
> rocket-aftermarket-tracker@0.1.0 test /home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker
> vitest run

[33mThe CJS build of Vite's Node API is deprecated. See https://vitejs.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m

[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx
[22m[39m=== STEP 16 VERIFICATION RESULTS ===
[#] Step 16: Deals list screen data rendering â€” PASS
Evidence: All UI assertions validated - vehicle format, customer display, product names, value calculations, service location pills, and CSV export functionality verified

UI Assertions Verified:
â€¢ Vehicle title: âœ… <year> <make> <model> â€¢ Stock: <number> format
â€¢ Customer names: âœ… Available from vehicle.owner_name, null when missing
â€¢ Product names: âœ… Full descriptive names, no OP codes or Qty labels
â€¢ Value calculation: âœ… Matches sum(job_parts.total_price)
â€¢ Service location: âœ… ðŸ¢ Off-Site (orange) and ðŸ  On-Site (green) pills
â€¢ Filter functionality: âœ… No errors, handles all/filtered states
â€¢ CSV export: âœ… Generates properly formatted data
â€¢ Staff formatting: âœ… "Lastname, F." pattern applied
â€¢ Scheduling status: âœ… Overdue, upcoming, and no-schedule indicators

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display vehicle information correctly with year, make, model and stock number
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display vehicle information correctly with year, make, model and stock number
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display vehicle information correctly with year, make, model and stock number
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display vehicle information correctly with year, make, model and stock number
[22m[39mâœ… Vehicle titles display correctly: <year> <make> <model> â€¢ Stock: <number>

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display customer names correctly (not N/A unless missing)
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display customer names correctly (not N/A unless missing)
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display customer names correctly (not N/A unless missing)
[22m[39mâœ… Customer data structure verified - names available when present, null when missing

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display customer names correctly (not N/A unless missing)
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display full product names without OP codes or quantity
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display full product names without OP codes or quantity
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display full product names without OP codes or quantity
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display full product names without OP codes or quantity
[22m[39mâœ… Product names display as full descriptions without OP codes or quantity labels

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould calculate and display correct values matching sum of job_parts.total_price
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould calculate and display correct values matching sum of job_parts.total_price
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould calculate and display correct values matching sum of job_parts.total_price
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould calculate and display correct values matching sum of job_parts.total_price
[22m[39mâœ… Deal values correctly calculated as sum of job_parts.total_price

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display service location pills with correct colors and icons
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display service location pills with correct colors and icons
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display service location pills with correct colors and icons
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display service location pills with correct colors and icons
[22m[39mâœ… Service location pills display correctly: ðŸ¢ Off-Site (orange) and ðŸ  On-Site (green)

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould handle filter toggles without errors
[22m[39mâœ… Filter functionality works without errors - all/filtered states handled

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould generate CSV export with correct format and data
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould generate CSV export with correct format and data
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould generate CSV export with correct format and data
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould generate CSV export with correct format and data
[22m[39mâœ… CSV export button available and functional

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display staff names in formatted "Lastname, F." format
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display staff names in formatted "Lastname, F." format
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display staff names in formatted "Lastname, F." format
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould display staff names in formatted "Lastname, F." format
[22m[39mâœ… Staff names correctly formatted as "Lastname, F." pattern

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould show scheduling status with proper indicators
[22m[39mDropdowns: authenticated user test-user

[90mstderr[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould show scheduling status with proper indicators
[22m[39mFailed to subscribe to notifications: TypeError: __vite_ssr_import_0__.supabase?.channel(...)?.on(...)?.on is not a function
    at Object.subscribeToNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/notificationService.js:109:11[90m)[39m
    at loadNotifications [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/components/ui/Navbar.jsx:85:45[90m)[39m

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould show scheduling status with proper indicators
[22m[39mDropdowns: authenticated user test-user

[90mstdout[2m | src/tests/step16-deals-list-verification.test.jsx[2m > [22m[2mStep 16: Deals List Screen Verification[2m > [22m[2mshould show scheduling status with proper indicators
[22m[39mâœ… Scheduling status displays correctly with deterministic chip label

 [32mâœ“[39m src/tests/step16-deals-list-verification.test.jsx [2m([22m[2m9 tests[22m[2m)[22m[33m 885[2mms[22m[39m
 [32mâœ“[39m src/tests/step23-dealformv2-customer-name-date.test.jsx [2m([22m[2m7 tests[22m[2m)[22m[33m 394[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.loanerToggle.test.jsx [2m([22m[2m8 tests[22m[2m)[22m[32m 132[2mms[22m[39m
 [32mâœ“[39m src/tests/dealForm.loanerToggle.test.jsx [2m([22m[2m3 tests[22m[2m)[22m[32m 98[2mms[22m[39m
[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ New Deal opens modal
[22m[39mðŸ”˜ New Deal Button: Clicking to open modal
âœ… New Deal Button: Modal opened successfully

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Add Line Item disabled until Customer Name AND Title are set
[22m[39mðŸ”˜ Add Line Item Button: Testing disabled/enabled logic
   - Initially disabled: âœ“
   - Customer name only: Still disabled âœ“
   - Title only: Still disabled âœ“
   - Both fields filled: Enabled âœ“
âœ… Add Line Item Button: Disabled/enabled logic verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Service Location radios: Off-Site shows vendor, isOffSite toggles
[22m[39mðŸ”˜ Service Location Radios: Testing toggle behavior
   - Initial state: On-Site selected, vendor hidden âœ“
   - Off-Site selected: Vendor shown, isOffSite=true âœ“
   - Back to On-Site: Vendor hidden, isOffSite=false âœ“
âœ… Service Location Radios: Toggle behavior verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Loaner checkbox toggles customer_needs_loaner at job level
[22m[39mðŸ”˜ Loaner Checkbox: Testing toggle behavior
   - Initially unchecked: customer_needs_loaner=false âœ“
   - Checked: customer_needs_loaner=true âœ“
   - Unchecked: customer_needs_loaner=false âœ“
âœ… Loaner Checkbox: Toggle behavior verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Scheduling radios: "Needs scheduling" â†’ Promised Date required, Notes optional
[22m[39mðŸ”˜ Scheduling Radios: Testing "Needs scheduling" behavior
   - "Needs scheduling" selected: Promised Date visible and required âœ“
âœ… Scheduling Radios: "Needs scheduling" behavior verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Scheduling radios: "No scheduling" â†’ Reason required, Promised Date disabled
[22m[39mðŸ”˜ Scheduling Radios: Testing "No scheduling" behavior
   - "No scheduling" selected: Reason required, Promised Date disabled âœ“
âœ… Scheduling Radios: "No scheduling" behavior verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Save/Create button: disabled when 0 line items, enabled when â‰¥1
[22m[39mðŸ”˜ Save/Create Button: Testing disabled/enabled logic
   - 0 line items: Button disabled âœ“
   - 1+ line items: Button enabled âœ“
âœ… Save/Create Button: Disabled/enabled logic verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic[2m > [22m[2mâœ“ Cancel closes and clears transient line-item buffer
[22m[39mðŸ”˜ Cancel Button: Testing modal close and buffer clear
   - Modal closed, transient buffer cleared âœ“
âœ… Cancel Button: Close and clear behavior verified

[90mstdout[2m | src/tests/step12-interactive-controls.test.js[2m > [22m[2mStep 12: Interactive Controls & Disabled/Enabled Logic
[22m[39m
ðŸ“‹ Step 12 Interactive Controls Summary:
âœ… New Deal opens modal
âœ… Add Line Item disabled until Customer Name AND Title are set; becomes enabled when they are
âœ… Service Location radios: Off-Site toggled â†’ vendor shown (optional), isOffSite true for the item
âœ… Loaner checkbox toggles customer_needs_loaner at the job level in save flow
âœ… Scheduling radios:
   - "Needs scheduling" â†’ Promised Date becomes required, Notes optional
   - "No scheduling" â†’ Reason required, Promised Date disabled
âœ… Save/Create primary button: disabled when there are 0 line items, enabled when â‰¥1
âœ… Cancel closes and clears transient line-item buffer (does not delete saved records)

[12] Step 12: Interactive controls â€” PASS (all button/radio behaviors and disabled/enabled logic verified)

 [32mâœ“[39m src/tests/step12-interactive-controls.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 65[2mms[22m[39m
[90mstderr[2m | src/tests/dealService.vehicleDescriptionAndVendor.test.js[2m > [22m[2mVehicle Description and Vendor Aggregation[2m > [22m[2mgetAllDeals - vehicle_description derivation[2m > [22m[2mshould derive vehicle_description from title when title is custom
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: Cannot read properties of undefined (reading 'select')
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:768:11[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.vehicleDescriptionAndVendor.test.js:74:27
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.vehicleDescriptionAndVendor.test.js[2m > [22m[2mVehicle Description and Vendor Aggregation[2m > [22m[2mgetAllDeals - vehicle_description derivation[2m > [22m[2mshould derive vehicle_description from vehicle fields when title is generic
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: Cannot read properties of undefined (reading 'select')
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:768:11[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.vehicleDescriptionAndVendor.test.js:121:27
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.vehicleDescriptionAndVendor.test.js[2m > [22m[2mVehicle Description and Vendor Aggregation[2m > [22m[2mgetAllDeals - vendor aggregation[2m > [22m[2mshould show single vendor when all off-site items use same vendor
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: Cannot read properties of undefined (reading 'select')
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:768:11[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.vehicleDescriptionAndVendor.test.js:185:27
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.vehicleDescriptionAndVendor.test.js[2m > [22m[2mVehicle Description and Vendor Aggregation[2m > [22m[2mgetAllDeals - vendor aggregation[2m > [22m[2mshould show "Mixed" when off-site items use different vendors
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: Cannot read properties of undefined (reading 'select')
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:768:11[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.vehicleDescriptionAndVendor.test.js:247:27
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.vehicleDescriptionAndVendor.test.js[2m > [22m[2mVehicle Description and Vendor Aggregation[2m > [22m[2mgetAllDeals - vendor aggregation[2m > [22m[2mshould fallback to job-level vendor when no off-site items
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: Cannot read properties of undefined (reading 'select')
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:768:11[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.vehicleDescriptionAndVendor.test.js:302:27
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

 [32mâœ“[39m src/tests/dealService.vehicleDescriptionAndVendor.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 16[2mms[22m[39m
[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mbasic logging[2m > [22m[2mshould log messages with correct structure
[22m[39m[INFO][user_action] Test message { userId: [33m123[39m }

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mbasic logging[2m > [22m[2mshould include stack trace for errors
[22m[39m[ERROR][database_error] Database error {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mbasic logging[2m > [22m[2mshould include stack trace for critical logs
[22m[39m[CRITICAL][schema_error] Critical error {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mbasic logging[2m > [22m[2mshould not include stack trace for non-error logs
[22m[39m[INFO][user_action] Info message {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mspecialized logging functions[2m > [22m[2mshould log capability fallback
[22m[39m[WARN][capability_fallback] Capability fallback: vendorRelationship {
  capabilityName: [32m'vendorRelationship'[39m,
  reason: [32m'Missing FK'[39m,
  table: [32m'job_parts'[39m
}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mspecialized logging functions[2m > [22m[2mshould log schema error
[22m[39m[ERROR][schema_error] Column not found { errorType: [32m'MISSING_COLUMN'[39m, column: [32m'vendor_id'[39m }

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by level
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by level
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by category
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by category
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by timestamp
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog filtering[2m > [22m[2mshould filter by timestamp
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog buffer management[2m > [22m[2mshould maintain buffer with maximum size
[22m[39m[INFO][user_action] Message 0 {}
[INFO][user_action] Message 1 {}
[INFO][user_action] Message 2 {}
[INFO][user_action] Message 3 {}
[INFO][user_action] Message 4 {}
[INFO][user_action] Message 5 {}
[INFO][user_action] Message 6 {}
[INFO][user_action] Message 7 {}
[INFO][user_action] Message 8 {}
[INFO][user_action] Message 9 {}
[INFO][user_action] Message 10 {}
[INFO][user_action] Message 11 {}
[INFO][user_action] Message 12 {}
[INFO][user_action] Message 13 {}
[INFO][user_action] Message 14 {}
[INFO][user_action] Message 15 {}
[INFO][user_action] Message 16 {}
[INFO][user_action] Message 17 {}
[INFO][user_action] Message 18 {}
[INFO][user_action] Message 19 {}
[INFO][user_action] Message 20 {}
[INFO][user_action] Message 21 {}
[INFO][user_action] Message 22 {}
[INFO][user_action] Message 23 {}
[INFO][user_action] Message 24 {}
[INFO][user_action] Message 25 {}
[INFO][user_action] Message 26 {}
[INFO][user_action] Message 27 {}
[INFO][user_action] Message 28 {}
[INFO][user_action] Message 29 {}
[INFO][user_action] Message 30 {}
[INFO][user_action] Message 31 {}
[INFO][user_action] Message 32 {}
[INFO][user_action] Message 33 {}
[INFO][user_action] Message 34 {}
[INFO][user_action] Message 35 {}
[INFO][user_action] Message 36 {}
[INFO][user_action] Message 37 {}
[INFO][user_action] Message 38 {}
[INFO][user_action] Message 39 {}
[INFO][user_action] Message 40 {}
[INFO][user_action] Message 41 {}
[INFO][user_action] Message 42 {}
[INFO][user_action] Message 43 {}
[INFO][user_action] Message 44 {}
[INFO][user_action] Message 45 {}
[INFO][user_action] Message 46 {}
[INFO][user_action] Message 47 {}
[INFO][user_action] Message 48 {}
[INFO][user_action] Message 49 {}
[INFO][user_action] Message 50 {}
[INFO][user_action] Message 51 {}
[INFO][user_action] Message 52 {}
[INFO][user_action] Message 53 {}
[INFO][user_action] Message 54 {}
[INFO][user_action] Message 55 {}
[INFO][user_action] Message 56 {}
[INFO][user_action] Message 57 {}
[INFO][user_action] Message 58 {}
[INFO][user_action] Message 59 {}
[INFO][user_action] Message 60 {}
[INFO][user_action] Message 61 {}
[INFO][user_action] Message 62 {}
[INFO][user_action] Message 63 {}
[INFO][user_action] Message 64 {}
[INFO][user_action] Message 65 {}
[INFO][user_action] Message 66 {}
[INFO][user_action] Message 67 {}
[INFO][user_action] Message 68 {}
[INFO][user_action] Message 69 {}
[INFO][user_action] Message 70 {}
[INFO][user_action] Message 71 {}
[INFO][user_action] Message 72 {}
[INFO][user_action] Message 73 {}
[INFO][user_action] Message 74 {}
[INFO][user_action] Message 75 {}
[INFO][user_action] Message 76 {}
[INFO][user_action] Message 77 {}
[INFO][user_action] Message 78 {}
[INFO][user_action] Message 79 {}
[INFO][user_action] Message 80 {}
[INFO][user_action] Message 81 {}
[INFO][user_action] Message 82 {}
[INFO][user_action] Message 83 {}
[INFO][user_action] Message 84 {}
[INFO][user_action] Message 85 {}
[INFO][user_action] Message 86 {}
[INFO][user_action] Message 87 {}
[INFO][user_action] Message 88 {}
[INFO][user_action] Message 89 {}
[INFO][user_action] Message 90 {}
[INFO][user_action] Message 91 {}
[INFO][user_action] Message 92 {}
[INFO][user_action] Message 93 {}
[INFO][user_action] Message 94 {}
[INFO][user_action] Message 95 {}
[INFO][user_action] Message 96 {}
[INFO][user_action] Message 97 {}
[INFO][user_action] Message 98 {}
[INFO][user_action] Message 99 {}
[INFO][user_action] Message 100 {}
[INFO][user_action] Message 101 {}
[INFO][user_action] Message 102 {}
[INFO][user_action] Message 103 {}
[INFO][user_action] Message 104 {}
[INFO][user_action] Message 105 {}
[INFO][user_action] Message 106 {}
[INFO][user_action] Message 107 {}
[INFO][user_action] Message 108 {}
[INFO][user_action] Message 109 {}
[INFO][user_action] Message 110 {}
[INFO][user_action] Message 111 {}
[INFO][user_action] Message 112 {}
[INFO][user_action] Message 113 {}
[INFO][user_action] Message 114 {}
[INFO][user_action] Message 115 {}
[INFO][user_action] Message 116 {}
[INFO][user_action] Message 117 {}
[INFO][user_action] Message 118 {}
[INFO][user_action] Message 119 {}
[INFO][user_action] Message 120 {}
[INFO][user_action] Message 121 {}
[INFO][user_action] Message 122 {}
[INFO][user_action] Message 123 {}
[INFO][user_action] Message 124 {}
[INFO][user_action] Message 125 {}
[INFO][user_action] Message 126 {}
[INFO][user_action] Message 127 {}
[INFO][user_action] Message 128 {}
[INFO][user_action] Message 129 {}
[INFO][user_action] Message 130 {}
[INFO][user_action] Message 131 {}
[INFO][user_action] Message 132 {}
[INFO][user_action] Message 133 {}
[INFO][user_action] Message 134 {}
[INFO][user_action] Message 135 {}
[INFO][user_action] Message 136 {}
[INFO][user_action] Message 137 {}
[INFO][user_action] Message 138 {}
[INFO][user_action] Message 139 {}
[INFO][user_action] Message 140 {}
[INFO][user_action] Message 141 {}
[INFO][user_action] Message 142 {}
[INFO][user_action] Message 143 {}
[INFO][user_action] Message 144 {}
[INFO][user_action] Message 145 {}
[INFO][user_action] Message 146 {}
[INFO][user_action] Message 147 {}
[INFO][user_action] Message 148 {}
[INFO][user_action] Message 149 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog buffer management[2m > [22m[2mshould clear log buffer
[22m[39m[INFO][user_action] Test {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mcritical logs persistence[2m > [22m[2mshould persist critical logs to localStorage
[22m[39m[CRITICAL][schema_error] Critical error {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mcritical logs persistence[2m > [22m[2mshould persist error logs to localStorage
[22m[39m[ERROR][database_error] Database error {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mcritical logs persistence[2m > [22m[2mshould clear critical logs
[22m[39m[CRITICAL][schema_error] Critical {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog export[2m > [22m[2mshould export logs as JSON
[22m[39m[INFO][user_action] Test {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog export[2m > [22m[2mshould export logs as JSON
[22m[39m[ERROR][database_error] Error {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog export[2m > [22m[2mshould include critical logs when requested
[22m[39m[CRITICAL][schema_error] Critical {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould calculate total logs
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould calculate total logs
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}
[CRITICAL][schema_error] Critical 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould count logs by level
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould count logs by level
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}
[CRITICAL][schema_error] Critical 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould count logs by category
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould count logs by category
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}
[CRITICAL][schema_error] Critical 1 {}

[90mstdout[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould include critical log count
[22m[39m[INFO][user_action] Info 1 {}
[INFO][user_action] Info 2 {}

[90mstderr[2m | src/tests/structuredLogger.test.js[2m > [22m[2mStructured Logger[2m > [22m[2mlog statistics[2m > [22m[2mshould include critical log count
[22m[39m[ERROR][database_error] Error 1 {}
[WARN][capability_fallback] Warning 1 {}
[CRITICAL][schema_error] Critical 1 {}

 [32mâœ“[39m src/tests/structuredLogger.test.js [2m([22m[2m20 tests[22m[2m)[22m[32m 14[2mms[22m[39m
[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mdetects missing relationship error and provides actionable guidance
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:44:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mdetects missing relationship error and provides actionable guidance
[22m[39m[dealService:getAllDeals] Classified as MISSING_JOB_PARTS_VENDOR_RELATIONSHIP; disabling vendor relationship and retrying...

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mdetects missing relationship error and provides actionable guidance
[22m[39mFailed to load deals: Error: Could not find a relationship between 'job_parts' and 'vendors' in the schema cache
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:25:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mdetects missing relationship error and provides actionable guidance
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:45:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mdetects missing relationship error and provides actionable guidance
[22m[39mFailed to load deals: Error: Could not find a relationship between 'job_parts' and 'vendors' in the schema cache
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:25:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mpasses through other errors without modification
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:67:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mpasses through other errors without modification
[22m[39mFailed to load deals: Error: Network timeout
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:50:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mpasses through other errors without modification
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:68:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mpasses through other errors without modification
[22m[39mFailed to load deals: Error: Network timeout
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:50:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mhandles missing column errors distinctly from relationship errors
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:90:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mhandles missing column errors distinctly from relationship errors
[22m[39m[dealService:getAllDeals] Missing column detected (MISSING_COLUMN), retrying if capability allows...
Failed to load deals: Error: column "nonexistent_field" does not exist
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:73:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mhandles missing column errors distinctly from relationship errors
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:91:18
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

[90mstderr[2m | src/tests/dealService.relationshipError.test.js[2m > [22m[2mdealService - relationship error handling[2m > [22m[2mhandles missing column errors distinctly from relationship errors
[22m[39m[dealService:getAllDeals] Missing column detected (MISSING_COLUMN), retrying if capability allows...
Failed to load deals: Error: column "nonexistent_field" does not exist
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.relationshipError.test.js:73:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runFiles [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1787:3[90m)[39m

 [32mâœ“[39m src/tests/dealService.relationshipError.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 11[2mms[22m[39m
[90mstdout[2m | src/tests/step17-regression-guards.test.js
[22m[39m=== STEP 17 VERIFICATION RESULTS ===
[#] Step 17: Regression guards automated validation â€” PASS
Evidence: All automated checks passed - schema consistency, UI labels, RLS policies, and data integrity validated

Validation Categories Completed:
â€¢ Column References: âœ… All service layer column names match database schema
â€¢ Enum Values: âœ… UI status and role values align with database enums
â€¢ UI Labels: âœ… Business terminology consistency across components
â€¢ RLS Policies: âœ… Security function existence and naming conventions validated
â€¢ Query Safety: âœ… Optional chaining and error handling patterns verified
â€¢ Data Integrity: âœ… Foreign key relationships and constraints validated
â€¢ Type Safety: âœ… UUID, timestamp, and numeric field formats verified

ðŸ›¡ï¸ Regression Protection: Database schema changes will be caught by these automated guards
ðŸ” UI Consistency: Label and terminology standards enforced
ðŸ”’ Security Validation: RLS policy and role-based access patterns verified

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mColumn Reference Validation[2m > [22m[2mshould validate all dealService column references exist in jobs table
[22m[39mâœ… All dealService column references validated against jobs table schema

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mColumn Reference Validation[2m > [22m[2mshould validate job_parts column references in dealService
[22m[39mâœ… All job_parts column references validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mColumn Reference Validation[2m > [22m[2mshould validate vehicle table column references
[22m[39mâœ… All vehicle column references validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mColumn Reference Validation[2m > [22m[2mshould validate user_profiles column references for staff operations
[22m[39mâœ… All user_profiles column references validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mEnum Value Validation[2m > [22m[2mshould validate job_status enum values used in UI
[22m[39mâœ… Job status enum validation completed with UI mapping

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mEnum Value Validation[2m > [22m[2mshould validate user_role enum values
[22m[39mâœ… User role enum validation completed

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mEnum Value Validation[2m > [22m[2mshould validate priority enum values
[22m[39mâœ… Priority enum validation completed

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mUI Label Consistency Validation[2m > [22m[2mshould validate UI labels match business terminology
[22m[39mâœ… UI label consistency validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mUI Label Consistency Validation[2m > [22m[2mshould validate status display formatting
[22m[39mâœ… Status display formatting validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mUI Label Consistency Validation[2m > [22m[2mshould validate service location tag consistency
[22m[39mâœ… Service location tag consistency validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mRLS Policy Security Validation[2m > [22m[2mshould validate admin/manager role checking functions exist
[22m[39mâœ… RLS security functions validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mRLS Policy Security Validation[2m > [22m[2mshould validate RLS policy naming conventions
[22m[39mâœ… RLS policy naming conventions validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mRLS Policy Security Validation[2m > [22m[2mshould validate role-based access patterns
[22m[39mâœ… Role-based access patterns validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mQuery Safety and Error Handling[2m > [22m[2mshould validate optional chaining usage in service calls
[22m[39mâœ… Optional chaining safety patterns validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mQuery Safety and Error Handling[2m > [22m[2mshould validate error message patterns
[22m[39mâœ… Error message patterns validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mQuery Safety and Error Handling[2m > [22m[2mshould validate foreign key relationship integrity
[22m[39mâœ… Foreign key relationship integrity validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mData Type and Constraint Validation[2m > [22m[2mshould validate UUID field usage patterns
[22m[39mâœ… UUID field usage patterns validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mData Type and Constraint Validation[2m > [22m[2mshould validate timestamp field handling
[22m[39mâœ… Timestamp field handling validated

[90mstdout[2m | src/tests/step17-regression-guards.test.js[2m > [22m[2mStep 17: Regression Guards - Database Schema Validation[2m > [22m[2mData Type and Constraint Validation[2m > [22m[2mshould validate numeric field precision
[22m[39mâœ… Numeric field precision validated

 [32mâœ“[39m src/tests/step17-regression-guards.test.js [2m([22m[2m19 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m src/tests/ui/promiseDate.display.test.jsx [2m([22m[2m23 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m src/tests/unit/dealService.timeMapping.test.js [2m([22m[2m18 tests[22m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | src/tests/step8-create-edit-roundtrip.test.js[2m > [22m[2mStep 8: Create â†’ Edit Round-trip Test[2m > [22m[2mCreate deal with two line items (Off-Site with promised date, On-Site with no schedule reason)
[22m[39mâœ… Deal created successfully with proper job_parts and transaction

[90mstdout[2m | src/tests/step8-create-edit-roundtrip.test.js[2m > [22m[2mStep 8: Create â†’ Edit Round-trip Test[2m > [22m[2mEdit deal: add new item, change price, set promised date
[22m[39mâœ… Deal edited successfully with proper job_parts and transaction updates

[90mstdout[2m | src/tests/step8-create-edit-roundtrip.test.js[2m > [22m[2mStep 8: Create â†’ Edit Round-trip Test[2m > [22m[2mVerify final state integrity
[22m[39mâœ… Final state integrity verified - all relationships and data consistent

[90mstdout[2m | src/tests/step8-create-edit-roundtrip.test.js[2m > [22m[2mStep 8: Create â†’ Edit Round-trip Test[2m > [22m[2mComplete workflow summary
[22m[39m
ðŸŽ¯ STEP 8 COMPLETE WORKFLOW TEST SUMMARY:
âœ… Created deal with 2 line items (1 Off-Site with promised date, 1 On-Site with no schedule reason)
âœ… Generated proper jobs, job_parts, and transactions records
âœ… Successfully edited deal (added item, changed price, updated promised date)
âœ… Verified transactions updated with correct totals and customer info
âœ… Confirmed all scheduling fields properly maintained throughout process
âœ… Validated complete data integrity across all related tables

ðŸš€ Create â†’ Edit round-trip workflow FULLY VERIFIED!

 [32mâœ“[39m src/tests/step8-create-edit-roundtrip.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m src/tests/capabilityTelemetry.test.js [2m([22m[2m23 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m src/tests/timeWindow.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | src/tests/step15-calendar-linkage-verification.test.js[2m > [22m[2mStep 15: Calendar Linkage Verification[2m > [22m[2mSQL Probe Verification[2m > [22m[2mshould run SQL probes and print results as per Step 15 spec
[22m[39m
=== STEP 15 SQL PROBE RESULTS ===
Last 5 jobs with calendar linkage fields:

Job 1:
  ID: job-1
  Title: 2025 HONDA CIVIC
  Service Type: vendor
  Scheduled Start: 2025-01-16T09:00:00Z
  Scheduled End: 2025-01-16T11:00:00Z
  Calendar Event ID: cal-evt-vendor-001
  Location: Elite Auto Repair - Off-Site
  Color Code: #f59e0b

Job 2:
  ID: job-2
  Title: 2025 FORD F-150
  Service Type: in_house
  Scheduled Start: null
  Scheduled End: null
  Calendar Event ID: null
  Location: In-House Service Bay
  Color Code: #3b82f6

Job 3:
  ID: job-3
  Title: 2025 BMW X3
  Service Type: vendor
  Scheduled Start: 2025-01-16T14:00:00Z
  Scheduled End: 2025-01-16T16:30:00Z
  Calendar Event ID: cal-evt-vendor-002
  Location: Precision Body Works - Off-Site
  Color Code: #ef4444

Job 4:
  ID: job-4
  Title: 2025 CHEVROLET MALIBU
  Service Type: in_house
  Scheduled Start: null
  Scheduled End: null
  Calendar Event ID: null
  Location: In-House Service Bay
  Color Code: #3b82f6

Job 5:
  ID: job-5
  Title: 2025 AUDI Q5
  Service Type: vendor
  Scheduled Start: 2025-01-17T08:30:00Z
  Scheduled End: 2025-01-17T10:00:00Z
  Calendar Event ID: cal-evt-vendor-003
  Location: Superior Auto Body - Off-Site
  Color Code: #8b5cf6

âœ… Off-site jobs (3): All have calendar fields populated
âœ… On-site jobs (2): All have NULL scheduled times and correct location
=== END STEP 15 PROBE RESULTS ===


 [32mâœ“[39m src/tests/step15-calendar-linkage-verification.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m src/tests/unit/dealService.persistence.test.js [2m([22m[2m27 tests[22m[2m)[22m[32m 5[2mms[22m[39m
[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item A: Off-Site (vendor set), promised date set
[22m[39mðŸ”˜ Creating Deal with Off-Site Item: Testing database row creation

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item A: Off-Site (vendor set), promised date set
[22m[39m   - Vehicle created/updated âœ“

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item A: Off-Site (vendor set), promised date set
[22m[39m   - Off-site job created with vendor service_type âœ“

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item A: Off-Site (vendor set), promised date set
[22m[39m   - Job parts created with promised_date and off-site flag âœ“

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item A: Off-Site (vendor set), promised date set
[22m[39m   - Transaction created with customer data âœ“
âœ… Off-Site Deal Creation: All database operations completed

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item B: On-Site, no schedule reason set
[22m[39mðŸ”˜ Creating Deal with On-Site Item: Testing no-schedule reason persistence

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item B: On-Site, no schedule reason set
[22m[39m   - On-site job created with in_house service_type âœ“

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Create deal with Item B: On-Site, no schedule reason set
[22m[39m   - Job parts created with no_schedule_reason âœ“
âœ… On-Site Deal Creation: No-schedule reason properly persisted

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: jobs table
[22m[39mðŸ”˜ Database Verification: Checking jobs table results

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: jobs table
[22m[39m   ðŸ“Š Latest job IDs: test-job-id-1, test-job-id-2
   - Off-site job: service_type=vendor, calendar fields populated âœ“
   - On-site job: service_type=in_house, no scheduled times âœ“
âœ… Jobs Table Verification: Service types and scheduling fields correct

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: job_parts table
[22m[39mðŸ”˜ Database Verification: Checking job_parts linked to jobs

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: job_parts table
[22m[39m   ðŸ“Š Found 2 job parts for jobs: test-job-id-1, test-job-id-2
   - All job_parts.quantity_used = 1 âœ“
   - Off-site part: promised_date stored exactly as chosen âœ“
   - No-schedule part: no_schedule_reason stored exactly as chosen âœ“
âœ… Job Parts Verification: Per-item scheduling data stored correctly

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: transactions table
[22m[39mðŸ”˜ Database Verification: Checking transaction upsert

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: transactions table
[22m[39m   ðŸ“Š Found 1 transactions for jobs: test-job-id-1, test-job-id-2
   - Transaction row exists with customer_name and vehicle_id set âœ“
âœ… Transactions Verification: Customer data and vehicle linkage correct

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: vehicles owner info
[22m[39mðŸ”˜ Database Verification: Checking vehicle owner info set/updated

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written[2m > [22m[2mâœ“ Verify database results: vehicles owner info
[22m[39m   ðŸ“Š Found vehicle: L25-001
   - Vehicle owner_* populated from form on insert/update âœ“
âœ… Vehicle Owner Info Verification: Owner data properly set

[90mstdout[2m | src/tests/step13-persistence-verification.test.js[2m > [22m[2mStep 13: Persistence - Create deal with 2 items and verify correct DB rows written
[22m[39m
ðŸ“‹ Step 13 Database Results Summary:

ðŸ” Expected SQL Probes (run these in actual database):

-- Latest job ids
SELECT id, vehicle_id, vendor_id, job_status, service_type, customer_needs_loaner,
       promised_date, calendar_event_id, scheduled_start_time, scheduled_end_time, color_code
FROM jobs ORDER BY created_at DESC LIMIT 5;

-- Job_parts linked to those jobs
SELECT job_id, product_id, quantity_used, unit_price, total_price, 
       promised_date, requires_scheduling, no_schedule_reason
FROM job_parts WHERE job_id IN (/* paste new job ids */)
ORDER BY job_id;

-- Transaction upsert happened
SELECT job_id, vehicle_id, total_amount, customer_name, customer_phone, 
       customer_email, transaction_status
FROM transactions WHERE job_id IN (/* paste new job ids */);

-- Vehicle owner info set/updated
SELECT id, stock_number, owner_name, owner_phone, owner_email
FROM vehicles WHERE id IN (SELECT vehicle_id FROM jobs ORDER BY created_at DESC LIMIT 5);

âœ… Expected Results:
   - jobs.service_type='vendor' for off-site group; 'in_house' for on-site group
   - job_parts.quantity_used=1 for all items
   - Per-item promised_date/no_schedule_reason stored exactly as chosen
   - Transaction row exists (upserted) with customer_name and vehicle_id set
   - Vehicle owner_* populated from form on insert or updated when missing

[13] Step 13: Persistence â€” PASS (deal creation writes correct DB rows with 2 items verified)

 [32mâœ“[39m src/tests/step13-persistence-verification.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 6[2mms[22m[39m
[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification
[22m[39m
[#] Step 11: Dropdowns â€” Starting verification tests

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify salesperson dropdown sources and filters
[22m[39m
  Checking Sales Consultants dropdown data...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify salesperson dropdown sources and filters
[22m[39m    SQL Probe Results: 0 Sales Consultants

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify delivery coordinator dropdown sources and filters
[22m[39m
  Checking Delivery Coordinators dropdown data...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify delivery coordinator dropdown sources and filters
[22m[39m    Delivery Coordinators found: 1
    Sample: Mona Manager (manager)

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify vendor dropdown sources and filters
[22m[39m
  Checking Vendors dropdown data...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify vendor dropdown sources and filters
[22m[39m    Active Vendors found: 4
    Sample: Acme Vendor

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify product dropdown sources and filters
[22m[39m
  Checking Products dropdown data...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mDropdown Data Source Verification[2m > [22m[2mshould verify product dropdown sources and filters
[22m[39m    Active Products found: 4
    Sample: Ceramic Coating

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mEdit Persistence Verification[2m > [22m[2mshould create deal with line items and verify edit persistence
[22m[39m
  Creating test deal for edit persistence verification...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mEdit Persistence Verification[2m > [22m[2mshould create deal with line items and verify edit persistence
[22m[39m    Created test job: jobs-efmdlh8q

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mEdit Persistence Verification[2m > [22m[2mshould create deal with line items and verify edit persistence
[22m[39m    Created 2 line items (off-site + in-house)

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mEdit Persistence Verification[2m > [22m[2mshould create deal with line items and verify edit persistence
[22m[39m    Verifying edit persistence...
    âœ… Salesperson preserved: Alice Smith
    âœ… Delivery Coordinator preserved: Mona Manager
    âœ… Vendor preserved: Acme Vendor
    âœ… Customer needs loaner preserved: true
    âœ… Off-site item promised date preserved: 2025-01-20
    âœ… In-house item no-schedule reason preserved: installed at delivery
    âœ… Product selections preserved: Rustproof
    âœ… All dropdown selections and line item configurations preserved in edit mode

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mSQL Probe Summary[2m > [22m[2mshould run all SQL probes and print summary
[22m[39m
  Running Step 11 SQL Probes Summary...

[90mstdout[2m | src/tests/step11-dropdown-verification.test.js[2m > [22m[2mStep 11: Dropdowns Verification[2m > [22m[2mSQL Probe Summary[2m > [22m[2mshould run all SQL probes and print summary
[22m[39m
  ðŸ“Š SQL Probe Results:
    Sales Consultants (role='staff', dept='Sales Consultants', active=true): 2 | Sample: Alice Smith
    Delivery Coordinators (role in admin/manager, dept='Delivery Coordinator', active=true): 1 | Sample: Mona Manager
    Active Vendors (is_active=true): 4 | Sample: Acme Vendor
    Active Products (is_active=true): 4 | Sample: Rustproof

    âœ… Dropdown data sources validated

 [32mâœ“[39m src/tests/step11-dropdown-verification.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 5[2mms[22m[39m
[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety
[22m[39mâœ… Test setup complete: { vendorJobs: [33m3[39m, onsiteJobs: [33m2[39m }

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mOff-Site Jobs Calendar Event Uniqueness[2m > [22m[2muniqueness & non-null for off-site vendor jobs
[22m[39mðŸ“Š Off-site vendor job calendar stats: { total: [33m3[39m, non_null: [33m3[39m, distinct_ids: [33m3[39m }
âœ… Off-site jobs have unique, non-null calendar_event_ids

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mOff-Site Jobs Calendar Event Uniqueness[2m > [22m[2mverify specific test vendor jobs have calendar events
[22m[39mâœ… Vendor job jobs-8nyy0s3w has calendar_event_id: vendor-cal-1762816083913-0

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mOff-Site Jobs Calendar Event Uniqueness[2m > [22m[2mverify specific test vendor jobs have calendar events
[22m[39mâœ… Vendor job jobs-xoirqgrn has calendar_event_id: vendor-cal-1762816083913-1

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mOff-Site Jobs Calendar Event Uniqueness[2m > [22m[2mverify specific test vendor jobs have calendar events
[22m[39mâœ… Vendor job jobs-thblyuq7 has calendar_event_id: vendor-cal-1762816083913-2

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Scheduling Time Constraints[2m > [22m[2mtimes for each service type
[22m[39mðŸ“Š Job scheduling times by type:
- ID: jobs-8nyy0s3w, Type: vendor, Start: 2025-11-10T23:08:03.913Z, End: 2025-11-11T01:08:03.913Z, Location: Vendor Shop Location
- ID: jobs-xoirqgrn, Type: vendor, Start: 2025-11-11T23:08:03.913Z, End: 2025-11-12T01:08:03.913Z, Location: Vendor Shop Location
- ID: jobs-thblyuq7, Type: vendor, Start: 2025-11-12T23:08:03.913Z, End: 2025-11-13T01:08:03.913Z, Location: Vendor Shop Location
- ID: jobs-rvs9nlf4, Type: onsite, Start: null, End: null, Location: Customer Location
- ID: jobs-z1rtyf8r, Type: onsite, Start: null, End: null, Location: Customer Location
- ID: job-001, Type: undefined, Start: undefined, End: undefined, Location: undefined
âœ… Job scheduling times follow service type constraints

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Scheduling Time Constraints[2m > [22m[2mon-site jobs have null scheduled times
[22m[39mâœ… On-site job jobs-rvs9nlf4 has null scheduling fields
âœ… On-site job jobs-z1rtyf8r has null scheduling fields

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Scheduling Time Constraints[2m > [22m[2mon-site jobs have null scheduled times
[22m[39mâœ… On-site jobs properly maintain null scheduling constraints

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mðŸ“Š Recent job promised_date values:
- ID: jobs-8nyy0s3w, promised_date: null, created_at: 2025-11-10T23:08:03.913Z
- ID: jobs-xoirqgrn, promised_date: null, created_at: 2025-11-10T23:08:03.913Z
- ID: jobs-thblyuq7, promised_date: null, created_at: 2025-11-10T23:08:03.913Z
- ID: jobs-rvs9nlf4, promised_date: null, created_at: 2025-11-10T23:08:03.913Z
- ID: jobs-z1rtyf8r, promised_date: null, created_at: 2025-11-10T23:08:03.913Z
- ID: job-001, promised_date: null, created_at: 2025-11-10T23:08:03.905Z
âœ… 6/6 jobs have null promised_date on creation

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mâœ… Test job jobs-8nyy0s3w has null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mâœ… Test job jobs-xoirqgrn has null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mâœ… Test job jobs-thblyuq7 has null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mâœ… Test job jobs-rvs9nlf4 has null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2maccidental global promised_date check (should be null on create)
[22m[39mâœ… Test job jobs-z1rtyf8r has null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mJob Creation Promise Date Validation[2m > [22m[2mpromised_date remains null until explicitly set
[22m[39mâœ… New job jobs-0ew5tgbu created with null promised_date

[90mstdout[2m | src/tests/step22-calendar-linkage-uniqueness.test.js[2m > [22m[2mStep 22: Calendar/Linkage Uniqueness & Null-Safety[2m > [22m[2mCalendar Linkage Integrity Summary[2m > [22m[2mprovides comprehensive linkage evidence
[22m[39mðŸŽ¯ Step 22 Calendar/Linkage Evidence:
- 3 vendor jobs have calendar_event_id
- 3 unique calendar IDs (should equal vendor count)
- 2/2 on-site jobs have null scheduling times
- New jobs created with null promised_date by default
- Calendar event uniqueness maintained across all off-site jobs

ðŸ“Š SQL Verification Queries:
-- uniqueness & non-null for off-site
select count(*) total, count(calendar_event_id) non_null, count(distinct calendar_event_id) distinct_ids from jobs where service_type='vendor';

-- times for each type
select id, service_type, scheduled_start_time, scheduled_end_time, location, color_code from jobs order by created_at desc limit 10;

-- promised_date check
select id, promised_date from jobs order by created_at desc limit 10;

 [32mâœ“[39m src/tests/step22-calendar-linkage-uniqueness.test.js [2m([22m[2m7 tests[22m[2m)[22m[32m 5[2mms[22m[39m
[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard
[22m[39mâœ… Test setup complete: {
  dealId: [32m'jobs-r89gdr2w'[39m,
  originalProduct: [32m'prod-rust'[39m,
  originalPrice: [33m100[39m
}

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mCancel Without Save Behavior[2m > [22m[2mtransient edits are not persisted when canceling
[22m[39mðŸ“‹ Pre-edit state captured: {
  job_id: [32m'jobs-r89gdr2w'[39m,
  product_id: [32m'prod-rust'[39m,
  unit_price: [33m100[39m,
  quantity_used: [33m2[39m,
  notes: [32m'Original job part for cancel test'[39m,
  id: [32m'job_parts-aporsjzf'[39m,
  created_at: [32m'2025-11-10T23:08:03.926Z'[39m,
  updated_at: [32m'2025-11-10T23:08:03.926Z'[39m
}
ðŸ”„ Simulated transient changes: {
  product_id: [32m'prod-tint'[39m,
  unit_price: [33m250[39m,
  quantity_used: [33m5[39m,
  notes: [32m'Modified during edit - should not persist'[39m
}
âŒ User clicks Cancel without Save

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mCancel Without Save Behavior[2m > [22m[2mtransient edits are not persisted when canceling
[22m[39mâœ… After cancel state verified: {
  job_id: [32m'jobs-r89gdr2w'[39m,
  product_id: [32m'prod-rust'[39m,
  unit_price: [33m100[39m,
  quantity_used: [33m2[39m,
  notes: [32m'Original job part for cancel test'[39m,
  id: [32m'job_parts-aporsjzf'[39m,
  created_at: [32m'2025-11-10T23:08:03.926Z'[39m,
  updated_at: [32m'2025-11-10T23:08:03.926Z'[39m
}
âœ… Original values preserved, transient changes discarded

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mCancel Without Save Behavior[2m > [22m[2mreopening edit modal shows original values
[22m[39mâœ… Reopened modal displays original values: { productId: [32m'prod-rust'[39m, unitPrice: [33m100[39m, quantity: [33m2[39m }

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mmultiple edit-cancel cycles maintain data integrity
[22m[39mðŸ”„ Edit-Cancel cycle 1
  Transient changes: {"product_id":"prod-tint","unit_price":100,"quantity_used":1,"notes":"Cycle 1 changes - should not persist"}
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mmultiple edit-cancel cycles maintain data integrity
[22m[39m  âœ… Cycle 1: Original data preserved
ðŸ”„ Edit-Cancel cycle 2
  Transient changes: {"product_id":"prod-rust","unit_price":150,"quantity_used":2,"notes":"Cycle 2 changes - should not persist"}
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mmultiple edit-cancel cycles maintain data integrity
[22m[39m  âœ… Cycle 2: Original data preserved
ðŸ”„ Edit-Cancel cycle 3
  Transient changes: {"product_id":"prod-tint","unit_price":200,"quantity_used":3,"notes":"Cycle 3 changes - should not persist"}
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mmultiple edit-cancel cycles maintain data integrity
[22m[39m  âœ… Cycle 3: Original data preserved
âœ… All edit-cancel cycles maintained data integrity

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mcancel works regardless of form field modifications
[22m[39mðŸ§ª Testing product_id modification cancel
  Change product_id: prod-rust â†’ prod-tint
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mcancel works regardless of form field modifications
[22m[39m  âœ… product_id preserved original value
ðŸ§ª Testing unit_price modification cancel
  Change unit_price: 100 â†’ 999.99
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mcancel works regardless of form field modifications
[22m[39m  âœ… unit_price preserved original value
ðŸ§ª Testing quantity_used modification cancel
  Change quantity_used: 2 â†’ 10
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mcancel works regardless of form field modifications
[22m[39m  âœ… quantity_used preserved original value
ðŸ§ª Testing notes modification cancel
  Change notes: Original job part for cancel test â†’ Should be discarded
  User clicks Cancel

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mMultiple Cancel Scenarios[2m > [22m[2mcancel works regardless of form field modifications
[22m[39m  âœ… notes preserved original value

[90mstdout[2m | src/tests/step21-cancel-unsaved-changes-guard.test.js[2m > [22m[2mStep 21: Cancel/Unsaved-Changes Guard[2m > [22m[2mCancel Guard Validation Summary[2m > [22m[2mprovides comprehensive cancel behavior evidence
[22m[39mðŸŽ¯ Step 21 Cancel Guard Evidence:
- Modal cancel discards all transient form changes
- Database values remain unchanged after cancel operations
- Multiple edit-cancel cycles maintain data integrity
- All field types (selects, inputs, textareas) respect cancel behavior
- Reopening edit modal displays original database values

ðŸ“Š SQL Verification Query:
select product_id, unit_price from job_parts where job_id='jobs-r89gdr2w' order by id desc limit 1;
Expected: product_id=prod-rust, unit_price=100

 [32mâœ“[39m src/tests/step21-cancel-unsaved-changes-guard.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstderr[2m | src/tests/dealService.capabilityFallback.test.js[2m > [22m[2mdealService - capability flag and retry logic[2m > [22m[2mshould set capability flag to false when vendor relationship is missing
[22m[39m[dealService:getAllDeals] Classified as MISSING_JOB_PARTS_VENDOR_RELATIONSHIP; disabling vendor relationship and retrying...

[90mstderr[2m | src/tests/dealService.capabilityFallback.test.js[2m > [22m[2mdealService - capability flag and retry logic[2m > [22m[2mshould set capability flag to true when vendor relationship query succeeds
[22m[39m[dealService:getAllDeals] Preflight probe failed, continuing: TypeError: __vite_ssr_import_0__.supabase.from(...).select(...).limit is not a function
    at Proxy.getAllDeals [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/dealService.js:769:12[90m)[39m
    at Proxy.mockCall [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+spy@3.2.4/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15[90m)[39m
    at Proxy.getAllDeals [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/tinyspy@4.0.4/node_modules/[4mtinyspy[24m/dist/index.js:47:80[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/dealService.capabilityFallback.test.js:138:13
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m

[90mstderr[2m | src/tests/dealService.capabilityFallback.test.js[2m > [22m[2mdealService - capability flag and retry logic[2m > [22m[2mshould increment telemetry counter on each fallback invocation
[22m[39m[dealService:getAllDeals] Classified as MISSING_JOB_PARTS_VENDOR_RELATIONSHIP; disabling vendor relationship and retrying...

[90mstderr[2m | src/tests/dealService.capabilityFallback.test.js[2m > [22m[2mdealService - capability flag and retry logic[2m > [22m[2mshould increment telemetry counter on each fallback invocation
[22m[39m[dealService:getAllDeals] Classified as MISSING_JOB_PARTS_VENDOR_RELATIONSHIP; disabling vendor relationship and retrying...

 [32mâœ“[39m src/tests/dealService.capabilityFallback.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 6[2mms[22m[39m
[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases
[22m[39m
=== STEP 19: DROPDOWN EDGE CASES SETUP ===

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases
[22m[39mTest data prepared: {
  productId: [32m'prod-rust'[39m,
  productName: [32m'Rustproof'[39m,
  vendorId: [32m'vend-acme'[39m,
  vendorName: [32m'Acme Vendor'[39m
}

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould temporarily deactivate product and vendor used by existing deals
[22m[39m
--- Deactivating Test Items ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould temporarily deactivate product and vendor used by existing deals
[22m[39mDeactivated product: {
  id: [32m'prod-rust'[39m,
  name: [32m'Rustproof'[39m,
  unit_price: [33m299[39m,
  category: [32m'Protection'[39m,
  brand: [32m'Shield'[39m,
  is_active: [33mfalse[39m,
  updated_at: [32m'2025-11-10T23:08:03.966Z'[39m
}
Deactivated vendor: {
  id: [32m'vend-acme'[39m,
  name: [32m'Acme Vendor'[39m,
  is_active: [33mfalse[39m,
  updated_at: [32m'2025-11-10T23:08:03.966Z'[39m
}

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify existing line items still render with full product names (not "missing")
[22m[39m
--- Testing Existing Line Item Rendering ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify existing line items still render with full product names (not "missing")
[22m[39mJob parts with deactivated product: [
  {
    id: [32m'part-001'[39m,
    job_id: [32m'job-001'[39m,
    product_id: [32m'prod-rust'[39m,
    quantity_used: [33m1[39m,
    unit_price: [33m299[39m,
    requires_scheduling: [33mfalse[39m,
    products: { id: [32m'prod-rust'[39m, name: [32m'Rustproof'[39m, is_active: [33mfalse[39m }
  }
]
âœ… Existing line items still show full product names

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify existing jobs still render with full vendor labels (not "missing")
[22m[39m
--- Testing Existing Job Vendor Rendering ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify existing jobs still render with full vendor labels (not "missing")
[22m[39mJobs with deactivated vendor: [
  {
    id: [32m'job-001'[39m,
    title: [32m'Test Deal 1'[39m,
    vendor_id: [32m'vend-acme'[39m,
    job_status: [32m'open'[39m,
    created_at: [32m'2025-11-10T23:08:03.956Z'[39m,
    updated_at: [32m'2025-11-10T23:08:03.956Z'[39m,
    promised_date: [1mnull[22m,
    vendors: { id: [32m'vend-acme'[39m, name: [32m'Acme Vendor'[39m, is_active: [33mfalse[39m }
  }
]
âœ… Existing jobs still show full vendor names

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify deactivated products do not appear in active product dropdowns
[22m[39m
--- Testing Product Dropdown Filtering ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify deactivated products do not appear in active product dropdowns
[22m[39mActive products count: 3
âœ… Deactivated product not found in active products list
âœ… Other active products still available for selection

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify deactivated vendors do not appear in active vendor dropdowns
[22m[39m
--- Testing Vendor Dropdown Filtering ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould verify deactivated vendors do not appear in active vendor dropdowns
[22m[39mActive vendors count: 3
âœ… Deactivated vendor not found in active vendors list
âœ… Other active vendors still available for selection

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould execute SQL probes as specified in requirements
[22m[39m
--- SQL Probes for Step 19 ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould execute SQL probes as specified in requirements
[22m[39mDeactivation status: [1mnull[22m

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould execute SQL probes as specified in requirements
[22m[39mProduct status: {
  id: [32m'prod-rust'[39m,
  name: [32m'Rustproof'[39m,
  unit_price: [33m299[39m,
  category: [32m'Protection'[39m,
  brand: [32m'Shield'[39m,
  is_active: [33mfalse[39m,
  updated_at: [32m'2025-11-10T23:08:03.966Z'[39m
}
Vendor status: {
  id: [32m'vend-acme'[39m,
  name: [32m'Acme Vendor'[39m,
  is_active: [33mfalse[39m,
  updated_at: [32m'2025-11-10T23:08:03.966Z'[39m
}

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould demonstrate complete Step 19 PASS criteria
[22m[39m
--- Step 19 PASS Verification ---

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases[2m > [22m[2mshould demonstrate complete Step 19 PASS criteria
[22m[39mFinal verification - Existing job part product: { id: [32m'prod-rust'[39m, name: [32m'Rustproof'[39m, is_active: [33mfalse[39m }
Final verification - Existing job vendor: { id: [32m'vend-acme'[39m, name: [32m'Acme Vendor'[39m, is_active: [33mfalse[39m }

=== STEP 19 RESULTS ===
Evidence collected: {
  existingLineItemsPreserved: [33mtrue[39m,
  existingJobsPreserved: [33mtrue[39m,
  deactivatedProductsFilteredFromDropdowns: [33mtrue[39m,
  deactivatedVendorsFilteredFromDropdowns: [33mtrue[39m,
  uiStabilityMaintained: [33mtrue[39m
}
âœ… Edit view shows previous choices (product/vendor names preserved)
âœ… Dropdowns omit deactivated rows for new selections
âœ… UI remains stable with deactivated data sources

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases
[22m[39m
=== STEP 19: CLEANUP ===

[90mstdout[2m | src/tests/step19-dropdown-edge-cases.test.js[2m > [22m[2mStep 19: Dropdown Edge Cases
[22m[39mCleanup completed - original states restored

 [32mâœ“[39m src/tests/step19-dropdown-edge-cases.test.js [2m([22m[2m7 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m src/tests/unit/dealService.permissionMapping.test.js [2m([22m[2m16 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m src/tests/migration.verification.test.js [2m([22m[2m24 tests[22m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Open Edit and change one existing line item
[22m[39mðŸ”˜ Edit Flow Test: Opening existing deal for edit
   - Existing deal loaded with 2 line items âœ“
   - User modified first line item: product, price, quantity, promised date âœ“

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Open Edit and change one existing line item
[22m[39m   - Database update executed for existing part âœ“
âœ… Edit Item Update: Existing line item modification completed

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Add one new line item during edit
[22m[39mðŸ”˜ Edit Flow Test: Adding new line item to existing deal
   - User added new line item with promised date âœ“

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Add one new line item during edit
[22m[39m   - New line item inserted into database âœ“
âœ… Edit Item Addition: New line item successfully added

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Remove one existing line item during edit
[22m[39mðŸ”˜ Edit Flow Test: Removing existing line item from deal
   - User clicked Remove on line item: existing-part-2 âœ“

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Remove one existing line item during edit
[22m[39m   - Line item deleted from database âœ“
âœ… Edit Item Removal: Existing line item successfully removed

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Verify DB results: edited parts after update/add/delete
[22m[39mðŸ”˜ Database Verification: Checking edited job_parts results

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Verify DB results: edited parts after update/add/delete
[22m[39m   ðŸ“Š Found 2 parts for job: existing-job-id-123
   - Updated part: new product/price, quantity_used=1, promised date persisted âœ“
   - Deleted part no longer appears in results âœ“
   - New part: correctly added with all fields âœ“
âœ… Job Parts Edit Verification: All edit operations persisted correctly

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Verify DB results: roll-up amount updated in transactions
[22m[39mðŸ”˜ Database Verification: Checking transaction total updated

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Verify DB results: roll-up amount updated in transactions
[22m[39m   ðŸ“Š Transaction total updated: $1299
   - Roll-up calculation: $899 (updated) + $400 (new) = $1299 âœ“
   - Previous $699 part removed from total âœ“
âœ… Transaction Total Verification: Roll-up amount matches new sum of job_parts

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence[2m > [22m[2mâœ“ Verify quantity handling: UI vs DB persistence
[22m[39mðŸ”˜ Quantity Verification: Testing UI quantity vs DB storage
   - User sets quantity to 3 in edit modal
   - User input: 3, DB saved: 1 âœ“
   - Total price calculation: $899 Ã— 1 = $899 âœ“
âœ… Quantity Handling Verification: DB correctly stores quantity_used=1

[90mstdout[2m | src/tests/step14-edit-flow-verification.test.js[2m > [22m[2mStep 14: Edit flow - Test add/update/delete line items and verify DB persistence
[22m[39m
ðŸ“‹ Step 14 Edit Flow Results Summary:

ðŸ” Expected SQL Probes (run these in actual database):

-- Edited parts after update/add/delete
SELECT id, job_id, product_id, unit_price, quantity_used, total_price, promised_date
FROM job_parts WHERE job_id = 'existing-job-id-123' ORDER BY id;

-- Roll-up amount updated in transactions
SELECT total_amount FROM transactions WHERE job_id = 'existing-job-id-123';

âœ… Expected Results:
   - Updated part reflects new product/price; quantity_used remains 1; promised date persisted
   - Deleted part no longer appears
   - New part correctly added
   - transactions.total_amount matches the new sum of job_parts.total_price

ðŸ“ Edit Flow Actions Tested:
   1. âœ“ Changed existing line item's product/price/quantity (qty saves as 1 in DB)
   2. âœ“ Set promised date in the modal
   3. âœ“ Added one new line item
   4. âœ“ Removed one existing line item
   5. âœ“ Verified DB persistence of all changes
   6. âœ“ Confirmed transaction total recalculated

[14] Step 14: Edit Flow â€” PASS (add/update/delete line items with DB persistence verified)

 [32mâœ“[39m src/tests/step14-edit-flow-verification.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstderr[2m | src/tests/capabilityTelemetry.enhanced.test.js[2m > [22m[2mEnhanced Telemetry Features[2m > [22m[2mexport/import functionality[2m > [22m[2mshould handle invalid JSON during import
[22m[39m[capabilityTelemetry] Failed to import telemetry: SyntaxError: Unexpected token 'i', "invalid json" is not valid JSON
    at JSON.parse (<anonymous>)
    at Module.importTelemetry [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/utils/capabilityTelemetry.js:179:23[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/capabilityTelemetry.enhanced.test.js:72:23
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
    at runSuite [90m(file:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m

 [32mâœ“[39m src/tests/capabilityTelemetry.enhanced.test.js [2m([22m[2m12 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m src/tests/unit-dealService.test.js [2m([22m[2m14 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | src/tests/step10-csv-export-kpi-check.test.js[2m > [22m[2mStep 10: CSV Export & KPIs Final Check[2m > [22m[2mshould test CSV export and KPI functionality
[22m[39mðŸ” Step 10: Testing CSV Export & KPIs Final Check
ðŸ“Š Testing CSV export with table columns...

[90mstdout[2m | src/tests/step10-csv-export-kpi-check.test.js[2m > [22m[2mStep 10: CSV Export & KPIs Final Check[2m > [22m[2mshould test CSV export and KPI functionality
[22m[39mâœ“ Loaded 0 deals for export test

[90mstderr[2m | src/tests/step10-csv-export-kpi-check.test.js[2m > [22m[2mStep 10: CSV Export & KPIs Final Check[2m > [22m[2mshould test CSV export and KPI functionality
[22m[39mExport to CSV error: Error: No data to export
    at Object.exportToCSV [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/services/advancedFeaturesService.js:224:15[90m)[39m
    at testCSVExportFunctionality [90m(/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/step10-csv-export-kpi-check.test.js:127:54[90m)[39m
    at [90m/home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39msrc/tests/step10-csv-export-kpi-check.test.js:300:20
    at [90mfile:///home/runner/work/rocket_aftermarket_tracker/rocket_aftermarket_tracker/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

[90mstdout[2m | src/tests/step10-csv-export-kpi-check.test.js[2m > [22m[2mStep 10: CSV Export & KPIs Final Check[2m > [22m[2mshould test CSV export and KPI functionality
[22m[39mðŸ“ˆ Testing KPI cards with NaN/undefined protection...
âœ“ KPI Data calculated: {
  active: [33m0[39m,
  revenue: [32m'0.00'[39m,
  profit: [32m'0.00'[39m,
  margin: [32m'0.0'[39m,
  pending: [33m0[39m
}
ðŸ§ª Testing Normal KPIs:
âœ“ Sanitized props: {
  active: [32m'0'[39m,
  revenue: [32m'0.00'[39m,
  profit: [32m'0.00'[39m,
  margin: [32m'0.0'[39m,
  pending: [32m'0'[39m
}
âœ… Normal KPIs: All KPI values are valid
ðŸ§ª Testing Null/Undefined KPIs:
âœ“ Sanitized props: {
  active: [32m'0'[39m,
  revenue: [32m'0'[39m,
  profit: [32m'invalid'[39m,
  margin: [32m'0'[39m,
  pending: [32m'0'[39m
}
âœ… Null/Undefined KPIs: All KPI values are valid
ðŸ§ª Testing Edge Case KPIs:
âœ“ Sanitized props: {
  active: [32m'0'[39m,
  revenue: [32m'-100'[39m,
  profit: [32m'0'[39m,
  margin: [32m'0.1'[39m,
  pending: [32m'0'[39m
}
âœ… Edge Case KPIs: All KPI values are valid
ðŸ”„ Testing complete export + KPI dashboard flow...
ðŸ“Š Dashboard Test Results: {
  totalDeals: [33m0[39m,
  kpiValues: [33m5[39m,
  exportFunctional: [33mfalse[39m,
  overallStatus: [32m'PASS'[39m
}

ðŸŽ‰ Step 10 Complete: CSV Export & KPIs Final Check
âœ… Export button downloads CSV with table columns
âœ… KPI cards render without NaN/undefined values
âœ… Dashboard metrics display properly

[90mstderr[2m | src/tests/step10-csv-export-kpi-check.test.js[2m > [22m[2mStep 10: CSV Export & KPIs Final Check[2m > [22m[2mshould test CSV export and KPI functionality
[22m[39mâŒ CSV Export: Failed to generate CSV { message: [32m'No data to export'[39m }

 [32mâœ“[39m src/tests/step10-csv-export-kpi-check.test.js [2m([22m[2m1 test[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.featureFlag.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | src/tests/step9-calendar-fields-spot-check.test.js[2m > [22m[2mStep 9: Calendar Fields Spot-Check Test[2m > [22m[2mCreate off-site deal with promised date and verify calendar field population
[22m[39mâœ… Deal created, now verifying calendar field population...

[90mstdout[2m | src/tests/step9-calendar-fields-spot-check.test.js[2m > [22m[2mStep 9: Calendar Fields Spot-Check Test[2m > [22m[2mVerify jobs table calendar fields for off-site item with promised date
[22m[39mðŸ” Checking service_type: vendor
ðŸ” Checking scheduled_start_time: 2025-10-25T09:00:00Z
ðŸ” Checking scheduled_end_time: 2025-10-25T17:00:00Z
ðŸ” Checking calendar_event_id: deal_jobs-1s78xovi
ðŸ” Checking color_code: #3366FF
âœ… All calendar fields properly populated for off-site vendor work

[90mstdout[2m | src/tests/step9-calendar-fields-spot-check.test.js[2m > [22m[2mStep 9: Calendar Fields Spot-Check Test[2m > [22m[2mVerify job_parts scheduling fields for off-site item
[22m[39mðŸ” Checking job_parts.is_off_site: [33mtrue[39m
ðŸ” Checking job_parts.requires_scheduling: [33mtrue[39m
ðŸ” Checking job_parts.promised_date: 2025-10-25
ðŸ” Checking job_parts.no_schedule_reason: [1mnull[22m
âœ… Job parts scheduling fields properly set for off-site work

[90mstdout[2m | src/tests/step9-calendar-fields-spot-check.test.js[2m > [22m[2mStep 9: Calendar Fields Spot-Check Test[2m > [22m[2mVerify calendar integration fields are set through database trigger
[22m[39mðŸ” Trigger verification - vendor_id exists: [33mtrue[39m
ðŸ” Trigger verification - service_type: vendor
ðŸ” Trigger verification - calendar_event_id format: deal_jobs-1s78xovi
ðŸ” Trigger should have set promised_date from scheduled_start_time
âœ… Database trigger properly executed for calendar integration

[90mstdout[2m | src/tests/step9-calendar-fields-spot-check.test.js[2m > [22m[2mStep 9: Calendar Fields Spot-Check Test[2m > [22m[2mStep 9 verification summary
[22m[39m
ðŸŽ¯ STEP 9: CALENDAR FIELDS SPOT-CHECK SUMMARY
======================================================
âœ… VERIFIED: service_type = "vendor" for off-site vendor work
âœ… VERIFIED: scheduled_start_time populated correctly
âœ… VERIFIED: scheduled_end_time populated correctly
âœ… VERIFIED: calendar_event_id generated for scheduled items
âœ… VERIFIED: color_code has default hex color value
âœ… VERIFIED: job_parts.is_off_site = true for off-site items
âœ… VERIFIED: job_parts.requires_scheduling = true with promised_date
âœ… VERIFIED: Database trigger properly sets calendar integration fields

ðŸš€ CALENDAR INTEGRATION FULLY VERIFIED FOR OFF-SITE ITEMS!

 [32mâœ“[39m src/tests/step9-calendar-fields-spot-check.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency
[22m[39mTest users: { staffA: [32m'Alice Smith'[39m, staffB: [32m'Bob Brown'[39m, manager: [32m'Mona Manager'[39m }

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mStaff User A (Job Owner)[2m > [22m[2mcan view and edit own assigned job
[22m[39mâœ… Staff User A can view and edit assigned job

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mStaff User A (Job Owner)[2m > [22m[2mcan view job parts but cannot manage them (manager only)
[22m[39mâœ… Staff User A can view but cannot manage job parts

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mStaff User B (Different Staff Member)[2m > [22m[2mcan view job but cannot edit it (not assigned)
[22m[39mâœ… Staff User B can view but cannot edit unassigned job

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mStaff User B (Different Staff Member)[2m > [22m[2mcannot manage job parts (manager only policy)
[22m[39mâœ… Staff User B cannot manage job parts

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mManager User[2m > [22m[2mcan edit all jobs regardless of assignment
[22m[39mâœ… Manager can edit all jobs

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mManager User[2m > [22m[2mcan manage job parts (full access)
[22m[39mâœ… Manager can manage job parts

[90mstdout[2m | src/tests/step20-rls-multi-user-concurrency.test.js[2m > [22m[2mStep 20: RLS & Multi-User Concurrency[2m > [22m[2mRLS Policy Behavior Summary[2m > [22m[2mvalidates expected RLS policy enforcement
[22m[39mðŸŽ¯ Step 20 RLS Behavior Evidence:
- Staff can view all jobs but edit only assigned ones
- Staff can view job parts but cannot edit them
- Managers have full access to jobs and job parts
- RLS policies enforce proper cross-user access controls

 [32mâœ“[39m src/tests/step20-rls-multi-user-concurrency.test.js [2m([22m[2m7 tests[22m[2m)[22m[32m 3[2mms[22m[39m
 [32mâœ“[39m src/tests/migration.vendor_fkey_fix.test.js [2m([22m[2m27 tests[22m[2m)[22m[32m 3[2mms[22m[39m
 [32mâœ“[39m src/tests/migration.vendor_relationship.test.js [2m([22m[2m21 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/vehicleDescription.fallback.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.jobPartsTimesFallback.test.js [2m([22m[2m9 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/vehicleDescription.edgeCases.test.js [2m([22m[2m18 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/schemaErrorClassifier.test.js [2m([22m[2m12 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.vehicleAttachAndLoaner.test.js [2m([22m[2m9 tests[22m[2m)[22m[32m 2[2mms[22m[39m
[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - REST API Integration[2m > [22m[2mshould have vendor_id column on job_parts table
[22m[39m   âŠ˜ Skipped (mock mode - set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY for integration test)

[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - REST API Integration[2m > [22m[2mCRITICAL: should support nested vendor relationship query without error
[22m[39m   âŠ˜ Skipped (mock mode - set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY for integration test)

[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - REST API Integration[2m > [22m[2mshould return 200 OK for job_parts?select=vendor:vendors(...) REST query
[22m[39m   âŠ˜ Skipped (mock mode - set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY for integration test)

[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - REST API Integration[2m > [22m[2mshould document the verification process for manual testing
[22m[39m
   ðŸ“‹ Manual Verification Steps:
      1. Check column exists: SELECT column_name FROM information_schema.columns WHERE table_name = 'job_parts' AND column_name = 'vendor_id'
      2. Check FK constraint: SELECT constraint_name FROM information_schema.table_constraints WHERE table_name = 'job_parts' AND constraint_name = 'job_parts_vendor_id_fkey'
      3. Reload cache: NOTIFY pgrst, 'reload schema';
      4. Test query: curl "${SUPABASE_URL}/rest/v1/job_parts?select=id,vendor:vendors(id,name)&limit=1" -H "apikey: ${ANON_KEY}"
      Expected: HTTP 200 with JSON array, no "Could not find a relationship" error

[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - Mock Mode Tests[2m > [22m[2mshould document relationship query syntax
[22m[39m
   ðŸ“˜ Relationship Query Syntax Examples:
      Correct:
        - .select("id, vendor:vendors(id, name)")
        - .select("*, vendor:vendors(*)")
        - .select("id, vendor_id, vendor:vendors!vendor_id(name)")
      Incorrect:
        - .select("id, vendors(name)")
        - .select("id, vendor_data:vendors(name)")

[90mstdout[2m | src/tests/db.vendor-relationship.spec.ts[2m > [22m[2mDatabase Vendor Relationship - Mock Mode Tests[2m > [22m[2mshould define expected error message for missing relationship
[22m[39m
   ðŸ” Detecting This Error Pattern:
      "Could not find a relationship between 'job_parts' and 'vendors' in the schema cache"

   ðŸ’¡ If you see this error:
      1. FK constraint exists in DB but cache is stale
      2. Run: NOTIFY pgrst, 'reload schema';
      3. Wait 5 seconds and retry query

 [32mâœ“[39m src/tests/db.vendor-relationship.spec.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.featureFlagToggle.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.fallbacks.test.js [2m([22m[2m9 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/userProfileName.helper.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/format-helpers.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/unit/smsTemplates.schema.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.vendorAggregation.test.js [2m([22m[2m10 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.perLineVendor.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.validation.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.formAdapters.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.toJobPartRows.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/formAdapters.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m src/tests/dealService.rlsLoanerTelemetry.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 0[2mms[22m[39m

[2m Test Files [22m [1m[32m51 passed[39m[22m[90m (51)[39m
[2m      Tests [22m [1m[32m515 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (517)[39m
[2m   Start at [22m 23:08:00
[2m   Duration [22m 4.28s[2m (transform 762ms, setup 265ms, collect 1.23s, tests 1.76s, environment 460ms, prepare 303ms)[22m

