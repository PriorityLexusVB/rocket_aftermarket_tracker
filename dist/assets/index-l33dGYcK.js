import{s as G,u as Pe,j as e,B as O,S as Ae,I as qe,a as We,g as Xe,b as He,c as Ge,d as Ze,e as Qe,p as ze,f as ss,h as rs,i as ts,k as ns,l as pe}from"./index-xGVZGovN.js";import{r as k,R as ls}from"./react-Czq5O75u.js";import{dealService as Ie,mapDbDealToForm as Re,getDeal as as,updateDeal as cs,deleteDeal as is,markLoanerReturned as os,getAllDeals as ds}from"./dealService-Cdkah3-K.js";import{s as Le,t as us}from"./options-CllavUpK.js";import{I as Y}from"./Icon-DkrncZxg.js";import{l as xs}from"./vendorService-lheVtlve.js";import{l as hs}from"./smsTemplateService-B227VVoW.js";import{N as Ve}from"./Navbar-I6vrhnIS.js";import{a as ms}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const gs=(t,u="")=>t==null?u:String(t),Ce={async getOverdueJobs(){var t;try{const{data:u,error:r}=await((t=G)==null?void 0:t.rpc("get_overdue_jobs_enhanced"));return r?(console.error("Error fetching overdue jobs:",r),{data:[],error:{message:r==null?void 0:r.message}}):{data:u||[],error:null}}catch(u){return console.error("Error in getOverdueJobs service:",u),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var t,u,r,i;try{const{data:x,error:d}=await((i=(r=(u=(t=G)==null?void 0:t.from("sms_templates"))==null?void 0:u.select("*"))==null?void 0:r.eq("is_active",!0))==null?void 0:i.order("created_at",{ascending:!1}));return d?{data:[],error:{message:d==null?void 0:d.message}}:{data:x||[],error:null}}catch(x){return console.error("Error fetching SMS templates:",x),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(t){var u,r,i,x,d,o,b,v;try{const f=await((r=(u=G)==null?void 0:u.auth)==null?void 0:r.getUser()),{data:y,error:h}=await((v=(b=(o=(i=G)==null?void 0:i.from("sms_templates"))==null?void 0:o.insert([{...t,created_by:(d=(x=f==null?void 0:f.data)==null?void 0:x.user)==null?void 0:d.id}]))==null?void 0:b.select())==null?void 0:v.single());return h?{data:null,error:{message:h==null?void 0:h.message}}:{data:y,error:null}}catch(f){return console.error("Error creating SMS template:",f),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(t,u){var r,i,x,d,o,b;try{const{data:v,error:f}=await((b=(o=(d=(x=(r=G)==null?void 0:r.from("sms_templates"))==null?void 0:x.update({...u,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:d.eq("id",t))==null?void 0:o.select())==null?void 0:b.single());return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:v,error:null}}catch(v){return console.error("Error updating SMS template:",v),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(t){var u,r,i;try{const{error:x}=await((i=(r=(u=G)==null?void 0:u.from("sms_templates"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return x?{error:{message:x==null?void 0:x.message}}:{error:null}}catch(x){return console.error("Error deleting SMS template:",x),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(t){var u,r,i,x,d,o,b,v,f;try{const y=await((r=(u=G)==null?void 0:u.auth)==null?void 0:r.getUser()),{data:h,error:P}=await((f=(v=(d=(x=(i=G)==null?void 0:i.from("filter_presets"))==null?void 0:x.select("*"))==null?void 0:d.eq("page_type",t))==null?void 0:v.or(`user_id.eq.${(b=(o=y==null?void 0:y.data)==null?void 0:o.user)==null?void 0:b.id},is_public.eq.true`))==null?void 0:f.order("created_at",{ascending:!1}));return P?{data:[],error:{message:P==null?void 0:P.message}}:{data:h||[],error:null}}catch(y){return console.error("Error fetching filter presets:",y),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(t,u,r,i=!1){var x,d,o,b,v,f,y,h;try{const P=await((d=(x=G)==null?void 0:x.auth)==null?void 0:d.getUser()),{data:ee,error:z}=await((h=(y=(f=(o=G)==null?void 0:o.from("filter_presets"))==null?void 0:f.insert([{user_id:(v=(b=P==null?void 0:P.data)==null?void 0:b.user)==null?void 0:v.id,page_type:t,name:u,filters:r,is_public:i}]))==null?void 0:y.select())==null?void 0:h.single());return z?{data:null,error:{message:z==null?void 0:z.message}}:{data:ee,error:null}}catch(P){return console.error("Error saving filter preset:",P),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(t){var u,r,i;try{const{error:x}=await((i=(r=(u=G)==null?void 0:u.from("filter_presets"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return x?{error:{message:x==null?void 0:x.message}}:{error:null}}catch(x){return console.error("Error deleting filter preset:",x),{error:{message:"Failed to delete filter preset"}}}},async exportData(t,u={},r="staff"){var i,x;try{const{data:d,error:o}=await((i=G)==null?void 0:i.rpc("generate_export_data",{export_type:t,filters:u,user_role:r}));return o?{data:null,error:{message:o==null?void 0:o.message}}:{data:(x=d||[])==null?void 0:x.map(v=>{var h;const f=(v==null?void 0:v.export_data)||v,y={};return(h=Object==null?void 0:Object.entries(f))==null||h.forEach(([P,ee])=>{typeof ee=="number"?y[P]=isNaN(ee)?0:ee:ee==null?y[P]="":y[P]=ee}),{export_data:y}}),error:null}}catch(d){return console.error("Error exporting data:",d),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(t,u,r=null){var i,x,d,o;try{if(!t||(t==null?void 0:t.length)===0)throw new Error("No data to export");let b="";if(r)b+=(r==null?void 0:r.join(","))+`
`;else{const y=((i=t==null?void 0:t[0])==null?void 0:i.export_data)||(t==null?void 0:t[0]);y&&(b+=((x=Object==null?void 0:Object.keys(y))==null?void 0:x.join(","))+`
`)}t==null||t.forEach(y=>{var ee;const h=(y==null?void 0:y.export_data)||y,P=(ee=Object==null?void 0:Object.values(h))==null?void 0:ee.map(z=>{if(z==null)return"";if(typeof z=="number"&&isNaN(z))return"0";let _=gs(z);return _!=null&&_.includes(",")||_!=null&&_.includes('"')?`"${_==null?void 0:_.replace(/"/g,'""')}"`:_});b+=(P==null?void 0:P.join(","))+`
`});const v=new Blob([b],{type:"text/csv;charset=utf-8;"}),f=document.createElement("a");if((f==null?void 0:f.download)!==void 0){const y=URL==null?void 0:URL.createObjectURL(v);f==null||f.setAttribute("href",y),f==null||f.setAttribute("download",u),f.style.visibility="hidden",(d=document.body)==null||d.appendChild(f),f==null||f.click(),(o=document.body)==null||o.removeChild(f),URL==null||URL.revokeObjectURL(y)}return{success:!0,error:null}}catch(b){return console.error("Export to CSV error:",b),{success:!1,error:{message:(b==null?void 0:b.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(t,u){var r,i,x,d,o;try{const b=await((i=(r=G)==null?void 0:r.auth)==null?void 0:i.getUser()),{data:v,error:f}=await((o=G)==null?void 0:o.rpc("bulk_update_jobs",{job_ids:t,updates:u,performed_by:(d=(x=b==null?void 0:b.data)==null?void 0:x.user)==null?void 0:d.id}));return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:(v==null?void 0:v[0])||null,error:null}}catch(b){return console.error("Error in bulk update jobs:",b),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var t,u,r,i,x,d,o;try{const b=await((u=(t=G)==null?void 0:t.auth)==null?void 0:u.getUser()),{data:v,error:f}=await((o=(i=(r=G)==null?void 0:r.from("notification_preferences"))==null?void 0:i.select("*"))==null?void 0:o.eq("user_id",(d=(x=b==null?void 0:b.data)==null?void 0:x.user)==null?void 0:d.id));return f?{data:[],error:{message:f==null?void 0:f.message}}:{data:v||[],error:null}}catch(b){return console.error("Error fetching notification preferences:",b),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(t){var u,r,i,x,d,o,b,v,f,y;try{const h=await((r=(u=G)==null?void 0:u.auth)==null?void 0:r.getUser());await((b=(x=(i=G)==null?void 0:i.from("notification_preferences"))==null?void 0:x.delete())==null?void 0:b.eq("user_id",(o=(d=h==null?void 0:h.data)==null?void 0:d.user)==null?void 0:o.id));const P=t==null?void 0:t.map(_=>{var m,I;return{..._,user_id:(I=(m=h==null?void 0:h.data)==null?void 0:m.user)==null?void 0:I.id}}),{data:ee,error:z}=await((y=(f=(v=G)==null?void 0:v.from("notification_preferences"))==null?void 0:f.insert(P))==null?void 0:y.select());return z?{data:null,error:{message:z==null?void 0:z.message}}:{data:ee,error:null}}catch(h){return console.error("Error updating notification preferences:",h),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(t){var u,r,i;try{return(i=(r=(u=G)==null?void 0:u.channel("overdue-jobs"))==null?void 0:r.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},d=>{var o;(o=this.getOverdueJobs())==null||o.then(b=>{b!=null&&b.data&&t(b==null?void 0:b.data)})}))==null?void 0:i.subscribe()}catch(x){return console.error("Error subscribing to overdue jobs:",x),null}},async searchWithFilters(t,u,r){var i,x,d;try{let o=(i=G)==null?void 0:i.from(r);if(t)switch(r){case"jobs":o=o==null?void 0:o.or(`job_number.ilike.%${t}%,title.ilike.%${t}%`);break;case"vehicles":o=o==null?void 0:o.or(`vin.ilike.%${t}%,make.ilike.%${t}%,model.ilike.%${t}%`);break;case"vendors":o=o==null?void 0:o.or(`name.ilike.%${t}%,specialty.ilike.%${t}%`);break}(x=Object==null?void 0:Object.entries(u))==null||x.forEach(([f,y])=>{y!=null&&y!==""&&(Array!=null&&Array.isArray(y)?o=o==null?void 0:o.in(f,y):typeof y=="object"&&(y==null?void 0:y.min)!==void 0?o=o==null?void 0:o.gte(f,y==null?void 0:y.min):typeof y=="object"&&(y==null?void 0:y.max)!==void 0?o=o==null?void 0:o.lte(f,y==null?void 0:y.max):o=o==null?void 0:o.eq(f,y))});const{data:b,error:v}=await((d=o==null?void 0:o.select("*"))==null?void 0:d.order("created_at",{ascending:!1}));return v?{data:[],error:{message:v==null?void 0:v.message}}:{data:b||[],error:null}}catch(o){return console.error("Error in search with filters:",o),{data:[],error:{message:"Failed to search with filters"}}}}},bs=({exportType:t,filters:u={},selectedIds:r=[],onExportStart:i,onExportComplete:x,onExportError:d,disabled:o=!1,variant:b="outline",size:v="sm",className:f=""})=>{var $;const[y,h]=k.useState(!1),[P,ee]=k.useState(!1),[z,_]=k.useState("csv"),[m,I]=k.useState("filtered"),{user:c,userProfile:ne}=Pe(),g=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],F=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(r==null?void 0:r.length)>0?[{value:"selected",label:`Selected (${r==null?void 0:r.length})`}]:[]],M=()=>{var K,he,le;const U=(le=(he=(K=new Date)==null?void 0:K.toISOString())==null?void 0:he.split("T"))==null?void 0:le[0];return`${t}-${m==="selected"?"selected":m}-${U}.${z}`},R=async()=>{var U,ge,K,he;if(!y)try{h(!0),i&&i();let le={...u};m==="selected"&&(r==null?void 0:r.length)>0&&(le.ids=r),m==="all"&&(le={});const se=await(Ce==null?void 0:Ce.exportData(t,le,(ne==null?void 0:ne.role)||"staff"));if(se!=null&&se.error)throw new Error((U=se==null?void 0:se.error)==null?void 0:U.message);if(!(se!=null&&se.data)||((ge=se==null?void 0:se.data)==null?void 0:ge.length)===0)throw new Error("No data found to export");const p=M(),q=await(Ce==null?void 0:Ce.exportToCSV(se==null?void 0:se.data,p));if(q!=null&&q.error)throw new Error((K=q==null?void 0:q.error)==null?void 0:K.message);ee(!1),x&&x((he=se==null?void 0:se.data)==null?void 0:he.length,p)}catch(le){console.error("Export error:",le),d&&d((le==null?void 0:le.message)||"Export failed")}finally{h(!1)}},w=()=>{switch(t){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(O,{variant:b,size:v,onClick:()=>ee(!P),disabled:o||y,iconName:y?void 0:"Download",iconPosition:"left",className:`${f} ${y?"cursor-wait":""}`,"aria-label":`Export ${w()}`,children:y?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${w()}`}),P&&!y&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ae,{value:z,onChange:_,options:g,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ae,{value:m,onChange:I,options:F,className:"w-full"})]}),m==="filtered"&&(($=Object==null?void 0:Object.keys(u))==null?void 0:$.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(qe,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),m==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(qe,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",r==null?void 0:r.length," selected record",(r==null?void 0:r.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>ee(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(O,{size:"sm",onClick:R,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${w()}`,children:"Export"})]})]})})]})},Ue={async getVehicles(t={},u=null){var r,i,x,d;try{let o=(x=(i=(r=G)==null?void 0:r.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:x.order("created_at",{ascending:!1});return u&&(o=o==null?void 0:o.eq("org_id",u)),t!=null&&t.status&&(o=o==null?void 0:o.eq("vehicle_status",t==null?void 0:t.status)),t!=null&&t.make&&(o=o==null?void 0:o.eq("make",t==null?void 0:t.make)),t!=null&&t.year&&(o=o==null?void 0:o.eq("year",t==null?void 0:t.year)),t!=null&&t.search&&(o=o==null?void 0:o.or(`vin.ilike.%${t==null?void 0:t.search}%,make.ilike.%${t==null?void 0:t.search}%,model.ilike.%${t==null?void 0:t.search}%,license_plate.ilike.%${t==null?void 0:t.search}%,owner_name.ilike.%${t==null?void 0:t.search}%,owner_phone.ilike.%${t==null?void 0:t.search}%,owner_email.ilike.%${t==null?void 0:t.search}%,stock_number.ilike.%${t==null?void 0:t.search}%`)),{data:await Le(o,"vehicles:getVehicles")||[],error:null}}catch(o){return(d=o==null?void 0:o.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(t,u=null){var r,i,x,d,o;try{let b=(d=(x=(i=(r=G)==null?void 0:r.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:x.eq("id",t))==null?void 0:d.single();return u&&(b=b==null?void 0:b.eq("org_id",u)),{data:await Le(b,"vehicles:getVehicleById"),error:null}}catch(b){return(o=b==null?void 0:b.message)!=null&&o.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(t){var u,r,i,x,d,o,b,v,f,y;try{const{data:h,error:P}=await((f=(v=(b=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:b.insert([{...t,created_by:(o=(d=(x=await((i=(r=G)==null?void 0:r.auth)==null?void 0:i.getUser()))==null?void 0:x.data)==null?void 0:d.user)==null?void 0:o.id}]))==null?void 0:v.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:f.single());return P?{data:null,error:{message:P==null?void 0:P.message}}:{data:h,error:null}}catch(h){return(y=h==null?void 0:h.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(t){var u,r,i,x;try{const{data:d,error:o}=await((x=(i=(r=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:r.insert([t]))==null?void 0:i.select())==null?void 0:x.single());if(o)throw console.error("Vehicle creation error:",o),new Error(o.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",d),d}catch(d){throw console.error("Error in vehicleService.create:",d),d}},async createVehicleWithProducts(t){var u,r;try{console.log("Creating vehicle with products:",t);const i=`vehicle_${Date.now()}`;await new Promise(d=>setTimeout(d,1e3));const x={id:i,...t,created_at:(u=new Date)==null?void 0:u.toISOString(),initial_products_count:((r=t==null?void 0:t.initial_products)==null?void 0:r.length)||0,estimated_aftermarket_value:(t==null?void 0:t.total_initial_product_value)||0};return console.log("Vehicle created successfully:",x),x}catch(i){throw console.error("Error creating vehicle with products:",i),i}},async checkStockNumberExists(t){var u,r,i,x;if(!(t!=null&&t.trim()))return!1;try{const{data:d,error:o}=await((x=(i=(r=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:i.eq("stock_number",t==null?void 0:t.trim()))==null?void 0:x.maybeSingle());return o?(console.error("Stock number check error:",o),!1):!!d}catch(d){return console.error("Error checking stock number:",d),!1}},async checkVinExists(t){var u,r,i,x;if(!(t!=null&&t.trim()))return!1;try{const{data:d,error:o}=await((x=(i=(r=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:i.eq("vin",t==null?void 0:t.trim()))==null?void 0:x.maybeSingle());return o?(console.error("VIN check error:",o),!1):!!d}catch(d){return console.error("Error checking VIN:",d),!1}},async updateVehicle(t,u){var r,i,x,d,o,b,v;try{const{data:f,error:y}=await((b=(o=(d=(x=(r=G)==null?void 0:r.from("vehicles"))==null?void 0:x.update({...u,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:d.eq("id",t))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:b.single());return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:f,error:null}}catch(f){return(v=f==null?void 0:f.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(t){var u,r,i,x;try{const{error:d}=await((i=(r=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return(x=d==null?void 0:d.message)!=null&&x.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(t=null){var u,r,i,x,d,o,b;try{let v=(r=(u=G)==null?void 0:u.from("vehicles"))==null?void 0:r.select("vehicle_status");t&&(v=v==null?void 0:v.eq("org_id",t));const f=await Le(v,"vehicles:getVehicleStats");return{data:{total:(f==null?void 0:f.length)||0,active:((i=f==null?void 0:f.filter(h=>(h==null?void 0:h.vehicle_status)==="active"))==null?void 0:i.length)||0,maintenance:((x=f==null?void 0:f.filter(h=>(h==null?void 0:h.vehicle_status)==="maintenance"))==null?void 0:x.length)||0,retired:((d=f==null?void 0:f.filter(h=>(h==null?void 0:h.vehicle_status)==="retired"))==null?void 0:d.length)||0,sold:((o=f==null?void 0:f.filter(h=>(h==null?void 0:h.vehicle_status)==="sold"))==null?void 0:o.length)||0},error:null}}catch(v){return(b=v==null?void 0:v.message)!=null&&b.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(t={}){return await this.getVehicles(t)}};function fs({isOpen:t,onClose:u,onSuccess:r}){var j,V,re;const{user:i}=Pe(),{orgId:x}=We()||{},[d,o]=k.useState(1),[b,v]=k.useState(!1),[f,y]=k.useState(""),[h,P]=k.useState(!1),[ee,z]=k.useState(!1),[_,m]=k.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),I={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(j=new Date)==null?void 0:j.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[c,ne]=k.useState(I),[g,F]=k.useState([]),M=async(l=0)=>{var S,A;try{m(J=>({...J,loading:!0,error:null,retryCount:l}));const[ie,ae,ce,L,W]=await Promise.all([Xe().catch(()=>[]),He().catch(()=>[]),Ge().catch(()=>[]),Ze({activeOnly:!0}).catch(()=>[]),Qe({activeOnly:!0}).catch(()=>[])]);m({salesConsultants:ie,deliveryCoordinators:ae,financeManagers:ce,vendors:L,products:W==null?void 0:W.map(J=>({...J,unitPrice:J==null?void 0:J.unit_price})),loading:!1,error:null,retryCount:l})}catch(ie){if(console.error("Failed to load dropdown data:",ie),l<2&&((S=ie==null?void 0:ie.message)!=null&&S.includes("fetch")||(A=ie==null?void 0:ie.message)!=null&&A.includes("network"))){setTimeout(()=>M(l+1),1e3*(l+1));return}m(ae=>({...ae,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:l}))}},R=({checked:l,onChange:S})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!l,onChange:A=>{var ae;const ie=!!((ae=A==null?void 0:A.target)!=null&&ae.checked);S(ie)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),w=({label:l,options:S,value:A,onChange:ie,placeholder:ae,required:ce=!1,helpText:L,testId:W})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l," ",ce&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:A||"",onChange:J=>{var T;return ie(((T=J==null?void 0:J.target)==null?void 0:T.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:_==null?void 0:_.loading,required:ce,"data-testid":W,children:[e.jsx("option",{value:"",children:ae}),S==null?void 0:S.map(J=>e.jsx("option",{value:J==null?void 0:J.id,children:(J==null?void 0:J.full_name)||(J==null?void 0:J.label)||(J==null?void 0:J.name)},J==null?void 0:J.id))]}),L&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:L}),(S==null?void 0:S.length)===0&&!(_!=null&&_.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No ",l==null?void 0:l.toLowerCase()," found yet. Add it in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]});k.useEffect(()=>{const l=(c==null?void 0:c.customerName)!==(I==null?void 0:I.customerName)||(c==null?void 0:c.customerPhone)!==(I==null?void 0:I.customerPhone)||(c==null?void 0:c.customerEmail)!==(I==null?void 0:I.customerEmail)||(c==null?void 0:c.needsLoaner)!==(I==null?void 0:I.needsLoaner)||(c==null?void 0:c.assignedTo)!==(I==null?void 0:I.assignedTo)||(c==null?void 0:c.deliveryCoordinator)!==(I==null?void 0:I.deliveryCoordinator)||(c==null?void 0:c.financeManager)!==(I==null?void 0:I.financeManager)||(g==null?void 0:g.length)>0;P(l)},[c,g]),k.useEffect(()=>{t&&M()},[t]);const $=()=>{F(l=>[...l,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},U=(l,S,A)=>{var ie;if(F(ae=>ae==null?void 0:ae.map(ce=>{if((ce==null?void 0:ce.id)===l){let L={...ce,[S]:A};return S==="requiresScheduling"&&(A===!0?L.noScheduleReason="":L.promisedDate=""),L}return ce})),S==="productId"&&A){const ae=(ie=_==null?void 0:_.products)==null?void 0:ie.find(ce=>(ce==null?void 0:ce.id)===A);ae&&F(ce=>ce==null?void 0:ce.map(L=>(L==null?void 0:L.id)===l?{...L,unitPrice:(ae==null?void 0:ae.unitPrice)||""}:L))}},ge=l=>{F(S=>S==null?void 0:S.filter(A=>(A==null?void 0:A.id)!==l))},K=()=>{var l,S;return((S=(l=c==null?void 0:c.customerName)==null?void 0:l.trim())==null?void 0:S.length)>0},he=()=>(g==null?void 0:g.length)===0?!1:g==null?void 0:g.every(l=>{var S;return!(!(l!=null&&l.productId)||!(l!=null&&l.unitPrice)||l!=null&&l.requiresScheduling&&!(l!=null&&l.promisedDate)||!(l!=null&&l.requiresScheduling)&&!((S=l==null?void 0:l.noScheduleReason)!=null&&S.trim())||(l==null?void 0:l.serviceType)==="vendor"&&!(l!=null&&l.vendorId))}),le=()=>g==null?void 0:g.reduce((l,S)=>l+(parseFloat(S==null?void 0:S.unitPrice)||0),0),se=async()=>{var l,S,A,ie,ae,ce,L,W,J,T;if(!K()){y("Customer name is required to save draft");return}v(!0),y("");try{const D={year:(c==null?void 0:c.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(S=c==null?void 0:c.customerName)==null?void 0:S.trim(),owner_phone:((A=c==null?void 0:c.customerPhone)==null?void 0:A.trim())||null,owner_email:((ie=c==null?void 0:c.customerEmail)==null?void 0:ie.trim())||null,stock_number:((ae=c==null?void 0:c.stockNumber)==null?void 0:ae.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...x?{org_id:x}:{}},Ne=await Ue.create(D),je={title:`Draft Deal - ${(ce=c==null?void 0:c.customerName)==null?void 0:ce.trim()}`,description:`Draft deal for ${(L=c==null?void 0:c.customerName)==null?void 0:L.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:Ne==null?void 0:Ne.id,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),customerName:(W=c==null?void 0:c.customerName)==null?void 0:W.trim(),customerPhone:((J=c==null?void 0:c.customerPhone)==null?void 0:J.trim())||"",customerEmail:((T=c==null?void 0:c.customerEmail)==null?void 0:T.trim())||"",org_id:x||void 0,lineItems:[]};await Ie.createDeal(je),r==null||r(),q(),u()}catch(D){y(`Failed to save draft: ${D==null?void 0:D.message}`)}finally{v(!1)}},p=async()=>{var l,S,A,ie,ae,ce,L,W,J,T,D,Ne;if(!K()||!he()){y("Please complete all required fields");return}v(!0),y("");try{const je={year:(c==null?void 0:c.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(S=c==null?void 0:c.customerName)==null?void 0:S.trim(),owner_phone:((A=c==null?void 0:c.customerPhone)==null?void 0:A.trim())||null,owner_email:((ie=c==null?void 0:c.customerEmail)==null?void 0:ie.trim())||null,stock_number:((ae=c==null?void 0:c.stockNumber)==null?void 0:ae.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...x?{org_id:x}:{}},s=await Ue.create(je),E=le(),B=(g==null?void 0:g.some(a=>(a==null?void 0:a.serviceType)==="vendor"))?"vendor":"in_house",H=((ce=g==null?void 0:g.find(a=>a==null?void 0:a.vendorId))==null?void 0:ce.vendorId)||null;let ue=null;if(B==="vendor"){const a=(g||[]).filter(n=>(n==null?void 0:n.serviceType)==="vendor"&&(n==null?void 0:n.requiresScheduling)&&(n==null?void 0:n.promisedDate)).map(n=>new Date(n==null?void 0:n.promisedDate)).sort((n,N)=>n-N);ue=(L=(a==null?void 0:a[0])||new Date)==null?void 0:L.toISOString()}const xe=(g||[]).map(a=>({product_id:a==null?void 0:a.productId,quantity_used:1,unit_price:parseFloat((a==null?void 0:a.unitPrice)||0),promised_date:a!=null&&a.requiresScheduling?a==null?void 0:a.promisedDate:null,requires_scheduling:!!(a!=null&&a.requiresScheduling),no_schedule_reason:a!=null&&a.requiresScheduling?null:a==null?void 0:a.noScheduleReason,is_off_site:(a==null?void 0:a.serviceType)==="vendor"})),oe={title:`Deal - ${(W=c==null?void 0:c.customerName)==null?void 0:W.trim()}`,description:`Deal for ${(J=c==null?void 0:c.customerName)==null?void 0:J.trim()}`,job_status:"pending",service_type:B,vehicle_id:s==null?void 0:s.id,vendor_id:H,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),scheduled_start_time:ue,estimated_cost:E,org_id:x||void 0,customerName:(T=c==null?void 0:c.customerName)==null?void 0:T.trim(),customerPhone:((D=c==null?void 0:c.customerPhone)==null?void 0:D.trim())||"",customerEmail:((Ne=c==null?void 0:c.customerEmail)==null?void 0:Ne.trim())||"",lineItems:xe},fe=await Ie.createDeal(oe);await Ie.updateDeal(fe==null?void 0:fe.id,oe),r==null||r(),q(),u()}catch(je){y(`Failed to create deal: ${je==null?void 0:je.message}`)}finally{v(!1)}},q=()=>{o(1),ne(I),F([]),y(""),P(!1)},ve=()=>{h?z(!0):(q(),u())},ke=()=>{z(!1),q(),u()};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:ve,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(Y,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${d>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${d>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[f&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",f]}),e.jsx("button",{onClick:()=>y(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(Y,{name:"X",size:16})})]})}),(_==null?void 0:_.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",_==null?void 0:_.error]}),e.jsx("button",{onClick:()=>M(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),d===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:c==null?void 0:c.customerName,onChange:l=>ne(S=>{var A;return{...S,customerName:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:c==null?void 0:c.customerPhone,onChange:l=>ne(S=>{var A;return{...S,customerPhone:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:c==null?void 0:c.customerEmail,onChange:l=>ne(S=>{var A;return{...S,customerEmail:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(c==null?void 0:c.vehicleYear)||"",onChange:l=>ne(S=>{var A;return{...S,vehicleYear:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((V=new Date)==null?void 0:V.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleMake)||"",onChange:l=>ne(S=>{var A;return{...S,vehicleMake:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleModel)||"",onChange:l=>ne(S=>{var A;return{...S,vehicleModel:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.stockNumber)||"",onChange:l=>ne(S=>{var A;return{...S,stockNumber:(A=l==null?void 0:l.target)==null?void 0:A.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(R,{checked:c==null?void 0:c.needsLoaner,onChange:l=>{ne(S=>({...S,needsLoaner:!!l}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(w,{label:"Sales Consultant",options:_==null?void 0:_.salesConsultants,value:c==null?void 0:c.assignedTo,onChange:l=>ne(S=>({...S,assignedTo:l})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(w,{label:"Delivery Coordinator",options:_==null?void 0:_.deliveryCoordinators,value:c==null?void 0:c.deliveryCoordinator,onChange:l=>ne(S=>({...S,deliveryCoordinator:l})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(w,{label:"Finance Manager",options:_==null?void 0:_.financeManagers,value:c==null?void 0:c.financeManager,onChange:l=>ne(S=>({...S,financeManager:l})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),d===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(O,{onClick:$,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(Y,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(g==null?void 0:g.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(Y,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[g==null?void 0:g.map((l,S)=>{var A,ie,ae,ce,L,W,J;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",S+1]}),e.jsx("button",{onClick:()=>ge(l==null?void 0:l.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(Y,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.productId)||"",onChange:T=>{var D;return U(l==null?void 0:l.id,"productId",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${S}`,children:[e.jsx("option",{value:"",children:"Select product"}),(A=_==null?void 0:_.products)==null?void 0:A.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(_!=null&&_.loading)&&(((ie=_==null?void 0:_.products)==null?void 0:ie.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No products found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:l==null?void 0:l.unitPrice,onChange:T=>{var D;return U(l==null?void 0:l.id,"unitPrice",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${S}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"in_house",checked:(l==null?void 0:l.serviceType)==="in_house",onChange:T=>{var D;return U(l==null?void 0:l.id,"serviceType",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"vendor",checked:(l==null?void 0:l.serviceType)==="vendor",onChange:T=>{var D;return U(l==null?void 0:l.id,"serviceType",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(l==null?void 0:l.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.vendorId)||"",onChange:T=>{var D;return U(l==null?void 0:l.id,"vendorId",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(ae=_==null?void 0:_.vendors)==null?void 0:ae.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(_!=null&&_.loading)&&(((ce=_==null?void 0:_.vendors)==null?void 0:ce.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${S}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!0,onChange:()=>U(l==null?void 0:l.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${S}`,"data-testid":`requires-scheduling-${S}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${S}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!1,onChange:()=>U(l==null?void 0:l.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${S}`}),"No Scheduling Needed"]})]}),l!=null&&l.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:l==null?void 0:l.promisedDate,onChange:T=>{var D;return U(l==null?void 0:l.id,"promisedDate",(D=T==null?void 0:T.target)==null?void 0:D.value)},min:(J=(W=(L=new Date)==null?void 0:L.toISOString())==null?void 0:W.split("T"))==null?void 0:J[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:l==null?void 0:l.noScheduleReason,onChange:T=>{var D;return U(l==null?void 0:l.id,"noScheduleReason",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:l==null?void 0:l.serviceNotes,onChange:T=>{var D;return U(l==null?void 0:l.id,"serviceNotes",(D=T==null?void 0:T.target)==null?void 0:D.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},l==null?void 0:l.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(re=le())==null?void 0:re.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[g==null?void 0:g.length," item",(g==null?void 0:g.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:d===2&&e.jsx(O,{onClick:()=>o(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(O,{onClick:ve,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),d===1&&e.jsxs(e.Fragment,{children:[e.jsx(O,{onClick:se,disabled:!K()||b,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:b?"Saving...":"Save Draft"}),e.jsx(O,{onClick:()=>o(2),disabled:!K(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),d===2&&e.jsx(O,{onClick:p,disabled:!K()||!he()||b,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:b?"Creating...":"Create Deal"})]})]})}),ee&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(O,{variant:"outline",onClick:()=>z(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(O,{onClick:ke,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function ps(t,{activeOnly:u=!0}={}){let r=G.from("products").select("*").order("name",{ascending:!0});u&&(r=r.eq("is_active",!0)),t&&(r=r.or(`org_id.eq.${t},org_id.is.null`));const i=await Le(r,"products:listByOrg");return us(i,{labelKey:"name",valueKey:"id"})}function js(t,{activeOnly:u=!0}={}){let r=G.from("user_profiles").select("*").order("full_name",{ascending:!0});return u&&(r=r.eq("is_active",!0)),t&&(r=r.eq("org_id",t)),Le(r,"staff:listByOrg")}function De(t={}){var m,I,c,ne;const{loadOnMount:u=!0,cacheTime:r=5*60*1e3}=t,[i,x]=k.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[d,o]=k.useState(null),b=We(),v=Pe(),f=async()=>{var g,F,M,R;try{if(b.loading)return;if(x(q=>({...q,loading:!0,error:null})),!((g=b.session)!=null&&g.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),x(q=>({...q,loading:!1}));return}const w=!!b.orgId,$=[(F=He())==null?void 0:F.catch(q=>(console.error("[dropdowns:dc] Delivery coordinators failed:",q),[])),(M=Xe())==null?void 0:M.catch(q=>(console.error("[dropdowns:sales] Sales consultants failed:",q),[])),(R=Ge())==null?void 0:R.catch(q=>(console.error("[dropdowns:finance] Finance managers failed:",q),[])),w?js(b.orgId).catch(q=>(console.error("[dropdowns:users] tenant staff failed:",q),[])):ts({activeOnly:!0}).catch(q=>(console.error("[dropdowns:users] global user profiles failed:",q),[])),w?xs(b.orgId).catch(q=>(console.error("[dropdowns:vendors] tenant vendors failed:",q),[])):Ze({activeOnly:!0}).catch(q=>(console.error("[dropdowns:vendors] global vendors failed:",q),[])),w?ps(b.orgId).catch(q=>(console.error("[dropdowns:products] tenant products failed:",q),[])):Qe({activeOnly:!0}).catch(q=>(console.error("[dropdowns:products] global products failed:",q),[])),w?hs(b.orgId).catch(q=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",q),[])):Promise.resolve([])],[U,ge,K,he,le,se,p]=await Promise.all($);x({dc:U,sales:ge,finance:K,users:he,vendors:le,products:se,smsTemplates:p,loading:!1,error:null,searchResults:null}),o(Date.now())}catch(w){x({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(w==null?void 0:w.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",w)}};k.useEffect(()=>{try{const g=ze({departments:["Sales","Sales Consultant","Sales Consultants"]}),F=ze({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),M=ze({departments:["Finance","Finance Manager","Finance Managers"]}),R=ss({activeOnly:!0}),w=rs({activeOnly:!0});[g==null?void 0:g.length,F==null?void 0:F.length,M==null?void 0:M.length,R==null?void 0:R.length,w==null?void 0:w.length].some(Boolean)&&x(U=>({...U,sales:g||U.sales,dc:F||U.dc,finance:M||U.finance,vendors:R||U.vendors,products:w||U.products,loading:!1,error:null}))}catch(g){console.info("[dropdowns] cached-first hydrate skipped:",g==null?void 0:g.message)}},[]);const y=()=>d?Date.now()-d<r:!1,h=async()=>{y()||await f()},P=async g=>{try{if(!(g!=null&&g.trim())){x(M=>({...M,searchResults:null}));return}const F=await ns(g);x(M=>({...M,searchResults:F}))}catch(F){console.error("[dropdowns:search] Search failed:",F),x(M=>({...M,searchResults:{users:[],vendors:[]}}))}},ee=()=>{x(g=>({...g,searchResults:null}))},z=(g={})=>{const{roles:F=[],departments:M=[],activeOnly:R=!0}=g;let w=(i==null?void 0:i.users)||[];return R&&(w=w==null?void 0:w.filter($=>$==null?void 0:$.is_active)),(F==null?void 0:F.length)>0&&(w=w==null?void 0:w.filter($=>F==null?void 0:F.includes($==null?void 0:$.role))),(M==null?void 0:M.length)>0&&(w=w==null?void 0:w.filter($=>M==null?void 0:M.includes($==null?void 0:$.department))),(w==null?void 0:w.map($=>({id:$==null?void 0:$.id,value:$==null?void 0:$.id,label:$==null?void 0:$.full_name,name:$==null?void 0:$.full_name,role:$==null?void 0:$.role,department:$==null?void 0:$.department,email:$==null?void 0:$.email})))||[]},_=(g={})=>{const{activeOnly:F=!0,specialty:M=null}=g;let R=(i==null?void 0:i.vendors)||[];return F&&(R=R==null?void 0:R.filter(w=>w==null?void 0:w.is_active)),M&&(R=R==null?void 0:R.filter(w=>{var $,U;return(U=($=w==null?void 0:w.specialty)==null?void 0:$.toLowerCase())==null?void 0:U.includes(M==null?void 0:M.toLowerCase())})),(R==null?void 0:R.map(w=>({id:w==null?void 0:w.id,value:(w==null?void 0:w.value)||(w==null?void 0:w.id),label:(w==null?void 0:w.label)||(w==null?void 0:w.name),name:w==null?void 0:w.name,specialty:w==null?void 0:w.specialty,email:w==null?void 0:w.email,phone:w==null?void 0:w.phone})))||[]};return k.useEffect(()=>{let g=!0;return(async()=>{var M;if(!u)return;const F=Date.now();for(;g&&(v!=null&&v.loading)&&Date.now()-F<5e3;)await new Promise(R=>setTimeout(R,200));g&&(v!=null&&v.user?(console.log("Dropdowns: authenticated user",(M=v==null?void 0:v.user)==null?void 0:M.id),v!=null&&v.userProfile&&console.log("Dropdowns: user profile org",v.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),g&&await f())})(),()=>{g=!1}},[u,v==null?void 0:v.loading,(m=v==null?void 0:v.user)==null?void 0:m.id,b==null?void 0:b.loading,b==null?void 0:b.orgId]),{dc:i==null?void 0:i.dc,sales:i==null?void 0:i.sales,finance:i==null?void 0:i.finance,users:i==null?void 0:i.users,vendors:i==null?void 0:i.vendors,products:i==null?void 0:i.products,smsTemplates:i==null?void 0:i.smsTemplates,loading:i==null?void 0:i.loading,error:i==null?void 0:i.error,searchResults:i==null?void 0:i.searchResults,globalSearch:P,clearSearch:ee,getUserOptions:z,getVendorOptions:_,refresh:f,refreshIfNeeded:h,lastUpdate:d,isCacheValid:y(),salesConsultantOptions:(I=(i==null?void 0:i.sales)||[])==null?void 0:I.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),deliveryCoordinatorOptions:(c=(i==null?void 0:i.dc)||[])==null?void 0:c.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),financeManagerOptions:(ne=(i==null?void 0:i.finance)||[])==null?void 0:ne.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name}))}}const vs=()=>{var v,f,y;const{dc:t,sales:u,finance:r,vendors:i,products:x,loading:d,error:o,refresh:b}=De({loadOnMount:!0});return{salesConsultants:u,deliveryCoordinators:t,financeManagers:r,vendors:i,products:x,loading:d,error:o,refresh:b,salesConsultantOptions:(v=u||[])==null?void 0:v.map(h=>({id:h==null?void 0:h.id,value:h==null?void 0:h.id,label:h==null?void 0:h.full_name,name:h==null?void 0:h.full_name})),deliveryCoordinatorOptions:(f=t||[])==null?void 0:f.map(h=>({id:h==null?void 0:h.id,value:h==null?void 0:h.id,label:h==null?void 0:h.full_name,name:h==null?void 0:h.full_name})),financeManagerOptions:(y=r||[])==null?void 0:y.map(h=>({id:h==null?void 0:h.id,value:h==null?void 0:h.id,label:h==null?void 0:h.full_name,name:h==null?void 0:h.full_name})),vendorOptions:i||[],productOptions:x||[]}},ys=()=>(ls.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),$e=({options:t=[],value:u,onChange:r,placeholder:i="Select...",searchable:x=!1,clearable:d=!1,disabled:o=!1,loading:b=!1,error:v=null,className:f="",optionLabel:y="label",optionValue:h="value",groupBy:P=null,renderOption:ee=null,label:z="",helperText:_=""})=>{const[m,I]=k.useState(!1),[c,ne]=k.useState(""),[g,F]=k.useState(!1),[M,R]=k.useState(t),[w,$]=k.useState(-1),[U,ge]=k.useState({top:0,left:0,width:0}),K=k.useRef(null),he=k.useRef(null);k.useRef(null),k.useEffect(()=>{F((()=>{var l;return(l=window.matchMedia("(max-width: 767px)"))==null?void 0:l.matches})());const V=window.matchMedia("(max-width: 767px)"),re=()=>F(V==null?void 0:V.matches);return V==null||V.addEventListener("change",re),()=>V==null?void 0:V.removeEventListener("change",re)},[]),k.useEffect(()=>{if(!(c!=null&&c.trim())){R(t);return}const j=c==null?void 0:c.toLowerCase(),V=t==null?void 0:t.filter(re=>{const l=[re==null?void 0:re.name,re==null?void 0:re.displayName,re==null?void 0:re.category,re==null?void 0:re.brand,re==null?void 0:re.specialty,re==null?void 0:re.department,re==null?void 0:re.email].filter(Boolean);return l==null?void 0:l.some(S=>{var A;return(A=S==null?void 0:S.toLowerCase())==null?void 0:A.includes(j)})});R(V),$(-1)},[c,t]);const le=t==null?void 0:t.find(j=>(j==null?void 0:j.id)===u),se=j=>((j==null?void 0:j[h])||(j==null?void 0:j.id))===u,p=()=>{var j;if(K!=null&&K.current){const V=(j=K==null?void 0:K.current)==null?void 0:j.getBoundingClientRect();ge({top:(V==null?void 0:V.bottom)+window.scrollY,left:(V==null?void 0:V.left)+window.scrollX,width:V==null?void 0:V.width})}};k.useEffect(()=>{m&&!g&&p()},[m,g]),k.useEffect(()=>{if(g)return;const j=V=>{var re;K!=null&&K.current&&!((re=K==null?void 0:K.current)!=null&&re.contains(V==null?void 0:V.target))&&(I(!1),ne(""),$(-1))};return document==null||document.addEventListener("mousedown",j),()=>document==null?void 0:document.removeEventListener("mousedown",j)},[g]);const q=j=>{if(!g){if(!m){((j==null?void 0:j.key)==="Enter"||(j==null?void 0:j.key)===" "||(j==null?void 0:j.key)==="ArrowDown")&&(j==null||j.preventDefault(),I(!0),x&&setTimeout(()=>{var V;return(V=he==null?void 0:he.current)==null?void 0:V.focus()},0));return}switch(j==null?void 0:j.key){case"Escape":I(!1),ne(""),$(-1);break;case"ArrowDown":j==null||j.preventDefault(),$(V=>V<(M==null?void 0:M.length)-1?V+1:0);break;case"ArrowUp":j==null||j.preventDefault(),$(V=>V>0?V-1:(M==null?void 0:M.length)-1);break;case"Enter":j==null||j.preventDefault(),w>=0&&(M!=null&&M[w])&&ve(M==null?void 0:M[w]);break;case"Tab":I(!1),ne(""),$(-1);break}}},ve=j=>{r==null||r(j==null?void 0:j.id),I(!1),ne(""),$(-1)},ke=j=>{j==null||j.stopPropagation(),r==null||r(null)};return g?e.jsxs("div",{className:`relative ${f}`,children:[e.jsxs("select",{value:u||"",onChange:j=>{var V;return r==null?void 0:r(((V=j==null?void 0:j.target)==null?void 0:V.value)||null)},disabled:o||b,className:`
            w-full px-3 py-2 border rounded-lg
            ${v?"border-red-500":"border-gray-300"}
            ${o||b?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:i}),t==null?void 0:t.map(j=>e.jsx("option",{value:(j==null?void 0:j[h])||(j==null?void 0:j.id),children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[h])||(j==null?void 0:j.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(Y,{name:"ChevronDown",size:16,className:"text-gray-400"})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]}):e.jsxs("div",{className:`relative ${f}`,ref:K,children:[e.jsxs("button",{type:"button",onClick:()=>!o&&!b&&I(!m),onKeyDown:q,disabled:o||b,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${v?"border-red-500":"border-gray-300"}
          ${o||b?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${m?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:le?"text-gray-900":"text-gray-500",children:le?(le==null?void 0:le[y])||(le==null?void 0:le.label):i}),e.jsxs("div",{className:"flex items-center space-x-1",children:[b&&e.jsx(Y,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),d&&le&&!b&&e.jsx("button",{type:"button",onClick:ke,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(Y,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(Y,{name:m?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),m&&typeof window<"u"&&e.jsx(ys,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>I(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${U==null?void 0:U.top}px`,left:`${U==null?void 0:U.left}px`,width:`${U==null?void 0:U.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:j=>j==null?void 0:j.stopPropagation(),children:[x&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:c,onChange:j=>{var V;return ne((V=j==null?void 0:j.target)==null?void 0:V.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(M==null?void 0:M.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:c?"No results found":"No options available"}):M==null?void 0:M.map(j=>e.jsx("button",{type:"button",onClick:()=>ve(j),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${se(j)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[h])||(j==null?void 0:j.id)))})]})})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]})},Ns=({isOpen:t,dealId:u,deal:r,onClose:i,onSuccess:x})=>{var Z,B,H,ue,xe,oe,fe;const[d,o]=k.useState(!0),[b,v]=k.useState(!1),[f,y]=k.useState(""),[h,P]=k.useState(!1),[ee,z]=k.useState(!1),[_,m]=k.useState(!1),[I,c]=k.useState(!1),[ne,g]=k.useState(null),[F,M]=k.useState(null),[R,w]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:$,deliveryCoordinatorOptions:U,financeManagerOptions:ge,vendorOptions:K,productOptions:he,loading:le,refresh:se}=vs(),[p,q]=k.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),ve=(a=[],n,N="Selected")=>!n||Array.isArray(a)&&a.some(C=>(C==null?void 0:C.id)===n)?a:[...a||[],{id:n,value:n,label:N}],ke=k.useMemo(()=>ve(K,p==null?void 0:p.vendor_id,"Selected vendor"),[K,p==null?void 0:p.vendor_id]),j=k.useMemo(()=>ve($,p==null?void 0:p.assignedTo,"Selected user"),[$,p==null?void 0:p.assignedTo]),V=k.useMemo(()=>ve(U,p==null?void 0:p.deliveryCoordinator,"Selected user"),[U,p==null?void 0:p.deliveryCoordinator]),re=k.useMemo(()=>ve(ge,p==null?void 0:p.financeManager,"Selected user"),[ge,p==null?void 0:p.financeManager]);k.useEffect(()=>{if(ne){const a=JSON.stringify(p)!==JSON.stringify(ne);m(a)}},[p,ne]),k.useEffect(()=>{if(t)try{se==null||se()}catch{}},[t,se]),k.useEffect(()=>{var a;if(t)if(r&&(r!=null&&r.id))try{const n=Re(r),N={...n,assignedTo:(n==null?void 0:n.assigned_to)||null,deliveryCoordinator:(n==null?void 0:n.delivery_coordinator_id)||null,financeManager:(n==null?void 0:n.finance_manager_id)||null,vendor_id:(n==null?void 0:n.vendor_id)||null,customerName:(r==null?void 0:r.customer_name)||"",customerPhone:(r==null?void 0:r.customer_phone)||"",customerEmail:(r==null?void 0:r.customer_email)||"",lineItems:((a=(n==null?void 0:n.lineItems)||[])==null?void 0:a.length)>0?ie(n==null?void 0:n.lineItems):[ce()]};q(N),g(JSON.parse(JSON.stringify(N))),o(!1),y("")}catch(n){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",n),ae()}else u?ae():(y("No deal selected to edit."),o(!1))},[t,u,r==null?void 0:r.id]),k.useEffect(()=>{if(!t||!d)return;const a=setTimeout(()=>{o(!1),y(n=>n||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(a)},[t,d]);const l=({checked:a,onChange:n})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!a,onChange:N=>{var C;return n(!!((C=N==null?void 0:N.target)!=null&&C.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),S=({value:a,selectedValue:n,onChange:N,itemIndex:C,disabled:de=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${C}`,value:"in_house",checked:!n,onChange:()=>N(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:de}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${C}`,value:"vendor",checked:n,onChange:()=>N(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:de}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),A=({requiresScheduling:a,onChange:n,itemIndex:N,disabled:C=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${N}`,checked:a===!0,onChange:()=>n(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:C}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${N}`,checked:a===!1,onChange:()=>n(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:C}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),ie=(a=[])=>(a||[]).map(n=>({product_id:(n==null?void 0:n.product_id)??null,unit_price:(n==null?void 0:n.unit_price)??0,quantity_used:(n==null?void 0:n.quantity_used)??1,lineItemPromisedDate:(n==null?void 0:n.lineItemPromisedDate)||(n==null?void 0:n.promised_date)||"",requiresScheduling:typeof(n==null?void 0:n.requiresScheduling)=="boolean"?n==null?void 0:n.requiresScheduling:!!(n!=null&&n.requires_scheduling),noScheduleReason:(n==null?void 0:n.noScheduleReason)||(n==null?void 0:n.no_schedule_reason)||"",isOffSite:typeof(n==null?void 0:n.isOffSite)=="boolean"?n==null?void 0:n.isOffSite:!!(n!=null&&n.is_off_site),description:(n==null?void 0:n.description)||""})),ae=async()=>{var a,n,N,C,de,te,X,Q,be,Oe;try{o(!0),y("");const Ee=await as(u),me=Re(Ee),{data:we}=await((C=(N=(n=(a=G)==null?void 0:a.from("transactions"))==null?void 0:n.select("customer_name, customer_phone, customer_email"))==null?void 0:N.eq("job_id",u))==null?void 0:C.single());let ye=null;try{const{data:Se}=await((be=(Q=(X=(te=(de=G)==null?void 0:de.from("loaner_assignments"))==null?void 0:te.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:X.eq("job_id",u))==null?void 0:Q.is("returned_at",null))==null?void 0:be.limit(1));ye=Array.isArray(Se)?Se[0]:Se}catch{}const Te={...me,assignedTo:(me==null?void 0:me.assigned_to)||null,deliveryCoordinator:(me==null?void 0:me.delivery_coordinator_id)||null,financeManager:(me==null?void 0:me.finance_manager_id)||null,vendor_id:(me==null?void 0:me.vendor_id)||null,customerName:(we==null?void 0:we.customer_name)||"",customerPhone:(we==null?void 0:we.customer_phone)||"",customerEmail:(we==null?void 0:we.customer_email)||"",lineItems:((Oe=(me==null?void 0:me.lineItems)||[])==null?void 0:Oe.length)>0?ie(me==null?void 0:me.lineItems):[ce()]};if(q(Te),g(JSON.parse(JSON.stringify(Te))),M(ye||null),ye)w({loaner_number:(ye==null?void 0:ye.loaner_number)||"",eta_return_date:(ye==null?void 0:ye.eta_return_date)||"",notes:(ye==null?void 0:ye.notes)||""});else{const Se=((Te==null?void 0:Te.lineItems)||[]).filter(_e=>(_e==null?void 0:_e.requiresScheduling)&&(_e==null?void 0:_e.lineItemPromisedDate)).map(_e=>new Date(_e.lineItemPromisedDate).getTime()),Fe=Se!=null&&Se.length?new Date(Math.max(...Se)):null;w(_e=>({..._e,eta_return_date:Fe?Fe.toISOString().split("T")[0]:""}))}}catch(Ee){y(`Failed to load deal: ${Ee==null?void 0:Ee.message}`)}finally{o(!1)}},ce=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),L=a=>{q(n=>({...n,...a}))},W=(a,n)=>{if(q(N=>{var C;return{...N,lineItems:(C=N==null?void 0:N.lineItems)==null?void 0:C.map((de,te)=>{if(te===a){let X={...de,...n};return"requiresScheduling"in n&&(X.requiresScheduling=!!(n!=null&&n.requiresScheduling),(n==null?void 0:n.requiresScheduling)===!0?X.noScheduleReason="":X.lineItemPromisedDate=""),"isOffSite"in n&&(X.isOffSite=!!(n!=null&&n.isOffSite),n!=null&&n.isOffSite||(X.vendorId="")),X}return de})}}),n!=null&&n.product_id){const N=he==null?void 0:he.find(C=>(C==null?void 0:C.id)===(n==null?void 0:n.product_id));N&&q(C=>{var de;return{...C,lineItems:(de=C==null?void 0:C.lineItems)==null?void 0:de.map((te,X)=>X===a?{...te,unit_price:(N==null?void 0:N.unitPrice)||(N==null?void 0:N.unit_price)||(te==null?void 0:te.unit_price),cost_price:(N==null?void 0:N.cost)||(te==null?void 0:te.cost_price)}:te)}})}},J=()=>{q(a=>({...a,lineItems:[...a==null?void 0:a.lineItems,ce()]}))},T=a=>{q(n=>{var N;return{...n,lineItems:(N=n==null?void 0:n.lineItems)==null?void 0:N.filter((C,de)=>de!==a)}})},D=async()=>{var a,n,N,C,de;try{if(v(!0),y(""),!((a=p==null?void 0:p.customerName)!=null&&a.trim())){y("Customer name is required");return}for(let Q=0;Q<((n=p==null?void 0:p.lineItems)==null?void 0:n.length);Q++){const be=(N=p==null?void 0:p.lineItems)==null?void 0:N[Q];if(!(be!=null&&be.product_id)){y(`Line item ${Q+1}: Product is required`);return}if(be!=null&&be.requiresScheduling&&!(be!=null&&be.lineItemPromisedDate)){y(`Line item ${Q+1}: Promised date is required when scheduling is needed`);return}if(!(be!=null&&be.requiresScheduling)&&!((C=be==null?void 0:be.noScheduleReason)!=null&&C.trim())){y(`Line item ${Q+1}: Reason is required when no scheduling is needed`);return}}const te={...p,customer_needs_loaner:!!(p!=null&&p.customer_needs_loaner),lineItems:(de=p==null?void 0:p.lineItems)==null?void 0:de.map(Q=>({...Q,requiresScheduling:!!(Q!=null&&Q.requiresScheduling),isOffSite:!!(Q!=null&&Q.isOffSite),unit_price:parseFloat(Q==null?void 0:Q.unit_price)||0,quantity_used:parseInt(Q==null?void 0:Q.quantity_used)||1}))},X={...te,assigned_to:(te==null?void 0:te.assignedTo)??null,delivery_coordinator_id:(te==null?void 0:te.deliveryCoordinator)??null,finance_manager_id:(te==null?void 0:te.financeManager)??null,vendor_id:(te==null?void 0:te.vendor_id)??null};await cs(u,{...X,loanerForm:R}),x==null||x(),i==null||i()}catch(te){y(`Failed to save deal: ${te==null?void 0:te.message}`)}finally{v(!1)}},Ne=async()=>{try{z(!0),await is(u),x==null||x(),i==null||i()}catch(a){y(`Failed to delete deal: ${a==null?void 0:a.message}`)}finally{z(!1),P(!1)}},je=()=>{_?c(!0):i()},s=()=>{c(!1),i()},E=()=>{var a;return((a=p==null?void 0:p.lineItems)==null?void 0:a.reduce((n,N)=>{const C=parseFloat(N==null?void 0:N.unit_price)||0,de=parseInt(N==null?void 0:N.quantity_used)||1;return n+C*de},0))||0};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:je,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(Y,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[f&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:f})}),d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{ae();try{se==null||se()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ae,{value:p==null?void 0:p.job_status,onChange:a=>{var n;return L({job_status:(n=a==null?void 0:a.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(pe,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:p==null?void 0:p.customerName,onChange:a=>{var n;return L({customerName:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(pe,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:p==null?void 0:p.customerPhone,onChange:a=>{var n;return L({customerPhone:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(pe,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:p==null?void 0:p.customerEmail,onChange:a=>{var n;return L({customerEmail:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ae,{value:p==null?void 0:p.priority,onChange:a=>{var n;return L({priority:(n=a==null?void 0:a.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(pe,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(p==null?void 0:p.vehicleYear)||"",onChange:a=>{var n;return L({vehicleYear:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"2024",min:"1900",max:((Z=new Date)==null?void 0:Z.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(pe,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(p==null?void 0:p.vehicleMake)||"",onChange:a=>{var n;return L({vehicleMake:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(pe,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(p==null?void 0:p.vehicleModel)||"",onChange:a=>{var n;return L({vehicleModel:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(pe,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(p==null?void 0:p.stockNumber)||"",onChange:a=>{var n;return L({stockNumber:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(l,{checked:p==null?void 0:p.customer_needs_loaner,onChange:a=>{if(L({customer_needs_loaner:a}),a&&!(R!=null&&R.eta_return_date)){const n=((p==null?void 0:p.lineItems)||[]).filter(C=>(C==null?void 0:C.requiresScheduling)&&(C==null?void 0:C.lineItemPromisedDate)).map(C=>new Date(C.lineItemPromisedDate).getTime()),N=n!=null&&n.length?new Date(Math.max(...n)):null;N&&w(C=>({...C,eta_return_date:N.toISOString().split("T")[0]}))}}}),F&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",F==null?void 0:F.loaner_number,(F==null?void 0:F.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due"," ",(B=new Date(F==null?void 0:F.eta_return_date))==null?void 0:B.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(p==null?void 0:p.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(pe,{id:"loaner-number","aria-label":"Loaner number",value:(R==null?void 0:R.loaner_number)||"",onChange:a=>w(n=>{var N;return{...n,loaner_number:(N=a==null?void 0:a.target)==null?void 0:N.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(pe,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(R==null?void 0:R.eta_return_date)||"",onChange:a=>w(n=>{var N;return{...n,eta_return_date:(N=a==null?void 0:a.target)==null?void 0:N.value}}),min:(xe=(ue=(H=new Date)==null?void 0:H.toISOString())==null?void 0:ue.split("T"))==null?void 0:xe[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(pe,{id:"loaner-notes","aria-label":"Loaner notes",value:(R==null?void 0:R.notes)||"",onChange:a=>w(n=>{var N;return{...n,notes:(N=a==null?void 0:a.target)==null?void 0:N.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"mb-4","data-testid":"vendor-select",children:[e.jsx($e,{label:"Vendor",options:ke,value:(p==null?void 0:p.vendor_id)||"",onChange:a=>L({vendor_id:a||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"}),!le&&((K==null?void 0:K.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"sales-select",children:[e.jsx($e,{label:"Sales Consultant",options:j,value:p==null?void 0:p.assignedTo,onChange:a=>L({assignedTo:a}),placeholder:"Select sales consultant",searchable:!0,clearable:!0}),!le&&(($==null?void 0:$.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"delivery-select",children:[e.jsx($e,{label:"Delivery Coordinator",options:V,value:p==null?void 0:p.deliveryCoordinator,onChange:a=>L({deliveryCoordinator:a}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0}),!le&&((U==null?void 0:U.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{"data-testid":"finance-select",children:[e.jsx($e,{label:"Finance Manager",options:re,value:p==null?void 0:p.financeManager,onChange:a=>L({financeManager:a}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"}),!le&&((ge==null?void 0:ge.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(O,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:J,children:[e.jsx(Y,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(oe=p==null?void 0:p.lineItems)==null?void 0:oe.map((a,n)=>{var N,C,de,te;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",n+1]}),((N=p==null?void 0:p.lineItems)==null?void 0:N.length)>1&&e.jsx(O,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>T(n),children:e.jsx(Y,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx($e,{label:"Product *",options:he,value:(a==null?void 0:a.product_id)||"",onChange:X=>W(n,{product_id:X?parseInt(X):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(pe,{id:`unit-price-${n}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:a==null?void 0:a.unit_price,onChange:X=>{var Q;return W(n,{unit_price:parseFloat((Q=X==null?void 0:X.target)==null?void 0:Q.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(pe,{id:`quantity-${n}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:a==null?void 0:a.quantity_used,onChange:X=>{var Q;return W(n,{quantity_used:parseInt((Q=X==null?void 0:X.target)==null?void 0:Q.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(S,{selectedValue:a==null?void 0:a.isOffSite,onChange:X=>W(n,{isOffSite:X}),itemIndex:n})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(A,{requiresScheduling:a==null?void 0:a.requiresScheduling,onChange:X=>W(n,{requiresScheduling:X}),itemIndex:n})}),a!=null&&a.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(pe,{id:`promised-date-${n}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:a==null?void 0:a.lineItemPromisedDate,onChange:X=>{var Q;return W(n,{lineItemPromisedDate:(Q=X==null?void 0:X.target)==null?void 0:Q.value})},min:(te=(de=(C=new Date)==null?void 0:C.toISOString())==null?void 0:de.split("T"))==null?void 0:te[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(pe,{id:`notes-${n}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(a==null?void 0:a.description)||"",onChange:X=>{var Q;return W(n,{description:(Q=X==null?void 0:X.target)==null?void 0:Q.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(pe,{id:`no-schedule-reason-${n}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:a==null?void 0:a.noScheduleReason,onChange:X=>{var Q;return W(n,{noScheduleReason:(Q=X==null?void 0:X.target)==null?void 0:Q.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(a==null?void 0:a.unit_price)||0)*(parseInt(a==null?void 0:a.quantity_used)||1)).toFixed(2)]})]},n)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(fe=E())==null?void 0:fe.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(O,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>P(!0),children:[e.jsx(Y,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(O,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:je,children:"Cancel"}),e.jsx(O,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:D,disabled:b,children:b?"Saving...":"Save Changes"})]})]}),h&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(O,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>P(!1),children:"Cancel"}),e.jsx(O,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:Ne,disabled:ee,children:ee?"Deleting...":"Delete"})]})]})}),I&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(O,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>c(!1),children:"Keep Editing"}),e.jsx(O,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:s,children:"Discard Changes"})]})]})})]})}):null};function _s({isOpen:t,onClose:u,deal:r}){const[i,x]=k.useState("Customer"),[d,o]=k.useState(""),b=k.useMemo(()=>["Customer","Vehicle","Deal & Pricing","Scheduling","Vendor","Files","Activity","Alerts/Holds"],[]);if(!t||!r)return null;const v=async h=>{try{await navigator.clipboard.writeText(h),o("Copied!"),setTimeout(()=>o(""),1500)}catch{o("Copy failed"),setTimeout(()=>o(""),1500)}},f=({title:h,children:P})=>e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2",children:h}),e.jsx("div",{className:"bg-white border border-slate-200 rounded-lg p-3 text-sm text-slate-800",children:P||e.jsx("span",{className:"text-slate-400",children:"â€”"})})]}),y=()=>{var h,P,ee,z,_;switch(i){case"Customer":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Customer",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(r==null?void 0:r.customer_name)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_email)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_phone)||"â€”"})]}),e.jsxs("div",{className:"flex gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(Y,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(Y,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",onClick:()=>v(`${(r==null?void 0:r.customer_name)||""} ${(r==null?void 0:r.customer_phone)||""}`.trim()),children:[e.jsx(Y,{name:"Copy",size:16,className:"mr-1"})," Copy"]})]})]})})});case"Vehicle":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Vehicle",children:e.jsxs("div",{children:[e.jsx("div",{children:r!=null&&r.vehicle?`${((h=r==null?void 0:r.vehicle)==null?void 0:h.year)||""} ${((P=r==null?void 0:r.vehicle)==null?void 0:P.make)||""} ${((ee=r==null?void 0:r.vehicle)==null?void 0:ee.model)||""}`.trim():"â€”"}),((z=r==null?void 0:r.vehicle)==null?void 0:z.stock_number)&&e.jsxs("div",{className:"text-slate-600",children:["Stock: ",(_=r==null?void 0:r.vehicle)==null?void 0:_.stock_number]})]})})});case"Deal & Pricing":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Totals",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Value"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(parseFloat(r==null?void 0:r.total_amount)||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Est. Margin"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(r==null?void 0:r.total_amount)||0)*.25)})]})]})})});case"Scheduling":return e.jsxs(e.Fragment,{children:[e.jsx(f,{title:"Appointment",children:r!=null&&r.appt_start?e.jsxs("div",{className:"text-sm",children:[new Date(r==null?void 0:r.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(r==null?void 0:r.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",r!=null&&r.appt_end?new Date(r==null?void 0:r.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):"â€”"}),e.jsx(f,{title:"Next Promise",children:r!=null&&r.next_promised_iso?new Date(r==null?void 0:r.next_promised_iso).toLocaleString():"â€”"})]});case"Vendor":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Vendor",children:e.jsx("div",{children:(r==null?void 0:r.vendor_name)||"Unassigned"})})});case"Files":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Files",children:"No files yet."})});case"Activity":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Activity",children:"Activity timeline coming soon."})});case"Alerts/Holds":return e.jsx(e.Fragment,{children:e.jsx(f,{title:"Alerts/Holds",children:"No alerts."})});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50",onClick:u}),e.jsxs("div",{className:"fixed right-0 top-0 h-full w-full md:w-[520px] bg-white shadow-xl z-50 overflow-y-auto",children:[e.jsxs("div",{className:"p-5 border-b bg-white sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:(r==null?void 0:r.job_number)||`Job-${String((r==null?void 0:r.id)||"").slice(0,8)}`}),e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:(r==null?void 0:r.customer_name)||"Deal Details"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[d&&e.jsx("span",{className:"text-xs text-slate-500",children:d}),e.jsx(O,{variant:"ghost",size:"icon",onClick:u,"aria-label":"Close drawer",children:e.jsx(Y,{name:"X",size:20})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:h=>h.stopPropagation(),children:e.jsxs(O,{size:"sm",className:"h-9",children:[e.jsx(Y,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:h=>h.stopPropagation(),children:e.jsxs(O,{size:"sm",className:"h-9",children:[e.jsx(Y,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",onClick:()=>v((r==null?void 0:r.customer_phone)||""),children:[e.jsx(Y,{name:"Copy",size:16,className:"mr-1"})," Copy Phone"]}),e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(Y,{name:"Calendar",size:16,className:"mr-1"})," Schedule"]}),e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(Y,{name:"FileText",size:16,className:"mr-1"})," Note"]}),e.jsxs(O,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(Y,{name:"CheckCircle",size:16,className:"mr-1"})," Complete"]})]})]}),e.jsx("div",{className:"px-5 pt-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:b.map(h=>e.jsx("button",{onClick:()=>x(h),className:`px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap border ${i===h?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:h},h))})}),e.jsx("div",{className:"p-5",children:y()})]})]})}const Be=({status:t})=>{var x;const u={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},r=(u==null?void 0:u[t])||"bg-gray-100 text-gray-700",i=((x=t==null?void 0:t.replace("_"," "))==null?void 0:x.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${r}`,children:i})},ws=t=>{try{if(!t)return"â€”";const u=new Date(t);if(Number.isNaN(u.getTime()))return"â€”";const r=Date.now()-u.getTime(),i=Math.floor(r/1e3),x=Math.floor(i/60),d=Math.floor(x/60),o=Math.floor(d/24);return o>0?`${o}d ago`:d>0?`${d}h ago`:x>0?`${x}m ago`:"just now"}catch{return"â€”"}},Ye=({nextPromisedAt:t})=>{var v;if(!t)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const u=new Date,i=new Date(t)-u,x=i<0,d=i>=0&&i<24*60*60*1e3,o=x?"bg-red-100 text-red-800 border-red-200":d?"bg-amber-100 text-amber-800 border-amber-200":"bg-green-100 text-green-800 border-green-200",b=(v=new Date(t))==null?void 0:v.toLocaleDateString("en-US",{month:"short",day:"numeric"});return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${o}`,children:["Next: ",b]})},Je=({serviceType:t,jobParts:u})=>{const r=u==null?void 0:u.some(x=>x==null?void 0:x.is_off_site),i=u==null?void 0:u.some(x=>!(x!=null&&x.is_off_site));return r&&i?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):r?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},Ss=({draftsCount:t,onViewDrafts:u})=>{const[r,i]=k.useState(!1);return t===0||r?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Y,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",t," draft deal",t>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{size:"sm",variant:"ghost",onClick:u,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>i(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(Y,{name:"X",size:16})})]})]})})},Me=t=>t?t!=null&&t.job_number?t.job_number:t!=null&&t.id?`Job-${String(t.id).slice(0,8)}`:"â€”":"â€”",es=t=>t&&(t==null?void 0:t.customer_name)||"",ks=({deal:t})=>!(t!=null&&t.customer_name)&&!(t!=null&&t.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"}):e.jsxs("div",{className:"space-y-1",children:[(t==null?void 0:t.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:t==null?void 0:t.customer_name}),(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`tel:${t==null?void 0:t.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:u=>u==null?void 0:u.stopPropagation(),children:t==null?void 0:t.customer_phone})]}),Cs=({amount:t})=>{var r;const u=parseFloat(t)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:r.format(u)})})},Ke=({deal:t})=>t!=null&&t.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",t==null?void 0:t.loaner_number,(t==null?void 0:t.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due ",t==null?void 0:t.loaner_eta_short]})]}):null,Es=({isOpen:t,onClose:u,deal:r,onSave:i,loading:x})=>{var y,h,P,ee;const[d,o]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),[b,v]=k.useState("");k.useEffect(()=>{if(t&&r){let z="";try{const _=((r==null?void 0:r.job_parts)||[]).filter(m=>(m==null?void 0:m.requires_scheduling)&&(m==null?void 0:m.promised_date)).map(m=>new Date(m.promised_date));(_==null?void 0:_.length)>0&&(z=new Date(Math.max.apply(null,_)).toISOString().split("T")[0])}catch{}o({loaner_number:(r==null?void 0:r.loaner_number)||"",eta_return_date:(r==null?void 0:r.loaner_eta_return_date)||z||"",notes:(r==null?void 0:r.loaner_notes)||""}),v("")}else t||(o({loaner_number:"",eta_return_date:"",notes:""}),v(""))},[t,r]);const f=async()=>{var z,_,m;if(v(""),!((z=d==null?void 0:d.loaner_number)!=null&&z.trim())){v("Loaner number is required");return}if(!(d!=null&&d.eta_return_date)){v("ETA return date is required");return}try{await i({job_id:r==null?void 0:r.id,loaner_number:(_=d==null?void 0:d.loaner_number)==null?void 0:_.trim(),eta_return_date:d==null?void 0:d.eta_return_date,notes:((m=d==null?void 0:d.notes)==null?void 0:m.trim())||null}),u()}catch(I){v((I==null?void 0:I.message)||"Failed to save loaner assignment")}};return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:u}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(O,{variant:"ghost",size:"icon",onClick:u,"aria-label":"Close drawer",children:e.jsx(Y,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:Me(r)}),e.jsx("p",{className:"text-xs text-slate-500",children:es(r)})]}),b&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:b}),e.jsx("button",{onClick:()=>v(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:d==null?void 0:d.loaner_number,onChange:z=>o(_=>{var m;return{..._,loaner_number:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:d==null?void 0:d.eta_return_date,onChange:z=>o(_=>{var m;return{..._,eta_return_date:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(P=(h=(y=new Date)==null?void 0:y.toISOString())==null?void 0:h.split("T"))==null?void 0:P[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:d==null?void 0:d.notes,onChange:z=>o(_=>{var m;return{..._,notes:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(O,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:x,children:"Cancel"}),e.jsx(O,{onClick:f,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:x||!((ee=d==null?void 0:d.loaner_number)!=null&&ee.trim())||!(d!=null&&d.eta_return_date),children:x?"Saving...":"Save Loaner"})]})]})})]}):null},Ts=({loaner:t,onClose:u,onConfirm:r,loading:i})=>t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",t==null?void 0:t.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(O,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:i,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(O,{onClick:r,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:i,"aria-label":"Confirm loaner returned",children:i?"Processing...":"Mark Returned"})]})]})})}):null;function Rs(){var je;const[t,u]=k.useState([]),[r,i]=k.useState(!0),[x,d]=k.useState(!1),[o,b]=k.useState(!1),[v,f]=k.useState(null),[y,h]=k.useState(null),[P,ee]=k.useState(null),[z,_]=k.useState(""),[m,I]=k.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[c,ne]=k.useState(!1),[g,F]=k.useState(null),[M,R]=k.useState(!1),[w,$]=k.useState(null),[U,ge]=k.useState(!1),[K,he]=k.useState(""),[le,se]=k.useState(!1),[p,q]=k.useState(null),{clearSearch:ve,error:ke}=De({loadOnMount:!0});ms();const{user:j}=Pe(),V=async s=>{var E;try{_("");const{error:Z}=await((E=G)==null?void 0:E.rpc("delete_job_cascade",{p_job_id:s}));if(Z)throw Z;ee(null),await S()}catch(Z){_(`Failed to delete deal: ${Z==null?void 0:Z.message}`),console.error("Delete error:",Z)}},re=async s=>{var E,Z,B,H,ue,xe,oe,fe,a,n;try{R(!0),_("");let N=null;try{const{data:C}=await((ue=(H=(B=(Z=(E=G)==null?void 0:E.from("loaner_assignments"))==null?void 0:Z.select("id"))==null?void 0:B.eq("job_id",s==null?void 0:s.job_id))==null?void 0:H.is("returned_at",null))==null?void 0:ue.limit(1));N=Array.isArray(C)?C[0]:C}catch{}if(N!=null&&N.id){const{error:C}=await((fe=(oe=(xe=G)==null?void 0:xe.from("loaner_assignments"))==null?void 0:oe.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:fe.eq("id",N.id));if(C)throw C}else{const{error:C}=await((n=(a=G)==null?void 0:a.from("loaner_assignments"))==null?void 0:n.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(C)throw C}ne(!1),F(null),await S()}catch(N){const C=`Failed to save loaner assignment: ${N==null?void 0:N.message}`;throw _(C),new Error(C)}finally{R(!1)}},l=async s=>{try{ge(!0),_(""),await os(s==null?void 0:s.loaner_id),$(null),await S()}catch(E){_(`Failed to mark loaner as returned: ${E==null?void 0:E.message}`),console.error("Mark returned error:",E)}finally{ge(!1)}},S=async(s=0)=>{var E,Z;try{i(!0),_("");const B=await ds();u(B||[])}catch(B){const H=`Failed to load deals: ${B==null?void 0:B.message}`;if(console.error("Load deals error:",B),s<2&&((E=B==null?void 0:B.message)!=null&&E.includes("fetch")||(Z=B==null?void 0:B.message)!=null&&Z.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>S(s+1),1e3*(s+1));return}_(H),u([])}finally{i(!1)}};k.useEffect(()=>{var Z;const s=new URLSearchParams(window.location.search),E=s==null?void 0:s.get("status");if(E){const B=((Z=E==null?void 0:E.charAt(0))==null?void 0:Z.toUpperCase())+(E==null?void 0:E.slice(1));I(H=>({...H,status:B}))}},[]),k.useEffect(()=>{S()},[]);const A=s=>{F(s),ne(!0)},ie=s=>{q(s),se(!0)},ae=({message:s,onClose:E})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(Y,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),E&&e.jsx("button",{onClick:E,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(Y,{name:"X",size:16})})]})}):null,L=(s=>{var fe,a,n;const E=s||[],Z=((fe=E==null?void 0:E.filter(N=>(N==null?void 0:N.job_status)==="in_progress"))==null?void 0:fe.length)||0,B=E==null?void 0:E.reduce((N,C)=>{const de=parseFloat(C==null?void 0:C.total_amount)||0;return N+de},0),H=B*.25,ue=B>0?25:0,xe=((a=E==null?void 0:E.filter(N=>(N==null?void 0:N.job_status)==="pending"))==null?void 0:a.length)||0,oe=((n=E==null?void 0:E.filter(N=>(N==null?void 0:N.job_status)==="draft"))==null?void 0:n.length)||0;return{active:Z,revenue:(B==null?void 0:B.toFixed(2))||"0.00",profit:(H==null?void 0:H.toFixed(2))||"0.00",margin:(ue==null?void 0:ue.toFixed(1))||"0.0",pending:xe,drafts:oe}})(t),W=t==null?void 0:t.filter(s=>{var E,Z,B,H,ue;if((m==null?void 0:m.status)!=="All"){const xe=(Z=(E=m==null?void 0:m.status)==null?void 0:E.toLowerCase())==null?void 0:Z.replace(" ","_");if((s==null?void 0:s.job_status)!==xe)return!1}if(m!=null&&m.salesAssigned&&(s==null?void 0:s.assigned_to)!==(m==null?void 0:m.salesAssigned)||m!=null&&m.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(m==null?void 0:m.deliveryAssigned)||m!=null&&m.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(m==null?void 0:m.financeAssigned)||m!=null&&m.vendor&&(s==null?void 0:s.vendor_id)!==(m==null?void 0:m.vendor))return!1;if(K!=null&&K.trim()){const xe=K==null?void 0:K.toLowerCase(),oe=N=>(N==null?void 0:N.replace(/\D/g,""))||"",fe=oe(xe),a=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(B=s==null?void 0:s.vehicle)==null?void 0:B.make,(H=s==null?void 0:s.vehicle)==null?void 0:H.model,((ue=s==null?void 0:s.vehicle)==null?void 0:ue.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(a==null?void 0:a.some(N=>{var de;const C=N==null?void 0:N.toLowerCase();return!!(C!=null&&C.includes(xe)||(fe==null?void 0:fe.length)>=3&&((de=oe(C))!=null&&de.includes(fe)))})))return!1}return!0});k.useEffect(()=>{const s=setTimeout(()=>{he(m==null?void 0:m.search)},300);return()=>clearTimeout(s)},[m==null?void 0:m.search]);const J=(s,E)=>{var Z,B;if(I(H=>({...H,[s]:E})),s==="status"){const H=new URLSearchParams(window.location.search);E==="All"?H==null||H.delete("status"):H==null||H.set("status",E==null?void 0:E.toLowerCase());const ue=`${(Z=window.location)==null?void 0:Z.pathname}${H!=null&&H.toString()?"?"+(H==null?void 0:H.toString()):""}`;(B=window.history)==null||B.replaceState({},"",ue)}},T=()=>{var s,E;I({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),ve(),(E=window.history)==null||E.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},D=s=>{var E;f(s);try{const Z=(E=W!=null&&W.length?W:t)==null?void 0:E.find(B=>(B==null?void 0:B.id)===s);h(Z||null)}catch{h(null)}b(!0)},Ne=()=>{b(!1),f(null),h(null)};return r?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ve,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ve,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(ae,{message:z||ke,onClose:()=>{_("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(bs,{exportType:"jobs",filters:{status:m==null?void 0:m.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,E)=>console.log(`Export complete: ${s} records`),onExportError:s=>_(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(O,{onClick:()=>d(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(Y,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(Ss,{draftsCount:L==null?void 0:L.drafts,onViewDrafts:()=>J("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(Y,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:L==null?void 0:L.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(Y,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",L==null?void 0:L.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(Y,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",L==null?void 0:L.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(Y,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[L==null?void 0:L.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(Y,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:L==null?void 0:L.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(Y,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:L==null?void 0:L.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>J("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(m==null?void 0:m.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Y,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:m==null?void 0:m.search,onChange:s=>{var E;return J("search",(E=s==null?void 0:s.target)==null?void 0:E.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(O,{variant:"ghost",size:"sm",onClick:T,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(Y,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",W==null?void 0:W.length," of ",t==null?void 0:t.length," deals",((m==null?void 0:m.salesAssigned)||(m==null?void 0:m.deliveryAssigned)||(m==null?void 0:m.financeAssigned)||(m==null?void 0:m.vendor)||(m==null?void 0:m.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Promise"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Appt Window"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vehicle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"$/Margin"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Work"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Last Activity"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:W==null?void 0:W.map(s=>{var E,Z,B,H,ue,xe;return e.jsxs("tr",{className:"hover:bg-slate-50 cursor-pointer",onClick:()=>ie(s),children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(Be,{status:s==null?void 0:s.job_status})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:typeof(s==null?void 0:s.age_days)=="number"?`${s==null?void 0:s.age_days}d`:"â€”"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ye,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.appt_start?e.jsxs("span",{className:"text-sm text-slate-700",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(ks,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[(s==null?void 0:s.customer_phone_e164)||(s==null?void 0:s.customer_phone)||"â€”",s!=null&&s.customer_phone_last4?e.jsxs("span",{className:"text-slate-400",children:[" ","(",`â€¦${s==null?void 0:s.customer_phone_last4}`,")"]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[s!=null&&s.vehicle?`${((E=s==null?void 0:s.vehicle)==null?void 0:E.year)||""} ${((Z=s==null?void 0:s.vehicle)==null?void 0:Z.make)||""} ${((B=s==null?void 0:s.vehicle)==null?void 0:B.model)||""}`.trim():"â€”",(H=s==null?void 0:s.vehicle)!=null&&H.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(ue=s==null?void 0:s.vehicle)==null?void 0:ue.stock_number]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Cs,{amount:s==null?void 0:s.total_amount}),e.jsxs("span",{className:"text-xs text-slate-500",children:["est."," ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(s==null?void 0:s.total_amount)||0)*.25)]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[((s==null?void 0:s.work_tags)||[]).map(oe=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 border border-slate-200",children:oe},oe)),(!(s!=null&&s.work_tags)||((xe=s==null?void 0:s.work_tags)==null?void 0:xe.length)===0)&&e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:(s==null?void 0:s.vendor_name)||"Unassigned"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Je,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:ws(s==null?void 0:s.created_at)})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.loaner_number||s!=null&&s.has_active_loaner?e.jsx(Ke,{deal:s}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(O,{size:"sm",variant:"ghost",onClick:oe=>{oe.stopPropagation(),D(s==null?void 0:s.id)},className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(O,{size:"sm",variant:"ghost",onClick:oe=>{oe.stopPropagation(),A(s)},className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(O,{size:"sm",variant:"ghost",onClick:oe=>{oe.stopPropagation(),$({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)})},className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(O,{size:"sm",variant:"ghost",onClick:oe=>{oe.stopPropagation(),ee(s)},className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(W==null?void 0:W.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(m==null?void 0:m.status)==="All"?"No deals found":`No ${(je=m==null?void 0:m.status)==null?void 0:je.toLowerCase()} deals found`})}):W==null?void 0:W.map(s=>{var E,Z,B,H,ue;return e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Me(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:es(s)||"â€”"})]}),e.jsx(Be,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-medium text-slate-900 text-sm",children:(s==null?void 0:s.customer_name)||"â€”"}),e.jsx("div",{className:"text-xs text-slate-500 truncate",children:s!=null&&s.customer_phone?e.jsx("a",{href:`tel:${s==null?void 0:s.customer_phone}`,onClick:xe=>{var oe;return(oe=xe==null?void 0:xe.stopPropagation)==null?void 0:oe.call(xe)},className:"underline",children:s==null?void 0:s.customer_phone}):"â€”"})]}),e.jsx("div",{className:"ml-3 shrink-0",children:e.jsx(Je,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})})]}),e.jsxs("div",{className:"text-xs text-slate-600 truncate",children:[(s!=null&&s.vehicle?`${((E=s==null?void 0:s.vehicle)==null?void 0:E.year)||""} ${((Z=s==null?void 0:s.vehicle)==null?void 0:Z.make)||""} ${((B=s==null?void 0:s.vehicle)==null?void 0:B.model)||""}`.trim():"")||"â€”",(H=s==null?void 0:s.vehicle)!=null&&H.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(ue=s==null?void 0:s.vehicle)==null?void 0:ue.stock_number]}):null,s!=null&&s.vendor_name?e.jsxs("span",{className:"text-slate-400",children:[" â€¢ ",s==null?void 0:s.vendor_name]}):null]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{"data-testid":"mobile-next-chip",children:e.jsx(Ye,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),(s==null?void 0:s.appt_start)&&e.jsxs("span",{className:"text-xs text-slate-700","data-testid":"mobile-appt-window",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}),((s==null?void 0:s.loaner_number)||(s==null?void 0:s.has_active_loaner))&&e.jsx(Ke,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>D(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(Y,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>ee(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(Y,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>A(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(Y,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>A(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(Y,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>$({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(Y,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id)})}),e.jsx(fs,{isOpen:x,onClose:()=>d(!1),onSuccess:S}),e.jsx(Ns,{isOpen:o,dealId:v,deal:y,onClose:Ne,onSuccess:()=>{S(),Ne()}}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(O,{variant:"outline",onClick:()=>ee(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(O,{onClick:()=>V(P==null?void 0:P.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(Es,{isOpen:c,onClose:()=>{ne(!1),F(null),_("")},deal:g,onSave:re,loading:M}),e.jsx(_s,{isOpen:le,onClose:()=>{se(!1),q(null)},deal:p}),e.jsx(Ts,{loaner:w,onClose:()=>{$(null),_("")},onConfirm:()=>l(w),loading:U})]})]})}export{Rs as default};
//# sourceMappingURL=index-l33dGYcK.js.map
