import{s as J,u as Le,j as e,B as U,S as Ee,I as Me,g as Ae,a as Re,b as Ve,c as Be,d as Ue,e as Xe,f as We,h as ue}from"./index-BNyzWt35.js";import{r as $,R as He}from"./react-Czq5O75u.js";import{dealService as Te,getDeal as Ge,mapDbDealToForm as Ze,updateDeal as Qe,deleteDeal as De,markLoanerReturned as es,getAllDeals as ss}from"./dealService-FIfxEVBr.js";import{u as Ye}from"./useTenant-BcLbtsA9.js";import{s as Ce,t as rs}from"./options-CllavUpK.js";import{I as G}from"./Icon-BN3P7VWD.js";import{l as as}from"./vendorService-CSn-i0le.js";import{l as ls}from"./smsTemplateService-3CqsKEs_.js";import{N as Ie}from"./Navbar-C3cztoVv.js";import{a as ns}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const ts=(r,c="")=>r==null?c:String(r),_e={async getOverdueJobs(){var r;try{const{data:c,error:l}=await((r=J)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return l?(console.error("Error fetching overdue jobs:",l),{data:[],error:{message:l==null?void 0:l.message}}):{data:c||[],error:null}}catch(c){return console.error("Error in getOverdueJobs service:",c),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,c,l,t;try{const{data:u,error:o}=await((t=(l=(c=(r=J)==null?void 0:r.from("sms_templates"))==null?void 0:c.select("*"))==null?void 0:l.eq("is_active",!0))==null?void 0:t.order("created_at",{ascending:!1}));return o?{data:[],error:{message:o==null?void 0:o.message}}:{data:u||[],error:null}}catch(u){return console.error("Error fetching SMS templates:",u),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var c,l,t,u,o,i,m,y;try{const b=await((l=(c=J)==null?void 0:c.auth)==null?void 0:l.getUser()),{data:w,error:f}=await((y=(m=(i=(t=J)==null?void 0:t.from("sms_templates"))==null?void 0:i.insert([{...r,created_by:(o=(u=b==null?void 0:b.data)==null?void 0:u.user)==null?void 0:o.id}]))==null?void 0:m.select())==null?void 0:y.single());return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:w,error:null}}catch(b){return console.error("Error creating SMS template:",b),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,c){var l,t,u,o,i,m;try{const{data:y,error:b}=await((m=(i=(o=(u=(l=J)==null?void 0:l.from("sms_templates"))==null?void 0:u.update({...c,updated_at:(t=new Date)==null?void 0:t.toISOString()}))==null?void 0:o.eq("id",r))==null?void 0:i.select())==null?void 0:m.single());return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:y,error:null}}catch(y){return console.error("Error updating SMS template:",y),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var c,l,t;try{const{error:u}=await((t=(l=(c=J)==null?void 0:c.from("sms_templates"))==null?void 0:l.delete())==null?void 0:t.eq("id",r));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting SMS template:",u),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var c,l,t,u,o,i,m,y,b;try{const w=await((l=(c=J)==null?void 0:c.auth)==null?void 0:l.getUser()),{data:f,error:V}=await((b=(y=(o=(u=(t=J)==null?void 0:t.from("filter_presets"))==null?void 0:u.select("*"))==null?void 0:o.eq("page_type",r))==null?void 0:y.or(`user_id.eq.${(m=(i=w==null?void 0:w.data)==null?void 0:i.user)==null?void 0:m.id},is_public.eq.true`))==null?void 0:b.order("created_at",{ascending:!1}));return V?{data:[],error:{message:V==null?void 0:V.message}}:{data:f||[],error:null}}catch(w){return console.error("Error fetching filter presets:",w),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,c,l,t=!1){var u,o,i,m,y,b,w,f;try{const V=await((o=(u=J)==null?void 0:u.auth)==null?void 0:o.getUser()),{data:B,error:h}=await((f=(w=(b=(i=J)==null?void 0:i.from("filter_presets"))==null?void 0:b.insert([{user_id:(y=(m=V==null?void 0:V.data)==null?void 0:m.user)==null?void 0:y.id,page_type:r,name:c,filters:l,is_public:t}]))==null?void 0:w.select())==null?void 0:f.single());return h?{data:null,error:{message:h==null?void 0:h.message}}:{data:B,error:null}}catch(V){return console.error("Error saving filter preset:",V),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var c,l,t;try{const{error:u}=await((t=(l=(c=J)==null?void 0:c.from("filter_presets"))==null?void 0:l.delete())==null?void 0:t.eq("id",r));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting filter preset:",u),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,c={},l="staff"){var t,u;try{const{data:o,error:i}=await((t=J)==null?void 0:t.rpc("generate_export_data",{export_type:r,filters:c,user_role:l}));return i?{data:null,error:{message:i==null?void 0:i.message}}:{data:(u=o||[])==null?void 0:u.map(y=>{var f;const b=(y==null?void 0:y.export_data)||y,w={};return(f=Object==null?void 0:Object.entries(b))==null||f.forEach(([V,B])=>{typeof B=="number"?w[V]=isNaN(B)?0:B:B==null?w[V]="":w[V]=B}),{export_data:w}}),error:null}}catch(o){return console.error("Error exporting data:",o),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,c,l=null){var t,u,o,i;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let m="";if(l)m+=(l==null?void 0:l.join(","))+`
`;else{const w=((t=r==null?void 0:r[0])==null?void 0:t.export_data)||(r==null?void 0:r[0]);w&&(m+=((u=Object==null?void 0:Object.keys(w))==null?void 0:u.join(","))+`
`)}r==null||r.forEach(w=>{var B;const f=(w==null?void 0:w.export_data)||w,V=(B=Object==null?void 0:Object.values(f))==null?void 0:B.map(h=>{if(h==null)return"";if(typeof h=="number"&&isNaN(h))return"0";let E=ts(h);return E!=null&&E.includes(",")||E!=null&&E.includes('"')?`"${E==null?void 0:E.replace(/"/g,'""')}"`:E});m+=(V==null?void 0:V.join(","))+`
`});const y=new Blob([m],{type:"text/csv;charset=utf-8;"}),b=document.createElement("a");if((b==null?void 0:b.download)!==void 0){const w=URL==null?void 0:URL.createObjectURL(y);b==null||b.setAttribute("href",w),b==null||b.setAttribute("download",c),b.style.visibility="hidden",(o=document.body)==null||o.appendChild(b),b==null||b.click(),(i=document.body)==null||i.removeChild(b),URL==null||URL.revokeObjectURL(w)}return{success:!0,error:null}}catch(m){return console.error("Export to CSV error:",m),{success:!1,error:{message:(m==null?void 0:m.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,c){var l,t,u,o,i;try{const m=await((t=(l=J)==null?void 0:l.auth)==null?void 0:t.getUser()),{data:y,error:b}=await((i=J)==null?void 0:i.rpc("bulk_update_jobs",{job_ids:r,updates:c,performed_by:(o=(u=m==null?void 0:m.data)==null?void 0:u.user)==null?void 0:o.id}));return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:(y==null?void 0:y[0])||null,error:null}}catch(m){return console.error("Error in bulk update jobs:",m),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,c,l,t,u,o,i;try{const m=await((c=(r=J)==null?void 0:r.auth)==null?void 0:c.getUser()),{data:y,error:b}=await((i=(t=(l=J)==null?void 0:l.from("notification_preferences"))==null?void 0:t.select("*"))==null?void 0:i.eq("user_id",(o=(u=m==null?void 0:m.data)==null?void 0:u.user)==null?void 0:o.id));return b?{data:[],error:{message:b==null?void 0:b.message}}:{data:y||[],error:null}}catch(m){return console.error("Error fetching notification preferences:",m),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var c,l,t,u,o,i,m,y,b,w;try{const f=await((l=(c=J)==null?void 0:c.auth)==null?void 0:l.getUser());await((m=(u=(t=J)==null?void 0:t.from("notification_preferences"))==null?void 0:u.delete())==null?void 0:m.eq("user_id",(i=(o=f==null?void 0:f.data)==null?void 0:o.user)==null?void 0:i.id));const V=r==null?void 0:r.map(E=>{var P,q;return{...E,user_id:(q=(P=f==null?void 0:f.data)==null?void 0:P.user)==null?void 0:q.id}}),{data:B,error:h}=await((w=(b=(y=J)==null?void 0:y.from("notification_preferences"))==null?void 0:b.insert(V))==null?void 0:w.select());return h?{data:null,error:{message:h==null?void 0:h.message}}:{data:B,error:null}}catch(f){return console.error("Error updating notification preferences:",f),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var c,l,t;try{return(t=(l=(c=J)==null?void 0:c.channel("overdue-jobs"))==null?void 0:l.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},o=>{var i;(i=this.getOverdueJobs())==null||i.then(m=>{m!=null&&m.data&&r(m==null?void 0:m.data)})}))==null?void 0:t.subscribe()}catch(u){return console.error("Error subscribing to overdue jobs:",u),null}},async searchWithFilters(r,c,l){var t,u,o;try{let i=(t=J)==null?void 0:t.from(l);if(r)switch(l){case"jobs":i=i==null?void 0:i.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":i=i==null?void 0:i.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":i=i==null?void 0:i.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(u=Object==null?void 0:Object.entries(c))==null||u.forEach(([b,w])=>{w!=null&&w!==""&&(Array!=null&&Array.isArray(w)?i=i==null?void 0:i.in(b,w):typeof w=="object"&&(w==null?void 0:w.min)!==void 0?i=i==null?void 0:i.gte(b,w==null?void 0:w.min):typeof w=="object"&&(w==null?void 0:w.max)!==void 0?i=i==null?void 0:i.lte(b,w==null?void 0:w.max):i=i==null?void 0:i.eq(b,w))});const{data:m,error:y}=await((o=i==null?void 0:i.select("*"))==null?void 0:o.order("created_at",{ascending:!1}));return y?{data:[],error:{message:y==null?void 0:y.message}}:{data:m||[],error:null}}catch(i){return console.error("Error in search with filters:",i),{data:[],error:{message:"Failed to search with filters"}}}}},cs=({exportType:r,filters:c={},selectedIds:l=[],onExportStart:t,onExportComplete:u,onExportError:o,disabled:i=!1,variant:m="outline",size:y="sm",className:b=""})=>{var I;const[w,f]=$.useState(!1),[V,B]=$.useState(!1),[h,E]=$.useState("csv"),[P,q]=$.useState("filtered"),{user:n,userProfile:se}=Le(),x=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],Z=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(l==null?void 0:l.length)>0?[{value:"selected",label:`Selected (${l==null?void 0:l.length})`}]:[]],T=()=>{var W,ie,re;const Y=(re=(ie=(W=new Date)==null?void 0:W.toISOString())==null?void 0:ie.split("T"))==null?void 0:re[0];return`${r}-${P==="selected"?"selected":P}-${Y}.${h}`},K=async()=>{var Y,xe,W,ie;if(!w)try{f(!0),t&&t();let re={...c};P==="selected"&&(l==null?void 0:l.length)>0&&(re.ids=l),P==="all"&&(re={});const j=await(_e==null?void 0:_e.exportData(r,re,(se==null?void 0:se.role)||"staff"));if(j!=null&&j.error)throw new Error((Y=j==null?void 0:j.error)==null?void 0:Y.message);if(!(j!=null&&j.data)||((xe=j==null?void 0:j.data)==null?void 0:xe.length)===0)throw new Error("No data found to export");const de=T(),R=await(_e==null?void 0:_e.exportToCSV(j==null?void 0:j.data,de));if(R!=null&&R.error)throw new Error((W=R==null?void 0:R.error)==null?void 0:W.message);B(!1),u&&u((ie=j==null?void 0:j.data)==null?void 0:ie.length,de)}catch(re){console.error("Export error:",re),o&&o((re==null?void 0:re.message)||"Export failed")}finally{f(!1)}},C=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(U,{variant:m,size:y,onClick:()=>B(!V),disabled:i||w,iconName:w?void 0:"Download",iconPosition:"left",className:`${b} ${w?"cursor-wait":""}`,"aria-label":`Export ${C()}`,children:w?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${C()}`}),V&&!w&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ee,{value:h,onChange:E,options:x,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ee,{value:P,onChange:q,options:Z,className:"w-full"})]}),P==="filtered"&&((I=Object==null?void 0:Object.keys(c))==null?void 0:I.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Me,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),P==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Me,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",l==null?void 0:l.length," selected record",(l==null?void 0:l.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(U,{variant:"ghost",size:"sm",onClick:()=>B(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(U,{size:"sm",onClick:K,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${C()}`,children:"Export"})]})]})})]})},Oe={async getVehicles(r={},c=null){var l,t,u,o;try{let i=(u=(t=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:t.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:u.order("created_at",{ascending:!1});return c&&(i=i==null?void 0:i.eq("org_id",c)),r!=null&&r.status&&(i=i==null?void 0:i.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(i=i==null?void 0:i.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(i=i==null?void 0:i.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(i=i==null?void 0:i.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await Ce(i,"vehicles:getVehicles")||[],error:null}}catch(i){return(o=i==null?void 0:i.message)!=null&&o.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,c=null){var l,t,u,o,i;try{let m=(o=(u=(t=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:t.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:u.eq("id",r))==null?void 0:o.single();return c&&(m=m==null?void 0:m.eq("org_id",c)),{data:await Ce(m,"vehicles:getVehicleById"),error:null}}catch(m){return(i=m==null?void 0:m.message)!=null&&i.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var c,l,t,u,o,i,m,y,b,w;try{const{data:f,error:V}=await((b=(y=(m=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:m.insert([{...r,created_by:(i=(o=(u=await((t=(l=J)==null?void 0:l.auth)==null?void 0:t.getUser()))==null?void 0:u.data)==null?void 0:o.user)==null?void 0:i.id}]))==null?void 0:y.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:b.single());return V?{data:null,error:{message:V==null?void 0:V.message}}:{data:f,error:null}}catch(f){return(w=f==null?void 0:f.message)!=null&&w.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var c,l,t,u;try{const{data:o,error:i}=await((u=(t=(l=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:l.insert([r]))==null?void 0:t.select())==null?void 0:u.single());if(i)throw console.error("Vehicle creation error:",i),new Error(i.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",o),o}catch(o){throw console.error("Error in vehicleService.create:",o),o}},async createVehicleWithProducts(r){var c,l;try{console.log("Creating vehicle with products:",r);const t=`vehicle_${Date.now()}`;await new Promise(o=>setTimeout(o,1e3));const u={id:t,...r,created_at:(c=new Date)==null?void 0:c.toISOString(),initial_products_count:((l=r==null?void 0:r.initial_products)==null?void 0:l.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",u),u}catch(t){throw console.error("Error creating vehicle with products:",t),t}},async checkStockNumberExists(r){var c,l,t,u;if(!(r!=null&&r.trim()))return!1;try{const{data:o,error:i}=await((u=(t=(l=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:t.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:u.maybeSingle());return i?(console.error("Stock number check error:",i),!1):!!o}catch(o){return console.error("Error checking stock number:",o),!1}},async checkVinExists(r){var c,l,t,u;if(!(r!=null&&r.trim()))return!1;try{const{data:o,error:i}=await((u=(t=(l=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:t.eq("vin",r==null?void 0:r.trim()))==null?void 0:u.maybeSingle());return i?(console.error("VIN check error:",i),!1):!!o}catch(o){return console.error("Error checking VIN:",o),!1}},async updateVehicle(r,c){var l,t,u,o,i,m,y;try{const{data:b,error:w}=await((m=(i=(o=(u=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:u.update({...c,updated_at:(t=new Date)==null?void 0:t.toISOString()}))==null?void 0:o.eq("id",r))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:m.single());return w?{data:null,error:{message:w==null?void 0:w.message}}:{data:b,error:null}}catch(b){return(y=b==null?void 0:b.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var c,l,t,u;try{const{error:o}=await((t=(l=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:l.delete())==null?void 0:t.eq("id",r));return o?{error:{message:o==null?void 0:o.message}}:{error:null}}catch(o){return(u=o==null?void 0:o.message)!=null&&u.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var c,l,t,u,o,i,m;try{let y=(l=(c=J)==null?void 0:c.from("vehicles"))==null?void 0:l.select("vehicle_status");r&&(y=y==null?void 0:y.eq("org_id",r));const b=await Ce(y,"vehicles:getVehicleStats");return{data:{total:(b==null?void 0:b.length)||0,active:((t=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="active"))==null?void 0:t.length)||0,maintenance:((u=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="maintenance"))==null?void 0:u.length)||0,retired:((o=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="retired"))==null?void 0:o.length)||0,sold:((i=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="sold"))==null?void 0:i.length)||0},error:null}}catch(y){return(m=y==null?void 0:y.message)!=null&&m.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function is({isOpen:r,onClose:c,onSuccess:l}){var g,F,A;const{user:t}=Le(),{orgId:u}=Ye()||{},[o,i]=$.useState(1),[m,y]=$.useState(!1),[b,w]=$.useState(""),[f,V]=$.useState(!1),[B,h]=$.useState(!1),[E,P]=$.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),q={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(g=new Date)==null?void 0:g.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[n,se]=$.useState(q),[x,Z]=$.useState([]),T=async(a=0)=>{var k,O;try{P(L=>({...L,loading:!0,error:null,retryCount:a}));const[H,Q,D,le,S]=await Promise.all([Ae().catch(()=>[]),Re().catch(()=>[]),Ve().catch(()=>[]),Be({activeOnly:!0}).catch(()=>[]),Ue({activeOnly:!0}).catch(()=>[])]);P({salesConsultants:H,deliveryCoordinators:Q,financeManagers:D,vendors:le,products:S==null?void 0:S.map(L=>({...L,unitPrice:L==null?void 0:L.unit_price})),loading:!1,error:null,retryCount:a})}catch(H){if(console.error("Failed to load dropdown data:",H),a<2&&((k=H==null?void 0:H.message)!=null&&k.includes("fetch")||(O=H==null?void 0:H.message)!=null&&O.includes("network"))){setTimeout(()=>T(a+1),1e3*(a+1));return}P(Q=>({...Q,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:a}))}},K=({checked:a,onChange:k})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!a,onChange:O=>{var Q;const H=!!((Q=O==null?void 0:O.target)!=null&&Q.checked);k(H)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),C=({label:a,options:k,value:O,onChange:H,placeholder:Q,required:D=!1,helpText:le,testId:S})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[a," ",D&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:O||"",onChange:L=>{var ne;return H(((ne=L==null?void 0:L.target)==null?void 0:ne.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:E==null?void 0:E.loading,required:D,"data-testid":S,children:[e.jsx("option",{value:"",children:Q}),k==null?void 0:k.map(L=>e.jsx("option",{value:L==null?void 0:L.id,children:(L==null?void 0:L.full_name)||(L==null?void 0:L.label)||(L==null?void 0:L.name)},L==null?void 0:L.id))]}),le&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:le}),(k==null?void 0:k.length)===0&&!(E!=null&&E.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-red-500",children:["No ",a==null?void 0:a.toLowerCase()," found. Please check your database connection."]})]});$.useEffect(()=>{const a=(n==null?void 0:n.customerName)!==(q==null?void 0:q.customerName)||(n==null?void 0:n.customerPhone)!==(q==null?void 0:q.customerPhone)||(n==null?void 0:n.customerEmail)!==(q==null?void 0:q.customerEmail)||(n==null?void 0:n.needsLoaner)!==(q==null?void 0:q.needsLoaner)||(n==null?void 0:n.assignedTo)!==(q==null?void 0:q.assignedTo)||(n==null?void 0:n.deliveryCoordinator)!==(q==null?void 0:q.deliveryCoordinator)||(n==null?void 0:n.financeManager)!==(q==null?void 0:q.financeManager)||(x==null?void 0:x.length)>0;V(a)},[n,x]),$.useEffect(()=>{r&&T()},[r]);const I=()=>{Z(a=>[...a,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},Y=(a,k,O)=>{var H;if(Z(Q=>Q==null?void 0:Q.map(D=>{if((D==null?void 0:D.id)===a){let le={...D,[k]:O};return k==="requiresScheduling"&&(O===!0?le.noScheduleReason="":le.promisedDate=""),le}return D})),k==="productId"&&O){const Q=(H=E==null?void 0:E.products)==null?void 0:H.find(D=>(D==null?void 0:D.id)===O);Q&&Z(D=>D==null?void 0:D.map(le=>(le==null?void 0:le.id)===a?{...le,unitPrice:(Q==null?void 0:Q.unitPrice)||""}:le))}},xe=a=>{Z(k=>k==null?void 0:k.filter(O=>(O==null?void 0:O.id)!==a))},W=()=>{var a,k;return((k=(a=n==null?void 0:n.customerName)==null?void 0:a.trim())==null?void 0:k.length)>0},ie=()=>(x==null?void 0:x.length)===0?!1:x==null?void 0:x.every(a=>{var k;return!(!(a!=null&&a.productId)||!(a!=null&&a.unitPrice)||a!=null&&a.requiresScheduling&&!(a!=null&&a.promisedDate)||!(a!=null&&a.requiresScheduling)&&!((k=a==null?void 0:a.noScheduleReason)!=null&&k.trim())||(a==null?void 0:a.serviceType)==="vendor"&&!(a!=null&&a.vendorId))}),re=()=>x==null?void 0:x.reduce((a,k)=>a+(parseFloat(k==null?void 0:k.unitPrice)||0),0),j=async()=>{var a,k,O,H,Q,D,le,S,L,ne;if(!W()){w("Customer name is required to save draft");return}y(!0),w("");try{const ge={year:(n==null?void 0:n.vehicleYear)||((a=new Date)==null?void 0:a.getFullYear()),make:(n==null?void 0:n.vehicleMake)||"TBD",model:(n==null?void 0:n.vehicleModel)||"TBD",owner_name:(k=n==null?void 0:n.customerName)==null?void 0:k.trim(),owner_phone:((O=n==null?void 0:n.customerPhone)==null?void 0:O.trim())||null,owner_email:((H=n==null?void 0:n.customerEmail)==null?void 0:H.trim())||null,stock_number:((Q=n==null?void 0:n.stockNumber)==null?void 0:Q.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},fe=await Oe.create(ge),me={title:`Draft Deal - ${(D=n==null?void 0:n.customerName)==null?void 0:D.trim()}`,description:`Draft deal for ${(le=n==null?void 0:n.customerName)==null?void 0:le.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:fe==null?void 0:fe.id,assigned_to:(n==null?void 0:n.assignedTo)||(t==null?void 0:t.id),delivery_coordinator_id:(n==null?void 0:n.deliveryCoordinator)||null,finance_manager_id:(n==null?void 0:n.financeManager)||null,customer_needs_loaner:!!(n!=null&&n.needsLoaner),customerName:(S=n==null?void 0:n.customerName)==null?void 0:S.trim(),customerPhone:((L=n==null?void 0:n.customerPhone)==null?void 0:L.trim())||"",customerEmail:((ne=n==null?void 0:n.customerEmail)==null?void 0:ne.trim())||"",org_id:u||void 0,lineItems:[]};await Te.createDeal(me),l==null||l(),R(),c()}catch(ge){w(`Failed to save draft: ${ge==null?void 0:ge.message}`)}finally{y(!1)}},de=async()=>{var a,k,O,H,Q,D,le,S,L,ne,ge,fe;if(!W()||!ie()){w("Please complete all required fields");return}y(!0),w("");try{const me={year:(n==null?void 0:n.vehicleYear)||((a=new Date)==null?void 0:a.getFullYear()),make:(n==null?void 0:n.vehicleMake)||"TBD",model:(n==null?void 0:n.vehicleModel)||"TBD",owner_name:(k=n==null?void 0:n.customerName)==null?void 0:k.trim(),owner_phone:((O=n==null?void 0:n.customerPhone)==null?void 0:O.trim())||null,owner_email:((H=n==null?void 0:n.customerEmail)==null?void 0:H.trim())||null,stock_number:((Q=n==null?void 0:n.stockNumber)==null?void 0:Q.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},je=await Oe.create(me),Ne=re(),p=(x==null?void 0:x.some(v=>(v==null?void 0:v.serviceType)==="vendor"))?"vendor":"in_house",M=((D=x==null?void 0:x.find(v=>v==null?void 0:v.vendorId))==null?void 0:D.vendorId)||null;let s=null;if(p==="vendor"){const v=(x||[]).filter(ae=>(ae==null?void 0:ae.serviceType)==="vendor"&&(ae==null?void 0:ae.requiresScheduling)&&(ae==null?void 0:ae.promisedDate)).map(ae=>new Date(ae==null?void 0:ae.promisedDate)).sort((ae,he)=>ae-he);s=(le=(v==null?void 0:v[0])||new Date)==null?void 0:le.toISOString()}const _=(x||[]).map(v=>({product_id:v==null?void 0:v.productId,quantity_used:1,unit_price:parseFloat((v==null?void 0:v.unitPrice)||0),promised_date:v!=null&&v.requiresScheduling?v==null?void 0:v.promisedDate:null,requires_scheduling:!!(v!=null&&v.requiresScheduling),no_schedule_reason:v!=null&&v.requiresScheduling?null:v==null?void 0:v.noScheduleReason,is_off_site:(v==null?void 0:v.serviceType)==="vendor"})),z={title:`Deal - ${(S=n==null?void 0:n.customerName)==null?void 0:S.trim()}`,description:`Deal for ${(L=n==null?void 0:n.customerName)==null?void 0:L.trim()}`,job_status:"pending",service_type:p,vehicle_id:je==null?void 0:je.id,vendor_id:M,assigned_to:(n==null?void 0:n.assignedTo)||(t==null?void 0:t.id),delivery_coordinator_id:(n==null?void 0:n.deliveryCoordinator)||null,finance_manager_id:(n==null?void 0:n.financeManager)||null,customer_needs_loaner:!!(n!=null&&n.needsLoaner),scheduled_start_time:s,estimated_cost:Ne,org_id:u||void 0,customerName:(ne=n==null?void 0:n.customerName)==null?void 0:ne.trim(),customerPhone:((ge=n==null?void 0:n.customerPhone)==null?void 0:ge.trim())||"",customerEmail:((fe=n==null?void 0:n.customerEmail)==null?void 0:fe.trim())||"",lineItems:_},N=await Te.createDeal(z);await Te.updateDeal(N==null?void 0:N.id,z),l==null||l(),R(),c()}catch(me){w(`Failed to create deal: ${me==null?void 0:me.message}`)}finally{y(!1)}},R=()=>{i(1),se(q),Z([]),w(""),V(!1)},ve=()=>{f?h(!0):(R(),c())},ye=()=>{h(!1),R(),c()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:o===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:ve,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(G,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${o>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${o>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${o>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${o>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[b&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",b]}),e.jsx("button",{onClick:()=>w(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(G,{name:"X",size:16})})]})}),(E==null?void 0:E.loading)&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(G,{name:"Loader",size:16,className:"mr-2 animate-spin"}),"Loading dropdown data..."]})}),(E==null?void 0:E.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",E==null?void 0:E.error]}),e.jsx("button",{onClick:()=>T(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),o===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:n==null?void 0:n.customerName,onChange:a=>se(k=>{var O;return{...k,customerName:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:n==null?void 0:n.customerPhone,onChange:a=>se(k=>{var O;return{...k,customerPhone:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:n==null?void 0:n.customerEmail,onChange:a=>se(k=>{var O;return{...k,customerEmail:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(n==null?void 0:n.vehicleYear)||"",onChange:a=>se(k=>{var O;return{...k,vehicleYear:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((F=new Date)==null?void 0:F.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(n==null?void 0:n.vehicleMake)||"",onChange:a=>se(k=>{var O;return{...k,vehicleMake:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(n==null?void 0:n.vehicleModel)||"",onChange:a=>se(k=>{var O;return{...k,vehicleModel:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(n==null?void 0:n.stockNumber)||"",onChange:a=>se(k=>{var O;return{...k,stockNumber:(O=a==null?void 0:a.target)==null?void 0:O.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(K,{checked:n==null?void 0:n.needsLoaner,onChange:a=>{se(k=>({...k,needsLoaner:!!a}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(C,{label:"Sales Consultant",options:E==null?void 0:E.salesConsultants,value:n==null?void 0:n.assignedTo,onChange:a=>se(k=>({...k,assignedTo:a})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(C,{label:"Delivery Coordinator",options:E==null?void 0:E.deliveryCoordinators,value:n==null?void 0:n.deliveryCoordinator,onChange:a=>se(k=>({...k,deliveryCoordinator:a})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(C,{label:"Finance Manager",options:E==null?void 0:E.financeManagers,value:n==null?void 0:n.financeManager,onChange:a=>se(k=>({...k,financeManager:a})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),o===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(U,{onClick:I,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(G,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(x==null?void 0:x.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(G,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[x==null?void 0:x.map((a,k)=>{var O,H,Q,D,le;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",k+1]}),e.jsx("button",{onClick:()=>xe(a==null?void 0:a.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(G,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(a==null?void 0:a.productId)||"",onChange:S=>{var L;return Y(a==null?void 0:a.id,"productId",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${k}`,children:[e.jsx("option",{value:"",children:"Select product"}),(O=E==null?void 0:E.products)==null?void 0:O.map(S=>e.jsx("option",{value:S==null?void 0:S.id,children:S==null?void 0:S.label},S==null?void 0:S.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:a==null?void 0:a.unitPrice,onChange:S=>{var L;return Y(a==null?void 0:a.id,"unitPrice",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${k}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${a==null?void 0:a.id}`,value:"in_house",checked:(a==null?void 0:a.serviceType)==="in_house",onChange:S=>{var L;return Y(a==null?void 0:a.id,"serviceType",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${a==null?void 0:a.id}`,value:"vendor",checked:(a==null?void 0:a.serviceType)==="vendor",onChange:S=>{var L;return Y(a==null?void 0:a.id,"serviceType",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(a==null?void 0:a.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(a==null?void 0:a.vendorId)||"",onChange:S=>{var L;return Y(a==null?void 0:a.id,"vendorId",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(H=E==null?void 0:E.vendors)==null?void 0:H.map(S=>e.jsx("option",{value:S==null?void 0:S.id,children:S==null?void 0:S.label},S==null?void 0:S.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${a==null?void 0:a.id}`,checked:(a==null?void 0:a.requiresScheduling)===!0,onChange:()=>Y(a==null?void 0:a.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${k}`,"data-testid":`requires-scheduling-${k}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${a==null?void 0:a.id}`,checked:(a==null?void 0:a.requiresScheduling)===!1,onChange:()=>Y(a==null?void 0:a.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${k}`}),"No Scheduling Needed"]})]}),a!=null&&a.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:a==null?void 0:a.promisedDate,onChange:S=>{var L;return Y(a==null?void 0:a.id,"promisedDate",(L=S==null?void 0:S.target)==null?void 0:L.value)},min:(le=(D=(Q=new Date)==null?void 0:Q.toISOString())==null?void 0:D.split("T"))==null?void 0:le[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a==null?void 0:a.noScheduleReason,onChange:S=>{var L;return Y(a==null?void 0:a.id,"noScheduleReason",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:a==null?void 0:a.serviceNotes,onChange:S=>{var L;return Y(a==null?void 0:a.id,"serviceNotes",(L=S==null?void 0:S.target)==null?void 0:L.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},a==null?void 0:a.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(A=re())==null?void 0:A.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[x==null?void 0:x.length," item",(x==null?void 0:x.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:o===2&&e.jsx(U,{onClick:()=>i(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(U,{onClick:ve,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),o===1&&e.jsxs(e.Fragment,{children:[e.jsx(U,{onClick:j,disabled:!W()||m,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:m?"Saving...":"Save Draft"}),e.jsx(U,{onClick:()=>i(2),disabled:!W(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),o===2&&e.jsx(U,{onClick:de,disabled:!W()||!ie()||m,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:m?"Creating...":"Create Deal"})]})]})}),B&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(U,{variant:"outline",onClick:()=>h(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(U,{onClick:ye,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function os(r,{activeOnly:c=!0}={}){let l=J.from("products").select("*").order("name",{ascending:!0});c&&(l=l.eq("is_active",!0)),r&&(l=l.or(`org_id.eq.${r},org_id.is.null`));const t=await Ce(l,"products:listByOrg");return rs(t,{labelKey:"name",valueKey:"id"})}function ds(r,{activeOnly:c=!0}={}){let l=J.from("user_profiles").select("*").order("full_name",{ascending:!0});return c&&(l=l.eq("is_active",!0)),r&&(l=l.eq("org_id",r)),Ce(l,"staff:listByOrg")}function Je(r={}){var P,q,n,se;const{loadOnMount:c=!0,cacheTime:l=5*60*1e3}=r,[t,u]=$.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[o,i]=$.useState(null),m=Ye(),y=Le(),b=async()=>{var x,Z,T,K;try{if(u(R=>({...R,loading:!0,error:null})),m.loading){u(R=>({...R,loading:!0}));return}if(!((x=m.session)!=null&&x.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),u(R=>({...R,loading:!1}));return}const C=!!m.orgId,I=[(Z=Re())==null?void 0:Z.catch(R=>(console.error("[dropdowns:dc] Delivery coordinators failed:",R),[])),(T=Ae())==null?void 0:T.catch(R=>(console.error("[dropdowns:sales] Sales consultants failed:",R),[])),(K=Ve())==null?void 0:K.catch(R=>(console.error("[dropdowns:finance] Finance managers failed:",R),[])),C?ds(m.orgId).catch(R=>(console.error("[dropdowns:users] tenant staff failed:",R),[])):Xe({activeOnly:!0}).catch(R=>(console.error("[dropdowns:users] global user profiles failed:",R),[])),C?as(m.orgId).catch(R=>(console.error("[dropdowns:vendors] tenant vendors failed:",R),[])):Be({activeOnly:!0}).catch(R=>(console.error("[dropdowns:vendors] global vendors failed:",R),[])),C?os(m.orgId).catch(R=>(console.error("[dropdowns:products] tenant products failed:",R),[])):Ue({activeOnly:!0}).catch(R=>(console.error("[dropdowns:products] global products failed:",R),[])),C?ls(m.orgId).catch(R=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",R),[])):Promise.resolve([])],[Y,xe,W,ie,re,j,de]=await Promise.all(I);u({dc:Y,sales:xe,finance:W,users:ie,vendors:re,products:j,smsTemplates:de,loading:!1,error:null,searchResults:null}),i(Date.now())}catch(C){u({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(C==null?void 0:C.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",C)}},w=()=>o?Date.now()-o<l:!1,f=async()=>{w()||await b()},V=async x=>{try{if(!(x!=null&&x.trim())){u(T=>({...T,searchResults:null}));return}const Z=await We(x);u(T=>({...T,searchResults:Z}))}catch(Z){console.error("[dropdowns:search] Search failed:",Z),u(T=>({...T,searchResults:{users:[],vendors:[]}}))}},B=()=>{u(x=>({...x,searchResults:null}))},h=(x={})=>{const{roles:Z=[],departments:T=[],activeOnly:K=!0}=x;let C=(t==null?void 0:t.users)||[];return K&&(C=C==null?void 0:C.filter(I=>I==null?void 0:I.is_active)),(Z==null?void 0:Z.length)>0&&(C=C==null?void 0:C.filter(I=>Z==null?void 0:Z.includes(I==null?void 0:I.role))),(T==null?void 0:T.length)>0&&(C=C==null?void 0:C.filter(I=>T==null?void 0:T.includes(I==null?void 0:I.department))),(C==null?void 0:C.map(I=>({id:I==null?void 0:I.id,value:I==null?void 0:I.id,label:I==null?void 0:I.full_name,name:I==null?void 0:I.full_name,role:I==null?void 0:I.role,department:I==null?void 0:I.department,email:I==null?void 0:I.email})))||[]},E=(x={})=>{const{activeOnly:Z=!0,specialty:T=null}=x;let K=(t==null?void 0:t.vendors)||[];return Z&&(K=K==null?void 0:K.filter(C=>C==null?void 0:C.is_active)),T&&(K=K==null?void 0:K.filter(C=>{var I,Y;return(Y=(I=C==null?void 0:C.specialty)==null?void 0:I.toLowerCase())==null?void 0:Y.includes(T==null?void 0:T.toLowerCase())})),(K==null?void 0:K.map(C=>({id:C==null?void 0:C.id,value:(C==null?void 0:C.value)||(C==null?void 0:C.id),label:(C==null?void 0:C.label)||(C==null?void 0:C.name),name:C==null?void 0:C.name,specialty:C==null?void 0:C.specialty,email:C==null?void 0:C.email,phone:C==null?void 0:C.phone})))||[]};return $.useEffect(()=>{let x=!0;return(async()=>{var T;if(!c)return;const Z=Date.now();for(;x&&(y!=null&&y.loading)&&Date.now()-Z<5e3;)await new Promise(K=>setTimeout(K,200));x&&(y!=null&&y.user?(console.log("Dropdowns: authenticated user",(T=y==null?void 0:y.user)==null?void 0:T.id),y!=null&&y.userProfile&&console.log("Dropdowns: user profile org",y.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),x&&await b())})(),()=>{x=!1}},[c,y==null?void 0:y.loading,(P=y==null?void 0:y.user)==null?void 0:P.id,m==null?void 0:m.loading,m==null?void 0:m.orgId]),{dc:t==null?void 0:t.dc,sales:t==null?void 0:t.sales,finance:t==null?void 0:t.finance,users:t==null?void 0:t.users,vendors:t==null?void 0:t.vendors,products:t==null?void 0:t.products,smsTemplates:t==null?void 0:t.smsTemplates,loading:t==null?void 0:t.loading,error:t==null?void 0:t.error,searchResults:t==null?void 0:t.searchResults,globalSearch:V,clearSearch:B,getUserOptions:h,getVendorOptions:E,refresh:b,refreshIfNeeded:f,lastUpdate:o,isCacheValid:w(),salesConsultantOptions:(q=(t==null?void 0:t.sales)||[])==null?void 0:q.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),deliveryCoordinatorOptions:(n=(t==null?void 0:t.dc)||[])==null?void 0:n.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),financeManagerOptions:(se=(t==null?void 0:t.finance)||[])==null?void 0:se.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name}))}}const us=()=>{var y,b,w;const{dc:r,sales:c,finance:l,vendors:t,products:u,loading:o,error:i,refresh:m}=Je({loadOnMount:!0});return{salesConsultants:c,deliveryCoordinators:r,financeManagers:l,vendors:t,products:u,loading:o,error:i,refresh:m,salesConsultantOptions:(y=c||[])==null?void 0:y.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),deliveryCoordinatorOptions:(b=r||[])==null?void 0:b.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),financeManagerOptions:(w=l||[])==null?void 0:w.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),vendorOptions:t||[],productOptions:u||[]}},hs=()=>(He.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Se=({options:r=[],value:c,onChange:l,placeholder:t="Select...",searchable:u=!1,clearable:o=!1,disabled:i=!1,loading:m=!1,error:y=null,className:b="",optionLabel:w="label",optionValue:f="value",groupBy:V=null,renderOption:B=null,label:h="",helperText:E=""})=>{const[P,q]=$.useState(!1),[n,se]=$.useState(""),[x,Z]=$.useState(!1),[T,K]=$.useState(r),[C,I]=$.useState(-1),[Y,xe]=$.useState({top:0,left:0,width:0}),W=$.useRef(null),ie=$.useRef(null);$.useRef(null),$.useEffect(()=>{Z((()=>{var a;return(a=window.matchMedia("(max-width: 767px)"))==null?void 0:a.matches})());const F=window.matchMedia("(max-width: 767px)"),A=()=>Z(F==null?void 0:F.matches);return F==null||F.addEventListener("change",A),()=>F==null?void 0:F.removeEventListener("change",A)},[]),$.useEffect(()=>{if(!(n!=null&&n.trim())){K(r);return}const g=n==null?void 0:n.toLowerCase(),F=r==null?void 0:r.filter(A=>{const a=[A==null?void 0:A.name,A==null?void 0:A.displayName,A==null?void 0:A.category,A==null?void 0:A.brand,A==null?void 0:A.specialty,A==null?void 0:A.department,A==null?void 0:A.email].filter(Boolean);return a==null?void 0:a.some(k=>{var O;return(O=k==null?void 0:k.toLowerCase())==null?void 0:O.includes(g)})});K(F),I(-1)},[n,r]);const re=r==null?void 0:r.find(g=>(g==null?void 0:g.id)===c),j=g=>((g==null?void 0:g[f])||(g==null?void 0:g.id))===c,de=()=>{var g;if(W!=null&&W.current){const F=(g=W==null?void 0:W.current)==null?void 0:g.getBoundingClientRect();xe({top:(F==null?void 0:F.bottom)+window.scrollY,left:(F==null?void 0:F.left)+window.scrollX,width:F==null?void 0:F.width})}};$.useEffect(()=>{P&&!x&&de()},[P,x]),$.useEffect(()=>{if(x)return;const g=F=>{var A;W!=null&&W.current&&!((A=W==null?void 0:W.current)!=null&&A.contains(F==null?void 0:F.target))&&(q(!1),se(""),I(-1))};return document==null||document.addEventListener("mousedown",g),()=>document==null?void 0:document.removeEventListener("mousedown",g)},[x]);const R=g=>{if(!x){if(!P){((g==null?void 0:g.key)==="Enter"||(g==null?void 0:g.key)===" "||(g==null?void 0:g.key)==="ArrowDown")&&(g==null||g.preventDefault(),q(!0),u&&setTimeout(()=>{var F;return(F=ie==null?void 0:ie.current)==null?void 0:F.focus()},0));return}switch(g==null?void 0:g.key){case"Escape":q(!1),se(""),I(-1);break;case"ArrowDown":g==null||g.preventDefault(),I(F=>F<(T==null?void 0:T.length)-1?F+1:0);break;case"ArrowUp":g==null||g.preventDefault(),I(F=>F>0?F-1:(T==null?void 0:T.length)-1);break;case"Enter":g==null||g.preventDefault(),C>=0&&(T!=null&&T[C])&&ve(T==null?void 0:T[C]);break;case"Tab":q(!1),se(""),I(-1);break}}},ve=g=>{l==null||l(g==null?void 0:g.id),q(!1),se(""),I(-1)},ye=g=>{g==null||g.stopPropagation(),l==null||l(null)};return x?e.jsxs("div",{className:`relative ${b}`,children:[e.jsxs("select",{value:c||"",onChange:g=>{var F;return l==null?void 0:l(((F=g==null?void 0:g.target)==null?void 0:F.value)||null)},disabled:i||m,className:`
            w-full px-3 py-2 border rounded-lg
            ${y?"border-red-500":"border-gray-300"}
            ${i||m?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:t}),r==null?void 0:r.map(g=>e.jsx("option",{value:(g==null?void 0:g[f])||(g==null?void 0:g.id),children:(g==null?void 0:g[w])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[f])||(g==null?void 0:g.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(G,{name:"ChevronDown",size:16,className:"text-gray-400"})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]}):e.jsxs("div",{className:`relative ${b}`,ref:W,children:[e.jsxs("button",{type:"button",onClick:()=>!i&&!m&&q(!P),onKeyDown:R,disabled:i||m,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${y?"border-red-500":"border-gray-300"}
          ${i||m?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${P?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:re?"text-gray-900":"text-gray-500",children:re?(re==null?void 0:re[w])||(re==null?void 0:re.label):t}),e.jsxs("div",{className:"flex items-center space-x-1",children:[m&&e.jsx(G,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),o&&re&&!m&&e.jsx("button",{type:"button",onClick:ye,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(G,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(G,{name:P?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),P&&typeof window<"u"&&e.jsx(hs,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>q(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${Y==null?void 0:Y.top}px`,left:`${Y==null?void 0:Y.left}px`,width:`${Y==null?void 0:Y.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:g=>g==null?void 0:g.stopPropagation(),children:[u&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:n,onChange:g=>{var F;return se((F=g==null?void 0:g.target)==null?void 0:F.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(T==null?void 0:T.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:n?"No results found":"No options available"}):T==null?void 0:T.map(g=>e.jsx("button",{type:"button",onClick:()=>ve(g),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${j(g)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(g==null?void 0:g[w])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[f])||(g==null?void 0:g.id)))})]})})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]})},xs=({isOpen:r,dealId:c,onClose:l,onSuccess:t})=>{var L,ne,ge,fe,me,je,Ne;const[u,o]=$.useState(!0),[i,m]=$.useState(!1),[y,b]=$.useState(""),[w,f]=$.useState(!1),[V,B]=$.useState(!1),[h,E]=$.useState(!1),[P,q]=$.useState(!1),[n,se]=$.useState(null),[x,Z]=$.useState(null),[T,K]=$.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:C,deliveryCoordinatorOptions:I,financeManagerOptions:Y,vendors:xe,products:W,loading:ie,refresh:re}=us(),[j,de]=$.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,financeManager:null,lineItems:[]});$.useEffect(()=>{if(n){const d=JSON.stringify(j)!==JSON.stringify(n);E(d)}},[j,n]),$.useEffect(()=>{r&&re()},[r,re]),$.useEffect(()=>{r&&c&&g()},[r,c]);const R=({checked:d,onChange:p})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!d,onChange:M=>{var s;return p(!!((s=M==null?void 0:M.target)!=null&&s.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),ve=({value:d,selectedValue:p,onChange:M,itemIndex:s,disabled:_=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${s}`,value:"in_house",checked:!p,onChange:()=>M(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:_}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${s}`,value:"vendor",checked:p,onChange:()=>M(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:_}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),ye=({requiresScheduling:d,onChange:p,itemIndex:M,disabled:s=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${M}`,checked:d===!0,onChange:()=>p(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:s}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${M}`,checked:d===!1,onChange:()=>p(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:s}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),g=async()=>{var d,p,M,s,_,z,N,v,ae,he;try{o(!0),b("");const be=await Ge(c),oe=Ze(be),{data:te}=await((s=(M=(p=(d=J)==null?void 0:d.from("transactions"))==null?void 0:p.select("customer_name, customer_phone, customer_email"))==null?void 0:M.eq("job_id",c))==null?void 0:s.single());let ce=null;try{const{data:ee}=await((ae=(v=(N=(z=(_=J)==null?void 0:_.from("loaner_assignments"))==null?void 0:z.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:N.eq("job_id",c))==null?void 0:v.is("returned_at",null))==null?void 0:ae.limit(1));ce=Array.isArray(ee)?ee[0]:ee}catch{}const X={...oe,customerName:(te==null?void 0:te.customer_name)||"",customerPhone:(te==null?void 0:te.customer_phone)||"",customerEmail:(te==null?void 0:te.customer_email)||"",lineItems:((he=(oe==null?void 0:oe.lineItems)||[])==null?void 0:he.length)>0?oe==null?void 0:oe.lineItems:[F()]};if(de(X),se(JSON.parse(JSON.stringify(X))),Z(ce||null),ce)K({loaner_number:(ce==null?void 0:ce.loaner_number)||"",eta_return_date:(ce==null?void 0:ce.eta_return_date)||"",notes:(ce==null?void 0:ce.notes)||""});else{const ee=((X==null?void 0:X.lineItems)||[]).filter(pe=>(pe==null?void 0:pe.requiresScheduling)&&(pe==null?void 0:pe.lineItemPromisedDate)).map(pe=>new Date(pe.lineItemPromisedDate).getTime()),we=ee!=null&&ee.length?new Date(Math.max(...ee)):null;K(pe=>({...pe,eta_return_date:we?we.toISOString().split("T")[0]:""}))}}catch(be){b(`Failed to load deal: ${be==null?void 0:be.message}`)}finally{o(!1)}},F=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),A=d=>{de(p=>({...p,...d}))},a=(d,p)=>{if(de(M=>{var s;return{...M,lineItems:(s=M==null?void 0:M.lineItems)==null?void 0:s.map((_,z)=>{if(z===d){let N={..._,...p};return"requiresScheduling"in p&&(N.requiresScheduling=!!(p!=null&&p.requiresScheduling),(p==null?void 0:p.requiresScheduling)===!0?N.noScheduleReason="":N.lineItemPromisedDate=""),"isOffSite"in p&&(N.isOffSite=!!(p!=null&&p.isOffSite),p!=null&&p.isOffSite||(N.vendorId="")),N}return _})}}),p!=null&&p.product_id){const M=W==null?void 0:W.find(s=>(s==null?void 0:s.id)===(p==null?void 0:p.product_id));M&&de(s=>{var _;return{...s,lineItems:(_=s==null?void 0:s.lineItems)==null?void 0:_.map((z,N)=>N===d?{...z,unit_price:(M==null?void 0:M.unitPrice)||(M==null?void 0:M.unit_price)||(z==null?void 0:z.unit_price),cost_price:(M==null?void 0:M.cost)||(z==null?void 0:z.cost_price)}:z)}})}},k=()=>{de(d=>({...d,lineItems:[...d==null?void 0:d.lineItems,F()]}))},O=d=>{de(p=>{var M;return{...p,lineItems:(M=p==null?void 0:p.lineItems)==null?void 0:M.filter((s,_)=>_!==d)}})},H=async()=>{var d,p,M,s,_;try{if(m(!0),b(""),!((d=j==null?void 0:j.customerName)!=null&&d.trim())){b("Customer name is required");return}for(let N=0;N<((p=j==null?void 0:j.lineItems)==null?void 0:p.length);N++){const v=(M=j==null?void 0:j.lineItems)==null?void 0:M[N];if(!(v!=null&&v.product_id)){b(`Line item ${N+1}: Product is required`);return}if(v!=null&&v.requiresScheduling&&!(v!=null&&v.lineItemPromisedDate)){b(`Line item ${N+1}: Promised date is required when scheduling is needed`);return}if(!(v!=null&&v.requiresScheduling)&&!((s=v==null?void 0:v.noScheduleReason)!=null&&s.trim())){b(`Line item ${N+1}: Reason is required when no scheduling is needed`);return}if(v!=null&&v.isOffSite&&!(v!=null&&v.vendorId)){b(`Line item ${N+1}: Vendor is required for off-site service`);return}}const z={...j,customer_needs_loaner:!!(j!=null&&j.customer_needs_loaner),lineItems:(_=j==null?void 0:j.lineItems)==null?void 0:_.map(N=>({...N,requiresScheduling:!!(N!=null&&N.requiresScheduling),isOffSite:!!(N!=null&&N.isOffSite),unit_price:parseFloat(N==null?void 0:N.unit_price)||0,quantity_used:parseInt(N==null?void 0:N.quantity_used)||1}))};await Qe(c,{...z,loanerForm:T}),t==null||t(),l==null||l()}catch(z){b(`Failed to save deal: ${z==null?void 0:z.message}`)}finally{m(!1)}},Q=async()=>{try{B(!0),await De(c),t==null||t(),l==null||l()}catch(d){b(`Failed to delete deal: ${d==null?void 0:d.message}`)}finally{B(!1),f(!1)}},D=()=>{h?q(!0):l()},le=()=>{q(!1),l()},S=()=>{var d;return((d=j==null?void 0:j.lineItems)==null?void 0:d.reduce((p,M)=>{const s=parseFloat(M==null?void 0:M.unit_price)||0,_=parseInt(M==null?void 0:M.quantity_used)||1;return p+s*_},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:D,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(G,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[y&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:y})}),ie&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-blue-800 text-sm",children:"Loading dropdown data..."})}),u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-gray-600",children:"Loading deal..."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ee,{value:j==null?void 0:j.job_status,onChange:d=>{var p;return A({job_status:(p=d==null?void 0:d.target)==null?void 0:p.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(ue,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:j==null?void 0:j.customerName,onChange:d=>{var p;return A({customerName:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(ue,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:j==null?void 0:j.customerPhone,onChange:d=>{var p;return A({customerPhone:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(ue,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:j==null?void 0:j.customerEmail,onChange:d=>{var p;return A({customerEmail:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ee,{value:j==null?void 0:j.priority,onChange:d=>{var p;return A({priority:(p=d==null?void 0:d.target)==null?void 0:p.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(ue,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(j==null?void 0:j.vehicleYear)||"",onChange:d=>{var p;return A({vehicleYear:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"2024",min:"1900",max:((L=new Date)==null?void 0:L.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(ue,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(j==null?void 0:j.vehicleMake)||"",onChange:d=>{var p;return A({vehicleMake:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(ue,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(j==null?void 0:j.vehicleModel)||"",onChange:d=>{var p;return A({vehicleModel:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(ue,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(j==null?void 0:j.stockNumber)||"",onChange:d=>{var p;return A({stockNumber:(p=d==null?void 0:d.target)==null?void 0:p.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(R,{checked:j==null?void 0:j.customer_needs_loaner,onChange:d=>{if(A({customer_needs_loaner:d}),d&&!(T!=null&&T.eta_return_date)){const p=((j==null?void 0:j.lineItems)||[]).filter(s=>(s==null?void 0:s.requiresScheduling)&&(s==null?void 0:s.lineItemPromisedDate)).map(s=>new Date(s.lineItemPromisedDate).getTime()),M=p!=null&&p.length?new Date(Math.max(...p)):null;M&&K(s=>({...s,eta_return_date:M.toISOString().split("T")[0]}))}}}),x&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",x==null?void 0:x.loaner_number,(x==null?void 0:x.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due"," ",(ne=new Date(x==null?void 0:x.eta_return_date))==null?void 0:ne.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(j==null?void 0:j.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(ue,{id:"loaner-number","aria-label":"Loaner number",value:(T==null?void 0:T.loaner_number)||"",onChange:d=>K(p=>{var M;return{...p,loaner_number:(M=d==null?void 0:d.target)==null?void 0:M.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(ue,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(T==null?void 0:T.eta_return_date)||"",onChange:d=>K(p=>{var M;return{...p,eta_return_date:(M=d==null?void 0:d.target)==null?void 0:M.value}}),min:(me=(fe=(ge=new Date)==null?void 0:ge.toISOString())==null?void 0:fe.split("T"))==null?void 0:me[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ue,{id:"loaner-notes","aria-label":"Loaner notes",value:(T==null?void 0:T.notes)||"",onChange:d=>K(p=>{var M;return{...p,notes:(M=d==null?void 0:d.target)==null?void 0:M.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsx("div",{className:"mb-4","data-testid":"sales-select",children:e.jsx(Se,{label:"Sales Consultant",options:C,value:j==null?void 0:j.assignedTo,onChange:d=>A({assignedTo:d}),placeholder:"Select sales consultant",searchable:!0,clearable:!0})}),e.jsx("div",{className:"mb-4","data-testid":"delivery-select",children:e.jsx(Se,{label:"Delivery Coordinator",options:I,value:j==null?void 0:j.deliveryCoordinator,onChange:d=>A({deliveryCoordinator:d}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0})}),e.jsx("div",{"data-testid":"finance-select",children:e.jsx(Se,{label:"Finance Manager",options:Y,value:j==null?void 0:j.financeManager,onChange:d=>A({financeManager:d}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(U,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:k,children:[e.jsx(G,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(je=j==null?void 0:j.lineItems)==null?void 0:je.map((d,p)=>{var M,s,_,z;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",p+1]}),((M=j==null?void 0:j.lineItems)==null?void 0:M.length)>1&&e.jsx(U,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>O(p),children:e.jsx(G,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Se,{label:"Product *",options:W,value:(d==null?void 0:d.product_id)||"",onChange:N=>a(p,{product_id:N?parseInt(N):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(ue,{id:`unit-price-${p}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:d==null?void 0:d.unit_price,onChange:N=>{var v;return a(p,{unit_price:parseFloat((v=N==null?void 0:N.target)==null?void 0:v.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(ue,{id:`quantity-${p}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:d==null?void 0:d.quantity_used,onChange:N=>{var v;return a(p,{quantity_used:parseInt((v=N==null?void 0:N.target)==null?void 0:v.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(ve,{selectedValue:d==null?void 0:d.isOffSite,onChange:N=>a(p,{isOffSite:N}),itemIndex:p})]}),(d==null?void 0:d.isOffSite)&&e.jsx("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:e.jsx(Se,{label:"Vendor *",options:xe,value:(d==null?void 0:d.vendorId)||"",onChange:N=>a(p,{vendorId:N}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"})}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(ye,{requiresScheduling:d==null?void 0:d.requiresScheduling,onChange:N=>a(p,{requiresScheduling:N}),itemIndex:p})}),d!=null&&d.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(ue,{id:`promised-date-${p}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:d==null?void 0:d.lineItemPromisedDate,onChange:N=>{var v;return a(p,{lineItemPromisedDate:(v=N==null?void 0:N.target)==null?void 0:v.value})},min:(z=(_=(s=new Date)==null?void 0:s.toISOString())==null?void 0:_.split("T"))==null?void 0:z[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ue,{id:`notes-${p}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(d==null?void 0:d.description)||"",onChange:N=>{var v;return a(p,{description:(v=N==null?void 0:N.target)==null?void 0:v.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(ue,{id:`no-schedule-reason-${p}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:d==null?void 0:d.noScheduleReason,onChange:N=>{var v;return a(p,{noScheduleReason:(v=N==null?void 0:N.target)==null?void 0:v.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(d==null?void 0:d.unit_price)||0)*(parseInt(d==null?void 0:d.quantity_used)||1)).toFixed(2)]})]},p)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(Ne=S())==null?void 0:Ne.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(U,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>f(!0),children:[e.jsx(G,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(U,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:D,children:"Cancel"}),e.jsx(U,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:H,disabled:i,children:i?"Saving...":"Save Changes"})]})]}),w&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(U,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>f(!1),children:"Cancel"}),e.jsx(U,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:Q,disabled:V,children:V?"Deleting...":"Delete"})]})]})}),P&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(U,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>q(!1),children:"Keep Editing"}),e.jsx(U,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:le,children:"Discard Changes"})]})]})})]})}):null},gs=({status:r})=>{var u;const c={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},l=(c==null?void 0:c[r])||"bg-gray-100 text-gray-700",t=((u=r==null?void 0:r.replace("_"," "))==null?void 0:u.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${l}`,children:t})},$e=r=>{var o,i,m;if(!r)return"";const c=(o=r==null?void 0:r.trim())==null?void 0:o.split(" ");if((c==null?void 0:c.length)<2)return r;const l=c==null?void 0:c[0],t=(i=c==null?void 0:c.slice(1))==null?void 0:i.join(" "),u=(m=l==null?void 0:l[0])==null?void 0:m.toUpperCase();return`${t}, ${u}.`},Pe=({nextPromisedShort:r})=>{if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const c=new Date(r),l=new Date;l==null||l.setHours(0,0,0,0),c==null||c.setHours(0,0,0,0);const t=new Date(l);t==null||t.setDate((l==null?void 0:l.getDate())+2);let u="";return c<l?u="bg-red-100 text-red-800 border-red-200":c<=t?u="bg-amber-100 text-amber-800 border-amber-200":u="bg-green-100 text-green-800 border-green-200",e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${u}`,children:["Next: ",r]})},qe=({serviceType:r,jobParts:c})=>{const l=c==null?void 0:c.some(u=>u==null?void 0:u.is_off_site),t=c==null?void 0:c.some(u=>!(u!=null&&u.is_off_site));return l&&t?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):l?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},ms=({draftsCount:r,onViewDrafts:c})=>{const[l,t]=$.useState(!1);return r===0||l?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(G,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{size:"sm",variant:"ghost",onClick:c,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>t(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(G,{name:"X",size:16})})]})]})})},ke=r=>r?r!=null&&r.job_number?r.job_number:r!=null&&r.id?`Job-${String(r.id).slice(0,8)}`:"â€”":"â€”",Ke=r=>r&&(r==null?void 0:r.customer_name)||"",ze=({deal:r})=>!(r!=null&&r.customer_name)&&!(r!=null&&r.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"}):e.jsxs("div",{className:"space-y-1",children:[(r==null?void 0:r.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:r==null?void 0:r.customer_name}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:c=>c==null?void 0:c.stopPropagation(),children:r==null?void 0:r.customer_phone})]}),Fe=({amount:r})=>{var l;const c=parseFloat(r)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:l.format(c)})})},bs=({deal:r})=>r!=null&&r.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",r==null?void 0:r.loaner_number,(r==null?void 0:r.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due ",r==null?void 0:r.loaner_eta_short]})]}):null,fs=({isOpen:r,onClose:c,deal:l,onSave:t,loading:u})=>{var w,f,V,B;const[o,i]=$.useState({loaner_number:"",eta_return_date:"",notes:""}),[m,y]=$.useState("");$.useEffect(()=>{if(r&&l){let h="";try{const E=((l==null?void 0:l.job_parts)||[]).filter(P=>(P==null?void 0:P.requires_scheduling)&&(P==null?void 0:P.promised_date)).map(P=>new Date(P.promised_date));(E==null?void 0:E.length)>0&&(h=new Date(Math.max.apply(null,E)).toISOString().split("T")[0])}catch{}i({loaner_number:(l==null?void 0:l.loaner_number)||"",eta_return_date:(l==null?void 0:l.loaner_eta_return_date)||h||"",notes:(l==null?void 0:l.loaner_notes)||""}),y("")}else r||(i({loaner_number:"",eta_return_date:"",notes:""}),y(""))},[r,l]);const b=async()=>{var h,E,P;if(y(""),!((h=o==null?void 0:o.loaner_number)!=null&&h.trim())){y("Loaner number is required");return}if(!(o!=null&&o.eta_return_date)){y("ETA return date is required");return}try{await t({job_id:l==null?void 0:l.id,loaner_number:(E=o==null?void 0:o.loaner_number)==null?void 0:E.trim(),eta_return_date:o==null?void 0:o.eta_return_date,notes:((P=o==null?void 0:o.notes)==null?void 0:P.trim())||null}),c()}catch(q){y((q==null?void 0:q.message)||"Failed to save loaner assignment")}};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:c}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(U,{variant:"ghost",size:"icon",onClick:c,"aria-label":"Close drawer",children:e.jsx(G,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:ke(l)}),e.jsx("p",{className:"text-xs text-slate-500",children:Ke(l)})]}),m&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:m}),e.jsx("button",{onClick:()=>y(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:o==null?void 0:o.loaner_number,onChange:h=>i(E=>{var P;return{...E,loaner_number:(P=h==null?void 0:h.target)==null?void 0:P.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:o==null?void 0:o.eta_return_date,onChange:h=>i(E=>{var P;return{...E,eta_return_date:(P=h==null?void 0:h.target)==null?void 0:P.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(V=(f=(w=new Date)==null?void 0:w.toISOString())==null?void 0:f.split("T"))==null?void 0:V[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:o==null?void 0:o.notes,onChange:h=>i(E=>{var P;return{...E,notes:(P=h==null?void 0:h.target)==null?void 0:P.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(U,{variant:"outline",onClick:c,className:"flex-1 h-11",disabled:u,children:"Cancel"}),e.jsx(U,{onClick:b,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:u||!((B=o==null?void 0:o.loaner_number)!=null&&B.trim())||!(o!=null&&o.eta_return_date),children:u?"Saving...":"Save Loaner"})]})]})})]}):null},ps=({loaner:r,onClose:c,onConfirm:l,loading:t})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(U,{variant:"outline",onClick:c,className:"flex-1 h-11",disabled:t,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(U,{onClick:l,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:t,"aria-label":"Confirm loaner returned",children:t?"Processing...":"Mark Returned"})]})]})})}):null;function Ts(){var je,Ne,d,p,M;const[r,c]=$.useState([]),[l,t]=$.useState(!0),[u,o]=$.useState(!1),[i,m]=$.useState(!1),[y,b]=$.useState(null),[w,f]=$.useState(null),[V,B]=$.useState(""),[h,E]=$.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[P,q]=$.useState(!1),[n,se]=$.useState(null),[x,Z]=$.useState(!1),[T,K]=$.useState(null),[C,I]=$.useState(!1),[Y,xe]=$.useState(""),{getUserOptions:W,getVendorOptions:ie,clearSearch:re,loading:j,error:de,refresh:R}=Je({loadOnMount:!0});ns();const{user:ve}=Le(),ye=()=>{try{return W({roles:["staff"],departments:["Sales Consultants"],activeOnly:!0})||[]}catch(s){return console.error("Error getting sales consultants:",s),[]}},g=()=>{try{return W({roles:["admin","manager"],departments:["Delivery Coordinator"],activeOnly:!0})||[]}catch(s){return console.error("Error getting delivery coordinators:",s),[]}},F=()=>{try{return W({roles:["staff"],departments:["Finance Manager"],activeOnly:!0})||[]}catch(s){return console.error("Error getting finance managers:",s),[]}},A=(s={})=>{try{return ie(s)||[]}catch(_){return console.error("Error getting vendor options:",_),[]}},a=async s=>{var _;try{B("");const{error:z}=await((_=J)==null?void 0:_.rpc("delete_job_cascade",{p_job_id:s}));if(z)throw z;f(null),await H()}catch(z){B(`Failed to delete deal: ${z==null?void 0:z.message}`),console.error("Delete error:",z)}},k=async s=>{var _,z,N,v,ae,he,be,oe,te,ce;try{Z(!0),B("");let X=null;try{const{data:ee}=await((ae=(v=(N=(z=(_=J)==null?void 0:_.from("loaner_assignments"))==null?void 0:z.select("id"))==null?void 0:N.eq("job_id",s==null?void 0:s.job_id))==null?void 0:v.is("returned_at",null))==null?void 0:ae.limit(1));X=Array.isArray(ee)?ee[0]:ee}catch{}if(X!=null&&X.id){const{error:ee}=await((oe=(be=(he=J)==null?void 0:he.from("loaner_assignments"))==null?void 0:be.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:oe.eq("id",X.id));if(ee)throw ee}else{const{error:ee}=await((ce=(te=J)==null?void 0:te.from("loaner_assignments"))==null?void 0:ce.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(ee)throw ee}q(!1),se(null),await H()}catch(X){const ee=`Failed to save loaner assignment: ${X==null?void 0:X.message}`;throw B(ee),new Error(ee)}finally{Z(!1)}},O=async s=>{try{I(!0),B(""),await es(s==null?void 0:s.loaner_id),K(null),await H()}catch(_){B(`Failed to mark loaner as returned: ${_==null?void 0:_.message}`),console.error("Mark returned error:",_)}finally{I(!1)}},H=async(s=0)=>{var _,z;try{t(!0),B("");const N=await ss();c(N||[])}catch(N){const v=`Failed to load deals: ${N==null?void 0:N.message}`;if(console.error("Load deals error:",N),s<2&&((_=N==null?void 0:N.message)!=null&&_.includes("fetch")||(z=N==null?void 0:N.message)!=null&&z.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>H(s+1),1e3*(s+1));return}B(v),c([])}finally{t(!1)}};$.useEffect(()=>{var z;const s=new URLSearchParams(window.location.search),_=s==null?void 0:s.get("status");if(_){const N=((z=_==null?void 0:_.charAt(0))==null?void 0:z.toUpperCase())+(_==null?void 0:_.slice(1));E(v=>({...v,status:N}))}},[]),$.useEffect(()=>{H()},[]);const Q=s=>{se(s),q(!0)},D=({message:s,onClose:_})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(G,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),_&&e.jsx("button",{onClick:_,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(G,{name:"X",size:16})})]})}):null,S=(s=>{var oe,te,ce;const _=s||[],z=((oe=_==null?void 0:_.filter(X=>(X==null?void 0:X.job_status)==="in_progress"))==null?void 0:oe.length)||0,N=_==null?void 0:_.reduce((X,ee)=>{const we=parseFloat(ee==null?void 0:ee.total_amount)||0;return X+we},0),v=N*.25,ae=N>0?25:0,he=((te=_==null?void 0:_.filter(X=>(X==null?void 0:X.job_status)==="pending"))==null?void 0:te.length)||0,be=((ce=_==null?void 0:_.filter(X=>(X==null?void 0:X.job_status)==="draft"))==null?void 0:ce.length)||0;return{active:z,revenue:(N==null?void 0:N.toFixed(2))||"0.00",profit:(v==null?void 0:v.toFixed(2))||"0.00",margin:(ae==null?void 0:ae.toFixed(1))||"0.0",pending:he,drafts:be}})(r),L=r==null?void 0:r.filter(s=>{var _,z,N,v,ae;if((h==null?void 0:h.status)!=="All"){const he=(z=(_=h==null?void 0:h.status)==null?void 0:_.toLowerCase())==null?void 0:z.replace(" ","_");if((s==null?void 0:s.job_status)!==he)return!1}if(h!=null&&h.salesAssigned&&(s==null?void 0:s.assigned_to)!==(h==null?void 0:h.salesAssigned)||h!=null&&h.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(h==null?void 0:h.deliveryAssigned)||h!=null&&h.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(h==null?void 0:h.financeAssigned)||h!=null&&h.vendor&&(s==null?void 0:s.vendor_id)!==(h==null?void 0:h.vendor))return!1;if(Y!=null&&Y.trim()){const he=Y==null?void 0:Y.toLowerCase(),be=X=>(X==null?void 0:X.replace(/\D/g,""))||"",oe=be(he),te=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(N=s==null?void 0:s.vehicle)==null?void 0:N.make,(v=s==null?void 0:s.vehicle)==null?void 0:v.model,((ae=s==null?void 0:s.vehicle)==null?void 0:ae.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(te==null?void 0:te.some(X=>{var we;const ee=X==null?void 0:X.toLowerCase();return!!(ee!=null&&ee.includes(he)||(oe==null?void 0:oe.length)>=3&&((we=be(ee))!=null&&we.includes(oe)))})))return!1}return!0});$.useEffect(()=>{const s=setTimeout(()=>{xe(h==null?void 0:h.search)},300);return()=>clearTimeout(s)},[h==null?void 0:h.search]);const ne=(s,_)=>{var z,N;if(E(v=>({...v,[s]:_})),s==="status"){const v=new URLSearchParams(window.location.search);_==="All"?v==null||v.delete("status"):v==null||v.set("status",_==null?void 0:_.toLowerCase());const ae=`${(z=window.location)==null?void 0:z.pathname}${v!=null&&v.toString()?"?"+(v==null?void 0:v.toString()):""}`;(N=window.history)==null||N.replaceState({},"",ae)}},ge=()=>{var s,_;E({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),re(),(_=window.history)==null||_.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},fe=s=>{b(s),m(!0)},me=()=>{m(!1),b(null)};return l?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ie,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-slate-600",children:"Loading deals..."}),j&&e.jsx("div",{className:"text-sm text-slate-500 mt-2",children:"Loading dropdown data..."})]})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ie,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(D,{message:V||de,onClose:()=>{B("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(cs,{exportType:"jobs",filters:{status:h==null?void 0:h.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,_)=>console.log(`Export complete: ${s} records`),onExportError:s=>B(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(U,{onClick:()=>o(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(G,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(ms,{draftsCount:S==null?void 0:S.drafts,onViewDrafts:()=>ne("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(G,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:S==null?void 0:S.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(G,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",S==null?void 0:S.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(G,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",S==null?void 0:S.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(G,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[S==null?void 0:S.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(G,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:S==null?void 0:S.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(G,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:S==null?void 0:S.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>ne("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(h==null?void 0:h.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(G,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:h==null?void 0:h.search,onChange:s=>{var _;return ne("search",(_=s==null?void 0:s.target)==null?void 0:_.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(h==null?void 0:h.salesAssigned)||"",onChange:s=>{var _;return ne("salesAssigned",((_=s==null?void 0:s.target)==null?void 0:_.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:j,id:"sales-filter",children:[e.jsx("option",{value:"",children:"Sales Consultants"}),(je=ye())==null?void 0:je.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:$e(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(h==null?void 0:h.deliveryAssigned)||"",onChange:s=>{var _;return ne("deliveryAssigned",((_=s==null?void 0:s.target)==null?void 0:_.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:j,id:"delivery-filter",children:[e.jsx("option",{value:"",children:"Delivery Coordinator"}),(Ne=g())==null?void 0:Ne.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:$e(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(h==null?void 0:h.financeAssigned)||"",onChange:s=>{var _;return ne("financeAssigned",((_=s==null?void 0:s.target)==null?void 0:_.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:j,id:"finance-filter",children:[e.jsx("option",{value:"",children:"Finance Manager"}),(d=F())==null?void 0:d.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:$e(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[180px]",children:e.jsxs("select",{value:(h==null?void 0:h.vendor)||"",onChange:s=>{var _;return ne("vendor",((_=s==null?void 0:s.target)==null?void 0:_.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:j,id:"vendor-filter",children:[e.jsx("option",{value:"",children:"Vendors"}),(p=A({activeOnly:!0}))==null?void 0:p.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:s==null?void 0:s.name},s==null?void 0:s.id))]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(U,{variant:"ghost",size:"sm",onClick:R,className:"text-slate-600 hover:text-slate-800",disabled:j,"aria-label":"Refresh dropdown data",children:[e.jsx(G,{name:"RefreshCw",size:16,className:"mr-1"}),j?"Loading...":"Refresh"]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(U,{variant:"ghost",size:"sm",onClick:ge,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(G,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",L==null?void 0:L.length," of ",r==null?void 0:r.length," deals",((h==null?void 0:h.salesAssigned)||(h==null?void 0:h.deliveryAssigned)||(h==null?void 0:h.financeAssigned)||(h==null?void 0:h.vendor)||(h==null?void 0:h.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Next"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:L==null?void 0:L.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(ze,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Fe,{amount:s==null?void 0:s.total_amount})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Pe,{nextPromisedShort:s==null?void 0:s.next_promised_short})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(qe,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(U,{size:"sm",variant:"ghost",onClick:()=>fe(s==null?void 0:s.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(U,{size:"sm",variant:"ghost",onClick:()=>Q(s),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(U,{size:"sm",variant:"ghost",onClick:()=>K({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:ke(s)}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(U,{size:"sm",variant:"ghost",onClick:()=>f(s),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(L==null?void 0:L.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(h==null?void 0:h.status)==="All"?"No deals found":`No ${(M=h==null?void 0:h.status)==null?void 0:M.toLowerCase()} deals found`})}):L==null?void 0:L.map(s=>e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:ke(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:Ke(s)||"â€”"})]}),e.jsx(gs,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((s==null?void 0:s.customer_name)||(s==null?void 0:s.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(ze,{deal:s})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(Fe,{amount:s==null?void 0:s.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(Pe,{nextPromisedShort:s==null?void 0:s.next_promised_short})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(qe,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})]}),(s==null?void 0:s.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(bs,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(U,{size:"sm",variant:"outline",onClick:()=>fe(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(G,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(U,{size:"sm",variant:"outline",onClick:()=>f(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(G,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(U,{size:"sm",variant:"outline",onClick:()=>Q(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(G,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(U,{size:"sm",variant:"outline",onClick:()=>Q(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(G,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(U,{size:"sm",variant:"outline",onClick:()=>K({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:ke(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(G,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id))}),e.jsx(is,{isOpen:u,onClose:()=>o(!1),onSuccess:H}),e.jsx(xs,{isOpen:i,dealId:y,onClose:me,onSuccess:()=>{H(),me()}}),w&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(U,{variant:"outline",onClick:()=>f(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(U,{onClick:()=>a(w==null?void 0:w.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(fs,{isOpen:P,onClose:()=>{q(!1),se(null),B("")},deal:n,onSave:k,loading:x}),e.jsx(ps,{loaner:T,onClose:()=>{K(null),B("")},onConfirm:()=>O(T),loading:C})]})]})}export{Ts as default};
//# sourceMappingURL=index-ClcTNs7p.js.map
