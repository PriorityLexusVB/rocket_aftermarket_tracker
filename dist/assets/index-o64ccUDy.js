import{s as J,u as Ie,j as e,B as K,S as $e,I as Ae,g as Ke,a as Xe,b as He,c as We,d as Ge,p as Oe,e as es,f as ss,h as rs,i as ns,k as me}from"./index-0LgLyUGa.js";import{r as k,R as ls}from"./react-Czq5O75u.js";import{dealService as qe,mapDbDealToForm as Fe,getDeal as ts,updateDeal as as,deleteDeal as cs,markLoanerReturned as is,getAllDeals as os}from"./dealService-BLUCIZry.js";import{u as Ze}from"./useTenant-d2MifiB_.js";import{s as Le,t as ds}from"./options-CllavUpK.js";import{I as te}from"./Icon-DUn4qUsG.js";import{l as us}from"./vendorService-BtEer-i9.js";import{l as hs}from"./smsTemplateService-BQFYgpUs.js";import{N as Re}from"./Navbar-BiQ0sbs8.js";import{a as xs}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const gs=(r,u="")=>r==null?u:String(r),ke={async getOverdueJobs(){var r;try{const{data:u,error:l}=await((r=J)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return l?(console.error("Error fetching overdue jobs:",l),{data:[],error:{message:l==null?void 0:l.message}}):{data:u||[],error:null}}catch(u){return console.error("Error in getOverdueJobs service:",u),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,u,l,c;try{const{data:h,error:d}=await((c=(l=(u=(r=J)==null?void 0:r.from("sms_templates"))==null?void 0:u.select("*"))==null?void 0:l.eq("is_active",!0))==null?void 0:c.order("created_at",{ascending:!1}));return d?{data:[],error:{message:d==null?void 0:d.message}}:{data:h||[],error:null}}catch(h){return console.error("Error fetching SMS templates:",h),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var u,l,c,h,d,o,f,v;try{const y=await((l=(u=J)==null?void 0:u.auth)==null?void 0:l.getUser()),{data:j,error:p}=await((v=(f=(o=(c=J)==null?void 0:c.from("sms_templates"))==null?void 0:o.insert([{...r,created_by:(d=(h=y==null?void 0:y.data)==null?void 0:h.user)==null?void 0:d.id}]))==null?void 0:f.select())==null?void 0:v.single());return p?{data:null,error:{message:p==null?void 0:p.message}}:{data:j,error:null}}catch(y){return console.error("Error creating SMS template:",y),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,u){var l,c,h,d,o,f;try{const{data:v,error:y}=await((f=(o=(d=(h=(l=J)==null?void 0:l.from("sms_templates"))==null?void 0:h.update({...u,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:o.select())==null?void 0:f.single());return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:v,error:null}}catch(v){return console.error("Error updating SMS template:",v),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var u,l,c;try{const{error:h}=await((c=(l=(u=J)==null?void 0:u.from("sms_templates"))==null?void 0:l.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting SMS template:",h),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var u,l,c,h,d,o,f,v,y;try{const j=await((l=(u=J)==null?void 0:u.auth)==null?void 0:l.getUser()),{data:p,error:A}=await((y=(v=(d=(h=(c=J)==null?void 0:c.from("filter_presets"))==null?void 0:h.select("*"))==null?void 0:d.eq("page_type",r))==null?void 0:v.or(`user_id.eq.${(f=(o=j==null?void 0:j.data)==null?void 0:o.user)==null?void 0:f.id},is_public.eq.true`))==null?void 0:y.order("created_at",{ascending:!1}));return A?{data:[],error:{message:A==null?void 0:A.message}}:{data:p||[],error:null}}catch(j){return console.error("Error fetching filter presets:",j),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,u,l,c=!1){var h,d,o,f,v,y,j,p;try{const A=await((d=(h=J)==null?void 0:h.auth)==null?void 0:d.getUser()),{data:se,error:q}=await((p=(j=(y=(o=J)==null?void 0:o.from("filter_presets"))==null?void 0:y.insert([{user_id:(v=(f=A==null?void 0:A.data)==null?void 0:f.user)==null?void 0:v.id,page_type:r,name:u,filters:l,is_public:c}]))==null?void 0:j.select())==null?void 0:p.single());return q?{data:null,error:{message:q==null?void 0:q.message}}:{data:se,error:null}}catch(A){return console.error("Error saving filter preset:",A),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var u,l,c;try{const{error:h}=await((c=(l=(u=J)==null?void 0:u.from("filter_presets"))==null?void 0:l.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting filter preset:",h),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,u={},l="staff"){var c,h;try{const{data:d,error:o}=await((c=J)==null?void 0:c.rpc("generate_export_data",{export_type:r,filters:u,user_role:l}));return o?{data:null,error:{message:o==null?void 0:o.message}}:{data:(h=d||[])==null?void 0:h.map(v=>{var p;const y=(v==null?void 0:v.export_data)||v,j={};return(p=Object==null?void 0:Object.entries(y))==null||p.forEach(([A,se])=>{typeof se=="number"?j[A]=isNaN(se)?0:se:se==null?j[A]="":j[A]=se}),{export_data:j}}),error:null}}catch(d){return console.error("Error exporting data:",d),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,u,l=null){var c,h,d,o;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let f="";if(l)f+=(l==null?void 0:l.join(","))+`
`;else{const j=((c=r==null?void 0:r[0])==null?void 0:c.export_data)||(r==null?void 0:r[0]);j&&(f+=((h=Object==null?void 0:Object.keys(j))==null?void 0:h.join(","))+`
`)}r==null||r.forEach(j=>{var se;const p=(j==null?void 0:j.export_data)||j,A=(se=Object==null?void 0:Object.values(p))==null?void 0:se.map(q=>{if(q==null)return"";if(typeof q=="number"&&isNaN(q))return"0";let w=gs(q);return w!=null&&w.includes(",")||w!=null&&w.includes('"')?`"${w==null?void 0:w.replace(/"/g,'""')}"`:w});f+=(A==null?void 0:A.join(","))+`
`});const v=new Blob([f],{type:"text/csv;charset=utf-8;"}),y=document.createElement("a");if((y==null?void 0:y.download)!==void 0){const j=URL==null?void 0:URL.createObjectURL(v);y==null||y.setAttribute("href",j),y==null||y.setAttribute("download",u),y.style.visibility="hidden",(d=document.body)==null||d.appendChild(y),y==null||y.click(),(o=document.body)==null||o.removeChild(y),URL==null||URL.revokeObjectURL(j)}return{success:!0,error:null}}catch(f){return console.error("Export to CSV error:",f),{success:!1,error:{message:(f==null?void 0:f.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,u){var l,c,h,d,o;try{const f=await((c=(l=J)==null?void 0:l.auth)==null?void 0:c.getUser()),{data:v,error:y}=await((o=J)==null?void 0:o.rpc("bulk_update_jobs",{job_ids:r,updates:u,performed_by:(d=(h=f==null?void 0:f.data)==null?void 0:h.user)==null?void 0:d.id}));return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:(v==null?void 0:v[0])||null,error:null}}catch(f){return console.error("Error in bulk update jobs:",f),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,u,l,c,h,d,o;try{const f=await((u=(r=J)==null?void 0:r.auth)==null?void 0:u.getUser()),{data:v,error:y}=await((o=(c=(l=J)==null?void 0:l.from("notification_preferences"))==null?void 0:c.select("*"))==null?void 0:o.eq("user_id",(d=(h=f==null?void 0:f.data)==null?void 0:h.user)==null?void 0:d.id));return y?{data:[],error:{message:y==null?void 0:y.message}}:{data:v||[],error:null}}catch(f){return console.error("Error fetching notification preferences:",f),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var u,l,c,h,d,o,f,v,y,j;try{const p=await((l=(u=J)==null?void 0:u.auth)==null?void 0:l.getUser());await((f=(h=(c=J)==null?void 0:c.from("notification_preferences"))==null?void 0:h.delete())==null?void 0:f.eq("user_id",(o=(d=p==null?void 0:p.data)==null?void 0:d.user)==null?void 0:o.id));const A=r==null?void 0:r.map(w=>{var m,$;return{...w,user_id:($=(m=p==null?void 0:p.data)==null?void 0:m.user)==null?void 0:$.id}}),{data:se,error:q}=await((j=(y=(v=J)==null?void 0:v.from("notification_preferences"))==null?void 0:y.insert(A))==null?void 0:j.select());return q?{data:null,error:{message:q==null?void 0:q.message}}:{data:se,error:null}}catch(p){return console.error("Error updating notification preferences:",p),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var u,l,c;try{return(c=(l=(u=J)==null?void 0:u.channel("overdue-jobs"))==null?void 0:l.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},d=>{var o;(o=this.getOverdueJobs())==null||o.then(f=>{f!=null&&f.data&&r(f==null?void 0:f.data)})}))==null?void 0:c.subscribe()}catch(h){return console.error("Error subscribing to overdue jobs:",h),null}},async searchWithFilters(r,u,l){var c,h,d;try{let o=(c=J)==null?void 0:c.from(l);if(r)switch(l){case"jobs":o=o==null?void 0:o.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":o=o==null?void 0:o.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":o=o==null?void 0:o.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(h=Object==null?void 0:Object.entries(u))==null||h.forEach(([y,j])=>{j!=null&&j!==""&&(Array!=null&&Array.isArray(j)?o=o==null?void 0:o.in(y,j):typeof j=="object"&&(j==null?void 0:j.min)!==void 0?o=o==null?void 0:o.gte(y,j==null?void 0:j.min):typeof j=="object"&&(j==null?void 0:j.max)!==void 0?o=o==null?void 0:o.lte(y,j==null?void 0:j.max):o=o==null?void 0:o.eq(y,j))});const{data:f,error:v}=await((d=o==null?void 0:o.select("*"))==null?void 0:d.order("created_at",{ascending:!1}));return v?{data:[],error:{message:v==null?void 0:v.message}}:{data:f||[],error:null}}catch(o){return console.error("Error in search with filters:",o),{data:[],error:{message:"Failed to search with filters"}}}}},ms=({exportType:r,filters:u={},selectedIds:l=[],onExportStart:c,onExportComplete:h,onExportError:d,disabled:o=!1,variant:f="outline",size:v="sm",className:y=""})=>{var L;const[j,p]=k.useState(!1),[A,se]=k.useState(!1),[q,w]=k.useState("csv"),[m,$]=k.useState("filtered"),{user:a,userProfile:re}=Ie(),b=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],P=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(l==null?void 0:l.length)>0?[{value:"selected",label:`Selected (${l==null?void 0:l.length})`}]:[]],M=()=>{var W,ce,G;const V=(G=(ce=(W=new Date)==null?void 0:W.toISOString())==null?void 0:ce.split("T"))==null?void 0:G[0];return`${r}-${m==="selected"?"selected":m}-${V}.${q}`},z=async()=>{var V,ge,W,ce;if(!j)try{p(!0),c&&c();let G={...u};m==="selected"&&(l==null?void 0:l.length)>0&&(G.ids=l),m==="all"&&(G={});const x=await(ke==null?void 0:ke.exportData(r,G,(re==null?void 0:re.role)||"staff"));if(x!=null&&x.error)throw new Error((V=x==null?void 0:x.error)==null?void 0:V.message);if(!(x!=null&&x.data)||((ge=x==null?void 0:x.data)==null?void 0:ge.length)===0)throw new Error("No data found to export");const ue=M(),R=await(ke==null?void 0:ke.exportToCSV(x==null?void 0:x.data,ue));if(R!=null&&R.error)throw new Error((W=R==null?void 0:R.error)==null?void 0:W.message);se(!1),h&&h((ce=x==null?void 0:x.data)==null?void 0:ce.length,ue)}catch(G){console.error("Export error:",G),d&&d((G==null?void 0:G.message)||"Export failed")}finally{p(!1)}},_=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(K,{variant:f,size:v,onClick:()=>se(!A),disabled:o||j,iconName:j?void 0:"Download",iconPosition:"left",className:`${y} ${j?"cursor-wait":""}`,"aria-label":`Export ${_()}`,children:j?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${_()}`}),A&&!j&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx($e,{value:q,onChange:w,options:b,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx($e,{value:m,onChange:$,options:P,className:"w-full"})]}),m==="filtered"&&((L=Object==null?void 0:Object.keys(u))==null?void 0:L.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Ae,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),m==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Ae,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",l==null?void 0:l.length," selected record",(l==null?void 0:l.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(K,{variant:"ghost",size:"sm",onClick:()=>se(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(K,{size:"sm",onClick:z,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${_()}`,children:"Export"})]})]})})]})},Be={async getVehicles(r={},u=null){var l,c,h,d;try{let o=(h=(c=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:h.order("created_at",{ascending:!1});return u&&(o=o==null?void 0:o.eq("org_id",u)),r!=null&&r.status&&(o=o==null?void 0:o.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(o=o==null?void 0:o.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(o=o==null?void 0:o.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(o=o==null?void 0:o.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await Le(o,"vehicles:getVehicles")||[],error:null}}catch(o){return(d=o==null?void 0:o.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,u=null){var l,c,h,d,o;try{let f=(d=(h=(c=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:h.eq("id",r))==null?void 0:d.single();return u&&(f=f==null?void 0:f.eq("org_id",u)),{data:await Le(f,"vehicles:getVehicleById"),error:null}}catch(f){return(o=f==null?void 0:f.message)!=null&&o.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var u,l,c,h,d,o,f,v,y,j;try{const{data:p,error:A}=await((y=(v=(f=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:f.insert([{...r,created_by:(o=(d=(h=await((c=(l=J)==null?void 0:l.auth)==null?void 0:c.getUser()))==null?void 0:h.data)==null?void 0:d.user)==null?void 0:o.id}]))==null?void 0:v.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:y.single());return A?{data:null,error:{message:A==null?void 0:A.message}}:{data:p,error:null}}catch(p){return(j=p==null?void 0:p.message)!=null&&j.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var u,l,c,h;try{const{data:d,error:o}=await((h=(c=(l=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:l.insert([r]))==null?void 0:c.select())==null?void 0:h.single());if(o)throw console.error("Vehicle creation error:",o),new Error(o.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",d),d}catch(d){throw console.error("Error in vehicleService.create:",d),d}},async createVehicleWithProducts(r){var u,l;try{console.log("Creating vehicle with products:",r);const c=`vehicle_${Date.now()}`;await new Promise(d=>setTimeout(d,1e3));const h={id:c,...r,created_at:(u=new Date)==null?void 0:u.toISOString(),initial_products_count:((l=r==null?void 0:r.initial_products)==null?void 0:l.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",h),h}catch(c){throw console.error("Error creating vehicle with products:",c),c}},async checkStockNumberExists(r){var u,l,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:o}=await((h=(c=(l=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:c.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return o?(console.error("Stock number check error:",o),!1):!!d}catch(d){return console.error("Error checking stock number:",d),!1}},async checkVinExists(r){var u,l,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:o}=await((h=(c=(l=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:c.eq("vin",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return o?(console.error("VIN check error:",o),!1):!!d}catch(d){return console.error("Error checking VIN:",d),!1}},async updateVehicle(r,u){var l,c,h,d,o,f,v;try{const{data:y,error:j}=await((f=(o=(d=(h=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:h.update({...u,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:f.single());return j?{data:null,error:{message:j==null?void 0:j.message}}:{data:y,error:null}}catch(y){return(v=y==null?void 0:y.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var u,l,c,h;try{const{error:d}=await((c=(l=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:l.delete())==null?void 0:c.eq("id",r));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return(h=d==null?void 0:d.message)!=null&&h.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var u,l,c,h,d,o,f;try{let v=(l=(u=J)==null?void 0:u.from("vehicles"))==null?void 0:l.select("vehicle_status");r&&(v=v==null?void 0:v.eq("org_id",r));const y=await Le(v,"vehicles:getVehicleStats");return{data:{total:(y==null?void 0:y.length)||0,active:((c=y==null?void 0:y.filter(p=>(p==null?void 0:p.vehicle_status)==="active"))==null?void 0:c.length)||0,maintenance:((h=y==null?void 0:y.filter(p=>(p==null?void 0:p.vehicle_status)==="maintenance"))==null?void 0:h.length)||0,retired:((d=y==null?void 0:y.filter(p=>(p==null?void 0:p.vehicle_status)==="retired"))==null?void 0:d.length)||0,sold:((o=y==null?void 0:y.filter(p=>(p==null?void 0:p.vehicle_status)==="sold"))==null?void 0:o.length)||0},error:null}}catch(v){return(f=v==null?void 0:v.message)!=null&&f.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function bs({isOpen:r,onClose:u,onSuccess:l}){var g,I,D;const{user:c}=Ie(),{orgId:h}=Ze()||{},[d,o]=k.useState(1),[f,v]=k.useState(!1),[y,j]=k.useState(""),[p,A]=k.useState(!1),[se,q]=k.useState(!1),[w,m]=k.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),$={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(g=new Date)==null?void 0:g.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[a,re]=k.useState($),[b,P]=k.useState([]),M=async(t=0)=>{var N,C;try{m(s=>({...s,loading:!0,error:null,retryCount:t}));const[ne,le,F,Q,E]=await Promise.all([Ke().catch(()=>[]),Xe().catch(()=>[]),He().catch(()=>[]),We({activeOnly:!0}).catch(()=>[]),Ge({activeOnly:!0}).catch(()=>[])]);m({salesConsultants:ne,deliveryCoordinators:le,financeManagers:F,vendors:Q,products:E==null?void 0:E.map(s=>({...s,unitPrice:s==null?void 0:s.unit_price})),loading:!1,error:null,retryCount:t})}catch(ne){if(console.error("Failed to load dropdown data:",ne),t<2&&((N=ne==null?void 0:ne.message)!=null&&N.includes("fetch")||(C=ne==null?void 0:ne.message)!=null&&C.includes("network"))){setTimeout(()=>M(t+1),1e3*(t+1));return}m(le=>({...le,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:t}))}},z=({checked:t,onChange:N})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!t,onChange:C=>{var le;const ne=!!((le=C==null?void 0:C.target)!=null&&le.checked);N(ne)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),_=({label:t,options:N,value:C,onChange:ne,placeholder:le,required:F=!1,helpText:Q,testId:E})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[t," ",F&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:C||"",onChange:s=>{var T;return ne(((T=s==null?void 0:s.target)==null?void 0:T.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:w==null?void 0:w.loading,required:F,"data-testid":E,children:[e.jsx("option",{value:"",children:le}),N==null?void 0:N.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:(s==null?void 0:s.full_name)||(s==null?void 0:s.label)||(s==null?void 0:s.name)},s==null?void 0:s.id))]}),Q&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:Q}),(N==null?void 0:N.length)===0&&!(w!=null&&w.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-red-500",children:["No ",t==null?void 0:t.toLowerCase()," found. Please check your database connection."]})]});k.useEffect(()=>{const t=(a==null?void 0:a.customerName)!==($==null?void 0:$.customerName)||(a==null?void 0:a.customerPhone)!==($==null?void 0:$.customerPhone)||(a==null?void 0:a.customerEmail)!==($==null?void 0:$.customerEmail)||(a==null?void 0:a.needsLoaner)!==($==null?void 0:$.needsLoaner)||(a==null?void 0:a.assignedTo)!==($==null?void 0:$.assignedTo)||(a==null?void 0:a.deliveryCoordinator)!==($==null?void 0:$.deliveryCoordinator)||(a==null?void 0:a.financeManager)!==($==null?void 0:$.financeManager)||(b==null?void 0:b.length)>0;A(t)},[a,b]),k.useEffect(()=>{r&&M()},[r]);const L=()=>{P(t=>[...t,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},V=(t,N,C)=>{var ne;if(P(le=>le==null?void 0:le.map(F=>{if((F==null?void 0:F.id)===t){let Q={...F,[N]:C};return N==="requiresScheduling"&&(C===!0?Q.noScheduleReason="":Q.promisedDate=""),Q}return F})),N==="productId"&&C){const le=(ne=w==null?void 0:w.products)==null?void 0:ne.find(F=>(F==null?void 0:F.id)===C);le&&P(F=>F==null?void 0:F.map(Q=>(Q==null?void 0:Q.id)===t?{...Q,unitPrice:(le==null?void 0:le.unitPrice)||""}:Q))}},ge=t=>{P(N=>N==null?void 0:N.filter(C=>(C==null?void 0:C.id)!==t))},W=()=>{var t,N;return((N=(t=a==null?void 0:a.customerName)==null?void 0:t.trim())==null?void 0:N.length)>0},ce=()=>(b==null?void 0:b.length)===0?!1:b==null?void 0:b.every(t=>{var N;return!(!(t!=null&&t.productId)||!(t!=null&&t.unitPrice)||t!=null&&t.requiresScheduling&&!(t!=null&&t.promisedDate)||!(t!=null&&t.requiresScheduling)&&!((N=t==null?void 0:t.noScheduleReason)!=null&&N.trim())||(t==null?void 0:t.serviceType)==="vendor"&&!(t!=null&&t.vendorId))}),G=()=>b==null?void 0:b.reduce((t,N)=>t+(parseFloat(N==null?void 0:N.unitPrice)||0),0),x=async()=>{var t,N,C,ne,le,F,Q,E,s,T;if(!W()){j("Customer name is required to save draft");return}v(!0),j("");try{const U={year:(a==null?void 0:a.vehicleYear)||((t=new Date)==null?void 0:t.getFullYear()),make:(a==null?void 0:a.vehicleMake)||"TBD",model:(a==null?void 0:a.vehicleModel)||"TBD",owner_name:(N=a==null?void 0:a.customerName)==null?void 0:N.trim(),owner_phone:((C=a==null?void 0:a.customerPhone)==null?void 0:C.trim())||null,owner_email:((ne=a==null?void 0:a.customerEmail)==null?void 0:ne.trim())||null,stock_number:((le=a==null?void 0:a.stockNumber)==null?void 0:le.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},B=await Be.create(U),X={title:`Draft Deal - ${(F=a==null?void 0:a.customerName)==null?void 0:F.trim()}`,description:`Draft deal for ${(Q=a==null?void 0:a.customerName)==null?void 0:Q.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:B==null?void 0:B.id,assigned_to:(a==null?void 0:a.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(a==null?void 0:a.deliveryCoordinator)||null,finance_manager_id:(a==null?void 0:a.financeManager)||null,customer_needs_loaner:!!(a!=null&&a.needsLoaner),customerName:(E=a==null?void 0:a.customerName)==null?void 0:E.trim(),customerPhone:((s=a==null?void 0:a.customerPhone)==null?void 0:s.trim())||"",customerEmail:((T=a==null?void 0:a.customerEmail)==null?void 0:T.trim())||"",org_id:h||void 0,lineItems:[]};await qe.createDeal(X),l==null||l(),R(),u()}catch(U){j(`Failed to save draft: ${U==null?void 0:U.message}`)}finally{v(!1)}},ue=async()=>{var t,N,C,ne,le,F,Q,E,s,T,U,B;if(!W()||!ce()){j("Please complete all required fields");return}v(!0),j("");try{const X={year:(a==null?void 0:a.vehicleYear)||((t=new Date)==null?void 0:t.getFullYear()),make:(a==null?void 0:a.vehicleMake)||"TBD",model:(a==null?void 0:a.vehicleModel)||"TBD",owner_name:(N=a==null?void 0:a.customerName)==null?void 0:N.trim(),owner_phone:((C=a==null?void 0:a.customerPhone)==null?void 0:C.trim())||null,owner_email:((ne=a==null?void 0:a.customerEmail)==null?void 0:ne.trim())||null,stock_number:((le=a==null?void 0:a.stockNumber)==null?void 0:le.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},he=await Be.create(X),be=G(),xe=(b==null?void 0:b.some(n=>(n==null?void 0:n.serviceType)==="vendor"))?"vendor":"in_house",fe=((F=b==null?void 0:b.find(n=>n==null?void 0:n.vendorId))==null?void 0:F.vendorId)||null;let pe=null;if(xe==="vendor"){const n=(b||[]).filter(S=>(S==null?void 0:S.serviceType)==="vendor"&&(S==null?void 0:S.requiresScheduling)&&(S==null?void 0:S.promisedDate)).map(S=>new Date(S==null?void 0:S.promisedDate)).sort((S,O)=>S-O);pe=(Q=(n==null?void 0:n[0])||new Date)==null?void 0:Q.toISOString()}const Z=(b||[]).map(n=>({product_id:n==null?void 0:n.productId,quantity_used:1,unit_price:parseFloat((n==null?void 0:n.unitPrice)||0),promised_date:n!=null&&n.requiresScheduling?n==null?void 0:n.promisedDate:null,requires_scheduling:!!(n!=null&&n.requiresScheduling),no_schedule_reason:n!=null&&n.requiresScheduling?null:n==null?void 0:n.noScheduleReason,is_off_site:(n==null?void 0:n.serviceType)==="vendor"})),ae={title:`Deal - ${(E=a==null?void 0:a.customerName)==null?void 0:E.trim()}`,description:`Deal for ${(s=a==null?void 0:a.customerName)==null?void 0:s.trim()}`,job_status:"pending",service_type:xe,vehicle_id:he==null?void 0:he.id,vendor_id:fe,assigned_to:(a==null?void 0:a.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(a==null?void 0:a.deliveryCoordinator)||null,finance_manager_id:(a==null?void 0:a.financeManager)||null,customer_needs_loaner:!!(a!=null&&a.needsLoaner),scheduled_start_time:pe,estimated_cost:be,org_id:h||void 0,customerName:(T=a==null?void 0:a.customerName)==null?void 0:T.trim(),customerPhone:((U=a==null?void 0:a.customerPhone)==null?void 0:U.trim())||"",customerEmail:((B=a==null?void 0:a.customerEmail)==null?void 0:B.trim())||"",lineItems:Z},i=await qe.createDeal(ae);await qe.updateDeal(i==null?void 0:i.id,ae),l==null||l(),R(),u()}catch(X){j(`Failed to create deal: ${X==null?void 0:X.message}`)}finally{v(!1)}},R=()=>{o(1),re($),P([]),j(""),A(!1)},Ne=()=>{p?q(!0):(R(),u())},Se=()=>{q(!1),R(),u()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:Ne,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(te,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${d>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${d>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[y&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",y]}),e.jsx("button",{onClick:()=>j(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(te,{name:"X",size:16})})]})}),(w==null?void 0:w.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",w==null?void 0:w.error]}),e.jsx("button",{onClick:()=>M(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),d===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a==null?void 0:a.customerName,onChange:t=>re(N=>{var C;return{...N,customerName:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:a==null?void 0:a.customerPhone,onChange:t=>re(N=>{var C;return{...N,customerPhone:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:a==null?void 0:a.customerEmail,onChange:t=>re(N=>{var C;return{...N,customerEmail:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(a==null?void 0:a.vehicleYear)||"",onChange:t=>re(N=>{var C;return{...N,vehicleYear:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((I=new Date)==null?void 0:I.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.vehicleMake)||"",onChange:t=>re(N=>{var C;return{...N,vehicleMake:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.vehicleModel)||"",onChange:t=>re(N=>{var C;return{...N,vehicleModel:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.stockNumber)||"",onChange:t=>re(N=>{var C;return{...N,stockNumber:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(z,{checked:a==null?void 0:a.needsLoaner,onChange:t=>{re(N=>({...N,needsLoaner:!!t}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(_,{label:"Sales Consultant",options:w==null?void 0:w.salesConsultants,value:a==null?void 0:a.assignedTo,onChange:t=>re(N=>({...N,assignedTo:t})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(_,{label:"Delivery Coordinator",options:w==null?void 0:w.deliveryCoordinators,value:a==null?void 0:a.deliveryCoordinator,onChange:t=>re(N=>({...N,deliveryCoordinator:t})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(_,{label:"Finance Manager",options:w==null?void 0:w.financeManagers,value:a==null?void 0:a.financeManager,onChange:t=>re(N=>({...N,financeManager:t})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),d===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(K,{onClick:L,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(te,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(b==null?void 0:b.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(te,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[b==null?void 0:b.map((t,N)=>{var C,ne,le,F,Q;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",N+1]}),e.jsx("button",{onClick:()=>ge(t==null?void 0:t.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(te,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(t==null?void 0:t.productId)||"",onChange:E=>{var s;return V(t==null?void 0:t.id,"productId",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${N}`,children:[e.jsx("option",{value:"",children:"Select product"}),(C=w==null?void 0:w.products)==null?void 0:C.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:t==null?void 0:t.unitPrice,onChange:E=>{var s;return V(t==null?void 0:t.id,"unitPrice",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${N}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${t==null?void 0:t.id}`,value:"in_house",checked:(t==null?void 0:t.serviceType)==="in_house",onChange:E=>{var s;return V(t==null?void 0:t.id,"serviceType",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"mr-2 cursor-pointer"}),"🏠 On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${t==null?void 0:t.id}`,value:"vendor",checked:(t==null?void 0:t.serviceType)==="vendor",onChange:E=>{var s;return V(t==null?void 0:t.id,"serviceType",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"mr-2 cursor-pointer"}),"🏢 Off-Site (Vendor)"]})]})]}),(t==null?void 0:t.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(t==null?void 0:t.vendorId)||"",onChange:E=>{var s;return V(t==null?void 0:t.id,"vendorId",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(ne=w==null?void 0:w.vendors)==null?void 0:ne.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${N}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${t==null?void 0:t.id}`,checked:(t==null?void 0:t.requiresScheduling)===!0,onChange:()=>V(t==null?void 0:t.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${N}`,"data-testid":`requires-scheduling-${N}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${N}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${t==null?void 0:t.id}`,checked:(t==null?void 0:t.requiresScheduling)===!1,onChange:()=>V(t==null?void 0:t.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${N}`}),"No Scheduling Needed"]})]}),t!=null&&t.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:t==null?void 0:t.promisedDate,onChange:E=>{var s;return V(t==null?void 0:t.id,"promisedDate",(s=E==null?void 0:E.target)==null?void 0:s.value)},min:(Q=(F=(le=new Date)==null?void 0:le.toISOString())==null?void 0:F.split("T"))==null?void 0:Q[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t==null?void 0:t.noScheduleReason,onChange:E=>{var s;return V(t==null?void 0:t.id,"noScheduleReason",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:t==null?void 0:t.serviceNotes,onChange:E=>{var s;return V(t==null?void 0:t.id,"serviceNotes",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},t==null?void 0:t.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(D=G())==null?void 0:D.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[b==null?void 0:b.length," item",(b==null?void 0:b.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:d===2&&e.jsx(K,{onClick:()=>o(1),variant:"outline",className:"w-full md:w-auto h-11",children:"← Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(K,{onClick:Ne,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),d===1&&e.jsxs(e.Fragment,{children:[e.jsx(K,{onClick:x,disabled:!W()||f,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:f?"Saving...":"Save Draft"}),e.jsx(K,{onClick:()=>o(2),disabled:!W(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items →"})]}),d===2&&e.jsx(K,{onClick:ue,disabled:!W()||!ce()||f,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:f?"Creating...":"Create Deal"})]})]})}),se&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{variant:"outline",onClick:()=>q(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(K,{onClick:Se,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function fs(r,{activeOnly:u=!0}={}){let l=J.from("products").select("*").order("name",{ascending:!0});u&&(l=l.eq("is_active",!0)),r&&(l=l.or(`org_id.eq.${r},org_id.is.null`));const c=await Le(l,"products:listByOrg");return ds(c,{labelKey:"name",valueKey:"id"})}function ps(r,{activeOnly:u=!0}={}){let l=J.from("user_profiles").select("*").order("full_name",{ascending:!0});return u&&(l=l.eq("is_active",!0)),r&&(l=l.eq("org_id",r)),Le(l,"staff:listByOrg")}function Qe(r={}){var m,$,a,re;const{loadOnMount:u=!0,cacheTime:l=5*60*1e3}=r,[c,h]=k.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[d,o]=k.useState(null),f=Ze(),v=Ie(),y=async()=>{var b,P,M,z;try{if(f.loading)return;if(h(R=>({...R,loading:!0,error:null})),!((b=f.session)!=null&&b.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),h(R=>({...R,loading:!1}));return}const _=!!f.orgId,L=[(P=Xe())==null?void 0:P.catch(R=>(console.error("[dropdowns:dc] Delivery coordinators failed:",R),[])),(M=Ke())==null?void 0:M.catch(R=>(console.error("[dropdowns:sales] Sales consultants failed:",R),[])),(z=He())==null?void 0:z.catch(R=>(console.error("[dropdowns:finance] Finance managers failed:",R),[])),_?ps(f.orgId).catch(R=>(console.error("[dropdowns:users] tenant staff failed:",R),[])):rs({activeOnly:!0}).catch(R=>(console.error("[dropdowns:users] global user profiles failed:",R),[])),_?us(f.orgId).catch(R=>(console.error("[dropdowns:vendors] tenant vendors failed:",R),[])):We({activeOnly:!0}).catch(R=>(console.error("[dropdowns:vendors] global vendors failed:",R),[])),_?fs(f.orgId).catch(R=>(console.error("[dropdowns:products] tenant products failed:",R),[])):Ge({activeOnly:!0}).catch(R=>(console.error("[dropdowns:products] global products failed:",R),[])),_?hs(f.orgId).catch(R=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",R),[])):Promise.resolve([])],[V,ge,W,ce,G,x,ue]=await Promise.all(L);h({dc:V,sales:ge,finance:W,users:ce,vendors:G,products:x,smsTemplates:ue,loading:!1,error:null,searchResults:null}),o(Date.now())}catch(_){h({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(_==null?void 0:_.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",_)}};k.useEffect(()=>{try{const b=Oe({departments:["Sales","Sales Consultant","Sales Consultants"]}),P=Oe({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),M=Oe({departments:["Finance","Finance Manager","Finance Managers"]}),z=es({activeOnly:!0}),_=ss({activeOnly:!0});[b==null?void 0:b.length,P==null?void 0:P.length,M==null?void 0:M.length,z==null?void 0:z.length,_==null?void 0:_.length].some(Boolean)&&h(V=>({...V,sales:b||V.sales,dc:P||V.dc,finance:M||V.finance,vendors:z||V.vendors,products:_||V.products,loading:!1,error:null}))}catch(b){console.info("[dropdowns] cached-first hydrate skipped:",b==null?void 0:b.message)}},[]);const j=()=>d?Date.now()-d<l:!1,p=async()=>{j()||await y()},A=async b=>{try{if(!(b!=null&&b.trim())){h(M=>({...M,searchResults:null}));return}const P=await ns(b);h(M=>({...M,searchResults:P}))}catch(P){console.error("[dropdowns:search] Search failed:",P),h(M=>({...M,searchResults:{users:[],vendors:[]}}))}},se=()=>{h(b=>({...b,searchResults:null}))},q=(b={})=>{const{roles:P=[],departments:M=[],activeOnly:z=!0}=b;let _=(c==null?void 0:c.users)||[];return z&&(_=_==null?void 0:_.filter(L=>L==null?void 0:L.is_active)),(P==null?void 0:P.length)>0&&(_=_==null?void 0:_.filter(L=>P==null?void 0:P.includes(L==null?void 0:L.role))),(M==null?void 0:M.length)>0&&(_=_==null?void 0:_.filter(L=>M==null?void 0:M.includes(L==null?void 0:L.department))),(_==null?void 0:_.map(L=>({id:L==null?void 0:L.id,value:L==null?void 0:L.id,label:L==null?void 0:L.full_name,name:L==null?void 0:L.full_name,role:L==null?void 0:L.role,department:L==null?void 0:L.department,email:L==null?void 0:L.email})))||[]},w=(b={})=>{const{activeOnly:P=!0,specialty:M=null}=b;let z=(c==null?void 0:c.vendors)||[];return P&&(z=z==null?void 0:z.filter(_=>_==null?void 0:_.is_active)),M&&(z=z==null?void 0:z.filter(_=>{var L,V;return(V=(L=_==null?void 0:_.specialty)==null?void 0:L.toLowerCase())==null?void 0:V.includes(M==null?void 0:M.toLowerCase())})),(z==null?void 0:z.map(_=>({id:_==null?void 0:_.id,value:(_==null?void 0:_.value)||(_==null?void 0:_.id),label:(_==null?void 0:_.label)||(_==null?void 0:_.name),name:_==null?void 0:_.name,specialty:_==null?void 0:_.specialty,email:_==null?void 0:_.email,phone:_==null?void 0:_.phone})))||[]};return k.useEffect(()=>{let b=!0;return(async()=>{var M;if(!u)return;const P=Date.now();for(;b&&(v!=null&&v.loading)&&Date.now()-P<5e3;)await new Promise(z=>setTimeout(z,200));b&&(v!=null&&v.user?(console.log("Dropdowns: authenticated user",(M=v==null?void 0:v.user)==null?void 0:M.id),v!=null&&v.userProfile&&console.log("Dropdowns: user profile org",v.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),b&&await y())})(),()=>{b=!1}},[u,v==null?void 0:v.loading,(m=v==null?void 0:v.user)==null?void 0:m.id,f==null?void 0:f.loading,f==null?void 0:f.orgId]),{dc:c==null?void 0:c.dc,sales:c==null?void 0:c.sales,finance:c==null?void 0:c.finance,users:c==null?void 0:c.users,vendors:c==null?void 0:c.vendors,products:c==null?void 0:c.products,smsTemplates:c==null?void 0:c.smsTemplates,loading:c==null?void 0:c.loading,error:c==null?void 0:c.error,searchResults:c==null?void 0:c.searchResults,globalSearch:A,clearSearch:se,getUserOptions:q,getVendorOptions:w,refresh:y,refreshIfNeeded:p,lastUpdate:d,isCacheValid:j(),salesConsultantOptions:($=(c==null?void 0:c.sales)||[])==null?void 0:$.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),deliveryCoordinatorOptions:(a=(c==null?void 0:c.dc)||[])==null?void 0:a.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),financeManagerOptions:(re=(c==null?void 0:c.finance)||[])==null?void 0:re.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name}))}}const js=()=>{var v,y,j;const{dc:r,sales:u,finance:l,vendors:c,products:h,loading:d,error:o,refresh:f}=Qe({loadOnMount:!0});return{salesConsultants:u,deliveryCoordinators:r,financeManagers:l,vendors:c,products:h,loading:d,error:o,refresh:f,salesConsultantOptions:(v=u||[])==null?void 0:v.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),deliveryCoordinatorOptions:(y=r||[])==null?void 0:y.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),financeManagerOptions:(j=l||[])==null?void 0:j.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),vendorOptions:c||[],productOptions:h||[]}},vs=()=>(ls.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Te=({options:r=[],value:u,onChange:l,placeholder:c="Select...",searchable:h=!1,clearable:d=!1,disabled:o=!1,loading:f=!1,error:v=null,className:y="",optionLabel:j="label",optionValue:p="value",groupBy:A=null,renderOption:se=null,label:q="",helperText:w=""})=>{const[m,$]=k.useState(!1),[a,re]=k.useState(""),[b,P]=k.useState(!1),[M,z]=k.useState(r),[_,L]=k.useState(-1),[V,ge]=k.useState({top:0,left:0,width:0}),W=k.useRef(null),ce=k.useRef(null);k.useRef(null),k.useEffect(()=>{P((()=>{var t;return(t=window.matchMedia("(max-width: 767px)"))==null?void 0:t.matches})());const I=window.matchMedia("(max-width: 767px)"),D=()=>P(I==null?void 0:I.matches);return I==null||I.addEventListener("change",D),()=>I==null?void 0:I.removeEventListener("change",D)},[]),k.useEffect(()=>{if(!(a!=null&&a.trim())){z(r);return}const g=a==null?void 0:a.toLowerCase(),I=r==null?void 0:r.filter(D=>{const t=[D==null?void 0:D.name,D==null?void 0:D.displayName,D==null?void 0:D.category,D==null?void 0:D.brand,D==null?void 0:D.specialty,D==null?void 0:D.department,D==null?void 0:D.email].filter(Boolean);return t==null?void 0:t.some(N=>{var C;return(C=N==null?void 0:N.toLowerCase())==null?void 0:C.includes(g)})});z(I),L(-1)},[a,r]);const G=r==null?void 0:r.find(g=>(g==null?void 0:g.id)===u),x=g=>((g==null?void 0:g[p])||(g==null?void 0:g.id))===u,ue=()=>{var g;if(W!=null&&W.current){const I=(g=W==null?void 0:W.current)==null?void 0:g.getBoundingClientRect();ge({top:(I==null?void 0:I.bottom)+window.scrollY,left:(I==null?void 0:I.left)+window.scrollX,width:I==null?void 0:I.width})}};k.useEffect(()=>{m&&!b&&ue()},[m,b]),k.useEffect(()=>{if(b)return;const g=I=>{var D;W!=null&&W.current&&!((D=W==null?void 0:W.current)!=null&&D.contains(I==null?void 0:I.target))&&($(!1),re(""),L(-1))};return document==null||document.addEventListener("mousedown",g),()=>document==null?void 0:document.removeEventListener("mousedown",g)},[b]);const R=g=>{if(!b){if(!m){((g==null?void 0:g.key)==="Enter"||(g==null?void 0:g.key)===" "||(g==null?void 0:g.key)==="ArrowDown")&&(g==null||g.preventDefault(),$(!0),h&&setTimeout(()=>{var I;return(I=ce==null?void 0:ce.current)==null?void 0:I.focus()},0));return}switch(g==null?void 0:g.key){case"Escape":$(!1),re(""),L(-1);break;case"ArrowDown":g==null||g.preventDefault(),L(I=>I<(M==null?void 0:M.length)-1?I+1:0);break;case"ArrowUp":g==null||g.preventDefault(),L(I=>I>0?I-1:(M==null?void 0:M.length)-1);break;case"Enter":g==null||g.preventDefault(),_>=0&&(M!=null&&M[_])&&Ne(M==null?void 0:M[_]);break;case"Tab":$(!1),re(""),L(-1);break}}},Ne=g=>{l==null||l(g==null?void 0:g.id),$(!1),re(""),L(-1)},Se=g=>{g==null||g.stopPropagation(),l==null||l(null)};return b?e.jsxs("div",{className:`relative ${y}`,children:[e.jsxs("select",{value:u||"",onChange:g=>{var I;return l==null?void 0:l(((I=g==null?void 0:g.target)==null?void 0:I.value)||null)},disabled:o||f,className:`
            w-full px-3 py-2 border rounded-lg
            ${v?"border-red-500":"border-gray-300"}
            ${o||f?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:c}),r==null?void 0:r.map(g=>e.jsx("option",{value:(g==null?void 0:g[p])||(g==null?void 0:g.id),children:(g==null?void 0:g[j])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[p])||(g==null?void 0:g.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(te,{name:"ChevronDown",size:16,className:"text-gray-400"})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]}):e.jsxs("div",{className:`relative ${y}`,ref:W,children:[e.jsxs("button",{type:"button",onClick:()=>!o&&!f&&$(!m),onKeyDown:R,disabled:o||f,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${v?"border-red-500":"border-gray-300"}
          ${o||f?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${m?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:G?"text-gray-900":"text-gray-500",children:G?(G==null?void 0:G[j])||(G==null?void 0:G.label):c}),e.jsxs("div",{className:"flex items-center space-x-1",children:[f&&e.jsx(te,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),d&&G&&!f&&e.jsx("button",{type:"button",onClick:Se,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(te,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(te,{name:m?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),m&&typeof window<"u"&&e.jsx(vs,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>$(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${V==null?void 0:V.top}px`,left:`${V==null?void 0:V.left}px`,width:`${V==null?void 0:V.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:g=>g==null?void 0:g.stopPropagation(),children:[h&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:a,onChange:g=>{var I;return re((I=g==null?void 0:g.target)==null?void 0:I.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(M==null?void 0:M.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:a?"No results found":"No options available"}):M==null?void 0:M.map(g=>e.jsx("button",{type:"button",onClick:()=>Ne(g),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${x(g)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(g==null?void 0:g[j])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[p])||(g==null?void 0:g.id)))})]})})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]})},ys=({isOpen:r,dealId:u,deal:l,onClose:c,onSuccess:h})=>{var be,ve,xe,fe,pe,Z,ae;const[d,o]=k.useState(!0),[f,v]=k.useState(!1),[y,j]=k.useState(""),[p,A]=k.useState(!1),[se,q]=k.useState(!1),[w,m]=k.useState(!1),[$,a]=k.useState(!1),[re,b]=k.useState(null),[P,M]=k.useState(null),[z,_]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:L,deliveryCoordinatorOptions:V,financeManagerOptions:ge,vendorOptions:W,productOptions:ce,refresh:G}=js(),[x,ue]=k.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),R=(i=[],n,S="Selected")=>!n||Array.isArray(i)&&i.some(O=>(O==null?void 0:O.id)===n)?i:[...i||[],{id:n,value:n,label:S}],Ne=k.useMemo(()=>R(W,x==null?void 0:x.vendor_id,"Selected vendor"),[W,x==null?void 0:x.vendor_id]),Se=k.useMemo(()=>R(L,x==null?void 0:x.assignedTo,"Selected user"),[L,x==null?void 0:x.assignedTo]),g=k.useMemo(()=>R(V,x==null?void 0:x.deliveryCoordinator,"Selected user"),[V,x==null?void 0:x.deliveryCoordinator]),I=k.useMemo(()=>R(ge,x==null?void 0:x.financeManager,"Selected user"),[ge,x==null?void 0:x.financeManager]);k.useEffect(()=>{if(re){const i=JSON.stringify(x)!==JSON.stringify(re);m(i)}},[x,re]),k.useEffect(()=>{if(r)try{G==null||G()}catch{}},[r,G]),k.useEffect(()=>{var i;if(r)if(l&&(l!=null&&l.id))try{const n=Fe(l),S={...n,assignedTo:(n==null?void 0:n.assigned_to)||null,deliveryCoordinator:(n==null?void 0:n.delivery_coordinator_id)||null,financeManager:(n==null?void 0:n.finance_manager_id)||null,vendor_id:(n==null?void 0:n.vendor_id)||null,customerName:(l==null?void 0:l.customer_name)||"",customerPhone:(l==null?void 0:l.customer_phone)||"",customerEmail:(l==null?void 0:l.customer_email)||"",lineItems:((i=(n==null?void 0:n.lineItems)||[])==null?void 0:i.length)>0?C(n==null?void 0:n.lineItems):[le()]};ue(S),b(JSON.parse(JSON.stringify(S))),o(!1),j("")}catch(n){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",n),ne()}else u?ne():(j("No deal selected to edit."),o(!1))},[r,u,l==null?void 0:l.id]),k.useEffect(()=>{if(!r||!d)return;const i=setTimeout(()=>{o(!1),j(n=>n||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(i)},[r,d]);const D=({checked:i,onChange:n})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!i,onChange:S=>{var O;return n(!!((O=S==null?void 0:S.target)!=null&&O.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),t=({value:i,selectedValue:n,onChange:S,itemIndex:O,disabled:ie=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${O}`,value:"in_house",checked:!n,onChange:()=>S(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:ie}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏠 On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${O}`,value:"vendor",checked:n,onChange:()=>S(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:ie}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏢 Off-Site"})]})]}),N=({requiresScheduling:i,onChange:n,itemIndex:S,disabled:O=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${S}`,checked:i===!0,onChange:()=>n(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:O}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${S}`,checked:i===!1,onChange:()=>n(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:O}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),C=(i=[])=>(i||[]).map(n=>({product_id:(n==null?void 0:n.product_id)??null,unit_price:(n==null?void 0:n.unit_price)??0,quantity_used:(n==null?void 0:n.quantity_used)??1,lineItemPromisedDate:(n==null?void 0:n.lineItemPromisedDate)||(n==null?void 0:n.promised_date)||"",requiresScheduling:typeof(n==null?void 0:n.requiresScheduling)=="boolean"?n==null?void 0:n.requiresScheduling:!!(n!=null&&n.requires_scheduling),noScheduleReason:(n==null?void 0:n.noScheduleReason)||(n==null?void 0:n.no_schedule_reason)||"",isOffSite:typeof(n==null?void 0:n.isOffSite)=="boolean"?n==null?void 0:n.isOffSite:!!(n!=null&&n.is_off_site),description:(n==null?void 0:n.description)||""})),ne=async()=>{var i,n,S,O,ie,ee,Y,H,de,Pe;try{o(!0),j("");const Ce=await ts(u),oe=Fe(Ce),{data:_e}=await((O=(S=(n=(i=J)==null?void 0:i.from("transactions"))==null?void 0:n.select("customer_name, customer_phone, customer_email"))==null?void 0:S.eq("job_id",u))==null?void 0:O.single());let je=null;try{const{data:we}=await((de=(H=(Y=(ee=(ie=J)==null?void 0:ie.from("loaner_assignments"))==null?void 0:ee.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:Y.eq("job_id",u))==null?void 0:H.is("returned_at",null))==null?void 0:de.limit(1));je=Array.isArray(we)?we[0]:we}catch{}const Ee={...oe,assignedTo:(oe==null?void 0:oe.assigned_to)||null,deliveryCoordinator:(oe==null?void 0:oe.delivery_coordinator_id)||null,financeManager:(oe==null?void 0:oe.finance_manager_id)||null,vendor_id:(oe==null?void 0:oe.vendor_id)||null,customerName:(_e==null?void 0:_e.customer_name)||"",customerPhone:(_e==null?void 0:_e.customer_phone)||"",customerEmail:(_e==null?void 0:_e.customer_email)||"",lineItems:((Pe=(oe==null?void 0:oe.lineItems)||[])==null?void 0:Pe.length)>0?C(oe==null?void 0:oe.lineItems):[le()]};if(ue(Ee),b(JSON.parse(JSON.stringify(Ee))),M(je||null),je)_({loaner_number:(je==null?void 0:je.loaner_number)||"",eta_return_date:(je==null?void 0:je.eta_return_date)||"",notes:(je==null?void 0:je.notes)||""});else{const we=((Ee==null?void 0:Ee.lineItems)||[]).filter(ye=>(ye==null?void 0:ye.requiresScheduling)&&(ye==null?void 0:ye.lineItemPromisedDate)).map(ye=>new Date(ye.lineItemPromisedDate).getTime()),ze=we!=null&&we.length?new Date(Math.max(...we)):null;_(ye=>({...ye,eta_return_date:ze?ze.toISOString().split("T")[0]:""}))}}catch(Ce){j(`Failed to load deal: ${Ce==null?void 0:Ce.message}`)}finally{o(!1)}},le=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),F=i=>{ue(n=>({...n,...i}))},Q=(i,n)=>{if(ue(S=>{var O;return{...S,lineItems:(O=S==null?void 0:S.lineItems)==null?void 0:O.map((ie,ee)=>{if(ee===i){let Y={...ie,...n};return"requiresScheduling"in n&&(Y.requiresScheduling=!!(n!=null&&n.requiresScheduling),(n==null?void 0:n.requiresScheduling)===!0?Y.noScheduleReason="":Y.lineItemPromisedDate=""),"isOffSite"in n&&(Y.isOffSite=!!(n!=null&&n.isOffSite),n!=null&&n.isOffSite||(Y.vendorId="")),Y}return ie})}}),n!=null&&n.product_id){const S=ce==null?void 0:ce.find(O=>(O==null?void 0:O.id)===(n==null?void 0:n.product_id));S&&ue(O=>{var ie;return{...O,lineItems:(ie=O==null?void 0:O.lineItems)==null?void 0:ie.map((ee,Y)=>Y===i?{...ee,unit_price:(S==null?void 0:S.unitPrice)||(S==null?void 0:S.unit_price)||(ee==null?void 0:ee.unit_price),cost_price:(S==null?void 0:S.cost)||(ee==null?void 0:ee.cost_price)}:ee)}})}},E=()=>{ue(i=>({...i,lineItems:[...i==null?void 0:i.lineItems,le()]}))},s=i=>{ue(n=>{var S;return{...n,lineItems:(S=n==null?void 0:n.lineItems)==null?void 0:S.filter((O,ie)=>ie!==i)}})},T=async()=>{var i,n,S,O,ie;try{if(v(!0),j(""),!((i=x==null?void 0:x.customerName)!=null&&i.trim())){j("Customer name is required");return}for(let H=0;H<((n=x==null?void 0:x.lineItems)==null?void 0:n.length);H++){const de=(S=x==null?void 0:x.lineItems)==null?void 0:S[H];if(!(de!=null&&de.product_id)){j(`Line item ${H+1}: Product is required`);return}if(de!=null&&de.requiresScheduling&&!(de!=null&&de.lineItemPromisedDate)){j(`Line item ${H+1}: Promised date is required when scheduling is needed`);return}if(!(de!=null&&de.requiresScheduling)&&!((O=de==null?void 0:de.noScheduleReason)!=null&&O.trim())){j(`Line item ${H+1}: Reason is required when no scheduling is needed`);return}}const ee={...x,customer_needs_loaner:!!(x!=null&&x.customer_needs_loaner),lineItems:(ie=x==null?void 0:x.lineItems)==null?void 0:ie.map(H=>({...H,requiresScheduling:!!(H!=null&&H.requiresScheduling),isOffSite:!!(H!=null&&H.isOffSite),unit_price:parseFloat(H==null?void 0:H.unit_price)||0,quantity_used:parseInt(H==null?void 0:H.quantity_used)||1}))},Y={...ee,assigned_to:(ee==null?void 0:ee.assignedTo)??null,delivery_coordinator_id:(ee==null?void 0:ee.deliveryCoordinator)??null,finance_manager_id:(ee==null?void 0:ee.financeManager)??null,vendor_id:(ee==null?void 0:ee.vendor_id)??null};await as(u,{...Y,loanerForm:z}),h==null||h(),c==null||c()}catch(ee){j(`Failed to save deal: ${ee==null?void 0:ee.message}`)}finally{v(!1)}},U=async()=>{try{q(!0),await cs(u),h==null||h(),c==null||c()}catch(i){j(`Failed to delete deal: ${i==null?void 0:i.message}`)}finally{q(!1),A(!1)}},B=()=>{w?a(!0):c()},X=()=>{a(!1),c()},he=()=>{var i;return((i=x==null?void 0:x.lineItems)==null?void 0:i.reduce((n,S)=>{const O=parseFloat(S==null?void 0:S.unit_price)||0,ie=parseInt(S==null?void 0:S.quantity_used)||1;return n+O*ie},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:B,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(te,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[y&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:y})}),d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{ne();try{G==null||G()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs($e,{value:x==null?void 0:x.job_status,onChange:i=>{var n;return F({job_status:(n=i==null?void 0:i.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(me,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:x==null?void 0:x.customerName,onChange:i=>{var n;return F({customerName:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(me,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:x==null?void 0:x.customerPhone,onChange:i=>{var n;return F({customerPhone:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(me,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:x==null?void 0:x.customerEmail,onChange:i=>{var n;return F({customerEmail:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs($e,{value:x==null?void 0:x.priority,onChange:i=>{var n;return F({priority:(n=i==null?void 0:i.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(me,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(x==null?void 0:x.vehicleYear)||"",onChange:i=>{var n;return F({vehicleYear:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"2024",min:"1900",max:((be=new Date)==null?void 0:be.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(me,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(x==null?void 0:x.vehicleMake)||"",onChange:i=>{var n;return F({vehicleMake:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(me,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(x==null?void 0:x.vehicleModel)||"",onChange:i=>{var n;return F({vehicleModel:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(me,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(x==null?void 0:x.stockNumber)||"",onChange:i=>{var n;return F({stockNumber:(n=i==null?void 0:i.target)==null?void 0:n.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(D,{checked:x==null?void 0:x.customer_needs_loaner,onChange:i=>{if(F({customer_needs_loaner:i}),i&&!(z!=null&&z.eta_return_date)){const n=((x==null?void 0:x.lineItems)||[]).filter(O=>(O==null?void 0:O.requiresScheduling)&&(O==null?void 0:O.lineItemPromisedDate)).map(O=>new Date(O.lineItemPromisedDate).getTime()),S=n!=null&&n.length?new Date(Math.max(...n)):null;S&&_(O=>({...O,eta_return_date:S.toISOString().split("T")[0]}))}}}),P&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",P==null?void 0:P.loaner_number,(P==null?void 0:P.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["• due"," ",(ve=new Date(P==null?void 0:P.eta_return_date))==null?void 0:ve.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(x==null?void 0:x.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(me,{id:"loaner-number","aria-label":"Loaner number",value:(z==null?void 0:z.loaner_number)||"",onChange:i=>_(n=>{var S;return{...n,loaner_number:(S=i==null?void 0:i.target)==null?void 0:S.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(me,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(z==null?void 0:z.eta_return_date)||"",onChange:i=>_(n=>{var S;return{...n,eta_return_date:(S=i==null?void 0:i.target)==null?void 0:S.value}}),min:(pe=(fe=(xe=new Date)==null?void 0:xe.toISOString())==null?void 0:fe.split("T"))==null?void 0:pe[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(me,{id:"loaner-notes","aria-label":"Loaner notes",value:(z==null?void 0:z.notes)||"",onChange:i=>_(n=>{var S;return{...n,notes:(S=i==null?void 0:i.target)==null?void 0:S.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsx("div",{className:"mb-4","data-testid":"vendor-select",children:e.jsx(Te,{label:"Vendor",options:Ne,value:(x==null?void 0:x.vendor_id)||"",onChange:i=>F({vendor_id:i||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"})}),e.jsx("div",{className:"mb-4","data-testid":"sales-select",children:e.jsx(Te,{label:"Sales Consultant",options:Se,value:x==null?void 0:x.assignedTo,onChange:i=>F({assignedTo:i}),placeholder:"Select sales consultant",searchable:!0,clearable:!0})}),e.jsx("div",{className:"mb-4","data-testid":"delivery-select",children:e.jsx(Te,{label:"Delivery Coordinator",options:g,value:x==null?void 0:x.deliveryCoordinator,onChange:i=>F({deliveryCoordinator:i}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0})}),e.jsx("div",{"data-testid":"finance-select",children:e.jsx(Te,{label:"Finance Manager",options:I,value:x==null?void 0:x.financeManager,onChange:i=>F({financeManager:i}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(K,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:E,children:[e.jsx(te,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(Z=x==null?void 0:x.lineItems)==null?void 0:Z.map((i,n)=>{var S,O,ie,ee;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",n+1]}),((S=x==null?void 0:x.lineItems)==null?void 0:S.length)>1&&e.jsx(K,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>s(n),children:e.jsx(te,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Te,{label:"Product *",options:ce,value:(i==null?void 0:i.product_id)||"",onChange:Y=>Q(n,{product_id:Y?parseInt(Y):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(me,{id:`unit-price-${n}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:i==null?void 0:i.unit_price,onChange:Y=>{var H;return Q(n,{unit_price:parseFloat((H=Y==null?void 0:Y.target)==null?void 0:H.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(me,{id:`quantity-${n}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:i==null?void 0:i.quantity_used,onChange:Y=>{var H;return Q(n,{quantity_used:parseInt((H=Y==null?void 0:Y.target)==null?void 0:H.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(t,{selectedValue:i==null?void 0:i.isOffSite,onChange:Y=>Q(n,{isOffSite:Y}),itemIndex:n})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(N,{requiresScheduling:i==null?void 0:i.requiresScheduling,onChange:Y=>Q(n,{requiresScheduling:Y}),itemIndex:n})}),i!=null&&i.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(me,{id:`promised-date-${n}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:i==null?void 0:i.lineItemPromisedDate,onChange:Y=>{var H;return Q(n,{lineItemPromisedDate:(H=Y==null?void 0:Y.target)==null?void 0:H.value})},min:(ee=(ie=(O=new Date)==null?void 0:O.toISOString())==null?void 0:ie.split("T"))==null?void 0:ee[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(me,{id:`notes-${n}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(i==null?void 0:i.description)||"",onChange:Y=>{var H;return Q(n,{description:(H=Y==null?void 0:Y.target)==null?void 0:H.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(me,{id:`no-schedule-reason-${n}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:i==null?void 0:i.noScheduleReason,onChange:Y=>{var H;return Q(n,{noScheduleReason:(H=Y==null?void 0:Y.target)==null?void 0:H.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(i==null?void 0:i.unit_price)||0)*(parseInt(i==null?void 0:i.quantity_used)||1)).toFixed(2)]})]},n)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(ae=he())==null?void 0:ae.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(K,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>A(!0),children:[e.jsx(te,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(K,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:B,children:"Cancel"}),e.jsx(K,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:T,disabled:f,children:f?"Saving...":"Save Changes"})]})]}),p&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>A(!1),children:"Cancel"}),e.jsx(K,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:U,disabled:se,children:se?"Deleting...":"Delete"})]})]})}),$&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>a(!1),children:"Keep Editing"}),e.jsx(K,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:X,children:"Discard Changes"})]})]})})]})}):null},Ns=({status:r})=>{var h;const u={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},l=(u==null?void 0:u[r])||"bg-gray-100 text-gray-700",c=((h=r==null?void 0:r.replace("_"," "))==null?void 0:h.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${l}`,children:c})},Ve=({nextPromisedShort:r})=>{if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"—"});const u=new Date(r),l=new Date;l==null||l.setHours(0,0,0,0),u==null||u.setHours(0,0,0,0);const c=new Date(l);c==null||c.setDate((l==null?void 0:l.getDate())+2);let h="";return u<l?h="bg-red-100 text-red-800 border-red-200":u<=c?h="bg-amber-100 text-amber-800 border-amber-200":h="bg-green-100 text-green-800 border-green-200",e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${h}`,children:["Next: ",r]})},Ye=({serviceType:r,jobParts:u})=>{const l=u==null?void 0:u.some(h=>h==null?void 0:h.is_off_site),c=u==null?void 0:u.some(h=>!(h!=null&&h.is_off_site));return l&&c?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})]}):l?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})},_s=({draftsCount:r,onViewDrafts:u})=>{const[l,c]=k.useState(!1);return r===0||l?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(te,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft – needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{size:"sm",variant:"ghost",onClick:u,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>c(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(te,{name:"X",size:16})})]})]})})},Me=r=>r?r!=null&&r.job_number?r.job_number:r!=null&&r.id?`Job-${String(r.id).slice(0,8)}`:"—":"—",De=r=>r&&(r==null?void 0:r.customer_name)||"",Ue=({deal:r})=>!(r!=null&&r.customer_name)&&!(r!=null&&r.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"—"}):e.jsxs("div",{className:"space-y-1",children:[(r==null?void 0:r.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:r==null?void 0:r.customer_name}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:u=>u==null?void 0:u.stopPropagation(),children:r==null?void 0:r.customer_phone})]}),Je=({amount:r})=>{var l;const u=parseFloat(r)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:l.format(u)})})},ws=({deal:r})=>r!=null&&r.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",r==null?void 0:r.loaner_number,(r==null?void 0:r.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["• due ",r==null?void 0:r.loaner_eta_short]})]}):null,Ss=({isOpen:r,onClose:u,deal:l,onSave:c,loading:h})=>{var j,p,A,se;const[d,o]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),[f,v]=k.useState("");k.useEffect(()=>{if(r&&l){let q="";try{const w=((l==null?void 0:l.job_parts)||[]).filter(m=>(m==null?void 0:m.requires_scheduling)&&(m==null?void 0:m.promised_date)).map(m=>new Date(m.promised_date));(w==null?void 0:w.length)>0&&(q=new Date(Math.max.apply(null,w)).toISOString().split("T")[0])}catch{}o({loaner_number:(l==null?void 0:l.loaner_number)||"",eta_return_date:(l==null?void 0:l.loaner_eta_return_date)||q||"",notes:(l==null?void 0:l.loaner_notes)||""}),v("")}else r||(o({loaner_number:"",eta_return_date:"",notes:""}),v(""))},[r,l]);const y=async()=>{var q,w,m;if(v(""),!((q=d==null?void 0:d.loaner_number)!=null&&q.trim())){v("Loaner number is required");return}if(!(d!=null&&d.eta_return_date)){v("ETA return date is required");return}try{await c({job_id:l==null?void 0:l.id,loaner_number:(w=d==null?void 0:d.loaner_number)==null?void 0:w.trim(),eta_return_date:d==null?void 0:d.eta_return_date,notes:((m=d==null?void 0:d.notes)==null?void 0:m.trim())||null}),u()}catch($){v(($==null?void 0:$.message)||"Failed to save loaner assignment")}};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:u}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(K,{variant:"ghost",size:"icon",onClick:u,"aria-label":"Close drawer",children:e.jsx(te,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:Me(l)}),e.jsx("p",{className:"text-xs text-slate-500",children:De(l)})]}),f&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:f}),e.jsx("button",{onClick:()=>v(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:d==null?void 0:d.loaner_number,onChange:q=>o(w=>{var m;return{...w,loaner_number:(m=q==null?void 0:q.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:d==null?void 0:d.eta_return_date,onChange:q=>o(w=>{var m;return{...w,eta_return_date:(m=q==null?void 0:q.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(A=(p=(j=new Date)==null?void 0:j.toISOString())==null?void 0:p.split("T"))==null?void 0:A[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:d==null?void 0:d.notes,onChange:q=>o(w=>{var m;return{...w,notes:(m=q==null?void 0:q.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(K,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:h,children:"Cancel"}),e.jsx(K,{onClick:y,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:h||!((se=d==null?void 0:d.loaner_number)!=null&&se.trim())||!(d!=null&&d.eta_return_date),children:h?"Saving...":"Save Loaner"})]})]})})]}):null},ks=({loaner:r,onClose:u,onConfirm:l,loading:c})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(K,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:c,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(K,{onClick:l,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:c,"aria-label":"Confirm loaner returned",children:c?"Processing...":"Mark Returned"})]})]})})}):null;function As(){var E;const[r,u]=k.useState([]),[l,c]=k.useState(!0),[h,d]=k.useState(!1),[o,f]=k.useState(!1),[v,y]=k.useState(null),[j,p]=k.useState(null),[A,se]=k.useState(null),[q,w]=k.useState(""),[m,$]=k.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[a,re]=k.useState(!1),[b,P]=k.useState(null),[M,z]=k.useState(!1),[_,L]=k.useState(null),[V,ge]=k.useState(!1),[W,ce]=k.useState(""),{clearSearch:G,error:x}=Qe({loadOnMount:!0});xs();const{user:ue}=Ie(),R=async s=>{var T;try{w("");const{error:U}=await((T=J)==null?void 0:T.rpc("delete_job_cascade",{p_job_id:s}));if(U)throw U;se(null),await g()}catch(U){w(`Failed to delete deal: ${U==null?void 0:U.message}`),console.error("Delete error:",U)}},Ne=async s=>{var T,U,B,X,he,be,ve,xe,fe,pe;try{z(!0),w("");let Z=null;try{const{data:ae}=await((he=(X=(B=(U=(T=J)==null?void 0:T.from("loaner_assignments"))==null?void 0:U.select("id"))==null?void 0:B.eq("job_id",s==null?void 0:s.job_id))==null?void 0:X.is("returned_at",null))==null?void 0:he.limit(1));Z=Array.isArray(ae)?ae[0]:ae}catch{}if(Z!=null&&Z.id){const{error:ae}=await((xe=(ve=(be=J)==null?void 0:be.from("loaner_assignments"))==null?void 0:ve.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:xe.eq("id",Z.id));if(ae)throw ae}else{const{error:ae}=await((pe=(fe=J)==null?void 0:fe.from("loaner_assignments"))==null?void 0:pe.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(ae)throw ae}re(!1),P(null),await g()}catch(Z){const ae=`Failed to save loaner assignment: ${Z==null?void 0:Z.message}`;throw w(ae),new Error(ae)}finally{z(!1)}},Se=async s=>{try{ge(!0),w(""),await is(s==null?void 0:s.loaner_id),L(null),await g()}catch(T){w(`Failed to mark loaner as returned: ${T==null?void 0:T.message}`),console.error("Mark returned error:",T)}finally{ge(!1)}},g=async(s=0)=>{var T,U;try{c(!0),w("");const B=await os();u(B||[])}catch(B){const X=`Failed to load deals: ${B==null?void 0:B.message}`;if(console.error("Load deals error:",B),s<2&&((T=B==null?void 0:B.message)!=null&&T.includes("fetch")||(U=B==null?void 0:B.message)!=null&&U.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>g(s+1),1e3*(s+1));return}w(X),u([])}finally{c(!1)}};k.useEffect(()=>{var U;const s=new URLSearchParams(window.location.search),T=s==null?void 0:s.get("status");if(T){const B=((U=T==null?void 0:T.charAt(0))==null?void 0:U.toUpperCase())+(T==null?void 0:T.slice(1));$(X=>({...X,status:B}))}},[]),k.useEffect(()=>{g()},[]);const I=s=>{P(s),re(!0)},D=({message:s,onClose:T})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(te,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),T&&e.jsx("button",{onClick:T,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(te,{name:"X",size:16})})]})}):null,N=(s=>{var xe,fe,pe;const T=s||[],U=((xe=T==null?void 0:T.filter(Z=>(Z==null?void 0:Z.job_status)==="in_progress"))==null?void 0:xe.length)||0,B=T==null?void 0:T.reduce((Z,ae)=>{const i=parseFloat(ae==null?void 0:ae.total_amount)||0;return Z+i},0),X=B*.25,he=B>0?25:0,be=((fe=T==null?void 0:T.filter(Z=>(Z==null?void 0:Z.job_status)==="pending"))==null?void 0:fe.length)||0,ve=((pe=T==null?void 0:T.filter(Z=>(Z==null?void 0:Z.job_status)==="draft"))==null?void 0:pe.length)||0;return{active:U,revenue:(B==null?void 0:B.toFixed(2))||"0.00",profit:(X==null?void 0:X.toFixed(2))||"0.00",margin:(he==null?void 0:he.toFixed(1))||"0.0",pending:be,drafts:ve}})(r),C=r==null?void 0:r.filter(s=>{var T,U,B,X,he;if((m==null?void 0:m.status)!=="All"){const be=(U=(T=m==null?void 0:m.status)==null?void 0:T.toLowerCase())==null?void 0:U.replace(" ","_");if((s==null?void 0:s.job_status)!==be)return!1}if(m!=null&&m.salesAssigned&&(s==null?void 0:s.assigned_to)!==(m==null?void 0:m.salesAssigned)||m!=null&&m.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(m==null?void 0:m.deliveryAssigned)||m!=null&&m.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(m==null?void 0:m.financeAssigned)||m!=null&&m.vendor&&(s==null?void 0:s.vendor_id)!==(m==null?void 0:m.vendor))return!1;if(W!=null&&W.trim()){const be=W==null?void 0:W.toLowerCase(),ve=Z=>(Z==null?void 0:Z.replace(/\D/g,""))||"",xe=ve(be),fe=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(B=s==null?void 0:s.vehicle)==null?void 0:B.make,(X=s==null?void 0:s.vehicle)==null?void 0:X.model,((he=s==null?void 0:s.vehicle)==null?void 0:he.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(fe==null?void 0:fe.some(Z=>{var i;const ae=Z==null?void 0:Z.toLowerCase();return!!(ae!=null&&ae.includes(be)||(xe==null?void 0:xe.length)>=3&&((i=ve(ae))!=null&&i.includes(xe)))})))return!1}return!0});k.useEffect(()=>{const s=setTimeout(()=>{ce(m==null?void 0:m.search)},300);return()=>clearTimeout(s)},[m==null?void 0:m.search]);const ne=(s,T)=>{var U,B;if($(X=>({...X,[s]:T})),s==="status"){const X=new URLSearchParams(window.location.search);T==="All"?X==null||X.delete("status"):X==null||X.set("status",T==null?void 0:T.toLowerCase());const he=`${(U=window.location)==null?void 0:U.pathname}${X!=null&&X.toString()?"?"+(X==null?void 0:X.toString()):""}`;(B=window.history)==null||B.replaceState({},"",he)}},le=()=>{var s,T;$({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),G(),(T=window.history)==null||T.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},F=s=>{var T;y(s);try{const U=(T=C!=null&&C.length?C:r)==null?void 0:T.find(B=>(B==null?void 0:B.id)===s);p(U||null)}catch{p(null)}f(!0)},Q=()=>{f(!1),y(null),p(null)};return l?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Re,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Re,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(D,{message:q||x,onClose:()=>{w("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ms,{exportType:"jobs",filters:{status:m==null?void 0:m.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,T)=>console.log(`Export complete: ${s} records`),onExportError:s=>w(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(K,{onClick:()=>d(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(te,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(_s,{draftsCount:N==null?void 0:N.drafts,onViewDrafts:()=>ne("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(te,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:N==null?void 0:N.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(te,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",N==null?void 0:N.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(te,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",N==null?void 0:N.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(te,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[N==null?void 0:N.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(te,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:N==null?void 0:N.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(te,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:N==null?void 0:N.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>ne("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(m==null?void 0:m.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(te,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:m==null?void 0:m.search,onChange:s=>{var T;return ne("search",(T=s==null?void 0:s.target)==null?void 0:T.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(K,{variant:"ghost",size:"sm",onClick:le,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(te,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",C==null?void 0:C.length," of ",r==null?void 0:r.length," deals",((m==null?void 0:m.salesAssigned)||(m==null?void 0:m.deliveryAssigned)||(m==null?void 0:m.financeAssigned)||(m==null?void 0:m.vendor)||(m==null?void 0:m.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Next"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:C==null?void 0:C.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ue,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Je,{amount:s==null?void 0:s.total_amount})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ve,{nextPromisedShort:s==null?void 0:s.next_promised_short})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ye,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>F(s==null?void 0:s.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>I(s),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>L({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>se(s),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(C==null?void 0:C.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(m==null?void 0:m.status)==="All"?"No deals found":`No ${(E=m==null?void 0:m.status)==null?void 0:E.toLowerCase()} deals found`})}):C==null?void 0:C.map(s=>e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Me(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:De(s)||"—"})]}),e.jsx(Ns,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((s==null?void 0:s.customer_name)||(s==null?void 0:s.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(Ue,{deal:s})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(Je,{amount:s==null?void 0:s.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(Ve,{nextPromisedShort:s==null?void 0:s.next_promised_short})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(Ye,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})]}),(s==null?void 0:s.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(ws,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>F(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(te,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>se(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(te,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>I(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(te,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>I(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(te,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>L({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(te,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id))}),e.jsx(bs,{isOpen:h,onClose:()=>d(!1),onSuccess:g}),e.jsx(ys,{isOpen:o,dealId:v,deal:j,onClose:Q,onSuccess:()=>{g(),Q()}}),A&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(K,{variant:"outline",onClick:()=>se(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(K,{onClick:()=>R(A==null?void 0:A.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(Ss,{isOpen:a,onClose:()=>{re(!1),P(null),w("")},deal:b,onSave:Ne,loading:M}),e.jsx(ks,{loaner:_,onClose:()=>{L(null),w("")},onConfirm:()=>Se(_),loading:V})]})]})}export{As as default};
//# sourceMappingURL=index-o64ccUDy.js.map
