import{s as K,u as Te,j as e,B as X,S as Ee,I as Ie,g as Be,a as Ve,b as Ye,c as Ue,d as Je,e as We,f as Ge,h as he}from"./index-vshjI1Zv.js";import{r as $,R as Ze}from"./react-Czq5O75u.js";import{dealService as Le,mapDbDealToForm as qe,getDeal as Qe,updateDeal as De,deleteDeal as es,markLoanerReturned as ss,getAllDeals as rs}from"./dealService-4ECM39cP.js";import{u as Ke}from"./useTenant-CESxY2vP.js";import{s as ke,t as ls}from"./options-CllavUpK.js";import{I as ee}from"./Icon-ioIXd00e.js";import{l as ns}from"./vendorService-v7oDpID-.js";import{l as ts}from"./smsTemplateService-7l5TBzqt.js";import{N as Pe}from"./Navbar-DhLitDfN.js";import{a as as}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const cs=(r,u="")=>r==null?u:String(r),Ne={async getOverdueJobs(){var r;try{const{data:u,error:n}=await((r=K)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return n?(console.error("Error fetching overdue jobs:",n),{data:[],error:{message:n==null?void 0:n.message}}):{data:u||[],error:null}}catch(u){return console.error("Error in getOverdueJobs service:",u),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,u,n,c;try{const{data:h,error:d}=await((c=(n=(u=(r=K)==null?void 0:r.from("sms_templates"))==null?void 0:u.select("*"))==null?void 0:n.eq("is_active",!0))==null?void 0:c.order("created_at",{ascending:!1}));return d?{data:[],error:{message:d==null?void 0:d.message}}:{data:h||[],error:null}}catch(h){return console.error("Error fetching SMS templates:",h),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var u,n,c,h,d,i,b,v;try{const y=await((n=(u=K)==null?void 0:u.auth)==null?void 0:n.getUser()),{data:p,error:f}=await((v=(b=(i=(c=K)==null?void 0:c.from("sms_templates"))==null?void 0:i.insert([{...r,created_by:(d=(h=y==null?void 0:y.data)==null?void 0:h.user)==null?void 0:d.id}]))==null?void 0:b.select())==null?void 0:v.single());return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:p,error:null}}catch(y){return console.error("Error creating SMS template:",y),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,u){var n,c,h,d,i,b;try{const{data:v,error:y}=await((b=(i=(d=(h=(n=K)==null?void 0:n.from("sms_templates"))==null?void 0:h.update({...u,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:i.select())==null?void 0:b.single());return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:v,error:null}}catch(v){return console.error("Error updating SMS template:",v),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var u,n,c;try{const{error:h}=await((c=(n=(u=K)==null?void 0:u.from("sms_templates"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting SMS template:",h),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var u,n,c,h,d,i,b,v,y;try{const p=await((n=(u=K)==null?void 0:u.auth)==null?void 0:n.getUser()),{data:f,error:R}=await((y=(v=(d=(h=(c=K)==null?void 0:c.from("filter_presets"))==null?void 0:h.select("*"))==null?void 0:d.eq("page_type",r))==null?void 0:v.or(`user_id.eq.${(b=(i=p==null?void 0:p.data)==null?void 0:i.user)==null?void 0:b.id},is_public.eq.true`))==null?void 0:y.order("created_at",{ascending:!1}));return R?{data:[],error:{message:R==null?void 0:R.message}}:{data:f||[],error:null}}catch(p){return console.error("Error fetching filter presets:",p),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,u,n,c=!1){var h,d,i,b,v,y,p,f;try{const R=await((d=(h=K)==null?void 0:h.auth)==null?void 0:d.getUser()),{data:Q,error:z}=await((f=(p=(y=(i=K)==null?void 0:i.from("filter_presets"))==null?void 0:y.insert([{user_id:(v=(b=R==null?void 0:R.data)==null?void 0:b.user)==null?void 0:v.id,page_type:r,name:u,filters:n,is_public:c}]))==null?void 0:p.select())==null?void 0:f.single());return z?{data:null,error:{message:z==null?void 0:z.message}}:{data:Q,error:null}}catch(R){return console.error("Error saving filter preset:",R),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var u,n,c;try{const{error:h}=await((c=(n=(u=K)==null?void 0:u.from("filter_presets"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting filter preset:",h),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,u={},n="staff"){var c,h;try{const{data:d,error:i}=await((c=K)==null?void 0:c.rpc("generate_export_data",{export_type:r,filters:u,user_role:n}));return i?{data:null,error:{message:i==null?void 0:i.message}}:{data:(h=d||[])==null?void 0:h.map(v=>{var f;const y=(v==null?void 0:v.export_data)||v,p={};return(f=Object==null?void 0:Object.entries(y))==null||f.forEach(([R,Q])=>{typeof Q=="number"?p[R]=isNaN(Q)?0:Q:Q==null?p[R]="":p[R]=Q}),{export_data:p}}),error:null}}catch(d){return console.error("Error exporting data:",d),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,u,n=null){var c,h,d,i;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let b="";if(n)b+=(n==null?void 0:n.join(","))+`
`;else{const p=((c=r==null?void 0:r[0])==null?void 0:c.export_data)||(r==null?void 0:r[0]);p&&(b+=((h=Object==null?void 0:Object.keys(p))==null?void 0:h.join(","))+`
`)}r==null||r.forEach(p=>{var Q;const f=(p==null?void 0:p.export_data)||p,R=(Q=Object==null?void 0:Object.values(f))==null?void 0:Q.map(z=>{if(z==null)return"";if(typeof z=="number"&&isNaN(z))return"0";let S=cs(z);return S!=null&&S.includes(",")||S!=null&&S.includes('"')?`"${S==null?void 0:S.replace(/"/g,'""')}"`:S});b+=(R==null?void 0:R.join(","))+`
`});const v=new Blob([b],{type:"text/csv;charset=utf-8;"}),y=document.createElement("a");if((y==null?void 0:y.download)!==void 0){const p=URL==null?void 0:URL.createObjectURL(v);y==null||y.setAttribute("href",p),y==null||y.setAttribute("download",u),y.style.visibility="hidden",(d=document.body)==null||d.appendChild(y),y==null||y.click(),(i=document.body)==null||i.removeChild(y),URL==null||URL.revokeObjectURL(p)}return{success:!0,error:null}}catch(b){return console.error("Export to CSV error:",b),{success:!1,error:{message:(b==null?void 0:b.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,u){var n,c,h,d,i;try{const b=await((c=(n=K)==null?void 0:n.auth)==null?void 0:c.getUser()),{data:v,error:y}=await((i=K)==null?void 0:i.rpc("bulk_update_jobs",{job_ids:r,updates:u,performed_by:(d=(h=b==null?void 0:b.data)==null?void 0:h.user)==null?void 0:d.id}));return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:(v==null?void 0:v[0])||null,error:null}}catch(b){return console.error("Error in bulk update jobs:",b),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,u,n,c,h,d,i;try{const b=await((u=(r=K)==null?void 0:r.auth)==null?void 0:u.getUser()),{data:v,error:y}=await((i=(c=(n=K)==null?void 0:n.from("notification_preferences"))==null?void 0:c.select("*"))==null?void 0:i.eq("user_id",(d=(h=b==null?void 0:b.data)==null?void 0:h.user)==null?void 0:d.id));return y?{data:[],error:{message:y==null?void 0:y.message}}:{data:v||[],error:null}}catch(b){return console.error("Error fetching notification preferences:",b),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var u,n,c,h,d,i,b,v,y,p;try{const f=await((n=(u=K)==null?void 0:u.auth)==null?void 0:n.getUser());await((b=(h=(c=K)==null?void 0:c.from("notification_preferences"))==null?void 0:h.delete())==null?void 0:b.eq("user_id",(i=(d=f==null?void 0:f.data)==null?void 0:d.user)==null?void 0:i.id));const R=r==null?void 0:r.map(S=>{var m,O;return{...S,user_id:(O=(m=f==null?void 0:f.data)==null?void 0:m.user)==null?void 0:O.id}}),{data:Q,error:z}=await((p=(y=(v=K)==null?void 0:v.from("notification_preferences"))==null?void 0:y.insert(R))==null?void 0:p.select());return z?{data:null,error:{message:z==null?void 0:z.message}}:{data:Q,error:null}}catch(f){return console.error("Error updating notification preferences:",f),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var u,n,c;try{return(c=(n=(u=K)==null?void 0:u.channel("overdue-jobs"))==null?void 0:n.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},d=>{var i;(i=this.getOverdueJobs())==null||i.then(b=>{b!=null&&b.data&&r(b==null?void 0:b.data)})}))==null?void 0:c.subscribe()}catch(h){return console.error("Error subscribing to overdue jobs:",h),null}},async searchWithFilters(r,u,n){var c,h,d;try{let i=(c=K)==null?void 0:c.from(n);if(r)switch(n){case"jobs":i=i==null?void 0:i.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":i=i==null?void 0:i.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":i=i==null?void 0:i.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(h=Object==null?void 0:Object.entries(u))==null||h.forEach(([y,p])=>{p!=null&&p!==""&&(Array!=null&&Array.isArray(p)?i=i==null?void 0:i.in(y,p):typeof p=="object"&&(p==null?void 0:p.min)!==void 0?i=i==null?void 0:i.gte(y,p==null?void 0:p.min):typeof p=="object"&&(p==null?void 0:p.max)!==void 0?i=i==null?void 0:i.lte(y,p==null?void 0:p.max):i=i==null?void 0:i.eq(y,p))});const{data:b,error:v}=await((d=i==null?void 0:i.select("*"))==null?void 0:d.order("created_at",{ascending:!1}));return v?{data:[],error:{message:v==null?void 0:v.message}}:{data:b||[],error:null}}catch(i){return console.error("Error in search with filters:",i),{data:[],error:{message:"Failed to search with filters"}}}}},os=({exportType:r,filters:u={},selectedIds:n=[],onExportStart:c,onExportComplete:h,onExportError:d,disabled:i=!1,variant:b="outline",size:v="sm",className:y=""})=>{var M;const[p,f]=$.useState(!1),[R,Q]=$.useState(!1),[z,S]=$.useState("csv"),[m,O]=$.useState("filtered"),{user:a,userProfile:D}=Te(),j=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],F=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(n==null?void 0:n.length)>0?[{value:"selected",label:`Selected (${n==null?void 0:n.length})`}]:[]],q=()=>{var H,ce,le;const G=(le=(ce=(H=new Date)==null?void 0:H.toISOString())==null?void 0:ce.split("T"))==null?void 0:le[0];return`${r}-${m==="selected"?"selected":m}-${G}.${z}`},V=async()=>{var G,xe,H,ce;if(!p)try{f(!0),c&&c();let le={...u};m==="selected"&&(n==null?void 0:n.length)>0&&(le.ids=n),m==="all"&&(le={});const Z=await(Ne==null?void 0:Ne.exportData(r,le,(D==null?void 0:D.role)||"staff"));if(Z!=null&&Z.error)throw new Error((G=Z==null?void 0:Z.error)==null?void 0:G.message);if(!(Z!=null&&Z.data)||((xe=Z==null?void 0:Z.data)==null?void 0:xe.length)===0)throw new Error("No data found to export");const _=q(),A=await(Ne==null?void 0:Ne.exportToCSV(Z==null?void 0:Z.data,_));if(A!=null&&A.error)throw new Error((H=A==null?void 0:A.error)==null?void 0:H.message);Q(!1),h&&h((ce=Z==null?void 0:Z.data)==null?void 0:ce.length,_)}catch(le){console.error("Export error:",le),d&&d((le==null?void 0:le.message)||"Export failed")}finally{f(!1)}},w=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(X,{variant:b,size:v,onClick:()=>Q(!R),disabled:i||p,iconName:p?void 0:"Download",iconPosition:"left",className:`${y} ${p?"cursor-wait":""}`,"aria-label":`Export ${w()}`,children:p?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${w()}`}),R&&!p&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ee,{value:z,onChange:S,options:j,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ee,{value:m,onChange:O,options:F,className:"w-full"})]}),m==="filtered"&&((M=Object==null?void 0:Object.keys(u))==null?void 0:M.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Ie,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),m==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Ie,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",n==null?void 0:n.length," selected record",(n==null?void 0:n.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(X,{variant:"ghost",size:"sm",onClick:()=>Q(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(X,{size:"sm",onClick:V,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${w()}`,children:"Export"})]})]})})]})},Oe={async getVehicles(r={},u=null){var n,c,h,d;try{let i=(h=(c=(n=K)==null?void 0:n.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:h.order("created_at",{ascending:!1});return u&&(i=i==null?void 0:i.eq("org_id",u)),r!=null&&r.status&&(i=i==null?void 0:i.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(i=i==null?void 0:i.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(i=i==null?void 0:i.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(i=i==null?void 0:i.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await ke(i,"vehicles:getVehicles")||[],error:null}}catch(i){return(d=i==null?void 0:i.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,u=null){var n,c,h,d,i;try{let b=(d=(h=(c=(n=K)==null?void 0:n.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:h.eq("id",r))==null?void 0:d.single();return u&&(b=b==null?void 0:b.eq("org_id",u)),{data:await ke(b,"vehicles:getVehicleById"),error:null}}catch(b){return(i=b==null?void 0:b.message)!=null&&i.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var u,n,c,h,d,i,b,v,y,p;try{const{data:f,error:R}=await((y=(v=(b=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:b.insert([{...r,created_by:(i=(d=(h=await((c=(n=K)==null?void 0:n.auth)==null?void 0:c.getUser()))==null?void 0:h.data)==null?void 0:d.user)==null?void 0:i.id}]))==null?void 0:v.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:y.single());return R?{data:null,error:{message:R==null?void 0:R.message}}:{data:f,error:null}}catch(f){return(p=f==null?void 0:f.message)!=null&&p.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var u,n,c,h;try{const{data:d,error:i}=await((h=(c=(n=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:n.insert([r]))==null?void 0:c.select())==null?void 0:h.single());if(i)throw console.error("Vehicle creation error:",i),new Error(i.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",d),d}catch(d){throw console.error("Error in vehicleService.create:",d),d}},async createVehicleWithProducts(r){var u,n;try{console.log("Creating vehicle with products:",r);const c=`vehicle_${Date.now()}`;await new Promise(d=>setTimeout(d,1e3));const h={id:c,...r,created_at:(u=new Date)==null?void 0:u.toISOString(),initial_products_count:((n=r==null?void 0:r.initial_products)==null?void 0:n.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",h),h}catch(c){throw console.error("Error creating vehicle with products:",c),c}},async checkStockNumberExists(r){var u,n,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:i}=await((h=(c=(n=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:n.select("id"))==null?void 0:c.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return i?(console.error("Stock number check error:",i),!1):!!d}catch(d){return console.error("Error checking stock number:",d),!1}},async checkVinExists(r){var u,n,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:i}=await((h=(c=(n=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:n.select("id"))==null?void 0:c.eq("vin",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return i?(console.error("VIN check error:",i),!1):!!d}catch(d){return console.error("Error checking VIN:",d),!1}},async updateVehicle(r,u){var n,c,h,d,i,b,v;try{const{data:y,error:p}=await((b=(i=(d=(h=(n=K)==null?void 0:n.from("vehicles"))==null?void 0:h.update({...u,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:b.single());return p?{data:null,error:{message:p==null?void 0:p.message}}:{data:y,error:null}}catch(y){return(v=y==null?void 0:y.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var u,n,c,h;try{const{error:d}=await((c=(n=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return(h=d==null?void 0:d.message)!=null&&h.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var u,n,c,h,d,i,b;try{let v=(n=(u=K)==null?void 0:u.from("vehicles"))==null?void 0:n.select("vehicle_status");r&&(v=v==null?void 0:v.eq("org_id",r));const y=await ke(v,"vehicles:getVehicleStats");return{data:{total:(y==null?void 0:y.length)||0,active:((c=y==null?void 0:y.filter(f=>(f==null?void 0:f.vehicle_status)==="active"))==null?void 0:c.length)||0,maintenance:((h=y==null?void 0:y.filter(f=>(f==null?void 0:f.vehicle_status)==="maintenance"))==null?void 0:h.length)||0,retired:((d=y==null?void 0:y.filter(f=>(f==null?void 0:f.vehicle_status)==="retired"))==null?void 0:d.length)||0,sold:((i=y==null?void 0:y.filter(f=>(f==null?void 0:f.vehicle_status)==="sold"))==null?void 0:i.length)||0},error:null}}catch(v){return(b=v==null?void 0:v.message)!=null&&b.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function is({isOpen:r,onClose:u,onSuccess:n}){var x,P,W;const{user:c}=Te(),{orgId:h}=Ke()||{},[d,i]=$.useState(1),[b,v]=$.useState(!1),[y,p]=$.useState(""),[f,R]=$.useState(!1),[Q,z]=$.useState(!1),[S,m]=$.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),O={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(x=new Date)==null?void 0:x.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[a,D]=$.useState(O),[j,F]=$.useState([]),q=async(l=0)=>{var g,k;try{m(s=>({...s,loading:!0,error:null,retryCount:l}));const[re,ne,se,ae,E]=await Promise.all([Be().catch(()=>[]),Ve().catch(()=>[]),Ye().catch(()=>[]),Ue({activeOnly:!0}).catch(()=>[]),Je({activeOnly:!0}).catch(()=>[])]);m({salesConsultants:re,deliveryCoordinators:ne,financeManagers:se,vendors:ae,products:E==null?void 0:E.map(s=>({...s,unitPrice:s==null?void 0:s.unit_price})),loading:!1,error:null,retryCount:l})}catch(re){if(console.error("Failed to load dropdown data:",re),l<2&&((g=re==null?void 0:re.message)!=null&&g.includes("fetch")||(k=re==null?void 0:re.message)!=null&&k.includes("network"))){setTimeout(()=>q(l+1),1e3*(l+1));return}m(ne=>({...ne,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:l}))}},V=({checked:l,onChange:g})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!l,onChange:k=>{var ne;const re=!!((ne=k==null?void 0:k.target)!=null&&ne.checked);g(re)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),w=({label:l,options:g,value:k,onChange:re,placeholder:ne,required:se=!1,helpText:ae,testId:E})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l," ",se&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:k||"",onChange:s=>{var L;return re(((L=s==null?void 0:s.target)==null?void 0:L.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:S==null?void 0:S.loading,required:se,"data-testid":E,children:[e.jsx("option",{value:"",children:ne}),g==null?void 0:g.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:(s==null?void 0:s.full_name)||(s==null?void 0:s.label)||(s==null?void 0:s.name)},s==null?void 0:s.id))]}),ae&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:ae}),(g==null?void 0:g.length)===0&&!(S!=null&&S.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-red-500",children:["No ",l==null?void 0:l.toLowerCase()," found. Please check your database connection."]})]});$.useEffect(()=>{const l=(a==null?void 0:a.customerName)!==(O==null?void 0:O.customerName)||(a==null?void 0:a.customerPhone)!==(O==null?void 0:O.customerPhone)||(a==null?void 0:a.customerEmail)!==(O==null?void 0:O.customerEmail)||(a==null?void 0:a.needsLoaner)!==(O==null?void 0:O.needsLoaner)||(a==null?void 0:a.assignedTo)!==(O==null?void 0:O.assignedTo)||(a==null?void 0:a.deliveryCoordinator)!==(O==null?void 0:O.deliveryCoordinator)||(a==null?void 0:a.financeManager)!==(O==null?void 0:O.financeManager)||(j==null?void 0:j.length)>0;R(l)},[a,j]),$.useEffect(()=>{r&&q()},[r]);const M=()=>{F(l=>[...l,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},G=(l,g,k)=>{var re;if(F(ne=>ne==null?void 0:ne.map(se=>{if((se==null?void 0:se.id)===l){let ae={...se,[g]:k};return g==="requiresScheduling"&&(k===!0?ae.noScheduleReason="":ae.promisedDate=""),ae}return se})),g==="productId"&&k){const ne=(re=S==null?void 0:S.products)==null?void 0:re.find(se=>(se==null?void 0:se.id)===k);ne&&F(se=>se==null?void 0:se.map(ae=>(ae==null?void 0:ae.id)===l?{...ae,unitPrice:(ne==null?void 0:ne.unitPrice)||""}:ae))}},xe=l=>{F(g=>g==null?void 0:g.filter(k=>(k==null?void 0:k.id)!==l))},H=()=>{var l,g;return((g=(l=a==null?void 0:a.customerName)==null?void 0:l.trim())==null?void 0:g.length)>0},ce=()=>(j==null?void 0:j.length)===0?!1:j==null?void 0:j.every(l=>{var g;return!(!(l!=null&&l.productId)||!(l!=null&&l.unitPrice)||l!=null&&l.requiresScheduling&&!(l!=null&&l.promisedDate)||!(l!=null&&l.requiresScheduling)&&!((g=l==null?void 0:l.noScheduleReason)!=null&&g.trim())||(l==null?void 0:l.serviceType)==="vendor"&&!(l!=null&&l.vendorId))}),le=()=>j==null?void 0:j.reduce((l,g)=>l+(parseFloat(g==null?void 0:g.unitPrice)||0),0),Z=async()=>{var l,g,k,re,ne,se,ae,E,s,L;if(!H()){p("Customer name is required to save draft");return}v(!0),p("");try{const Y={year:(a==null?void 0:a.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(a==null?void 0:a.vehicleMake)||"TBD",model:(a==null?void 0:a.vehicleModel)||"TBD",owner_name:(g=a==null?void 0:a.customerName)==null?void 0:g.trim(),owner_phone:((k=a==null?void 0:a.customerPhone)==null?void 0:k.trim())||null,owner_email:((re=a==null?void 0:a.customerEmail)==null?void 0:re.trim())||null,stock_number:((ne=a==null?void 0:a.stockNumber)==null?void 0:ne.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},B=await Oe.create(Y),J={title:`Draft Deal - ${(se=a==null?void 0:a.customerName)==null?void 0:se.trim()}`,description:`Draft deal for ${(ae=a==null?void 0:a.customerName)==null?void 0:ae.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:B==null?void 0:B.id,assigned_to:(a==null?void 0:a.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(a==null?void 0:a.deliveryCoordinator)||null,finance_manager_id:(a==null?void 0:a.financeManager)||null,customer_needs_loaner:!!(a!=null&&a.needsLoaner),customerName:(E=a==null?void 0:a.customerName)==null?void 0:E.trim(),customerPhone:((s=a==null?void 0:a.customerPhone)==null?void 0:s.trim())||"",customerEmail:((L=a==null?void 0:a.customerEmail)==null?void 0:L.trim())||"",org_id:h||void 0,lineItems:[]};await Le.createDeal(J),n==null||n(),A(),u()}catch(Y){p(`Failed to save draft: ${Y==null?void 0:Y.message}`)}finally{v(!1)}},_=async()=>{var l,g,k,re,ne,se,ae,E,s,L,Y,B;if(!H()||!ce()){p("Please complete all required fields");return}v(!0),p("");try{const J={year:(a==null?void 0:a.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(a==null?void 0:a.vehicleMake)||"TBD",model:(a==null?void 0:a.vehicleModel)||"TBD",owner_name:(g=a==null?void 0:a.customerName)==null?void 0:g.trim(),owner_phone:((k=a==null?void 0:a.customerPhone)==null?void 0:k.trim())||null,owner_email:((re=a==null?void 0:a.customerEmail)==null?void 0:re.trim())||null,stock_number:((ne=a==null?void 0:a.stockNumber)==null?void 0:ne.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},ie=await Oe.create(J),me=le(),ue=(j==null?void 0:j.some(C=>(C==null?void 0:C.serviceType)==="vendor"))?"vendor":"in_house",o=((se=j==null?void 0:j.find(C=>C==null?void 0:C.vendorId))==null?void 0:se.vendorId)||null;let t=null;if(ue==="vendor"){const C=(j||[]).filter(I=>(I==null?void 0:I.serviceType)==="vendor"&&(I==null?void 0:I.requiresScheduling)&&(I==null?void 0:I.promisedDate)).map(I=>new Date(I==null?void 0:I.promisedDate)).sort((I,U)=>I-U);t=(ae=(C==null?void 0:C[0])||new Date)==null?void 0:ae.toISOString()}const N=(j||[]).map(C=>({product_id:C==null?void 0:C.productId,quantity_used:1,unit_price:parseFloat((C==null?void 0:C.unitPrice)||0),promised_date:C!=null&&C.requiresScheduling?C==null?void 0:C.promisedDate:null,requires_scheduling:!!(C!=null&&C.requiresScheduling),no_schedule_reason:C!=null&&C.requiresScheduling?null:C==null?void 0:C.noScheduleReason,is_off_site:(C==null?void 0:C.serviceType)==="vendor"})),T={title:`Deal - ${(E=a==null?void 0:a.customerName)==null?void 0:E.trim()}`,description:`Deal for ${(s=a==null?void 0:a.customerName)==null?void 0:s.trim()}`,job_status:"pending",service_type:ue,vehicle_id:ie==null?void 0:ie.id,vendor_id:o,assigned_to:(a==null?void 0:a.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(a==null?void 0:a.deliveryCoordinator)||null,finance_manager_id:(a==null?void 0:a.financeManager)||null,customer_needs_loaner:!!(a!=null&&a.needsLoaner),scheduled_start_time:t,estimated_cost:me,org_id:h||void 0,customerName:(L=a==null?void 0:a.customerName)==null?void 0:L.trim(),customerPhone:((Y=a==null?void 0:a.customerPhone)==null?void 0:Y.trim())||"",customerEmail:((B=a==null?void 0:a.customerEmail)==null?void 0:B.trim())||"",lineItems:N},te=await Le.createDeal(T);await Le.updateDeal(te==null?void 0:te.id,T),n==null||n(),A(),u()}catch(J){p(`Failed to create deal: ${J==null?void 0:J.message}`)}finally{v(!1)}},A=()=>{i(1),D(O),F([]),p(""),R(!1)},je=()=>{f?z(!0):(A(),u())},ye=()=>{z(!1),A(),u()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:je,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(ee,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${d>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${d>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[y&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",y]}),e.jsx("button",{onClick:()=>p(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(ee,{name:"X",size:16})})]})}),(S==null?void 0:S.loading)&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{name:"Loader",size:16,className:"mr-2 animate-spin"}),"Loading dropdown data..."]})}),(S==null?void 0:S.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",S==null?void 0:S.error]}),e.jsx("button",{onClick:()=>q(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),d===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a==null?void 0:a.customerName,onChange:l=>D(g=>{var k;return{...g,customerName:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:a==null?void 0:a.customerPhone,onChange:l=>D(g=>{var k;return{...g,customerPhone:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:a==null?void 0:a.customerEmail,onChange:l=>D(g=>{var k;return{...g,customerEmail:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(a==null?void 0:a.vehicleYear)||"",onChange:l=>D(g=>{var k;return{...g,vehicleYear:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((P=new Date)==null?void 0:P.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.vehicleMake)||"",onChange:l=>D(g=>{var k;return{...g,vehicleMake:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.vehicleModel)||"",onChange:l=>D(g=>{var k;return{...g,vehicleModel:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(a==null?void 0:a.stockNumber)||"",onChange:l=>D(g=>{var k;return{...g,stockNumber:(k=l==null?void 0:l.target)==null?void 0:k.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(V,{checked:a==null?void 0:a.needsLoaner,onChange:l=>{D(g=>({...g,needsLoaner:!!l}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(w,{label:"Sales Consultant",options:S==null?void 0:S.salesConsultants,value:a==null?void 0:a.assignedTo,onChange:l=>D(g=>({...g,assignedTo:l})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(w,{label:"Delivery Coordinator",options:S==null?void 0:S.deliveryCoordinators,value:a==null?void 0:a.deliveryCoordinator,onChange:l=>D(g=>({...g,deliveryCoordinator:l})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(w,{label:"Finance Manager",options:S==null?void 0:S.financeManagers,value:a==null?void 0:a.financeManager,onChange:l=>D(g=>({...g,financeManager:l})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),d===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(X,{onClick:M,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(ee,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(j==null?void 0:j.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(ee,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[j==null?void 0:j.map((l,g)=>{var k,re,ne,se,ae;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",g+1]}),e.jsx("button",{onClick:()=>xe(l==null?void 0:l.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(ee,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.productId)||"",onChange:E=>{var s;return G(l==null?void 0:l.id,"productId",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${g}`,children:[e.jsx("option",{value:"",children:"Select product"}),(k=S==null?void 0:S.products)==null?void 0:k.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:l==null?void 0:l.unitPrice,onChange:E=>{var s;return G(l==null?void 0:l.id,"unitPrice",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${g}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"in_house",checked:(l==null?void 0:l.serviceType)==="in_house",onChange:E=>{var s;return G(l==null?void 0:l.id,"serviceType",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"mr-2 cursor-pointer"}),"🏠 On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"vendor",checked:(l==null?void 0:l.serviceType)==="vendor",onChange:E=>{var s;return G(l==null?void 0:l.id,"serviceType",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"mr-2 cursor-pointer"}),"🏢 Off-Site (Vendor)"]})]})]}),(l==null?void 0:l.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.vendorId)||"",onChange:E=>{var s;return G(l==null?void 0:l.id,"vendorId",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(re=S==null?void 0:S.vendors)==null?void 0:re.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${g}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!0,onChange:()=>G(l==null?void 0:l.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${g}`,"data-testid":`requires-scheduling-${g}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${g}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!1,onChange:()=>G(l==null?void 0:l.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${g}`}),"No Scheduling Needed"]})]}),l!=null&&l.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:l==null?void 0:l.promisedDate,onChange:E=>{var s;return G(l==null?void 0:l.id,"promisedDate",(s=E==null?void 0:E.target)==null?void 0:s.value)},min:(ae=(se=(ne=new Date)==null?void 0:ne.toISOString())==null?void 0:se.split("T"))==null?void 0:ae[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:l==null?void 0:l.noScheduleReason,onChange:E=>{var s;return G(l==null?void 0:l.id,"noScheduleReason",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:l==null?void 0:l.serviceNotes,onChange:E=>{var s;return G(l==null?void 0:l.id,"serviceNotes",(s=E==null?void 0:E.target)==null?void 0:s.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},l==null?void 0:l.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(W=le())==null?void 0:W.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[j==null?void 0:j.length," item",(j==null?void 0:j.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:d===2&&e.jsx(X,{onClick:()=>i(1),variant:"outline",className:"w-full md:w-auto h-11",children:"← Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(X,{onClick:je,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),d===1&&e.jsxs(e.Fragment,{children:[e.jsx(X,{onClick:Z,disabled:!H()||b,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:b?"Saving...":"Save Draft"}),e.jsx(X,{onClick:()=>i(2),disabled:!H(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items →"})]}),d===2&&e.jsx(X,{onClick:_,disabled:!H()||!ce()||b,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:b?"Creating...":"Create Deal"})]})]})}),Q&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(X,{variant:"outline",onClick:()=>z(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(X,{onClick:ye,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function ds(r,{activeOnly:u=!0}={}){let n=K.from("products").select("*").order("name",{ascending:!0});u&&(n=n.eq("is_active",!0)),r&&(n=n.or(`org_id.eq.${r},org_id.is.null`));const c=await ke(n,"products:listByOrg");return ls(c,{labelKey:"name",valueKey:"id"})}function us(r,{activeOnly:u=!0}={}){let n=K.from("user_profiles").select("*").order("full_name",{ascending:!0});return u&&(n=n.eq("is_active",!0)),r&&(n=n.eq("org_id",r)),ke(n,"staff:listByOrg")}function Xe(r={}){var m,O,a,D;const{loadOnMount:u=!0,cacheTime:n=5*60*1e3}=r,[c,h]=$.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[d,i]=$.useState(null),b=Ke(),v=Te(),y=async()=>{var j,F,q,V;try{if(b.loading)return;if(h(A=>({...A,loading:!0,error:null})),!((j=b.session)!=null&&j.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),h(A=>({...A,loading:!1}));return}const w=!!b.orgId,M=[(F=Ve())==null?void 0:F.catch(A=>(console.error("[dropdowns:dc] Delivery coordinators failed:",A),[])),(q=Be())==null?void 0:q.catch(A=>(console.error("[dropdowns:sales] Sales consultants failed:",A),[])),(V=Ye())==null?void 0:V.catch(A=>(console.error("[dropdowns:finance] Finance managers failed:",A),[])),w?us(b.orgId).catch(A=>(console.error("[dropdowns:users] tenant staff failed:",A),[])):We({activeOnly:!0}).catch(A=>(console.error("[dropdowns:users] global user profiles failed:",A),[])),w?ns(b.orgId).catch(A=>(console.error("[dropdowns:vendors] tenant vendors failed:",A),[])):Ue({activeOnly:!0}).catch(A=>(console.error("[dropdowns:vendors] global vendors failed:",A),[])),w?ds(b.orgId).catch(A=>(console.error("[dropdowns:products] tenant products failed:",A),[])):Je({activeOnly:!0}).catch(A=>(console.error("[dropdowns:products] global products failed:",A),[])),w?ts(b.orgId).catch(A=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",A),[])):Promise.resolve([])],[G,xe,H,ce,le,Z,_]=await Promise.all(M);h({dc:G,sales:xe,finance:H,users:ce,vendors:le,products:Z,smsTemplates:_,loading:!1,error:null,searchResults:null}),i(Date.now())}catch(w){h({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(w==null?void 0:w.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",w)}},p=()=>d?Date.now()-d<n:!1,f=async()=>{p()||await y()},R=async j=>{try{if(!(j!=null&&j.trim())){h(q=>({...q,searchResults:null}));return}const F=await Ge(j);h(q=>({...q,searchResults:F}))}catch(F){console.error("[dropdowns:search] Search failed:",F),h(q=>({...q,searchResults:{users:[],vendors:[]}}))}},Q=()=>{h(j=>({...j,searchResults:null}))},z=(j={})=>{const{roles:F=[],departments:q=[],activeOnly:V=!0}=j;let w=(c==null?void 0:c.users)||[];return V&&(w=w==null?void 0:w.filter(M=>M==null?void 0:M.is_active)),(F==null?void 0:F.length)>0&&(w=w==null?void 0:w.filter(M=>F==null?void 0:F.includes(M==null?void 0:M.role))),(q==null?void 0:q.length)>0&&(w=w==null?void 0:w.filter(M=>q==null?void 0:q.includes(M==null?void 0:M.department))),(w==null?void 0:w.map(M=>({id:M==null?void 0:M.id,value:M==null?void 0:M.id,label:M==null?void 0:M.full_name,name:M==null?void 0:M.full_name,role:M==null?void 0:M.role,department:M==null?void 0:M.department,email:M==null?void 0:M.email})))||[]},S=(j={})=>{const{activeOnly:F=!0,specialty:q=null}=j;let V=(c==null?void 0:c.vendors)||[];return F&&(V=V==null?void 0:V.filter(w=>w==null?void 0:w.is_active)),q&&(V=V==null?void 0:V.filter(w=>{var M,G;return(G=(M=w==null?void 0:w.specialty)==null?void 0:M.toLowerCase())==null?void 0:G.includes(q==null?void 0:q.toLowerCase())})),(V==null?void 0:V.map(w=>({id:w==null?void 0:w.id,value:(w==null?void 0:w.value)||(w==null?void 0:w.id),label:(w==null?void 0:w.label)||(w==null?void 0:w.name),name:w==null?void 0:w.name,specialty:w==null?void 0:w.specialty,email:w==null?void 0:w.email,phone:w==null?void 0:w.phone})))||[]};return $.useEffect(()=>{let j=!0;return(async()=>{var q;if(!u)return;const F=Date.now();for(;j&&(v!=null&&v.loading)&&Date.now()-F<5e3;)await new Promise(V=>setTimeout(V,200));j&&(v!=null&&v.user?(console.log("Dropdowns: authenticated user",(q=v==null?void 0:v.user)==null?void 0:q.id),v!=null&&v.userProfile&&console.log("Dropdowns: user profile org",v.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),j&&await y())})(),()=>{j=!1}},[u,v==null?void 0:v.loading,(m=v==null?void 0:v.user)==null?void 0:m.id,b==null?void 0:b.loading,b==null?void 0:b.orgId]),{dc:c==null?void 0:c.dc,sales:c==null?void 0:c.sales,finance:c==null?void 0:c.finance,users:c==null?void 0:c.users,vendors:c==null?void 0:c.vendors,products:c==null?void 0:c.products,smsTemplates:c==null?void 0:c.smsTemplates,loading:c==null?void 0:c.loading,error:c==null?void 0:c.error,searchResults:c==null?void 0:c.searchResults,globalSearch:R,clearSearch:Q,getUserOptions:z,getVendorOptions:S,refresh:y,refreshIfNeeded:f,lastUpdate:d,isCacheValid:p(),salesConsultantOptions:(O=(c==null?void 0:c.sales)||[])==null?void 0:O.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name})),deliveryCoordinatorOptions:(a=(c==null?void 0:c.dc)||[])==null?void 0:a.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name})),financeManagerOptions:(D=(c==null?void 0:c.finance)||[])==null?void 0:D.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name}))}}const hs=()=>{var v,y,p;const{dc:r,sales:u,finance:n,vendors:c,products:h,loading:d,error:i,refresh:b}=Xe({loadOnMount:!0});return{salesConsultants:u,deliveryCoordinators:r,financeManagers:n,vendors:c,products:h,loading:d,error:i,refresh:b,salesConsultantOptions:(v=u||[])==null?void 0:v.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),deliveryCoordinatorOptions:(y=r||[])==null?void 0:y.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),financeManagerOptions:(p=n||[])==null?void 0:p.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),vendorOptions:c||[],productOptions:h||[]}},xs=()=>(Ze.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Se=({options:r=[],value:u,onChange:n,placeholder:c="Select...",searchable:h=!1,clearable:d=!1,disabled:i=!1,loading:b=!1,error:v=null,className:y="",optionLabel:p="label",optionValue:f="value",groupBy:R=null,renderOption:Q=null,label:z="",helperText:S=""})=>{const[m,O]=$.useState(!1),[a,D]=$.useState(""),[j,F]=$.useState(!1),[q,V]=$.useState(r),[w,M]=$.useState(-1),[G,xe]=$.useState({top:0,left:0,width:0}),H=$.useRef(null),ce=$.useRef(null);$.useRef(null),$.useEffect(()=>{F((()=>{var l;return(l=window.matchMedia("(max-width: 767px)"))==null?void 0:l.matches})());const P=window.matchMedia("(max-width: 767px)"),W=()=>F(P==null?void 0:P.matches);return P==null||P.addEventListener("change",W),()=>P==null?void 0:P.removeEventListener("change",W)},[]),$.useEffect(()=>{if(!(a!=null&&a.trim())){V(r);return}const x=a==null?void 0:a.toLowerCase(),P=r==null?void 0:r.filter(W=>{const l=[W==null?void 0:W.name,W==null?void 0:W.displayName,W==null?void 0:W.category,W==null?void 0:W.brand,W==null?void 0:W.specialty,W==null?void 0:W.department,W==null?void 0:W.email].filter(Boolean);return l==null?void 0:l.some(g=>{var k;return(k=g==null?void 0:g.toLowerCase())==null?void 0:k.includes(x)})});V(P),M(-1)},[a,r]);const le=r==null?void 0:r.find(x=>(x==null?void 0:x.id)===u),Z=x=>((x==null?void 0:x[f])||(x==null?void 0:x.id))===u,_=()=>{var x;if(H!=null&&H.current){const P=(x=H==null?void 0:H.current)==null?void 0:x.getBoundingClientRect();xe({top:(P==null?void 0:P.bottom)+window.scrollY,left:(P==null?void 0:P.left)+window.scrollX,width:P==null?void 0:P.width})}};$.useEffect(()=>{m&&!j&&_()},[m,j]),$.useEffect(()=>{if(j)return;const x=P=>{var W;H!=null&&H.current&&!((W=H==null?void 0:H.current)!=null&&W.contains(P==null?void 0:P.target))&&(O(!1),D(""),M(-1))};return document==null||document.addEventListener("mousedown",x),()=>document==null?void 0:document.removeEventListener("mousedown",x)},[j]);const A=x=>{if(!j){if(!m){((x==null?void 0:x.key)==="Enter"||(x==null?void 0:x.key)===" "||(x==null?void 0:x.key)==="ArrowDown")&&(x==null||x.preventDefault(),O(!0),h&&setTimeout(()=>{var P;return(P=ce==null?void 0:ce.current)==null?void 0:P.focus()},0));return}switch(x==null?void 0:x.key){case"Escape":O(!1),D(""),M(-1);break;case"ArrowDown":x==null||x.preventDefault(),M(P=>P<(q==null?void 0:q.length)-1?P+1:0);break;case"ArrowUp":x==null||x.preventDefault(),M(P=>P>0?P-1:(q==null?void 0:q.length)-1);break;case"Enter":x==null||x.preventDefault(),w>=0&&(q!=null&&q[w])&&je(q==null?void 0:q[w]);break;case"Tab":O(!1),D(""),M(-1);break}}},je=x=>{n==null||n(x==null?void 0:x.id),O(!1),D(""),M(-1)},ye=x=>{x==null||x.stopPropagation(),n==null||n(null)};return j?e.jsxs("div",{className:`relative ${y}`,children:[e.jsxs("select",{value:u||"",onChange:x=>{var P;return n==null?void 0:n(((P=x==null?void 0:x.target)==null?void 0:P.value)||null)},disabled:i||b,className:`
            w-full px-3 py-2 border rounded-lg
            ${v?"border-red-500":"border-gray-300"}
            ${i||b?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:c}),r==null?void 0:r.map(x=>e.jsx("option",{value:(x==null?void 0:x[f])||(x==null?void 0:x.id),children:(x==null?void 0:x[p])||(x==null?void 0:x.label)||(x==null?void 0:x.name)},(x==null?void 0:x[f])||(x==null?void 0:x.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(ee,{name:"ChevronDown",size:16,className:"text-gray-400"})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]}):e.jsxs("div",{className:`relative ${y}`,ref:H,children:[e.jsxs("button",{type:"button",onClick:()=>!i&&!b&&O(!m),onKeyDown:A,disabled:i||b,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${v?"border-red-500":"border-gray-300"}
          ${i||b?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${m?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:le?"text-gray-900":"text-gray-500",children:le?(le==null?void 0:le[p])||(le==null?void 0:le.label):c}),e.jsxs("div",{className:"flex items-center space-x-1",children:[b&&e.jsx(ee,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),d&&le&&!b&&e.jsx("button",{type:"button",onClick:ye,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(ee,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(ee,{name:m?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),m&&typeof window<"u"&&e.jsx(xs,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>O(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${G==null?void 0:G.top}px`,left:`${G==null?void 0:G.left}px`,width:`${G==null?void 0:G.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:x=>x==null?void 0:x.stopPropagation(),children:[h&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:a,onChange:x=>{var P;return D((P=x==null?void 0:x.target)==null?void 0:P.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(q==null?void 0:q.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:a?"No results found":"No options available"}):q==null?void 0:q.map(x=>e.jsx("button",{type:"button",onClick:()=>je(x),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${Z(x)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(x==null?void 0:x[p])||(x==null?void 0:x.label)||(x==null?void 0:x.name)},(x==null?void 0:x[f])||(x==null?void 0:x.id)))})]})})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]})},ms=({isOpen:r,dealId:u,deal:n,onClose:c,onSuccess:h})=>{var Y,B,J,ie,me,be,ue;const[d,i]=$.useState(!0),[b,v]=$.useState(!1),[y,p]=$.useState(""),[f,R]=$.useState(!1),[Q,z]=$.useState(!1),[S,m]=$.useState(!1),[O,a]=$.useState(!1),[D,j]=$.useState(null),[F,q]=$.useState(null),[V,w]=$.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:M,deliveryCoordinatorOptions:G,financeManagerOptions:xe,vendorOptions:H,productOptions:ce,loading:le,refresh:Z}=hs(),[_,A]=$.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]});$.useEffect(()=>{if(D){const o=JSON.stringify(_)!==JSON.stringify(D);m(o)}},[_,D]),$.useEffect(()=>{if(r)try{Z==null||Z()}catch{}},[r,Z]),$.useEffect(()=>{var o;if(r)if(n&&(n!=null&&n.id))try{const t=qe(n),N={...t,assignedTo:(t==null?void 0:t.assigned_to)||null,deliveryCoordinator:(t==null?void 0:t.delivery_coordinator_id)||null,financeManager:(t==null?void 0:t.finance_manager_id)||null,vendor_id:(t==null?void 0:t.vendor_id)||null,customerName:(n==null?void 0:n.customer_name)||"",customerPhone:(n==null?void 0:n.customer_phone)||"",customerEmail:(n==null?void 0:n.customer_email)||"",lineItems:((o=(t==null?void 0:t.lineItems)||[])==null?void 0:o.length)>0?P(t==null?void 0:t.lineItems):[l()]};A(N),j(JSON.parse(JSON.stringify(N))),i(!1),p("")}catch(t){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",t),W()}else u?W():(p("No deal selected to edit."),i(!1))},[r,u,n==null?void 0:n.id]),$.useEffect(()=>{if(!r||!d)return;const o=setTimeout(()=>{i(!1),p(t=>t||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(o)},[r,d]);const je=({checked:o,onChange:t})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!o,onChange:N=>{var T;return t(!!((T=N==null?void 0:N.target)!=null&&T.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),ye=({value:o,selectedValue:t,onChange:N,itemIndex:T,disabled:te=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${T}`,value:"in_house",checked:!t,onChange:()=>N(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:te}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏠 On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${T}`,value:"vendor",checked:t,onChange:()=>N(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:te}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏢 Off-Site"})]})]}),x=({requiresScheduling:o,onChange:t,itemIndex:N,disabled:T=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${N}`,checked:o===!0,onChange:()=>t(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:T}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${N}`,checked:o===!1,onChange:()=>t(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:T}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),P=(o=[])=>(o||[]).map(t=>({product_id:(t==null?void 0:t.product_id)??null,unit_price:(t==null?void 0:t.unit_price)??0,quantity_used:(t==null?void 0:t.quantity_used)??1,lineItemPromisedDate:(t==null?void 0:t.lineItemPromisedDate)||(t==null?void 0:t.promised_date)||"",requiresScheduling:typeof(t==null?void 0:t.requiresScheduling)=="boolean"?t==null?void 0:t.requiresScheduling:!!(t!=null&&t.requires_scheduling),noScheduleReason:(t==null?void 0:t.noScheduleReason)||(t==null?void 0:t.no_schedule_reason)||"",isOffSite:typeof(t==null?void 0:t.isOffSite)=="boolean"?t==null?void 0:t.isOffSite:!!(t!=null&&t.is_off_site),description:(t==null?void 0:t.description)||""})),W=async()=>{var o,t,N,T,te,C,I,U,de,$e;try{i(!0),p("");const _e=await Qe(u),oe=qe(_e),{data:pe}=await((T=(N=(t=(o=K)==null?void 0:o.from("transactions"))==null?void 0:t.select("customer_name, customer_phone, customer_email"))==null?void 0:N.eq("job_id",u))==null?void 0:T.single());let ge=null;try{const{data:ve}=await((de=(U=(I=(C=(te=K)==null?void 0:te.from("loaner_assignments"))==null?void 0:C.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:I.eq("job_id",u))==null?void 0:U.is("returned_at",null))==null?void 0:de.limit(1));ge=Array.isArray(ve)?ve[0]:ve}catch{}const we={...oe,assignedTo:(oe==null?void 0:oe.assigned_to)||null,deliveryCoordinator:(oe==null?void 0:oe.delivery_coordinator_id)||null,financeManager:(oe==null?void 0:oe.finance_manager_id)||null,vendor_id:(oe==null?void 0:oe.vendor_id)||null,customerName:(pe==null?void 0:pe.customer_name)||"",customerPhone:(pe==null?void 0:pe.customer_phone)||"",customerEmail:(pe==null?void 0:pe.customer_email)||"",lineItems:(($e=(oe==null?void 0:oe.lineItems)||[])==null?void 0:$e.length)>0?P(oe==null?void 0:oe.lineItems):[l()]};if(A(we),j(JSON.parse(JSON.stringify(we))),q(ge||null),ge)w({loaner_number:(ge==null?void 0:ge.loaner_number)||"",eta_return_date:(ge==null?void 0:ge.eta_return_date)||"",notes:(ge==null?void 0:ge.notes)||""});else{const ve=((we==null?void 0:we.lineItems)||[]).filter(fe=>(fe==null?void 0:fe.requiresScheduling)&&(fe==null?void 0:fe.lineItemPromisedDate)).map(fe=>new Date(fe.lineItemPromisedDate).getTime()),Me=ve!=null&&ve.length?new Date(Math.max(...ve)):null;w(fe=>({...fe,eta_return_date:Me?Me.toISOString().split("T")[0]:""}))}}catch(_e){p(`Failed to load deal: ${_e==null?void 0:_e.message}`)}finally{i(!1)}},l=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),g=o=>{A(t=>({...t,...o}))},k=(o,t)=>{if(A(N=>{var T;return{...N,lineItems:(T=N==null?void 0:N.lineItems)==null?void 0:T.map((te,C)=>{if(C===o){let I={...te,...t};return"requiresScheduling"in t&&(I.requiresScheduling=!!(t!=null&&t.requiresScheduling),(t==null?void 0:t.requiresScheduling)===!0?I.noScheduleReason="":I.lineItemPromisedDate=""),"isOffSite"in t&&(I.isOffSite=!!(t!=null&&t.isOffSite),t!=null&&t.isOffSite||(I.vendorId="")),I}return te})}}),t!=null&&t.product_id){const N=ce==null?void 0:ce.find(T=>(T==null?void 0:T.id)===(t==null?void 0:t.product_id));N&&A(T=>{var te;return{...T,lineItems:(te=T==null?void 0:T.lineItems)==null?void 0:te.map((C,I)=>I===o?{...C,unit_price:(N==null?void 0:N.unitPrice)||(N==null?void 0:N.unit_price)||(C==null?void 0:C.unit_price),cost_price:(N==null?void 0:N.cost)||(C==null?void 0:C.cost_price)}:C)}})}},re=()=>{A(o=>({...o,lineItems:[...o==null?void 0:o.lineItems,l()]}))},ne=o=>{A(t=>{var N;return{...t,lineItems:(N=t==null?void 0:t.lineItems)==null?void 0:N.filter((T,te)=>te!==o)}})},se=async()=>{var o,t,N,T,te;try{if(v(!0),p(""),!((o=_==null?void 0:_.customerName)!=null&&o.trim())){p("Customer name is required");return}for(let U=0;U<((t=_==null?void 0:_.lineItems)==null?void 0:t.length);U++){const de=(N=_==null?void 0:_.lineItems)==null?void 0:N[U];if(!(de!=null&&de.product_id)){p(`Line item ${U+1}: Product is required`);return}if(de!=null&&de.requiresScheduling&&!(de!=null&&de.lineItemPromisedDate)){p(`Line item ${U+1}: Promised date is required when scheduling is needed`);return}if(!(de!=null&&de.requiresScheduling)&&!((T=de==null?void 0:de.noScheduleReason)!=null&&T.trim())){p(`Line item ${U+1}: Reason is required when no scheduling is needed`);return}}const C={..._,customer_needs_loaner:!!(_!=null&&_.customer_needs_loaner),lineItems:(te=_==null?void 0:_.lineItems)==null?void 0:te.map(U=>({...U,requiresScheduling:!!(U!=null&&U.requiresScheduling),isOffSite:!!(U!=null&&U.isOffSite),unit_price:parseFloat(U==null?void 0:U.unit_price)||0,quantity_used:parseInt(U==null?void 0:U.quantity_used)||1}))},I={...C,assigned_to:(C==null?void 0:C.assignedTo)??null,delivery_coordinator_id:(C==null?void 0:C.deliveryCoordinator)??null,finance_manager_id:(C==null?void 0:C.financeManager)??null,vendor_id:(C==null?void 0:C.vendor_id)??null};await De(u,{...I,loanerForm:V}),h==null||h(),c==null||c()}catch(C){p(`Failed to save deal: ${C==null?void 0:C.message}`)}finally{v(!1)}},ae=async()=>{try{z(!0),await es(u),h==null||h(),c==null||c()}catch(o){p(`Failed to delete deal: ${o==null?void 0:o.message}`)}finally{z(!1),R(!1)}},E=()=>{S?a(!0):c()},s=()=>{a(!1),c()},L=()=>{var o;return((o=_==null?void 0:_.lineItems)==null?void 0:o.reduce((t,N)=>{const T=parseFloat(N==null?void 0:N.unit_price)||0,te=parseInt(N==null?void 0:N.quantity_used)||1;return t+T*te},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:E,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(ee,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[y&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:y})}),le&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-blue-800 text-sm",children:"Loading dropdown data..."})}),d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{W();try{Z==null||Z()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ee,{value:_==null?void 0:_.job_status,onChange:o=>{var t;return g({job_status:(t=o==null?void 0:o.target)==null?void 0:t.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(he,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:_==null?void 0:_.customerName,onChange:o=>{var t;return g({customerName:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(he,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:_==null?void 0:_.customerPhone,onChange:o=>{var t;return g({customerPhone:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(he,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:_==null?void 0:_.customerEmail,onChange:o=>{var t;return g({customerEmail:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ee,{value:_==null?void 0:_.priority,onChange:o=>{var t;return g({priority:(t=o==null?void 0:o.target)==null?void 0:t.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(he,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(_==null?void 0:_.vehicleYear)||"",onChange:o=>{var t;return g({vehicleYear:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"2024",min:"1900",max:((Y=new Date)==null?void 0:Y.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(he,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(_==null?void 0:_.vehicleMake)||"",onChange:o=>{var t;return g({vehicleMake:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(he,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(_==null?void 0:_.vehicleModel)||"",onChange:o=>{var t;return g({vehicleModel:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(he,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(_==null?void 0:_.stockNumber)||"",onChange:o=>{var t;return g({stockNumber:(t=o==null?void 0:o.target)==null?void 0:t.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(je,{checked:_==null?void 0:_.customer_needs_loaner,onChange:o=>{if(g({customer_needs_loaner:o}),o&&!(V!=null&&V.eta_return_date)){const t=((_==null?void 0:_.lineItems)||[]).filter(T=>(T==null?void 0:T.requiresScheduling)&&(T==null?void 0:T.lineItemPromisedDate)).map(T=>new Date(T.lineItemPromisedDate).getTime()),N=t!=null&&t.length?new Date(Math.max(...t)):null;N&&w(T=>({...T,eta_return_date:N.toISOString().split("T")[0]}))}}}),F&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",F==null?void 0:F.loaner_number,(F==null?void 0:F.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["• due"," ",(B=new Date(F==null?void 0:F.eta_return_date))==null?void 0:B.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(_==null?void 0:_.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(he,{id:"loaner-number","aria-label":"Loaner number",value:(V==null?void 0:V.loaner_number)||"",onChange:o=>w(t=>{var N;return{...t,loaner_number:(N=o==null?void 0:o.target)==null?void 0:N.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(he,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(V==null?void 0:V.eta_return_date)||"",onChange:o=>w(t=>{var N;return{...t,eta_return_date:(N=o==null?void 0:o.target)==null?void 0:N.value}}),min:(me=(ie=(J=new Date)==null?void 0:J.toISOString())==null?void 0:ie.split("T"))==null?void 0:me[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(he,{id:"loaner-notes","aria-label":"Loaner notes",value:(V==null?void 0:V.notes)||"",onChange:o=>w(t=>{var N;return{...t,notes:(N=o==null?void 0:o.target)==null?void 0:N.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsx("div",{className:"mb-4","data-testid":"vendor-select",children:e.jsx(Se,{label:"Vendor",options:H,value:(_==null?void 0:_.vendor_id)||"",onChange:o=>g({vendor_id:o||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"})}),e.jsx("div",{className:"mb-4","data-testid":"sales-select",children:e.jsx(Se,{label:"Sales Consultant",options:M,value:_==null?void 0:_.assignedTo,onChange:o=>g({assignedTo:o}),placeholder:"Select sales consultant",searchable:!0,clearable:!0})}),e.jsx("div",{className:"mb-4","data-testid":"delivery-select",children:e.jsx(Se,{label:"Delivery Coordinator",options:G,value:_==null?void 0:_.deliveryCoordinator,onChange:o=>g({deliveryCoordinator:o}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0})}),e.jsx("div",{"data-testid":"finance-select",children:e.jsx(Se,{label:"Finance Manager",options:xe,value:_==null?void 0:_.financeManager,onChange:o=>g({financeManager:o}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(X,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:re,children:[e.jsx(ee,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(be=_==null?void 0:_.lineItems)==null?void 0:be.map((o,t)=>{var N,T,te,C;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",t+1]}),((N=_==null?void 0:_.lineItems)==null?void 0:N.length)>1&&e.jsx(X,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>ne(t),children:e.jsx(ee,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Se,{label:"Product *",options:ce,value:(o==null?void 0:o.product_id)||"",onChange:I=>k(t,{product_id:I?parseInt(I):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(he,{id:`unit-price-${t}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:o==null?void 0:o.unit_price,onChange:I=>{var U;return k(t,{unit_price:parseFloat((U=I==null?void 0:I.target)==null?void 0:U.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(he,{id:`quantity-${t}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:o==null?void 0:o.quantity_used,onChange:I=>{var U;return k(t,{quantity_used:parseInt((U=I==null?void 0:I.target)==null?void 0:U.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(ye,{selectedValue:o==null?void 0:o.isOffSite,onChange:I=>k(t,{isOffSite:I}),itemIndex:t})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(x,{requiresScheduling:o==null?void 0:o.requiresScheduling,onChange:I=>k(t,{requiresScheduling:I}),itemIndex:t})}),o!=null&&o.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(he,{id:`promised-date-${t}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:o==null?void 0:o.lineItemPromisedDate,onChange:I=>{var U;return k(t,{lineItemPromisedDate:(U=I==null?void 0:I.target)==null?void 0:U.value})},min:(C=(te=(T=new Date)==null?void 0:T.toISOString())==null?void 0:te.split("T"))==null?void 0:C[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(he,{id:`notes-${t}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(o==null?void 0:o.description)||"",onChange:I=>{var U;return k(t,{description:(U=I==null?void 0:I.target)==null?void 0:U.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(he,{id:`no-schedule-reason-${t}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:o==null?void 0:o.noScheduleReason,onChange:I=>{var U;return k(t,{noScheduleReason:(U=I==null?void 0:I.target)==null?void 0:U.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(o==null?void 0:o.unit_price)||0)*(parseInt(o==null?void 0:o.quantity_used)||1)).toFixed(2)]})]},t)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(ue=L())==null?void 0:ue.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(X,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>R(!0),children:[e.jsx(ee,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(X,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:E,children:"Cancel"}),e.jsx(X,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:se,disabled:b,children:b?"Saving...":"Save Changes"})]})]}),f&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(X,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>R(!1),children:"Cancel"}),e.jsx(X,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:ae,disabled:Q,children:Q?"Deleting...":"Delete"})]})]})}),O&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(X,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>a(!1),children:"Keep Editing"}),e.jsx(X,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:s,children:"Discard Changes"})]})]})})]})}):null},gs=({status:r})=>{var h;const u={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},n=(u==null?void 0:u[r])||"bg-gray-100 text-gray-700",c=((h=r==null?void 0:r.replace("_"," "))==null?void 0:h.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${n}`,children:c})},ze=({nextPromisedShort:r})=>{if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"—"});const u=new Date(r),n=new Date;n==null||n.setHours(0,0,0,0),u==null||u.setHours(0,0,0,0);const c=new Date(n);c==null||c.setDate((n==null?void 0:n.getDate())+2);let h="";return u<n?h="bg-red-100 text-red-800 border-red-200":u<=c?h="bg-amber-100 text-amber-800 border-amber-200":h="bg-green-100 text-green-800 border-green-200",e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${h}`,children:["Next: ",r]})},Ae=({serviceType:r,jobParts:u})=>{const n=u==null?void 0:u.some(h=>h==null?void 0:h.is_off_site),c=u==null?void 0:u.some(h=>!(h!=null&&h.is_off_site));return n&&c?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})]}):n?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})},bs=({draftsCount:r,onViewDrafts:u})=>{const[n,c]=$.useState(!1);return r===0||n?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ee,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft – needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{size:"sm",variant:"ghost",onClick:u,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>c(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(ee,{name:"X",size:16})})]})]})})},Ce=r=>r?r!=null&&r.job_number?r.job_number:r!=null&&r.id?`Job-${String(r.id).slice(0,8)}`:"—":"—",He=r=>r&&(r==null?void 0:r.customer_name)||"",Re=({deal:r})=>!(r!=null&&r.customer_name)&&!(r!=null&&r.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"—"}):e.jsxs("div",{className:"space-y-1",children:[(r==null?void 0:r.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:r==null?void 0:r.customer_name}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:u=>u==null?void 0:u.stopPropagation(),children:r==null?void 0:r.customer_phone})]}),Fe=({amount:r})=>{var n;const u=parseFloat(r)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(n=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:n.format(u)})})},fs=({deal:r})=>r!=null&&r.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",r==null?void 0:r.loaner_number,(r==null?void 0:r.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["• due ",r==null?void 0:r.loaner_eta_short]})]}):null,js=({isOpen:r,onClose:u,deal:n,onSave:c,loading:h})=>{var p,f,R,Q;const[d,i]=$.useState({loaner_number:"",eta_return_date:"",notes:""}),[b,v]=$.useState("");$.useEffect(()=>{if(r&&n){let z="";try{const S=((n==null?void 0:n.job_parts)||[]).filter(m=>(m==null?void 0:m.requires_scheduling)&&(m==null?void 0:m.promised_date)).map(m=>new Date(m.promised_date));(S==null?void 0:S.length)>0&&(z=new Date(Math.max.apply(null,S)).toISOString().split("T")[0])}catch{}i({loaner_number:(n==null?void 0:n.loaner_number)||"",eta_return_date:(n==null?void 0:n.loaner_eta_return_date)||z||"",notes:(n==null?void 0:n.loaner_notes)||""}),v("")}else r||(i({loaner_number:"",eta_return_date:"",notes:""}),v(""))},[r,n]);const y=async()=>{var z,S,m;if(v(""),!((z=d==null?void 0:d.loaner_number)!=null&&z.trim())){v("Loaner number is required");return}if(!(d!=null&&d.eta_return_date)){v("ETA return date is required");return}try{await c({job_id:n==null?void 0:n.id,loaner_number:(S=d==null?void 0:d.loaner_number)==null?void 0:S.trim(),eta_return_date:d==null?void 0:d.eta_return_date,notes:((m=d==null?void 0:d.notes)==null?void 0:m.trim())||null}),u()}catch(O){v((O==null?void 0:O.message)||"Failed to save loaner assignment")}};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:u}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(X,{variant:"ghost",size:"icon",onClick:u,"aria-label":"Close drawer",children:e.jsx(ee,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:Ce(n)}),e.jsx("p",{className:"text-xs text-slate-500",children:He(n)})]}),b&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:b}),e.jsx("button",{onClick:()=>v(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:d==null?void 0:d.loaner_number,onChange:z=>i(S=>{var m;return{...S,loaner_number:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:d==null?void 0:d.eta_return_date,onChange:z=>i(S=>{var m;return{...S,eta_return_date:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(R=(f=(p=new Date)==null?void 0:p.toISOString())==null?void 0:f.split("T"))==null?void 0:R[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:d==null?void 0:d.notes,onChange:z=>i(S=>{var m;return{...S,notes:(m=z==null?void 0:z.target)==null?void 0:m.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(X,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:h,children:"Cancel"}),e.jsx(X,{onClick:y,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:h||!((Q=d==null?void 0:d.loaner_number)!=null&&Q.trim())||!(d!=null&&d.eta_return_date),children:h?"Saving...":"Save Loaner"})]})]})})]}):null},ps=({loaner:r,onClose:u,onConfirm:n,loading:c})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(X,{variant:"outline",onClick:u,className:"flex-1 h-11",disabled:c,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(X,{onClick:n,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:c,"aria-label":"Confirm loaner returned",children:c?"Processing...":"Mark Returned"})]})]})})}):null;function $s(){var E;const[r,u]=$.useState([]),[n,c]=$.useState(!0),[h,d]=$.useState(!1),[i,b]=$.useState(!1),[v,y]=$.useState(null),[p,f]=$.useState(null),[R,Q]=$.useState(null),[z,S]=$.useState(""),[m,O]=$.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[a,D]=$.useState(!1),[j,F]=$.useState(null),[q,V]=$.useState(!1),[w,M]=$.useState(null),[G,xe]=$.useState(!1),[H,ce]=$.useState(""),{clearSearch:le,error:Z}=Xe({loadOnMount:!0});as();const{user:_}=Te(),A=async s=>{var L;try{S("");const{error:Y}=await((L=K)==null?void 0:L.rpc("delete_job_cascade",{p_job_id:s}));if(Y)throw Y;Q(null),await x()}catch(Y){S(`Failed to delete deal: ${Y==null?void 0:Y.message}`),console.error("Delete error:",Y)}},je=async s=>{var L,Y,B,J,ie,me,be,ue,o,t;try{V(!0),S("");let N=null;try{const{data:T}=await((ie=(J=(B=(Y=(L=K)==null?void 0:L.from("loaner_assignments"))==null?void 0:Y.select("id"))==null?void 0:B.eq("job_id",s==null?void 0:s.job_id))==null?void 0:J.is("returned_at",null))==null?void 0:ie.limit(1));N=Array.isArray(T)?T[0]:T}catch{}if(N!=null&&N.id){const{error:T}=await((ue=(be=(me=K)==null?void 0:me.from("loaner_assignments"))==null?void 0:be.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:ue.eq("id",N.id));if(T)throw T}else{const{error:T}=await((t=(o=K)==null?void 0:o.from("loaner_assignments"))==null?void 0:t.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(T)throw T}D(!1),F(null),await x()}catch(N){const T=`Failed to save loaner assignment: ${N==null?void 0:N.message}`;throw S(T),new Error(T)}finally{V(!1)}},ye=async s=>{try{xe(!0),S(""),await ss(s==null?void 0:s.loaner_id),M(null),await x()}catch(L){S(`Failed to mark loaner as returned: ${L==null?void 0:L.message}`),console.error("Mark returned error:",L)}finally{xe(!1)}},x=async(s=0)=>{var L,Y;try{c(!0),S("");const B=await rs();u(B||[])}catch(B){const J=`Failed to load deals: ${B==null?void 0:B.message}`;if(console.error("Load deals error:",B),s<2&&((L=B==null?void 0:B.message)!=null&&L.includes("fetch")||(Y=B==null?void 0:B.message)!=null&&Y.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>x(s+1),1e3*(s+1));return}S(J),u([])}finally{c(!1)}};$.useEffect(()=>{var Y;const s=new URLSearchParams(window.location.search),L=s==null?void 0:s.get("status");if(L){const B=((Y=L==null?void 0:L.charAt(0))==null?void 0:Y.toUpperCase())+(L==null?void 0:L.slice(1));O(J=>({...J,status:B}))}},[]),$.useEffect(()=>{x()},[]);const P=s=>{F(s),D(!0)},W=({message:s,onClose:L})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(ee,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),L&&e.jsx("button",{onClick:L,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(ee,{name:"X",size:16})})]})}):null,g=(s=>{var ue,o,t;const L=s||[],Y=((ue=L==null?void 0:L.filter(N=>(N==null?void 0:N.job_status)==="in_progress"))==null?void 0:ue.length)||0,B=L==null?void 0:L.reduce((N,T)=>{const te=parseFloat(T==null?void 0:T.total_amount)||0;return N+te},0),J=B*.25,ie=B>0?25:0,me=((o=L==null?void 0:L.filter(N=>(N==null?void 0:N.job_status)==="pending"))==null?void 0:o.length)||0,be=((t=L==null?void 0:L.filter(N=>(N==null?void 0:N.job_status)==="draft"))==null?void 0:t.length)||0;return{active:Y,revenue:(B==null?void 0:B.toFixed(2))||"0.00",profit:(J==null?void 0:J.toFixed(2))||"0.00",margin:(ie==null?void 0:ie.toFixed(1))||"0.0",pending:me,drafts:be}})(r),k=r==null?void 0:r.filter(s=>{var L,Y,B,J,ie;if((m==null?void 0:m.status)!=="All"){const me=(Y=(L=m==null?void 0:m.status)==null?void 0:L.toLowerCase())==null?void 0:Y.replace(" ","_");if((s==null?void 0:s.job_status)!==me)return!1}if(m!=null&&m.salesAssigned&&(s==null?void 0:s.assigned_to)!==(m==null?void 0:m.salesAssigned)||m!=null&&m.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(m==null?void 0:m.deliveryAssigned)||m!=null&&m.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(m==null?void 0:m.financeAssigned)||m!=null&&m.vendor&&(s==null?void 0:s.vendor_id)!==(m==null?void 0:m.vendor))return!1;if(H!=null&&H.trim()){const me=H==null?void 0:H.toLowerCase(),be=N=>(N==null?void 0:N.replace(/\D/g,""))||"",ue=be(me),o=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(B=s==null?void 0:s.vehicle)==null?void 0:B.make,(J=s==null?void 0:s.vehicle)==null?void 0:J.model,((ie=s==null?void 0:s.vehicle)==null?void 0:ie.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(o==null?void 0:o.some(N=>{var te;const T=N==null?void 0:N.toLowerCase();return!!(T!=null&&T.includes(me)||(ue==null?void 0:ue.length)>=3&&((te=be(T))!=null&&te.includes(ue)))})))return!1}return!0});$.useEffect(()=>{const s=setTimeout(()=>{ce(m==null?void 0:m.search)},300);return()=>clearTimeout(s)},[m==null?void 0:m.search]);const re=(s,L)=>{var Y,B;if(O(J=>({...J,[s]:L})),s==="status"){const J=new URLSearchParams(window.location.search);L==="All"?J==null||J.delete("status"):J==null||J.set("status",L==null?void 0:L.toLowerCase());const ie=`${(Y=window.location)==null?void 0:Y.pathname}${J!=null&&J.toString()?"?"+(J==null?void 0:J.toString()):""}`;(B=window.history)==null||B.replaceState({},"",ie)}},ne=()=>{var s,L;O({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),le(),(L=window.history)==null||L.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},se=s=>{var L;y(s);try{const Y=(L=k!=null&&k.length?k:r)==null?void 0:L.find(B=>(B==null?void 0:B.id)===s);f(Y||null)}catch{f(null)}b(!0)},ae=()=>{b(!1),y(null),f(null)};return n?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Pe,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Pe,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(W,{message:z||Z,onClose:()=>{S("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(os,{exportType:"jobs",filters:{status:m==null?void 0:m.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,L)=>console.log(`Export complete: ${s} records`),onExportError:s=>S(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(X,{onClick:()=>d(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(ee,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(bs,{draftsCount:g==null?void 0:g.drafts,onViewDrafts:()=>re("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(ee,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:g==null?void 0:g.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(ee,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",g==null?void 0:g.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(ee,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",g==null?void 0:g.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(ee,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[g==null?void 0:g.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(ee,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:g==null?void 0:g.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(ee,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:g==null?void 0:g.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>re("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(m==null?void 0:m.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ee,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:m==null?void 0:m.search,onChange:s=>{var L;return re("search",(L=s==null?void 0:s.target)==null?void 0:L.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(X,{variant:"ghost",size:"sm",onClick:ne,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(ee,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",k==null?void 0:k.length," of ",r==null?void 0:r.length," deals",((m==null?void 0:m.salesAssigned)||(m==null?void 0:m.deliveryAssigned)||(m==null?void 0:m.financeAssigned)||(m==null?void 0:m.vendor)||(m==null?void 0:m.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Next"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:k==null?void 0:k.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(Re,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Fe,{amount:s==null?void 0:s.total_amount})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(ze,{nextPromisedShort:s==null?void 0:s.next_promised_short})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ae,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(X,{size:"sm",variant:"ghost",onClick:()=>se(s==null?void 0:s.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(X,{size:"sm",variant:"ghost",onClick:()=>P(s),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(X,{size:"sm",variant:"ghost",onClick:()=>M({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Ce(s)}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(X,{size:"sm",variant:"ghost",onClick:()=>Q(s),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(k==null?void 0:k.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(m==null?void 0:m.status)==="All"?"No deals found":`No ${(E=m==null?void 0:m.status)==null?void 0:E.toLowerCase()} deals found`})}):k==null?void 0:k.map(s=>e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Ce(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:He(s)||"—"})]}),e.jsx(gs,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((s==null?void 0:s.customer_name)||(s==null?void 0:s.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(Re,{deal:s})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(Fe,{amount:s==null?void 0:s.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(ze,{nextPromisedShort:s==null?void 0:s.next_promised_short})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(Ae,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})]}),(s==null?void 0:s.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(fs,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(X,{size:"sm",variant:"outline",onClick:()=>se(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(ee,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(X,{size:"sm",variant:"outline",onClick:()=>Q(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(ee,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(X,{size:"sm",variant:"outline",onClick:()=>P(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(ee,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(X,{size:"sm",variant:"outline",onClick:()=>P(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(ee,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(X,{size:"sm",variant:"outline",onClick:()=>M({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Ce(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(ee,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id))}),e.jsx(is,{isOpen:h,onClose:()=>d(!1),onSuccess:x}),e.jsx(ms,{isOpen:i,dealId:v,deal:p,onClose:ae,onSuccess:()=>{x(),ae()}}),R&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(X,{variant:"outline",onClick:()=>Q(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(X,{onClick:()=>A(R==null?void 0:R.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(js,{isOpen:a,onClose:()=>{D(!1),F(null),S("")},deal:j,onSave:je,loading:q}),e.jsx(ps,{loaner:w,onClose:()=>{M(null),S("")},onConfirm:()=>ye(w),loading:G})]})]})}export{$s as default};
//# sourceMappingURL=index-CQP6jdmS.js.map
