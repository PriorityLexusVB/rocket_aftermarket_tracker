import{s as h}from"./index-Z7SfelWm.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const D=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function b(e,n){const s={};return n==null||n.forEach(c=>{(e==null?void 0:e[c])!==void 0&&(s[c]=e==null?void 0:e[c])}),s}function ee(e){const n=b(e||{},D);return Object.keys(n).forEach(s=>{n[s]===""&&(n[s]=null)}),n}function Y(){const e=Date.now(),n=Math.floor(Math.random()*1e4);return`TXN-${e}-${n}`}async function ne(e){var c,t,d,m;const{data:n,error:s}=await((m=(d=(t=(c=h)==null?void 0:c.from("jobs"))==null?void 0:t.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, updated_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:d.eq("id",e))==null?void 0:m.single());if(s)throw new Error(`Failed to load deal: ${s.message}`);return n}function Z(e={}){var w,E,k,I,g,P,y,i,p;const n=ee(e||{}),s=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),c=s?{...n,org_id:s}:n;{const r=((e==null?void 0:e.description)||"").trim();r?c.title=r:c!=null&&c.title||(c!=null&&c.job_number?c.title=`Deal ${c.job_number}`:c.title="Untitled Deal")}const d=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(r=>{const q=(r==null?void 0:r.requires_scheduling)??(r==null?void 0:r.requiresScheduling)??!0,C=(r==null?void 0:r.no_schedule_reason)||(r==null?void 0:r.noScheduleReason)||null,A=(r==null?void 0:r.promised_date)||(r==null?void 0:r.lineItemPromisedDate)||null,B=(r==null?void 0:r.is_off_site)??(r==null?void 0:r.isOffSite)??!1;return{product_id:r.product_id??null,quantity_used:Number(r.quantity_used??r.quantity??1),unit_price:Number(r.unit_price??r.price??0),promised_date:A,requires_scheduling:!!q,no_schedule_reason:q?null:C,is_off_site:!!B,lineItemPromisedDate:A,requiresScheduling:!!q,noScheduleReason:q?null:C,isOffSite:!!B}});for(const r of d)if((Number.isNaN(r.quantity_used)||r.quantity_used==null)&&(r.quantity_used=1),(Number.isNaN(r.unit_price)||r.unit_price==null)&&(r.unit_price=0),!r.requires_scheduling&&!String(r.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((d==null?void 0:d.length)||0)>0&&!d.some(q=>!!q.product_id))throw new Error("At least one product is required");const m=(d||[]).map(r=>({product_id:r.product_id,quantity:Number(r.quantity_used??1),unit_price:Number(r.unit_price??0),total_price:Number(r.unit_price??0)*Number(r.quantity_used??1),quantity_used:r.quantity_used,promised_date:r.promised_date,requires_scheduling:r.requires_scheduling,no_schedule_reason:r.no_schedule_reason,is_off_site:r.is_off_site})),a=(e==null?void 0:e.loanerForm)||null,N=((w=e==null?void 0:e.customerName)==null?void 0:w.trim())||((k=(E=e==null?void 0:e.customer_name)==null?void 0:E.trim)==null?void 0:k.call(E))||"",F=((I=e==null?void 0:e.customerPhone)==null?void 0:I.trim())||((P=(g=e==null?void 0:e.customer_phone)==null?void 0:g.trim)==null?void 0:P.call(g))||"",$=((y=e==null?void 0:e.customerEmail)==null?void 0:y.trim())||((p=(i=e==null?void 0:e.customer_email)==null?void 0:i.trim)==null?void 0:p.call(i))||"";return{payload:c,normalizedLineItems:d,jobPayload:c,jobParts:m,loanerForm:a,customerName:N,customerPhone:F,customerEmail:$}}function S(e,n=[]){var s,c;return(c=(s=n||[])==null?void 0:s.map(t=>({job_id:e,product_id:(t==null?void 0:t.product_id)??null,quantity_used:(t==null?void 0:t.quantity_used)??(t==null?void 0:t.quantity)??1,unit_price:(t==null?void 0:t.unit_price)??(t==null?void 0:t.price)??0,promised_date:(t==null?void 0:t.lineItemPromisedDate)||(t!=null&&t.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(t!=null&&t.requiresScheduling),no_schedule_reason:t!=null&&t.requiresScheduling?null:(t==null?void 0:t.noScheduleReason)||null,is_off_site:!!(t!=null&&t.isOffSite)})))==null?void 0:c.filter(t=>(t==null?void 0:t.product_id)!==null||(t==null?void 0:t.quantity_used)||(t==null?void 0:t.unit_price))}async function j(e,n){var s,c,t,d,m,a,N,F,$,w,E,k,I;if((s=n==null?void 0:n.loaner_number)!=null&&s.trim())try{const{data:g}=await((a=(m=(d=(t=(c=h)==null?void 0:c.from("loaner_assignments"))==null?void 0:t.select("id"))==null?void 0:d.eq("job_id",e))==null?void 0:m.is("returned_at",null))==null?void 0:a.single()),P={job_id:e,loaner_number:(N=n==null?void 0:n.loaner_number)==null?void 0:N.trim(),eta_return_date:(n==null?void 0:n.eta_return_date)||null,notes:((F=n==null?void 0:n.notes)==null?void 0:F.trim())||null};if(g){const{error:y}=await((E=(w=($=h)==null?void 0:$.from("loaner_assignments"))==null?void 0:w.update(P))==null?void 0:E.eq("id",g==null?void 0:g.id));if(y)throw y}else{const{error:y}=await((I=(k=h)==null?void 0:k.from("loaner_assignments"))==null?void 0:I.insert([P]));if(y)throw y}}catch(g){throw(g==null?void 0:g.code)==="23505"?new Error(`Loaner ${n==null?void 0:n.loaner_number} is already assigned to another active job`):g}}async function re(){var e,n,s,c,t,d,m,a,N,F,$;try{const{data:w,error:E}=await((c=(s=(n=(e=h)==null?void 0:e.from("jobs"))==null?void 0:n.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        scheduled_start_time, scheduled_end_time,
        vehicle:vehicles(year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:s.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:c.order("created_at",{ascending:!1}));if(E)throw E;const k=(w==null?void 0:w.map(i=>i==null?void 0:i.id))||[],[I,g]=await Promise.all([(m=(d=(t=h)==null?void 0:t.from("transactions"))==null?void 0:d.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:m.in("job_id",k),($=(F=(N=(a=h)==null?void 0:a.from("loaner_assignments"))==null?void 0:N.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:F.in("job_id",k))==null?void 0:$.is("returned_at",null)]),P=(I==null?void 0:I.data)||[],y=(g==null?void 0:g.data)||[];return(w==null?void 0:w.map(i=>{var x,z,o,l,L,M,K,_,f,T;const p=P==null?void 0:P.find(u=>(u==null?void 0:u.job_id)===(i==null?void 0:i.id)),r=y==null?void 0:y.find(u=>(u==null?void 0:u.job_id)===(i==null?void 0:i.id)),q=((x=i==null?void 0:i.job_parts)==null?void 0:x.filter(u=>(u==null?void 0:u.requires_scheduling)&&(u==null?void 0:u.promised_date)))||[],C=(q==null?void 0:q.length)>0?(o=(z=q==null?void 0:q.sort((u,O)=>new Date(u.promised_date)-new Date(O.promised_date)))==null?void 0:z[0])==null?void 0:o.promised_date:null,A=i!=null&&i.created_at?new Date(i.created_at):null,V=A?Math.max(0,Math.floor((new Date-A)/(1e3*60*60*24))):null,J=(p==null?void 0:p.customer_phone)||"",v=(J||"").replace(/\D/g,""),W=(v==null?void 0:v.slice(-4))||"",X=(v==null?void 0:v.length)===11&&v.startsWith("1")?`+${v}`:(v==null?void 0:v.length)===10?`+1${v}`:J||"",R=(i==null?void 0:i.scheduled_start_time)||null,G=(i==null?void 0:i.scheduled_end_time)||null,H=((i==null?void 0:i.job_parts)||[]).map(u=>{var O,U;return((O=u==null?void 0:u.product)==null?void 0:O.category)||((U=u==null?void 0:u.product)==null?void 0:U.name)||""}).map(u=>{const O=(u||"").toLowerCase();return/ppf|paint protection/.test(O)?"PPF":/tint|window/.test(O)?"Tint":/ceramic/.test(O)?"Ceramic":/detail|wash|interior|exterior/.test(O)?"Detail":null}).filter(Boolean).filter((u,O,U)=>U.indexOf(u)===O);return{...i,customer_name:(p==null?void 0:p.customer_name)||"",customer_phone:(p==null?void 0:p.customer_phone)||"",customer_phone_e164:X,customer_phone_last4:W,customer_email:(p==null?void 0:p.customer_email)||"",total_amount:(p==null?void 0:p.total_amount)||0,has_active_loaner:!!(r!=null&&r.id),next_promised_iso:C||null,loaner_id:(r==null?void 0:r.id)||null,loaner_number:(r==null?void 0:r.loaner_number)||null,loaner_eta_short:r!=null&&r.eta_return_date?(l=new Date(r==null?void 0:r.eta_return_date))==null?void 0:l.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_eta_return_date:(r==null?void 0:r.eta_return_date)||null,age_days:V,appt_start:R,appt_end:G,vendor_name:((L=i==null?void 0:i.vendor)==null?void 0:L.name)||null,work_tags:H,vehicle:i!=null&&i.vehicle_id&&(i!=null&&i.vehicle)?{year:(M=i==null?void 0:i.vehicle)==null?void 0:M.year,make:(K=i==null?void 0:i.vehicle)==null?void 0:K.make,model:(_=i==null?void 0:i.vehicle)==null?void 0:_.model,stock_number:(f=i==null?void 0:i.vehicle)==null?void 0:f.stock_number}:null,stock_no:(T=i==null?void 0:i.vehicle)==null?void 0:T.stock_number}}))||[]}catch(w){throw console.error("Failed to load deals:",w),new Error(`Failed to load deals: ${w==null?void 0:w.message}`)}}async function Q(e){var n,s,c,t;try{const d=await ne(e),{data:m}=await((t=(c=(s=(n=h)==null?void 0:n.from("transactions"))==null?void 0:s.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:c.eq("job_id",e))==null?void 0:t.single());return{...d,customer_name:(m==null?void 0:m.customer_name)||"",customer_phone:(m==null?void 0:m.customer_phone)||"",customer_email:(m==null?void 0:m.customer_email)||"",total_amount:(m==null?void 0:m.total_amount)||0}}catch(d){throw console.error("[dealService:get] Failed to get deal:",d),new Error(`Failed to load deal: ${d==null?void 0:d.message}`)}}async function se(e){var F,$,w,E,k,I,g,P,y,i,p,r,q,C,A,B,V,J,v,W,X,R,G,H,x,z,o,l,L,M,K;const{payload:n,normalizedLineItems:s,loanerForm:c,customerName:t,customerPhone:d,customerEmail:m}=Z(e||{});if(!(n!=null&&n.org_id))try{const{data:_}=await((w=($=(F=h)==null?void 0:F.auth)==null?void 0:$.getUser)==null?void 0:w.call($)),f=(E=_==null?void 0:_.user)==null?void 0:E.id;if(f){const{data:T}=await((P=(g=(I=(k=h)==null?void 0:k.from("user_profiles"))==null?void 0:I.select("org_id"))==null?void 0:g.eq("id",f))==null?void 0:P.single());T!=null&&T.org_id&&(n.org_id=T.org_id)}}catch(_){console.warn("[dealService:create] Unable to infer org_id from profile:",_==null?void 0:_.message)}if(!(n!=null&&n.job_number)){const _=Date.now(),f=Math.floor(Math.random()*1e4);n.job_number=`JOB-${_}-${f}`}n!=null&&n.vendor_id&&!(n!=null&&n.scheduled_start_time)&&(n.scheduled_start_time=new Date().toISOString());try{const _=Array.from(new Set((s||[]).map(f=>f!=null&&f.product_id?String(f.product_id):null).filter(Boolean)));if(_.length){const{data:f,error:T}=await((p=(i=(y=h)==null?void 0:y.from("products"))==null?void 0:i.select("id"))==null?void 0:p.in("id",_));if(T)throw T;const u=new Set((f||[]).map(U=>String(U.id)));if(_.filter(U=>!u.has(String(U))).length)throw new Error("One or more selected products no longer exist. Please re-select a valid product.")}}catch(_){throw new Error(`Failed to create deal: ${(_==null?void 0:_.message)||_}`)}const{data:a,error:N}=await((A=(C=(q=(r=h)==null?void 0:r.from("jobs"))==null?void 0:q.insert([n]))==null?void 0:C.select("id"))==null?void 0:A.single());if(N)throw new Error(`Failed to create deal: ${N.message}`);try{if((s||[]).length>0){const _=S(a==null?void 0:a.id,s);if((_==null?void 0:_.length)>0){const{error:f}=await((V=(B=h)==null?void 0:B.from("job_parts"))==null?void 0:V.insert(_));if(f)throw f}}n!=null&&n.customer_needs_loaner&&c&&await j(a==null?void 0:a.id,c);try{const _={job_id:a==null?void 0:a.id,vehicle_id:(n==null?void 0:n.vehicle_id)||null,total_amount:(s||[]).reduce((T,u)=>{const O=Number((u==null?void 0:u.quantity_used)||(u==null?void 0:u.quantity)||1),U=Number((u==null?void 0:u.unit_price)||(u==null?void 0:u.price)||0);return T+O*U},0)||0,customer_name:t||"Unknown Customer",customer_phone:d||null,customer_email:m||null,transaction_status:"pending",transaction_number:Y()},{data:f}=await((G=(R=(X=(W=(v=(J=h)==null?void 0:J.from("transactions"))==null?void 0:v.select("id"))==null?void 0:W.eq("job_id",a==null?void 0:a.id))==null?void 0:X.limit(1))==null?void 0:R.maybeSingle)==null?void 0:G.call(R));f!=null&&f.id||await((x=(H=h)==null?void 0:H.from("transactions"))==null?void 0:x.insert([_]))}catch(_){console.warn("[dealService:create] pre-create transaction insert skipped:",_==null?void 0:_.message)}try{return await Q(a==null?void 0:a.id)}catch(_){return console.warn("[dealService:create] getDeal fallback due to error:",_==null?void 0:_.message),{id:a==null?void 0:a.id}}}catch(_){console.error("[dealService:create] Failed to create deal:",_);try{await((l=(o=(z=h)==null?void 0:z.from("job_parts"))==null?void 0:o.delete())==null?void 0:l.eq("job_id",a==null?void 0:a.id))}catch{}try{await((K=(M=(L=h)==null?void 0:L.from("jobs"))==null?void 0:M.delete())==null?void 0:K.eq("id",a==null?void 0:a.id))}catch{}throw new Error(`Failed to create deal: ${_.message}`)}}async function te(e,n){var E,k,I,g,P,y,i,p,r,q,C,A,B,V,J,v,W,X,R,G,H,x,z;const{payload:s,normalizedLineItems:c,loanerForm:t,customerName:d,customerPhone:m,customerEmail:a}=Z(n||{});{const o=((n==null?void 0:n.description)||"").trim();o&&(s.description=o)}const N=(c||[]).reduce((o,l)=>{const L=Number((l==null?void 0:l.quantity_used)||(l==null?void 0:l.quantity)||1),M=Number((l==null?void 0:l.unit_price)||(l==null?void 0:l.price)||0);return o+L*M},0)||0;let F;try{let o=(I=(k=(E=h)==null?void 0:E.from("jobs"))==null?void 0:k.update(s))==null?void 0:I.eq("id",e);s!=null&&s.org_id&&(o=(g=o==null?void 0:o.eq)==null?void 0:g.call(o,"org_id",s.org_id)),n!=null&&n.updated_at&&(o=(P=o==null?void 0:o.eq)==null?void 0:P.call(o,"updated_at",n.updated_at));const{data:l,error:L}=await((i=(y=o==null?void 0:o.select("id, updated_at"))==null?void 0:y.maybeSingle)==null?void 0:i.call(y));if(L)throw L;if(!(l!=null&&l.id)){const M=new Error("Conflict: This deal was updated by someone else. Refresh and try again.");throw M.status=409,M}}catch(o){F=o}if(F)throw new Error(`Failed to update deal: ${F.message||F}`);const $={job_id:e,vehicle_id:(s==null?void 0:s.vehicle_id)||null,total_amount:N,customer_name:d||"Unknown Customer",customer_phone:m||null,customer_email:a||null,transaction_status:"pending"};try{const{data:o}=await((B=(A=(C=(q=(r=(p=h)==null?void 0:p.from("transactions"))==null?void 0:r.select("id, transaction_number"))==null?void 0:q.eq("job_id",e))==null?void 0:C.limit(1))==null?void 0:A.maybeSingle)==null?void 0:B.call(A));if(o!=null&&o.id){const{error:l}=await((v=(J=(V=h)==null?void 0:V.from("transactions"))==null?void 0:J.update($))==null?void 0:v.eq("id",o.id));if(l)throw l}else{const l={...$,transaction_number:Y()},{error:L}=await((X=(W=h)==null?void 0:W.from("transactions"))==null?void 0:X.insert([l]));if(L)throw L}}catch(o){throw new Error(`Failed to upsert transaction: ${(o==null?void 0:o.message)||o}`)}const{error:w}=await((H=(G=(R=h)==null?void 0:R.from("job_parts"))==null?void 0:G.delete())==null?void 0:H.eq("job_id",e));if(w)throw new Error(`Failed to update line items: ${w.message}`);if((c||[]).length>0){const o=S(e,c);if((o==null?void 0:o.length)>0){const{error:l}=await((z=(x=h)==null?void 0:x.from("job_parts"))==null?void 0:z.insert(o));if(l)throw new Error(`Failed to update line items: ${l.message}`)}}return s!=null&&s.customer_needs_loaner&&t&&await j(e,t),await Q(e)}async function ie(e){var s;const{error:n}=await((s=h)==null?void 0:s.rpc("delete_job_cascade",{p_job_id:e}));if(n)throw new Error(`Failed to delete deal: ${n.message}`);return!0}async function ce(e,n){var t,d,m,a,N;const{data:s,error:c}=await((N=(a=(m=(d=(t=h)==null?void 0:t.from("jobs"))==null?void 0:d.update({job_status:n}))==null?void 0:m.eq("id",e))==null?void 0:a.select("id, job_status"))==null?void 0:N.single());if(c)throw new Error(`Failed to update status: ${c.message}`);return s}function ae(e){var n;return e?{id:e==null?void 0:e.id,updated_at:e==null?void 0:e.updated_at,job_number:(e==null?void 0:e.job_number)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.title)||(e==null?void 0:e.description)||"",vendor_id:e==null?void 0:e.vendor_id,vehicle_id:e==null?void 0:e.vehicle_id,job_status:(e==null?void 0:e.job_status)||"pending",priority:(e==null?void 0:e.priority)||"medium",scheduled_start_time:(e==null?void 0:e.scheduled_start_time)||"",scheduled_end_time:(e==null?void 0:e.scheduled_end_time)||"",estimated_hours:(e==null?void 0:e.estimated_hours)||"",estimated_cost:(e==null?void 0:e.estimated_cost)||"",actual_cost:(e==null?void 0:e.actual_cost)||"",location:(e==null?void 0:e.location)||"",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assigned_to:e==null?void 0:e.assigned_to,delivery_coordinator_id:e==null?void 0:e.delivery_coordinator_id,finance_manager_id:e==null?void 0:e.finance_manager_id,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicle:(e==null?void 0:e.vehicle)||null,lineItems:(n=(e==null?void 0:e.job_parts)||[])==null?void 0:n.map(s=>({product_id:s==null?void 0:s.product_id,unit_price:(s==null?void 0:s.unit_price)||0,quantity_used:(s==null?void 0:s.quantity_used)||1,promised_date:(s==null?void 0:s.promised_date)||"",requires_scheduling:!!(s!=null&&s.requires_scheduling),no_schedule_reason:(s==null?void 0:s.no_schedule_reason)||"",is_off_site:!!(s!=null&&s.is_off_site)}))}:null}async function me(e){var n,s,c,t;try{const{error:d}=await((t=(c=(n=h)==null?void 0:n.from("loaner_assignments"))==null?void 0:c.update({returned_at:(s=new Date)==null?void 0:s.toISOString()}))==null?void 0:t.eq("id",e));if(d)throw d;return!0}catch(d){throw console.error("Failed to mark loaner as returned:",d),new Error(`Failed to mark loaner as returned: ${d==null?void 0:d.message}`)}}const le={getAllDeals:re,getDeal:Q,createDeal:se,updateDeal:te,deleteDeal:ie,updateDealStatus:ce};export{se as createDeal,le as dealService,le as default,ie as deleteDeal,re as getAllDeals,Q as getDeal,ae as mapDbDealToForm,Z as mapFormToDb,me as markLoanerReturned,S as toJobPartRows,te as updateDeal,ce as updateDealStatus};
//# sourceMappingURL=dealService-BiwUi1HC.js.map
