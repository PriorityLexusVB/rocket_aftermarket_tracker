import{u as F,j as e,B as y,s as g}from"./index-ChFOcr8K.js";import{r as f}from"./react-Czq5O75u.js";import{N as X}from"./Navbar-DlTrAlxI.js";import{I as x}from"./Icon-_cdJ2-W2.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";function ce(){var z,D,E,R,q,T,I,M;const{user:ee}=F(),[b,V]=f.useState([]),[W,A]=f.useState(!0),[C,j]=f.useState(""),[G,_]=f.useState(!1),[o,w]=f.useState(null),[h,H]=f.useState({available:0,assigned:0,overdue:0}),[l,v]=f.useState({loaner_number:"",eta_return_date:"",notes:""}),k=async()=>{var t,r,a,c,d;try{A(!0),j("");const{data:s,error:u}=await((a=(r=(t=g)==null?void 0:t.from("loaner_assignments"))==null?void 0:r.select(`
          id,
          job_id,
          loaner_number,
          eta_return_date,
          returned_at,
          notes,
          created_at,
          jobs (
            id,
            title,
            customer_needs_loaner,
            transactions (
              customer_name,
              customer_phone
            )
          )
        `))==null?void 0:a.order("created_at",{ascending:!1}));if(u)throw u;const m=new Date,p=((c=s==null?void 0:s.filter(n=>!(n!=null&&n.returned_at)))==null?void 0:c.length)||0,N=((d=s==null?void 0:s.filter(n=>!(n!=null&&n.returned_at)&&new Date(n==null?void 0:n.eta_return_date)<m))==null?void 0:d.length)||0;V(s||[]),H({available:Math.max(0,10-p),assigned:p,overdue:N})}catch(s){j(`Failed to load loaner data: ${s==null?void 0:s.message}`),console.error("Load loaners error:",s)}finally{A(!1)}},[i,K]=f.useState([]),S=async()=>{var t,r,a,c;try{const{data:d,error:s}=await((c=(a=(r=(t=g)==null?void 0:t.from("jobs"))==null?void 0:r.select(`
          id,
          title,
          customer_needs_loaner,
          transactions (
            customer_name,
            customer_phone
          ),
          loaner_assignments (
            id,
            returned_at
          )
        `))==null?void 0:a.eq("customer_needs_loaner",!0))==null?void 0:c.in("job_status",["pending","in_progress"]));if(s)throw s;const u=d==null?void 0:d.filter(m=>{var N;return!((N=m==null?void 0:m.loaner_assignments)==null?void 0:N.some(n=>!(n!=null&&n.returned_at)))});K(u||[])}catch(d){console.error("Load jobs needing loaners error:",d)}},Q=async()=>{var t,r,a,c,d;if(!o||!((t=l==null?void 0:l.loaner_number)!=null&&t.trim())||!(l!=null&&l.eta_return_date)){j("Please fill in all required fields");return}try{j("");const{error:s}=await((d=(r=g)==null?void 0:r.from("loaner_assignments"))==null?void 0:d.insert([{job_id:o==null?void 0:o.id,loaner_number:(a=l==null?void 0:l.loaner_number)==null?void 0:a.trim(),eta_return_date:l==null?void 0:l.eta_return_date,notes:((c=l==null?void 0:l.notes)==null?void 0:c.trim())||null}]));if(s)throw s;v({loaner_number:"",eta_return_date:"",notes:""}),_(!1),w(null),await Promise.all([k(),S()])}catch(s){j(`Failed to assign loaner: ${s==null?void 0:s.message}`)}},Y=async t=>{var r,a,c,d;try{j("");const{error:s}=await((d=(c=(r=g)==null?void 0:r.from("loaner_assignments"))==null?void 0:c.update({returned_at:(a=new Date)==null?void 0:a.toISOString()}))==null?void 0:d.eq("id",t));if(s)throw s;await k()}catch(s){j(`Failed to mark loaner as returned: ${s==null?void 0:s.message}`)}},L=t=>{var r;return t?(r=new Date(t))==null?void 0:r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"—"},Z=t=>{if(t!=null&&t.returned_at)return"returned";const r=new Date,a=new Date(t==null?void 0:t.eta_return_date);return a<r?"overdue":Math.ceil((a-r)/(1e3*60*60*24))<=2?"due-soon":"active"},J=t=>{const r={active:{color:"bg-green-100 text-green-800 border-green-200",label:"Active"},"due-soon":{color:"bg-yellow-100 text-yellow-800 border-yellow-200",label:"Due Soon"},overdue:{color:"bg-red-100 text-red-800 border-red-200",label:"Overdue"},returned:{color:"bg-gray-100 text-gray-700 border-gray-200",label:"Returned"}};return(r==null?void 0:r[t])||(r==null?void 0:r.active)};return f.useEffect(()=>{Promise.all([k(),S()])},[]),W?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(X,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(x,{name:"Loader",size:32,className:"animate-spin mx-auto mb-4 text-slate-400"}),e.jsx("div",{className:"text-slate-600",children:"Loading loaner management..."})]})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(X,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[C&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(x,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:C})]})]}),e.jsx("button",{onClick:()=>j(""),className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(x,{name:"X",size:16})})]})}),e.jsx("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Loaner Management"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Track and manage loaner vehicle assignments"})]})}),e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(x,{name:"Car",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Available"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:h==null?void 0:h.available})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(x,{name:"Users",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Assigned"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:h==null?void 0:h.assigned})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-red-100 mr-4",children:e.jsx(x,{name:"AlertTriangle",size:24,className:"text-red-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Overdue"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:h==null?void 0:h.overdue})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(x,{name:"Clock",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:i==null?void 0:i.length})]})]})})]})}),(i==null?void 0:i.length)>0&&e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{name:"AlertCircle",size:20,className:"text-yellow-600 mr-2"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-yellow-800",children:"Jobs Requiring Loaner Assignment"}),e.jsxs("p",{className:"text-sm text-yellow-700 mt-1",children:[i==null?void 0:i.length," job",(i==null?void 0:i.length)!==1?"s":""," ","need loaner vehicles assigned"]})]})]})}),e.jsx("div",{className:"grid gap-4",children:i==null?void 0:i.map(t=>{var r,a,c,d,s,u,m,p;return e.jsxs("div",{className:"bg-white rounded-lg border p-4 flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-slate-900",children:(t==null?void 0:t.job_number)||((a=(r=t==null?void 0:t.transactions)==null?void 0:r[0])==null?void 0:a.customer_name)||"—"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Customer: ",((d=(c=t==null?void 0:t.transactions)==null?void 0:c[0])==null?void 0:d.customer_name)||"Unknown"]}),((u=(s=t==null?void 0:t.transactions)==null?void 0:s[0])==null?void 0:u.customer_phone)&&e.jsxs("p",{className:"text-sm text-slate-500",children:["Phone: ",(p=(m=t==null?void 0:t.transactions)==null?void 0:m[0])==null?void 0:p.customer_phone]})]}),e.jsxs(y,{onClick:()=>{w(t),_(!0)},className:"bg-purple-600 hover:bg-purple-700 text-white h-11 px-6",children:[e.jsx(x,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]})]},t==null?void 0:t.id)})})]}),e.jsxs("div",{className:"bg-white rounded-lg border overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Active Loaner Assignments"}),e.jsx("p",{className:"text-sm text-slate-600 mt-1",children:"Track current and returned loaner vehicles"})]}),(b==null?void 0:b.length)===0?e.jsxs("div",{className:"p-8 text-center text-slate-500",children:[e.jsx(x,{name:"Car",size:48,className:"mx-auto mb-4 text-slate-300"}),e.jsx("p",{children:"No loaner assignments found"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner #"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Job"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Expected Return"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:b==null?void 0:b.map(t=>{var c,d,s,u,m,p,N,n,P,U,O,$,B;const r=Z(t),a=J(r);return e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{name:"Car",size:16,className:"text-slate-400 mr-2"}),e.jsxs("span",{className:"font-medium text-slate-900",children:["#",t==null?void 0:t.loaner_number]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:((s=(d=(c=t==null?void 0:t.jobs)==null?void 0:c.transactions)==null?void 0:d[0])==null?void 0:s.customer_name)||"Unknown"}),((p=(m=(u=t==null?void 0:t.jobs)==null?void 0:u.transactions)==null?void 0:m[0])==null?void 0:p.customer_phone)&&e.jsx("div",{className:"text-sm text-slate-500",children:(P=(n=(N=t==null?void 0:t.jobs)==null?void 0:N.transactions)==null?void 0:n[0])==null?void 0:P.customer_phone})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-sm text-slate-900",children:((U=t==null?void 0:t.jobs)==null?void 0:U.job_number)||((B=($=(O=t==null?void 0:t.jobs)==null?void 0:O.transactions)==null?void 0:$[0])==null?void 0:B.customer_name)||"Unknown Job"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-slate-900",children:L(t==null?void 0:t.eta_return_date)}),(t==null?void 0:t.returned_at)&&e.jsxs("div",{className:"text-xs text-slate-500",children:["Returned: ",L(t==null?void 0:t.returned_at)]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${a==null?void 0:a.color}`,children:a==null?void 0:a.label})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:!(t!=null&&t.returned_at)&&e.jsx(y,{size:"sm",variant:"ghost",onClick:()=>Y(t==null?void 0:t.id),className:"text-green-600 hover:text-green-800",children:"Mark Returned"})})]},t==null?void 0:t.id)})})]})})]}),G&&o&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Assign Loaner Vehicle"}),e.jsx("button",{onClick:()=>{_(!1),w(null),v({loaner_number:"",eta_return_date:"",notes:""})},className:"text-slate-400 hover:text-slate-600",children:e.jsx(x,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-1",children:(o==null?void 0:o.job_number)||((D=(z=o==null?void 0:o.transactions)==null?void 0:z[0])==null?void 0:D.customer_name)||"—"}),e.jsx("p",{className:"text-sm text-slate-600",children:(R=(E=o==null?void 0:o.transactions)==null?void 0:E[0])==null?void 0:R.customer_name})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:l==null?void 0:l.loaner_number,onChange:t=>v(r=>{var a;return{...r,loaner_number:(a=t==null?void 0:t.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., L-001",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:l==null?void 0:l.eta_return_date,onChange:t=>v(r=>{var a;return{...r,eta_return_date:(a=t==null?void 0:t.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(I=(T=(q=new Date)==null?void 0:q.toISOString())==null?void 0:T.split("T"))==null?void 0:I[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:l==null?void 0:l.notes,onChange:t=>v(r=>{var a;return{...r,notes:(a=t==null?void 0:t.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Any special instructions or notes..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(y,{variant:"outline",onClick:()=>{_(!1),w(null),v({loaner_number:"",eta_return_date:"",notes:""})},className:"flex-1 h-11",children:"Cancel"}),e.jsx(y,{onClick:Q,className:"flex-1 h-11 bg-purple-600 hover:bg-purple-700 text-white",disabled:!((M=l==null?void 0:l.loaner_number)!=null&&M.trim())||!(l!=null&&l.eta_return_date),children:"Assign Loaner"})]})]})})})]})]})}export{ce as default};
//# sourceMappingURL=index-HBefJNtF.js.map
