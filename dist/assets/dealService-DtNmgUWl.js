import{s as l}from"./index-DozuhN0O.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const V=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function Y(e,n){const o={};return n==null||n.forEach(c=>{(e==null?void 0:e[c])!==void 0&&(o[c]=e==null?void 0:e[c])}),o}function x(e){const n=Y(e||{},V);return Object.keys(n).forEach(o=>{n[o]===""&&(n[o]=null)}),n}async function G(e){var c,r,u,i;const{data:n,error:o}=await((i=(u=(r=(c=l)==null?void 0:c.from("jobs"))==null?void 0:r.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:u.eq("id",e))==null?void 0:i.single());if(o)throw new Error(`Failed to load deal: ${o.message}`);return n}function U(e={}){var m,y,E,f,d,v,g,t,_;const n=x(e||{}),o=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),c=o?{...n,org_id:o}:n,u=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(s=>({product_id:s.product_id??null,quantity_used:Number(s.quantity_used??s.quantity??1),unit_price:Number(s.unit_price??s.price??0),promised_date:s.promised_date||s.lineItemPromisedDate||null,requires_scheduling:!!s.requires_scheduling||!!s.requiresScheduling,no_schedule_reason:s.no_schedule_reason||s.noScheduleReason||null,is_off_site:!!s.is_off_site||!!s.isOffSite,lineItemPromisedDate:s.lineItemPromisedDate||s.promised_date||null,requiresScheduling:!!s.requiresScheduling||!!s.requires_scheduling,noScheduleReason:s.noScheduleReason||s.no_schedule_reason||null,isOffSite:!!s.isOffSite||!!s.is_off_site}));for(const s of u)if((Number.isNaN(s.quantity_used)||s.quantity_used==null)&&(s.quantity_used=1),(Number.isNaN(s.unit_price)||s.unit_price==null)&&(s.unit_price=0),!s.requires_scheduling&&!String(s.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((u==null?void 0:u.length)||0)>0&&!u.some(I=>!!I.product_id))throw new Error("At least one product is required");const i=(u||[]).map(s=>({product_id:s.product_id,quantity:Number(s.quantity_used??1),unit_price:Number(s.unit_price??0),total_price:Number(s.unit_price??0)*Number(s.quantity_used??1),quantity_used:s.quantity_used,promised_date:s.promised_date,requires_scheduling:s.requires_scheduling,no_schedule_reason:s.no_schedule_reason,is_off_site:s.is_off_site})),w=(e==null?void 0:e.loanerForm)||null,q=((m=e==null?void 0:e.customerName)==null?void 0:m.trim())||((E=(y=e==null?void 0:e.customer_name)==null?void 0:y.trim)==null?void 0:E.call(y))||"",F=((f=e==null?void 0:e.customerPhone)==null?void 0:f.trim())||((v=(d=e==null?void 0:e.customer_phone)==null?void 0:d.trim)==null?void 0:v.call(d))||"",N=((g=e==null?void 0:e.customerEmail)==null?void 0:g.trim())||((_=(t=e==null?void 0:e.customer_email)==null?void 0:t.trim)==null?void 0:_.call(t))||"";return{payload:c,normalizedLineItems:u,jobPayload:c,jobParts:i,loanerForm:w,customerName:q,customerPhone:F,customerEmail:N}}function z(e,n=[]){var o,c;return(c=(o=n||[])==null?void 0:o.map(r=>({job_id:e,product_id:(r==null?void 0:r.product_id)??null,quantity_used:(r==null?void 0:r.quantity_used)??(r==null?void 0:r.quantity)??1,unit_price:(r==null?void 0:r.unit_price)??(r==null?void 0:r.price)??0,promised_date:(r==null?void 0:r.lineItemPromisedDate)||(r!=null&&r.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(r!=null&&r.requiresScheduling),no_schedule_reason:r!=null&&r.requiresScheduling?null:(r==null?void 0:r.noScheduleReason)||null,is_off_site:!!(r!=null&&r.isOffSite)})))==null?void 0:c.filter(r=>(r==null?void 0:r.product_id)!==null||(r==null?void 0:r.quantity_used)||(r==null?void 0:r.unit_price))}async function T(e,n){var o,c,r,u,i,w,q,F,N,m,y,E,f;if((o=n==null?void 0:n.loaner_number)!=null&&o.trim())try{const{data:d}=await((w=(i=(u=(r=(c=l)==null?void 0:c.from("loaner_assignments"))==null?void 0:r.select("id"))==null?void 0:u.eq("job_id",e))==null?void 0:i.is("returned_at",null))==null?void 0:w.single()),v={job_id:e,loaner_number:(q=n==null?void 0:n.loaner_number)==null?void 0:q.trim(),eta_return_date:(n==null?void 0:n.eta_return_date)||null,notes:((F=n==null?void 0:n.notes)==null?void 0:F.trim())||null};if(d){const{error:g}=await((y=(m=(N=l)==null?void 0:N.from("loaner_assignments"))==null?void 0:m.update(v))==null?void 0:y.eq("id",d==null?void 0:d.id));if(g)throw g}else{const{error:g}=await((f=(E=l)==null?void 0:E.from("loaner_assignments"))==null?void 0:f.insert([v]));if(g)throw g}}catch(d){throw(d==null?void 0:d.code)==="23505"?new Error(`Loaner ${n==null?void 0:n.loaner_number} is already assigned to another active job`):d}}async function H(){var e,n,o,c,r,u,i,w,q,F,N;try{const{data:m,error:y}=await((c=(o=(n=(e=l)==null?void 0:e.from("jobs"))==null?void 0:n.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        vehicle:vehicles(year, make, model, stock_number),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site)
      `))==null?void 0:o.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:c.order("created_at",{ascending:!1}));if(y)throw y;const E=(m==null?void 0:m.map(t=>t==null?void 0:t.id))||[],[f,d]=await Promise.all([(i=(u=(r=l)==null?void 0:r.from("transactions"))==null?void 0:u.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:i.in("job_id",E),(N=(F=(q=(w=l)==null?void 0:w.from("loaner_assignments"))==null?void 0:q.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:F.in("job_id",E))==null?void 0:N.is("returned_at",null)]),v=(f==null?void 0:f.data)||[],g=(d==null?void 0:d.data)||[];return(m==null?void 0:m.map(t=>{var P,k,O,A,L,M,R,J,h,a;const _=v==null?void 0:v.find(p=>(p==null?void 0:p.job_id)===(t==null?void 0:t.id)),s=g==null?void 0:g.find(p=>(p==null?void 0:p.job_id)===(t==null?void 0:t.id)),I=((P=t==null?void 0:t.job_parts)==null?void 0:P.filter(p=>(p==null?void 0:p.requires_scheduling)&&(p==null?void 0:p.promised_date)))||[],$=(I==null?void 0:I.length)>0?(O=(k=I==null?void 0:I.sort((p,B)=>new Date(p.promised_date)-new Date(B.promised_date)))==null?void 0:k[0])==null?void 0:O.promised_date:null;return{...t,customer_name:(_==null?void 0:_.customer_name)||"",customer_phone:(_==null?void 0:_.customer_phone)||"",customer_email:(_==null?void 0:_.customer_email)||"",total_amount:(_==null?void 0:_.total_amount)||0,next_promised_short:$?(A=new Date($))==null?void 0:A.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_id:(s==null?void 0:s.id)||null,loaner_number:(s==null?void 0:s.loaner_number)||null,loaner_eta_short:s!=null&&s.eta_return_date?(L=new Date(s==null?void 0:s.eta_return_date))==null?void 0:L.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,vehicle:t!=null&&t.vehicle_id&&(t!=null&&t.vehicle)?{year:(M=t==null?void 0:t.vehicle)==null?void 0:M.year,make:(R=t==null?void 0:t.vehicle)==null?void 0:R.make,model:(J=t==null?void 0:t.vehicle)==null?void 0:J.model,stock_number:(h=t==null?void 0:t.vehicle)==null?void 0:h.stock_number}:null,stock_no:(a=t==null?void 0:t.vehicle)==null?void 0:a.stock_number}}))||[]}catch(m){throw console.error("Failed to load deals:",m),new Error(`Failed to load deals: ${m==null?void 0:m.message}`)}}async function C(e){var n,o,c,r;try{const u=await G(e),{data:i}=await((r=(c=(o=(n=l)==null?void 0:n.from("transactions"))==null?void 0:o.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:c.eq("job_id",e))==null?void 0:r.single());return{...u,customer_name:(i==null?void 0:i.customer_name)||"",customer_phone:(i==null?void 0:i.customer_phone)||"",customer_email:(i==null?void 0:i.customer_email)||"",total_amount:(i==null?void 0:i.total_amount)||0}}catch(u){throw console.error("[dealService:get] Failed to get deal:",u),new Error(`Failed to load deal: ${u==null?void 0:u.message}`)}}async function K(e){var i,w,q,F,N,m,y,E,f,d,v,g;const{payload:n,normalizedLineItems:o,loanerForm:c}=U(e||{});if(!(n!=null&&n.job_number)){const t=Date.now(),_=Math.floor(Math.random()*1e4);n.job_number=`JOB-${t}-${_}`}n!=null&&n.vendor_id&&!(n!=null&&n.scheduled_start_time)&&(n.scheduled_start_time=new Date().toISOString());const{data:r,error:u}=await((F=(q=(w=(i=l)==null?void 0:i.from("jobs"))==null?void 0:w.insert([n]))==null?void 0:q.select("id"))==null?void 0:F.single());if(u)throw new Error(`Failed to create deal: ${u.message}`);try{if((o||[]).length>0){const t=z(r==null?void 0:r.id,o);if((t==null?void 0:t.length)>0){const{error:_}=await((m=(N=l)==null?void 0:N.from("job_parts"))==null?void 0:m.insert(t));if(_)throw _}}return n!=null&&n.customer_needs_loaner&&c&&await T(r==null?void 0:r.id,c),await C(r==null?void 0:r.id)}catch(t){console.error("[dealService:create] Failed to create deal:",t);try{await((f=(E=(y=l)==null?void 0:y.from("job_parts"))==null?void 0:E.delete())==null?void 0:f.eq("job_id",r==null?void 0:r.id))}catch{}try{await((g=(v=(d=l)==null?void 0:d.from("jobs"))==null?void 0:v.delete())==null?void 0:g.eq("id",r==null?void 0:r.id))}catch{}throw new Error(`Failed to create deal: ${t.message}`)}}async function Q(e,n){var y,E,f,d,v,g,t,_,s,I,$,P,k,O,A,L,M,R,J;const{payload:o,normalizedLineItems:c,loanerForm:r,customerName:u,customerPhone:i,customerEmail:w}=U(n||{}),q=(c||[]).reduce((h,a)=>{const p=Number((a==null?void 0:a.quantity_used)||(a==null?void 0:a.quantity)||1),B=Number((a==null?void 0:a.unit_price)||(a==null?void 0:a.price)||0);return h+p*B},0)||0,{error:F}=await((f=(E=(y=l)==null?void 0:y.from("jobs"))==null?void 0:E.update(o))==null?void 0:f.eq("id",e));if(F)throw new Error(`Failed to update deal: ${F.message}`);const N={job_id:e,vehicle_id:(o==null?void 0:o.vehicle_id)||null,total_amount:q,customer_name:u||"Unknown Customer",customer_phone:i||null,customer_email:w||null,transaction_status:"pending"};try{const{data:h}=await((s=(_=(t=(g=(v=(d=l)==null?void 0:d.from("transactions"))==null?void 0:v.select("id"))==null?void 0:g.eq("job_id",e))==null?void 0:t.limit(1))==null?void 0:_.maybeSingle)==null?void 0:s.call(_));if(h!=null&&h.id){const{error:a}=await((P=($=(I=l)==null?void 0:I.from("transactions"))==null?void 0:$.update(N))==null?void 0:P.eq("id",h.id));if(a)throw a}else{const{error:a}=await((O=(k=l)==null?void 0:k.from("transactions"))==null?void 0:O.insert([N]));if(a)throw a}}catch(h){throw new Error(`Failed to upsert transaction: ${(h==null?void 0:h.message)||h}`)}const{error:m}=await((M=(L=(A=l)==null?void 0:A.from("job_parts"))==null?void 0:L.delete())==null?void 0:M.eq("job_id",e));if(m)throw new Error(`Failed to update line items: ${m.message}`);if((c||[]).length>0){const h=z(e,c);if((h==null?void 0:h.length)>0){const{error:a}=await((J=(R=l)==null?void 0:R.from("job_parts"))==null?void 0:J.insert(h));if(a)throw new Error(`Failed to update line items: ${a.message}`)}}return o!=null&&o.customer_needs_loaner&&r&&await T(e,r),await C(e)}async function W(e){var o;const{error:n}=await((o=l)==null?void 0:o.rpc("delete_job_cascade",{p_job_id:e}));if(n)throw new Error(`Failed to delete deal: ${n.message}`);return!0}async function X(e,n){var r,u,i,w,q;const{data:o,error:c}=await((q=(w=(i=(u=(r=l)==null?void 0:r.from("jobs"))==null?void 0:u.update({job_status:n}))==null?void 0:i.eq("id",e))==null?void 0:w.select("id, job_status"))==null?void 0:q.single());if(c)throw new Error(`Failed to update status: ${c.message}`);return o}function D(e){var o,c,r,u;if(!e)return null;const n=Array.isArray(e==null?void 0:e.job_parts)?e.job_parts:[];return{job_status:(e==null?void 0:e.job_status)||"draft",priority:(e==null?void 0:e.priority)||"medium",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assignedTo:(e==null?void 0:e.assigned_to)||null,deliveryCoordinator:(e==null?void 0:e.delivery_coordinator_id)||null,financeManager:(e==null?void 0:e.finance_manager_id)||null,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicleYear:((o=e==null?void 0:e.vehicle)==null?void 0:o.year)||"",vehicleMake:((c=e==null?void 0:e.vehicle)==null?void 0:c.make)||"",vehicleModel:((r=e==null?void 0:e.vehicle)==null?void 0:r.model)||"",stockNumber:((u=e==null?void 0:e.vehicle)==null?void 0:u.stock_number)||"",lineItems:n.map(i=>({product_id:(i==null?void 0:i.product_id)??null,unit_price:Number((i==null?void 0:i.unit_price)??0),quantity_used:Number((i==null?void 0:i.quantity_used)??1),lineItemPromisedDate:(i==null?void 0:i.promised_date)||"",requiresScheduling:!!(i!=null&&i.requires_scheduling),noScheduleReason:(i==null?void 0:i.no_schedule_reason)||"",isOffSite:!!(i!=null&&i.is_off_site),description:""}))}}async function ee(e){var n,o,c,r;try{const{error:u}=await((r=(c=(n=l)==null?void 0:n.from("loaner_assignments"))==null?void 0:c.update({returned_at:(o=new Date)==null?void 0:o.toISOString()}))==null?void 0:r.eq("id",e));if(u)throw u;return!0}catch(u){throw console.error("Failed to mark loaner as returned:",u),new Error(`Failed to mark loaner as returned: ${u==null?void 0:u.message}`)}}const re={getAllDeals:H,getDeal:C,createDeal:K,updateDeal:Q,deleteDeal:W,updateDealStatus:X};export{K as createDeal,re as dealService,re as default,W as deleteDeal,H as getAllDeals,C as getDeal,D as mapDbDealToForm,U as mapFormToDb,ee as markLoanerReturned,z as toJobPartRows,Q as updateDeal,X as updateDealStatus};
//# sourceMappingURL=dealService-DtNmgUWl.js.map
