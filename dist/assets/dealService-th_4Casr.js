import{s as h}from"./index-CsUHg1Df.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const D=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function b(e,r){const t={};return r==null||r.forEach(c=>{(e==null?void 0:e[c])!==void 0&&(t[c]=e==null?void 0:e[c])}),t}function ee(e){const r=b(e||{},D);return Object.keys(r).forEach(t=>{r[t]===""&&(r[t]=null)}),r}function Y(){const e=Date.now(),r=Math.floor(Math.random()*1e4);return`TXN-${e}-${r}`}async function ne(e){var c,s,o,_;const{data:r,error:t}=await((_=(o=(s=(c=h)==null?void 0:c.from("jobs"))==null?void 0:s.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:o.eq("id",e))==null?void 0:_.single());if(t)throw new Error(`Failed to load deal: ${t.message}`);return r}function Z(e={}){var p,v,k,$,g,I,y,i,m;const r=ee(e||{}),t=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),c=t?{...r,org_id:t}:r;if(!(c!=null&&c.title)){const n=((e==null?void 0:e.description)||"").trim();n?c.title=n:c!=null&&c.job_number?c.title=`Deal ${c.job_number}`:c.title="Untitled Deal"}const o=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(n=>{const q=(n==null?void 0:n.requires_scheduling)??(n==null?void 0:n.requiresScheduling)??!0,M=(n==null?void 0:n.no_schedule_reason)||(n==null?void 0:n.noScheduleReason)||null,A=(n==null?void 0:n.promised_date)||(n==null?void 0:n.lineItemPromisedDate)||null,U=(n==null?void 0:n.is_off_site)??(n==null?void 0:n.isOffSite)??!1;return{product_id:n.product_id??null,quantity_used:Number(n.quantity_used??n.quantity??1),unit_price:Number(n.unit_price??n.price??0),promised_date:A,requires_scheduling:!!q,no_schedule_reason:q?null:M,is_off_site:!!U,lineItemPromisedDate:A,requiresScheduling:!!q,noScheduleReason:q?null:M,isOffSite:!!U}});for(const n of o)if((Number.isNaN(n.quantity_used)||n.quantity_used==null)&&(n.quantity_used=1),(Number.isNaN(n.unit_price)||n.unit_price==null)&&(n.unit_price=0),!n.requires_scheduling&&!String(n.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((o==null?void 0:o.length)||0)>0&&!o.some(q=>!!q.product_id))throw new Error("At least one product is required");const _=(o||[]).map(n=>({product_id:n.product_id,quantity:Number(n.quantity_used??1),unit_price:Number(n.unit_price??0),total_price:Number(n.unit_price??0)*Number(n.quantity_used??1),quantity_used:n.quantity_used,promised_date:n.promised_date,requires_scheduling:n.requires_scheduling,no_schedule_reason:n.no_schedule_reason,is_off_site:n.is_off_site})),u=(e==null?void 0:e.loanerForm)||null,N=((p=e==null?void 0:e.customerName)==null?void 0:p.trim())||((k=(v=e==null?void 0:e.customer_name)==null?void 0:v.trim)==null?void 0:k.call(v))||"",O=(($=e==null?void 0:e.customerPhone)==null?void 0:$.trim())||((I=(g=e==null?void 0:e.customer_phone)==null?void 0:g.trim)==null?void 0:I.call(g))||"",F=((y=e==null?void 0:e.customerEmail)==null?void 0:y.trim())||((m=(i=e==null?void 0:e.customer_email)==null?void 0:i.trim)==null?void 0:m.call(i))||"";return{payload:c,normalizedLineItems:o,jobPayload:c,jobParts:_,loanerForm:u,customerName:N,customerPhone:O,customerEmail:F}}function S(e,r=[]){var t,c;return(c=(t=r||[])==null?void 0:t.map(s=>({job_id:e,product_id:(s==null?void 0:s.product_id)??null,quantity_used:(s==null?void 0:s.quantity_used)??(s==null?void 0:s.quantity)??1,unit_price:(s==null?void 0:s.unit_price)??(s==null?void 0:s.price)??0,promised_date:(s==null?void 0:s.lineItemPromisedDate)||(s!=null&&s.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(s!=null&&s.requiresScheduling),no_schedule_reason:s!=null&&s.requiresScheduling?null:(s==null?void 0:s.noScheduleReason)||null,is_off_site:!!(s!=null&&s.isOffSite)})))==null?void 0:c.filter(s=>(s==null?void 0:s.product_id)!==null||(s==null?void 0:s.quantity_used)||(s==null?void 0:s.unit_price))}async function j(e,r){var t,c,s,o,_,u,N,O,F,p,v,k,$;if((t=r==null?void 0:r.loaner_number)!=null&&t.trim())try{const{data:g}=await((u=(_=(o=(s=(c=h)==null?void 0:c.from("loaner_assignments"))==null?void 0:s.select("id"))==null?void 0:o.eq("job_id",e))==null?void 0:_.is("returned_at",null))==null?void 0:u.single()),I={job_id:e,loaner_number:(N=r==null?void 0:r.loaner_number)==null?void 0:N.trim(),eta_return_date:(r==null?void 0:r.eta_return_date)||null,notes:((O=r==null?void 0:r.notes)==null?void 0:O.trim())||null};if(g){const{error:y}=await((v=(p=(F=h)==null?void 0:F.from("loaner_assignments"))==null?void 0:p.update(I))==null?void 0:v.eq("id",g==null?void 0:g.id));if(y)throw y}else{const{error:y}=await(($=(k=h)==null?void 0:k.from("loaner_assignments"))==null?void 0:$.insert([I]));if(y)throw y}}catch(g){throw(g==null?void 0:g.code)==="23505"?new Error(`Loaner ${r==null?void 0:r.loaner_number} is already assigned to another active job`):g}}async function re(){var e,r,t,c,s,o,_,u,N,O,F;try{const{data:p,error:v}=await((c=(t=(r=(e=h)==null?void 0:e.from("jobs"))==null?void 0:r.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        scheduled_start_time, scheduled_end_time,
        vehicle:vehicles(year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:t.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:c.order("created_at",{ascending:!1}));if(v)throw v;const k=(p==null?void 0:p.map(i=>i==null?void 0:i.id))||[],[$,g]=await Promise.all([(_=(o=(s=h)==null?void 0:s.from("transactions"))==null?void 0:o.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:_.in("job_id",k),(F=(O=(N=(u=h)==null?void 0:u.from("loaner_assignments"))==null?void 0:N.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:O.in("job_id",k))==null?void 0:F.is("returned_at",null)]),I=($==null?void 0:$.data)||[],y=(g==null?void 0:g.data)||[];return(p==null?void 0:p.map(i=>{var T,V,W,X,d,E,C,P,G,H;const m=I==null?void 0:I.find(a=>(a==null?void 0:a.job_id)===(i==null?void 0:i.id)),n=y==null?void 0:y.find(a=>(a==null?void 0:a.job_id)===(i==null?void 0:i.id)),q=((T=i==null?void 0:i.job_parts)==null?void 0:T.filter(a=>(a==null?void 0:a.requires_scheduling)&&(a==null?void 0:a.promised_date)))||[],M=(q==null?void 0:q.length)>0?(W=(V=q==null?void 0:q.sort((a,L)=>new Date(a.promised_date)-new Date(L.promised_date)))==null?void 0:V[0])==null?void 0:W.promised_date:null,A=i!=null&&i.created_at?new Date(i.created_at):null,J=A?Math.max(0,Math.floor((new Date-A)/(1e3*60*60*24))):null,B=(m==null?void 0:m.customer_phone)||"",f=(B||"").replace(/\D/g,""),R=(f==null?void 0:f.slice(-4))||"",z=(f==null?void 0:f.length)===11&&f.startsWith("1")?`+${f}`:(f==null?void 0:f.length)===10?`+1${f}`:B||"",x=(i==null?void 0:i.scheduled_start_time)||null,w=(i==null?void 0:i.scheduled_end_time)||null,l=((i==null?void 0:i.job_parts)||[]).map(a=>{var L,K;return((L=a==null?void 0:a.product)==null?void 0:L.category)||((K=a==null?void 0:a.product)==null?void 0:K.name)||""}).map(a=>{const L=(a||"").toLowerCase();return/ppf|paint protection/.test(L)?"PPF":/tint|window/.test(L)?"Tint":/ceramic/.test(L)?"Ceramic":/detail|wash|interior|exterior/.test(L)?"Detail":null}).filter(Boolean).filter((a,L,K)=>K.indexOf(a)===L);return{...i,customer_name:(m==null?void 0:m.customer_name)||"",customer_phone:(m==null?void 0:m.customer_phone)||"",customer_phone_e164:z,customer_phone_last4:R,customer_email:(m==null?void 0:m.customer_email)||"",total_amount:(m==null?void 0:m.total_amount)||0,has_active_loaner:!!(n!=null&&n.id),next_promised_iso:M||null,loaner_id:(n==null?void 0:n.id)||null,loaner_number:(n==null?void 0:n.loaner_number)||null,loaner_eta_short:n!=null&&n.eta_return_date?(X=new Date(n==null?void 0:n.eta_return_date))==null?void 0:X.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_eta_return_date:(n==null?void 0:n.eta_return_date)||null,age_days:J,appt_start:x,appt_end:w,vendor_name:((d=i==null?void 0:i.vendor)==null?void 0:d.name)||null,work_tags:l,vehicle:i!=null&&i.vehicle_id&&(i!=null&&i.vehicle)?{year:(E=i==null?void 0:i.vehicle)==null?void 0:E.year,make:(C=i==null?void 0:i.vehicle)==null?void 0:C.make,model:(P=i==null?void 0:i.vehicle)==null?void 0:P.model,stock_number:(G=i==null?void 0:i.vehicle)==null?void 0:G.stock_number}:null,stock_no:(H=i==null?void 0:i.vehicle)==null?void 0:H.stock_number}}))||[]}catch(p){throw console.error("Failed to load deals:",p),new Error(`Failed to load deals: ${p==null?void 0:p.message}`)}}async function Q(e){var r,t,c,s;try{const o=await ne(e),{data:_}=await((s=(c=(t=(r=h)==null?void 0:r.from("transactions"))==null?void 0:t.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:c.eq("job_id",e))==null?void 0:s.single());return{...o,customer_name:(_==null?void 0:_.customer_name)||"",customer_phone:(_==null?void 0:_.customer_phone)||"",customer_email:(_==null?void 0:_.customer_email)||"",total_amount:(_==null?void 0:_.total_amount)||0}}catch(o){throw console.error("[dealService:get] Failed to get deal:",o),new Error(`Failed to load deal: ${o==null?void 0:o.message}`)}}async function se(e){var O,F,p,v,k,$,g,I,y,i,m,n,q,M,A,U,J,B,f,R,z,x,w,l,T,V,W,X;const{payload:r,normalizedLineItems:t,loanerForm:c,customerName:s,customerPhone:o,customerEmail:_}=Z(e||{});if(!(r!=null&&r.org_id))try{const{data:d}=await((p=(F=(O=h)==null?void 0:O.auth)==null?void 0:F.getUser)==null?void 0:p.call(F)),E=(v=d==null?void 0:d.user)==null?void 0:v.id;if(E){const{data:C}=await((I=(g=($=(k=h)==null?void 0:k.from("user_profiles"))==null?void 0:$.select("org_id"))==null?void 0:g.eq("id",E))==null?void 0:I.single());C!=null&&C.org_id&&(r.org_id=C.org_id)}}catch(d){console.warn("[dealService:create] Unable to infer org_id from profile:",d==null?void 0:d.message)}if(!(r!=null&&r.job_number)){const d=Date.now(),E=Math.floor(Math.random()*1e4);r.job_number=`JOB-${d}-${E}`}r!=null&&r.vendor_id&&!(r!=null&&r.scheduled_start_time)&&(r.scheduled_start_time=new Date().toISOString());const{data:u,error:N}=await((n=(m=(i=(y=h)==null?void 0:y.from("jobs"))==null?void 0:i.insert([r]))==null?void 0:m.select("id"))==null?void 0:n.single());if(N)throw new Error(`Failed to create deal: ${N.message}`);try{if((t||[]).length>0){const d=S(u==null?void 0:u.id,t);if((d==null?void 0:d.length)>0){const{error:E}=await((M=(q=h)==null?void 0:q.from("job_parts"))==null?void 0:M.insert(d));if(E)throw E}}r!=null&&r.customer_needs_loaner&&c&&await j(u==null?void 0:u.id,c);try{const d={job_id:u==null?void 0:u.id,vehicle_id:(r==null?void 0:r.vehicle_id)||null,total_amount:(t||[]).reduce((C,P)=>{const G=Number((P==null?void 0:P.quantity_used)||(P==null?void 0:P.quantity)||1),H=Number((P==null?void 0:P.unit_price)||(P==null?void 0:P.price)||0);return C+G*H},0)||0,customer_name:s||"Unknown Customer",customer_phone:o||null,customer_email:_||null,transaction_status:"pending",transaction_number:Y()},{data:E}=await((R=(f=(B=(J=(U=(A=h)==null?void 0:A.from("transactions"))==null?void 0:U.select("id"))==null?void 0:J.eq("job_id",u==null?void 0:u.id))==null?void 0:B.limit(1))==null?void 0:f.maybeSingle)==null?void 0:R.call(f));E!=null&&E.id||await((x=(z=h)==null?void 0:z.from("transactions"))==null?void 0:x.insert([d]))}catch(d){console.warn("[dealService:create] pre-create transaction insert skipped:",d==null?void 0:d.message)}try{return await Q(u==null?void 0:u.id)}catch(d){return console.warn("[dealService:create] getDeal fallback due to error:",d==null?void 0:d.message),{id:u==null?void 0:u.id}}}catch(d){console.error("[dealService:create] Failed to create deal:",d);try{await((T=(l=(w=h)==null?void 0:w.from("job_parts"))==null?void 0:l.delete())==null?void 0:T.eq("job_id",u==null?void 0:u.id))}catch{}try{await((X=(W=(V=h)==null?void 0:V.from("jobs"))==null?void 0:W.delete())==null?void 0:X.eq("id",u==null?void 0:u.id))}catch{}throw new Error(`Failed to create deal: ${d.message}`)}}async function te(e,r){var v,k,$,g,I,y,i,m,n,q,M,A,U,J,B,f,R,z,x;const{payload:t,normalizedLineItems:c,loanerForm:s,customerName:o,customerPhone:_,customerEmail:u}=Z(r||{}),N=(c||[]).reduce((w,l)=>{const T=Number((l==null?void 0:l.quantity_used)||(l==null?void 0:l.quantity)||1),V=Number((l==null?void 0:l.unit_price)||(l==null?void 0:l.price)||0);return w+T*V},0)||0,{error:O}=await(($=(k=(v=h)==null?void 0:v.from("jobs"))==null?void 0:k.update(t))==null?void 0:$.eq("id",e));if(O)throw new Error(`Failed to update deal: ${O.message}`);const F={job_id:e,vehicle_id:(t==null?void 0:t.vehicle_id)||null,total_amount:N,customer_name:o||"Unknown Customer",customer_phone:_||null,customer_email:u||null,transaction_status:"pending"};try{const{data:w}=await((n=(m=(i=(y=(I=(g=h)==null?void 0:g.from("transactions"))==null?void 0:I.select("id, transaction_number"))==null?void 0:y.eq("job_id",e))==null?void 0:i.limit(1))==null?void 0:m.maybeSingle)==null?void 0:n.call(m));if(w!=null&&w.id){const{error:l}=await((A=(M=(q=h)==null?void 0:q.from("transactions"))==null?void 0:M.update(F))==null?void 0:A.eq("id",w.id));if(l)throw l}else{const l={...F,transaction_number:Y()},{error:T}=await((J=(U=h)==null?void 0:U.from("transactions"))==null?void 0:J.insert([l]));if(T)throw T}}catch(w){throw new Error(`Failed to upsert transaction: ${(w==null?void 0:w.message)||w}`)}const{error:p}=await((R=(f=(B=h)==null?void 0:B.from("job_parts"))==null?void 0:f.delete())==null?void 0:R.eq("job_id",e));if(p)throw new Error(`Failed to update line items: ${p.message}`);if((c||[]).length>0){const w=S(e,c);if((w==null?void 0:w.length)>0){const{error:l}=await((x=(z=h)==null?void 0:z.from("job_parts"))==null?void 0:x.insert(w));if(l)throw new Error(`Failed to update line items: ${l.message}`)}}return t!=null&&t.customer_needs_loaner&&s&&await j(e,s),await Q(e)}async function ie(e){var t;const{error:r}=await((t=h)==null?void 0:t.rpc("delete_job_cascade",{p_job_id:e}));if(r)throw new Error(`Failed to delete deal: ${r.message}`);return!0}async function ce(e,r){var s,o,_,u,N;const{data:t,error:c}=await((N=(u=(_=(o=(s=h)==null?void 0:s.from("jobs"))==null?void 0:o.update({job_status:r}))==null?void 0:_.eq("id",e))==null?void 0:u.select("id, job_status"))==null?void 0:N.single());if(c)throw new Error(`Failed to update status: ${c.message}`);return t}function ae(e){var r;return e?{id:e==null?void 0:e.id,job_number:(e==null?void 0:e.job_number)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",vendor_id:e==null?void 0:e.vendor_id,vehicle_id:e==null?void 0:e.vehicle_id,job_status:(e==null?void 0:e.job_status)||"pending",priority:(e==null?void 0:e.priority)||"medium",scheduled_start_time:(e==null?void 0:e.scheduled_start_time)||"",scheduled_end_time:(e==null?void 0:e.scheduled_end_time)||"",estimated_hours:(e==null?void 0:e.estimated_hours)||"",estimated_cost:(e==null?void 0:e.estimated_cost)||"",actual_cost:(e==null?void 0:e.actual_cost)||"",location:(e==null?void 0:e.location)||"",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assigned_to:e==null?void 0:e.assigned_to,delivery_coordinator_id:e==null?void 0:e.delivery_coordinator_id,finance_manager_id:e==null?void 0:e.finance_manager_id,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicle:(e==null?void 0:e.vehicle)||null,lineItems:(r=(e==null?void 0:e.job_parts)||[])==null?void 0:r.map(t=>({product_id:t==null?void 0:t.product_id,unit_price:(t==null?void 0:t.unit_price)||0,quantity_used:(t==null?void 0:t.quantity_used)||1,promised_date:(t==null?void 0:t.promised_date)||"",requires_scheduling:!!(t!=null&&t.requires_scheduling),no_schedule_reason:(t==null?void 0:t.no_schedule_reason)||"",is_off_site:!!(t!=null&&t.is_off_site)}))}:null}async function me(e){var r,t,c,s;try{const{error:o}=await((s=(c=(r=h)==null?void 0:r.from("loaner_assignments"))==null?void 0:c.update({returned_at:(t=new Date)==null?void 0:t.toISOString()}))==null?void 0:s.eq("id",e));if(o)throw o;return!0}catch(o){throw console.error("Failed to mark loaner as returned:",o),new Error(`Failed to mark loaner as returned: ${o==null?void 0:o.message}`)}}const le={getAllDeals:re,getDeal:Q,createDeal:se,updateDeal:te,deleteDeal:ie,updateDealStatus:ce};export{se as createDeal,le as dealService,le as default,ie as deleteDeal,re as getAllDeals,Q as getDeal,ae as mapDbDealToForm,Z as mapFormToDb,me as markLoanerReturned,S as toJobPartRows,te as updateDeal,ce as updateDealStatus};
//# sourceMappingURL=dealService-th_4Casr.js.map
