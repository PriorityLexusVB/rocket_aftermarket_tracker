{"version":3,"mappings":"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","names":["UnsavedChangesGuard","isDirty","isSubmitting","useEffect","onClickCapture","e","a","href","onPopState","dealServicePromise","emptyLineItem","DealForm","initial","mode","onCancel","onSave","loading","setLoading","useState","saving","setSaving","errorMsg","setErrorMsg","savedAt","setSavedAt","lineErrors","setLineErrors","vendors","setVendors","products","setProducts","sales","setSales","finance","setFinance","delivery","setDelivery","form","setForm","_a","_b","_c","_d","orgId","useTenant","logFormSubmission","logError","useLogger","toast","_e","useToast","initialSnapshot","mounted","vendorsPromise","listVendorsByOrg","getVendors","productsPromise","listProductsByOrg","getProducts","salesPromise","listStaffByOrg","getSalesConsultants","financePromise","getFinanceManagers","deliveryPromise","getDeliveryCoordinators","vOpts","pOpts","sOpts","fOpts","dOpts","selectedProductIds","li","synthetic","pid","productMap","useMemo","m","p","key","handleChange","val","prev","handleLoanerChange","handleLineChange","idx","next","lineItems","prod","errs","copy","row","addLineItem","removeLineItem","_","i","handler","handleCancel","dealSubtotal","sum","qty","price","currencyFmt","submit","arr","el","missingReasonIndexes","requires","reason","first","normalizePhone","s","digits","normalizedLineItems","payload","_f","_g","_h","_i","mod","dealService","savedRecord","mapped","_j","_k","err","msg","jsx","jsxs","v","u","item","itemKey"],"sources":["../../src/components/common/UnsavedChangesGuard.jsx","../../src/pages/deals/DealForm.jsx"],"sourcesContent":["import { useEffect } from 'react'\r\n\r\n// Minimal client-side guard to warn on internal link clicks and back/forward nav\r\nexport default function UnsavedChangesGuard({ isDirty, isSubmitting }) {\r\n  useEffect(() => {\r\n    if (!isDirty || isSubmitting) return\r\n\r\n    const onClickCapture = (e) => {\r\n      // Only intercept left-clicks without modifier keys\r\n      if (e.defaultPrevented || e.button !== 0 || e.metaKey || e.altKey || e.ctrlKey || e.shiftKey)\r\n        return\r\n      // Find closest anchor\r\n      const a = e.target.closest ? e.target.closest('a[href]') : null\r\n      if (!a) return\r\n      // Ignore new-tab or external\r\n      if (a.target === '_blank') return\r\n      const href = a.getAttribute('href') || ''\r\n      if (!href) return\r\n      // Same origin heuristic\r\n      const isExternal = /^(https?:)?\\/\\//i.test(href)\r\n      if (isExternal) return\r\n      // Prompt\r\n      const ok = window.confirm('You have unsaved changes. Discard them?')\r\n      if (!ok) {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n      }\r\n    }\r\n\r\n    const onPopState = (e) => {\r\n      // Prompt on back/forward\r\n      const ok = window.confirm('You have unsaved changes. Discard them?')\r\n      if (!ok) {\r\n        // revert navigation\r\n        history.go(1)\r\n      }\r\n    }\r\n\r\n    document.addEventListener('click', onClickCapture, true)\r\n    window.addEventListener('popstate', onPopState)\r\n    return () => {\r\n      document.removeEventListener('click', onClickCapture, true)\r\n      window.removeEventListener('popstate', onPopState)\r\n    }\r\n  }, [isDirty, isSubmitting])\r\n\r\n  return null\r\n}\r\n","// src/pages/deals/DealForm.jsx\r\nimport React, { useEffect, useMemo, useState } from 'react'\r\nimport {\r\n  getVendors,\r\n  getProducts,\r\n  getSalesConsultants,\r\n  getFinanceManagers,\r\n  getDeliveryCoordinators,\r\n} from '../../services/dropdownService'\r\nimport { listVendorsByOrg, listProductsByOrg, listStaffByOrg } from '../../services/tenantService'\r\nimport useTenant from '../../hooks/useTenant'\r\nimport { useLogger } from '../../hooks/useLogger'\r\nimport UnsavedChangesGuard from '../../components/common/UnsavedChangesGuard'\r\nimport { useToast } from '../../components/ui/ToastProvider'\r\n\r\n// Optional fallback to service-layer create/update if parent didn't pass onSave\r\nlet dealServicePromise\r\ntry {\r\n  dealServicePromise = import('../../services/dealService.js')\r\n} catch (_) {\r\n  // ignore if not present or already injected via props\r\n}\r\n\r\nconst emptyLineItem = () => ({\r\n  product_id: '',\r\n  quantity_used: 1,\r\n  unit_price: 0,\r\n  promised_date: '',\r\n  requires_scheduling: true,\r\n  no_schedule_reason: '',\r\n  is_off_site: false,\r\n})\r\n\r\nexport default function DealForm({\r\n  initial = {},\r\n  mode = 'create', // 'create' | 'edit'\r\n  onCancel,\r\n  onSave, // optional (payload) => Promise<{id}>\r\n}) {\r\n  const [loading, setLoading] = useState(true)\r\n  const [saving, setSaving] = useState(false)\r\n  const [errorMsg, setErrorMsg] = useState('')\r\n  const [savedAt, setSavedAt] = useState(null)\r\n  const [lineErrors, setLineErrors] = useState({})\r\n  const [vendors, setVendors] = useState([])\r\n  const [products, setProducts] = useState([])\r\n  const [sales, setSales] = useState([])\r\n  const [finance, setFinance] = useState([])\r\n  const [delivery, setDelivery] = useState([])\r\n\r\n  const [form, setForm] = useState({\r\n    id: initial.id || undefined,\r\n    job_number: initial.job_number || '',\r\n    vehicle_id: initial.vehicle_id || '',\r\n    stock_number: initial.stock_number || '', // display only if you don’t want editable\r\n    description: initial.description || '',\r\n    vendor_id: initial.vendor_id || '',\r\n    assigned_to: initial.assigned_to || '',\r\n    finance_manager_id: initial.finance_manager_id || '',\r\n    delivery_coordinator_id: initial.delivery_coordinator_id || '',\r\n    customer_mobile: initial.customer_mobile || '',\r\n    customer_needs_loaner: !!initial.customer_needs_loaner,\r\n    loanerForm: {\r\n      loaner_number: initial?.loanerForm?.loaner_number || '',\r\n      eta_return_date: initial?.loanerForm?.eta_return_date || '',\r\n      notes: initial?.loanerForm?.notes || '',\r\n    },\r\n    lineItems: initial.lineItems?.length ? initial.lineItems : [emptyLineItem()],\r\n    promised_date: initial.promised_date || '',\r\n    scheduled_start_time: initial.scheduled_start_time || '',\r\n    scheduled_end_time: initial.scheduled_end_time || '',\r\n    calendar_notes: initial.calendar_notes || '',\r\n  })\r\n\r\n  // Keep local form state in sync when parent provides a new initial (e.g., after save/refetch or route change)\r\n  useEffect(() => {\r\n    // Only sync when a meaningful initial is provided (e.g., edit mode or refetch),\r\n    // not for an empty default object which would clear user input on every render.\r\n    const hasMeaningfulInitial =\r\n      initial &&\r\n      (initial.id ||\r\n        initial.job_number ||\r\n        (Array.isArray(initial.lineItems) && initial.lineItems.length > 0))\r\n    if (!hasMeaningfulInitial) return\r\n\r\n    setForm({\r\n      id: initial.id || undefined,\r\n      job_number: initial.job_number || '',\r\n      vehicle_id: initial.vehicle_id || '',\r\n      stock_number: initial.stock_number || '',\r\n      description: initial.description || '',\r\n      vendor_id: initial.vendor_id || '',\r\n      assigned_to: initial.assigned_to || '',\r\n      finance_manager_id: initial.finance_manager_id || '',\r\n      delivery_coordinator_id: initial.delivery_coordinator_id || '',\r\n      customer_mobile: initial.customer_mobile || '',\r\n      customer_needs_loaner: !!initial.customer_needs_loaner,\r\n      loanerForm: {\r\n        loaner_number: initial?.loanerForm?.loaner_number || '',\r\n        eta_return_date: initial?.loanerForm?.eta_return_date || '',\r\n        notes: initial?.loanerForm?.notes || '',\r\n      },\r\n      lineItems: initial.lineItems?.length ? initial.lineItems : [emptyLineItem()],\r\n      promised_date: initial.promised_date || '',\r\n      scheduled_start_time: initial.scheduled_start_time || '',\r\n      scheduled_end_time: initial.scheduled_end_time || '',\r\n      calendar_notes: initial.calendar_notes || '',\r\n    })\r\n    // We intentionally do not update initialSnapshot here to preserve dirty tracking vs the very first load.\r\n    // The UnsavedChangesGuard still works because isDirty compares to the original initialSnapshot.\r\n    // For edit-after-save UX, the toast/success banner is shown and the new values render from props.\r\n  }, [initial])\r\n\r\n  const { orgId } = useTenant()\r\n  const { logFormSubmission, logError } = useLogger()\r\n  const toast = useToast?.()\r\n  const [initialSnapshot] = useState(() =>\r\n    JSON.stringify({\r\n      id: initial.id || undefined,\r\n      job_number: initial.job_number || '',\r\n      vehicle_id: initial.vehicle_id || '',\r\n      stock_number: initial.stock_number || '',\r\n      description: initial.description || '',\r\n      vendor_id: initial.vendor_id || '',\r\n      assigned_to: initial.assigned_to || '',\r\n      finance_manager_id: initial.finance_manager_id || '',\r\n      delivery_coordinator_id: initial.delivery_coordinator_id || '',\r\n      customer_mobile: initial.customer_mobile || '',\r\n      customer_needs_loaner: !!initial.customer_needs_loaner,\r\n      lineItems: initial.lineItems?.length ? initial.lineItems : [emptyLineItem()],\r\n      promised_date: initial.promised_date || '',\r\n      scheduled_start_time: initial.scheduled_start_time || '',\r\n      scheduled_end_time: initial.scheduled_end_time || '',\r\n      calendar_notes: initial.calendar_notes || '',\r\n    })\r\n  )\r\n\r\n  // Load vendors/products/staff dropdown data\r\n  useEffect(() => {\r\n    let mounted = true\r\n    ;(async () => {\r\n      try {\r\n        const vendorsPromise = orgId ? listVendorsByOrg(orgId, { activeOnly: true }) : getVendors()\r\n        const productsPromise = orgId\r\n          ? listProductsByOrg(orgId, { activeOnly: true })\r\n          : getProducts()\r\n\r\n        // Prefer tenant-aware staff lists when orgId is available\r\n        const salesPromise = orgId\r\n          ? listStaffByOrg(orgId, {\r\n              departments: ['Sales', 'Sales Consultant', 'Sales Consultants'],\r\n              activeOnly: true,\r\n            })\r\n          : getSalesConsultants()\r\n        const financePromise = orgId\r\n          ? listStaffByOrg(orgId, {\r\n              departments: ['Finance', 'Finance Manager', 'Finance Managers', 'Managers'],\r\n              activeOnly: true,\r\n            })\r\n          : getFinanceManagers()\r\n        const deliveryPromise = orgId\r\n          ? listStaffByOrg(orgId, {\r\n              departments: ['Delivery', 'Delivery Coordinator', 'Delivery Coordinators'],\r\n              activeOnly: true,\r\n            })\r\n          : getDeliveryCoordinators()\r\n\r\n        let [vOpts, pOpts, sOpts, fOpts, dOpts] = await Promise.all([\r\n          vendorsPromise,\r\n          productsPromise,\r\n          salesPromise,\r\n          financePromise,\r\n          deliveryPromise,\r\n        ])\r\n\r\n        // Fallbacks\r\n        if (orgId) {\r\n          if (!Array.isArray(sOpts) || sOpts.length === 0) {\r\n            sOpts = await listStaffByOrg(orgId, { activeOnly: true }).catch(() => [])\r\n            if (!sOpts?.length) sOpts = await getSalesConsultants().catch(() => [])\r\n          }\r\n          if (!Array.isArray(fOpts) || fOpts.length === 0) {\r\n            fOpts = await listStaffByOrg(orgId, { activeOnly: true }).catch(() => [])\r\n            if (!fOpts?.length) fOpts = await getFinanceManagers().catch(() => [])\r\n          }\r\n          if (!Array.isArray(dOpts) || dOpts.length === 0) {\r\n            dOpts = await listStaffByOrg(orgId, { activeOnly: true }).catch(() => [])\r\n            if (!dOpts?.length) dOpts = await getDeliveryCoordinators().catch(() => [])\r\n          }\r\n        }\r\n        if (!mounted) return\r\n        setVendors(vOpts || [])\r\n        setProducts(pOpts || [])\r\n        setSales(sOpts || [])\r\n        setFinance(fOpts || [])\r\n        setDelivery(dOpts || [])\r\n      } catch (e) {\r\n        console.error('DealForm dropdown load error', e)\r\n      } finally {\r\n        if (mounted) setLoading(false)\r\n      }\r\n    })()\r\n    return () => {\r\n      mounted = false\r\n    }\r\n  }, [orgId])\r\n\r\n  // Synthetic option reconciliation so selected values render immediately\r\n  useEffect(() => {\r\n    // Vendors\r\n    if (!vendors?.length && form?.vendor_id) {\r\n      setVendors([{ id: form.vendor_id, value: form.vendor_id, label: 'Selected vendor' }])\r\n    }\r\n    // Sales\r\n    if (!sales?.length && form?.assigned_to) {\r\n      setSales([{ id: form.assigned_to, value: form.assigned_to, label: 'Selected sales' }])\r\n    }\r\n    // Finance\r\n    if (!finance?.length && form?.finance_manager_id) {\r\n      setFinance([\r\n        { id: form.finance_manager_id, value: form.finance_manager_id, label: 'Selected finance' },\r\n      ])\r\n    }\r\n    // Delivery\r\n    if (!delivery?.length && form?.delivery_coordinator_id) {\r\n      setDelivery([\r\n        {\r\n          id: form.delivery_coordinator_id,\r\n          value: form.delivery_coordinator_id,\r\n          label: 'Selected delivery',\r\n        },\r\n      ])\r\n    }\r\n    // Products – seed any selected product ids from line items with their current unit_price\r\n    const selectedProductIds = new Set(\r\n      (form?.lineItems || [])\r\n        .map((li) => (li?.product_id ? String(li.product_id) : null))\r\n        .filter(Boolean)\r\n    )\r\n    if (!products?.length && selectedProductIds.size > 0) {\r\n      const synthetic = []\r\n      ;(form?.lineItems || []).forEach((li) => {\r\n        if (!li?.product_id) return\r\n        const pid = String(li.product_id)\r\n        if (selectedProductIds.has(pid)) {\r\n          synthetic.push({\r\n            id: pid,\r\n            value: pid,\r\n            label: 'Selected product',\r\n            unit_price: Number(li?.unit_price ?? 0),\r\n          })\r\n          selectedProductIds.delete(pid)\r\n        }\r\n      })\r\n      if (synthetic.length) setProducts(synthetic)\r\n    }\r\n    // We intentionally do not include vendors/products/sales/... in deps to avoid loops when real data loads\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [form])\r\n\r\n  const productMap = useMemo(() => {\r\n    const m = new Map()\r\n    ;(products || []).forEach((p) => {\r\n      // options come as { id, value, label, unit_price }\r\n      const key = p.id ?? p.value\r\n      if (key != null) m.set(String(key), p)\r\n    })\r\n    return m\r\n  }, [products])\r\n\r\n  const handleChange = (key, val) => setForm((prev) => ({ ...prev, [key]: val }))\r\n\r\n  const handleLoanerChange = (key, val) =>\r\n    setForm((prev) => ({ ...prev, loanerForm: { ...(prev.loanerForm || {}), [key]: val } }))\r\n\r\n  const handleLineChange = (idx, key, val) =>\r\n    setForm((prev) => {\r\n      const next = { ...prev }\r\n      const lineItems = Array.isArray(next.lineItems) ? [...next.lineItems] : []\r\n      const li = { ...(lineItems[idx] || {}) }\r\n      li[key] = val\r\n      if (key === 'product_id') {\r\n        // ensure we look up by the option value string\r\n        const prod = productMap.get(String(val))\r\n        if (prod && prod.unit_price !== undefined) {\r\n          li.unit_price = Number(prod.unit_price || 0)\r\n        }\r\n      }\r\n      // Clear validation error when user fixes the issue\r\n      if (key === 'no_schedule_reason' && String(val || '').trim()) {\r\n        setLineErrors((errs) => {\r\n          if (!errs || !errs[idx]?.noScheduleReason) return errs\r\n          const copy = { ...errs }\r\n          const row = { ...(copy[idx] || {}) }\r\n          delete row.noScheduleReason\r\n          if (!Object.keys(row).length) delete copy[idx]\r\n          else copy[idx] = row\r\n          return copy\r\n        })\r\n      }\r\n      if (key === 'requires_scheduling' && !!val) {\r\n        // if user now requires scheduling, clear the previous missing-reason error\r\n        setLineErrors((errs) => {\r\n          if (!errs || !errs[idx]?.noScheduleReason) return errs\r\n          const copy = { ...errs }\r\n          const row = { ...(copy[idx] || {}) }\r\n          delete row.noScheduleReason\r\n          if (!Object.keys(row).length) delete copy[idx]\r\n          else copy[idx] = row\r\n          return copy\r\n        })\r\n      }\r\n      lineItems[idx] = li\r\n      next.lineItems = lineItems\r\n      return next\r\n    })\r\n\r\n  const addLineItem = () => setForm((p) => ({ ...p, lineItems: [...p.lineItems, emptyLineItem()] }))\r\n  const removeLineItem = (idx) =>\r\n    setForm((p) => ({ ...p, lineItems: p.lineItems.filter((_, i) => i !== idx) }))\r\n\r\n  // Dirty tracking for unsaved-changes guard\r\n  const isDirty = useMemo(() => {\r\n    try {\r\n      return JSON.stringify(form) !== initialSnapshot\r\n    } catch {\r\n      return true\r\n    }\r\n  }, [form, initialSnapshot])\r\n\r\n  useEffect(() => {\r\n    const handler = (e) => {\r\n      if (!isDirty || saving) return\r\n      e.preventDefault()\r\n      e.returnValue = ''\r\n      return ''\r\n    }\r\n    window.addEventListener('beforeunload', handler)\r\n    return () => window.removeEventListener('beforeunload', handler)\r\n  }, [isDirty, saving])\r\n\r\n  const handleCancel = () => {\r\n    if (saving) return\r\n    if (isDirty) {\r\n      const ok = window.confirm('You have unsaved changes. Discard them?')\r\n      if (!ok) return\r\n    }\r\n    onCancel?.()\r\n  }\r\n\r\n  // Totals bar calculation (qty is always 1, but keep quantity_used support)\r\n  const dealSubtotal = useMemo(() => {\r\n    try {\r\n      return (form.lineItems || []).reduce((sum, li) => {\r\n        const qty = Number(li?.quantity_used ?? 1) || 1\r\n        const price = Number(li?.unit_price ?? 0) || 0\r\n        return sum + qty * price\r\n      }, 0)\r\n    } catch {\r\n      return 0\r\n    }\r\n  }, [form.lineItems])\r\n\r\n  const currencyFmt = useMemo(\r\n    () => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }),\r\n    []\r\n  )\r\n\r\n  const submit = async (e) => {\r\n    e?.preventDefault?.()\r\n    // Prevent duplicate submits\r\n    if (saving) return\r\n    setSaving(true)\r\n    setErrorMsg('')\r\n    try {\r\n      // Guard: require at least one valid product selection\r\n      const validProductIdxs = (form.lineItems || []).reduce((arr, li, idx) => {\r\n        if (li?.product_id) arr.push(idx)\r\n        return arr\r\n      }, [])\r\n      if (validProductIdxs.length === 0) {\r\n        setSaving(false)\r\n        setErrorMsg('Please add at least one product to the deal.')\r\n        // Focus first product dropdown\r\n        try {\r\n          const el = document.querySelector('[data-testid=\"product-select-0\"]')\r\n          el?.scrollIntoView({ behavior: 'smooth', block: 'center' })\r\n          el?.focus?.()\r\n        } catch {}\r\n        return\r\n      }\r\n\r\n      // Guard: If requires_scheduling === false, no_schedule_reason is required\r\n      const missingReasonIndexes = (form.lineItems || []).reduce((arr, li, idx) => {\r\n        const requires = !!li?.requires_scheduling\r\n        const reason = String(li?.no_schedule_reason || '').trim()\r\n        if (!requires && !reason) arr.push(idx)\r\n        return arr\r\n      }, [])\r\n      if (missingReasonIndexes.length > 0) {\r\n        const errs = {}\r\n        missingReasonIndexes.forEach((i) => {\r\n          errs[i] = { ...(errs[i] || {}), noScheduleReason: true }\r\n        })\r\n        setLineErrors(errs)\r\n        setSaving(false)\r\n        // Focus first offending field for quicker correction\r\n        try {\r\n          const first = missingReasonIndexes[0]\r\n          const el = document.querySelector(`[data-testid=\"no-schedule-reason-${first}\"]`)\r\n          el?.scrollIntoView({ behavior: 'smooth', block: 'center' })\r\n          el?.focus?.()\r\n        } catch {}\r\n        return\r\n      } else {\r\n        setLineErrors({})\r\n      }\r\n\r\n      // Light phone normalization (digits only; prefix +1 for 10-digit US)\r\n      const normalizePhone = (s) => {\r\n        try {\r\n          const digits = String(s || '').replace(/\\D+/g, '')\r\n          if (digits.length === 10) return `+1${digits}`\r\n          if (digits.length === 11 && digits.startsWith('1')) return `+${digits}`\r\n          return s || ''\r\n        } catch {\r\n          return s || ''\r\n        }\r\n      }\r\n\r\n      // Build payload that includes both snake_case (UI) and camelCase (service) fields\r\n      const normalizedLineItems = (form.lineItems || []).map((li) => ({\r\n        product_id: li.product_id || null,\r\n        quantity_used: Number(li.quantity_used || 1),\r\n        unit_price: Number(li.unit_price || 0),\r\n        // snake_case (UI)\r\n        promised_date: li.promised_date || li.lineItemPromisedDate || null,\r\n        requires_scheduling: !!li.requires_scheduling || !!li.requiresScheduling,\r\n        no_schedule_reason: li.no_schedule_reason || li.noScheduleReason || null,\r\n        is_off_site: !!li.is_off_site || !!li.isOffSite,\r\n        // camelCase (service compatibility)\r\n        lineItemPromisedDate: li.lineItemPromisedDate || li.promised_date || null,\r\n        requiresScheduling: !!li.requiresScheduling || !!li.requires_scheduling,\r\n        noScheduleReason: li.noScheduleReason || li.no_schedule_reason || null,\r\n        isOffSite: !!li.isOffSite || !!li.is_off_site,\r\n      }))\r\n\r\n      const payload = {\r\n        ...form,\r\n        // attach tenant org for write policies when available\r\n        org_id: form.org_id || orgId || undefined,\r\n        customer_needs_loaner: !!form.customer_needs_loaner,\r\n        // pass loaner details to the service (service gracefully ignores when number is empty)\r\n        loanerForm: form.customer_needs_loaner\r\n          ? {\r\n              loaner_number: form?.loanerForm?.loaner_number?.trim() || '',\r\n              eta_return_date: form?.loanerForm?.eta_return_date || null,\r\n              notes: form?.loanerForm?.notes || '',\r\n            }\r\n          : null,\r\n        // mirror phone fields for downstream services\r\n        customer_phone: normalizePhone(form.customer_phone || form.customer_mobile || ''),\r\n        customerPhone: normalizePhone(\r\n          form.customerPhone || form.customer_mobile || form.customer_phone || ''\r\n        ),\r\n        lineItems: normalizedLineItems,\r\n      }\r\n\r\n      if (onSave) {\r\n        // parent-provided save handler is authoritative (handles navigation/closing)\r\n        await onSave(payload)\r\n        await logFormSubmission?.(\r\n          'DealForm',\r\n          { orgId, hasLineItems: payload?.lineItems?.length > 0 },\r\n          true\r\n        )\r\n        setSavedAt(Date.now())\r\n        try {\r\n          toast?.success?.('Saved successfully')\r\n        } catch {}\r\n      } else if (dealServicePromise) {\r\n        const mod = await dealServicePromise\r\n        const dealService = mod?.default ?? mod\r\n        // Use service directly and reflect the saved record in the form (do not auto-close)\r\n        let savedRecord = null\r\n        if (mode === 'edit' && payload.id) {\r\n          savedRecord = await dealService.updateDeal(payload.id, payload)\r\n        } else {\r\n          savedRecord = await dealService.createDeal(payload)\r\n        }\r\n\r\n        if (savedRecord) {\r\n          // map DB shape to form if helper exists\r\n          try {\r\n            const mapped = dealService.mapDbDealToForm\r\n              ? dealService.mapDbDealToForm(savedRecord)\r\n              : null\r\n            if (mapped)\r\n              setForm((prev) => ({ ...prev, ...mapped, lineItems: mapped.lineItems || [] }))\r\n          } catch (e) {\r\n            // fallback: do nothing if mapping fails\r\n            console.warn('Failed to map saved record to form:', e)\r\n          }\r\n        }\r\n        await logFormSubmission?.(\r\n          'DealForm',\r\n          { orgId, hasLineItems: payload?.lineItems?.length > 0 },\r\n          true\r\n        )\r\n        setSavedAt(Date.now())\r\n        try {\r\n          toast?.success?.('Saved successfully')\r\n        } catch {}\r\n      }\r\n    } catch (err) {\r\n      const msg = err?.message || String(err)\r\n      console.error('Deal save failed', err)\r\n      setErrorMsg(msg)\r\n      try {\r\n        await logError?.(err, { where: 'DealForm.submit', orgId })\r\n      } catch (_) {}\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  if (loading) return <div className=\"p-4\">Loading…</div>\r\n\r\n  return (\r\n    <form className=\"space-y-6 p-4\" onSubmit={submit} data-testid=\"deal-form\">\r\n      {/* Quick Identifiers */}\r\n      <section className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Deal / Job #</label>\r\n          <input\r\n            data-testid=\"deal-number-input\"\r\n            type=\"text\"\r\n            value={form.job_number}\r\n            onChange={(e) => handleChange('job_number', e.target.value)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n            placeholder=\"Auto or manual\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Stock #</label>\r\n          <input\r\n            data-testid=\"stock-number-display\"\r\n            type=\"text\"\r\n            value={form.stock_number || ''}\r\n            onChange={(e) => handleChange('stock_number', e.target.value)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n            placeholder=\"e.g. A1234\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Customer Mobile</label>\r\n          <input\r\n            data-testid=\"customer-mobile-input\"\r\n            type=\"tel\"\r\n            value={form.customer_mobile}\r\n            onChange={(e) => handleChange('customer_mobile', e.target.value)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n            placeholder=\"+1 555 555 5555\"\r\n          />\r\n        </div>\r\n      </section>\r\n\r\n      {/* Primary Info */}\r\n      <section className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Vendor</label>\r\n          <select\r\n            data-testid=\"vendor-select\"\r\n            value={form.vendor_id || ''}\r\n            onChange={(e) => handleChange('vendor_id', e.target.value || null)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n          >\r\n            <option value=\"\">— Select Vendor —</option>\r\n            {vendors.map((v) => (\r\n              <option key={v.id} value={v.value}>\r\n                {v.label}\r\n              </option>\r\n            ))}\r\n          </select>\r\n          {vendors.length === 0 && (\r\n            <p className=\"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1\">\r\n              No vendors available. Check Admin → Vendors to add or attach vendors to your org.\r\n            </p>\r\n          )}\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Description</label>\r\n          <textarea\r\n            data-testid=\"description-input\"\r\n            value={form.description}\r\n            onChange={(e) => handleChange('description', e.target.value)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n            rows={3}\r\n          />\r\n        </div>\r\n      </section>\r\n\r\n      {/* Staff */}\r\n      <section className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Sales Consultant</label>\r\n          <select\r\n            data-testid=\"sales-select\"\r\n            value={form.assigned_to || ''}\r\n            onChange={(e) => handleChange('assigned_to', e.target.value || null)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n          >\r\n            <option value=\"\">— Select Sales —</option>\r\n            {sales.map((u) => (\r\n              <option key={u.id} value={u.value}>\r\n                {u.label}\r\n              </option>\r\n            ))}\r\n          </select>\r\n          {sales.length === 0 && (\r\n            <p className=\"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1\">\r\n              No sales staff found. Use Admin → Staff Records to add staff and assign to your org.\r\n            </p>\r\n          )}\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Finance Manager</label>\r\n          <select\r\n            data-testid=\"finance-select\"\r\n            value={form.finance_manager_id || ''}\r\n            onChange={(e) => handleChange('finance_manager_id', e.target.value || null)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n          >\r\n            <option value=\"\">— Select Finance —</option>\r\n            {finance.map((u) => (\r\n              <option key={u.id} value={u.value}>\r\n                {u.label}\r\n              </option>\r\n            ))}\r\n          </select>\r\n          {finance.length === 0 && (\r\n            <p className=\"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1\">\r\n              No finance managers found. Add or attach staff in Admin → Staff Records.\r\n            </p>\r\n          )}\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-slate-700\">Delivery Coordinator</label>\r\n          <select\r\n            data-testid=\"delivery-select\"\r\n            value={form.delivery_coordinator_id || ''}\r\n            onChange={(e) => handleChange('delivery_coordinator_id', e.target.value || null)}\r\n            className=\"mt-1 input-mobile w-full\"\r\n          >\r\n            <option value=\"\">— Select Delivery —</option>\r\n            {delivery.map((u) => (\r\n              <option key={u.id} value={u.value}>\r\n                {u.label}\r\n              </option>\r\n            ))}\r\n          </select>\r\n          {delivery.length === 0 && (\r\n            <p className=\"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1\">\r\n              No delivery coordinators found. Add or attach staff in Admin → Staff Records.\r\n            </p>\r\n          )}\r\n        </div>\r\n      </section>\r\n\r\n      {/* Customer needs loaner */}\r\n      <section className=\"flex items-center gap-3\">\r\n        <input\r\n          data-testid=\"loaner-checkbox\"\r\n          id=\"needsLoaner\"\r\n          type=\"checkbox\"\r\n          checked={!!form.customer_needs_loaner}\r\n          onChange={(e) => handleChange('customer_needs_loaner', e.target.checked)}\r\n          className=\"h-5 w-5 accent-blue-600 appearance-auto\"\r\n        />\r\n        <label htmlFor=\"needsLoaner\" className=\"text-sm text-slate-800\">\r\n          Customer needs loaner\r\n        </label>\r\n      </section>\r\n\r\n      {form.customer_needs_loaner ? (\r\n        <section className=\"grid grid-cols-1 md:grid-cols-3 gap-4\" data-testid=\"loaner-section\">\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-700\">Loaner Number</label>\r\n            <input\r\n              data-testid=\"loaner-number-input\"\r\n              type=\"text\"\r\n              value={form?.loanerForm?.loaner_number || ''}\r\n              onChange={(e) => handleLoanerChange('loaner_number', e.target.value)}\r\n              className=\"mt-1 input-mobile w-full\"\r\n              placeholder=\"e.g. L-1024\"\r\n            />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-700\">ETA Return Date</label>\r\n            <input\r\n              data-testid=\"loaner-eta-input\"\r\n              type=\"date\"\r\n              value={form?.loanerForm?.eta_return_date || ''}\r\n              onChange={(e) => handleLoanerChange('eta_return_date', e.target.value || '')}\r\n              className=\"mt-1 input-mobile w-full\"\r\n            />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-700\">Notes</label>\r\n            <input\r\n              data-testid=\"loaner-notes-input\"\r\n              type=\"text\"\r\n              value={form?.loanerForm?.notes || ''}\r\n              onChange={(e) => handleLoanerChange('notes', e.target.value)}\r\n              className=\"mt-1 input-mobile w-full\"\r\n              placeholder=\"Optional\"\r\n            />\r\n          </div>\r\n        </section>\r\n      ) : null}\r\n\r\n      {/* Line Items */}\r\n      <section className=\"space-y-4\" data-testid=\"line-items-section\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h3 className=\"text-lg font-semibold\">Line Items</h3>\r\n          <button\r\n            type=\"button\"\r\n            onClick={addLineItem}\r\n            className=\"btn-mobile btn-mobile-sm\"\r\n            data-testid=\"add-line-item-btn\"\r\n          >\r\n            + Add Item\r\n          </button>\r\n        </div>\r\n        {products.length === 0 && (\r\n          <div className=\"p-3 rounded bg-amber-50 text-amber-800 text-sm\">\r\n            No products available. Check Admin → Aftermarket Products to add/attach products.\r\n          </div>\r\n        )}\r\n\r\n        {form.lineItems.map((item, idx) => {\r\n          const itemKey = `li-${idx}`\r\n          const onSiteSelected = !item.is_off_site\r\n          return (\r\n            <div key={itemKey} className=\"card-mobile space-y-3\" data-testid={`line-${idx}`}>\r\n              {/* Product + price */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-5 gap-3\">\r\n                <div className=\"md:col-span-3\">\r\n                  <label className=\"block text-sm font-medium text-slate-700\">Product</label>\r\n                  <select\r\n                    data-testid={`product-select-${idx}`}\r\n                    value={item.product_id || ''}\r\n                    onChange={(e) => handleLineChange(idx, 'product_id', e.target.value || '')}\r\n                    className=\"mt-1 input-mobile w-full\"\r\n                  >\r\n                    <option value=\"\">— Select Product —</option>\r\n                    {products.map((p) => (\r\n                      <option key={p.id} value={p.value}>\r\n                        {p.label}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700\">Unit Price</label>\r\n                  <input\r\n                    data-testid={`unit-price-input-${idx}`}\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    value={item.unit_price}\r\n                    onChange={(e) =>\r\n                      handleLineChange(idx, 'unit_price', Number(e.target.value || 0))\r\n                    }\r\n                    className=\"mt-1 input-mobile w-full\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-end\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => removeLineItem(idx)}\r\n                    className=\"btn-mobile btn-mobile-sm w-full\"\r\n                    data-testid={`remove-line-item-btn-${idx}`}\r\n                  >\r\n                    Remove\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Service location tiles (On-Site vs Off-Site) */}\r\n              <div className=\"flex gap-3\">\r\n                {/* On-Site */}\r\n                <label\r\n                  className={`inline-flex items-center gap-2 cursor-pointer border rounded px-3 py-2\r\n                    ${!item.is_off_site ? 'ring-2 ring-blue-400 bg-blue-50 border-blue-300' : 'border-gray-300'}`}\r\n                >\r\n                  <input\r\n                    type=\"radio\"\r\n                    name={`serviceLocation_${itemKey}`}\r\n                    checked={!item.is_off_site}\r\n                    onChange={() => handleLineChange(idx, 'is_off_site', false)}\r\n                    className=\"h-4 w-4 accent-blue-600 appearance-auto\"\r\n                    data-testid={`onsite-radio-${idx}`}\r\n                  />\r\n                  <span className=\"text-sm\">On-Site</span>\r\n                </label>\r\n\r\n                {/* Off-Site */}\r\n                <label\r\n                  className={`inline-flex items-center gap-2 cursor-pointer border rounded px-3 py-2\r\n                    ${item.is_off_site ? 'ring-2 ring-blue-400 bg-blue-50 border-blue-300' : 'border-gray-300'}`}\r\n                >\r\n                  <input\r\n                    type=\"radio\"\r\n                    name={`serviceLocation_${itemKey}`}\r\n                    checked={!!item.is_off_site}\r\n                    onChange={() => handleLineChange(idx, 'is_off_site', true)}\r\n                    className=\"h-4 w-4 accent-blue-600 appearance-auto\"\r\n                    data-testid={`offsite-radio-${idx}`}\r\n                  />\r\n                  <span className=\"text-sm\">Off-Site</span>\r\n                </label>\r\n              </div>\r\n\r\n              {/* Scheduling controls */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700\">Promised Date</label>\r\n                  <input\r\n                    data-testid={`promised-date-${idx}`}\r\n                    type=\"date\"\r\n                    value={item.promised_date || ''}\r\n                    onChange={(e) => handleLineChange(idx, 'promised_date', e.target.value || '')}\r\n                    className=\"mt-1 input-mobile w-full\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2 mt-6\">\r\n                  <input\r\n                    id={`requiresScheduling-${idx}`}\r\n                    data-testid={`requires-scheduling-${idx}`}\r\n                    type=\"checkbox\"\r\n                    checked={!!item.requires_scheduling}\r\n                    onChange={(e) => handleLineChange(idx, 'requires_scheduling', e.target.checked)}\r\n                    className=\"h-5 w-5 accent-blue-600 appearance-auto\"\r\n                  />\r\n                  <label htmlFor={`requiresScheduling-${idx}`} className=\"text-sm\">\r\n                    Requires Scheduling\r\n                  </label>\r\n                </div>\r\n\r\n                {!item.requires_scheduling && (\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-slate-700\">\r\n                      No Schedule Reason\r\n                    </label>\r\n                    <input\r\n                      data-testid={`no-schedule-reason-${idx}`}\r\n                      type=\"text\"\r\n                      value={item.no_schedule_reason || ''}\r\n                      onChange={(e) =>\r\n                        handleLineChange(idx, 'no_schedule_reason', e.target.value || '')\r\n                      }\r\n                      className=\"mt-1 input-mobile w-full\"\r\n                    />\r\n                    {lineErrors?.[idx]?.noScheduleReason && (\r\n                      <p className=\"mt-1 text-sm text-red-600\">\r\n                        Reason is required when not scheduling.\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )\r\n        })}\r\n      </section>\r\n\r\n      {/* Calendar notes (optional) */}\r\n      <section>\r\n        <label className=\"block text-sm font-medium text-slate-700\">Calendar Notes</label>\r\n        <textarea\r\n          data-testid=\"calendar-notes-input\"\r\n          value={form.calendar_notes || ''}\r\n          onChange={(e) => handleChange('calendar_notes', e.target.value)}\r\n          className=\"mt-1 input-mobile w-full\"\r\n          rows={3}\r\n        />\r\n      </section>\r\n\r\n      {/* Sticky actions + total (mobile-safe) */}\r\n      <section\r\n        className=\"sticky bottom-20 md:bottom-0 z-40 -mx-4 px-4 py-3 bg-white/90 backdrop-blur border-t shadow-sm\"\r\n        style={{ paddingBottom: 'max(env(safe-area-inset-bottom), 0px)' }}\r\n      >\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <div className=\"flex items-baseline gap-2\" data-testid=\"deal-total\">\r\n            <span className=\"text-sm text-slate-600\">Total</span>\r\n            <span className=\"text-lg font-semibold\" data-testid=\"deal-total-amount\">\r\n              {currencyFmt.format(dealSubtotal || 0)}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleCancel}\r\n              className=\"btn-mobile button-outline-enhanced\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={saving}\r\n              className=\"btn-mobile button-enhanced\"\r\n              data-testid=\"save-deal-btn\"\r\n            >\r\n              {saving ? 'Saving…' : mode === 'edit' ? 'Save Changes' : 'Create Deal'}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {errorMsg ? (\r\n        <div className=\"mt-3 p-3 rounded bg-red-50 text-red-700\" data-testid=\"save-error\">\r\n          {errorMsg}\r\n        </div>\r\n      ) : null}\r\n      {savedAt && !errorMsg ? (\r\n        <div className=\"mt-3 p-3 rounded bg-emerald-50 text-emerald-700\" data-testid=\"save-success\">\r\n          Saved successfully.\r\n        </div>\r\n      ) : null}\r\n      <UnsavedChangesGuard isDirty={isDirty} isSubmitting={saving} />\r\n    </form>\r\n  )\r\n}\r\n"],"file":"assets/DealForm-BYWQGd4G.js"}