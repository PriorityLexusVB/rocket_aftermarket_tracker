{"version":3,"file":"index-Blv7h66j.js","sources":["../../src/services/advancedFeaturesService.js","../../src/components/common/ExportButton.jsx","../../src/services/vehicleService.js","../../src/pages/deals/NewDealModal.jsx","../../src/services/productService.js","../../src/services/staffService.js","../../src/hooks/useDropdownData.js","../../src/components/ui/Portal.jsx","../../src/components/ui/SearchableSelect.jsx","../../src/pages/deals/components/EditDealModal.jsx","../../src/pages/deals/index.jsx"],"sourcesContent":["import React, { useState, useEffect } from 'react'\r\nimport { supabase } from '@/lib/supabase'\r\n\r\n// Utility functions for safe data handling\r\nconst safeNumber = (value, defaultValue = 0) => {\r\n  if (value === null || value === undefined || value === '') return defaultValue\r\n  const parsed = parseFloat(value)\r\n  return isNaN(parsed) ? defaultValue : parsed\r\n}\r\n\r\nconst safeString = (value, defaultValue = '') => {\r\n  return value === null || value === undefined ? defaultValue : String(value)\r\n}\r\n\r\n// Enhanced service with all advanced features\r\nexport const advancedFeaturesService = {\r\n  // Overdue Jobs Service\r\n  async getOverdueJobs() {\r\n    try {\r\n      const { data, error } = await supabase?.rpc('get_overdue_jobs_enhanced')\r\n\r\n      if (error) {\r\n        console.error('Error fetching overdue jobs:', error)\r\n        return { data: [], error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      console.error('Error in getOverdueJobs service:', error)\r\n      return { data: [], error: { message: 'Failed to fetch overdue jobs' } }\r\n    }\r\n  },\r\n\r\n  // SMS Template Service\r\n  async getSmsTemplates() {\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('sms_templates')\r\n        ?.select('*')\r\n        ?.eq('is_active', true)\r\n        ?.order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        return { data: [], error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      console.error('Error fetching SMS templates:', error)\r\n      return { data: [], error: { message: 'Failed to fetch SMS templates' } }\r\n    }\r\n  },\r\n\r\n  async createSmsTemplate(template) {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n      const { data, error } = await supabase\r\n        ?.from('sms_templates')\r\n        ?.insert([\r\n          {\r\n            ...template,\r\n            created_by: currentUser?.data?.user?.id,\r\n          },\r\n        ])\r\n        ?.select()\r\n        ?.single()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      console.error('Error creating SMS template:', error)\r\n      return { data: null, error: { message: 'Failed to create SMS template' } }\r\n    }\r\n  },\r\n\r\n  async updateSmsTemplate(id, updates) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('sms_templates')\r\n        ?.update({\r\n          ...updates,\r\n          updated_at: new Date()?.toISOString(),\r\n        })\r\n        ?.eq('id', id)\r\n        ?.select()\r\n        ?.single()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      console.error('Error updating SMS template:', error)\r\n      return { data: null, error: { message: 'Failed to update SMS template' } }\r\n    }\r\n  },\r\n\r\n  async deleteSmsTemplate(id) {\r\n    try {\r\n      const { error } = await supabase?.from('sms_templates')?.delete()?.eq('id', id)\r\n\r\n      if (error) {\r\n        return { error: { message: error?.message } }\r\n      }\r\n\r\n      return { error: null }\r\n    } catch (error) {\r\n      console.error('Error deleting SMS template:', error)\r\n      return { error: { message: 'Failed to delete SMS template' } }\r\n    }\r\n  },\r\n\r\n  // Filter Presets Service\r\n  async getFilterPresets(pageType) {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n      const { data, error } = await supabase\r\n        ?.from('filter_presets')\r\n        ?.select('*')\r\n        ?.eq('page_type', pageType)\r\n        ?.or(`user_id.eq.${currentUser?.data?.user?.id},is_public.eq.true`)\r\n        ?.order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        return { data: [], error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      console.error('Error fetching filter presets:', error)\r\n      return { data: [], error: { message: 'Failed to fetch filter presets' } }\r\n    }\r\n  },\r\n\r\n  async saveFilterPreset(pageType, name, filters, isPublic = false) {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n      const { data, error } = await supabase\r\n        ?.from('filter_presets')\r\n        ?.insert([\r\n          {\r\n            user_id: currentUser?.data?.user?.id,\r\n            page_type: pageType,\r\n            name,\r\n            filters,\r\n            is_public: isPublic,\r\n          },\r\n        ])\r\n        ?.select()\r\n        ?.single()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      console.error('Error saving filter preset:', error)\r\n      return { data: null, error: { message: 'Failed to save filter preset' } }\r\n    }\r\n  },\r\n\r\n  async deleteFilterPreset(id) {\r\n    try {\r\n      const { error } = await supabase?.from('filter_presets')?.delete()?.eq('id', id)\r\n\r\n      if (error) {\r\n        return { error: { message: error?.message } }\r\n      }\r\n\r\n      return { error: null }\r\n    } catch (error) {\r\n      console.error('Error deleting filter preset:', error)\r\n      return { error: { message: 'Failed to delete filter preset' } }\r\n    }\r\n  },\r\n\r\n  // Export Service\r\n  async exportData(exportType, filters = {}, userRole = 'staff') {\r\n    try {\r\n      const { data, error } = await supabase?.rpc('generate_export_data', {\r\n        export_type: exportType,\r\n        filters,\r\n        user_role: userRole,\r\n      })\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      // Clean and validate export data to prevent NaN/undefined values\r\n      const cleanedData = (data || [])?.map((item) => {\r\n        const exportData = item?.export_data || item\r\n        const cleanedExportData = {}\r\n\r\n        Object?.entries(exportData)?.forEach(([key, value]) => {\r\n          if (typeof value === 'number') {\r\n            cleanedExportData[key] = isNaN(value) ? 0 : value\r\n          } else if (value === null || value === undefined) {\r\n            cleanedExportData[key] = ''\r\n          } else {\r\n            cleanedExportData[key] = value\r\n          }\r\n        })\r\n\r\n        return { export_data: cleanedExportData }\r\n      })\r\n\r\n      return { data: cleanedData, error: null }\r\n    } catch (error) {\r\n      console.error('Error exporting data:', error)\r\n      return { data: null, error: { message: 'Failed to export data' } }\r\n    }\r\n  },\r\n\r\n  async exportToCSV(data, filename, headers = null) {\r\n    try {\r\n      if (!data || data?.length === 0) {\r\n        throw new Error('No data to export')\r\n      }\r\n\r\n      let csvContent = ''\r\n\r\n      // Add headers\r\n      if (headers) {\r\n        csvContent += headers?.join(',') + '\\n'\r\n      } else {\r\n        // Use object keys as headers for JSONB data\r\n        const firstRow = data?.[0]?.export_data || data?.[0]\r\n        if (firstRow) {\r\n          csvContent += Object?.keys(firstRow)?.join(',') + '\\n'\r\n        }\r\n      }\r\n\r\n      // Add data rows with safe value handling\r\n      data?.forEach((row) => {\r\n        const rowData = row?.export_data || row\r\n        const values = Object?.values(rowData)?.map((value) => {\r\n          // Handle nulls, undefined, and NaN values\r\n          if (value === null || value === undefined) return ''\r\n\r\n          // Handle NaN specifically\r\n          if (typeof value === 'number' && isNaN(value)) return '0'\r\n\r\n          // Convert to string safely\r\n          let stringValue = safeString(value)\r\n\r\n          // Escape commas and quotes in CSV\r\n          if (stringValue?.includes(',') || stringValue?.includes('\"')) {\r\n            return `\"${stringValue?.replace(/\"/g, '\"\"')}\"`\r\n          }\r\n\r\n          return stringValue\r\n        })\r\n        csvContent += values?.join(',') + '\\n'\r\n      })\r\n\r\n      // Create and download file\r\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })\r\n      const link = document.createElement('a')\r\n\r\n      if (link?.download !== undefined) {\r\n        const url = URL?.createObjectURL(blob)\r\n        link?.setAttribute('href', url)\r\n        link?.setAttribute('download', filename)\r\n        link.style.visibility = 'hidden'\r\n        document.body?.appendChild(link)\r\n        link?.click()\r\n        document.body?.removeChild(link)\r\n        // Clean up the URL object\r\n        URL?.revokeObjectURL(url)\r\n      }\r\n\r\n      return { success: true, error: null }\r\n    } catch (error) {\r\n      console.error('Export to CSV error:', error)\r\n      return { success: false, error: { message: error?.message || 'Failed to export CSV' } }\r\n    }\r\n  },\r\n\r\n  // Bulk Operations Service\r\n  async bulkUpdateJobs(jobIds, updates) {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n      const { data, error } = await supabase?.rpc('bulk_update_jobs', {\r\n        job_ids: jobIds,\r\n        updates,\r\n        performed_by: currentUser?.data?.user?.id,\r\n      })\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data?.[0] || null, error: null }\r\n    } catch (error) {\r\n      console.error('Error in bulk update jobs:', error)\r\n      return { data: null, error: { message: 'Failed to bulk update jobs' } }\r\n    }\r\n  },\r\n\r\n  // Notification Service\r\n  async getNotificationPreferences() {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n      const { data, error } = await supabase\r\n        ?.from('notification_preferences')\r\n        ?.select('*')\r\n        ?.eq('user_id', currentUser?.data?.user?.id)\r\n\r\n      if (error) {\r\n        return { data: [], error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      console.error('Error fetching notification preferences:', error)\r\n      return { data: [], error: { message: 'Failed to fetch notification preferences' } }\r\n    }\r\n  },\r\n\r\n  async updateNotificationPreferences(preferences) {\r\n    try {\r\n      const currentUser = await supabase?.auth?.getUser()\r\n\r\n      // Delete existing preferences and insert new ones\r\n      await supabase\r\n        ?.from('notification_preferences')\r\n        ?.delete()\r\n        ?.eq('user_id', currentUser?.data?.user?.id)\r\n\r\n      const preferencesWithUser = preferences?.map((pref) => ({\r\n        ...pref,\r\n        user_id: currentUser?.data?.user?.id,\r\n      }))\r\n\r\n      const { data, error } = await supabase\r\n        ?.from('notification_preferences')\r\n        ?.insert(preferencesWithUser)\r\n        ?.select()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      console.error('Error updating notification preferences:', error)\r\n      return { data: null, error: { message: 'Failed to update notification preferences' } }\r\n    }\r\n  },\r\n\r\n  // Real-time subscriptions\r\n  subscribeToOverdueJobs(callback) {\r\n    try {\r\n      const subscription = supabase\r\n        ?.channel('overdue-jobs')\r\n        ?.on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' }, (payload) => {\r\n          // Refetch overdue jobs when any job changes\r\n          this.getOverdueJobs()?.then((result) => {\r\n            if (result?.data) {\r\n              callback(result?.data)\r\n            }\r\n          })\r\n        })\r\n        ?.subscribe()\r\n\r\n      return subscription\r\n    } catch (error) {\r\n      console.error('Error subscribing to overdue jobs:', error)\r\n      return null\r\n    }\r\n  },\r\n\r\n  // Enhanced search with filters\r\n  async searchWithFilters(searchQuery, filters, tableType) {\r\n    try {\r\n      let query = supabase?.from(tableType)\r\n\r\n      // Apply search\r\n      if (searchQuery) {\r\n        switch (tableType) {\r\n          case 'jobs':\r\n            query = query?.or(`job_number.ilike.%${searchQuery}%,title.ilike.%${searchQuery}%`)\r\n            break\r\n          case 'vehicles':\r\n            query = query?.or(\r\n              `vin.ilike.%${searchQuery}%,make.ilike.%${searchQuery}%,model.ilike.%${searchQuery}%`\r\n            )\r\n            break\r\n          case 'vendors':\r\n            query = query?.or(`name.ilike.%${searchQuery}%,specialty.ilike.%${searchQuery}%`)\r\n            break\r\n        }\r\n      }\r\n\r\n      // Apply filters\r\n      Object?.entries(filters)?.forEach(([key, value]) => {\r\n        if (value != null && value !== '') {\r\n          if (Array?.isArray(value)) {\r\n            query = query?.in(key, value)\r\n          } else if (typeof value === 'object' && value?.min !== undefined) {\r\n            query = query?.gte(key, value?.min)\r\n          } else if (typeof value === 'object' && value?.max !== undefined) {\r\n            query = query?.lte(key, value?.max)\r\n          } else {\r\n            query = query?.eq(key, value)\r\n          }\r\n        }\r\n      })\r\n\r\n      const { data, error } = await query?.select('*')?.order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        return { data: [], error: { message: error?.message } }\r\n      }\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      console.error('Error in search with filters:', error)\r\n      return { data: [], error: { message: 'Failed to search with filters' } }\r\n    }\r\n  },\r\n}\r\n\r\n// Hook for overdue jobs\r\nexport const useOverdueJobs = () => {\r\n  const [overdueJobs, setOverdueJobs] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n\r\n  const fetchOverdueJobs = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const result = await advancedFeaturesService?.getOverdueJobs()\r\n      if (result?.error) {\r\n        setError(result?.error?.message)\r\n      } else {\r\n        setOverdueJobs(result?.data)\r\n        setError(null)\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching overdue jobs:', err)\r\n      setError('Failed to fetch overdue jobs')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchOverdueJobs()\r\n\r\n    // Set up real-time subscription\r\n    const subscription = advancedFeaturesService?.subscribeToOverdueJobs(setOverdueJobs)\r\n\r\n    return () => {\r\n      if (subscription) {\r\n        subscription?.unsubscribe()\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  return { overdueJobs, loading, error, refetch: fetchOverdueJobs }\r\n}\r\n\r\n// Hook for filter presets\r\nexport const useFilterPresets = (pageType) => {\r\n  const [presets, setPresets] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    const loadPresets = async () => {\r\n      setLoading(true)\r\n      const result = await advancedFeaturesService?.getFilterPresets(pageType)\r\n      if (result?.data) {\r\n        setPresets(result?.data)\r\n      }\r\n      setLoading(false)\r\n    }\r\n\r\n    loadPresets()\r\n  }, [pageType])\r\n\r\n  const savePreset = async (name, filters, isPublic = false) => {\r\n    const result = await advancedFeaturesService?.saveFilterPreset(\r\n      pageType,\r\n      name,\r\n      filters,\r\n      isPublic\r\n    )\r\n    if (result?.data) {\r\n      setPresets((prev) => [result?.data, ...prev])\r\n    }\r\n    return result\r\n  }\r\n\r\n  const deletePreset = async (id) => {\r\n    const result = await advancedFeaturesService?.deleteFilterPreset(id)\r\n    if (result?.error === null) {\r\n      setPresets((prev) => prev?.filter((preset) => preset?.id !== id))\r\n    }\r\n    return result\r\n  }\r\n\r\n  return { presets, loading, savePreset, deletePreset }\r\n}\r\n\r\nexport default advancedFeaturesService\r\n","import React, { useState } from 'react';\r\nimport Icon from '../AppIcon';\r\nimport Button from '../ui/Button';\r\nimport Select from '../ui/Select';\r\nimport { advancedFeaturesService } from '../../services/advancedFeaturesService';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\n\r\nconst ExportButton = ({\r\n  exportType, // 'jobs', 'vehicles', 'vendors', 'transactions'\r\n  filters = {},\r\n  selectedIds = [], // For exporting only selected items\r\n  onExportStart,\r\n  onExportComplete,\r\n  onExportError,\r\n  disabled = false,\r\n  variant = 'outline',\r\n  size = 'sm',\r\n  className = ''\r\n}) => {\r\n  const [isExporting, setIsExporting] = useState(false);\r\n  const [showOptions, setShowOptions] = useState(false);\r\n  const [exportFormat, setExportFormat] = useState('csv');\r\n  const [exportScope, setExportScope] = useState('filtered');\r\n  const { user, userProfile } = useAuth();\r\n\r\n  const exportOptions = [\r\n    { value: 'csv', label: 'CSV File' },\r\n    { value: 'excel', label: 'Excel File' }\r\n  ];\r\n\r\n  const scopeOptions = [\r\n    { value: 'all', label: 'All Records' },\r\n    { value: 'filtered', label: 'Filtered Results' },\r\n    ...(selectedIds?.length > 0 ? [{ value: 'selected', label: `Selected (${selectedIds?.length})` }] : [])\r\n  ];\r\n\r\n  const getExportFilename = () => {\r\n    const timestamp = new Date()?.toISOString()?.split('T')?.[0];\r\n    const scope = exportScope === 'selected' ? 'selected' : exportScope;\r\n    return `${exportType}-${scope}-${timestamp}.${exportFormat}`;\r\n  };\r\n\r\n  const exportData = async () => {\r\n    try {\r\n      setIsExporting(true);\r\n      \r\n      // Get data from service instead of undefined generateExportData\r\n      const result = await advancedFeaturesService?.exportData(\r\n        exportType, \r\n        filters, \r\n        userProfile?.role || 'staff'\r\n      );\r\n\r\n      if (result?.error) {\r\n        onExportError?.(result?.error?.message || 'Export failed');\r\n        return;\r\n      }\r\n\r\n      const data = result?.data;\r\n      \r\n      if (!data || data?.length === 0) {\r\n        onExportError?.('No data available for export');\r\n        return;\r\n      }\r\n\r\n      // Enhanced CSV columns with proper guards\r\n      const csvData = data?.map(row => {\r\n        // Helper function to guard against NaN/undefined values\r\n        const safeValue = (value, fallback = '') => {\r\n          if (value === null || value === undefined || value === '' || \r\n              (typeof value === 'number' && (isNaN(value) || !isFinite(value)))) {\r\n            return fallback;\r\n          }\r\n          return value;\r\n        };\r\n\r\n        const safeNumber = (value, fallback = 0) => {\r\n          const num = parseFloat(value);\r\n          return isNaN(num) || !isFinite(num) ? fallback : num;\r\n        };\r\n\r\n        const safeCurrency = (value) => {\r\n          const num = safeNumber(value, 0);\r\n          return new Intl.NumberFormat('en-US', {\r\n            style: 'currency',\r\n            currency: 'USD'\r\n          })?.format(num);\r\n        };\r\n\r\n        return {\r\n          // Core identification\r\n          Stock: safeValue(row?.vehicle?.stock_number),\r\n          Customer: safeValue(row?.customer_name),\r\n          Phone: safeValue(row?.customer_phone),\r\n          \r\n          // Vehicle information\r\n          Vehicle: row?.vehicle ? \r\n            `${safeValue(row?.vehicle?.year)} ${safeValue(row?.vehicle?.make)} ${safeValue(row?.vehicle?.model)}`?.trim() : \r\n            '',\r\n          \r\n          // Staff assignments\r\n          Sales: safeValue(row?.assigned_to_name),\r\n          Status: safeValue(row?.job_status, 'unknown')?.replace('_', ' ')?.toUpperCase(),\r\n          \r\n          // Service details\r\n          ServiceType: row?.service_type === 'vendor' ? 'Off-Site' : 'On-Site',\r\n          \r\n          // Loaner information with proper boolean check\r\n          Loaner: row?.customer_needs_loaner === true ? 'Yes' : 'No',\r\n          \r\n          // Next promised date with safe formatting\r\n          NextPromised: (() => {\r\n            if (!row?.job_parts || row?.job_parts?.length === 0) return '';\r\n            \r\n            const schedulingItems = row?.job_parts?.filter(part => \r\n              part?.requires_scheduling && part?.promised_date\r\n            );\r\n            \r\n            if (schedulingItems?.length === 0) return '';\r\n            \r\n            const earliestPromise = schedulingItems?.sort((a, b) => \r\n              new Date(a.promised_date) - new Date(b.promised_date)\r\n            )?.[0];\r\n            \r\n            if (!earliestPromise?.promised_date) return '';\r\n            \r\n            try {\r\n              return new Date(earliestPromise.promised_date)?.toLocaleDateString('en-US', {\r\n                year: 'numeric',\r\n                month: 'short',\r\n                day: 'numeric'\r\n              });\r\n            } catch {\r\n              return '';\r\n            }\r\n          })(),\r\n          \r\n          // Financial information with currency formatting\r\n          Value: safeCurrency(row?.total_amount),\r\n          \r\n          // Vendor information\r\n          Vendor: safeValue(row?.vendor?.name)\r\n        };\r\n      });\r\n\r\n      // Generate filename with timestamp\r\n      const timestamp = new Date()?.toISOString()?.slice(0, 19)?.replace(/:/g, '-');\r\n      const filename = `${exportType}_export_${timestamp}.csv`;\r\n      \r\n      // Convert to CSV\r\n      const csvContent = convertToCSV(csvData);\r\n      \r\n      // Download CSV\r\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n      const link = document.createElement('a');\r\n      const url = URL.createObjectURL(blob);\r\n      \r\n      link?.setAttribute('href', url);\r\n      link?.setAttribute('download', filename);\r\n      link.style.visibility = 'hidden';\r\n      document.body?.appendChild(link);\r\n      link?.click();\r\n      document.body?.removeChild(link);\r\n      \r\n      onExportComplete?.(data?.length, filename);\r\n      \r\n    } catch (error) {\r\n      console.error('Export error:', error);\r\n      onExportError?.(error?.message || 'Export failed');\r\n    } finally {\r\n      setIsExporting(false);\r\n    }\r\n  };\r\n\r\n  // Helper function to convert data to CSV with proper escaping\r\n  const convertToCSV = (data) => {\r\n    if (!data || data?.length === 0) return '';\r\n    \r\n    const headers = Object.keys(data?.[0]);\r\n    const csvRows = [\r\n      // Header row\r\n      headers?.map(header => `\"${header}\"`)?.join(','),\r\n      // Data rows\r\n      ...data?.map(row =>\r\n        headers?.map(header => {\r\n          const value = row?.[header];\r\n          // Escape quotes and wrap in quotes\r\n          const escapedValue = String(value || '')?.replace(/\"/g, '\"\"');\r\n          return `\"${escapedValue}\"`;\r\n        })?.join(',')\r\n      )\r\n    ];\r\n    \r\n    return csvRows?.join('\\n');\r\n  };\r\n\r\n  const handleExport = async () => {\r\n    if (isExporting) return;\r\n\r\n    try {\r\n      setIsExporting(true);\r\n      if (onExportStart) onExportStart();\r\n\r\n      // Prepare filters based on scope\r\n      let exportFilters = { ...filters };\r\n      \r\n      if (exportScope === 'selected' && selectedIds?.length > 0) {\r\n        exportFilters.ids = selectedIds;\r\n      }\r\n\r\n      if (exportScope === 'all') {\r\n        exportFilters = {}; // Clear all filters for full export\r\n      }\r\n\r\n      // Get data from service\r\n      const result = await advancedFeaturesService?.exportData(\r\n        exportType, \r\n        exportFilters, \r\n        userProfile?.role || 'staff'\r\n      );\r\n\r\n      if (result?.error) {\r\n        throw new Error(result?.error?.message);\r\n      }\r\n\r\n      if (!result?.data || result?.data?.length === 0) {\r\n        throw new Error('No data found to export');\r\n      }\r\n\r\n      // Export to file\r\n      const filename = getExportFilename();\r\n      const exportResult = await advancedFeaturesService?.exportToCSV(\r\n        result?.data, \r\n        filename\r\n      );\r\n\r\n      if (exportResult?.error) {\r\n        throw new Error(exportResult?.error?.message);\r\n      }\r\n\r\n      setShowOptions(false);\r\n      if (onExportComplete) {\r\n        onExportComplete(result?.data?.length, filename);\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Export error:', error);\r\n      if (onExportError) {\r\n        onExportError(error?.message || 'Export failed');\r\n      }\r\n    } finally {\r\n      setIsExporting(false);\r\n    }\r\n  };\r\n\r\n  const getExportTypeLabel = () => {\r\n    switch (exportType) {\r\n      case 'jobs': return 'Jobs';\r\n      case 'vehicles': return 'Vehicles';\r\n      case 'vendors': return 'Vendors';\r\n      case 'transactions': return 'Transactions';\r\n      default: return 'Data';\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"relative\">\r\n      <Button\r\n        variant={variant}\r\n        size={size}\r\n        onClick={() => setShowOptions(!showOptions)}\r\n        disabled={disabled || isExporting}\r\n        iconName={isExporting ? undefined : 'Download'}\r\n        iconPosition=\"left\"\r\n        className={`${className} ${isExporting ? 'cursor-wait' : ''}`}\r\n        aria-label={`Export ${getExportTypeLabel()}`}\r\n      >\r\n        {isExporting ? (\r\n          <div className=\"flex items-center space-x-2\">\r\n            <div className=\"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin\" />\r\n            <span>Exporting...</span>\r\n          </div>\r\n        ) : (\r\n          `Export ${getExportTypeLabel()}`\r\n        )}\r\n      </Button>\r\n\r\n      {/* Export Options Dropdown */}\r\n      {showOptions && !isExporting && (\r\n        <div className=\"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50\">\r\n          <div className=\"p-4 space-y-4\">\r\n            <div>\r\n              <label className=\"text-sm font-medium text-foreground mb-2 block\">\r\n                Export Format\r\n              </label>\r\n              <Select\r\n                value={exportFormat}\r\n                onChange={setExportFormat}\r\n                options={exportOptions}\r\n                className=\"w-full\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"text-sm font-medium text-foreground mb-2 block\">\r\n                Export Scope\r\n              </label>\r\n              <Select\r\n                value={exportScope}\r\n                onChange={setExportScope}\r\n                options={scopeOptions}\r\n                className=\"w-full\"\r\n              />\r\n            </div>\r\n\r\n            {exportScope === 'filtered' && Object?.keys(filters)?.length === 0 && (\r\n              <div className=\"text-xs text-orange-600 bg-orange-50 p-2 rounded\">\r\n                <Icon name=\"AlertTriangle\" size={12} className=\"inline mr-1\" />\r\n                No filters applied. This will export all records.\r\n              </div>\r\n            )}\r\n\r\n            {exportScope === 'selected' && (\r\n              <div className=\"text-xs text-blue-600 bg-blue-50 p-2 rounded\">\r\n                <Icon name=\"Info\" size={12} className=\"inline mr-1\" />\r\n                Exporting {selectedIds?.length} selected record{selectedIds?.length !== 1 ? 's' : ''}.\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"flex justify-end space-x-2 pt-2 border-t border-border\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setShowOptions(false)}\r\n                className=\"min-w-0\"\r\n                aria-label=\"Cancel export\"\r\n              >\r\n                Cancel\r\n              </Button>\r\n              \r\n              <Button\r\n                size=\"sm\"\r\n                onClick={handleExport}\r\n                iconName=\"Download\"\r\n                iconPosition=\"left\"\r\n                className=\"min-w-0\"\r\n                aria-label={`Export ${getExportTypeLabel()}`}\r\n              >\r\n                Export\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ExportButton;","import { supabase } from '@/lib/supabase'\r\nimport { safeSelect } from '../lib/supabase/safeSelect'\r\n\r\nexport const vehicleService = {\r\n  // Get all vehicles with optional filtering\r\n  async getVehicles(filters = {}, orgId = null) {\r\n    try {\r\n      let query = supabase\r\n        ?.from('vehicles')\r\n        ?.select(\r\n          `\r\n          *,\r\n          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)\r\n        `\r\n        )\r\n        ?.order('created_at', { ascending: false })\r\n      if (orgId) query = query?.eq('org_id', orgId)\r\n\r\n      // Apply filters\r\n      if (filters?.status) {\r\n        query = query?.eq('vehicle_status', filters?.status)\r\n      }\r\n\r\n      if (filters?.make) {\r\n        query = query?.eq('make', filters?.make)\r\n      }\r\n\r\n      if (filters?.year) {\r\n        query = query?.eq('year', filters?.year)\r\n      }\r\n\r\n      if (filters?.search) {\r\n        query = query?.or(\r\n          `vin.ilike.%${filters?.search}%,make.ilike.%${filters?.search}%,model.ilike.%${filters?.search}%,license_plate.ilike.%${filters?.search}%,owner_name.ilike.%${filters?.search}%,owner_phone.ilike.%${filters?.search}%,owner_email.ilike.%${filters?.search}%,stock_number.ilike.%${filters?.search}%`\r\n        )\r\n      }\r\n\r\n      const data = await safeSelect(query, 'vehicles:getVehicles')\r\n\r\n      return { data: data || [], error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          data: null,\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { data: null, error: { message: 'Failed to load vehicles' } }\r\n    }\r\n  },\r\n\r\n  // Get single vehicle by ID\r\n  async getVehicleById(id, orgId = null) {\r\n    try {\r\n      let q = supabase\r\n        ?.from('vehicles')\r\n        ?.select(\r\n          `\r\n          *,\r\n          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),\r\n          jobs(\r\n            id,\r\n            job_number,\r\n            title,\r\n            job_status,\r\n            priority,\r\n            estimated_cost,\r\n            actual_cost,\r\n            created_at,\r\n            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)\r\n          )\r\n        `\r\n        )\r\n        ?.eq('id', id)\r\n        ?.single()\r\n      if (orgId) q = q?.eq('org_id', orgId)\r\n      const data = await safeSelect(q, 'vehicles:getVehicleById')\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          data: null,\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { data: null, error: { message: 'Failed to load vehicle details' } }\r\n    }\r\n  },\r\n\r\n  // Create new vehicle\r\n  async createVehicle(vehicleData) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('vehicles')\r\n        ?.insert([\r\n          {\r\n            ...vehicleData,\r\n            created_by: (await supabase?.auth?.getUser())?.data?.user?.id,\r\n          },\r\n        ])\r\n        ?.select(\r\n          `\r\n          *,\r\n          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)\r\n        `\r\n        )\r\n        ?.single()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          data: null,\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { data: null, error: { message: 'Failed to create vehicle' } }\r\n    }\r\n  },\r\n\r\n  async create(vehicleData) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('vehicles')\r\n        ?.insert([vehicleData])\r\n        ?.select()\r\n        ?.single()\r\n\r\n      if (error) {\r\n        console.error('Vehicle creation error:', error)\r\n        throw new Error(error.message || 'Failed to create vehicle')\r\n      }\r\n\r\n      console.log('Vehicle created successfully:', data)\r\n      return data\r\n    } catch (error) {\r\n      console.error('Error in vehicleService.create:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  async createVehicleWithProducts(vehicleData) {\r\n    try {\r\n      console.log('Creating vehicle with products:', vehicleData)\r\n\r\n      // In a real implementation, this would:\r\n      // 1. Create the vehicle record in the vehicles table\r\n      // 2. Create vehicle_products records for each selected product\r\n      // 3. Optionally create initial job records if vendor is assigned\r\n      // 4. Return the created vehicle with all relationships\r\n\r\n      // Mock implementation for now\r\n      const mockVehicleId = `vehicle_${Date.now()}`\r\n\r\n      // Simulate API call delay\r\n      await new Promise((resolve) => setTimeout(resolve, 1000))\r\n\r\n      // Mock successful response\r\n      const createdVehicle = {\r\n        id: mockVehicleId,\r\n        ...vehicleData,\r\n        created_at: new Date()?.toISOString(),\r\n        initial_products_count: vehicleData?.initial_products?.length || 0,\r\n        estimated_aftermarket_value: vehicleData?.total_initial_product_value || 0,\r\n      }\r\n\r\n      console.log('Vehicle created successfully:', createdVehicle)\r\n      return createdVehicle\r\n    } catch (error) {\r\n      console.error('Error creating vehicle with products:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  async checkStockNumberExists(stockNumber) {\r\n    if (!stockNumber?.trim()) return false\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('vehicles')\r\n        ?.select('id')\r\n        ?.eq('stock_number', stockNumber?.trim())\r\n        ?.maybeSingle()\r\n\r\n      if (error) {\r\n        console.error('Stock number check error:', error)\r\n        return false\r\n      }\r\n\r\n      return !!data\r\n    } catch (error) {\r\n      console.error('Error checking stock number:', error)\r\n      return false\r\n    }\r\n  },\r\n\r\n  async checkVinExists(vin) {\r\n    if (!vin?.trim()) return false\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('vehicles')\r\n        ?.select('id')\r\n        ?.eq('vin', vin?.trim())\r\n        ?.maybeSingle()\r\n\r\n      if (error) {\r\n        console.error('VIN check error:', error)\r\n        return false\r\n      }\r\n\r\n      return !!data\r\n    } catch (error) {\r\n      console.error('Error checking VIN:', error)\r\n      return false\r\n    }\r\n  },\r\n\r\n  // Update vehicle\r\n  async updateVehicle(id, updates) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        ?.from('vehicles')\r\n        ?.update({\r\n          ...updates,\r\n          updated_at: new Date()?.toISOString(),\r\n        })\r\n        ?.eq('id', id)\r\n        ?.select(\r\n          `\r\n          *,\r\n          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)\r\n        `\r\n        )\r\n        ?.single()\r\n\r\n      if (error) {\r\n        return { data: null, error: { message: error?.message } }\r\n      }\r\n\r\n      return { data, error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          data: null,\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { data: null, error: { message: 'Failed to update vehicle' } }\r\n    }\r\n  },\r\n\r\n  // Delete vehicle\r\n  async deleteVehicle(id) {\r\n    try {\r\n      const { error } = await supabase?.from('vehicles')?.delete()?.eq('id', id)\r\n\r\n      if (error) {\r\n        return { error: { message: error?.message } }\r\n      }\r\n\r\n      return { error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { error: { message: 'Failed to delete vehicle' } }\r\n    }\r\n  },\r\n\r\n  // Get vehicle statistics\r\n  async getVehicleStats(orgId = null) {\r\n    try {\r\n      let q = supabase?.from('vehicles')?.select('vehicle_status')\r\n      if (orgId) q = q?.eq('org_id', orgId)\r\n      const data = await safeSelect(q, 'vehicles:getVehicleStats')\r\n\r\n      const stats = {\r\n        total: data?.length || 0,\r\n        active: data?.filter((v) => v?.vehicle_status === 'active')?.length || 0,\r\n        maintenance: data?.filter((v) => v?.vehicle_status === 'maintenance')?.length || 0,\r\n        retired: data?.filter((v) => v?.vehicle_status === 'retired')?.length || 0,\r\n        sold: data?.filter((v) => v?.vehicle_status === 'sold')?.length || 0,\r\n      }\r\n\r\n      return { data: stats, error: null }\r\n    } catch (error) {\r\n      if (error?.message?.includes('Failed to fetch')) {\r\n        return {\r\n          data: null,\r\n          error: {\r\n            message:\r\n              'Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status.',\r\n          },\r\n        }\r\n      }\r\n      return { data: null, error: { message: 'Failed to load vehicle statistics' } }\r\n    }\r\n  },\r\n\r\n  // Get all vehicles (alias for getVehicles for consistent API usage)\r\n  async getAllVehicles(filters = {}) {\r\n    return await this.getVehicles(filters)\r\n  },\r\n}\r\n\r\n// Add vendor-aware vehicle fetching\r\nexport const getVehicles = async (options = {}, orgId = null) => {\r\n  try {\r\n    let query = supabase?.from('vehicles')?.select(`\r\n      *,\r\n      jobs:jobs!vehicles_vehicle_id_fkey(\r\n        id,\r\n        job_number,\r\n        title,\r\n        job_status,\r\n        vendor_id,\r\n        assigned_to\r\n      )\r\n    `)\r\n    if (orgId) query = query?.eq('org_id', orgId)\r\n\r\n    // Apply filters if provided\r\n    if (options?.status) {\r\n      query = query?.eq('vehicle_status', options?.status)\r\n    }\r\n\r\n    if (options?.search) {\r\n      query = query?.or(`\r\n        make.ilike.%${options?.search}%,\r\n        model.ilike.%${options?.search}%,\r\n        vin.ilike.%${options?.search}%,\r\n        license_plate.ilike.%${options?.search}%\r\n      `)\r\n    }\r\n\r\n    const data = await safeSelect(\r\n      query?.order('created_at', { ascending: false }),\r\n      'vehicles:getVehiclesFlat'\r\n    )\r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Error fetching vehicles:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n// Vendor-specific vehicle access function\r\nexport const getVendorAccessibleVehicles = async (vendorId) => {\r\n  try {\r\n    const { data, error } = await supabase?.rpc('get_vendor_vehicles', {\r\n      vendor_uuid: vendorId,\r\n    })\r\n\r\n    if (error) {\r\n      throw error\r\n    }\r\n\r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Error fetching vendor vehicles:', error)\r\n    throw error\r\n  }\r\n}\r\nfunction createVehicleWithProducts(...args) {\r\n  // eslint-disable-next-line no-console\r\n  console.warn('Placeholder: createVehicleWithProducts is not implemented yet.', args)\r\n  return null\r\n}\r\n\r\nexport { createVehicleWithProducts }\r\n","import React, { useState, useEffect } from 'react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuth } from '../../contexts/AuthContext'\r\nimport useTenant from '../../hooks/useTenant'\r\nimport dealService from '../../services/dealService'\r\nimport { vehicleService } from '../../services/vehicleService'\r\nimport Button from '../../components/ui/Button'\r\nimport Icon from '../../components/ui/Icon'\r\n// Prefer shared dropdown service helpers with fuzzy fallback and optional org scoping\r\nimport {\r\n  getSalesConsultants,\r\n  getDeliveryCoordinators,\r\n  getFinanceManagers,\r\n  getVendors,\r\n  getProducts,\r\n} from '../../services/dropdownService'\r\n\r\nexport default function NewDealModal({ isOpen, onClose, onSuccess }) {\r\n  const { user } = useAuth()\r\n  const { orgId } = useTenant() || {}\r\n  const [currentStep, setCurrentStep] = useState(1) // 1 = Customer, 2 = Line Items\r\n  const [isSubmitting, setIsSubmitting] = useState(false)\r\n  const [error, setError] = useState('')\r\n  const [isDirty, setIsDirty] = useState(false)\r\n  const [showUnsavedWarning, setShowUnsavedWarning] = useState(false)\r\n\r\n  // ✅ FIXED: Enhanced dropdown state with comprehensive error handling and retry logic\r\n  const [dropdownData, setDropdownData] = useState({\r\n    salesConsultants: [],\r\n    deliveryCoordinators: [],\r\n    financeManagers: [],\r\n    vendors: [],\r\n    products: [],\r\n    loading: true,\r\n    error: null,\r\n    retryCount: 0,\r\n  })\r\n\r\n  // Initial form state for dirty checking\r\n  const initialFormState = {\r\n    customerName: '',\r\n    customerPhone: '',\r\n    customerEmail: '',\r\n    needsLoaner: false,\r\n    assignedTo: null,\r\n    deliveryCoordinator: null,\r\n    financeManager: null,\r\n    vehicleYear: new Date()?.getFullYear(),\r\n    vehicleMake: 'Toyota',\r\n    vehicleModel: 'Camry',\r\n    stockNumber: '',\r\n  }\r\n\r\n  // Customer form data\r\n  const [customerData, setCustomerData] = useState(initialFormState)\r\n\r\n  // Line items data\r\n  const [lineItems, setLineItems] = useState([])\r\n\r\n  // ✅ FIXED: Enhanced dropdown data loading with comprehensive error handling and retry logic\r\n  const loadDropdownData = async (retryCount = 0) => {\r\n    try {\r\n      setDropdownData((prev) => ({ ...prev, loading: true, error: null, retryCount }))\r\n\r\n      // Use shared services with org-aware scoping and fuzzy fallbacks\r\n      const [sales, dc, finance, vendorsOpts, productsOpts] = await Promise.all([\r\n        getSalesConsultants().catch(() => []),\r\n        getDeliveryCoordinators().catch(() => []),\r\n        getFinanceManagers().catch(() => []),\r\n        getVendors({ activeOnly: true }).catch(() => []),\r\n        getProducts({ activeOnly: true }).catch(() => []),\r\n      ])\r\n\r\n      setDropdownData({\r\n        salesConsultants: sales,\r\n        deliveryCoordinators: dc,\r\n        financeManagers: finance,\r\n        vendors: vendorsOpts,\r\n        products: productsOpts?.map((p) => ({ ...p, unitPrice: p?.unit_price })),\r\n        loading: false,\r\n        error: null,\r\n        retryCount,\r\n      })\r\n    } catch (err) {\r\n      console.error('Failed to load dropdown data:', err)\r\n\r\n      // Retry logic for network failures\r\n      if (\r\n        retryCount < 2 &&\r\n        (err?.message?.includes('fetch') || err?.message?.includes('network'))\r\n      ) {\r\n        setTimeout(() => loadDropdownData(retryCount + 1), 1000 * (retryCount + 1))\r\n        return\r\n      }\r\n\r\n      setDropdownData((prev) => ({\r\n        ...prev,\r\n        loading: false,\r\n        error: 'Failed to load dropdown data. Please check your connection and try again.',\r\n        retryCount,\r\n      }))\r\n    }\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced loaner checkbox with proper mobile accessibility and boolean handling\r\n  const LoanerCheckbox = ({ checked, onChange }) => (\r\n    <div className=\"bg-slate-50 p-4 rounded-lg border border-slate-200\">\r\n      <label\r\n        htmlFor=\"needs-loaner-modal\"\r\n        className=\"flex items-center gap-3 cursor-pointer select-none\"\r\n      >\r\n        <input\r\n          id=\"needs-loaner-modal\"\r\n          type=\"checkbox\"\r\n          checked={Boolean(checked)}\r\n          onChange={(e) => {\r\n            const isChecked = Boolean(e?.target?.checked)\r\n            onChange(isChecked)\r\n          }}\r\n          className=\"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer\"\r\n          data-testid=\"loaner-checkbox\"\r\n        />\r\n        <span className=\"text-sm font-medium text-gray-700\">Customer needs loaner vehicle</span>\r\n      </label>\r\n      <p className=\"text-xs text-gray-500 mt-2 ml-8\">\r\n        Check this if the customer requires a loaner vehicle during service\r\n      </p>\r\n    </div>\r\n  )\r\n\r\n  // ✅ FIXED: Enhanced native select component with better error handling\r\n  const MobileSelect = ({\r\n    label,\r\n    options,\r\n    value,\r\n    onChange,\r\n    placeholder,\r\n    required = false,\r\n    helpText,\r\n    testId,\r\n  }) => (\r\n    <div>\r\n      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n        {label} {required && <span className=\"text-red-500\">*</span>}\r\n      </label>\r\n      <select\r\n        value={value || ''}\r\n        onChange={(e) => onChange(e?.target?.value || null)}\r\n        className=\"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer\"\r\n        disabled={dropdownData?.loading}\r\n        required={required}\r\n        data-testid={testId}\r\n      >\r\n        <option value=\"\">{placeholder}</option>\r\n        {options?.map((option) => (\r\n          <option key={option?.id} value={option?.id}>\r\n            {option?.full_name || option?.label || option?.name}\r\n          </option>\r\n        ))}\r\n      </select>\r\n      {helpText && <p className=\"mt-1 text-xs text-gray-500\">{helpText}</p>}\r\n      {options?.length === 0 && !dropdownData?.loading && (\r\n        <p className=\"mt-1 text-xs text-red-500\">\r\n          No {label?.toLowerCase()} found. Please check your database connection.\r\n        </p>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  // Dirty state tracking\r\n  useEffect(() => {\r\n    const hasChanges =\r\n      customerData?.customerName !== initialFormState?.customerName ||\r\n      customerData?.customerPhone !== initialFormState?.customerPhone ||\r\n      customerData?.customerEmail !== initialFormState?.customerEmail ||\r\n      customerData?.needsLoaner !== initialFormState?.needsLoaner ||\r\n      customerData?.assignedTo !== initialFormState?.assignedTo ||\r\n      customerData?.deliveryCoordinator !== initialFormState?.deliveryCoordinator ||\r\n      customerData?.financeManager !== initialFormState?.financeManager ||\r\n      lineItems?.length > 0\r\n\r\n    setIsDirty(hasChanges)\r\n  }, [customerData, lineItems])\r\n\r\n  // Load dropdown data when modal opens\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      loadDropdownData()\r\n    }\r\n  }, [isOpen])\r\n\r\n  // Add new line item\r\n  const addLineItem = () => {\r\n    setLineItems((prev) => [\r\n      ...prev,\r\n      {\r\n        id: Date.now(),\r\n        productId: '',\r\n        unitPrice: '',\r\n        serviceType: 'in_house',\r\n        vendorId: '',\r\n        requiresScheduling: true,\r\n        promisedDate: '',\r\n        noScheduleReason: '',\r\n        serviceNotes: '',\r\n      },\r\n    ])\r\n  }\r\n\r\n  // Update line item\r\n  const updateLineItem = (id, field, value) => {\r\n    setLineItems((prev) =>\r\n      prev?.map((item) => {\r\n        if (item?.id === id) {\r\n          let updatedItem = { ...item, [field]: value }\r\n\r\n          if (field === 'requiresScheduling') {\r\n            if (value === true) {\r\n              updatedItem.noScheduleReason = ''\r\n            } else {\r\n              updatedItem.promisedDate = ''\r\n            }\r\n          }\r\n\r\n          return updatedItem\r\n        }\r\n        return item\r\n      })\r\n    )\r\n\r\n    // Auto-populate price when product is selected\r\n    if (field === 'productId' && value) {\r\n      const selectedProduct = dropdownData?.products?.find((p) => p?.id === value)\r\n      if (selectedProduct) {\r\n        setLineItems((prev) =>\r\n          prev?.map((item) =>\r\n            item?.id === id ? { ...item, unitPrice: selectedProduct?.unitPrice || '' } : item\r\n          )\r\n        )\r\n      }\r\n    }\r\n  }\r\n\r\n  // Remove line item\r\n  const removeLineItem = (id) => {\r\n    setLineItems((prev) => prev?.filter((item) => item?.id !== id))\r\n  }\r\n\r\n  // Validation\r\n  const validateStep1 = () => {\r\n    return customerData?.customerName?.trim()?.length > 0\r\n  }\r\n\r\n  const validateStep2 = () => {\r\n    if (lineItems?.length === 0) return false\r\n\r\n    return lineItems?.every((item) => {\r\n      if (!item?.productId || !item?.unitPrice) return false\r\n      if (item?.requiresScheduling && !item?.promisedDate) return false\r\n      if (!item?.requiresScheduling && !item?.noScheduleReason?.trim()) return false\r\n      if (item?.serviceType === 'vendor' && !item?.vendorId) return false\r\n      return true\r\n    })\r\n  }\r\n\r\n  // Calculate total\r\n  const calculateTotal = () => {\r\n    return lineItems?.reduce((sum, item) => {\r\n      return sum + (parseFloat(item?.unitPrice) || 0)\r\n    }, 0)\r\n  }\r\n\r\n  // Handle save as draft\r\n  const handleSaveDraft = async () => {\r\n    if (!validateStep1()) {\r\n      setError('Customer name is required to save draft')\r\n      return\r\n    }\r\n\r\n    setIsSubmitting(true)\r\n    setError('')\r\n\r\n    try {\r\n      // Create vehicle via service (service-layer boundary)\r\n      const vehiclePayload = {\r\n        year: customerData?.vehicleYear || new Date()?.getFullYear(),\r\n        make: customerData?.vehicleMake || 'TBD',\r\n        model: customerData?.vehicleModel || 'TBD',\r\n        owner_name: customerData?.customerName?.trim(),\r\n        owner_phone: customerData?.customerPhone?.trim() || null,\r\n        owner_email: customerData?.customerEmail?.trim() || null,\r\n        stock_number: customerData?.stockNumber?.trim() || `DRAFT-${Date.now()}`,\r\n        vehicle_status: 'active',\r\n        ...(orgId ? { org_id: orgId } : {}),\r\n      }\r\n      const vehicle = await vehicleService.create(vehiclePayload)\r\n\r\n      // Create draft job via dealService\r\n      const payload = {\r\n        title: `Draft Deal - ${customerData?.customerName?.trim()}`,\r\n        description: `Draft deal for ${customerData?.customerName?.trim()}`,\r\n        job_status: 'draft',\r\n        service_type: 'in_house',\r\n        vehicle_id: vehicle?.id,\r\n        assigned_to: customerData?.assignedTo || user?.id,\r\n        delivery_coordinator_id: customerData?.deliveryCoordinator || null,\r\n        finance_manager_id: customerData?.financeManager || null,\r\n        customer_needs_loaner: Boolean(customerData?.needsLoaner),\r\n        customerName: customerData?.customerName?.trim(),\r\n        customerPhone: customerData?.customerPhone?.trim() || '',\r\n        customerEmail: customerData?.customerEmail?.trim() || '',\r\n        org_id: orgId || undefined,\r\n        lineItems: [],\r\n      }\r\n      await dealService.createDeal(payload)\r\n\r\n      onSuccess?.()\r\n      resetForm()\r\n      onClose()\r\n    } catch (err) {\r\n      setError(`Failed to save draft: ${err?.message}`)\r\n    } finally {\r\n      setIsSubmitting(false)\r\n    }\r\n  }\r\n\r\n  // Handle create full deal\r\n  const handleCreateDeal = async () => {\r\n    if (!validateStep1() || !validateStep2()) {\r\n      setError('Please complete all required fields')\r\n      return\r\n    }\r\n\r\n    setIsSubmitting(true)\r\n    setError('')\r\n\r\n    try {\r\n      // Create vehicle via service\r\n      const vehiclePayload = {\r\n        year: customerData?.vehicleYear || new Date()?.getFullYear(),\r\n        make: customerData?.vehicleMake || 'TBD',\r\n        model: customerData?.vehicleModel || 'TBD',\r\n        owner_name: customerData?.customerName?.trim(),\r\n        owner_phone: customerData?.customerPhone?.trim() || null,\r\n        owner_email: customerData?.customerEmail?.trim() || null,\r\n        stock_number: customerData?.stockNumber?.trim() || `DEAL-${Date.now()}`,\r\n        vehicle_status: 'active',\r\n        ...(orgId ? { org_id: orgId } : {}),\r\n      }\r\n      const vehicle = await vehicleService.create(vehiclePayload)\r\n\r\n      const total = calculateTotal()\r\n      const hasVendorItems = lineItems?.some((item) => item?.serviceType === 'vendor')\r\n      const serviceType = hasVendorItems ? 'vendor' : 'in_house'\r\n      const primaryVendor = lineItems?.find((item) => item?.vendorId)?.vendorId || null\r\n\r\n      // If vendor job, ensure scheduled_start_time is set (DB constraint)\r\n      let scheduledStart = null\r\n      if (serviceType === 'vendor') {\r\n        const vendorDates = (lineItems || [])\r\n          .filter(\r\n            (it) => it?.serviceType === 'vendor' && it?.requiresScheduling && it?.promisedDate\r\n          )\r\n          .map((it) => new Date(it?.promisedDate))\r\n          .sort((a, b) => a - b)\r\n        scheduledStart = (vendorDates?.[0] || new Date())?.toISOString()\r\n      }\r\n\r\n      // Build line items for dealService\r\n      const li = (lineItems || []).map((item) => ({\r\n        product_id: item?.productId,\r\n        quantity_used: 1,\r\n        unit_price: parseFloat(item?.unitPrice || 0),\r\n        promised_date: item?.requiresScheduling ? item?.promisedDate : null,\r\n        requires_scheduling: Boolean(item?.requiresScheduling),\r\n        no_schedule_reason: !item?.requiresScheduling ? item?.noScheduleReason : null,\r\n        is_off_site: item?.serviceType === 'vendor',\r\n      }))\r\n\r\n      const payload = {\r\n        title: `Deal - ${customerData?.customerName?.trim()}`,\r\n        description: `Deal for ${customerData?.customerName?.trim()}`,\r\n        job_status: 'pending',\r\n        service_type: serviceType,\r\n        vehicle_id: vehicle?.id,\r\n        vendor_id: primaryVendor,\r\n        assigned_to: customerData?.assignedTo || user?.id,\r\n        delivery_coordinator_id: customerData?.deliveryCoordinator || null,\r\n        finance_manager_id: customerData?.financeManager || null,\r\n        customer_needs_loaner: Boolean(customerData?.needsLoaner),\r\n        scheduled_start_time: scheduledStart,\r\n        estimated_cost: total,\r\n        org_id: orgId || undefined,\r\n        customerName: customerData?.customerName?.trim(),\r\n        customerPhone: customerData?.customerPhone?.trim() || '',\r\n        customerEmail: customerData?.customerEmail?.trim() || '',\r\n        lineItems: li,\r\n      }\r\n\r\n      // Create via service (inserts job + parts)\r\n      const created = await dealService.createDeal(payload)\r\n\r\n      // Upsert transaction and finalize totals via update\r\n      await dealService.updateDeal(created?.id, payload)\r\n\r\n      onSuccess?.()\r\n      resetForm()\r\n      onClose()\r\n    } catch (err) {\r\n      setError(`Failed to create deal: ${err?.message}`)\r\n    } finally {\r\n      setIsSubmitting(false)\r\n    }\r\n  }\r\n\r\n  const resetForm = () => {\r\n    setCurrentStep(1)\r\n    setCustomerData(initialFormState)\r\n    setLineItems([])\r\n    setError('')\r\n    setIsDirty(false)\r\n  }\r\n\r\n  // Enhanced close handler with unsaved changes guard\r\n  const handleClose = () => {\r\n    if (isDirty) {\r\n      setShowUnsavedWarning(true)\r\n    } else {\r\n      resetForm()\r\n      onClose()\r\n    }\r\n  }\r\n\r\n  const confirmClose = () => {\r\n    setShowUnsavedWarning(false)\r\n    resetForm()\r\n    onClose()\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0\">\r\n          <div>\r\n            <h2 className=\"text-xl font-semibold text-gray-900\">Create New Deal</h2>\r\n            <p className=\"text-sm text-gray-600 mt-1\">\r\n              {currentStep === 1 ? 'Customer Information' : 'Line Items & Service Configuration'}\r\n            </p>\r\n          </div>\r\n          <button\r\n            onClick={handleClose}\r\n            className=\"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg\"\r\n          >\r\n            <Icon name=\"X\" size={24} />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Progress indicator */}\r\n        <div className=\"px-6 py-4 bg-slate-50 flex-shrink-0 border-b\">\r\n          <div className=\"flex items-center space-x-4\">\r\n            <div\r\n              className={`flex items-center space-x-2 ${currentStep >= 1 ? 'text-blue-600' : 'text-gray-400'}`}\r\n            >\r\n              <div\r\n                className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\r\n                  currentStep >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'\r\n                }`}\r\n              >\r\n                1\r\n              </div>\r\n              <span className=\"font-medium\">Customer</span>\r\n            </div>\r\n            <div className=\"flex-1 h-px bg-gray-300\"></div>\r\n            <div\r\n              className={`flex items-center space-x-2 ${currentStep >= 2 ? 'text-blue-600' : 'text-gray-400'}`}\r\n            >\r\n              <div\r\n                className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\r\n                  currentStep >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'\r\n                }`}\r\n              >\r\n                2\r\n              </div>\r\n              <span className=\"font-medium\">Line Items</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"p-6 overflow-y-auto flex-1 bg-white\">\r\n          {error && (\r\n            <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <strong>Error:</strong> {error}\r\n                </div>\r\n                <button\r\n                  onClick={() => setError('')}\r\n                  className=\"text-red-600 hover:text-red-800 ml-2\"\r\n                >\r\n                  <Icon name=\"X\" size={16} />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {dropdownData?.loading && (\r\n            <div className=\"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm\">\r\n              <div className=\"flex items-center\">\r\n                <Icon name=\"Loader\" size={16} className=\"mr-2 animate-spin\" />\r\n                Loading dropdown data...\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {dropdownData?.error && (\r\n            <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <strong>Error:</strong> {dropdownData?.error}\r\n                </div>\r\n                <button\r\n                  onClick={() => loadDropdownData()}\r\n                  className=\"text-blue-600 hover:text-blue-800 ml-2 text-xs underline\"\r\n                >\r\n                  Retry\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {currentStep === 1 && (\r\n            <div className=\"space-y-6\">\r\n              {/* Customer Information */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Customer Name <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={customerData?.customerName}\r\n                    onChange={(e) =>\r\n                      setCustomerData((prev) => ({ ...prev, customerName: e?.target?.value }))\r\n                    }\r\n                    className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Enter customer name\"\r\n                    required\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Customer Phone\r\n                  </label>\r\n                  <input\r\n                    type=\"tel\"\r\n                    value={customerData?.customerPhone}\r\n                    onChange={(e) =>\r\n                      setCustomerData((prev) => ({ ...prev, customerPhone: e?.target?.value }))\r\n                    }\r\n                    className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Enter customer phone\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Customer Email\r\n                </label>\r\n                <input\r\n                  type=\"email\"\r\n                  value={customerData?.customerEmail}\r\n                  onChange={(e) =>\r\n                    setCustomerData((prev) => ({ ...prev, customerEmail: e?.target?.value }))\r\n                  }\r\n                  className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                  placeholder=\"Enter customer email\"\r\n                />\r\n              </div>\r\n\r\n              {/* Vehicle Information */}\r\n              <div className=\"bg-slate-50 p-4 rounded-lg border border-slate-200\">\r\n                <h4 className=\"text-lg font-medium text-gray-900 mb-4\">Vehicle Information</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Year</label>\r\n                    <input\r\n                      type=\"number\"\r\n                      value={customerData?.vehicleYear || ''}\r\n                      onChange={(e) =>\r\n                        setCustomerData((prev) => ({ ...prev, vehicleYear: e?.target?.value }))\r\n                      }\r\n                      className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                      placeholder=\"2024\"\r\n                      min=\"1900\"\r\n                      max={new Date()?.getFullYear() + 2}\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Make</label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={customerData?.vehicleMake || ''}\r\n                      onChange={(e) =>\r\n                        setCustomerData((prev) => ({ ...prev, vehicleMake: e?.target?.value }))\r\n                      }\r\n                      className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                      placeholder=\"Toyota\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Model</label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={customerData?.vehicleModel || ''}\r\n                      onChange={(e) =>\r\n                        setCustomerData((prev) => ({ ...prev, vehicleModel: e?.target?.value }))\r\n                      }\r\n                      className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                      placeholder=\"Camry\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n                <div className=\"mt-4\">\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Stock Number\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={customerData?.stockNumber || ''}\r\n                    onChange={(e) =>\r\n                      setCustomerData((prev) => ({ ...prev, stockNumber: e?.target?.value }))\r\n                    }\r\n                    className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Enter stock number (optional)\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {/* ✅ FIXED: Enhanced loaner checkbox with proper mobile functionality */}\r\n              <LoanerCheckbox\r\n                checked={customerData?.needsLoaner}\r\n                onChange={(checked) => {\r\n                  setCustomerData((prev) => ({ ...prev, needsLoaner: Boolean(checked) }))\r\n                }}\r\n              />\r\n\r\n              {/* ✅ FIXED: Dealer Representatives with working dropdowns */}\r\n              <div className=\"bg-slate-50 p-4 rounded-lg border border-slate-200\">\r\n                <h4 className=\"text-lg font-medium text-gray-900 mb-4\">Dealer Representatives</h4>\r\n\r\n                <div className=\"grid grid-cols-1 gap-4\">\r\n                  <MobileSelect\r\n                    label=\"Sales Consultant\"\r\n                    options={dropdownData?.salesConsultants}\r\n                    value={customerData?.assignedTo}\r\n                    onChange={(value) =>\r\n                      setCustomerData((prev) => ({ ...prev, assignedTo: value }))\r\n                    }\r\n                    placeholder=\"Select sales consultant (optional)\"\r\n                    helpText=\"Choose the sales consultant responsible for this deal\"\r\n                    testId=\"sales-select\"\r\n                  />\r\n\r\n                  <MobileSelect\r\n                    label=\"Delivery Coordinator\"\r\n                    options={dropdownData?.deliveryCoordinators}\r\n                    value={customerData?.deliveryCoordinator}\r\n                    onChange={(value) =>\r\n                      setCustomerData((prev) => ({ ...prev, deliveryCoordinator: value }))\r\n                    }\r\n                    placeholder=\"Select delivery coordinator (optional)\"\r\n                    helpText=\"Choose the delivery coordinator for this deal\"\r\n                    testId=\"delivery-select\"\r\n                  />\r\n\r\n                  <MobileSelect\r\n                    label=\"Finance Manager\"\r\n                    options={dropdownData?.financeManagers}\r\n                    value={customerData?.financeManager}\r\n                    onChange={(value) =>\r\n                      setCustomerData((prev) => ({ ...prev, financeManager: value }))\r\n                    }\r\n                    placeholder=\"Select finance manager (optional)\"\r\n                    helpText=\"Choose the finance manager for this deal\"\r\n                    testId=\"finance-select\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {currentStep === 2 && (\r\n            <div className=\"space-y-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">Line Items</h3>\r\n                <Button\r\n                  onClick={addLineItem}\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11\"\r\n                >\r\n                  <Icon name=\"Plus\" size={16} />\r\n                  <span>Add Item</span>\r\n                </Button>\r\n              </div>\r\n\r\n              {lineItems?.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300\">\r\n                  <Icon name=\"Package\" size={48} className=\"mx-auto mb-4 text-gray-300\" />\r\n                  <p>No line items added yet</p>\r\n                  <p className=\"text-sm\">Click \"Add Item\" to get started</p>\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  {lineItems?.map((item, index) => (\r\n                    <div\r\n                      key={item?.id}\r\n                      className=\"border rounded-xl p-4 bg-slate-50 border-slate-200\"\r\n                    >\r\n                      <div className=\"flex items-center justify-between mb-4\">\r\n                        <h4 className=\"font-medium text-gray-900\">Item #{index + 1}</h4>\r\n                        <button\r\n                          onClick={() => removeLineItem(item?.id)}\r\n                          className=\"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg\"\r\n                          aria-label=\"Remove line item\"\r\n                          title=\"Remove line item\"\r\n                        >\r\n                          <Icon name=\"Trash2\" size={16} />\r\n                        </button>\r\n                      </div>\r\n\r\n                      {/* Product and Price */}\r\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n                        <div>\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Product <span className=\"text-red-500\">*</span>\r\n                          </label>\r\n                          <select\r\n                            value={item?.productId || ''}\r\n                            onChange={(e) =>\r\n                              updateLineItem(item?.id, 'productId', e?.target?.value)\r\n                            }\r\n                            className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer\"\r\n                            required\r\n                            data-testid={`product-select-${index}`}\r\n                          >\r\n                            <option value=\"\">Select product</option>\r\n                            {dropdownData?.products?.map((product) => (\r\n                              <option key={product?.id} value={product?.id}>\r\n                                {product?.label}\r\n                              </option>\r\n                            ))}\r\n                          </select>\r\n                        </div>\r\n\r\n                        <div>\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Unit Price <span className=\"text-red-500\">*</span>\r\n                          </label>\r\n                          <input\r\n                            type=\"number\"\r\n                            step=\"0.01\"\r\n                            min=\"0\"\r\n                            value={item?.unitPrice}\r\n                            onChange={(e) =>\r\n                              updateLineItem(item?.id, 'unitPrice', e?.target?.value)\r\n                            }\r\n                            className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            placeholder=\"0.00\"\r\n                            required\r\n                            data-testid={`unit-price-input-${index}`}\r\n                          />\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Service Configuration */}\r\n                      <div className=\"bg-white rounded-lg p-4 border border-slate-200 mb-4\">\r\n                        <h5 className=\"font-medium text-gray-900 mb-3\">Service Configuration</h5>\r\n\r\n                        {/* Service Type */}\r\n                        <div className=\"mb-4\">\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Service Type\r\n                          </label>\r\n                          <div className=\"flex flex-col sm:flex-row gap-2\">\r\n                            <label className=\"flex items-center cursor-pointer\">\r\n                              <input\r\n                                type=\"radio\"\r\n                                name={`serviceType_${item?.id}`}\r\n                                value=\"in_house\"\r\n                                checked={item?.serviceType === 'in_house'}\r\n                                onChange={(e) =>\r\n                                  updateLineItem(item?.id, 'serviceType', e?.target?.value)\r\n                                }\r\n                                className=\"mr-2 cursor-pointer\"\r\n                              />\r\n                              🏠 On-Site (In-House)\r\n                            </label>\r\n                            <label className=\"flex items-center cursor-pointer\">\r\n                              <input\r\n                                type=\"radio\"\r\n                                name={`serviceType_${item?.id}`}\r\n                                value=\"vendor\"\r\n                                checked={item?.serviceType === 'vendor'}\r\n                                onChange={(e) =>\r\n                                  updateLineItem(item?.id, 'serviceType', e?.target?.value)\r\n                                }\r\n                                className=\"mr-2 cursor-pointer\"\r\n                              />\r\n                              🏢 Off-Site (Vendor)\r\n                            </label>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Vendor Selection */}\r\n                        {item?.serviceType === 'vendor' && (\r\n                          <div className=\"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200\">\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                              Vendor <span className=\"text-red-500\">*</span>\r\n                            </label>\r\n                            <select\r\n                              value={item?.vendorId || ''}\r\n                              onChange={(e) =>\r\n                                updateLineItem(item?.id, 'vendorId', e?.target?.value)\r\n                              }\r\n                              className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer\"\r\n                              required\r\n                            >\r\n                              <option value=\"\">Select vendor</option>\r\n                              {dropdownData?.vendors?.map((vendor) => (\r\n                                <option key={vendor?.id} value={vendor?.id}>\r\n                                  {vendor?.label}\r\n                                </option>\r\n                              ))}\r\n                            </select>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Scheduling */}\r\n                        <div className=\"mb-4\">\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Scheduling\r\n                          </label>\r\n                          <div className=\"space-y-3\">\r\n                            <div className=\"flex flex-col sm:flex-row gap-2\">\r\n                              <label\r\n                                className=\"flex items-center cursor-pointer\"\r\n                                htmlFor={`requiresScheduling-${index}`}\r\n                              >\r\n                                <input\r\n                                  type=\"radio\"\r\n                                  name={`scheduling_${item?.id}`}\r\n                                  checked={item?.requiresScheduling === true}\r\n                                  onChange={() =>\r\n                                    updateLineItem(item?.id, 'requiresScheduling', true)\r\n                                  }\r\n                                  className=\"mr-2 cursor-pointer\"\r\n                                  id={`requiresScheduling-${index}`}\r\n                                  data-testid={`requires-scheduling-${index}`}\r\n                                />\r\n                                Needs Scheduling\r\n                              </label>\r\n                              <label\r\n                                className=\"flex items-center cursor-pointer\"\r\n                                htmlFor={`noScheduling-${index}`}\r\n                              >\r\n                                <input\r\n                                  type=\"radio\"\r\n                                  name={`scheduling_${item?.id}`}\r\n                                  checked={item?.requiresScheduling === false}\r\n                                  onChange={() =>\r\n                                    updateLineItem(item?.id, 'requiresScheduling', false)\r\n                                  }\r\n                                  className=\"mr-2 cursor-pointer\"\r\n                                  id={`noScheduling-${index}`}\r\n                                />\r\n                                No Scheduling Needed\r\n                              </label>\r\n                            </div>\r\n\r\n                            {item?.requiresScheduling ? (\r\n                              <div className=\"p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                                  Promised Date <span className=\"text-red-500\">*</span>\r\n                                </label>\r\n                                <input\r\n                                  type=\"date\"\r\n                                  value={item?.promisedDate}\r\n                                  onChange={(e) =>\r\n                                    updateLineItem(item?.id, 'promisedDate', e?.target?.value)\r\n                                  }\r\n                                  min={new Date()?.toISOString()?.split('T')?.[0]}\r\n                                  className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                                  required\r\n                                />\r\n                              </div>\r\n                            ) : (\r\n                              <div className=\"p-3 bg-gray-50 rounded-lg border border-gray-200\">\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                                  Reason for No Schedule <span className=\"text-red-500\">*</span>\r\n                                </label>\r\n                                <input\r\n                                  type=\"text\"\r\n                                  value={item?.noScheduleReason}\r\n                                  onChange={(e) =>\r\n                                    updateLineItem(item?.id, 'noScheduleReason', e?.target?.value)\r\n                                  }\r\n                                  className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                                  placeholder=\"e.g., installed at delivery, no appointment needed\"\r\n                                  required\r\n                                />\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Service Notes */}\r\n                        <div>\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Service Notes\r\n                          </label>\r\n                          <textarea\r\n                            rows={2}\r\n                            value={item?.serviceNotes}\r\n                            onChange={(e) =>\r\n                              updateLineItem(item?.id, 'serviceNotes', e?.target?.value)\r\n                            }\r\n                            className=\"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            placeholder=\"Special instructions, customer preferences, etc.\"\r\n                          />\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n\r\n                  {/* Total */}\r\n                  <div className=\"bg-green-50 border border-green-200 rounded-lg p-4\">\r\n                    <div className=\"flex justify-between items-center\">\r\n                      <span className=\"text-lg font-medium text-gray-900\">Total:</span>\r\n                      <span className=\"text-xl font-bold text-green-700\">\r\n                        ${calculateTotal()?.toFixed(2)}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"text-sm text-gray-600 mt-1\">\r\n                      {lineItems?.length} item{lineItems?.length !== 1 ? 's' : ''} added\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <div className=\"px-6 py-4 border-t bg-slate-50 flex-shrink-0\">\r\n          <div className=\"flex flex-col md:flex-row justify-between items-center gap-3\">\r\n            <div className=\"flex space-x-3 w-full md:w-auto\">\r\n              {currentStep === 2 && (\r\n                <Button\r\n                  onClick={() => setCurrentStep(1)}\r\n                  variant=\"outline\"\r\n                  className=\"w-full md:w-auto h-11\"\r\n                >\r\n                  ← Back\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"flex space-x-3 w-full md:w-auto\">\r\n              <Button onClick={handleClose} variant=\"outline\" className=\"w-full md:w-auto h-11\">\r\n                Cancel\r\n              </Button>\r\n\r\n              {currentStep === 1 && (\r\n                <>\r\n                  <Button\r\n                    onClick={handleSaveDraft}\r\n                    disabled={!validateStep1() || isSubmitting}\r\n                    variant=\"outline\"\r\n                    className=\"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100\"\r\n                  >\r\n                    {isSubmitting ? 'Saving...' : 'Save Draft'}\r\n                  </Button>\r\n                  <Button\r\n                    onClick={() => setCurrentStep(2)}\r\n                    disabled={!validateStep1()}\r\n                    className=\"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700\"\r\n                  >\r\n                    Add Line Items →\r\n                  </Button>\r\n                </>\r\n              )}\r\n\r\n              {currentStep === 2 && (\r\n                <Button\r\n                  onClick={handleCreateDeal}\r\n                  disabled={!validateStep1() || !validateStep2() || isSubmitting}\r\n                  className=\"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700\"\r\n                >\r\n                  {isSubmitting ? 'Creating...' : 'Create Deal'}\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Unsaved Changes Warning Modal */}\r\n        {showUnsavedWarning && (\r\n          <div className=\"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10\">\r\n            <div className=\"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl\">\r\n              <h3 className=\"text-lg font-semibold mb-4 text-gray-900\">Unsaved Changes</h3>\r\n              <p className=\"text-gray-600 mb-6\">\r\n                You have unsaved changes. Are you sure you want to close and discard your changes?\r\n              </p>\r\n              <div className=\"flex space-x-3\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => setShowUnsavedWarning(false)}\r\n                  className=\"flex-1 h-11\"\r\n                >\r\n                  Keep Editing\r\n                </Button>\r\n                <Button\r\n                  onClick={confirmClose}\r\n                  className=\"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white\"\r\n                >\r\n                  Discard Changes\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","import { supabase } from '@/lib/supabase'\r\nimport { safeSelect } from '@/lib/supabase/safeSelect'\r\nimport { toOptions } from '@/lib/options'\r\n\r\n// Tenant-aware list for dropdowns and consumers\r\nexport async function listProductsByOrg(orgId, { activeOnly = true } = {}) {\r\n  let q = supabase.from('products').select('*').order('name', { ascending: true })\r\n  if (activeOnly) q = q.eq('is_active', true)\r\n  if (orgId) q = q.or(`org_id.eq.${orgId},org_id.is.null`)\r\n  const rows = await safeSelect(q, 'products:listByOrg')\r\n  return toOptions(rows, { labelKey: 'name', valueKey: 'id' })\r\n}\r\n\r\nexport const productService = {\r\n  async list({ orgId = null, activeOnly = true } = {}) {\r\n    let q = supabase.from('products').select('*').order('name', { ascending: true })\r\n    if (activeOnly) q = q.eq('is_active', true)\r\n    if (orgId) q = q.or(`org_id.eq.${orgId},org_id.is.null`)\r\n    const rows = await safeSelect(q, 'products:list')\r\n    return toOptions(rows, { labelKey: 'name', valueKey: 'id' })\r\n  },\r\n\r\n  async getById(id, orgId = null) {\r\n    if (!id) return null\r\n    try {\r\n      let q = supabase.from('products').select('*').eq('id', id).single()\r\n      if (orgId) q = q.eq('org_id', orgId)\r\n      const res = await q.throwOnError()\r\n      return res?.data ?? null\r\n    } catch (e) {\r\n      console.error('[products:getById] failed', e)\r\n      return null\r\n    }\r\n  },\r\n}\r\n\r\nexport default productService\r\n","import { supabase } from '@/lib/supabase'\r\nimport { safeSelect } from '@/lib/supabase/safeSelect'\r\n\r\n// Prefer user_profiles as the authoritative staff source\r\nexport function listStaffByOrg(orgId, { activeOnly = true } = {}) {\r\n  let q = supabase.from('user_profiles').select('*').order('full_name', { ascending: true })\r\n  if (activeOnly) q = q.eq('is_active', true)\r\n  if (orgId) q = q.eq('org_id', orgId)\r\n  return safeSelect(q, 'staff:listByOrg')\r\n}\r\n\r\nexport default { listStaffByOrg }\r\n","import { useEffect, useState } from 'react'\r\nimport { useAuth } from '../contexts/AuthContext'\r\nimport useTenant from './useTenant'\r\nimport { listVendorsByOrg } from '../services/vendorService'\r\nimport { listProductsByOrg } from '../services/productService'\r\nimport { listStaffByOrg } from '../services/staffService'\r\nimport { listSmsTemplatesByOrg } from '../services/smsTemplateService'\r\nimport {\r\n  getDeliveryCoordinators,\r\n  getSalesConsultants,\r\n  getFinanceManagers,\r\n  getUserProfiles,\r\n  getVendors,\r\n  getProducts,\r\n  globalSearch,\r\n} from '../services/dropdownService'\r\n\r\nexport function useDropdownData(options = {}) {\r\n  const {\r\n    loadOnMount = true,\r\n    cacheTime = 5 * 60 * 1000, // 5 minutes default\r\n  } = options\r\n\r\n  const [state, setState] = useState({\r\n    dc: [],\r\n    sales: [],\r\n    finance: [],\r\n    users: [],\r\n    vendors: [],\r\n    products: [],\r\n    smsTemplates: [],\r\n    loading: true,\r\n    error: null,\r\n    searchResults: null,\r\n  })\r\n\r\n  const [lastUpdate, setLastUpdate] = useState(null)\r\n\r\n  const tenant = useTenant()\r\n  const auth = useAuth()\r\n\r\n  // Enhanced load data with tenant-aware services and better error handling\r\n  const loadData = async () => {\r\n    try {\r\n      // If tenant is still loading, skip without toggling the loading flag here.\r\n      // The effect below re-invokes loadData when tenant.loading flips to false.\r\n      if (tenant.loading) {\r\n        return\r\n      }\r\n\r\n      setState((prev) => ({ ...prev, loading: true, error: null }))\r\n\r\n      // If no user session, prefer global safe fallbacks\r\n      if (!tenant.session?.user) {\r\n        console.warn('Dropdowns: no authenticated user; some queries may return empty due to RLS')\r\n        setState((prev) => ({ ...prev, loading: false }))\r\n        return\r\n      }\r\n\r\n      // If org is not present, fallback to global dropdownService calls\r\n      const useTenantLists = Boolean(tenant.orgId)\r\n\r\n      const promises = [\r\n        getDeliveryCoordinators()?.catch((err) => {\r\n          console.error('[dropdowns:dc] Delivery coordinators failed:', err)\r\n          return []\r\n        }),\r\n        getSalesConsultants()?.catch((err) => {\r\n          console.error('[dropdowns:sales] Sales consultants failed:', err)\r\n          return []\r\n        }),\r\n        getFinanceManagers()?.catch((err) => {\r\n          console.error('[dropdowns:finance] Finance managers failed:', err)\r\n          return []\r\n        }),\r\n        useTenantLists\r\n          ? listStaffByOrg(tenant.orgId).catch((err) => {\r\n              console.error('[dropdowns:users] tenant staff failed:', err)\r\n              return []\r\n            })\r\n          : getUserProfiles({ activeOnly: true }).catch((err) => {\r\n              console.error('[dropdowns:users] global user profiles failed:', err)\r\n              return []\r\n            }),\r\n        useTenantLists\r\n          ? listVendorsByOrg(tenant.orgId).catch((err) => {\r\n              console.error('[dropdowns:vendors] tenant vendors failed:', err)\r\n              return []\r\n            })\r\n          : getVendors({ activeOnly: true }).catch((err) => {\r\n              console.error('[dropdowns:vendors] global vendors failed:', err)\r\n              return []\r\n            }),\r\n        useTenantLists\r\n          ? listProductsByOrg(tenant.orgId).catch((err) => {\r\n              console.error('[dropdowns:products] tenant products failed:', err)\r\n              return []\r\n            })\r\n          : getProducts({ activeOnly: true }).catch((err) => {\r\n              console.error('[dropdowns:products] global products failed:', err)\r\n              return []\r\n            }),\r\n        useTenantLists\r\n          ? listSmsTemplatesByOrg(tenant.orgId).catch((err) => {\r\n              console.error('[dropdowns:smsTemplates] tenant SMS templates failed:', err)\r\n              return []\r\n            })\r\n          : Promise.resolve([]),\r\n      ]\r\n\r\n      const [dc, sales, finance, users, vendors, products, smsTemplates] =\r\n        await Promise.all(promises)\r\n\r\n      setState({\r\n        dc,\r\n        sales,\r\n        finance,\r\n        users,\r\n        vendors,\r\n        products,\r\n        smsTemplates,\r\n        loading: false,\r\n        error: null,\r\n        searchResults: null,\r\n      })\r\n      setLastUpdate(Date.now())\r\n    } catch (err) {\r\n      setState({\r\n        dc: [],\r\n        sales: [],\r\n        finance: [],\r\n        users: [],\r\n        vendors: [],\r\n        products: [],\r\n        smsTemplates: [],\r\n        loading: false,\r\n        error: err?.message || 'Failed to load dropdown data',\r\n        searchResults: null,\r\n      })\r\n      console.error('[dropdowns] Dropdown data load failed:', err)\r\n    }\r\n  }\r\n\r\n  // Check if cache is still valid\r\n  const isCacheValid = () => {\r\n    if (!lastUpdate) return false\r\n    return Date.now() - lastUpdate < cacheTime\r\n  }\r\n\r\n  // Refresh data if cache is invalid\r\n  const refreshIfNeeded = async () => {\r\n    if (!isCacheValid()) {\r\n      await loadData()\r\n    }\r\n  }\r\n\r\n  // Enhanced search functionality with error handling\r\n  const performGlobalSearch = async (searchTerm) => {\r\n    try {\r\n      if (!searchTerm?.trim()) {\r\n        setState((prev) => ({ ...prev, searchResults: null }))\r\n        return\r\n      }\r\n\r\n      const results = await globalSearch(searchTerm)\r\n      setState((prev) => ({ ...prev, searchResults: results }))\r\n    } catch (err) {\r\n      console.error('[dropdowns:search] Search failed:', err)\r\n      setState((prev) => ({ ...prev, searchResults: { users: [], vendors: [] } }))\r\n    }\r\n  }\r\n\r\n  // Clear search results\r\n  const clearSearch = () => {\r\n    setState((prev) => ({ ...prev, searchResults: null }))\r\n  }\r\n\r\n  // Get user options with filtering\r\n  const getUserOptions = (filterOptions = {}) => {\r\n    const { roles = [], departments = [], activeOnly = true } = filterOptions\r\n\r\n    let filteredUsers = state?.users || []\r\n\r\n    if (activeOnly) {\r\n      filteredUsers = filteredUsers?.filter((user) => user?.is_active)\r\n    }\r\n\r\n    if (roles?.length > 0) {\r\n      filteredUsers = filteredUsers?.filter((user) => roles?.includes(user?.role))\r\n    }\r\n\r\n    if (departments?.length > 0) {\r\n      filteredUsers = filteredUsers?.filter((user) => departments?.includes(user?.department))\r\n    }\r\n\r\n    return (\r\n      filteredUsers?.map((user) => ({\r\n        id: user?.id,\r\n        value: user?.id,\r\n        label: user?.full_name,\r\n        name: user?.full_name,\r\n        role: user?.role,\r\n        department: user?.department,\r\n        email: user?.email,\r\n      })) || []\r\n    )\r\n  }\r\n\r\n  // Get vendor options with filtering\r\n  const getVendorOptions = (filterOptions = {}) => {\r\n    const { activeOnly = true, specialty = null } = filterOptions\r\n\r\n    let filteredVendors = state?.vendors || []\r\n\r\n    if (activeOnly) {\r\n      filteredVendors = filteredVendors?.filter((vendor) => vendor?.is_active)\r\n    }\r\n\r\n    if (specialty) {\r\n      filteredVendors = filteredVendors?.filter((vendor) =>\r\n        vendor?.specialty?.toLowerCase()?.includes(specialty?.toLowerCase())\r\n      )\r\n    }\r\n\r\n    return (\r\n      filteredVendors?.map((vendor) => ({\r\n        id: vendor?.id,\r\n        value: vendor?.value || vendor?.id,\r\n        label: vendor?.label || vendor?.name,\r\n        name: vendor?.name,\r\n        specialty: vendor?.specialty,\r\n        email: vendor?.email,\r\n        phone: vendor?.phone,\r\n      })) || []\r\n    )\r\n  }\r\n\r\n  // Load data on mount if requested\r\n  useEffect(() => {\r\n    let mounted = true\r\n\r\n    ;(async () => {\r\n      if (!loadOnMount) return\r\n\r\n      // wait until auth.loading === false (or timeout after a few tries)\r\n      const start = Date.now()\r\n      while (mounted && auth?.loading && Date.now() - start < 5000) {\r\n        // small sleep\r\n        // eslint-disable-next-line no-await-in-loop\r\n        await new Promise((r) => setTimeout(r, 200))\r\n      }\r\n\r\n      if (!mounted) return\r\n      if (!auth?.user) {\r\n        console.warn(\r\n          'Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS'\r\n        )\r\n      } else {\r\n        console.log('Dropdowns: authenticated user', auth?.user?.id)\r\n        if (auth?.userProfile) console.log('Dropdowns: user profile org', auth.userProfile)\r\n      }\r\n\r\n      if (mounted) await loadData()\r\n    })()\r\n\r\n    return () => {\r\n      mounted = false\r\n    }\r\n  }, [loadOnMount, auth?.loading, auth?.user?.id, tenant?.loading, tenant?.orgId])\r\n\r\n  return {\r\n    // Original data arrays\r\n    dc: state?.dc,\r\n    sales: state?.sales,\r\n    finance: state?.finance,\r\n    users: state?.users,\r\n    vendors: state?.vendors,\r\n    products: state?.products,\r\n    smsTemplates: state?.smsTemplates,\r\n\r\n    // Loading state\r\n    loading: state?.loading,\r\n    error: state?.error,\r\n\r\n    // Search functionality\r\n    searchResults: state?.searchResults,\r\n    globalSearch: performGlobalSearch,\r\n    clearSearch,\r\n\r\n    // Enhanced options methods expected by deals page\r\n    getUserOptions,\r\n    getVendorOptions,\r\n\r\n    // Actions\r\n    refresh: loadData,\r\n    refreshIfNeeded,\r\n\r\n    // Cache info\r\n    lastUpdate,\r\n    isCacheValid: isCacheValid(),\r\n\r\n    // Formatted options for backward compatibility\r\n    salesConsultantOptions: (state?.sales || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n\r\n    deliveryCoordinatorOptions: (state?.dc || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n\r\n    financeManagerOptions: (state?.finance || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n  }\r\n}\r\n\r\n// Enhanced deal form dropdowns hook with Finance Managers\r\nexport const useDealFormDropdowns = () => {\r\n  const {\r\n    dc: deliveryCoordinators,\r\n    sales: salesConsultants,\r\n    finance: financeManagers,\r\n    vendors,\r\n    products,\r\n    loading,\r\n    error,\r\n    refresh,\r\n  } = useDropdownData({ loadOnMount: true })\r\n\r\n  return {\r\n    // Deal-specific data with Finance Managers and additional data\r\n    salesConsultants,\r\n    deliveryCoordinators,\r\n    financeManagers,\r\n    vendors,\r\n    products,\r\n\r\n    // Loading state\r\n    loading,\r\n    error,\r\n\r\n    // Actions\r\n    refresh,\r\n\r\n    // Formatted options for dropdowns\r\n    salesConsultantOptions: (salesConsultants || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n\r\n    deliveryCoordinatorOptions: (deliveryCoordinators || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n\r\n    financeManagerOptions: (financeManagers || [])?.map((item) => ({\r\n      id: item?.id,\r\n      value: item?.id,\r\n      label: item?.full_name,\r\n      name: item?.full_name,\r\n    })),\r\n\r\n    vendorOptions: vendors || [],\r\n    productOptions: products || [],\r\n  }\r\n}\r\n\r\nexport default useDropdownData\r\n","import React, { useEffect } from 'react';\r\n\r\nconst Portal = () => {\r\n  React.useEffect(() => {\r\n    // eslint-disable-next-line no-console\r\n    console.warn('Placeholder: Portal is not implemented yet.');\r\n  }, []);\r\n  return (\r\n    <>\r\n  { /*Portal */} \r\n </>\r\n  );\r\n};\r\n\r\nexport { Portal };\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport Icon from './Icon';\r\nimport { Portal } from './Portal';\r\n\r\n/**\r\n * SearchableSelect Component with Mobile Native Select Support\r\n * Automatically detects mobile and renders native <select> for mobile devices\r\n * while keeping headless select with portal rendering for desktop\r\n */\r\nconst SearchableSelect = ({ \r\n  options = [], \r\n  value, \r\n  onChange, \r\n  placeholder = \"Select...\",\r\n  searchable = false,\r\n  clearable = false,\r\n  disabled = false,\r\n  loading = false,\r\n  error = null,\r\n  className = \"\",\r\n  optionLabel = \"label\",\r\n  optionValue = \"value\",\r\n  groupBy = null,\r\n  renderOption = null,\r\n  label = '',\r\n  helperText = ''\r\n}) => {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [isMobile, setIsMobile] = useState(false);\r\n  const [filteredOptions, setFilteredOptions] = useState(options);\r\n  const [highlightedIndex, setHighlightedIndex] = useState(-1);\r\n  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, left: 0, width: 0 });\r\n  \r\n  const containerRef = useRef(null);\r\n  const searchInputRef = useRef(null);\r\n  const listRef = useRef(null);\r\n\r\n  // Detect mobile device\r\n  useEffect(() => {\r\n    const checkIsMobile = () => {\r\n      return window.matchMedia('(max-width: 767px)')?.matches;\r\n    };\r\n    \r\n    setIsMobile(checkIsMobile());\r\n    \r\n    const mediaQuery = window.matchMedia('(max-width: 767px)');\r\n    const handleResize = () => setIsMobile(mediaQuery?.matches);\r\n    \r\n    mediaQuery?.addEventListener('change', handleResize);\r\n    return () => mediaQuery?.removeEventListener('change', handleResize);\r\n  }, []);\r\n\r\n  // Filter options based on search term\r\n  useEffect(() => {\r\n    if (!searchTerm?.trim()) {\r\n      setFilteredOptions(options);\r\n      return;\r\n    }\r\n\r\n    const term = searchTerm?.toLowerCase();\r\n    const filtered = options?.filter(option => {\r\n      const searchFields = [\r\n        option?.name,\r\n        option?.displayName,\r\n        option?.category,\r\n        option?.brand,\r\n        option?.specialty,\r\n        option?.department,\r\n        option?.email\r\n      ]?.filter(Boolean);\r\n\r\n      return searchFields?.some(field => \r\n        field?.toLowerCase()?.includes(term)\r\n      );\r\n    });\r\n\r\n    setFilteredOptions(filtered);\r\n    setHighlightedIndex(-1);\r\n  }, [searchTerm, options]);\r\n\r\n  // Find selected option\r\n  const selectedOption = options?.find(opt => opt?.id === value);\r\n\r\n  // Check if option is selected\r\n  const isSelected = (option) => {\r\n    return (option?.[optionValue] || option?.id) === value;\r\n  };\r\n\r\n  // Calculate dropdown position\r\n  const calculateDropdownPosition = () => {\r\n    if (containerRef?.current) {\r\n      const rect = containerRef?.current?.getBoundingClientRect();\r\n      setDropdownPosition({\r\n        top: rect?.bottom + window.scrollY,\r\n        left: rect?.left + window.scrollX,\r\n        width: rect?.width\r\n      });\r\n    }\r\n  };\r\n\r\n  // Update position when opening dropdown\r\n  useEffect(() => {\r\n    if (isOpen && !isMobile) {\r\n      calculateDropdownPosition();\r\n    }\r\n  }, [isOpen, isMobile]);\r\n\r\n  // Handle click outside (desktop only)\r\n  useEffect(() => {\r\n    if (isMobile) return; // Skip for mobile\r\n    \r\n    const handleClickOutside = (event) => {\r\n      if (containerRef?.current && !containerRef?.current?.contains(event?.target)) {\r\n        setIsOpen(false);\r\n        setSearchTerm('');\r\n        setHighlightedIndex(-1);\r\n      }\r\n    };\r\n\r\n    document?.addEventListener('mousedown', handleClickOutside);\r\n    return () => document?.removeEventListener('mousedown', handleClickOutside);\r\n  }, [isMobile]);\r\n\r\n  // Handle keyboard navigation (desktop only)\r\n  const handleKeyDown = (e) => {\r\n    if (isMobile) return; // Skip for mobile\r\n    \r\n    if (!isOpen) {\r\n      if (e?.key === 'Enter' || e?.key === ' ' || e?.key === 'ArrowDown') {\r\n        e?.preventDefault();\r\n        setIsOpen(true);\r\n        if (searchable) {\r\n          setTimeout(() => searchInputRef?.current?.focus(), 0);\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    switch (e?.key) {\r\n      case 'Escape':\r\n        setIsOpen(false);\r\n        setSearchTerm('');\r\n        setHighlightedIndex(-1);\r\n        break;\r\n      case 'ArrowDown':\r\n        e?.preventDefault();\r\n        setHighlightedIndex(prev => \r\n          prev < filteredOptions?.length - 1 ? prev + 1 : 0\r\n        );\r\n        break;\r\n      case 'ArrowUp':\r\n        e?.preventDefault();\r\n        setHighlightedIndex(prev => \r\n          prev > 0 ? prev - 1 : filteredOptions?.length - 1\r\n        );\r\n        break;\r\n      case 'Enter':\r\n        e?.preventDefault();\r\n        if (highlightedIndex >= 0 && filteredOptions?.[highlightedIndex]) {\r\n          handleSelect(filteredOptions?.[highlightedIndex]);\r\n        }\r\n        break;\r\n      case 'Tab':\r\n        setIsOpen(false);\r\n        setSearchTerm('');\r\n        setHighlightedIndex(-1);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  };\r\n\r\n  // Handle option selection\r\n  const handleSelect = (option) => {\r\n    onChange?.(option?.id);\r\n    setIsOpen(false);\r\n    setSearchTerm('');\r\n    setHighlightedIndex(-1);\r\n  };\r\n\r\n  // Handle clear selection (desktop only)\r\n  const handleClear = (e) => {\r\n    e?.stopPropagation();\r\n    onChange?.(null);\r\n  };\r\n\r\n  // ✅ FIXED: Use native select on mobile per user requirements\r\n  if (isMobile) {\r\n    return (\r\n      <div className={`relative ${className}`}>\r\n        <select\r\n          value={value || ''}\r\n          onChange={(e) => onChange?.(e?.target?.value || null)}\r\n          disabled={disabled || loading}\r\n          className={`\r\n            w-full px-3 py-2 border rounded-lg\r\n            ${error ? 'border-red-500' : 'border-gray-300'}\r\n            ${disabled || loading ? 'bg-gray-100 cursor-not-allowed' : 'bg-white'}\r\n            focus:ring-1 focus:ring-blue-500 focus:border-blue-500\r\n            appearance-none text-base\r\n          `}\r\n        >\r\n          <option value=\"\">{placeholder}</option>\r\n          {options?.map((option) => (\r\n            <option \r\n              key={option?.[optionValue] || option?.id} \r\n              value={option?.[optionValue] || option?.id}\r\n            >\r\n              {option?.[optionLabel] || option?.label || option?.name}\r\n            </option>\r\n          ))}\r\n        </select>\r\n        {/* Mobile select arrow */}\r\n        <div className=\"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none\">\r\n          <Icon name=\"ChevronDown\" size={16} className=\"text-gray-400\" />\r\n        </div>\r\n        {error && (\r\n          <div className=\"mt-1 text-sm text-red-600\">{error}</div>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // ✅ ENHANCED: Desktop headless dropdown with better portal rendering\r\n  return (\r\n    <div className={`relative ${className}`} ref={containerRef}>\r\n      {/* Trigger */}\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => !disabled && !loading && setIsOpen(!isOpen)}\r\n        onKeyDown={handleKeyDown}\r\n        disabled={disabled || loading}\r\n        className={`\r\n          w-full px-3 py-2 text-left border rounded-lg\r\n          ${error ? 'border-red-500' : 'border-gray-300'}\r\n          ${disabled || loading ? 'bg-gray-100 cursor-not-allowed' : 'bg-white hover:border-gray-400'}\r\n          ${isOpen ? 'ring-1 ring-blue-500 border-blue-500' : ''}\r\n          focus:ring-1 focus:ring-blue-500 focus:border-blue-500\r\n          flex items-center justify-between\r\n        `}\r\n      >\r\n        {/* Display text */}\r\n        <span className={selectedOption ? 'text-gray-900' : 'text-gray-500'}>\r\n          {selectedOption ? (selectedOption?.[optionLabel] || selectedOption?.label) : placeholder}\r\n        </span>\r\n        \r\n        {/* Icons */}\r\n        <div className=\"flex items-center space-x-1\">\r\n          {loading && <Icon name=\"Loader2\" size={16} className=\"animate-spin text-gray-400\" />}\r\n          {clearable && selectedOption && !loading && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleClear}\r\n              className=\"p-0.5 hover:bg-gray-200 rounded\"\r\n            >\r\n              <Icon name=\"X\" size={14} className=\"text-gray-400 hover:text-gray-600\" />\r\n            </button>\r\n          )}\r\n          <Icon \r\n            name={isOpen ? \"ChevronUp\" : \"ChevronDown\"} \r\n            size={16} \r\n            className=\"text-gray-400\" \r\n          />\r\n        </div>\r\n      </button>\r\n      {/* ✅ ENHANCED: Portal-rendered dropdown with proper z-index */}\r\n      {isOpen && typeof window !== 'undefined' && (\r\n        <Portal>\r\n          <div \r\n            className=\"fixed inset-0 z-50\"\r\n            onClick={() => setIsOpen(false)}\r\n          >\r\n            <div \r\n              style={{\r\n                position: 'absolute',\r\n                top: `${dropdownPosition?.top}px`,\r\n                left: `${dropdownPosition?.left}px`,\r\n                width: `${dropdownPosition?.width}px`,\r\n                zIndex: 9999\r\n              }}\r\n              className=\"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden\"\r\n              onClick={(e) => e?.stopPropagation()}\r\n            >\r\n              {/* Search input */}\r\n              {searchable && (\r\n                <div className=\"p-2 border-b border-gray-200\">\r\n                  <input\r\n                    type=\"text\"\r\n                    value={searchTerm}\r\n                    onChange={(e) => setSearchTerm(e?.target?.value)}\r\n                    placeholder=\"Search...\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500\"\r\n                    autoFocus\r\n                  />\r\n                </div>\r\n              )}\r\n\r\n              {/* Options list */}\r\n              <div className=\"max-h-48 overflow-auto\">\r\n                {filteredOptions?.length === 0 ? (\r\n                  <div className=\"px-3 py-2 text-sm text-gray-500\">\r\n                    {searchTerm ? 'No results found' : 'No options available'}\r\n                  </div>\r\n                ) : (\r\n                  filteredOptions?.map((option) => (\r\n                    <button\r\n                      key={option?.[optionValue] || option?.id}\r\n                      type=\"button\"\r\n                      onClick={() => handleSelect(option)}\r\n                      className={`\r\n                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50\r\n                        ${isSelected(option) ? 'bg-blue-50 text-blue-700' : 'text-gray-900'}\r\n                        focus:bg-gray-50 focus:outline-none\r\n                      `}\r\n                    >\r\n                      {option?.[optionLabel] || option?.label || option?.name}\r\n                    </button>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </Portal>\r\n      )}\r\n      {/* Error message */}\r\n      {error && (\r\n        <div className=\"mt-1 text-sm text-red-600\">{error}</div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SearchableSelect;","import React, { useEffect, useMemo, useState } from 'react'\r\nimport { getDeal, updateDeal, deleteDeal, mapDbDealToForm } from '../../../services/dealService'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport { useDealFormDropdowns } from '../../../hooks/useDropdownData'\r\nimport Button from '../../../components/ui/Button'\r\nimport Input from '../../../components/ui/Input'\r\nimport Select from '../../../components/ui/Select'\r\nimport SearchableSelect from '../../../components/ui/SearchableSelect'\r\nimport Icon from '../../../components/ui/Icon'\r\n\r\n// Accept either a dealId to fetch or a preloaded deal object to render immediately\r\nconst EditDealModal = ({ isOpen, dealId, deal: initialDeal, onClose, onSuccess }) => {\r\n  const [loading, setLoading] = useState(true)\r\n  const [saving, setSaving] = useState(false)\r\n  const [error, setError] = useState('')\r\n  const [deleteConfirm, setDeleteConfirm] = useState(false)\r\n  const [deleting, setDeleting] = useState(false)\r\n  const [isDirty, setIsDirty] = useState(false)\r\n  const [showUnsavedWarning, setShowUnsavedWarning] = useState(false)\r\n  const [initialFormData, setInitialFormData] = useState(null)\r\n  const [loanerAssignment, setLoanerAssignment] = useState(null)\r\n  const [loanerForm, setLoanerForm] = useState({\r\n    loaner_number: '',\r\n    eta_return_date: '',\r\n    notes: '',\r\n  })\r\n\r\n  // Enhanced dropdown data\r\n  const {\r\n    // Use pre-formatted option arrays so labels/ids match SearchableSelect expectations\r\n    salesConsultantOptions,\r\n    deliveryCoordinatorOptions,\r\n    financeManagerOptions,\r\n    vendorOptions: vendors,\r\n    productOptions: products,\r\n    loading: dropdownLoading,\r\n    refresh: refreshDropdowns,\r\n  } = useDealFormDropdowns()\r\n\r\n  // Form state\r\n  const [formData, setFormData] = useState({\r\n    customerName: '',\r\n    customerPhone: '',\r\n    customerEmail: '',\r\n    job_status: 'draft',\r\n    priority: 'medium',\r\n    customer_needs_loaner: false,\r\n    assignedTo: null,\r\n    deliveryCoordinator: null,\r\n    financeManager: null,\r\n    lineItems: [],\r\n  })\r\n\r\n  // Dirty state tracking\r\n  useEffect(() => {\r\n    if (initialFormData) {\r\n      const hasChanges = JSON.stringify(formData) !== JSON.stringify(initialFormData)\r\n      setIsDirty(hasChanges)\r\n    }\r\n  }, [formData, initialFormData])\r\n\r\n  // Load dropdown data when the modal opens (non-blocking; hook caches results)\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      try {\r\n        refreshDropdowns?.()\r\n      } catch {}\r\n    }\r\n  }, [isOpen, refreshDropdowns])\r\n\r\n  // If a preloaded deal object is provided, use it; otherwise load by id\r\n  useEffect(() => {\r\n    if (!isOpen) return\r\n    // Prefer preloaded deal for instant render (avoids a second network call)\r\n    if (initialDeal && initialDeal?.id) {\r\n      try {\r\n        const formDeal = mapDbDealToForm(initialDeal)\r\n        const loadedFormData = {\r\n          ...formDeal,\r\n          // Map DB snake_case to UI camelCase for staff + vendor selections\r\n          assignedTo: formDeal?.assigned_to || null,\r\n          deliveryCoordinator: formDeal?.delivery_coordinator_id || null,\r\n          financeManager: formDeal?.finance_manager_id || null,\r\n          vendor_id: formDeal?.vendor_id || null,\r\n          customerName: initialDeal?.customer_name || '',\r\n          customerPhone: initialDeal?.customer_phone || '',\r\n          customerEmail: initialDeal?.customer_email || '',\r\n          lineItems:\r\n            (formDeal?.lineItems || [])?.length > 0\r\n              ? toCamelLineItems(formDeal?.lineItems)\r\n              : [createEmptyLineItem()],\r\n        }\r\n        setFormData(loadedFormData)\r\n        setInitialFormData(JSON.parse(JSON.stringify(loadedFormData)))\r\n        setLoading(false)\r\n        setError('')\r\n      } catch (e) {\r\n        console.warn('[EditDealModal] failed to preload deal, falling back to fetch:', e)\r\n        loadDealData()\r\n      }\r\n    } else if (dealId) {\r\n      loadDealData()\r\n    } else {\r\n      // If opened with neither dealId nor deal, show a friendly error instead of spinning forever\r\n      setError('No deal selected to edit.')\r\n      setLoading(false)\r\n    }\r\n  }, [isOpen, dealId, initialDeal?.id])\r\n\r\n  // Safety: if something goes sideways, stop showing the spinner after a short timeout\r\n  useEffect(() => {\r\n    if (!isOpen) return\r\n    if (!loading) return\r\n    const t = setTimeout(() => {\r\n      setLoading(false)\r\n      setError((prev) => prev || 'Took longer than expected to load. You can retry the load.')\r\n    }, 8000)\r\n    return () => clearTimeout(t)\r\n  }, [isOpen, loading])\r\n\r\n  // Simplified Loaner Checkbox (native behavior; single-click reliable)\r\n  const LoanerCheckbox = ({ checked, onChange }) => (\r\n    <div className=\"bg-slate-50 p-4 rounded-lg border\">\r\n      <label\r\n        htmlFor=\"customer_needs_loaner\"\r\n        className=\"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer\"\r\n      >\r\n        <input\r\n          id=\"customer_needs_loaner\"\r\n          type=\"checkbox\"\r\n          checked={Boolean(checked)}\r\n          onChange={(e) => onChange(Boolean(e?.target?.checked))}\r\n          className=\"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n          data-testid=\"loaner-checkbox\"\r\n        />\r\n        <span className=\"text-sm font-medium text-gray-700 select-none\">\r\n          Customer needs loaner vehicle\r\n        </span>\r\n      </label>\r\n    </div>\r\n  )\r\n\r\n  // Enhanced Service Type Radio with proper mobile accessibility\r\n  const ServiceTypeRadio = ({ value, selectedValue, onChange, itemIndex, disabled = false }) => (\r\n    <div className=\"flex space-x-6\">\r\n      <label className=\"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer\">\r\n        <input\r\n          type=\"radio\"\r\n          name={`serviceLocation_${itemIndex}`}\r\n          value=\"in_house\"\r\n          checked={!selectedValue}\r\n          onChange={() => onChange(false)}\r\n          className=\"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500\"\r\n          data-testid=\"service-type-in-house\"\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"text-sm text-gray-700 select-none\">🏠 On-Site</span>\r\n      </label>\r\n      <label className=\"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer\">\r\n        <input\r\n          type=\"radio\"\r\n          name={`serviceLocation_${itemIndex}`}\r\n          value=\"vendor\"\r\n          checked={selectedValue}\r\n          onChange={() => onChange(true)}\r\n          className=\"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500\"\r\n          data-testid=\"service-type-vendor\"\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"text-sm text-gray-700 select-none\">🏢 Off-Site</span>\r\n      </label>\r\n    </div>\r\n  )\r\n\r\n  // Enhanced Scheduling Radio with mobile optimization\r\n  const SchedulingRadio = ({ requiresScheduling, onChange, itemIndex, disabled = false }) => (\r\n    <div className=\"flex space-x-6\">\r\n      <label className=\"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer\">\r\n        <input\r\n          type=\"radio\"\r\n          name={`scheduling_${itemIndex}`}\r\n          checked={requiresScheduling === true}\r\n          onChange={() => onChange(true)}\r\n          className=\"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500\"\r\n          data-testid=\"requires-scheduling-yes\"\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"text-sm text-gray-700 select-none\">Needs scheduling</span>\r\n      </label>\r\n      <label className=\"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer\">\r\n        <input\r\n          type=\"radio\"\r\n          name={`scheduling_${itemIndex}`}\r\n          checked={requiresScheduling === false}\r\n          onChange={() => onChange(false)}\r\n          className=\"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500\"\r\n          data-testid=\"requires-scheduling-no\"\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"text-sm text-gray-700 select-none\">No scheduling needed</span>\r\n      </label>\r\n    </div>\r\n  )\r\n\r\n  // Normalize DB/Supabase line items into the camelCase keys this modal expects\r\n  const toCamelLineItems = (items = []) =>\r\n    (items || []).map((part) => ({\r\n      product_id: part?.product_id ?? null,\r\n      unit_price: part?.unit_price ?? 0,\r\n      quantity_used: part?.quantity_used ?? 1,\r\n      lineItemPromisedDate: part?.lineItemPromisedDate || part?.promised_date || '',\r\n      requiresScheduling:\r\n        typeof part?.requiresScheduling === 'boolean'\r\n          ? part?.requiresScheduling\r\n          : !!part?.requires_scheduling,\r\n      noScheduleReason: part?.noScheduleReason || part?.no_schedule_reason || '',\r\n      isOffSite: typeof part?.isOffSite === 'boolean' ? part?.isOffSite : !!part?.is_off_site,\r\n      description: part?.description || '',\r\n    }))\r\n\r\n  const loadDealData = async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError('')\r\n\r\n      const deal = await getDeal(dealId)\r\n      const formDeal = mapDbDealToForm(deal)\r\n\r\n      // Get transaction data for customer info\r\n      const { data: transaction } = await supabase\r\n        ?.from('transactions')\r\n        ?.select('customer_name, customer_phone, customer_email')\r\n        ?.eq('job_id', dealId)\r\n        ?.single()\r\n\r\n      // Load active loaner assignment (if any)\r\n      let activeLoaner = null\r\n      try {\r\n        const { data: la } = await supabase\r\n          ?.from('loaner_assignments')\r\n          ?.select('id, loaner_number, eta_return_date, returned_at')\r\n          ?.eq('job_id', dealId)\r\n          ?.is('returned_at', null)\r\n          ?.limit(1)\r\n        activeLoaner = Array.isArray(la) ? la[0] : la\r\n      } catch (_) {\r\n        // ignore\r\n      }\r\n\r\n      const loadedFormData = {\r\n        ...formDeal,\r\n        // Map DB snake_case to UI camelCase for staff + vendor selections\r\n        assignedTo: formDeal?.assigned_to || null,\r\n        deliveryCoordinator: formDeal?.delivery_coordinator_id || null,\r\n        financeManager: formDeal?.finance_manager_id || null,\r\n        vendor_id: formDeal?.vendor_id || null,\r\n        customerName: transaction?.customer_name || '',\r\n        customerPhone: transaction?.customer_phone || '',\r\n        customerEmail: transaction?.customer_email || '',\r\n        lineItems:\r\n          (formDeal?.lineItems || [])?.length > 0\r\n            ? toCamelLineItems(formDeal?.lineItems)\r\n            : [createEmptyLineItem()],\r\n      }\r\n\r\n      setFormData(loadedFormData)\r\n      setInitialFormData(JSON.parse(JSON.stringify(loadedFormData))) // Deep copy for comparison\r\n      setLoanerAssignment(activeLoaner || null)\r\n\r\n      // Initialize loaner form\r\n      if (activeLoaner) {\r\n        setLoanerForm({\r\n          loaner_number: activeLoaner?.loaner_number || '',\r\n          eta_return_date: activeLoaner?.eta_return_date || '',\r\n          notes: activeLoaner?.notes || '',\r\n        })\r\n      } else {\r\n        // Default ETA to the latest scheduled promised_date among line items (if any)\r\n        const dates = (loadedFormData?.lineItems || [])\r\n          .filter((li) => li?.requiresScheduling && li?.lineItemPromisedDate)\r\n          .map((li) => new Date(li.lineItemPromisedDate).getTime())\r\n        const latest = dates?.length ? new Date(Math.max(...dates)) : null\r\n        setLoanerForm((prev) => ({\r\n          ...prev,\r\n          eta_return_date: latest ? latest.toISOString().split('T')[0] : '',\r\n        }))\r\n      }\r\n    } catch (err) {\r\n      setError(`Failed to load deal: ${err?.message}`)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const createEmptyLineItem = () => ({\r\n    product_id: null,\r\n    unit_price: 0,\r\n    quantity_used: 1,\r\n    lineItemPromisedDate: '',\r\n    requiresScheduling: false,\r\n    noScheduleReason: '',\r\n    isOffSite: false,\r\n    description: '',\r\n  })\r\n\r\n  const updateFormData = (updates) => {\r\n    setFormData((prev) => ({ ...prev, ...updates }))\r\n  }\r\n\r\n  const updateLineItem = (index, updates) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      lineItems: prev?.lineItems?.map((item, i) => {\r\n        if (i === index) {\r\n          let updatedItem = { ...item, ...updates }\r\n\r\n          // Boolean coercion and paired field clearing\r\n          if ('requiresScheduling' in updates) {\r\n            updatedItem.requiresScheduling = Boolean(updates?.requiresScheduling)\r\n            if (updates?.requiresScheduling === true) {\r\n              updatedItem.noScheduleReason = ''\r\n            } else {\r\n              updatedItem.lineItemPromisedDate = ''\r\n            }\r\n          }\r\n\r\n          if ('isOffSite' in updates) {\r\n            updatedItem.isOffSite = Boolean(updates?.isOffSite)\r\n            if (!updates?.isOffSite) {\r\n              updatedItem.vendorId = ''\r\n            }\r\n          }\r\n\r\n          return updatedItem\r\n        }\r\n        return item\r\n      }),\r\n    }))\r\n\r\n    // Auto-populate price when product is selected\r\n    if (updates?.product_id) {\r\n      const selectedProduct = products?.find((p) => p?.id === updates?.product_id)\r\n      if (selectedProduct) {\r\n        setFormData((prev) => ({\r\n          ...prev,\r\n          lineItems: prev?.lineItems?.map((item, i) =>\r\n            i === index\r\n              ? {\r\n                  ...item,\r\n                  unit_price:\r\n                    selectedProduct?.unitPrice || selectedProduct?.unit_price || item?.unit_price,\r\n                  cost_price: selectedProduct?.cost || item?.cost_price,\r\n                }\r\n              : item\r\n          ),\r\n        }))\r\n      }\r\n    }\r\n  }\r\n\r\n  const addLineItem = () => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      lineItems: [...prev?.lineItems, createEmptyLineItem()],\r\n    }))\r\n  }\r\n\r\n  const removeLineItem = (index) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      lineItems: prev?.lineItems?.filter((_, i) => i !== index),\r\n    }))\r\n  }\r\n\r\n  const handleSave = async () => {\r\n    try {\r\n      setSaving(true)\r\n      setError('')\r\n\r\n      if (!formData?.customerName?.trim()) {\r\n        setError('Customer name is required')\r\n        return\r\n      }\r\n\r\n      // Validate line items with scheduling\r\n      for (let i = 0; i < formData?.lineItems?.length; i++) {\r\n        const item = formData?.lineItems?.[i]\r\n\r\n        if (!item?.product_id) {\r\n          setError(`Line item ${i + 1}: Product is required`)\r\n          return\r\n        }\r\n\r\n        if (item?.requiresScheduling && !item?.lineItemPromisedDate) {\r\n          setError(`Line item ${i + 1}: Promised date is required when scheduling is needed`)\r\n          return\r\n        }\r\n\r\n        if (!item?.requiresScheduling && !item?.noScheduleReason?.trim()) {\r\n          setError(`Line item ${i + 1}: Reason is required when no scheduling is needed`)\r\n          return\r\n        }\r\n\r\n        // Vendor selection is tracked at the deal level (vendor_id). No per-line vendor requirement.\r\n      }\r\n\r\n      // Update the deal with proper boolean coercion\r\n      const updatedFormData = {\r\n        ...formData,\r\n        customer_needs_loaner: Boolean(formData?.customer_needs_loaner),\r\n        lineItems: formData?.lineItems?.map((item) => ({\r\n          ...item,\r\n          requiresScheduling: Boolean(item?.requiresScheduling),\r\n          isOffSite: Boolean(item?.isOffSite),\r\n          unit_price: parseFloat(item?.unit_price) || 0,\r\n          quantity_used: parseInt(item?.quantity_used) || 1,\r\n        })),\r\n      }\r\n\r\n      // Map UI camelCase fields back to DB snake_case keys for service layer\r\n      const payloadForSave = {\r\n        ...updatedFormData,\r\n        assigned_to: updatedFormData?.assignedTo ?? null,\r\n        delivery_coordinator_id: updatedFormData?.deliveryCoordinator ?? null,\r\n        finance_manager_id: updatedFormData?.financeManager ?? null,\r\n        vendor_id: updatedFormData?.vendor_id ?? null,\r\n      }\r\n\r\n      // Include inline loaner form (optional) for assignment upsert\r\n      await updateDeal(dealId, { ...payloadForSave, loanerForm })\r\n\r\n      onSuccess?.()\r\n      onClose?.()\r\n    } catch (err) {\r\n      setError(`Failed to save deal: ${err?.message}`)\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const handleDelete = async () => {\r\n    try {\r\n      setDeleting(true)\r\n      await deleteDeal(dealId)\r\n      onSuccess?.()\r\n      onClose?.()\r\n    } catch (err) {\r\n      setError(`Failed to delete deal: ${err?.message}`)\r\n    } finally {\r\n      setDeleting(false)\r\n      setDeleteConfirm(false)\r\n    }\r\n  }\r\n\r\n  // Enhanced close handler with unsaved changes guard\r\n  const handleClose = () => {\r\n    if (isDirty) {\r\n      setShowUnsavedWarning(true)\r\n    } else {\r\n      onClose()\r\n    }\r\n  }\r\n\r\n  const confirmClose = () => {\r\n    setShowUnsavedWarning(false)\r\n    onClose()\r\n  }\r\n\r\n  // Calculate total with guard for NaN\r\n  const calculateTotal = () => {\r\n    return (\r\n      formData?.lineItems?.reduce((total, item) => {\r\n        const price = parseFloat(item?.unit_price) || 0\r\n        const quantity = parseInt(item?.quantity_used) || 1\r\n        return total + price * quantity\r\n      }, 0) || 0\r\n    )\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl\">\r\n        {/* Header with enhanced styling */}\r\n        <div className=\"flex items-center justify-between p-6 border-b bg-slate-50\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900\">Edit Deal</h2>\r\n          <button\r\n            onClick={handleClose}\r\n            className=\"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600\"\r\n          >\r\n            <Icon name=\"X\" size={20} />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content with light theme */}\r\n        <div className=\"overflow-y-auto max-h-[calc(90vh-180px)]\">\r\n          <div className=\"p-6 space-y-6 bg-white\">\r\n            {error && (\r\n              <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\r\n                <div className=\"text-red-800 text-sm\">{error}</div>\r\n              </div>\r\n            )}\r\n\r\n            {dropdownLoading && (\r\n              <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n                <div className=\"text-blue-800 text-sm\">Loading dropdown data...</div>\r\n              </div>\r\n            )}\r\n\r\n            {loading ? (\r\n              <div className=\"flex flex-col items-center justify-center py-12 gap-3\">\r\n                <div className=\"text-gray-600\">Loading deal...</div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    loadDealData()\r\n                    try {\r\n                      refreshDropdowns?.()\r\n                    } catch {}\r\n                  }}\r\n                  className=\"text-sm text-blue-600 hover:text-blue-800\"\r\n                >\r\n                  Having trouble? Retry load\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                {/* Basic Info with mobile-first layout */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Status</label>\r\n                    <Select\r\n                      value={formData?.job_status}\r\n                      onChange={(e) => updateFormData({ job_status: e?.target?.value })}\r\n                    >\r\n                      <option value=\"draft\">Draft</option>\r\n                      <option value=\"pending\">Pending</option>\r\n                      <option value=\"in_progress\">In Progress</option>\r\n                      <option value=\"completed\">Completed</option>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Customer Name *\r\n                    </label>\r\n                    <Input\r\n                      id=\"customer-name\"\r\n                      aria-label=\"Customer name input\"\r\n                      label=\"\"\r\n                      helperText=\"\"\r\n                      maxLength={255}\r\n                      style={{}}\r\n                      value={formData?.customerName}\r\n                      onChange={(e) => updateFormData({ customerName: e?.target?.value })}\r\n                      placeholder=\"Enter customer name\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Customer Phone\r\n                    </label>\r\n                    <Input\r\n                      id=\"customer-phone\"\r\n                      aria-label=\"Customer phone input\"\r\n                      label=\"\"\r\n                      helperText=\"\"\r\n                      maxLength={20}\r\n                      style={{}}\r\n                      value={formData?.customerPhone}\r\n                      onChange={(e) => updateFormData({ customerPhone: e?.target?.value })}\r\n                      placeholder=\"Enter phone number\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Customer Email\r\n                    </label>\r\n                    <Input\r\n                      id=\"customer-email\"\r\n                      aria-label=\"Customer email input\"\r\n                      label=\"\"\r\n                      helperText=\"\"\r\n                      maxLength={255}\r\n                      style={{}}\r\n                      type=\"email\"\r\n                      value={formData?.customerEmail}\r\n                      onChange={(e) => updateFormData({ customerEmail: e?.target?.value })}\r\n                      placeholder=\"Enter email address\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Priority</label>\r\n                    <Select\r\n                      value={formData?.priority}\r\n                      onChange={(e) => updateFormData({ priority: e?.target?.value })}\r\n                    >\r\n                      <option value=\"low\">Low</option>\r\n                      <option value=\"medium\">Medium</option>\r\n                      <option value=\"high\">High</option>\r\n                      <option value=\"urgent\">Urgent</option>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Vehicle Information Section - Visible on Mobile and Desktop */}\r\n                <div className=\"block bg-slate-50 p-4 rounded-lg border\">\r\n                  <h4 className=\"text-lg font-medium text-gray-900 mb-4\">Vehicle Information</h4>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">Year</label>\r\n                      <Input\r\n                        id=\"vehicle-year\"\r\n                        aria-label=\"Vehicle year input\"\r\n                        label=\"\"\r\n                        helperText=\"\"\r\n                        maxLength={4}\r\n                        style={{}}\r\n                        type=\"number\"\r\n                        value={formData?.vehicleYear || ''}\r\n                        onChange={(e) => updateFormData({ vehicleYear: e?.target?.value })}\r\n                        placeholder=\"2024\"\r\n                        min=\"1900\"\r\n                        max={new Date()?.getFullYear() + 2}\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">Make</label>\r\n                      <Input\r\n                        id=\"vehicle-make\"\r\n                        aria-label=\"Vehicle make input\"\r\n                        label=\"\"\r\n                        helperText=\"\"\r\n                        maxLength={50}\r\n                        style={{}}\r\n                        value={formData?.vehicleMake || ''}\r\n                        onChange={(e) => updateFormData({ vehicleMake: e?.target?.value })}\r\n                        placeholder=\"Toyota\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">Model</label>\r\n                      <Input\r\n                        id=\"vehicle-model\"\r\n                        aria-label=\"Vehicle model input\"\r\n                        label=\"\"\r\n                        helperText=\"\"\r\n                        maxLength={50}\r\n                        style={{}}\r\n                        value={formData?.vehicleModel || ''}\r\n                        onChange={(e) => updateFormData({ vehicleModel: e?.target?.value })}\r\n                        placeholder=\"Camry\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"mt-4\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Stock Number\r\n                    </label>\r\n                    <Input\r\n                      id=\"vehicle-stock\"\r\n                      aria-label=\"Vehicle stock number input\"\r\n                      label=\"\"\r\n                      helperText=\"\"\r\n                      maxLength={20}\r\n                      style={{}}\r\n                      value={formData?.stockNumber || ''}\r\n                      onChange={(e) => updateFormData({ stockNumber: e?.target?.value })}\r\n                      placeholder=\"Enter stock number\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Customer Needs Loaner with enhanced styling and click propagation */}\r\n                <div className=\"space-y-3\">\r\n                  <LoanerCheckbox\r\n                    checked={formData?.customer_needs_loaner}\r\n                    onChange={(checked) => {\r\n                      updateFormData({ customer_needs_loaner: checked })\r\n                      if (checked) {\r\n                        // If turning on and ETA empty, default to latest scheduled promised date\r\n                        if (!loanerForm?.eta_return_date) {\r\n                          const dates = (formData?.lineItems || [])\r\n                            .filter((li) => li?.requiresScheduling && li?.lineItemPromisedDate)\r\n                            .map((li) => new Date(li.lineItemPromisedDate).getTime())\r\n                          const latest = dates?.length ? new Date(Math.max(...dates)) : null\r\n                          if (latest) {\r\n                            setLoanerForm((prev) => ({\r\n                              ...prev,\r\n                              eta_return_date: latest.toISOString().split('T')[0],\r\n                            }))\r\n                          }\r\n                        }\r\n                      }\r\n                    }}\r\n                  />\r\n                  {/* Current Loaner summary (mirrors Deals page badge) */}\r\n                  {loanerAssignment && (\r\n                    <div className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200\">\r\n                      🚗 Loaner #{loanerAssignment?.loaner_number}\r\n                      {loanerAssignment?.eta_return_date && (\r\n                        <span className=\"ml-1\">\r\n                          • due{' '}\r\n                          {new Date(loanerAssignment?.eta_return_date)?.toLocaleDateString(\r\n                            'en-US',\r\n                            { month: 'short', day: 'numeric' }\r\n                          )}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Inline Loaner editor */}\r\n                  {formData?.customer_needs_loaner && (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4\">\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                          Loaner Number\r\n                        </label>\r\n                        <Input\r\n                          id=\"loaner-number\"\r\n                          aria-label=\"Loaner number\"\r\n                          value={loanerForm?.loaner_number || ''}\r\n                          onChange={(e) =>\r\n                            setLoanerForm((prev) => ({ ...prev, loaner_number: e?.target?.value }))\r\n                          }\r\n                          placeholder=\"e.g. 1234\"\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                          ETA Return Date\r\n                        </label>\r\n                        <Input\r\n                          id=\"loaner-eta\"\r\n                          aria-label=\"Loaner ETA\"\r\n                          type=\"date\"\r\n                          value={loanerForm?.eta_return_date || ''}\r\n                          onChange={(e) =>\r\n                            setLoanerForm((prev) => ({\r\n                              ...prev,\r\n                              eta_return_date: e?.target?.value,\r\n                            }))\r\n                          }\r\n                          min={new Date()?.toISOString()?.split('T')?.[0]}\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                          Notes\r\n                        </label>\r\n                        <Input\r\n                          id=\"loaner-notes\"\r\n                          aria-label=\"Loaner notes\"\r\n                          value={loanerForm?.notes || ''}\r\n                          onChange={(e) =>\r\n                            setLoanerForm((prev) => ({ ...prev, notes: e?.target?.value }))\r\n                          }\r\n                          placeholder=\"Optional notes\"\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Dealer Representatives */}\r\n                <div className=\"bg-slate-50 p-4 rounded-lg border\">\r\n                  <h4 className=\"text-lg font-medium text-gray-900 mb-4\">Dealer Representatives</h4>\r\n\r\n                  {/* Vendor (job-level) */}\r\n                  <div className=\"mb-4\" data-testid=\"vendor-select\">\r\n                    <SearchableSelect\r\n                      label=\"Vendor\"\r\n                      options={vendors}\r\n                      value={formData?.vendor_id || ''}\r\n                      onChange={(value) => updateFormData({ vendor_id: value || null })}\r\n                      placeholder=\"Select vendor\"\r\n                      searchable={true}\r\n                      clearable={true}\r\n                      groupBy=\"specialty\"\r\n                    />\r\n                  </div>\r\n\r\n                  {/* Sales Consultant */}\r\n                  <div className=\"mb-4\" data-testid=\"sales-select\">\r\n                    <SearchableSelect\r\n                      label=\"Sales Consultant\"\r\n                      options={salesConsultantOptions}\r\n                      value={formData?.assignedTo}\r\n                      onChange={(value) => updateFormData({ assignedTo: value })}\r\n                      placeholder=\"Select sales consultant\"\r\n                      searchable={true}\r\n                      clearable={true}\r\n                    />\r\n                  </div>\r\n\r\n                  {/* Delivery Coordinator */}\r\n                  <div className=\"mb-4\" data-testid=\"delivery-select\">\r\n                    <SearchableSelect\r\n                      label=\"Delivery Coordinator\"\r\n                      options={deliveryCoordinatorOptions}\r\n                      value={formData?.deliveryCoordinator}\r\n                      onChange={(value) => updateFormData({ deliveryCoordinator: value })}\r\n                      placeholder=\"Select delivery coordinator\"\r\n                      searchable={true}\r\n                      clearable={true}\r\n                    />\r\n                  </div>\r\n\r\n                  {/* Finance Manager */}\r\n                  <div data-testid=\"finance-select\">\r\n                    <SearchableSelect\r\n                      label=\"Finance Manager\"\r\n                      options={financeManagerOptions}\r\n                      value={formData?.financeManager}\r\n                      onChange={(value) => updateFormData({ financeManager: value })}\r\n                      placeholder=\"Select finance manager\"\r\n                      searchable={true}\r\n                      clearable={true}\r\n                      helperText=\"Optional - does not block saves\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Line Items */}\r\n                <div>\r\n                  <div className=\"flex items-center justify-between mb-4\">\r\n                    <h3 className=\"text-lg font-medium text-gray-900\">Line Items</h3>\r\n                    <Button\r\n                      className=\"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100\"\r\n                      aria-label=\"Add line item\"\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={addLineItem}\r\n                    >\r\n                      <Icon name=\"Plus\" size={16} className=\"mr-2\" />\r\n                      Add Item\r\n                    </Button>\r\n                  </div>\r\n\r\n                  <div className=\"space-y-4\">\r\n                    {formData?.lineItems?.map((item, index) => (\r\n                      <div key={index} className=\"border rounded-xl p-4 bg-slate-50\">\r\n                        <div className=\"flex items-center justify-between mb-4\">\r\n                          <h4 className=\"font-medium text-gray-900\">Item #{index + 1}</h4>\r\n                          {formData?.lineItems?.length > 1 && (\r\n                            <Button\r\n                              className=\"text-red-600 hover:text-red-800 hover:bg-red-50\"\r\n                              aria-label=\"Remove line item\"\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => removeLineItem(index)}\r\n                            >\r\n                              <Icon name=\"Trash2\" size={16} />\r\n                            </Button>\r\n                          )}\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4\">\r\n                          <div>\r\n                            <SearchableSelect\r\n                              label=\"Product *\"\r\n                              options={products}\r\n                              value={item?.product_id || ''}\r\n                              onChange={(value) =>\r\n                                updateLineItem(index, {\r\n                                  product_id: value ? parseInt(value) : null,\r\n                                })\r\n                              }\r\n                              placeholder=\"Select product\"\r\n                              searchable={true}\r\n                              clearable={true}\r\n                              groupBy=\"category\"\r\n                            />\r\n                          </div>\r\n\r\n                          <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                              Unit Price *\r\n                            </label>\r\n                            <Input\r\n                              id={`unit-price-${index}`}\r\n                              aria-label=\"Unit price input\"\r\n                              label=\"\"\r\n                              helperText=\"\"\r\n                              maxLength={10}\r\n                              style={{}}\r\n                              type=\"number\"\r\n                              step=\"0.01\"\r\n                              value={item?.unit_price}\r\n                              onChange={(e) =>\r\n                                updateLineItem(index, {\r\n                                  unit_price: parseFloat(e?.target?.value) || 0,\r\n                                })\r\n                              }\r\n                              placeholder=\"0.00\"\r\n                            />\r\n                          </div>\r\n\r\n                          <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                              Quantity\r\n                            </label>\r\n                            <Input\r\n                              id={`quantity-${index}`}\r\n                              aria-label=\"Quantity input\"\r\n                              label=\"\"\r\n                              helperText=\"\"\r\n                              maxLength={10}\r\n                              style={{}}\r\n                              type=\"number\"\r\n                              min=\"1\"\r\n                              value={item?.quantity_used}\r\n                              onChange={(e) =>\r\n                                updateLineItem(index, {\r\n                                  quantity_used: parseInt(e?.target?.value) || 1,\r\n                                })\r\n                              }\r\n                              placeholder=\"1\"\r\n                            />\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Service Location with enhanced radio buttons */}\r\n                        <div className=\"mb-4\">\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            Service Location\r\n                          </label>\r\n                          <ServiceTypeRadio\r\n                            selectedValue={item?.isOffSite}\r\n                            onChange={(value) => updateLineItem(index, { isOffSite: value })}\r\n                            itemIndex={index}\r\n                          />\r\n                        </div>\r\n\r\n                        {/* Vendor selection occurs at the deal level (above). */}\r\n\r\n                        {/* Scheduling with enhanced styling */}\r\n                        <div className=\"bg-white rounded-lg p-4 border\">\r\n                          <h5 className=\"font-medium text-gray-900 mb-3\">Scheduling</h5>\r\n\r\n                          <div className=\"mb-3\">\r\n                            <SchedulingRadio\r\n                              requiresScheduling={item?.requiresScheduling}\r\n                              onChange={(value) =>\r\n                                updateLineItem(index, { requiresScheduling: value })\r\n                              }\r\n                              itemIndex={index}\r\n                            />\r\n                          </div>\r\n\r\n                          {item?.requiresScheduling ? (\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                              <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                  Promised Date *\r\n                                </label>\r\n                                <Input\r\n                                  id={`promised-date-${index}`}\r\n                                  aria-label=\"Promised date input\"\r\n                                  label=\"\"\r\n                                  helperText=\"\"\r\n                                  maxLength={255}\r\n                                  style={{}}\r\n                                  type=\"date\"\r\n                                  value={item?.lineItemPromisedDate}\r\n                                  onChange={(e) =>\r\n                                    updateLineItem(index, {\r\n                                      lineItemPromisedDate: e?.target?.value,\r\n                                    })\r\n                                  }\r\n                                  min={new Date()?.toISOString()?.split('T')?.[0]}\r\n                                  placeholder=\"\"\r\n                                />\r\n                              </div>\r\n                              <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                  Notes\r\n                                </label>\r\n                                <Input\r\n                                  id={`notes-${index}`}\r\n                                  aria-label=\"Notes input\"\r\n                                  label=\"\"\r\n                                  helperText=\"\"\r\n                                  maxLength={500}\r\n                                  style={{}}\r\n                                  value={item?.description || ''}\r\n                                  onChange={(e) =>\r\n                                    updateLineItem(index, { description: e?.target?.value })\r\n                                  }\r\n                                  placeholder=\"Special instructions...\"\r\n                                />\r\n                              </div>\r\n                            </div>\r\n                          ) : (\r\n                            <div className=\"p-3 bg-gray-50 rounded-lg border border-gray-200\">\r\n                              <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                Reason for no schedule *\r\n                              </label>\r\n                              <Input\r\n                                id={`no-schedule-reason-${index}`}\r\n                                aria-label=\"No schedule reason input\"\r\n                                label=\"\"\r\n                                helperText=\"\"\r\n                                maxLength={255}\r\n                                style={{}}\r\n                                value={item?.noScheduleReason}\r\n                                onChange={(e) =>\r\n                                  updateLineItem(index, { noScheduleReason: e?.target?.value })\r\n                                }\r\n                                placeholder=\"e.g., installed at delivery, no appointment needed\"\r\n                              />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n\r\n                        {/* Line Total with NaN guard */}\r\n                        <div className=\"text-right mt-3 text-sm text-gray-600\">\r\n                          Line Total: $\r\n                          {(\r\n                            (parseFloat(item?.unit_price) || 0) *\r\n                            (parseInt(item?.quantity_used) || 1)\r\n                          )?.toFixed(2)}\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n\r\n                  {/* Deal Total with enhanced styling */}\r\n                  <div className=\"flex justify-end mt-4\">\r\n                    <div className=\"bg-green-50 border border-green-200 px-4 py-2 rounded-lg\">\r\n                      <span className=\"font-medium text-green-900\">\r\n                        Deal Total: ${calculateTotal()?.toFixed(2)}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Footer with mobile-friendly buttons */}\r\n        <div className=\"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3\">\r\n          <Button\r\n            className=\"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50\"\r\n            aria-label=\"Delete deal\"\r\n            variant=\"outline\"\r\n            onClick={() => setDeleteConfirm(true)}\r\n          >\r\n            <Icon name=\"Trash2\" size={16} className=\"mr-2\" />\r\n            Delete Deal\r\n          </Button>\r\n\r\n          <div className=\"flex space-x-3 w-full md:w-auto\">\r\n            <Button\r\n              className=\"w-full md:w-auto h-11\"\r\n              aria-label=\"Cancel editing\"\r\n              variant=\"outline\"\r\n              onClick={handleClose}\r\n            >\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              className=\"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700\"\r\n              aria-label=\"Save changes\"\r\n              onClick={handleSave}\r\n              disabled={saving}\r\n            >\r\n              {saving ? 'Saving...' : 'Save Changes'}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Delete Confirmation Modal */}\r\n        {deleteConfirm && (\r\n          <div className=\"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center\">\r\n            <div className=\"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl\">\r\n              <h3 className=\"text-lg font-semibold mb-4\">Delete Deal</h3>\r\n              <p className=\"text-gray-600 mb-6\">\r\n                Are you sure you want to delete this deal and all its line items? This action cannot\r\n                be undone.\r\n              </p>\r\n              <div className=\"flex space-x-3\">\r\n                <Button\r\n                  className=\"flex-1 h-11\"\r\n                  aria-label=\"Cancel deletion\"\r\n                  variant=\"outline\"\r\n                  onClick={() => setDeleteConfirm(false)}\r\n                >\r\n                  Cancel\r\n                </Button>\r\n                <Button\r\n                  className=\"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white\"\r\n                  aria-label=\"Confirm deletion\"\r\n                  onClick={handleDelete}\r\n                  disabled={deleting}\r\n                >\r\n                  {deleting ? 'Deleting...' : 'Delete'}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Unsaved Changes Warning Modal */}\r\n        {showUnsavedWarning && (\r\n          <div className=\"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10\">\r\n            <div className=\"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl\">\r\n              <h3 className=\"text-lg font-semibold mb-4 text-gray-900\">Unsaved Changes</h3>\r\n              <p className=\"text-gray-600 mb-6\">\r\n                You have unsaved changes. Are you sure you want to close and discard your changes?\r\n              </p>\r\n              <div className=\"flex space-x-3\">\r\n                <Button\r\n                  className=\"flex-1 h-11\"\r\n                  aria-label=\"Keep editing\"\r\n                  variant=\"outline\"\r\n                  onClick={() => setShowUnsavedWarning(false)}\r\n                >\r\n                  Keep Editing\r\n                </Button>\r\n                <Button\r\n                  className=\"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white\"\r\n                  aria-label=\"Discard changes\"\r\n                  onClick={confirmClose}\r\n                >\r\n                  Discard Changes\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default EditDealModal\r\n","// src/pages/deals/index.jsx\r\nimport React, { useEffect, useState } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { getAllDeals, markLoanerReturned } from '../../services/dealService'\r\nimport ExportButton from '../../components/common/ExportButton'\r\nimport NewDealModal from './NewDealModal'\r\nimport EditDealModal from './components/EditDealModal'\r\n\r\nimport { useDropdownData } from '../../hooks/useDropdownData'\r\nimport Navbar from '../../components/ui/Navbar'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuth } from '../../contexts/AuthContext'\r\nimport Button from '../../components/ui/Button'\r\nimport Icon from '../../components/ui/Icon'\r\n\r\n// ✅ UPDATED: StatusPill with enhanced styling\r\nconst StatusPill = ({ status }) => {\r\n  const statusColors = {\r\n    draft: 'bg-gray-100 text-gray-700',\r\n    pending: 'bg-blue-100 text-blue-700',\r\n    in_progress: 'bg-orange-100 text-orange-700',\r\n    completed: 'bg-green-100 text-green-700',\r\n    cancelled: 'bg-red-100 text-red-700',\r\n  }\r\n  const color = statusColors?.[status] || 'bg-gray-100 text-gray-700'\r\n  const displayStatus = status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'\r\n\r\n  return <span className={`px-2 py-1 rounded text-xs font-medium ${color}`}>{displayStatus}</span>\r\n}\r\n\r\n// ✅ ADDED: Helper to format names as \"Lastname, F.\"\r\nconst formatStaffName = (fullName) => {\r\n  if (!fullName) return ''\r\n  const parts = fullName?.trim()?.split(' ')\r\n  if (parts?.length < 2) return fullName\r\n\r\n  const firstName = parts?.[0]\r\n  const lastName = parts?.slice(1)?.join(' ')\r\n  const firstInitial = firstName?.[0]?.toUpperCase()\r\n\r\n  return `${lastName}, ${firstInitial}.`\r\n}\r\n\r\n// ✅ UPDATED: Enhanced \"Next\" promised chip with exact functionality per requirements\r\nconst NextPromisedChip = ({ nextPromisedShort }) => {\r\n  if (!nextPromisedShort) {\r\n    return <span className=\"text-xs text-gray-500\">—</span>\r\n  }\r\n\r\n  // Parse the date to determine urgency\r\n  const promiseDate = new Date(nextPromisedShort)\r\n  const today = new Date()\r\n  today?.setHours(0, 0, 0, 0)\r\n  promiseDate?.setHours(0, 0, 0, 0)\r\n\r\n  const todayPlus2 = new Date(today)\r\n  todayPlus2?.setDate(today?.getDate() + 2)\r\n\r\n  let urgencyClass = ''\r\n\r\n  // Compute urgency per requirements\r\n  if (promiseDate < today) {\r\n    // overdue: date < today\r\n    urgencyClass = 'bg-red-100 text-red-800 border-red-200'\r\n  } else if (promiseDate <= todayPlus2) {\r\n    // soon: today ≤ date ≤ today+2\r\n    urgencyClass = 'bg-amber-100 text-amber-800 border-amber-200'\r\n  } else {\r\n    // ok: otherwise\r\n    urgencyClass = 'bg-green-100 text-green-800 border-green-200'\r\n  }\r\n\r\n  return (\r\n    <span\r\n      className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${urgencyClass}`}\r\n    >\r\n      Next: {nextPromisedShort}\r\n    </span>\r\n  )\r\n}\r\n\r\n// ✅ UPDATED: Service Location Tag with exact colors per checklist (#22c55e in-house / #f97316 vendor)\r\nconst ServiceLocationTag = ({ serviceType, jobParts }) => {\r\n  // Check if any line items are off-site to determine vendor status\r\n  const hasOffSiteItems = jobParts?.some((part) => part?.is_off_site)\r\n  const hasOnSiteItems = jobParts?.some((part) => !part?.is_off_site)\r\n\r\n  if (hasOffSiteItems && hasOnSiteItems) {\r\n    return (\r\n      <div className=\"flex flex-col space-y-1\">\r\n        <span\r\n          className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white\"\r\n          style={{ backgroundColor: '#f97316' }}\r\n        >\r\n          🏢 Off-Site\r\n        </span>\r\n        <span\r\n          className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white\"\r\n          style={{ backgroundColor: '#22c55e' }}\r\n        >\r\n          🏠 In-House\r\n        </span>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (hasOffSiteItems) {\r\n    return (\r\n      <span\r\n        className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white\"\r\n        style={{ backgroundColor: '#f97316' }}\r\n      >\r\n        🏢 Off-Site\r\n      </span>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <span\r\n      className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white\"\r\n      style={{ backgroundColor: '#22c55e' }}\r\n    >\r\n      🏠 In-House\r\n    </span>\r\n  )\r\n}\r\n\r\n// ✅ UPDATED: Enhanced draft reminder with improved styling\r\nconst DraftReminderBanner = ({ draftsCount, onViewDrafts }) => {\r\n  const [dismissed, setDismissed] = useState(false)\r\n\r\n  if (draftsCount === 0 || dismissed) return null\r\n\r\n  return (\r\n    <div\r\n      className=\"mb-6 p-4 rounded-lg border\"\r\n      style={{ backgroundColor: '#FEF3C7', borderColor: '#F3E8A3', color: '#92400E' }}\r\n    >\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center space-x-3\">\r\n          <div className=\"flex-shrink-0\">\r\n            <Icon name=\"AlertCircle\" size={20} style={{ color: '#D97706' }} />\r\n          </div>\r\n          <div>\r\n            <p className=\"font-medium\">Draft – needs details</p>\r\n            <p className=\"text-sm\">\r\n              You have {draftsCount} draft deal{draftsCount > 1 ? 's' : ''} to complete.\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <Button\r\n            size=\"sm\"\r\n            variant=\"ghost\"\r\n            onClick={onViewDrafts}\r\n            style={{ color: '#92400E' }}\r\n            className=\"hover:bg-yellow-100\"\r\n            aria-label=\"View draft deals\"\r\n          >\r\n            View drafts\r\n          </Button>\r\n          <button onClick={() => setDismissed(true)} className=\"p-1\" style={{ color: '#F59E0B' }}>\r\n            <Icon name=\"X\" size={16} />\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Safe display helpers to replace deprecated deal.title usage\r\nconst getDealPrimaryRef = (deal) => {\r\n  if (!deal) return '—'\r\n  if (deal?.job_number) return deal.job_number\r\n  if (deal?.id) return `Job-${String(deal.id).slice(0, 8)}`\r\n  return '—'\r\n}\r\n\r\nconst getDealSubtitle = (deal) => {\r\n  if (!deal) return ''\r\n  return deal?.customer_name || ''\r\n}\r\n\r\n// ✅ UPDATED: Mobile-friendly customer display with enhanced tap-to-call and SMS\r\nconst CustomerDisplay = ({ deal }) => {\r\n  if (!deal?.customer_name && !deal?.customer_phone) {\r\n    return <span className=\"text-xs text-gray-500\">—</span>\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-1\">\r\n      {deal?.customer_name && (\r\n        <div className=\"font-medium text-sm text-slate-900\">{deal?.customer_name}</div>\r\n      )}\r\n      {deal?.customer_phone && (\r\n        <a\r\n          href={`tel:${deal?.customer_phone}`}\r\n          className=\"text-xs text-slate-500 hover:text-blue-600 underline\"\r\n          onClick={(e) => e?.stopPropagation()}\r\n        >\r\n          {deal?.customer_phone}\r\n        </a>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n// ✅ UPDATED: Value display with currency formatting\r\nconst ValueDisplay = ({ amount }) => {\r\n  const value = parseFloat(amount) || 0\r\n  return (\r\n    <div className=\"text-right\">\r\n      <span className=\"text-sm font-medium text-slate-900\">\r\n        {new Intl.NumberFormat('en-US', {\r\n          style: 'currency',\r\n          currency: 'USD',\r\n        })?.format(value)}\r\n      </span>\r\n    </div>\r\n  )\r\n}\r\n\r\n// ✅ ADDED: Enhanced Loaner Badge component for tracker rows\r\nconst LoanerBadge = ({ deal }) => {\r\n  if (!deal?.loaner_number) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <span className=\"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200\">\r\n      🚗 Loaner #{deal?.loaner_number}\r\n      {deal?.loaner_eta_short && <span className=\"ml-1\">• due {deal?.loaner_eta_short}</span>}\r\n    </span>\r\n  )\r\n}\r\n\r\n// ✅ FIXED: Loaner Drawer Component with enhanced mobile functionality\r\nconst LoanerDrawer = ({ isOpen, onClose, deal, onSave, loading }) => {\r\n  const [loanerForm, setLoanerForm] = useState({\r\n    loaner_number: '',\r\n    eta_return_date: '',\r\n    notes: '',\r\n  })\r\n  const [error, setError] = useState('')\r\n\r\n  // Reset form when drawer opens/closes\r\n  useEffect(() => {\r\n    if (isOpen && deal) {\r\n      // Compute default ETA as the latest scheduled promised_date if none exists yet\r\n      let defaultEta = ''\r\n      try {\r\n        const dates = (deal?.job_parts || [])\r\n          .filter((p) => p?.requires_scheduling && p?.promised_date)\r\n          .map((p) => new Date(p.promised_date))\r\n        if (dates?.length > 0) {\r\n          const latest = new Date(Math.max.apply(null, dates))\r\n          // format YYYY-MM-DD for date input\r\n          defaultEta = latest.toISOString().split('T')[0]\r\n        }\r\n      } catch (_) {}\r\n\r\n      // Pre-populate if loaner exists; otherwise use computed default for ETA\r\n      setLoanerForm({\r\n        loaner_number: deal?.loaner_number || '',\r\n        eta_return_date: deal?.loaner_eta_return_date || defaultEta || '',\r\n        notes: deal?.loaner_notes || '',\r\n      })\r\n      setError('')\r\n    } else if (!isOpen) {\r\n      setLoanerForm({ loaner_number: '', eta_return_date: '', notes: '' })\r\n      setError('')\r\n    }\r\n  }, [isOpen, deal])\r\n\r\n  const handleSave = async () => {\r\n    setError('')\r\n\r\n    if (!loanerForm?.loaner_number?.trim()) {\r\n      setError('Loaner number is required')\r\n      return\r\n    }\r\n\r\n    if (!loanerForm?.eta_return_date) {\r\n      setError('ETA return date is required')\r\n      return\r\n    }\r\n\r\n    try {\r\n      await onSave({\r\n        job_id: deal?.id,\r\n        loaner_number: loanerForm?.loaner_number?.trim(),\r\n        eta_return_date: loanerForm?.eta_return_date,\r\n        notes: loanerForm?.notes?.trim() || null,\r\n      })\r\n      onClose() // Close drawer on successful save\r\n    } catch (err) {\r\n      setError(err?.message || 'Failed to save loaner assignment')\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 z-50\" onClick={onClose} />\r\n\r\n      {/* Drawer - Mobile-first light theme only */}\r\n      <div className=\"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto\">\r\n        <div className=\"p-6\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h3 className=\"text-lg font-semibold text-slate-900\">Loaner Assignment</h3>\r\n            <Button variant=\"ghost\" size=\"icon\" onClick={onClose} aria-label=\"Close drawer\">\r\n              <Icon name=\"X\" size={20} />\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Deal Info */}\r\n          <div className=\"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n            <h4 className=\"font-medium text-sm text-slate-900 mb-2\">Deal Information</h4>\r\n            <p className=\"text-sm text-slate-600\">{getDealPrimaryRef(deal)}</p>\r\n            <p className=\"text-xs text-slate-500\">{getDealSubtitle(deal)}</p>\r\n          </div>\r\n\r\n          {/* Error Display */}\r\n          {error && (\r\n            <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg\">\r\n              <p className=\"text-sm text-red-700\">{error}</p>\r\n              <button\r\n                onClick={() => setError('')}\r\n                className=\"text-xs text-red-500 hover:text-red-700 mt-1 underline\"\r\n              >\r\n                Dismiss\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* Form with light theme inputs */}\r\n          <div className=\"space-y-4\">\r\n            {/* Loaner Number */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Loaner Number *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={loanerForm?.loaner_number}\r\n                onChange={(e) =>\r\n                  setLoanerForm((prev) => ({ ...prev, loaner_number: e?.target?.value }))\r\n                }\r\n                className=\"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                placeholder=\"e.g., 123\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* ETA Return Date */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Expected Return Date *\r\n              </label>\r\n              <input\r\n                type=\"date\"\r\n                value={loanerForm?.eta_return_date}\r\n                onChange={(e) =>\r\n                  setLoanerForm((prev) => ({ ...prev, eta_return_date: e?.target?.value }))\r\n                }\r\n                className=\"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                min={new Date()?.toISOString()?.split('T')?.[0]}\r\n                required\r\n              />\r\n            </div>\r\n\r\n            {/* Notes */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Notes (optional)\r\n              </label>\r\n              <textarea\r\n                value={loanerForm?.notes}\r\n                onChange={(e) => setLoanerForm((prev) => ({ ...prev, notes: e?.target?.value }))}\r\n                className=\"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                rows={3}\r\n                placeholder=\"Optional notes about the loaner vehicle...\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Actions */}\r\n          <div className=\"flex gap-3 mt-6\">\r\n            <Button variant=\"outline\" onClick={onClose} className=\"flex-1 h-11\" disabled={loading}>\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              onClick={handleSave}\r\n              className=\"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white\"\r\n              disabled={\r\n                loading || !loanerForm?.loaner_number?.trim() || !loanerForm?.eta_return_date\r\n              }\r\n            >\r\n              {loading ? 'Saving...' : 'Save Loaner'}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\n// ✅ ADDED: Mark Returned Modal Component\r\nconst MarkReturnedModal = ({ loaner, onClose, onConfirm, loading }) => {\r\n  if (!loaner) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-lg w-full max-w-md\">\r\n        <div className=\"p-6\">\r\n          <h3 className=\"text-lg font-semibold mb-4 text-slate-900\">Mark Loaner Returned</h3>\r\n          <p className=\"text-slate-600 mb-6\">\r\n            Mark loaner <strong>#{loaner?.loaner_number}</strong> as returned?\r\n          </p>\r\n          <div className=\"flex gap-3\">\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={onClose}\r\n              className=\"flex-1 h-11\"\r\n              disabled={loading}\r\n              aria-label=\"Cancel marking loaner as returned\"\r\n            >\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              onClick={onConfirm}\r\n              className=\"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white\"\r\n              disabled={loading}\r\n              aria-label=\"Confirm loaner returned\"\r\n            >\r\n              {loading ? 'Processing...' : 'Mark Returned'}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default function DealsPage() {\r\n  const [deals, setDeals] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [showNewDealModal, setShowNewDealModal] = useState(false)\r\n  const [showEditDealModal, setShowEditDealModal] = useState(false)\r\n  const [editingDealId, setEditingDealId] = useState(null)\r\n  const [editingDeal, setEditingDeal] = useState(null)\r\n  const [deleteConfirm, setDeleteConfirm] = useState(null)\r\n\r\n  // ✅ FIXED: Added missing error state management\r\n  const [error, setError] = useState('')\r\n\r\n  // ✅ UPDATED: Status tabs & quick search with enhanced filtering\r\n  const [filters, setFilters] = useState({\r\n    status: 'All',\r\n    salesAssigned: null,\r\n    deliveryAssigned: null,\r\n    financeAssigned: null,\r\n    vendor: null,\r\n    search: '',\r\n  })\r\n\r\n  // ✅ ADDED: Loaner management state\r\n  const [showLoanerDrawer, setShowLoanerDrawer] = useState(false)\r\n  const [selectedDealForLoaner, setSelectedDealForLoaner] = useState(null)\r\n  const [loanerLoading, setLoanerLoading] = useState(false)\r\n  const [markReturnedModal, setMarkReturnedModal] = useState(null)\r\n  const [returningLoaner, setReturningLoaner] = useState(false)\r\n  const [searchDebounce, setSearchDebounce] = useState('')\r\n\r\n  // ✅ FIXED: Properly use the dropdown hook instead of direct function calls\r\n  const {\r\n    getUserOptions,\r\n    getVendorOptions,\r\n    clearSearch,\r\n    loading: dropdownLoading,\r\n    error: dropdownError,\r\n    refresh: refreshDropdowns,\r\n  } = useDropdownData({ loadOnMount: true })\r\n\r\n  const navigate = useNavigate()\r\n  const { user } = useAuth()\r\n\r\n  // ✅ FIXED: Replace direct function calls with hook-based calls\r\n  const getSalesConsultants = () => {\r\n    try {\r\n      return (\r\n        getUserOptions({\r\n          roles: ['staff'],\r\n          departments: ['Sales Consultants'],\r\n          activeOnly: true,\r\n        }) || []\r\n      )\r\n    } catch (err) {\r\n      console.error('Error getting sales consultants:', err)\r\n      return []\r\n    }\r\n  }\r\n\r\n  const getDeliveryCoordinators = () => {\r\n    try {\r\n      return (\r\n        getUserOptions({\r\n          roles: ['admin', 'manager'],\r\n          departments: ['Delivery Coordinator'],\r\n          activeOnly: true,\r\n        }) || []\r\n      )\r\n    } catch (err) {\r\n      console.error('Error getting delivery coordinators:', err)\r\n      return []\r\n    }\r\n  }\r\n\r\n  const getFinanceManagers = () => {\r\n    try {\r\n      return (\r\n        getUserOptions({\r\n          roles: ['staff'],\r\n          departments: ['Finance Manager'],\r\n          activeOnly: true,\r\n        }) || []\r\n      )\r\n    } catch (err) {\r\n      console.error('Error getting finance managers:', err)\r\n      return []\r\n    }\r\n  }\r\n\r\n  const getSafeVendorOptions = (filterOptions = {}) => {\r\n    try {\r\n      return getVendorOptions(filterOptions) || []\r\n    } catch (err) {\r\n      console.error('Error getting vendor options:', err)\r\n      return []\r\n    }\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced delete function with proper error handling\r\n  const handleDeleteDeal = async (dealId) => {\r\n    try {\r\n      setError('') // Clear previous errors\r\n      const { error: deleteError } = await supabase?.rpc('delete_job_cascade', { p_job_id: dealId })\r\n      if (deleteError) throw deleteError\r\n\r\n      setDeleteConfirm(null)\r\n      await loadDeals()\r\n    } catch (e) {\r\n      setError(`Failed to delete deal: ${e?.message}`)\r\n      console.error('Delete error:', e)\r\n    }\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced loaner assignment with better error handling and modal state management\r\n  const handleSaveLoaner = async (loanerData) => {\r\n    try {\r\n      setLoanerLoading(true)\r\n      setError('') // Clear previous errors\r\n\r\n      // Insert or update loaner assignment without relying on ON CONFLICT\r\n      let existing = null\r\n      try {\r\n        const { data: rows } = await supabase\r\n          ?.from('loaner_assignments')\r\n          ?.select('id')\r\n          ?.eq('job_id', loanerData?.job_id)\r\n          ?.is('returned_at', null)\r\n          ?.limit(1)\r\n        existing = Array.isArray(rows) ? rows[0] : rows\r\n      } catch (_) {}\r\n\r\n      if (existing?.id) {\r\n        const { error: updErr } = await supabase\r\n          ?.from('loaner_assignments')\r\n          ?.update({\r\n            loaner_number: loanerData?.loaner_number,\r\n            eta_return_date: loanerData?.eta_return_date,\r\n            notes: loanerData?.notes,\r\n          })\r\n          ?.eq('id', existing.id)\r\n        if (updErr) throw updErr\r\n      } else {\r\n        const { error: insErr } = await supabase?.from('loaner_assignments')?.insert([\r\n          {\r\n            job_id: loanerData?.job_id,\r\n            loaner_number: loanerData?.loaner_number,\r\n            eta_return_date: loanerData?.eta_return_date,\r\n            notes: loanerData?.notes,\r\n          },\r\n        ])\r\n        if (insErr) throw insErr\r\n      }\r\n\r\n      // ✅ FIXED: Properly close drawer and reset state\r\n      setShowLoanerDrawer(false)\r\n      setSelectedDealForLoaner(null)\r\n      await loadDeals() // Refresh data\r\n    } catch (e) {\r\n      const errorMessage = `Failed to save loaner assignment: ${e?.message}`\r\n      setError(errorMessage)\r\n      throw new Error(errorMessage)\r\n    } finally {\r\n      setLoanerLoading(false)\r\n    }\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced mark returned with better error handling\r\n  const handleMarkLoanerReturned = async (loanerData) => {\r\n    try {\r\n      setReturningLoaner(true)\r\n      setError('') // Clear previous errors\r\n      await markLoanerReturned(loanerData?.loaner_id)\r\n      setMarkReturnedModal(null)\r\n      await loadDeals() // Refresh data\r\n    } catch (e) {\r\n      setError(`Failed to mark loaner as returned: ${e?.message}`)\r\n      console.error('Mark returned error:', e)\r\n    } finally {\r\n      setReturningLoaner(false)\r\n    }\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced load deals with better error handling and retry logic\r\n  const loadDeals = async (retryCount = 0) => {\r\n    try {\r\n      setLoading(true)\r\n      setError('') // Clear previous errors\r\n      const data = await getAllDeals()\r\n      setDeals(data || [])\r\n    } catch (e) {\r\n      const errorMessage = `Failed to load deals: ${e?.message}`\r\n      console.error('Load deals error:', e)\r\n\r\n      // Retry logic for network issues\r\n      if (retryCount < 2 && (e?.message?.includes('fetch') || e?.message?.includes('network'))) {\r\n        console.log(`Retrying load deals (attempt ${retryCount + 1})`)\r\n        setTimeout(() => loadDeals(retryCount + 1), 1000 * (retryCount + 1))\r\n        return\r\n      }\r\n\r\n      setError(errorMessage)\r\n      setDeals([]) // Set empty array on error\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // ✅ ADDED: Initialize status from URL parameter on mount\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search)\r\n    const statusParam = urlParams?.get('status')\r\n    if (statusParam) {\r\n      const statusValue = statusParam?.charAt(0)?.toUpperCase() + statusParam?.slice(1)\r\n      setFilters((prev) => ({ ...prev, status: statusValue }))\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    loadDeals()\r\n  }, [])\r\n\r\n  // ✅ FIXED: Properly use the dropdown hook instead of direct function calls\r\n  const loadDropdownData = async () => {\r\n    await refreshDropdowns()\r\n  }\r\n\r\n  // ✅ FIXED: Move handleManageLoaner function to proper location inside component\r\n  const handleManageLoaner = (deal) => {\r\n    setSelectedDealForLoaner(deal)\r\n    setShowLoanerDrawer(true)\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced error display component\r\n  const ErrorAlert = ({ message, onClose }) => {\r\n    if (!message) return null\r\n\r\n    return (\r\n      <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n        <div className=\"flex justify-between items-start\">\r\n          <div className=\"flex\">\r\n            <Icon name=\"AlertCircle\" size={20} className=\"text-red-500 mr-2 mt-0.5\" />\r\n            <div>\r\n              <h4 className=\"text-sm font-medium text-red-800\">Error</h4>\r\n              <p className=\"text-sm text-red-700 mt-1\">{message}</p>\r\n            </div>\r\n          </div>\r\n          {onClose && (\r\n            <button\r\n              onClick={onClose}\r\n              className=\"text-red-400 hover:text-red-600\"\r\n              aria-label=\"Dismiss error\"\r\n            >\r\n              <Icon name=\"X\" size={16} />\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // ✅ UPDATED: Calculate KPIs with proper safety checks\r\n  const calculateKPIs = (dealsData) => {\r\n    const safeDeals = dealsData || []\r\n\r\n    const activeJobs = safeDeals?.filter((d) => d?.job_status === 'in_progress')?.length || 0\r\n\r\n    const totalRevenue = safeDeals?.reduce((sum, deal) => {\r\n      const revenue = parseFloat(deal?.total_amount) || 0\r\n      return sum + revenue\r\n    }, 0)\r\n\r\n    // Estimate 25% profit margin\r\n    const totalProfit = totalRevenue * 0.25\r\n    const margin = totalRevenue > 0 ? 25.0 : 0\r\n\r\n    const pendingJobs = safeDeals?.filter((d) => d?.job_status === 'pending')?.length || 0\r\n\r\n    const totalDrafts = safeDeals?.filter((d) => d?.job_status === 'draft')?.length || 0\r\n\r\n    return {\r\n      active: activeJobs,\r\n      revenue: totalRevenue?.toFixed(2) || '0.00',\r\n      profit: totalProfit?.toFixed(2) || '0.00',\r\n      margin: margin?.toFixed(1) || '0.0',\r\n      pending: pendingJobs,\r\n      drafts: totalDrafts,\r\n    }\r\n  }\r\n\r\n  const kpis = calculateKPIs(deals)\r\n\r\n  // ✅ UPDATED: Enhanced filter deals with 300ms debounced search\r\n  const filteredDeals = deals?.filter((deal) => {\r\n    // Status filter with tab-based logic\r\n    if (filters?.status !== 'All') {\r\n      const targetStatus = filters?.status?.toLowerCase()?.replace(' ', '_')\r\n      if (deal?.job_status !== targetStatus) {\r\n        return false\r\n      }\r\n    }\r\n\r\n    // Sales assigned filter\r\n    if (filters?.salesAssigned && deal?.assigned_to !== filters?.salesAssigned) {\r\n      return false\r\n    }\r\n\r\n    // Delivery assigned filter\r\n    if (filters?.deliveryAssigned && deal?.delivery_coordinator_id !== filters?.deliveryAssigned) {\r\n      return false\r\n    }\r\n\r\n    // Finance assigned filter\r\n    if (filters?.financeAssigned && deal?.finance_manager_id !== filters?.financeAssigned) {\r\n      return false\r\n    }\r\n\r\n    // Vendor filter\r\n    if (filters?.vendor && deal?.vendor_id !== filters?.vendor) {\r\n      return false\r\n    }\r\n\r\n    // ✅ UPDATED: Search filter with debounced search (matches stock, name, phone with stripped non-digits)\r\n    if (searchDebounce?.trim()) {\r\n      const searchTerm = searchDebounce?.toLowerCase()\r\n\r\n      // Strip non-digits for phone matching\r\n      const stripNonDigits = (str) => str?.replace(/\\D/g, '') || ''\r\n      const searchDigits = stripNonDigits(searchTerm)\r\n\r\n      const searchableFields = [\r\n        deal?.customer_name,\r\n        deal?.customer_phone,\r\n        deal?.customer_email,\r\n        deal?.job_number,\r\n        deal?.vehicle?.make,\r\n        deal?.vehicle?.model,\r\n        deal?.vehicle?.stock_number || deal?.stock_no,\r\n        deal?.description,\r\n      ]?.filter(Boolean)\r\n\r\n      const hasMatch = searchableFields?.some((field) => {\r\n        const fieldStr = field?.toLowerCase()\r\n        // Standard text match\r\n        if (fieldStr?.includes(searchTerm)) return true\r\n        // Phone number digit match\r\n        if (searchDigits?.length >= 3 && stripNonDigits(fieldStr)?.includes(searchDigits))\r\n          return true\r\n        return false\r\n      })\r\n\r\n      if (!hasMatch) return false\r\n    }\r\n\r\n    return true\r\n  })\r\n\r\n  // ✅ ADDED: 300ms debounced search implementation\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      setSearchDebounce(filters?.search)\r\n    }, 300)\r\n\r\n    return () => clearTimeout(timer)\r\n  }, [filters?.search])\r\n\r\n  // ✅ UPDATED: Update filter function with URL parameter support\r\n  const updateFilter = (key, value) => {\r\n    setFilters((prev) => ({\r\n      ...prev,\r\n      [key]: value,\r\n    }))\r\n\r\n    // Update URL for status filter\r\n    if (key === 'status') {\r\n      const searchParams = new URLSearchParams(window.location.search)\r\n      if (value === 'All') {\r\n        searchParams?.delete('status')\r\n      } else {\r\n        searchParams?.set('status', value?.toLowerCase())\r\n      }\r\n      const newUrl = `${window.location?.pathname}${searchParams?.toString() ? '?' + searchParams?.toString() : ''}`\r\n      window.history?.replaceState({}, '', newUrl)\r\n    }\r\n  }\r\n\r\n  // Clear all filters\r\n  const clearAllFilters = () => {\r\n    setFilters({\r\n      status: 'All',\r\n      salesAssigned: null,\r\n      deliveryAssigned: null,\r\n      financeAssigned: null,\r\n      vendor: null,\r\n      search: '',\r\n    })\r\n    clearSearch()\r\n\r\n    // Clear URL params\r\n    window.history?.replaceState({}, '', window.location?.pathname)\r\n  }\r\n\r\n  const handleEditDeal = (dealId) => {\r\n    setEditingDealId(dealId)\r\n    // Preload full deal object from current list for instant modal render\r\n    try {\r\n      const found = (filteredDeals?.length ? filteredDeals : deals)?.find((d) => d?.id === dealId)\r\n      if (found) setEditingDeal(found)\r\n      else setEditingDeal(null)\r\n    } catch (_) {\r\n      setEditingDeal(null)\r\n    }\r\n    setShowEditDealModal(true)\r\n  }\r\n\r\n  const closeEditModal = () => {\r\n    setShowEditDealModal(false)\r\n    setEditingDealId(null)\r\n    setEditingDeal(null)\r\n  }\r\n\r\n  // ✅ FIXED: Enhanced loading state without dropdown dependency\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 text-slate-900\">\r\n        <Navbar />\r\n        <div className=\"p-4 md:p-8\" style={{ paddingTop: '5rem' }}>\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <div className=\"text-center\">\r\n              <div className=\"text-slate-600\">Loading deals...</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50 text-slate-900\">\r\n      {/* ✅ FIXED: Ensure navbar is always visible */}\r\n      <Navbar />\r\n      <div className=\"p-4 md:p-8 max-w-7xl mx-auto\" style={{ paddingTop: '5rem' }}>\r\n        {/* ✅ FIXED: Error display */}\r\n        <ErrorAlert\r\n          message={error || dropdownError}\r\n          onClose={() => {\r\n            setError('')\r\n          }}\r\n        />\r\n\r\n        {/* Header */}\r\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4\">\r\n          <h1 className=\"text-2xl md:text-3xl font-bold text-slate-900\">Deal Tracker</h1>\r\n          <div className=\"flex items-center space-x-3\">\r\n            <ExportButton\r\n              exportType=\"jobs\"\r\n              filters={{ status: filters?.status }}\r\n              onExportStart={() => console.log('Starting export...')}\r\n              onExportComplete={(recordCount, filename) =>\r\n                console.log(`Export complete: ${recordCount} records`)\r\n              }\r\n              onExportError={(errorMessage) => setError(`Export failed: ${errorMessage}`)}\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              className=\"bg-white hover:bg-gray-50\"\r\n            />\r\n            <Button\r\n              onClick={() => setShowNewDealModal(true)}\r\n              className=\"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11\"\r\n              aria-label=\"Create new deal\"\r\n            >\r\n              <Icon name=\"Plus\" size={16} className=\"mr-2\" />\r\n              New Deal\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* ✅ UPDATED: Draft reminder banner */}\r\n        <DraftReminderBanner\r\n          draftsCount={kpis?.drafts}\r\n          onViewDrafts={() => updateFilter('status', 'Draft')}\r\n        />\r\n\r\n        {/* ✅ UPDATED: KPI Row - Enhanced with profit analysis */}\r\n        <div className=\"mb-6\">\r\n          <div className=\"grid grid-cols-2 md:grid-cols-6 gap-4\">\r\n            {/* Active Jobs */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-orange-100 mr-4\">\r\n                  <Icon name=\"Clock\" size={24} className=\"text-orange-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Active\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">{kpis?.active}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Revenue */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-green-100 mr-4\">\r\n                  <Icon name=\"DollarSign\" size={24} className=\"text-green-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Revenue\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">${kpis?.revenue}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Profit */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-blue-100 mr-4\">\r\n                  <Icon name=\"TrendingUp\" size={24} className=\"text-blue-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Profit\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">${kpis?.profit}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Margin */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-purple-100 mr-4\">\r\n                  <Icon name=\"Percent\" size={24} className=\"text-purple-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Margin\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">{kpis?.margin}%</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Pending */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-yellow-100 mr-4\">\r\n                  <Icon name=\"Clock\" size={24} className=\"text-yellow-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Pending\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">{kpis?.pending}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Drafts */}\r\n            <div className=\"bg-white p-6 rounded-xl border shadow-sm\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"p-3 rounded-lg bg-gray-100 mr-4\">\r\n                  <Icon name=\"File\" size={24} className=\"text-gray-700\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-slate-600 text-sm font-medium uppercase tracking-wide\">\r\n                    Drafts\r\n                  </h3>\r\n                  <p className=\"text-slate-900 text-2xl font-bold\">{kpis?.drafts}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* ✅ FIXED: Status tabs & enhanced dropdown filters */}\r\n        <div className=\"mb-6 bg-white rounded-lg border p-4\">\r\n          {/* Status Tabs */}\r\n          <div className=\"flex flex-wrap gap-2 mb-4\">\r\n            {['All', 'Draft', 'Pending', 'Active', 'Completed']?.map((status) => (\r\n              <button\r\n                key={status}\r\n                onClick={() => updateFilter('status', status)}\r\n                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors\r\n                  ${\r\n                    filters?.status === status\r\n                      ? 'bg-blue-600 text-white'\r\n                      : 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50'\r\n                  }`}\r\n              >\r\n                {status}\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"flex flex-col lg:flex-row gap-4\">\r\n            {/* ✅ UPDATED: Search box with 300ms debounce, matches stock, name, phone (strip non-digits) */}\r\n            <div className=\"flex-1\">\r\n              <div className=\"relative\">\r\n                <Icon\r\n                  name=\"Search\"\r\n                  size={16}\r\n                  className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400\"\r\n                />\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Search deals, customers, vehicles...\"\r\n                  value={filters?.search}\r\n                  onChange={(e) => updateFilter('search', e?.target?.value)}\r\n                  className=\"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Clear Filters */}\r\n            <div className=\"flex items-center\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={clearAllFilters}\r\n                className=\"text-slate-600 hover:text-slate-800\"\r\n                aria-label=\"Clear all filters\"\r\n              >\r\n                <Icon name=\"X\" size={16} className=\"mr-1\" />\r\n                Clear\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Results count */}\r\n        <div className=\"mb-4 text-sm text-slate-600\">\r\n          Showing {filteredDeals?.length} of {deals?.length} deals\r\n          {(filters?.salesAssigned ||\r\n            filters?.deliveryAssigned ||\r\n            filters?.financeAssigned ||\r\n            filters?.vendor ||\r\n            filters?.search) && <span className=\"ml-2 text-blue-600\">(filtered)</span>}\r\n        </div>\r\n\r\n        {/* ✅ UPDATED: Desktop Table with exact columns per requirements */}\r\n        <div className=\"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm\">\r\n          <table className=\"min-w-full\">\r\n            <thead className=\"bg-slate-50\">\r\n              <tr>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider\">\r\n                  Customer\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider\">\r\n                  Value\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider\">\r\n                  Next\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider\">\r\n                  Service\r\n                </th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider\">\r\n                  Actions\r\n                </th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"bg-white divide-y divide-slate-200\">\r\n              {filteredDeals?.map((deal) => (\r\n                <tr key={deal?.id} className=\"hover:bg-slate-50\">\r\n                  <td className=\"px-6 py-4\">\r\n                    <CustomerDisplay deal={deal} />\r\n                  </td>\r\n                  <td className=\"px-6 py-4\">\r\n                    <ValueDisplay amount={deal?.total_amount} />\r\n                  </td>\r\n                  <td className=\"px-6 py-4\">\r\n                    <NextPromisedChip nextPromisedShort={deal?.next_promised_short} />\r\n                  </td>\r\n                  <td className=\"px-6 py-4\">\r\n                    <ServiceLocationTag\r\n                      serviceType={deal?.service_type}\r\n                      jobParts={deal?.job_parts}\r\n                    />\r\n                  </td>\r\n                  <td className=\"px-6 py-4 text-right\">\r\n                    <div className=\"flex items-center justify-end space-x-2\">\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        onClick={() => handleEditDeal(deal?.id)}\r\n                        className=\"text-blue-600 hover:text-blue-800\"\r\n                        aria-label=\"Edit deal\"\r\n                      >\r\n                        Edit\r\n                      </Button>\r\n\r\n                      {/* ✅ FIXED: Loaner management for desktop with proper condition */}\r\n                      {deal?.customer_needs_loaner && (\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"ghost\"\r\n                          onClick={() => handleManageLoaner(deal)}\r\n                          className=\"text-purple-600 hover:text-purple-800\"\r\n                          aria-label=\"Manage loaner\"\r\n                        >\r\n                          Loaner\r\n                        </Button>\r\n                      )}\r\n\r\n                      {/* Mark returned button for active loaners */}\r\n                      {deal?.loaner_id && (\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"ghost\"\r\n                          onClick={() =>\r\n                            setMarkReturnedModal({\r\n                              loaner_id: deal?.loaner_id,\r\n                              loaner_number: deal?.loaner_number,\r\n                              job_title: getDealPrimaryRef(deal),\r\n                            })\r\n                          }\r\n                          className=\"text-green-600 hover:text-green-800\"\r\n                          aria-label=\"Mark loaner returned\"\r\n                        >\r\n                          Return\r\n                        </Button>\r\n                      )}\r\n\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        onClick={() => setDeleteConfirm(deal)}\r\n                        className=\"text-red-600 hover:text-red-800\"\r\n                        aria-label=\"Delete deal\"\r\n                      >\r\n                        Delete\r\n                      </Button>\r\n                    </div>\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        {/* ✅ UPDATED: Mobile Cards with enhanced styling and loaner support */}\r\n        <div className=\"md:hidden space-y-4\">\r\n          {filteredDeals?.length === 0 ? (\r\n            <div className=\"bg-white rounded-lg border p-8 text-center\">\r\n              <div className=\"text-slate-500\">\r\n                {filters?.status === 'All'\r\n                  ? 'No deals found'\r\n                  : `No ${filters?.status?.toLowerCase()} deals found`}\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            filteredDeals?.map((deal) => (\r\n              <div key={deal?.id} className=\"bg-white rounded-xl border shadow-sm overflow-hidden\">\r\n                {/* Card Header */}\r\n                <div className=\"p-4 border-b bg-slate-50\">\r\n                  <div className=\"flex justify-between items-start mb-2\">\r\n                    <div>\r\n                      <div className=\"font-medium text-slate-900\">{getDealPrimaryRef(deal)}</div>\r\n                      <div className=\"text-sm text-slate-600\">{getDealSubtitle(deal) || '—'}</div>\r\n                    </div>\r\n                    <StatusPill status={deal?.job_status} />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Card Content with enhanced mobile layout */}\r\n                <div className=\"p-4 space-y-4\">\r\n                  {/* Customer Display */}\r\n                  {(deal?.customer_name || deal?.customer_phone) && (\r\n                    <div>\r\n                      <div className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">\r\n                        Customer\r\n                      </div>\r\n                      <CustomerDisplay deal={deal} />\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <div className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">\r\n                        Value\r\n                      </div>\r\n                      <ValueDisplay amount={deal?.total_amount} />\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">\r\n                        Next\r\n                      </div>\r\n                      <NextPromisedChip nextPromisedShort={deal?.next_promised_short} />\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <div className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">\r\n                      Service\r\n                    </div>\r\n                    <ServiceLocationTag\r\n                      serviceType={deal?.service_type}\r\n                      jobParts={deal?.job_parts}\r\n                    />\r\n                  </div>\r\n\r\n                  {/* ✅ ADDED: Loaner badge display for mobile */}\r\n                  {deal?.loaner_number && (\r\n                    <div>\r\n                      <div className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">\r\n                        Loaner Assignment\r\n                      </div>\r\n                      <LoanerBadge deal={deal} />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* ✅ FIXED: Enhanced mobile footer with proper loaner actions */}\r\n                <div className=\"p-4 border-t bg-slate-50\">\r\n                  {/* Primary actions row */}\r\n                  <div className=\"grid grid-cols-2 gap-2 mb-2\">\r\n                    <Button\r\n                      size=\"sm\"\r\n                      variant=\"outline\"\r\n                      onClick={() => handleEditDeal(deal?.id)}\r\n                      className=\"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100\"\r\n                      aria-label=\"Edit deal\"\r\n                    >\r\n                      <Icon name=\"Edit\" size={16} className=\"mr-2\" />\r\n                      Edit\r\n                    </Button>\r\n\r\n                    <Button\r\n                      size=\"sm\"\r\n                      variant=\"outline\"\r\n                      onClick={() => setDeleteConfirm(deal)}\r\n                      className=\"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100\"\r\n                      aria-label=\"Delete deal\"\r\n                    >\r\n                      <Icon name=\"Trash2\" size={16} className=\"mr-2\" />\r\n                      Delete\r\n                    </Button>\r\n                  </div>\r\n\r\n                  {/* ✅ FIXED: Loaner actions row with proper conditions */}\r\n                  {(deal?.customer_needs_loaner || deal?.loaner_id) && (\r\n                    <div className=\"grid grid-cols-2 gap-2\">\r\n                      {deal?.customer_needs_loaner && !deal?.loaner_id && (\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"outline\"\r\n                          onClick={() => handleManageLoaner(deal)}\r\n                          className=\"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100\"\r\n                          aria-label=\"Manage loaner\"\r\n                        >\r\n                          <Icon name=\"Car\" size={16} className=\"mr-2\" />\r\n                          Assign Loaner\r\n                        </Button>\r\n                      )}\r\n\r\n                      {deal?.loaner_id && (\r\n                        <>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() => handleManageLoaner(deal)}\r\n                            className=\"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100\"\r\n                            aria-label=\"Edit loaner\"\r\n                          >\r\n                            <Icon name=\"Edit\" size={16} className=\"mr-2\" />\r\n                            Edit Loaner\r\n                          </Button>\r\n\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() =>\r\n                              setMarkReturnedModal({\r\n                                loaner_id: deal?.loaner_id,\r\n                                loaner_number: deal?.loaner_number,\r\n                                job_title: getDealPrimaryRef(deal),\r\n                              })\r\n                            }\r\n                            className=\"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100\"\r\n                            aria-label=\"Mark loaner returned\"\r\n                          >\r\n                            <Icon name=\"CheckCircle\" size={16} className=\"mr-2\" />\r\n                            Mark Returned\r\n                          </Button>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n\r\n        {/* ✅ UPDATED: New Deal Modal */}\r\n        <NewDealModal\r\n          isOpen={showNewDealModal}\r\n          onClose={() => setShowNewDealModal(false)}\r\n          onSuccess={loadDeals}\r\n        />\r\n\r\n        {/* Edit Deal Modal */}\r\n        <EditDealModal\r\n          isOpen={showEditDealModal}\r\n          dealId={editingDealId}\r\n          deal={editingDeal}\r\n          onClose={closeEditModal}\r\n          onSuccess={() => {\r\n            loadDeals()\r\n            closeEditModal()\r\n          }}\r\n        />\r\n\r\n        {/* ✅ UPDATED: Delete Confirmation Modal with light theme */}\r\n        {deleteConfirm && (\r\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4\">\r\n              <div className=\"p-6\">\r\n                <h3 className=\"text-lg font-semibold mb-4 text-slate-900\">Delete Deal</h3>\r\n                <p className=\"text-slate-600 mb-6\">\r\n                  Delete deal and its line items? This cannot be undone.\r\n                </p>\r\n                <div className=\"flex gap-3\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={() => setDeleteConfirm(null)}\r\n                    className=\"flex-1 h-11\"\r\n                    aria-label=\"Cancel deletion\"\r\n                  >\r\n                    Cancel\r\n                  </Button>\r\n                  <Button\r\n                    onClick={() => handleDeleteDeal(deleteConfirm?.id)}\r\n                    className=\"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white\"\r\n                    aria-label=\"Confirm deletion\"\r\n                  >\r\n                    Delete\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* ✅ ADDED: Loaner Drawer with improved error handling */}\r\n        <LoanerDrawer\r\n          isOpen={showLoanerDrawer}\r\n          onClose={() => {\r\n            setShowLoanerDrawer(false)\r\n            setSelectedDealForLoaner(null)\r\n            setError('') // Clear any drawer-related errors\r\n          }}\r\n          deal={selectedDealForLoaner}\r\n          onSave={handleSaveLoaner}\r\n          loading={loanerLoading}\r\n        />\r\n\r\n        {/* Mark Loaner Returned Modal */}\r\n        <MarkReturnedModal\r\n          loaner={markReturnedModal}\r\n          onClose={() => {\r\n            setMarkReturnedModal(null)\r\n            setError('') // Clear any modal-related errors\r\n          }}\r\n          onConfirm={() => handleMarkLoanerReturned(markReturnedModal)}\r\n          loading={returningLoaner}\r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n"],"names":["safeString","value","defaultValue","advancedFeaturesService","data","error","_a","supabase","_d","_c","_b","template","currentUser","_h","_g","_f","_e","id","updates","pageType","_i","name","filters","isPublic","exportType","userRole","item","exportData","cleanedExportData","key","filename","headers","csvContent","firstRow","row","rowData","values","stringValue","blob","link","url","jobIds","preferences","preferencesWithUser","pref","_j","callback","payload","result","searchQuery","tableType","query","ExportButton","selectedIds","onExportStart","onExportComplete","onExportError","disabled","variant","size","className","isExporting","setIsExporting","useState","showOptions","setShowOptions","exportFormat","setExportFormat","exportScope","setExportScope","user","userProfile","useAuth","exportOptions","scopeOptions","getExportFilename","timestamp","handleExport","exportFilters","exportResult","getExportTypeLabel","jsxs","jsx","Button","Select","Icon","vehicleService","orgId","safeSelect","q","vehicleData","mockVehicleId","resolve","createdVehicle","stockNumber","vin","v","NewDealModal","isOpen","onClose","onSuccess","useTenant","currentStep","setCurrentStep","isSubmitting","setIsSubmitting","setError","isDirty","setIsDirty","showUnsavedWarning","setShowUnsavedWarning","dropdownData","setDropdownData","initialFormState","customerData","setCustomerData","lineItems","setLineItems","loadDropdownData","retryCount","prev","sales","dc","finance","vendorsOpts","productsOpts","getSalesConsultants","getDeliveryCoordinators","getFinanceManagers","getVendors","getProducts","p","err","LoanerCheckbox","checked","onChange","e","isChecked","MobileSelect","label","options","placeholder","required","helpText","testId","option","useEffect","hasChanges","addLineItem","updateLineItem","field","updatedItem","selectedProduct","removeLineItem","validateStep1","validateStep2","calculateTotal","sum","handleSaveDraft","vehiclePayload","vehicle","dealService","resetForm","handleCreateDeal","total","serviceType","primaryVendor","scheduledStart","vendorDates","it","a","b","li","_k","_l","created","handleClose","confirmClose","index","product","vendor","Fragment","listProductsByOrg","activeOnly","rows","toOptions","listStaffByOrg","useDropdownData","loadOnMount","cacheTime","state","setState","lastUpdate","setLastUpdate","tenant","auth","loadData","useTenantLists","promises","getUserProfiles","listVendorsByOrg","listSmsTemplatesByOrg","users","vendors","products","smsTemplates","isCacheValid","refreshIfNeeded","performGlobalSearch","searchTerm","results","globalSearch","clearSearch","getUserOptions","filterOptions","roles","departments","filteredUsers","getVendorOptions","specialty","filteredVendors","mounted","start","r","useDealFormDropdowns","deliveryCoordinators","salesConsultants","financeManagers","loading","refresh","Portal","React","SearchableSelect","searchable","clearable","optionLabel","optionValue","groupBy","renderOption","helperText","setIsOpen","setSearchTerm","isMobile","setIsMobile","filteredOptions","setFilteredOptions","highlightedIndex","setHighlightedIndex","dropdownPosition","setDropdownPosition","containerRef","useRef","searchInputRef","mediaQuery","handleResize","term","filtered","searchFields","selectedOption","opt","isSelected","calculateDropdownPosition","rect","handleClickOutside","event","handleKeyDown","handleSelect","handleClear","EditDealModal","dealId","initialDeal","setLoading","saving","setSaving","deleteConfirm","setDeleteConfirm","deleting","setDeleting","initialFormData","setInitialFormData","loanerAssignment","setLoanerAssignment","loanerForm","setLoanerForm","salesConsultantOptions","deliveryCoordinatorOptions","financeManagerOptions","dropdownLoading","refreshDropdowns","formData","setFormData","formDeal","mapDbDealToForm","loadedFormData","toCamelLineItems","createEmptyLineItem","loadDealData","t","ServiceTypeRadio","selectedValue","itemIndex","SchedulingRadio","requiresScheduling","items","part","deal","getDeal","transaction","activeLoaner","la","dates","latest","updateFormData","i","_","handleSave","updatedFormData","payloadForSave","updateDeal","handleDelete","deleteDeal","price","quantity","Input","StatusPill","status","statusColors","color","displayStatus","NextPromisedChip","nextPromisedShort","promiseDate","today","todayPlus2","urgencyClass","ServiceLocationTag","jobParts","hasOffSiteItems","hasOnSiteItems","DraftReminderBanner","draftsCount","onViewDrafts","dismissed","setDismissed","getDealPrimaryRef","getDealSubtitle","CustomerDisplay","ValueDisplay","amount","LoanerBadge","LoanerDrawer","onSave","defaultEta","MarkReturnedModal","loaner","onConfirm","DealsPage","deals","setDeals","showNewDealModal","setShowNewDealModal","showEditDealModal","setShowEditDealModal","editingDealId","setEditingDealId","editingDeal","setEditingDeal","setFilters","showLoanerDrawer","setShowLoanerDrawer","selectedDealForLoaner","setSelectedDealForLoaner","loanerLoading","setLoanerLoading","markReturnedModal","setMarkReturnedModal","returningLoaner","setReturningLoaner","searchDebounce","setSearchDebounce","dropdownError","useNavigate","handleDeleteDeal","deleteError","loadDeals","handleSaveLoaner","loanerData","existing","updErr","insErr","errorMessage","handleMarkLoanerReturned","markLoanerReturned","getAllDeals","urlParams","statusParam","statusValue","handleManageLoaner","ErrorAlert","message","kpis","dealsData","safeDeals","activeJobs","d","totalRevenue","revenue","totalProfit","margin","pendingJobs","totalDrafts","filteredDeals","targetStatus","stripNonDigits","str","searchDigits","searchableFields","fieldStr","timer","updateFilter","searchParams","newUrl","clearAllFilters","handleEditDeal","found","closeEditModal","Navbar","recordCount"],"mappings":"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"}