import{s as l}from"./index-BoQPs2Xw.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const X=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function x(e,s){const r={};return s==null||s.forEach(_=>{(e==null?void 0:e[_])!==void 0&&(r[_]=e==null?void 0:e[_])}),r}function G(e){const s=x(e||{},X);return Object.keys(s).forEach(r=>{s[r]===""&&(s[r]=null)}),s}async function H(e){var _,n,o,c;const{data:s,error:r}=await((c=(o=(n=(_=l)==null?void 0:_.from("jobs"))==null?void 0:n.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:o.eq("id",e))==null?void 0:c.single());if(r)throw new Error(`Failed to load deal: ${r.message}`);return s}function U(e={}){var a,p,v,q,m,f,g,t,d;const s=G(e||{}),r=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),_=r?{...s,org_id:r}:s,o=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(i=>({product_id:i.product_id??null,quantity_used:Number(i.quantity_used??i.quantity??1),unit_price:Number(i.unit_price??i.price??0),promised_date:i.promised_date||i.lineItemPromisedDate||null,requires_scheduling:!!i.requires_scheduling||!!i.requiresScheduling,no_schedule_reason:i.no_schedule_reason||i.noScheduleReason||null,is_off_site:!!i.is_off_site||!!i.isOffSite,lineItemPromisedDate:i.lineItemPromisedDate||i.promised_date||null,requiresScheduling:!!i.requiresScheduling||!!i.requires_scheduling,noScheduleReason:i.noScheduleReason||i.no_schedule_reason||null,isOffSite:!!i.isOffSite||!!i.is_off_site}));for(const i of o)if((Number.isNaN(i.quantity_used)||i.quantity_used==null)&&(i.quantity_used=1),(Number.isNaN(i.unit_price)||i.unit_price==null)&&(i.unit_price=0),!i.requires_scheduling&&!String(i.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((o==null?void 0:o.length)||0)>0&&!o.some(N=>!!N.product_id))throw new Error("At least one product is required");const c=(o||[]).map(i=>({product_id:i.product_id,quantity:Number(i.quantity_used??1),unit_price:Number(i.unit_price??0),total_price:Number(i.unit_price??0)*Number(i.quantity_used??1),quantity_used:i.quantity_used,promised_date:i.promised_date,requires_scheduling:i.requires_scheduling,no_schedule_reason:i.no_schedule_reason,is_off_site:i.is_off_site})),w=(e==null?void 0:e.loanerForm)||null,y=((a=e==null?void 0:e.customerName)==null?void 0:a.trim())||((v=(p=e==null?void 0:e.customer_name)==null?void 0:p.trim)==null?void 0:v.call(p))||"",E=((q=e==null?void 0:e.customerPhone)==null?void 0:q.trim())||((f=(m=e==null?void 0:e.customer_phone)==null?void 0:m.trim)==null?void 0:f.call(m))||"",F=((g=e==null?void 0:e.customerEmail)==null?void 0:g.trim())||((d=(t=e==null?void 0:e.customer_email)==null?void 0:t.trim)==null?void 0:d.call(t))||"";return{payload:_,normalizedLineItems:o,jobPayload:_,jobParts:c,loanerForm:w,customerName:y,customerPhone:E,customerEmail:F}}function z(e,s=[]){var r,_;return(_=(r=s||[])==null?void 0:r.map(n=>({job_id:e,product_id:(n==null?void 0:n.product_id)??null,quantity_used:(n==null?void 0:n.quantity_used)??(n==null?void 0:n.quantity)??1,unit_price:(n==null?void 0:n.unit_price)??(n==null?void 0:n.price)??0,promised_date:(n==null?void 0:n.lineItemPromisedDate)||(n!=null&&n.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(n!=null&&n.requiresScheduling),no_schedule_reason:n!=null&&n.requiresScheduling?null:(n==null?void 0:n.noScheduleReason)||null,is_off_site:!!(n!=null&&n.isOffSite)})))==null?void 0:_.filter(n=>(n==null?void 0:n.product_id)!==null||(n==null?void 0:n.quantity_used)||(n==null?void 0:n.unit_price))}async function C(e,s){var r,_,n,o,c,w,y,E,F,a,p,v,q;if((r=s==null?void 0:s.loaner_number)!=null&&r.trim())try{const{data:m}=await((w=(c=(o=(n=(_=l)==null?void 0:_.from("loaner_assignments"))==null?void 0:n.select("id"))==null?void 0:o.eq("job_id",e))==null?void 0:c.is("returned_at",null))==null?void 0:w.single()),f={job_id:e,loaner_number:(y=s==null?void 0:s.loaner_number)==null?void 0:y.trim(),eta_return_date:(s==null?void 0:s.eta_return_date)||null,notes:((E=s==null?void 0:s.notes)==null?void 0:E.trim())||null};if(m){const{error:g}=await((p=(a=(F=l)==null?void 0:F.from("loaner_assignments"))==null?void 0:a.update(f))==null?void 0:p.eq("id",m==null?void 0:m.id));if(g)throw g}else{const{error:g}=await((q=(v=l)==null?void 0:v.from("loaner_assignments"))==null?void 0:q.insert([f]));if(g)throw g}}catch(m){throw(m==null?void 0:m.code)==="23505"?new Error(`Loaner ${s==null?void 0:s.loaner_number} is already assigned to another active job`):m}}async function K(){var e,s,r,_,n,o,c,w,y,E,F;try{const{data:a,error:p}=await((_=(r=(s=(e=l)==null?void 0:e.from("jobs"))==null?void 0:s.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        vehicle:vehicles(year, make, model, stock_number),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site)
      `))==null?void 0:r.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:_.order("created_at",{ascending:!1}));if(p)throw p;const v=(a==null?void 0:a.map(t=>t==null?void 0:t.id))||[],[q,m]=await Promise.all([(c=(o=(n=l)==null?void 0:n.from("transactions"))==null?void 0:o.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:c.in("job_id",v),(F=(E=(y=(w=l)==null?void 0:w.from("loaner_assignments"))==null?void 0:y.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:E.in("job_id",v))==null?void 0:F.is("returned_at",null)]),f=(q==null?void 0:q.data)||[],g=(m==null?void 0:m.data)||[];return(a==null?void 0:a.map(t=>{var P,O,k,A,L,J,M,R,T,h;const d=f==null?void 0:f.find(u=>(u==null?void 0:u.job_id)===(t==null?void 0:t.id)),i=g==null?void 0:g.find(u=>(u==null?void 0:u.job_id)===(t==null?void 0:t.id)),N=((P=t==null?void 0:t.job_parts)==null?void 0:P.filter(u=>(u==null?void 0:u.requires_scheduling)&&(u==null?void 0:u.promised_date)))||[],$=(N==null?void 0:N.length)>0?(k=(O=N==null?void 0:N.sort((u,I)=>new Date(u.promised_date)-new Date(I.promised_date)))==null?void 0:O[0])==null?void 0:k.promised_date:null;return{...t,customer_name:(d==null?void 0:d.customer_name)||"",customer_phone:(d==null?void 0:d.customer_phone)||"",customer_email:(d==null?void 0:d.customer_email)||"",total_amount:(d==null?void 0:d.total_amount)||0,next_promised_short:$?(A=new Date($))==null?void 0:A.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_id:(i==null?void 0:i.id)||null,loaner_number:(i==null?void 0:i.loaner_number)||null,loaner_eta_short:i!=null&&i.eta_return_date?(L=new Date(i==null?void 0:i.eta_return_date))==null?void 0:L.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,vehicle:t!=null&&t.vehicle_id&&(t!=null&&t.vehicle)?{year:(J=t==null?void 0:t.vehicle)==null?void 0:J.year,make:(M=t==null?void 0:t.vehicle)==null?void 0:M.make,model:(R=t==null?void 0:t.vehicle)==null?void 0:R.model,stock_number:(T=t==null?void 0:t.vehicle)==null?void 0:T.stock_number}:null,stock_no:(h=t==null?void 0:t.vehicle)==null?void 0:h.stock_number}}))||[]}catch(a){throw console.error("Failed to load deals:",a),new Error(`Failed to load deals: ${a==null?void 0:a.message}`)}}async function B(e){var s,r,_,n;try{const o=await H(e),{data:c}=await((n=(_=(r=(s=l)==null?void 0:s.from("transactions"))==null?void 0:r.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:_.eq("job_id",e))==null?void 0:n.single());return{...o,customer_name:(c==null?void 0:c.customer_name)||"",customer_phone:(c==null?void 0:c.customer_phone)||"",customer_email:(c==null?void 0:c.customer_email)||"",total_amount:(c==null?void 0:c.total_amount)||0}}catch(o){throw console.error("[dealService:get] Failed to get deal:",o),new Error(`Failed to load deal: ${o==null?void 0:o.message}`)}}async function Q(e){var c,w,y,E,F,a,p,v,q,m,f,g;const{payload:s,normalizedLineItems:r,loanerForm:_}=U(e||{});if(!(s!=null&&s.job_number)){const t=Date.now(),d=Math.floor(Math.random()*1e4);s.job_number=`JOB-${t}-${d}`}s!=null&&s.vendor_id&&!(s!=null&&s.scheduled_start_time)&&(s.scheduled_start_time=new Date().toISOString());const{data:n,error:o}=await((E=(y=(w=(c=l)==null?void 0:c.from("jobs"))==null?void 0:w.insert([s]))==null?void 0:y.select("id"))==null?void 0:E.single());if(o)throw new Error(`Failed to create deal: ${o.message}`);try{if((r||[]).length>0){const t=z(n==null?void 0:n.id,r);if((t==null?void 0:t.length)>0){const{error:d}=await((a=(F=l)==null?void 0:F.from("job_parts"))==null?void 0:a.insert(t));if(d)throw d}}return s!=null&&s.customer_needs_loaner&&_&&await C(n==null?void 0:n.id,_),await B(n==null?void 0:n.id)}catch(t){console.error("[dealService:create] Failed to create deal:",t);try{await((q=(v=(p=l)==null?void 0:p.from("job_parts"))==null?void 0:v.delete())==null?void 0:q.eq("job_id",n==null?void 0:n.id))}catch{}try{await((g=(f=(m=l)==null?void 0:m.from("jobs"))==null?void 0:f.delete())==null?void 0:g.eq("id",n==null?void 0:n.id))}catch{}throw new Error(`Failed to create deal: ${t.message}`)}}async function W(e,s){var v,q,m,f,g,t,d,i,N,$,P,O,k,A,L,J,M,R,T;const{payload:r,normalizedLineItems:_,loanerForm:n,customerName:o,customerPhone:c,customerEmail:w}=U(s||{}),y=(_||[]).reduce((h,u)=>{const I=Number((u==null?void 0:u.quantity_used)||(u==null?void 0:u.quantity)||1),V=Number((u==null?void 0:u.unit_price)||(u==null?void 0:u.price)||0);return h+I*V},0)||0,{error:E}=await((m=(q=(v=l)==null?void 0:v.from("jobs"))==null?void 0:q.update(r))==null?void 0:m.eq("id",e));if(E)throw new Error(`Failed to update deal: ${E.message}`);const F=()=>{const h=Date.now(),u=Math.floor(Math.random()*1e4);return`TXN-${h}-${u}`},a={job_id:e,vehicle_id:(r==null?void 0:r.vehicle_id)||null,total_amount:y,customer_name:o||"Unknown Customer",customer_phone:c||null,customer_email:w||null,transaction_status:"pending"};try{const{data:h}=await((N=(i=(d=(t=(g=(f=l)==null?void 0:f.from("transactions"))==null?void 0:g.select("id, transaction_number"))==null?void 0:t.eq("job_id",e))==null?void 0:d.limit(1))==null?void 0:i.maybeSingle)==null?void 0:N.call(i));if(h!=null&&h.id){const{error:u}=await((O=(P=($=l)==null?void 0:$.from("transactions"))==null?void 0:P.update(a))==null?void 0:O.eq("id",h.id));if(u)throw u}else{const u={...a,transaction_number:F()},{error:I}=await((A=(k=l)==null?void 0:k.from("transactions"))==null?void 0:A.insert([u]));if(I)throw I}}catch(h){throw new Error(`Failed to upsert transaction: ${(h==null?void 0:h.message)||h}`)}const{error:p}=await((M=(J=(L=l)==null?void 0:L.from("job_parts"))==null?void 0:J.delete())==null?void 0:M.eq("job_id",e));if(p)throw new Error(`Failed to update line items: ${p.message}`);if((_||[]).length>0){const h=z(e,_);if((h==null?void 0:h.length)>0){const{error:u}=await((T=(R=l)==null?void 0:R.from("job_parts"))==null?void 0:T.insert(h));if(u)throw new Error(`Failed to update line items: ${u.message}`)}}return r!=null&&r.customer_needs_loaner&&n&&await C(e,n),await B(e)}async function Y(e){var r;const{error:s}=await((r=l)==null?void 0:r.rpc("delete_job_cascade",{p_job_id:e}));if(s)throw new Error(`Failed to delete deal: ${s.message}`);return!0}async function Z(e,s){var n,o,c,w,y;const{data:r,error:_}=await((y=(w=(c=(o=(n=l)==null?void 0:n.from("jobs"))==null?void 0:o.update({job_status:s}))==null?void 0:c.eq("id",e))==null?void 0:w.select("id, job_status"))==null?void 0:y.single());if(_)throw new Error(`Failed to update status: ${_.message}`);return r}function ee(e){var s;return e?{id:e==null?void 0:e.id,job_number:(e==null?void 0:e.job_number)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",vendor_id:e==null?void 0:e.vendor_id,vehicle_id:e==null?void 0:e.vehicle_id,job_status:(e==null?void 0:e.job_status)||"pending",priority:(e==null?void 0:e.priority)||"medium",scheduled_start_time:(e==null?void 0:e.scheduled_start_time)||"",scheduled_end_time:(e==null?void 0:e.scheduled_end_time)||"",estimated_hours:(e==null?void 0:e.estimated_hours)||"",estimated_cost:(e==null?void 0:e.estimated_cost)||"",actual_cost:(e==null?void 0:e.actual_cost)||"",location:(e==null?void 0:e.location)||"",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assigned_to:e==null?void 0:e.assigned_to,delivery_coordinator_id:e==null?void 0:e.delivery_coordinator_id,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicle:(e==null?void 0:e.vehicle)||null,lineItems:(s=(e==null?void 0:e.job_parts)||[])==null?void 0:s.map(r=>({product_id:r==null?void 0:r.product_id,unit_price:(r==null?void 0:r.unit_price)||0,quantity_used:(r==null?void 0:r.quantity_used)||1,promised_date:(r==null?void 0:r.promised_date)||"",requires_scheduling:!!(r!=null&&r.requires_scheduling),no_schedule_reason:(r==null?void 0:r.no_schedule_reason)||"",is_off_site:!!(r!=null&&r.is_off_site)}))}:null}async function ne(e){var s,r,_,n;try{const{error:o}=await((n=(_=(s=l)==null?void 0:s.from("loaner_assignments"))==null?void 0:_.update({returned_at:(r=new Date)==null?void 0:r.toISOString()}))==null?void 0:n.eq("id",e));if(o)throw o;return!0}catch(o){throw console.error("Failed to mark loaner as returned:",o),new Error(`Failed to mark loaner as returned: ${o==null?void 0:o.message}`)}}const se={getAllDeals:K,getDeal:B,createDeal:Q,updateDeal:W,deleteDeal:Y,updateDealStatus:Z};export{Q as createDeal,se as dealService,se as default,Y as deleteDeal,K as getAllDeals,B as getDeal,ee as mapDbDealToForm,U as mapFormToDb,ne as markLoanerReturned,z as toJobPartRows,W as updateDeal,Z as updateDealStatus};
//# sourceMappingURL=dealService-CkmTBHii.js.map
