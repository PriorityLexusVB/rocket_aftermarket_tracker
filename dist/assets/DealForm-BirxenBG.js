import{_ as fe}from"./supabase-D02rA7zj.js";import{i as pe,c as be,d as ge,g as X,b as Z,a as ee,j as e}from"./index-J61ARFIv.js";import{r as u}from"./react-Czq5O75u.js";import{l as ve,a as xe,b as P}from"./tenantService-Dp-apx3S.js";import{u as ye}from"./useTenant-DIP-ACuX.js";import{u as je}from"./useLogger-rvNn9uIV.js";import"./router-CZES1Sa0.js";import"./options-CllavUpK.js";function Ne({isDirty:s,isSubmitting:q}){return u.useEffect(()=>{if(!s||q)return;const k=p=>{if(p.defaultPrevented||p.button!==0||p.metaKey||p.altKey||p.ctrlKey||p.shiftKey)return;const I=p.target.closest?p.target.closest("a[href]"):null;if(!I||I.target==="_blank")return;const v=I.getAttribute("href")||"";if(!v||/^(https?:)?\/\//i.test(v))return;window.confirm("You have unsaved changes. Discard them?")||(p.preventDefault(),p.stopPropagation())},A=p=>{window.confirm("You have unsaved changes. Discard them?")||history.go(1)};return document.addEventListener("click",k,!0),window.addEventListener("popstate",A),()=>{document.removeEventListener("click",k,!0),window.removeEventListener("popstate",A)}},[s,q]),null}let U;try{U=fe(()=>import("./dealService-CugeVm6A.js"),__vite__mapDeps([0,1,2,3,4,5]))}catch{}const F=()=>({product_id:"",quantity_used:1,unit_price:0,promised_date:"",requires_scheduling:!0,no_schedule_reason:"",is_off_site:!1});function Ae({initial:s={},mode:q="create",onCancel:k,onSave:A}){var H,Q;const[p,I]=u.useState(!0),[v,L]=u.useState(!1),[$,M]=u.useState(""),[te,B]=u.useState(null),[V,O]=u.useState({}),[z,se]=u.useState([]),[R,ne]=u.useState([]),[J,ae]=u.useState([]),[Y,re]=u.useState([]),[G,oe]=u.useState([]),[r,C]=u.useState({id:s.id||void 0,job_number:s.job_number||"",vehicle_id:s.vehicle_id||"",stock_number:s.stock_number||"",description:s.description||"",vendor_id:s.vendor_id||"",assigned_to:s.assigned_to||"",finance_manager_id:s.finance_manager_id||"",delivery_coordinator_id:s.delivery_coordinator_id||"",customer_mobile:s.customer_mobile||"",customer_needs_loaner:!!s.customer_needs_loaner,lineItems:(H=s.lineItems)!=null&&H.length?s.lineItems:[F()],promised_date:s.promised_date||"",scheduled_start_time:s.scheduled_start_time||"",scheduled_end_time:s.scheduled_end_time||"",calendar_notes:s.calendar_notes||""});u.useEffect(()=>{var n;s&&(s.id||s.job_number||Array.isArray(s.lineItems)&&s.lineItems.length>0)&&C({id:s.id||void 0,job_number:s.job_number||"",vehicle_id:s.vehicle_id||"",stock_number:s.stock_number||"",description:s.description||"",vendor_id:s.vendor_id||"",assigned_to:s.assigned_to||"",finance_manager_id:s.finance_manager_id||"",delivery_coordinator_id:s.delivery_coordinator_id||"",customer_mobile:s.customer_mobile||"",customer_needs_loaner:!!s.customer_needs_loaner,lineItems:(n=s.lineItems)!=null&&n.length?s.lineItems:[F()],promised_date:s.promised_date||"",scheduled_start_time:s.scheduled_start_time||"",scheduled_end_time:s.scheduled_end_time||"",calendar_notes:s.calendar_notes||""})},[s]);const{orgId:m}=ye(),{logFormSubmission:D,logError:T}=je(),x=(Q=pe)==null?void 0:Q(),[W]=u.useState(()=>{var t;return JSON.stringify({id:s.id||void 0,job_number:s.job_number||"",vehicle_id:s.vehicle_id||"",stock_number:s.stock_number||"",description:s.description||"",vendor_id:s.vendor_id||"",assigned_to:s.assigned_to||"",finance_manager_id:s.finance_manager_id||"",delivery_coordinator_id:s.delivery_coordinator_id||"",customer_mobile:s.customer_mobile||"",customer_needs_loaner:!!s.customer_needs_loaner,lineItems:(t=s.lineItems)!=null&&t.length?s.lineItems:[F()],promised_date:s.promised_date||"",scheduled_start_time:s.scheduled_start_time||"",scheduled_end_time:s.scheduled_end_time||"",calendar_notes:s.calendar_notes||""})});u.useEffect(()=>{let t=!0;return(async()=>{try{const n=m?ve(m,{activeOnly:!0}):be(),i=m?xe(m,{activeOnly:!0}):ge(),b=m?P(m,{departments:["Sales","Sales Consultant","Sales Consultants"],activeOnly:!0}):X(),l=m?P(m,{departments:["Finance","Finance Manager","Finance Managers","Managers"],activeOnly:!0}):Z(),j=m?P(m,{departments:["Delivery","Delivery Coordinator","Delivery Coordinators"],activeOnly:!0}):ee();let[N,h,o,d,_]=await Promise.all([n,i,b,l,j]);if(m&&((!Array.isArray(o)||o.length===0)&&(o=await P(m,{activeOnly:!0}).catch(()=>[]),o!=null&&o.length||(o=await X().catch(()=>[]))),(!Array.isArray(d)||d.length===0)&&(d=await P(m,{activeOnly:!0}).catch(()=>[]),d!=null&&d.length||(d=await Z().catch(()=>[]))),(!Array.isArray(_)||_.length===0)&&(_=await P(m,{activeOnly:!0}).catch(()=>[]),_!=null&&_.length||(_=await ee().catch(()=>[])))),!t)return;se(N||[]),ne(h||[]),ae(o||[]),re(d||[]),oe(_||[])}catch(n){console.error("DealForm dropdown load error",n)}finally{t&&I(!1)}})(),()=>{t=!1}},[m]);const ce=u.useMemo(()=>{const t=new Map;return(R||[]).forEach(n=>{const i=n.id??n.value;i!=null&&t.set(String(i),n)}),t},[R]),y=(t,n)=>C(i=>({...i,[t]:n})),S=(t,n,i)=>C(b=>{const l={...b},j=Array.isArray(l.lineItems)?[...l.lineItems]:[],N={...j[t]||{}};if(N[n]=i,n==="product_id"){const h=ce.get(String(i));h&&h.unit_price!==void 0&&(N.unit_price=Number(h.unit_price||0))}return n==="no_schedule_reason"&&String(i||"").trim()&&O(h=>{var _;if(!h||!((_=h[t])!=null&&_.noScheduleReason))return h;const o={...h},d={...o[t]||{}};return delete d.noScheduleReason,Object.keys(d).length?o[t]=d:delete o[t],o}),n==="requires_scheduling"&&i&&O(h=>{var _;if(!h||!((_=h[t])!=null&&_.noScheduleReason))return h;const o={...h},d={...o[t]||{}};return delete d.noScheduleReason,Object.keys(d).length?o[t]=d:delete o[t],o}),j[t]=N,l.lineItems=j,l}),le=()=>C(t=>({...t,lineItems:[...t.lineItems,F()]})),de=t=>C(n=>({...n,lineItems:n.lineItems.filter((i,b)=>b!==t)})),E=u.useMemo(()=>{try{return JSON.stringify(r)!==W}catch{return!0}},[r,W]);u.useEffect(()=>{const t=n=>{if(!(!E||v))return n.preventDefault(),n.returnValue="",""};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)},[E,v]);const ie=()=>{v||E&&!window.confirm("You have unsaved changes. Discard them?")||k==null||k()},ue=u.useMemo(()=>{try{return(r.lineItems||[]).reduce((t,n)=>{const i=Number((n==null?void 0:n.quantity_used)??1)||1,b=Number((n==null?void 0:n.unit_price)??0)||0;return t+i*b},0)}catch{return 0}},[r.lineItems]),me=u.useMemo(()=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),[]),he=async t=>{var n,i,b,l,j,N,h;if((n=t==null?void 0:t.preventDefault)==null||n.call(t),!v){L(!0),M("");try{if((r.lineItems||[]).reduce((a,c,f)=>(c!=null&&c.product_id&&a.push(f),a),[]).length===0){L(!1),M("Please add at least one product to the deal.");try{const a=document.querySelector('[data-testid="product-select-0"]');a==null||a.scrollIntoView({behavior:"smooth",block:"center"}),(i=a==null?void 0:a.focus)==null||i.call(a)}catch{}return}const d=(r.lineItems||[]).reduce((a,c,f)=>{const w=!!(c!=null&&c.requires_scheduling),K=String((c==null?void 0:c.no_schedule_reason)||"").trim();return!w&&!K&&a.push(f),a},[]);if(d.length>0){const a={};d.forEach(c=>{a[c]={...a[c]||{},noScheduleReason:!0}}),O(a),L(!1);try{const c=d[0],f=document.querySelector('[data-testid="no-schedule-reason-${first{\'}"]');f==null||f.scrollIntoView({behavior:"smooth",block:"center"}),(b=f==null?void 0:f.focus)==null||b.call(f)}catch{}return}else O({});const _=a=>{try{const c=String(a||"").replace(/\D+/g,"");return c.length===10?`+1${c}`:c.length===11&&c.startsWith("1")?`+${c}`:a||""}catch{return a||""}},_e=(r.lineItems||[]).map(a=>({product_id:a.product_id||null,quantity_used:Number(a.quantity_used||1),unit_price:Number(a.unit_price||0),promised_date:a.promised_date||a.lineItemPromisedDate||null,requires_scheduling:!!a.requires_scheduling||!!a.requiresScheduling,no_schedule_reason:a.no_schedule_reason||a.noScheduleReason||null,is_off_site:!!a.is_off_site||!!a.isOffSite,lineItemPromisedDate:a.lineItemPromisedDate||a.promised_date||null,requiresScheduling:!!a.requiresScheduling||!!a.requires_scheduling,noScheduleReason:a.noScheduleReason||a.no_schedule_reason||null,isOffSite:!!a.isOffSite||!!a.is_off_site})),g={...r,org_id:r.org_id||m||void 0,customer_needs_loaner:!!r.customer_needs_loaner,customer_phone:_(r.customer_phone||r.customer_mobile||""),customerPhone:_(r.customerPhone||r.customer_mobile||r.customer_phone||""),lineItems:_e};if(A){await A(g),await(D==null?void 0:D("DealForm",{orgId:m,hasLineItems:((l=g==null?void 0:g.lineItems)==null?void 0:l.length)>0},!0)),B(Date.now());try{(j=x==null?void 0:x.success)==null||j.call(x,"Saved successfully")}catch{}}else if(U){const a=await U,c=(a==null?void 0:a.default)??a;let f=null;if(q==="edit"&&g.id?f=await c.updateDeal(g.id,g):f=await c.createDeal(g),f)try{const w=c.mapDbDealToForm?c.mapDbDealToForm(f):null;w&&C(K=>({...K,...w,lineItems:w.lineItems||[]}))}catch(w){console.warn("Failed to map saved record to form:",w)}await(D==null?void 0:D("DealForm",{orgId:m,hasLineItems:((N=g==null?void 0:g.lineItems)==null?void 0:N.length)>0},!0)),B(Date.now());try{(h=x==null?void 0:x.success)==null||h.call(x,"Saved successfully")}catch{}}}catch(o){const d=(o==null?void 0:o.message)||String(o);console.error("Deal save failed",o),M(d);try{await(T==null?void 0:T(o,{where:"DealForm.submit",orgId:m}))}catch{}}finally{L(!1)}}};return p?e.jsx("div",{className:"p-4",children:"Loadingâ€¦"}):e.jsxs("form",{className:"space-y-6 p-4",onSubmit:he,"data-testid":"deal-form",children:[e.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Deal / Job #"}),e.jsx("input",{"data-testid":"deal-number-input",type:"text",value:r.job_number,onChange:t=>y("job_number",t.target.value),className:"mt-1 input-mobile w-full",placeholder:"Auto or manual"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Stock #"}),e.jsx("input",{"data-testid":"stock-number-display",type:"text",value:r.stock_number||"",onChange:t=>y("stock_number",t.target.value),className:"mt-1 input-mobile w-full",placeholder:"e.g. A1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Customer Mobile"}),e.jsx("input",{"data-testid":"customer-mobile-input",type:"tel",value:r.customer_mobile,onChange:t=>y("customer_mobile",t.target.value),className:"mt-1 input-mobile w-full",placeholder:"+1 555 555 5555"})]})]}),e.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Vendor"}),e.jsxs("select",{"data-testid":"vendor-select",value:r.vendor_id||"",onChange:t=>y("vendor_id",t.target.value||null),className:"mt-1 input-mobile w-full",children:[e.jsx("option",{value:"",children:"â€” Select Vendor â€”"}),z.map(t=>e.jsx("option",{value:t.value,children:t.label},t.id))]}),z.length===0&&e.jsx("p",{className:"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1",children:"No vendors available. Check Admin â†’ Vendors to add or attach vendors to your org."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Description"}),e.jsx("textarea",{"data-testid":"description-input",value:r.description,onChange:t=>y("description",t.target.value),className:"mt-1 input-mobile w-full",rows:3})]})]}),e.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Sales Consultant"}),e.jsxs("select",{"data-testid":"sales-select",value:r.assigned_to||"",onChange:t=>y("assigned_to",t.target.value||null),className:"mt-1 input-mobile w-full",children:[e.jsx("option",{value:"",children:"â€” Select Sales â€”"}),J.map(t=>e.jsx("option",{value:t.value,children:t.label},t.id))]}),J.length===0&&e.jsx("p",{className:"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1",children:"No sales staff found. Use Admin â†’ Staff Records to add staff and assign to your org."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Finance Manager"}),e.jsxs("select",{"data-testid":"finance-select",value:r.finance_manager_id||"",onChange:t=>y("finance_manager_id",t.target.value||null),className:"mt-1 input-mobile w-full",children:[e.jsx("option",{value:"",children:"â€” Select Finance â€”"}),Y.map(t=>e.jsx("option",{value:t.value,children:t.label},t.id))]}),Y.length===0&&e.jsx("p",{className:"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1",children:"No finance managers found. Add or attach staff in Admin â†’ Staff Records."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Delivery Coordinator"}),e.jsxs("select",{"data-testid":"delivery-select",value:r.delivery_coordinator_id||"",onChange:t=>y("delivery_coordinator_id",t.target.value||null),className:"mt-1 input-mobile w-full",children:[e.jsx("option",{value:"",children:"â€” Select Delivery â€”"}),G.map(t=>e.jsx("option",{value:t.value,children:t.label},t.id))]}),G.length===0&&e.jsx("p",{className:"mt-2 text-sm text-amber-700 bg-amber-50 rounded px-2 py-1",children:"No delivery coordinators found. Add or attach staff in Admin â†’ Staff Records."})]})]}),e.jsxs("section",{className:"flex items-center gap-3",children:[e.jsx("input",{"data-testid":"loaner-checkbox",id:"needsLoaner",type:"checkbox",checked:!!r.customer_needs_loaner,onChange:t=>y("customer_needs_loaner",t.target.checked),className:"h-5 w-5 accent-blue-600 appearance-auto"}),e.jsx("label",{htmlFor:"needsLoaner",className:"text-sm text-slate-800",children:"Customer needs loaner"})]}),e.jsxs("section",{className:"space-y-4","data-testid":"line-items-section",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Line Items"}),e.jsx("button",{type:"button",onClick:le,className:"btn-mobile btn-mobile-sm","data-testid":"add-line-item-btn",children:"+ Add Item"})]}),R.length===0&&e.jsx("div",{className:"p-3 rounded bg-amber-50 text-amber-800 text-sm",children:"No products available. Check Admin â†’ Aftermarket Products to add/attach products."}),r.lineItems.map((t,n)=>{var b;const i=`li-${n}`;return t.is_off_site,e.jsxs("div",{className:"card-mobile space-y-3","data-testid":`line-${n}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-3",children:[e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Product"}),e.jsxs("select",{"data-testid":`product-select-${n}`,value:t.product_id||"",onChange:l=>S(n,"product_id",l.target.value||""),className:"mt-1 input-mobile w-full",children:[e.jsx("option",{value:"",children:"â€” Select Product â€”"}),R.map(l=>e.jsx("option",{value:l.value,children:l.label},l.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Unit Price"}),e.jsx("input",{"data-testid":`unit-price-input-${n}`,type:"number",step:"0.01",value:t.unit_price,onChange:l=>S(n,"unit_price",Number(l.target.value||0)),className:"mt-1 input-mobile w-full"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"button",onClick:()=>de(n),className:"btn-mobile btn-mobile-sm w-full","data-testid":`remove-line-item-btn-${n}`,children:"Remove"})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:`inline-flex items-center gap-2 cursor-pointer border rounded px-3 py-2
                    ${t.is_off_site?"border-gray-300":"ring-2 ring-blue-400 bg-blue-50 border-blue-300"}`,children:[e.jsx("input",{type:"radio",name:`serviceLocation_${i}`,checked:!t.is_off_site,onChange:()=>S(n,"is_off_site",!1),className:"h-4 w-4 accent-blue-600 appearance-auto","data-testid":`onsite-radio-${n}`}),e.jsx("span",{className:"text-sm",children:"On-Site"})]}),e.jsxs("label",{className:`inline-flex items-center gap-2 cursor-pointer border rounded px-3 py-2
                    ${t.is_off_site?"ring-2 ring-blue-400 bg-blue-50 border-blue-300":"border-gray-300"}`,children:[e.jsx("input",{type:"radio",name:`serviceLocation_${i}`,checked:!!t.is_off_site,onChange:()=>S(n,"is_off_site",!0),className:"h-4 w-4 accent-blue-600 appearance-auto","data-testid":`offsite-radio-${n}`}),e.jsx("span",{className:"text-sm",children:"Off-Site"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Promised Date"}),e.jsx("input",{"data-testid":`promised-date-${n}`,type:"date",value:t.promised_date||"",onChange:l=>S(n,"promised_date",l.target.value||""),className:"mt-1 input-mobile w-full"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-6",children:[e.jsx("input",{id:`requiresScheduling-${n}`,"data-testid":`requires-scheduling-${n}`,type:"checkbox",checked:!!t.requires_scheduling,onChange:l=>S(n,"requires_scheduling",l.target.checked),className:"h-5 w-5 accent-blue-600 appearance-auto"}),e.jsx("label",{htmlFor:`requiresScheduling-${n}`,className:"text-sm",children:"Requires Scheduling"})]}),!t.requires_scheduling&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"No Schedule Reason"}),e.jsx("input",{"data-testid":`no-schedule-reason-${n}`,type:"text",value:t.no_schedule_reason||"",onChange:l=>S(n,"no_schedule_reason",l.target.value||""),className:"mt-1 input-mobile w-full"}),((b=V==null?void 0:V[n])==null?void 0:b.noScheduleReason)&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:"Reason is required when not scheduling."})]})]})]},i)})]}),e.jsxs("section",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Calendar Notes"}),e.jsx("textarea",{"data-testid":"calendar-notes-input",value:r.calendar_notes||"",onChange:t=>y("calendar_notes",t.target.value),className:"mt-1 input-mobile w-full",rows:3})]}),e.jsx("section",{className:"sticky bottom-20 md:bottom-0 z-40 -mx-4 px-4 py-3 bg-white/90 backdrop-blur border-t shadow-sm",style:{paddingBottom:"max(env(safe-area-inset-bottom), 0px)"},children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-baseline gap-2","data-testid":"deal-total",children:[e.jsx("span",{className:"text-sm text-slate-600",children:"Total"}),e.jsx("span",{className:"text-lg font-semibold","data-testid":"deal-total-amount",children:me.format(ue||0)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:ie,className:"btn-mobile button-outline-enhanced",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:v,className:"btn-mobile button-enhanced","data-testid":"save-deal-btn",children:v?"Savingâ€¦":q==="edit"?"Save Changes":"Create Deal"})]})]})}),$?e.jsx("div",{className:"mt-3 p-3 rounded bg-red-50 text-red-700","data-testid":"save-error",children:$}):null,te&&!$?e.jsx("div",{className:"mt-3 p-3 rounded bg-emerald-50 text-emerald-700","data-testid":"save-success",children:"Saved successfully."}):null,e.jsx(Ne,{isDirty:E,isSubmitting:v})]})}export{Ae as default};
//# sourceMappingURL=DealForm-BirxenBG.js.map
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/dealService-CugeVm6A.js","assets/index-J61ARFIv.js","assets/react-Czq5O75u.js","assets/supabase-D02rA7zj.js","assets/router-CZES1Sa0.js","assets/index-BZO1J_ai.css"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}