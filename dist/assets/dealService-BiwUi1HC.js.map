{"version":3,"file":"dealService-BiwUi1HC.js","sources":["../../src/services/dealService.js"],"sourcesContent":["// src/services/dealService.js\r\nimport { supabase } from '@/lib/supabase'\r\n\r\n// --- helpers -------------------------------------------------------------\r\n\r\n// Only pass columns we're confident exist on your `jobs` table.\r\n// Add more keys here if you confirm additional columns.\r\nconst JOB_COLS = [\r\n  'job_number',\r\n  'title',\r\n  'description',\r\n  'vehicle_id',\r\n  'vendor_id',\r\n  'job_status',\r\n  'priority',\r\n  'location',\r\n  'scheduled_start_time',\r\n  'scheduled_end_time',\r\n  'estimated_hours',\r\n  'estimated_cost',\r\n  'actual_cost',\r\n  'customer_needs_loaner', // ✅ CONFIRMED: This column exists\r\n  'service_type',\r\n  'delivery_coordinator_id',\r\n  'finance_manager_id', // ✅ ADDED: Missing from previous list\r\n  'assigned_to',\r\n  // Optional multi-tenant scoping when present\r\n  'org_id',\r\n]\r\n\r\nfunction pick(obj, keys) {\r\n  const out = {}\r\n  keys?.forEach((k) => {\r\n    if (obj?.[k] !== undefined) out[k] = obj?.[k]\r\n  })\r\n  return out\r\n}\r\n\r\nfunction sanitizeDealPayload(input) {\r\n  const out = pick(input || {}, JOB_COLS)\r\n  // Generic: coerce empty-string primitives to null so DB types (uuid/timestamp/numeric) don't error\r\n  Object.keys(out).forEach((k) => {\r\n    if (out[k] === '') out[k] = null\r\n  })\r\n  return out\r\n}\r\n\r\n// Generate a readable unique-ish transaction number\r\nfunction generateTransactionNumber() {\r\n  const ts = Date.now()\r\n  const rand = Math.floor(Math.random() * 1_0000)\r\n  return `TXN-${ts}-${rand}`\r\n}\r\n\r\n// (moved below): mapDbDealToForm is implemented near the end and re-exported\r\n\r\n// Internal helper: load a fully-joined deal/job by id\r\nasync function selectJoinedDealById(id) {\r\n  const { data: job, error: jobError } = await supabase\r\n    ?.from('jobs')\r\n    ?.select(\r\n      `\r\n        id, job_number, title, description, job_status, priority, location,\r\n        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,\r\n        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,\r\n        service_type, delivery_coordinator_id, assigned_to, created_at, updated_at, finance_manager_id,\r\n        vehicle:vehicles(id, year, make, model, stock_number),\r\n        vendor:vendors(id, name),\r\n        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))\r\n      `\r\n    )\r\n    ?.eq('id', id)\r\n    ?.single()\r\n\r\n  if (jobError) throw new Error(`Failed to load deal: ${jobError.message}`)\r\n  return job\r\n}\r\n\r\n// Map UI form state into DB-friendly pieces: job payload, normalized lineItems, loaner form\r\nfunction mapFormToDb(formState = {}) {\r\n  // Base payload constrained to known columns\r\n  const base = sanitizeDealPayload(formState || {})\r\n\r\n  // Optional tenant scoping if provided by caller\r\n  const orgId = formState?.org_id ?? formState?.orgId\r\n  const payload = orgId ? { ...base, org_id: orgId } : base\r\n  // Ensure title stays meaningful and mirrors description edits for UX consistency\r\n  // - If description was provided/edited, use it as the title (primary display)\r\n  // - Else, if title missing, fall back to job_number or a generic default\r\n  {\r\n    const desc = (formState?.description || '').trim()\r\n    if (desc) {\r\n      payload.title = desc\r\n    } else if (!payload?.title) {\r\n      if (payload?.job_number) payload.title = `Deal ${payload.job_number}`\r\n      else payload.title = 'Untitled Deal'\r\n    }\r\n  }\r\n\r\n  // Accept either lineItems (current UI) or line_items (alternate callers)\r\n  const lineItemsInput = Array.isArray(formState?.line_items)\r\n    ? formState?.line_items\r\n    : Array.isArray(formState?.lineItems)\r\n      ? formState?.lineItems\r\n      : []\r\n\r\n  const normalizedLineItems = (lineItemsInput || []).map((li) => {\r\n    const requiresSchedulingNorm =\r\n      li?.requires_scheduling ?? li?.requiresScheduling ?? true /* default to true */\r\n    const noScheduleReasonNorm = li?.no_schedule_reason || li?.noScheduleReason || null\r\n    const lineItemPromisedDateNorm = li?.promised_date || li?.lineItemPromisedDate || null\r\n    const isOffSiteNorm = li?.is_off_site ?? li?.isOffSite ?? false\r\n    return {\r\n      product_id: li.product_id ?? null,\r\n      quantity_used: Number(li.quantity_used ?? li.quantity ?? 1),\r\n      unit_price: Number(li.unit_price ?? li.price ?? 0),\r\n      // snake_case for DB\r\n      promised_date: lineItemPromisedDateNorm,\r\n      requires_scheduling: !!requiresSchedulingNorm,\r\n      no_schedule_reason: requiresSchedulingNorm ? null : noScheduleReasonNorm,\r\n      is_off_site: !!isOffSiteNorm,\r\n      // keep camelCase too for internal callers\r\n      lineItemPromisedDate: lineItemPromisedDateNorm,\r\n      requiresScheduling: !!requiresSchedulingNorm,\r\n      noScheduleReason: requiresSchedulingNorm ? null : noScheduleReasonNorm,\r\n      isOffSite: !!isOffSiteNorm,\r\n    }\r\n  })\r\n\r\n  // Coerce invalid numerics and enforce business rules\r\n  for (const item of normalizedLineItems) {\r\n    if (Number.isNaN(item.quantity_used) || item.quantity_used == null) item.quantity_used = 1\r\n    if (Number.isNaN(item.unit_price) || item.unit_price == null) item.unit_price = 0\r\n    // Business rule: if not scheduling, reason is required\r\n    if (!item.requires_scheduling && !String(item.no_schedule_reason || '').trim()) {\r\n      throw new Error('Each non-scheduled line item must include a reason')\r\n    }\r\n  }\r\n\r\n  // Safety: require at least one product line item when any line items are provided\r\n  if ((normalizedLineItems?.length || 0) > 0) {\r\n    const hasProduct = normalizedLineItems.some((it) => !!it.product_id)\r\n    if (!hasProduct) throw new Error('At least one product is required')\r\n  }\r\n\r\n  // Contract-friendly jobParts for callers that expect quantity + total_price (UI keeps snake_case)\r\n  const jobParts = (normalizedLineItems || []).map((it) => ({\r\n    product_id: it.product_id,\r\n    quantity: Number(it.quantity_used ?? 1),\r\n    unit_price: Number(it.unit_price ?? 0),\r\n    total_price: Number(it.unit_price ?? 0) * Number(it.quantity_used ?? 1),\r\n    // Preserve UI snake_case so consumers don't lose fields\r\n    quantity_used: it.quantity_used,\r\n    promised_date: it.promised_date,\r\n    requires_scheduling: it.requires_scheduling,\r\n    no_schedule_reason: it.no_schedule_reason,\r\n    is_off_site: it.is_off_site,\r\n  }))\r\n\r\n  const loanerForm = formState?.loanerForm || null\r\n\r\n  // customer fields normalization\r\n  const customerName = formState?.customerName?.trim() || formState?.customer_name?.trim?.() || ''\r\n  const customerPhone =\r\n    formState?.customerPhone?.trim() || formState?.customer_phone?.trim?.() || ''\r\n  const customerEmail =\r\n    formState?.customerEmail?.trim() || formState?.customer_email?.trim?.() || ''\r\n\r\n  return {\r\n    // Back-compat keys used internally\r\n    payload,\r\n    normalizedLineItems,\r\n    // New contract-friendly keys (non-breaking additions)\r\n    jobPayload: payload,\r\n    jobParts,\r\n    // Extras\r\n    loanerForm,\r\n    customerName,\r\n    customerPhone,\r\n    customerEmail,\r\n  }\r\n}\r\n\r\n// Normalize line items to match `job_parts` columns we know are present.\r\n// ✅ FIXED: Remove total_price as it's auto-generated\r\nexport function toJobPartRows(jobId, items = []) {\r\n  return (\r\n    // drop null-only rows\r\n    (items || [])\r\n      ?.map((it) => ({\r\n        job_id: jobId,\r\n        product_id: it?.product_id ?? null,\r\n        quantity_used: it?.quantity_used ?? it?.quantity ?? 1,\r\n        unit_price: it?.unit_price ?? it?.price ?? 0,\r\n        // Add new per-line-item scheduling fields\r\n        promised_date:\r\n          it?.lineItemPromisedDate ||\r\n          // If requires scheduling and no date provided, default to today to satisfy DB constraint\r\n          (it?.requiresScheduling ? new Date().toISOString().slice(0, 10) : null),\r\n        requires_scheduling: !!it?.requiresScheduling,\r\n        no_schedule_reason: it?.requiresScheduling ? null : it?.noScheduleReason || null,\r\n        is_off_site: !!it?.isOffSite,\r\n        // ✅ REMOVED: total_price as it's auto-generated by database\r\n        // ✅ REMOVED: description field as it doesn't exist in schema\r\n      }))\r\n      ?.filter((row) => row?.product_id !== null || row?.quantity_used || row?.unit_price)\r\n  )\r\n}\r\n\r\n// A3: Enhanced UPSERT loaner assignment function\r\nasync function upsertLoanerAssignment(jobId, loanerData) {\r\n  if (!loanerData?.loaner_number?.trim()) {\r\n    return // No loaner number provided, skip assignment\r\n  }\r\n\r\n  try {\r\n    // Check for existing active assignment for this job\r\n    const { data: existing } = await supabase\r\n      ?.from('loaner_assignments')\r\n      ?.select('id')\r\n      ?.eq('job_id', jobId)\r\n      ?.is('returned_at', null)\r\n      ?.single()\r\n\r\n    const assignmentData = {\r\n      job_id: jobId,\r\n      loaner_number: loanerData?.loaner_number?.trim(),\r\n      eta_return_date: loanerData?.eta_return_date || null,\r\n      notes: loanerData?.notes?.trim() || null,\r\n    }\r\n\r\n    if (existing) {\r\n      // Update existing assignment\r\n      const { error } = await supabase\r\n        ?.from('loaner_assignments')\r\n        ?.update(assignmentData)\r\n        ?.eq('id', existing?.id)\r\n\r\n      if (error) throw error\r\n    } else {\r\n      // Create new assignment\r\n      const { error } = await supabase?.from('loaner_assignments')?.insert([assignmentData])\r\n\r\n      if (error) throw error\r\n    }\r\n  } catch (error) {\r\n    // Handle uniqueness constraint error gracefully\r\n    if (error?.code === '23505') {\r\n      throw new Error(\r\n        `Loaner ${loanerData?.loaner_number} is already assigned to another active job`\r\n      )\r\n    }\r\n    throw error\r\n  }\r\n}\r\n\r\n// ✅ FIXED: Updated getAllDeals to remove SQL RPC dependency and use direct queries\r\nexport async function getAllDeals() {\r\n  try {\r\n    // Use direct Supabase queries instead of SQL RPC function\r\n    const { data: jobs, error: jobsError } = await supabase\r\n      ?.from('jobs')\r\n      ?.select(\r\n        `\r\n        id, created_at, job_status, service_type, color_code, title, job_number,\r\n        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,\r\n        scheduled_start_time, scheduled_end_time,\r\n        vehicle:vehicles(year, make, model, stock_number),\r\n        vendor:vendors(id, name),\r\n        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))\r\n      `\r\n      )\r\n      ?.in('job_status', ['draft', 'pending', 'in_progress', 'completed'])\r\n      ?.order('created_at', { ascending: false })\r\n\r\n    if (jobsError) throw jobsError\r\n\r\n    // Get transactions and loaner assignments separately for better performance\r\n    const jobIds = jobs?.map((j) => j?.id) || []\r\n\r\n    const [transactionsResult, loanersResult] = await Promise.all([\r\n      supabase\r\n        ?.from('transactions')\r\n        ?.select('job_id, customer_name, customer_phone, customer_email, total_amount')\r\n        ?.in('job_id', jobIds),\r\n      supabase\r\n        ?.from('loaner_assignments')\r\n        ?.select('job_id, id, loaner_number, eta_return_date')\r\n        ?.in('job_id', jobIds)\r\n        ?.is('returned_at', null),\r\n    ])\r\n\r\n    const transactions = transactionsResult?.data || []\r\n    const loaners = loanersResult?.data || []\r\n\r\n    // Process and enhance the data\r\n    return (\r\n      jobs?.map((job) => {\r\n        const transaction = transactions?.find((t) => t?.job_id === job?.id)\r\n        const loaner = loaners?.find((l) => l?.job_id === job?.id)\r\n\r\n        // Calculate next promised date from job parts\r\n        const schedulingParts =\r\n          job?.job_parts?.filter((part) => part?.requires_scheduling && part?.promised_date) || []\r\n        const nextPromisedDate =\r\n          schedulingParts?.length > 0\r\n            ? schedulingParts?.sort(\r\n                (a, b) => new Date(a.promised_date) - new Date(b.promised_date)\r\n              )?.[0]?.promised_date\r\n            : null\r\n\r\n        // Compute helpful display fields\r\n        const createdAt = job?.created_at ? new Date(job.created_at) : null\r\n        const now = new Date()\r\n        const ageDays = createdAt\r\n          ? Math.max(0, Math.floor((now - createdAt) / (1000 * 60 * 60 * 24)))\r\n          : null\r\n\r\n        // Normalize phone to E.164 (best-effort, default country US)\r\n        const rawPhone = transaction?.customer_phone || ''\r\n        const digits = (rawPhone || '').replace(/\\D/g, '')\r\n        const phoneLast4 = digits?.slice(-4) || ''\r\n        const phoneE164 =\r\n          digits?.length === 11 && digits.startsWith('1')\r\n            ? `+${digits}`\r\n            : digits?.length === 10\r\n              ? `+1${digits}`\r\n              : rawPhone || ''\r\n\r\n        // Appointment window formatting helpers (leave raw timestamps for UI)\r\n        const apptStart = job?.scheduled_start_time || null\r\n        const apptEnd = job?.scheduled_end_time || null\r\n\r\n        // Work tags (simple mapping from product/category/name)\r\n        const workTags = (job?.job_parts || [])\r\n          .map((p) => p?.product?.category || p?.product?.name || '')\r\n          .map((label) => {\r\n            const l = (label || '').toLowerCase()\r\n            if (/ppf|paint protection/.test(l)) return 'PPF'\r\n            if (/tint|window/.test(l)) return 'Tint'\r\n            if (/ceramic/.test(l)) return 'Ceramic'\r\n            if (/detail|wash|interior|exterior/.test(l)) return 'Detail'\r\n            return null\r\n          })\r\n          .filter(Boolean)\r\n          .filter((v, i, a) => a.indexOf(v) === i)\r\n\r\n        return {\r\n          ...job,\r\n          customer_name: transaction?.customer_name || '',\r\n          customer_phone: transaction?.customer_phone || '',\r\n          customer_phone_e164: phoneE164,\r\n          customer_phone_last4: phoneLast4,\r\n          customer_email: transaction?.customer_email || '',\r\n          total_amount: transaction?.total_amount || 0,\r\n          has_active_loaner: !!loaner?.id,\r\n          next_promised_iso: nextPromisedDate || null,\r\n          loaner_id: loaner?.id || null,\r\n          loaner_number: loaner?.loaner_number || null,\r\n          loaner_eta_short: loaner?.eta_return_date\r\n            ? new Date(loaner?.eta_return_date)?.toLocaleDateString('en-US', {\r\n                month: 'short',\r\n                day: 'numeric',\r\n              })\r\n            : null,\r\n          loaner_eta_return_date: loaner?.eta_return_date || null,\r\n          age_days: ageDays,\r\n          appt_start: apptStart,\r\n          appt_end: apptEnd,\r\n          vendor_name: job?.vendor?.name || null,\r\n          work_tags: workTags,\r\n          vehicle:\r\n            job?.vehicle_id && job?.vehicle\r\n              ? {\r\n                  year: job?.vehicle?.year,\r\n                  make: job?.vehicle?.make,\r\n                  model: job?.vehicle?.model,\r\n                  stock_number: job?.vehicle?.stock_number,\r\n                }\r\n              : null,\r\n          stock_no: job?.vehicle?.stock_number,\r\n        }\r\n      }) || []\r\n    )\r\n  } catch (error) {\r\n    console.error('Failed to load deals:', error)\r\n    throw new Error(`Failed to load deals: ${error?.message}`)\r\n  }\r\n}\r\n\r\n// ✅ FIXED: Updated getDeal to remove SQL RPC dependency\r\nexport async function getDeal(id) {\r\n  try {\r\n    // Centralized joined selector\r\n    const job = await selectJoinedDealById(id)\r\n\r\n    // Get transaction data separately\r\n    const { data: transaction } = await supabase\r\n      ?.from('transactions')\r\n      ?.select('customer_name, customer_phone, customer_email, total_amount')\r\n      ?.eq('job_id', id)\r\n      ?.single()\r\n\r\n    return {\r\n      ...job,\r\n      customer_name: transaction?.customer_name || '',\r\n      customer_phone: transaction?.customer_phone || '',\r\n      customer_email: transaction?.customer_email || '',\r\n      total_amount: transaction?.total_amount || 0,\r\n    }\r\n  } catch (error) {\r\n    console.error('[dealService:get] Failed to get deal:', error)\r\n    throw new Error(`Failed to load deal: ${error?.message}`)\r\n  }\r\n}\r\n\r\n// CREATE: deal + job_parts\r\nexport async function createDeal(formState) {\r\n  const { payload, normalizedLineItems, loanerForm, customerName, customerPhone, customerEmail } =\r\n    mapFormToDb(formState || {})\r\n\r\n  // Fallback tenant scoping: if org_id is missing, try to infer from current user's profile\r\n  if (!payload?.org_id) {\r\n    try {\r\n      const { data: auth } = await supabase?.auth?.getUser?.()\r\n      const userId = auth?.user?.id\r\n      if (userId) {\r\n        const { data: prof } = await supabase\r\n          ?.from('user_profiles')\r\n          ?.select('org_id')\r\n          ?.eq('id', userId)\r\n          ?.single()\r\n        if (prof?.org_id) payload.org_id = prof.org_id\r\n      }\r\n    } catch (e) {\r\n      console.warn('[dealService:create] Unable to infer org_id from profile:', e?.message)\r\n    }\r\n  }\r\n\r\n  // Ensure required fields the DB expects\r\n  // jobs.job_number is NOT NULL + UNIQUE in schema; auto-generate if missing\r\n  if (!payload?.job_number) {\r\n    const ts = Date.now()\r\n    const rand = Math.floor(Math.random() * 1_0000)\r\n    payload.job_number = `JOB-${ts}-${rand}`\r\n  }\r\n\r\n  // Some DB triggers enforce vendor jobs to have scheduled dates.\r\n  // If this is a vendor job and no scheduled_start_time provided, default to now.\r\n  if (payload?.vendor_id && !payload?.scheduled_start_time) {\r\n    payload.scheduled_start_time = new Date().toISOString()\r\n  }\r\n\r\n  // Pre-insert FK guard: ensure all referenced products exist to avoid FK failure\r\n  try {\r\n    const productIds = Array.from(\r\n      new Set(\r\n        (normalizedLineItems || [])\r\n          .map((it) => (it?.product_id ? String(it.product_id) : null))\r\n          .filter(Boolean)\r\n      )\r\n    )\r\n    if (productIds.length) {\r\n      const { data: prodRows, error: prodErr } = await supabase\r\n        ?.from('products')\r\n        ?.select('id')\r\n        ?.in('id', productIds)\r\n      if (prodErr) throw prodErr\r\n      const found = new Set((prodRows || []).map((r) => String(r.id)))\r\n      const missing = productIds.filter((pid) => !found.has(String(pid)))\r\n      if (missing.length) {\r\n        throw new Error(\r\n          'One or more selected products no longer exist. Please re-select a valid product.'\r\n        )\r\n      }\r\n    }\r\n  } catch (fkErr) {\r\n    throw new Error(`Failed to create deal: ${fkErr?.message || fkErr}`)\r\n  }\r\n\r\n  // 1) create job\r\n  const { data: job, error: jobErr } = await supabase\r\n    ?.from('jobs')\r\n    ?.insert([payload])\r\n    ?.select('id')\r\n    ?.single()\r\n  if (jobErr) throw new Error(`Failed to create deal: ${jobErr.message}`)\r\n\r\n  try {\r\n    // 2) insert parts (if any)\r\n    if ((normalizedLineItems || []).length > 0) {\r\n      const rows = toJobPartRows(job?.id, normalizedLineItems)\r\n      if (rows?.length > 0) {\r\n        const { error: partsErr } = await supabase?.from('job_parts')?.insert(rows)\r\n        if (partsErr) throw partsErr\r\n      }\r\n    }\r\n\r\n    // A3: Handle loaner assignment for new deals\r\n    if (payload?.customer_needs_loaner && loanerForm) {\r\n      await upsertLoanerAssignment(job?.id, loanerForm)\r\n    }\r\n\r\n    // 3) Ensure a transaction row exists immediately to satisfy NOT NULLs in some environments\r\n    try {\r\n      const baseTransaction = {\r\n        job_id: job?.id,\r\n        vehicle_id: payload?.vehicle_id || null,\r\n        total_amount:\r\n          (normalizedLineItems || []).reduce((sum, item) => {\r\n            const qty = Number(item?.quantity_used || item?.quantity || 1)\r\n            const price = Number(item?.unit_price || item?.price || 0)\r\n            return sum + qty * price\r\n          }, 0) || 0,\r\n        customer_name: customerName || 'Unknown Customer',\r\n        customer_phone: customerPhone || null,\r\n        customer_email: customerEmail || null,\r\n        transaction_status: 'pending',\r\n        transaction_number: generateTransactionNumber(),\r\n      }\r\n\r\n      // best-effort: insert only if not exists (race-safe enough for single client)\r\n      const { data: existingTxn } = await supabase\r\n        ?.from('transactions')\r\n        ?.select('id')\r\n        ?.eq('job_id', job?.id)\r\n        ?.limit(1)\r\n        ?.maybeSingle?.()\r\n\r\n      if (!existingTxn?.id) {\r\n        await supabase?.from('transactions')?.insert([baseTransaction])\r\n      }\r\n    } catch (e) {\r\n      // non-fatal; updateDeal will try again, but we attempted to satisfy NOT NULL early\r\n      console.warn('[dealService:create] pre-create transaction insert skipped:', e?.message)\r\n    }\r\n\r\n    // 4) return full record (with joins). If joins are restricted by RLS/policies, fall back to minimal shape with id so callers can navigate to edit.\r\n    try {\r\n      return await getDeal(job?.id)\r\n    } catch (e) {\r\n      console.warn('[dealService:create] getDeal fallback due to error:', e?.message)\r\n      return { id: job?.id }\r\n    }\r\n  } catch (error) {\r\n    console.error('[dealService:create] Failed to create deal:', error)\r\n    // rollback best-effort: delete parts first, then job\r\n    try {\r\n      await supabase?.from('job_parts')?.delete()?.eq('job_id', job?.id)\r\n    } catch (_) {\r\n      // ignore\r\n    }\r\n    try {\r\n      await supabase?.from('jobs')?.delete()?.eq('id', job?.id)\r\n    } catch (_) {\r\n      // ignore\r\n    }\r\n    throw new Error(`Failed to create deal: ${error.message}`)\r\n  }\r\n}\r\n\r\n// UPDATE: deal + replace job_parts - FIXED with proper transaction handling and customer data\r\nexport async function updateDeal(id, formState) {\r\n  const { payload, normalizedLineItems, loanerForm, customerName, customerPhone, customerEmail } =\r\n    mapFormToDb(formState || {})\r\n\r\n  // Ensure description is explicitly updated when provided (some environments rely on it for display)\r\n  {\r\n    const desc = (formState?.description || '').trim()\r\n    if (desc) payload.description = desc\r\n  }\r\n\r\n  // Calculate total deal value for transactions\r\n  const totalDealValue =\r\n    (normalizedLineItems || []).reduce((sum, item) => {\r\n      const qty = Number(item?.quantity_used || item?.quantity || 1)\r\n      const price = Number(item?.unit_price || item?.price || 0)\r\n      return sum + qty * price\r\n    }, 0) || 0\r\n\r\n  // 1) Update job with optimistic concurrency and tenant scope where possible\r\n  let jobErr\r\n  try {\r\n    let q = supabase?.from('jobs')?.update(payload)?.eq('id', id)\r\n    // Tenant scope if provided\r\n    if (payload?.org_id) q = q?.eq?.('org_id', payload.org_id)\r\n    // Optimistic concurrency using updated_at if provided by caller\r\n    if (formState?.updated_at) q = q?.eq?.('updated_at', formState.updated_at)\r\n\r\n    const { data: updRow, error: updErr } = await q?.select('id, updated_at')?.maybeSingle?.()\r\n    if (updErr) throw updErr\r\n    if (!updRow?.id) {\r\n      // No rows matched: treat as 409/Conflict\r\n      const conflict = new Error(\r\n        'Conflict: This deal was updated by someone else. Refresh and try again.'\r\n      )\r\n      conflict.status = 409\r\n      throw conflict\r\n    }\r\n  } catch (e) {\r\n    jobErr = e\r\n  }\r\n  if (jobErr) throw new Error(`Failed to update deal: ${jobErr.message || jobErr}`)\r\n\r\n  // Prefer server-truth; do not write localStorage fallbacks for description\r\n\r\n  // 2) ✅ ENHANCED: Upsert transaction with customer data\r\n  const baseTransactionData = {\r\n    job_id: id,\r\n    vehicle_id: payload?.vehicle_id || null,\r\n    total_amount: totalDealValue,\r\n    customer_name: customerName || 'Unknown Customer',\r\n    customer_phone: customerPhone || null,\r\n    customer_email: customerEmail || null,\r\n    transaction_status: 'pending',\r\n  }\r\n\r\n  // Upsert without relying on a DB unique constraint (some envs lack a unique index on job_id)\r\n  try {\r\n    const { data: existingTxn } = await supabase\r\n      ?.from('transactions')\r\n      ?.select('id, transaction_number')\r\n      ?.eq('job_id', id)\r\n      ?.limit(1)\r\n      ?.maybeSingle?.() // keep compatibility if maybeSingle exists\r\n\r\n    if (existingTxn?.id) {\r\n      const { error: updErr } = await supabase\r\n        ?.from('transactions')\r\n        ?.update(baseTransactionData) // don't overwrite transaction_number on update\r\n        ?.eq('id', existingTxn.id)\r\n      if (updErr) throw updErr\r\n    } else {\r\n      const insertData = { ...baseTransactionData, transaction_number: generateTransactionNumber() }\r\n      const { error: insErr } = await supabase?.from('transactions')?.insert([insertData])\r\n      if (insErr) throw insErr\r\n    }\r\n  } catch (e) {\r\n    throw new Error(`Failed to upsert transaction: ${e?.message || e}`)\r\n  }\r\n\r\n  // 3) Replace job_parts with new scheduling fields\r\n  // Delete existing\r\n  const { error: delErr } = await supabase?.from('job_parts')?.delete()?.eq('job_id', id)\r\n  if (delErr) throw new Error(`Failed to update line items: ${delErr.message}`)\r\n\r\n  // Insert new (if any)\r\n  if ((normalizedLineItems || []).length > 0) {\r\n    const rows = toJobPartRows(id, normalizedLineItems)\r\n    if (rows?.length > 0) {\r\n      const { error: insErr } = await supabase?.from('job_parts')?.insert(rows)\r\n      if (insErr) throw new Error(`Failed to update line items: ${insErr.message}`)\r\n    }\r\n  }\r\n\r\n  // A3: Handle loaner assignment updates\r\n  if (payload?.customer_needs_loaner && loanerForm) {\r\n    await upsertLoanerAssignment(id, loanerForm)\r\n  }\r\n\r\n  // 4) Return full record (with joins and transaction data)\r\n  return await getDeal(id)\r\n}\r\n\r\n// ✅ UPDATED: Use safe cascade delete function\r\nexport async function deleteDeal(id) {\r\n  const { error } = await supabase?.rpc('delete_job_cascade', { p_job_id: id })\r\n  if (error) throw new Error(`Failed to delete deal: ${error.message}`)\r\n  return true\r\n}\r\n\r\n// UPDATE: status only (handy for quick changes)\r\nexport async function updateDealStatus(id, job_status) {\r\n  const { data, error } = await supabase\r\n    ?.from('jobs')\r\n    ?.update({ job_status })\r\n    ?.eq('id', id)\r\n    ?.select('id, job_status')\r\n    ?.single()\r\n\r\n  if (error) throw new Error(`Failed to update status: ${error.message}`)\r\n  return data\r\n}\r\n\r\n// ✅ ENHANCED: mapDbDealToForm implementation with proper customer data handling\r\nfunction mapDbDealToForm(dbDeal) {\r\n  if (!dbDeal) return null\r\n\r\n  return {\r\n    id: dbDeal?.id,\r\n    updated_at: dbDeal?.updated_at,\r\n    job_number: dbDeal?.job_number || '',\r\n    title: dbDeal?.title || '',\r\n    // Prefer title as the primary description source (we sync title to description on save)\r\n    // Fall back to DB description for older records\r\n    description: dbDeal?.title || dbDeal?.description || '',\r\n    vendor_id: dbDeal?.vendor_id,\r\n    vehicle_id: dbDeal?.vehicle_id,\r\n    job_status: dbDeal?.job_status || 'pending',\r\n    priority: dbDeal?.priority || 'medium',\r\n    scheduled_start_time: dbDeal?.scheduled_start_time || '',\r\n    scheduled_end_time: dbDeal?.scheduled_end_time || '',\r\n    estimated_hours: dbDeal?.estimated_hours || '',\r\n    estimated_cost: dbDeal?.estimated_cost || '',\r\n    actual_cost: dbDeal?.actual_cost || '',\r\n    location: dbDeal?.location || '',\r\n    customer_needs_loaner: !!dbDeal?.customer_needs_loaner,\r\n    assigned_to: dbDeal?.assigned_to,\r\n    delivery_coordinator_id: dbDeal?.delivery_coordinator_id,\r\n    finance_manager_id: dbDeal?.finance_manager_id,\r\n    // ✅ ENHANCED: Include customer data from transactions\r\n    customerName: dbDeal?.customer_name || '',\r\n    customerPhone: dbDeal?.customer_phone || '',\r\n    customerEmail: dbDeal?.customer_email || '',\r\n    // Preserve vehicle for header (stock number)\r\n    vehicle: dbDeal?.vehicle || null,\r\n    // Line items in snake_case shape expected by the form/UI\r\n    lineItems: (dbDeal?.job_parts || [])?.map((part) => ({\r\n      product_id: part?.product_id,\r\n      unit_price: part?.unit_price || 0,\r\n      quantity_used: part?.quantity_used || 1,\r\n      promised_date: part?.promised_date || '',\r\n      requires_scheduling: !!part?.requires_scheduling,\r\n      no_schedule_reason: part?.no_schedule_reason || '',\r\n      is_off_site: !!part?.is_off_site,\r\n    })),\r\n  }\r\n}\r\n\r\n// A3: New function to mark loaner as returned\r\nexport async function markLoanerReturned(loanerAssignmentId) {\r\n  try {\r\n    // Use direct update instead of RPC function if it doesn't exist\r\n    const { error } = await supabase\r\n      ?.from('loaner_assignments')\r\n      ?.update({ returned_at: new Date()?.toISOString() })\r\n      ?.eq('id', loanerAssignmentId)\r\n\r\n    if (error) throw error\r\n    return true\r\n  } catch (error) {\r\n    console.error('Failed to mark loaner as returned:', error)\r\n    throw new Error(`Failed to mark loaner as returned: ${error?.message}`)\r\n  }\r\n}\r\n\r\n// Back-compat default export (so both import styles work):\r\nexport const dealService = {\r\n  getAllDeals,\r\n  getDeal,\r\n  createDeal,\r\n  updateDeal,\r\n  deleteDeal,\r\n  updateDealStatus,\r\n}\r\n\r\nexport default dealService\r\n\r\nexport { mapDbDealToForm, mapFormToDb }\r\n"],"names":["JOB_COLS","pick","obj","keys","out","k","sanitizeDealPayload","input","generateTransactionNumber","ts","rand","selectJoinedDealById","id","job","jobError","_d","_c","_b","_a","supabase","mapFormToDb","formState","base","orgId","payload","desc","normalizedLineItems","li","requiresSchedulingNorm","noScheduleReasonNorm","lineItemPromisedDateNorm","isOffSiteNorm","item","it","jobParts","loanerForm","customerName","customerPhone","_f","_e","customerEmail","_g","_i","_h","toJobPartRows","jobId","items","row","upsertLoanerAssignment","loanerData","existing","assignmentData","error","_k","_j","_m","_l","getAllDeals","jobs","jobsError","jobIds","j","transactionsResult","loanersResult","transactions","loaners","transaction","t","loaner","l","schedulingParts","part","nextPromisedDate","a","b","createdAt","ageDays","rawPhone","digits","phoneLast4","phoneE164","apptStart","apptEnd","workTags","p","label","v","i","getDeal","createDeal","auth","userId","prof","e","productIds","prodRows","prodErr","found","r","pid","fkErr","jobErr","_o","_n","rows","partsErr","_q","_p","baseTransaction","sum","qty","price","existingTxn","_w","_v","_u","_t","_s","_r","_y","_x","_B","_A","_z","_E","_D","_C","updateDeal","totalDealValue","q","updRow","updErr","conflict","baseTransactionData","insertData","insErr","delErr","deleteDeal","updateDealStatus","job_status","data","mapDbDealToForm","dbDeal","markLoanerReturned","loanerAssignmentId","dealService"],"mappings":"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"}