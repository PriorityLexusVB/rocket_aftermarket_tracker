import{s as g}from"./index-DgFDa27-.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const X=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function G(e,n){const r={};return n==null||n.forEach(c=>{(e==null?void 0:e[c])!==void 0&&(r[c]=e==null?void 0:e[c])}),r}function H(e){const n=G(e||{},X);return Object.keys(n).forEach(r=>{n[r]===""&&(n[r]=null)}),n}function B(){const e=Date.now(),n=Math.floor(Math.random()*1e4);return`TXN-${e}-${n}`}async function K(e){var c,s,o,d;const{data:n,error:r}=await((d=(o=(s=(c=g)==null?void 0:c.from("jobs"))==null?void 0:s.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:o.eq("id",e))==null?void 0:d.single());if(r)throw new Error(`Failed to load deal: ${r.message}`);return n}function C(e={}){var h,q,F,E,a,N,y,t,m;const n=H(e||{}),r=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),c=r?{...n,org_id:r}:n,o=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(i=>({product_id:i.product_id??null,quantity_used:Number(i.quantity_used??i.quantity??1),unit_price:Number(i.unit_price??i.price??0),promised_date:i.promised_date||i.lineItemPromisedDate||null,requires_scheduling:!!i.requires_scheduling||!!i.requiresScheduling,no_schedule_reason:i.no_schedule_reason||i.noScheduleReason||null,is_off_site:!!i.is_off_site||!!i.isOffSite,lineItemPromisedDate:i.lineItemPromisedDate||i.promised_date||null,requiresScheduling:!!i.requiresScheduling||!!i.requires_scheduling,noScheduleReason:i.noScheduleReason||i.no_schedule_reason||null,isOffSite:!!i.isOffSite||!!i.is_off_site}));for(const i of o)if((Number.isNaN(i.quantity_used)||i.quantity_used==null)&&(i.quantity_used=1),(Number.isNaN(i.unit_price)||i.unit_price==null)&&(i.unit_price=0),!i.requires_scheduling&&!String(i.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((o==null?void 0:o.length)||0)>0&&!o.some(I=>!!I.product_id))throw new Error("At least one product is required");const d=(o||[]).map(i=>({product_id:i.product_id,quantity:Number(i.quantity_used??1),unit_price:Number(i.unit_price??0),total_price:Number(i.unit_price??0)*Number(i.quantity_used??1),quantity_used:i.quantity_used,promised_date:i.promised_date,requires_scheduling:i.requires_scheduling,no_schedule_reason:i.no_schedule_reason,is_off_site:i.is_off_site})),_=(e==null?void 0:e.loanerForm)||null,v=((h=e==null?void 0:e.customerName)==null?void 0:h.trim())||((F=(q=e==null?void 0:e.customer_name)==null?void 0:q.trim)==null?void 0:F.call(q))||"",$=((E=e==null?void 0:e.customerPhone)==null?void 0:E.trim())||((N=(a=e==null?void 0:e.customer_phone)==null?void 0:a.trim)==null?void 0:N.call(a))||"",P=((y=e==null?void 0:e.customerEmail)==null?void 0:y.trim())||((m=(t=e==null?void 0:e.customer_email)==null?void 0:t.trim)==null?void 0:m.call(t))||"";return{payload:c,normalizedLineItems:o,jobPayload:c,jobParts:d,loanerForm:_,customerName:v,customerPhone:$,customerEmail:P}}function z(e,n=[]){var r,c;return(c=(r=n||[])==null?void 0:r.map(s=>({job_id:e,product_id:(s==null?void 0:s.product_id)??null,quantity_used:(s==null?void 0:s.quantity_used)??(s==null?void 0:s.quantity)??1,unit_price:(s==null?void 0:s.unit_price)??(s==null?void 0:s.price)??0,promised_date:(s==null?void 0:s.lineItemPromisedDate)||(s!=null&&s.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(s!=null&&s.requiresScheduling),no_schedule_reason:s!=null&&s.requiresScheduling?null:(s==null?void 0:s.noScheduleReason)||null,is_off_site:!!(s!=null&&s.isOffSite)})))==null?void 0:c.filter(s=>(s==null?void 0:s.product_id)!==null||(s==null?void 0:s.quantity_used)||(s==null?void 0:s.unit_price))}async function V(e,n){var r,c,s,o,d,_,v,$,P,h,q,F,E;if((r=n==null?void 0:n.loaner_number)!=null&&r.trim())try{const{data:a}=await((_=(d=(o=(s=(c=g)==null?void 0:c.from("loaner_assignments"))==null?void 0:s.select("id"))==null?void 0:o.eq("job_id",e))==null?void 0:d.is("returned_at",null))==null?void 0:_.single()),N={job_id:e,loaner_number:(v=n==null?void 0:n.loaner_number)==null?void 0:v.trim(),eta_return_date:(n==null?void 0:n.eta_return_date)||null,notes:(($=n==null?void 0:n.notes)==null?void 0:$.trim())||null};if(a){const{error:y}=await((q=(h=(P=g)==null?void 0:P.from("loaner_assignments"))==null?void 0:h.update(N))==null?void 0:q.eq("id",a==null?void 0:a.id));if(y)throw y}else{const{error:y}=await((E=(F=g)==null?void 0:F.from("loaner_assignments"))==null?void 0:E.insert([N]));if(y)throw y}}catch(a){throw(a==null?void 0:a.code)==="23505"?new Error(`Loaner ${n==null?void 0:n.loaner_number} is already assigned to another active job`):a}}async function Q(){var e,n,r,c,s,o,d,_,v,$,P;try{const{data:h,error:q}=await((c=(r=(n=(e=g)==null?void 0:e.from("jobs"))==null?void 0:n.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        vehicle:vehicles(year, make, model, stock_number),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site)
      `))==null?void 0:r.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:c.order("created_at",{ascending:!1}));if(q)throw q;const F=(h==null?void 0:h.map(t=>t==null?void 0:t.id))||[],[E,a]=await Promise.all([(d=(o=(s=g)==null?void 0:s.from("transactions"))==null?void 0:o.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:d.in("job_id",F),(P=($=(v=(_=g)==null?void 0:_.from("loaner_assignments"))==null?void 0:v.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:$.in("job_id",F))==null?void 0:P.is("returned_at",null)]),N=(E==null?void 0:E.data)||[],y=(a==null?void 0:a.data)||[];return(h==null?void 0:h.map(t=>{var O,A,L,J,M,R,p,f,w,u;const m=N==null?void 0:N.find(l=>(l==null?void 0:l.job_id)===(t==null?void 0:t.id)),i=y==null?void 0:y.find(l=>(l==null?void 0:l.job_id)===(t==null?void 0:t.id)),I=((O=t==null?void 0:t.job_parts)==null?void 0:O.filter(l=>(l==null?void 0:l.requires_scheduling)&&(l==null?void 0:l.promised_date)))||[],k=(I==null?void 0:I.length)>0?(L=(A=I==null?void 0:I.sort((l,T)=>new Date(l.promised_date)-new Date(T.promised_date)))==null?void 0:A[0])==null?void 0:L.promised_date:null;return{...t,customer_name:(m==null?void 0:m.customer_name)||"",customer_phone:(m==null?void 0:m.customer_phone)||"",customer_email:(m==null?void 0:m.customer_email)||"",total_amount:(m==null?void 0:m.total_amount)||0,next_promised_short:k?(J=new Date(k))==null?void 0:J.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_id:(i==null?void 0:i.id)||null,loaner_number:(i==null?void 0:i.loaner_number)||null,loaner_eta_short:i!=null&&i.eta_return_date?(M=new Date(i==null?void 0:i.eta_return_date))==null?void 0:M.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,vehicle:t!=null&&t.vehicle_id&&(t!=null&&t.vehicle)?{year:(R=t==null?void 0:t.vehicle)==null?void 0:R.year,make:(p=t==null?void 0:t.vehicle)==null?void 0:p.make,model:(f=t==null?void 0:t.vehicle)==null?void 0:f.model,stock_number:(w=t==null?void 0:t.vehicle)==null?void 0:w.stock_number}:null,stock_no:(u=t==null?void 0:t.vehicle)==null?void 0:u.stock_number}}))||[]}catch(h){throw console.error("Failed to load deals:",h),new Error(`Failed to load deals: ${h==null?void 0:h.message}`)}}async function U(e){var n,r,c,s;try{const o=await K(e),{data:d}=await((s=(c=(r=(n=g)==null?void 0:n.from("transactions"))==null?void 0:r.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:c.eq("job_id",e))==null?void 0:s.single());return{...o,customer_name:(d==null?void 0:d.customer_name)||"",customer_phone:(d==null?void 0:d.customer_phone)||"",customer_email:(d==null?void 0:d.customer_email)||"",total_amount:(d==null?void 0:d.total_amount)||0}}catch(o){throw console.error("[dealService:get] Failed to get deal:",o),new Error(`Failed to load deal: ${o==null?void 0:o.message}`)}}async function W(e){var $,P,h,q,F,E,a,N,y,t,m,i,I,k,O,A,L,J,M,R;const{payload:n,normalizedLineItems:r,loanerForm:c,customerName:s,customerPhone:o,customerEmail:d}=C(e||{});if(!(n!=null&&n.job_number)){const p=Date.now(),f=Math.floor(Math.random()*1e4);n.job_number=`JOB-${p}-${f}`}n!=null&&n.vendor_id&&!(n!=null&&n.scheduled_start_time)&&(n.scheduled_start_time=new Date().toISOString());const{data:_,error:v}=await((q=(h=(P=($=g)==null?void 0:$.from("jobs"))==null?void 0:P.insert([n]))==null?void 0:h.select("id"))==null?void 0:q.single());if(v)throw new Error(`Failed to create deal: ${v.message}`);try{if((r||[]).length>0){const p=z(_==null?void 0:_.id,r);if((p==null?void 0:p.length)>0){const{error:f}=await((E=(F=g)==null?void 0:F.from("job_parts"))==null?void 0:E.insert(p));if(f)throw f}}n!=null&&n.customer_needs_loaner&&c&&await V(_==null?void 0:_.id,c);try{const p={job_id:_==null?void 0:_.id,vehicle_id:(n==null?void 0:n.vehicle_id)||null,total_amount:(r||[]).reduce((w,u)=>{const l=Number((u==null?void 0:u.quantity_used)||(u==null?void 0:u.quantity)||1),T=Number((u==null?void 0:u.unit_price)||(u==null?void 0:u.price)||0);return w+l*T},0)||0,customer_name:s||"Unknown Customer",customer_phone:o||null,customer_email:d||null,transaction_status:"pending",transaction_number:B()},{data:f}=await((i=(m=(t=(y=(N=(a=g)==null?void 0:a.from("transactions"))==null?void 0:N.select("id"))==null?void 0:y.eq("job_id",_==null?void 0:_.id))==null?void 0:t.limit(1))==null?void 0:m.maybeSingle)==null?void 0:i.call(m));f!=null&&f.id||await((k=(I=g)==null?void 0:I.from("transactions"))==null?void 0:k.insert([p]))}catch(p){console.warn("[dealService:create] pre-create transaction insert skipped:",p==null?void 0:p.message)}return await U(_==null?void 0:_.id)}catch(p){console.error("[dealService:create] Failed to create deal:",p);try{await((L=(A=(O=g)==null?void 0:O.from("job_parts"))==null?void 0:A.delete())==null?void 0:L.eq("job_id",_==null?void 0:_.id))}catch{}try{await((R=(M=(J=g)==null?void 0:J.from("jobs"))==null?void 0:M.delete())==null?void 0:R.eq("id",_==null?void 0:_.id))}catch{}throw new Error(`Failed to create deal: ${p.message}`)}}async function Y(e,n){var q,F,E,a,N,y,t,m,i,I,k,O,A,L,J,M,R,p,f;const{payload:r,normalizedLineItems:c,loanerForm:s,customerName:o,customerPhone:d,customerEmail:_}=C(n||{}),v=(c||[]).reduce((w,u)=>{const l=Number((u==null?void 0:u.quantity_used)||(u==null?void 0:u.quantity)||1),T=Number((u==null?void 0:u.unit_price)||(u==null?void 0:u.price)||0);return w+l*T},0)||0,{error:$}=await((E=(F=(q=g)==null?void 0:q.from("jobs"))==null?void 0:F.update(r))==null?void 0:E.eq("id",e));if($)throw new Error(`Failed to update deal: ${$.message}`);const P={job_id:e,vehicle_id:(r==null?void 0:r.vehicle_id)||null,total_amount:v,customer_name:o||"Unknown Customer",customer_phone:d||null,customer_email:_||null,transaction_status:"pending"};try{const{data:w}=await((i=(m=(t=(y=(N=(a=g)==null?void 0:a.from("transactions"))==null?void 0:N.select("id, transaction_number"))==null?void 0:y.eq("job_id",e))==null?void 0:t.limit(1))==null?void 0:m.maybeSingle)==null?void 0:i.call(m));if(w!=null&&w.id){const{error:u}=await((O=(k=(I=g)==null?void 0:I.from("transactions"))==null?void 0:k.update(P))==null?void 0:O.eq("id",w.id));if(u)throw u}else{const u={...P,transaction_number:B()},{error:l}=await((L=(A=g)==null?void 0:A.from("transactions"))==null?void 0:L.insert([u]));if(l)throw l}}catch(w){throw new Error(`Failed to upsert transaction: ${(w==null?void 0:w.message)||w}`)}const{error:h}=await((R=(M=(J=g)==null?void 0:J.from("job_parts"))==null?void 0:M.delete())==null?void 0:R.eq("job_id",e));if(h)throw new Error(`Failed to update line items: ${h.message}`);if((c||[]).length>0){const w=z(e,c);if((w==null?void 0:w.length)>0){const{error:u}=await((f=(p=g)==null?void 0:p.from("job_parts"))==null?void 0:f.insert(w));if(u)throw new Error(`Failed to update line items: ${u.message}`)}}return r!=null&&r.customer_needs_loaner&&s&&await V(e,s),await U(e)}async function Z(e){var r;const{error:n}=await((r=g)==null?void 0:r.rpc("delete_job_cascade",{p_job_id:e}));if(n)throw new Error(`Failed to delete deal: ${n.message}`);return!0}async function x(e,n){var s,o,d,_,v;const{data:r,error:c}=await((v=(_=(d=(o=(s=g)==null?void 0:s.from("jobs"))==null?void 0:o.update({job_status:n}))==null?void 0:d.eq("id",e))==null?void 0:_.select("id, job_status"))==null?void 0:v.single());if(c)throw new Error(`Failed to update status: ${c.message}`);return r}function ee(e){var n;return e?{id:e==null?void 0:e.id,job_number:(e==null?void 0:e.job_number)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",vendor_id:e==null?void 0:e.vendor_id,vehicle_id:e==null?void 0:e.vehicle_id,job_status:(e==null?void 0:e.job_status)||"pending",priority:(e==null?void 0:e.priority)||"medium",scheduled_start_time:(e==null?void 0:e.scheduled_start_time)||"",scheduled_end_time:(e==null?void 0:e.scheduled_end_time)||"",estimated_hours:(e==null?void 0:e.estimated_hours)||"",estimated_cost:(e==null?void 0:e.estimated_cost)||"",actual_cost:(e==null?void 0:e.actual_cost)||"",location:(e==null?void 0:e.location)||"",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assigned_to:e==null?void 0:e.assigned_to,delivery_coordinator_id:e==null?void 0:e.delivery_coordinator_id,finance_manager_id:e==null?void 0:e.finance_manager_id,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicle:(e==null?void 0:e.vehicle)||null,lineItems:(n=(e==null?void 0:e.job_parts)||[])==null?void 0:n.map(r=>({product_id:r==null?void 0:r.product_id,unit_price:(r==null?void 0:r.unit_price)||0,quantity_used:(r==null?void 0:r.quantity_used)||1,promised_date:(r==null?void 0:r.promised_date)||"",requires_scheduling:!!(r!=null&&r.requires_scheduling),no_schedule_reason:(r==null?void 0:r.no_schedule_reason)||"",is_off_site:!!(r!=null&&r.is_off_site)}))}:null}async function ne(e){var n,r,c,s;try{const{error:o}=await((s=(c=(n=g)==null?void 0:n.from("loaner_assignments"))==null?void 0:c.update({returned_at:(r=new Date)==null?void 0:r.toISOString()}))==null?void 0:s.eq("id",e));if(o)throw o;return!0}catch(o){throw console.error("Failed to mark loaner as returned:",o),new Error(`Failed to mark loaner as returned: ${o==null?void 0:o.message}`)}}const se={getAllDeals:Q,getDeal:U,createDeal:W,updateDeal:Y,deleteDeal:Z,updateDealStatus:x};export{W as createDeal,se as dealService,se as default,Z as deleteDeal,Q as getAllDeals,U as getDeal,ee as mapDbDealToForm,C as mapFormToDb,ne as markLoanerReturned,z as toJobPartRows,Y as updateDeal,x as updateDealStatus};
//# sourceMappingURL=dealService-BzS3ILPT.js.map
