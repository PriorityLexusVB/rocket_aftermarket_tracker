import{s as J,u as Ee,j as e,B as K,S as Ce,I as $e,g as Fe,a as Ae,b as Re,c as Be,d as Ve,e as Ke,f as Xe,h as ue}from"./index-BTbXx-8j.js";import{r as I,R as He}from"./react-Czq5O75u.js";import{dealService as Le,getDeal as We,mapDbDealToForm as Ge,updateDeal as Ze,deleteDeal as Qe,markLoanerReturned as De,getAllDeals as es}from"./dealService-DAWIhieb.js";import{u as Ue}from"./useTenant-BkWoO8Dc.js";import{s as _e,t as ss}from"./options-CllavUpK.js";import{I as Q}from"./Icon-8OPO6Nwf.js";import{l as rs}from"./vendorService-ZY8GRgO3.js";import{l as as}from"./smsTemplateService-CbsAAioi.js";import{N as Me}from"./Navbar-B_NIHc55.js";import{a as ls}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const ts=(s,o="")=>s==null?o:String(s),ve={async getOverdueJobs(){var s;try{const{data:o,error:l}=await((s=J)==null?void 0:s.rpc("get_overdue_jobs_enhanced"));return l?(console.error("Error fetching overdue jobs:",l),{data:[],error:{message:l==null?void 0:l.message}}):{data:o||[],error:null}}catch(o){return console.error("Error in getOverdueJobs service:",o),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var s,o,l,n;try{const{data:u,error:d}=await((n=(l=(o=(s=J)==null?void 0:s.from("sms_templates"))==null?void 0:o.select("*"))==null?void 0:l.eq("is_active",!0))==null?void 0:n.order("created_at",{ascending:!1}));return d?{data:[],error:{message:d==null?void 0:d.message}}:{data:u||[],error:null}}catch(u){return console.error("Error fetching SMS templates:",u),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(s){var o,l,n,u,d,c,j,v;try{const f=await((l=(o=J)==null?void 0:o.auth)==null?void 0:l.getUser()),{data:N,error:p}=await((v=(j=(c=(n=J)==null?void 0:n.from("sms_templates"))==null?void 0:c.insert([{...s,created_by:(d=(u=f==null?void 0:f.data)==null?void 0:u.user)==null?void 0:d.id}]))==null?void 0:j.select())==null?void 0:v.single());return p?{data:null,error:{message:p==null?void 0:p.message}}:{data:N,error:null}}catch(f){return console.error("Error creating SMS template:",f),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(s,o){var l,n,u,d,c,j;try{const{data:v,error:f}=await((j=(c=(d=(u=(l=J)==null?void 0:l.from("sms_templates"))==null?void 0:u.update({...o,updated_at:(n=new Date)==null?void 0:n.toISOString()}))==null?void 0:d.eq("id",s))==null?void 0:c.select())==null?void 0:j.single());return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:v,error:null}}catch(v){return console.error("Error updating SMS template:",v),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(s){var o,l,n;try{const{error:u}=await((n=(l=(o=J)==null?void 0:o.from("sms_templates"))==null?void 0:l.delete())==null?void 0:n.eq("id",s));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting SMS template:",u),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(s){var o,l,n,u,d,c,j,v,f;try{const N=await((l=(o=J)==null?void 0:o.auth)==null?void 0:l.getUser()),{data:p,error:A}=await((f=(v=(d=(u=(n=J)==null?void 0:n.from("filter_presets"))==null?void 0:u.select("*"))==null?void 0:d.eq("page_type",s))==null?void 0:v.or(`user_id.eq.${(j=(c=N==null?void 0:N.data)==null?void 0:c.user)==null?void 0:j.id},is_public.eq.true`))==null?void 0:f.order("created_at",{ascending:!1}));return A?{data:[],error:{message:A==null?void 0:A.message}}:{data:p||[],error:null}}catch(N){return console.error("Error fetching filter presets:",N),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(s,o,l,n=!1){var u,d,c,j,v,f,N,p;try{const A=await((d=(u=J)==null?void 0:u.auth)==null?void 0:d.getUser()),{data:R,error:m}=await((p=(N=(f=(c=J)==null?void 0:c.from("filter_presets"))==null?void 0:f.insert([{user_id:(v=(j=A==null?void 0:A.data)==null?void 0:j.user)==null?void 0:v.id,page_type:s,name:o,filters:l,is_public:n}]))==null?void 0:N.select())==null?void 0:p.single());return m?{data:null,error:{message:m==null?void 0:m.message}}:{data:R,error:null}}catch(A){return console.error("Error saving filter preset:",A),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(s){var o,l,n;try{const{error:u}=await((n=(l=(o=J)==null?void 0:o.from("filter_presets"))==null?void 0:l.delete())==null?void 0:n.eq("id",s));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting filter preset:",u),{error:{message:"Failed to delete filter preset"}}}},async exportData(s,o={},l="staff"){var n,u;try{const{data:d,error:c}=await((n=J)==null?void 0:n.rpc("generate_export_data",{export_type:s,filters:o,user_role:l}));return c?{data:null,error:{message:c==null?void 0:c.message}}:{data:(u=d||[])==null?void 0:u.map(v=>{var p;const f=(v==null?void 0:v.export_data)||v,N={};return(p=Object==null?void 0:Object.entries(f))==null||p.forEach(([A,R])=>{typeof R=="number"?N[A]=isNaN(R)?0:R:R==null?N[A]="":N[A]=R}),{export_data:N}}),error:null}}catch(d){return console.error("Error exporting data:",d),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(s,o,l=null){var n,u,d,c;try{if(!s||(s==null?void 0:s.length)===0)throw new Error("No data to export");let j="";if(l)j+=(l==null?void 0:l.join(","))+`
`;else{const N=((n=s==null?void 0:s[0])==null?void 0:n.export_data)||(s==null?void 0:s[0]);N&&(j+=((u=Object==null?void 0:Object.keys(N))==null?void 0:u.join(","))+`
`)}s==null||s.forEach(N=>{var R;const p=(N==null?void 0:N.export_data)||N,A=(R=Object==null?void 0:Object.values(p))==null?void 0:R.map(m=>{if(m==null)return"";if(typeof m=="number"&&isNaN(m))return"0";let E=ts(m);return E!=null&&E.includes(",")||E!=null&&E.includes('"')?`"${E==null?void 0:E.replace(/"/g,'""')}"`:E});j+=(A==null?void 0:A.join(","))+`
`});const v=new Blob([j],{type:"text/csv;charset=utf-8;"}),f=document.createElement("a");if((f==null?void 0:f.download)!==void 0){const N=URL==null?void 0:URL.createObjectURL(v);f==null||f.setAttribute("href",N),f==null||f.setAttribute("download",o),f.style.visibility="hidden",(d=document.body)==null||d.appendChild(f),f==null||f.click(),(c=document.body)==null||c.removeChild(f),URL==null||URL.revokeObjectURL(N)}return{success:!0,error:null}}catch(j){return console.error("Export to CSV error:",j),{success:!1,error:{message:(j==null?void 0:j.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(s,o){var l,n,u,d,c;try{const j=await((n=(l=J)==null?void 0:l.auth)==null?void 0:n.getUser()),{data:v,error:f}=await((c=J)==null?void 0:c.rpc("bulk_update_jobs",{job_ids:s,updates:o,performed_by:(d=(u=j==null?void 0:j.data)==null?void 0:u.user)==null?void 0:d.id}));return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:(v==null?void 0:v[0])||null,error:null}}catch(j){return console.error("Error in bulk update jobs:",j),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var s,o,l,n,u,d,c;try{const j=await((o=(s=J)==null?void 0:s.auth)==null?void 0:o.getUser()),{data:v,error:f}=await((c=(n=(l=J)==null?void 0:l.from("notification_preferences"))==null?void 0:n.select("*"))==null?void 0:c.eq("user_id",(d=(u=j==null?void 0:j.data)==null?void 0:u.user)==null?void 0:d.id));return f?{data:[],error:{message:f==null?void 0:f.message}}:{data:v||[],error:null}}catch(j){return console.error("Error fetching notification preferences:",j),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(s){var o,l,n,u,d,c,j,v,f,N;try{const p=await((l=(o=J)==null?void 0:o.auth)==null?void 0:l.getUser());await((j=(u=(n=J)==null?void 0:n.from("notification_preferences"))==null?void 0:u.delete())==null?void 0:j.eq("user_id",(c=(d=p==null?void 0:p.data)==null?void 0:d.user)==null?void 0:c.id));const A=s==null?void 0:s.map(E=>{var q,z;return{...E,user_id:(z=(q=p==null?void 0:p.data)==null?void 0:q.user)==null?void 0:z.id}}),{data:R,error:m}=await((N=(f=(v=J)==null?void 0:v.from("notification_preferences"))==null?void 0:f.insert(A))==null?void 0:N.select());return m?{data:null,error:{message:m==null?void 0:m.message}}:{data:R,error:null}}catch(p){return console.error("Error updating notification preferences:",p),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(s){var o,l,n;try{return(n=(l=(o=J)==null?void 0:o.channel("overdue-jobs"))==null?void 0:l.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},d=>{var c;(c=this.getOverdueJobs())==null||c.then(j=>{j!=null&&j.data&&s(j==null?void 0:j.data)})}))==null?void 0:n.subscribe()}catch(u){return console.error("Error subscribing to overdue jobs:",u),null}},async searchWithFilters(s,o,l){var n,u,d;try{let c=(n=J)==null?void 0:n.from(l);if(s)switch(l){case"jobs":c=c==null?void 0:c.or(`job_number.ilike.%${s}%,title.ilike.%${s}%`);break;case"vehicles":c=c==null?void 0:c.or(`vin.ilike.%${s}%,make.ilike.%${s}%,model.ilike.%${s}%`);break;case"vendors":c=c==null?void 0:c.or(`name.ilike.%${s}%,specialty.ilike.%${s}%`);break}(u=Object==null?void 0:Object.entries(o))==null||u.forEach(([f,N])=>{N!=null&&N!==""&&(Array!=null&&Array.isArray(N)?c=c==null?void 0:c.in(f,N):typeof N=="object"&&(N==null?void 0:N.min)!==void 0?c=c==null?void 0:c.gte(f,N==null?void 0:N.min):typeof N=="object"&&(N==null?void 0:N.max)!==void 0?c=c==null?void 0:c.lte(f,N==null?void 0:N.max):c=c==null?void 0:c.eq(f,N))});const{data:j,error:v}=await((d=c==null?void 0:c.select("*"))==null?void 0:d.order("created_at",{ascending:!1}));return v?{data:[],error:{message:v==null?void 0:v.message}}:{data:j||[],error:null}}catch(c){return console.error("Error in search with filters:",c),{data:[],error:{message:"Failed to search with filters"}}}}},ns=({exportType:s,filters:o={},selectedIds:l=[],onExportStart:n,onExportComplete:u,onExportError:d,disabled:c=!1,variant:j="outline",size:v="sm",className:f=""})=>{var O;const[N,p]=I.useState(!1),[A,R]=I.useState(!1),[m,E]=I.useState("csv"),[q,z]=I.useState("filtered"),{user:t,userProfile:D}=Ee(),x=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],G=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(l==null?void 0:l.length)>0?[{value:"selected",label:`Selected (${l==null?void 0:l.length})`}]:[]],M=()=>{var W,ne,H;const Y=(H=(ne=(W=new Date)==null?void 0:W.toISOString())==null?void 0:ne.split("T"))==null?void 0:H[0];return`${s}-${q==="selected"?"selected":q}-${Y}.${m}`},X=async()=>{var Y,xe,W,ne;if(!N)try{p(!0),n&&n();let H={...o};q==="selected"&&(l==null?void 0:l.length)>0&&(H.ids=l),q==="all"&&(H={});const y=await(ve==null?void 0:ve.exportData(s,H,(D==null?void 0:D.role)||"staff"));if(y!=null&&y.error)throw new Error((Y=y==null?void 0:y.error)==null?void 0:Y.message);if(!(y!=null&&y.data)||((xe=y==null?void 0:y.data)==null?void 0:xe.length)===0)throw new Error("No data found to export");const ie=M(),B=await(ve==null?void 0:ve.exportToCSV(y==null?void 0:y.data,ie));if(B!=null&&B.error)throw new Error((W=B==null?void 0:B.error)==null?void 0:W.message);R(!1),u&&u((ne=y==null?void 0:y.data)==null?void 0:ne.length,ie)}catch(H){console.error("Export error:",H),d&&d((H==null?void 0:H.message)||"Export failed")}finally{p(!1)}},S=()=>{switch(s){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(K,{variant:j,size:v,onClick:()=>R(!A),disabled:c||N,iconName:N?void 0:"Download",iconPosition:"left",className:`${f} ${N?"cursor-wait":""}`,"aria-label":`Export ${S()}`,children:N?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${S()}`}),A&&!N&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ce,{value:m,onChange:E,options:x,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ce,{value:q,onChange:z,options:G,className:"w-full"})]}),q==="filtered"&&((O=Object==null?void 0:Object.keys(o))==null?void 0:O.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx($e,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),q==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx($e,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",l==null?void 0:l.length," selected record",(l==null?void 0:l.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(K,{variant:"ghost",size:"sm",onClick:()=>R(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(K,{size:"sm",onClick:X,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${S()}`,children:"Export"})]})]})})]})},Ie={async getVehicles(s={},o=null){var l,n,u,d;try{let c=(u=(n=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:n.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:u.order("created_at",{ascending:!1});return o&&(c=c==null?void 0:c.eq("org_id",o)),s!=null&&s.status&&(c=c==null?void 0:c.eq("vehicle_status",s==null?void 0:s.status)),s!=null&&s.make&&(c=c==null?void 0:c.eq("make",s==null?void 0:s.make)),s!=null&&s.year&&(c=c==null?void 0:c.eq("year",s==null?void 0:s.year)),s!=null&&s.search&&(c=c==null?void 0:c.or(`vin.ilike.%${s==null?void 0:s.search}%,make.ilike.%${s==null?void 0:s.search}%,model.ilike.%${s==null?void 0:s.search}%,license_plate.ilike.%${s==null?void 0:s.search}%,owner_name.ilike.%${s==null?void 0:s.search}%,owner_phone.ilike.%${s==null?void 0:s.search}%,owner_email.ilike.%${s==null?void 0:s.search}%,stock_number.ilike.%${s==null?void 0:s.search}%`)),{data:await _e(c,"vehicles:getVehicles")||[],error:null}}catch(c){return(d=c==null?void 0:c.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(s,o=null){var l,n,u,d,c;try{let j=(d=(u=(n=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:n.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:u.eq("id",s))==null?void 0:d.single();return o&&(j=j==null?void 0:j.eq("org_id",o)),{data:await _e(j,"vehicles:getVehicleById"),error:null}}catch(j){return(c=j==null?void 0:j.message)!=null&&c.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(s){var o,l,n,u,d,c,j,v,f,N;try{const{data:p,error:A}=await((f=(v=(j=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:j.insert([{...s,created_by:(c=(d=(u=await((n=(l=J)==null?void 0:l.auth)==null?void 0:n.getUser()))==null?void 0:u.data)==null?void 0:d.user)==null?void 0:c.id}]))==null?void 0:v.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:f.single());return A?{data:null,error:{message:A==null?void 0:A.message}}:{data:p,error:null}}catch(p){return(N=p==null?void 0:p.message)!=null&&N.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(s){var o,l,n,u;try{const{data:d,error:c}=await((u=(n=(l=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:l.insert([s]))==null?void 0:n.select())==null?void 0:u.single());if(c)throw console.error("Vehicle creation error:",c),new Error(c.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",d),d}catch(d){throw console.error("Error in vehicleService.create:",d),d}},async createVehicleWithProducts(s){var o,l;try{console.log("Creating vehicle with products:",s);const n=`vehicle_${Date.now()}`;await new Promise(d=>setTimeout(d,1e3));const u={id:n,...s,created_at:(o=new Date)==null?void 0:o.toISOString(),initial_products_count:((l=s==null?void 0:s.initial_products)==null?void 0:l.length)||0,estimated_aftermarket_value:(s==null?void 0:s.total_initial_product_value)||0};return console.log("Vehicle created successfully:",u),u}catch(n){throw console.error("Error creating vehicle with products:",n),n}},async checkStockNumberExists(s){var o,l,n,u;if(!(s!=null&&s.trim()))return!1;try{const{data:d,error:c}=await((u=(n=(l=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:n.eq("stock_number",s==null?void 0:s.trim()))==null?void 0:u.maybeSingle());return c?(console.error("Stock number check error:",c),!1):!!d}catch(d){return console.error("Error checking stock number:",d),!1}},async checkVinExists(s){var o,l,n,u;if(!(s!=null&&s.trim()))return!1;try{const{data:d,error:c}=await((u=(n=(l=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:n.eq("vin",s==null?void 0:s.trim()))==null?void 0:u.maybeSingle());return c?(console.error("VIN check error:",c),!1):!!d}catch(d){return console.error("Error checking VIN:",d),!1}},async updateVehicle(s,o){var l,n,u,d,c,j,v;try{const{data:f,error:N}=await((j=(c=(d=(u=(l=J)==null?void 0:l.from("vehicles"))==null?void 0:u.update({...o,updated_at:(n=new Date)==null?void 0:n.toISOString()}))==null?void 0:d.eq("id",s))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:j.single());return N?{data:null,error:{message:N==null?void 0:N.message}}:{data:f,error:null}}catch(f){return(v=f==null?void 0:f.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(s){var o,l,n,u;try{const{error:d}=await((n=(l=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:l.delete())==null?void 0:n.eq("id",s));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return(u=d==null?void 0:d.message)!=null&&u.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(s=null){var o,l,n,u,d,c,j;try{let v=(l=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:l.select("vehicle_status");s&&(v=v==null?void 0:v.eq("org_id",s));const f=await _e(v,"vehicles:getVehicleStats");return{data:{total:(f==null?void 0:f.length)||0,active:((n=f==null?void 0:f.filter(p=>(p==null?void 0:p.vehicle_status)==="active"))==null?void 0:n.length)||0,maintenance:((u=f==null?void 0:f.filter(p=>(p==null?void 0:p.vehicle_status)==="maintenance"))==null?void 0:u.length)||0,retired:((d=f==null?void 0:f.filter(p=>(p==null?void 0:p.vehicle_status)==="retired"))==null?void 0:d.length)||0,sold:((c=f==null?void 0:f.filter(p=>(p==null?void 0:p.vehicle_status)==="sold"))==null?void 0:c.length)||0},error:null}}catch(v){return(j=v==null?void 0:v.message)!=null&&j.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(s={}){return await this.getVehicles(s)}};function cs({isOpen:s,onClose:o,onSuccess:l}){var g,F,T;const{user:n}=Ee(),{orgId:u}=Ue()||{},[d,c]=I.useState(1),[j,v]=I.useState(!1),[f,N]=I.useState(""),[p,A]=I.useState(!1),[R,m]=I.useState(!1),[E,q]=I.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),z={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(g=new Date)==null?void 0:g.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[t,D]=I.useState(z),[x,G]=I.useState([]),M=async(a=0)=>{var k,P;try{q(_=>({..._,loading:!0,error:null,retryCount:a}));const[se,ee,Z,r,h]=await Promise.all([Fe().catch(()=>[]),Ae().catch(()=>[]),Re().catch(()=>[]),Be({activeOnly:!0}).catch(()=>[]),Ve({activeOnly:!0}).catch(()=>[])]);q({salesConsultants:se,deliveryCoordinators:ee,financeManagers:Z,vendors:r,products:h==null?void 0:h.map(_=>({..._,unitPrice:_==null?void 0:_.unit_price})),loading:!1,error:null,retryCount:a})}catch(se){if(console.error("Failed to load dropdown data:",se),a<2&&((k=se==null?void 0:se.message)!=null&&k.includes("fetch")||(P=se==null?void 0:se.message)!=null&&P.includes("network"))){setTimeout(()=>M(a+1),1e3*(a+1));return}q(ee=>({...ee,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:a}))}},X=({checked:a,onChange:k})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!a,onChange:P=>{var ee;const se=!!((ee=P==null?void 0:P.target)!=null&&ee.checked);k(se)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),S=({label:a,options:k,value:P,onChange:se,placeholder:ee,required:Z=!1,helpText:r,testId:h})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[a," ",Z&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:P||"",onChange:_=>{var V;return se(((V=_==null?void 0:_.target)==null?void 0:V.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:E==null?void 0:E.loading,required:Z,"data-testid":h,children:[e.jsx("option",{value:"",children:ee}),k==null?void 0:k.map(_=>e.jsx("option",{value:_==null?void 0:_.id,children:(_==null?void 0:_.full_name)||(_==null?void 0:_.label)||(_==null?void 0:_.name)},_==null?void 0:_.id))]}),r&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:r}),(k==null?void 0:k.length)===0&&!(E!=null&&E.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-red-500",children:["No ",a==null?void 0:a.toLowerCase()," found. Please check your database connection."]})]});I.useEffect(()=>{const a=(t==null?void 0:t.customerName)!==(z==null?void 0:z.customerName)||(t==null?void 0:t.customerPhone)!==(z==null?void 0:z.customerPhone)||(t==null?void 0:t.customerEmail)!==(z==null?void 0:z.customerEmail)||(t==null?void 0:t.needsLoaner)!==(z==null?void 0:z.needsLoaner)||(t==null?void 0:t.assignedTo)!==(z==null?void 0:z.assignedTo)||(t==null?void 0:t.deliveryCoordinator)!==(z==null?void 0:z.deliveryCoordinator)||(t==null?void 0:t.financeManager)!==(z==null?void 0:z.financeManager)||(x==null?void 0:x.length)>0;A(a)},[t,x]),I.useEffect(()=>{s&&M()},[s]);const O=()=>{G(a=>[...a,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},Y=(a,k,P)=>{var se;if(G(ee=>ee==null?void 0:ee.map(Z=>{if((Z==null?void 0:Z.id)===a){let r={...Z,[k]:P};return k==="requiresScheduling"&&(P===!0?r.noScheduleReason="":r.promisedDate=""),r}return Z})),k==="productId"&&P){const ee=(se=E==null?void 0:E.products)==null?void 0:se.find(Z=>(Z==null?void 0:Z.id)===P);ee&&G(Z=>Z==null?void 0:Z.map(r=>(r==null?void 0:r.id)===a?{...r,unitPrice:(ee==null?void 0:ee.unitPrice)||""}:r))}},xe=a=>{G(k=>k==null?void 0:k.filter(P=>(P==null?void 0:P.id)!==a))},W=()=>{var a,k;return((k=(a=t==null?void 0:t.customerName)==null?void 0:a.trim())==null?void 0:k.length)>0},ne=()=>(x==null?void 0:x.length)===0?!1:x==null?void 0:x.every(a=>{var k;return!(!(a!=null&&a.productId)||!(a!=null&&a.unitPrice)||a!=null&&a.requiresScheduling&&!(a!=null&&a.promisedDate)||!(a!=null&&a.requiresScheduling)&&!((k=a==null?void 0:a.noScheduleReason)!=null&&k.trim())||(a==null?void 0:a.serviceType)==="vendor"&&!(a!=null&&a.vendorId))}),H=()=>x==null?void 0:x.reduce((a,k)=>a+(parseFloat(k==null?void 0:k.unitPrice)||0),0),y=async()=>{var a,k,P,se,ee,Z,r,h,_,V;if(!W()){N("Customer name is required to save draft");return}v(!0),N("");try{const U={year:(t==null?void 0:t.vehicleYear)||((a=new Date)==null?void 0:a.getFullYear()),make:(t==null?void 0:t.vehicleMake)||"TBD",model:(t==null?void 0:t.vehicleModel)||"TBD",owner_name:(k=t==null?void 0:t.customerName)==null?void 0:k.trim(),owner_phone:((P=t==null?void 0:t.customerPhone)==null?void 0:P.trim())||null,owner_email:((se=t==null?void 0:t.customerEmail)==null?void 0:se.trim())||null,stock_number:((ee=t==null?void 0:t.stockNumber)==null?void 0:ee.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},le=await Ie.create(U),te={title:`Draft Deal - ${(Z=t==null?void 0:t.customerName)==null?void 0:Z.trim()}`,description:`Draft deal for ${(r=t==null?void 0:t.customerName)==null?void 0:r.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:le==null?void 0:le.id,assigned_to:(t==null?void 0:t.assignedTo)||(n==null?void 0:n.id),delivery_coordinator_id:(t==null?void 0:t.deliveryCoordinator)||null,finance_manager_id:(t==null?void 0:t.financeManager)||null,customer_needs_loaner:!!(t!=null&&t.needsLoaner),customerName:(h=t==null?void 0:t.customerName)==null?void 0:h.trim(),customerPhone:((_=t==null?void 0:t.customerPhone)==null?void 0:_.trim())||"",customerEmail:((V=t==null?void 0:t.customerEmail)==null?void 0:V.trim())||"",org_id:u||void 0,lineItems:[]};await Le.createDeal(te),l==null||l(),B(),o()}catch(U){N(`Failed to save draft: ${U==null?void 0:U.message}`)}finally{v(!1)}},ie=async()=>{var a,k,P,se,ee,Z,r,h,_,V,U,le;if(!W()||!ne()){N("Please complete all required fields");return}v(!0),N("");try{const te={year:(t==null?void 0:t.vehicleYear)||((a=new Date)==null?void 0:a.getFullYear()),make:(t==null?void 0:t.vehicleMake)||"TBD",model:(t==null?void 0:t.vehicleModel)||"TBD",owner_name:(k=t==null?void 0:t.customerName)==null?void 0:k.trim(),owner_phone:((P=t==null?void 0:t.customerPhone)==null?void 0:P.trim())||null,owner_email:((se=t==null?void 0:t.customerEmail)==null?void 0:se.trim())||null,stock_number:((ee=t==null?void 0:t.stockNumber)==null?void 0:ee.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},he=await Ie.create(te),de=H(),b=(x==null?void 0:x.some(C=>(C==null?void 0:C.serviceType)==="vendor"))?"vendor":"in_house",w=((Z=x==null?void 0:x.find(C=>C==null?void 0:C.vendorId))==null?void 0:Z.vendorId)||null;let L=null;if(b==="vendor"){const C=(x||[]).filter(ce=>(ce==null?void 0:ce.serviceType)==="vendor"&&(ce==null?void 0:ce.requiresScheduling)&&(ce==null?void 0:ce.promisedDate)).map(ce=>new Date(ce==null?void 0:ce.promisedDate)).sort((ce,Se)=>ce-Se);L=(r=(C==null?void 0:C[0])||new Date)==null?void 0:r.toISOString()}const re=(x||[]).map(C=>({product_id:C==null?void 0:C.productId,quantity_used:1,unit_price:parseFloat((C==null?void 0:C.unitPrice)||0),promised_date:C!=null&&C.requiresScheduling?C==null?void 0:C.promisedDate:null,requires_scheduling:!!(C!=null&&C.requiresScheduling),no_schedule_reason:C!=null&&C.requiresScheduling?null:C==null?void 0:C.noScheduleReason,is_off_site:(C==null?void 0:C.serviceType)==="vendor"})),ae={title:`Deal - ${(h=t==null?void 0:t.customerName)==null?void 0:h.trim()}`,description:`Deal for ${(_=t==null?void 0:t.customerName)==null?void 0:_.trim()}`,job_status:"pending",service_type:b,vehicle_id:he==null?void 0:he.id,vendor_id:w,assigned_to:(t==null?void 0:t.assignedTo)||(n==null?void 0:n.id),delivery_coordinator_id:(t==null?void 0:t.deliveryCoordinator)||null,finance_manager_id:(t==null?void 0:t.financeManager)||null,customer_needs_loaner:!!(t!=null&&t.needsLoaner),scheduled_start_time:L,estimated_cost:de,org_id:u||void 0,customerName:(V=t==null?void 0:t.customerName)==null?void 0:V.trim(),customerPhone:((U=t==null?void 0:t.customerPhone)==null?void 0:U.trim())||"",customerEmail:((le=t==null?void 0:t.customerEmail)==null?void 0:le.trim())||"",lineItems:re},$=await Le.createDeal(ae);await Le.updateDeal($==null?void 0:$.id,ae),l==null||l(),B(),o()}catch(te){N(`Failed to create deal: ${te==null?void 0:te.message}`)}finally{v(!1)}},B=()=>{c(1),D(z),G([]),N(""),A(!1)},oe=()=>{p?m(!0):(B(),o())},be=()=>{m(!1),B(),o()};return s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:oe,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(Q,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${d>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${d>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[f&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",f]}),e.jsx("button",{onClick:()=>N(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(Q,{name:"X",size:16})})]})}),(E==null?void 0:E.loading)&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Q,{name:"Loader",size:16,className:"mr-2 animate-spin"}),"Loading dropdown data..."]})}),(E==null?void 0:E.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",E==null?void 0:E.error]}),e.jsx("button",{onClick:()=>M(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),d===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t==null?void 0:t.customerName,onChange:a=>D(k=>{var P;return{...k,customerName:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:t==null?void 0:t.customerPhone,onChange:a=>D(k=>{var P;return{...k,customerPhone:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:t==null?void 0:t.customerEmail,onChange:a=>D(k=>{var P;return{...k,customerEmail:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(t==null?void 0:t.vehicleYear)||"",onChange:a=>D(k=>{var P;return{...k,vehicleYear:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((F=new Date)==null?void 0:F.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.vehicleMake)||"",onChange:a=>D(k=>{var P;return{...k,vehicleMake:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.vehicleModel)||"",onChange:a=>D(k=>{var P;return{...k,vehicleModel:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.stockNumber)||"",onChange:a=>D(k=>{var P;return{...k,stockNumber:(P=a==null?void 0:a.target)==null?void 0:P.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(X,{checked:t==null?void 0:t.needsLoaner,onChange:a=>{D(k=>({...k,needsLoaner:!!a}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(S,{label:"Sales Consultant",options:E==null?void 0:E.salesConsultants,value:t==null?void 0:t.assignedTo,onChange:a=>D(k=>({...k,assignedTo:a})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(S,{label:"Delivery Coordinator",options:E==null?void 0:E.deliveryCoordinators,value:t==null?void 0:t.deliveryCoordinator,onChange:a=>D(k=>({...k,deliveryCoordinator:a})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(S,{label:"Finance Manager",options:E==null?void 0:E.financeManagers,value:t==null?void 0:t.financeManager,onChange:a=>D(k=>({...k,financeManager:a})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),d===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(K,{onClick:O,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(Q,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(x==null?void 0:x.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(Q,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[x==null?void 0:x.map((a,k)=>{var P,se,ee,Z,r;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",k+1]}),e.jsx("button",{onClick:()=>xe(a==null?void 0:a.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(Q,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(a==null?void 0:a.productId)||"",onChange:h=>{var _;return Y(a==null?void 0:a.id,"productId",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${k}`,children:[e.jsx("option",{value:"",children:"Select product"}),(P=E==null?void 0:E.products)==null?void 0:P.map(h=>e.jsx("option",{value:h==null?void 0:h.id,children:h==null?void 0:h.label},h==null?void 0:h.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:a==null?void 0:a.unitPrice,onChange:h=>{var _;return Y(a==null?void 0:a.id,"unitPrice",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${k}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${a==null?void 0:a.id}`,value:"in_house",checked:(a==null?void 0:a.serviceType)==="in_house",onChange:h=>{var _;return Y(a==null?void 0:a.id,"serviceType",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${a==null?void 0:a.id}`,value:"vendor",checked:(a==null?void 0:a.serviceType)==="vendor",onChange:h=>{var _;return Y(a==null?void 0:a.id,"serviceType",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(a==null?void 0:a.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(a==null?void 0:a.vendorId)||"",onChange:h=>{var _;return Y(a==null?void 0:a.id,"vendorId",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(se=E==null?void 0:E.vendors)==null?void 0:se.map(h=>e.jsx("option",{value:h==null?void 0:h.id,children:h==null?void 0:h.label},h==null?void 0:h.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${a==null?void 0:a.id}`,checked:(a==null?void 0:a.requiresScheduling)===!0,onChange:()=>Y(a==null?void 0:a.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${k}`,"data-testid":`requires-scheduling-${k}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${a==null?void 0:a.id}`,checked:(a==null?void 0:a.requiresScheduling)===!1,onChange:()=>Y(a==null?void 0:a.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${k}`}),"No Scheduling Needed"]})]}),a!=null&&a.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:a==null?void 0:a.promisedDate,onChange:h=>{var _;return Y(a==null?void 0:a.id,"promisedDate",(_=h==null?void 0:h.target)==null?void 0:_.value)},min:(r=(Z=(ee=new Date)==null?void 0:ee.toISOString())==null?void 0:Z.split("T"))==null?void 0:r[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a==null?void 0:a.noScheduleReason,onChange:h=>{var _;return Y(a==null?void 0:a.id,"noScheduleReason",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:a==null?void 0:a.serviceNotes,onChange:h=>{var _;return Y(a==null?void 0:a.id,"serviceNotes",(_=h==null?void 0:h.target)==null?void 0:_.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},a==null?void 0:a.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(T=H())==null?void 0:T.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[x==null?void 0:x.length," item",(x==null?void 0:x.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:d===2&&e.jsx(K,{onClick:()=>c(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(K,{onClick:oe,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),d===1&&e.jsxs(e.Fragment,{children:[e.jsx(K,{onClick:y,disabled:!W()||j,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:j?"Saving...":"Save Draft"}),e.jsx(K,{onClick:()=>c(2),disabled:!W(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),d===2&&e.jsx(K,{onClick:ie,disabled:!W()||!ne()||j,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:j?"Creating...":"Create Deal"})]})]})}),R&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{variant:"outline",onClick:()=>m(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(K,{onClick:be,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function is(s,{activeOnly:o=!0}={}){let l=J.from("products").select("*").order("name",{ascending:!0});o&&(l=l.eq("is_active",!0)),s&&(l=l.or(`org_id.eq.${s},org_id.is.null`));const n=await _e(l,"products:listByOrg");return ss(n,{labelKey:"name",valueKey:"id"})}function os(s,{activeOnly:o=!0}={}){let l=J.from("user_profiles").select("*").order("full_name",{ascending:!0});return o&&(l=l.eq("is_active",!0)),s&&(l=l.eq("org_id",s)),_e(l,"staff:listByOrg")}function Ye(s={}){var q,z,t,D;const{loadOnMount:o=!0,cacheTime:l=5*60*1e3}=s,[n,u]=I.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[d,c]=I.useState(null),j=Ue(),v=Ee(),f=async()=>{var x,G,M,X;try{if(j.loading)return;if(u(B=>({...B,loading:!0,error:null})),!((x=j.session)!=null&&x.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),u(B=>({...B,loading:!1}));return}const S=!!j.orgId,O=[(G=Ae())==null?void 0:G.catch(B=>(console.error("[dropdowns:dc] Delivery coordinators failed:",B),[])),(M=Fe())==null?void 0:M.catch(B=>(console.error("[dropdowns:sales] Sales consultants failed:",B),[])),(X=Re())==null?void 0:X.catch(B=>(console.error("[dropdowns:finance] Finance managers failed:",B),[])),S?os(j.orgId).catch(B=>(console.error("[dropdowns:users] tenant staff failed:",B),[])):Ke({activeOnly:!0}).catch(B=>(console.error("[dropdowns:users] global user profiles failed:",B),[])),S?rs(j.orgId).catch(B=>(console.error("[dropdowns:vendors] tenant vendors failed:",B),[])):Be({activeOnly:!0}).catch(B=>(console.error("[dropdowns:vendors] global vendors failed:",B),[])),S?is(j.orgId).catch(B=>(console.error("[dropdowns:products] tenant products failed:",B),[])):Ve({activeOnly:!0}).catch(B=>(console.error("[dropdowns:products] global products failed:",B),[])),S?as(j.orgId).catch(B=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",B),[])):Promise.resolve([])],[Y,xe,W,ne,H,y,ie]=await Promise.all(O);u({dc:Y,sales:xe,finance:W,users:ne,vendors:H,products:y,smsTemplates:ie,loading:!1,error:null,searchResults:null}),c(Date.now())}catch(S){u({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(S==null?void 0:S.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",S)}},N=()=>d?Date.now()-d<l:!1,p=async()=>{N()||await f()},A=async x=>{try{if(!(x!=null&&x.trim())){u(M=>({...M,searchResults:null}));return}const G=await Xe(x);u(M=>({...M,searchResults:G}))}catch(G){console.error("[dropdowns:search] Search failed:",G),u(M=>({...M,searchResults:{users:[],vendors:[]}}))}},R=()=>{u(x=>({...x,searchResults:null}))},m=(x={})=>{const{roles:G=[],departments:M=[],activeOnly:X=!0}=x;let S=(n==null?void 0:n.users)||[];return X&&(S=S==null?void 0:S.filter(O=>O==null?void 0:O.is_active)),(G==null?void 0:G.length)>0&&(S=S==null?void 0:S.filter(O=>G==null?void 0:G.includes(O==null?void 0:O.role))),(M==null?void 0:M.length)>0&&(S=S==null?void 0:S.filter(O=>M==null?void 0:M.includes(O==null?void 0:O.department))),(S==null?void 0:S.map(O=>({id:O==null?void 0:O.id,value:O==null?void 0:O.id,label:O==null?void 0:O.full_name,name:O==null?void 0:O.full_name,role:O==null?void 0:O.role,department:O==null?void 0:O.department,email:O==null?void 0:O.email})))||[]},E=(x={})=>{const{activeOnly:G=!0,specialty:M=null}=x;let X=(n==null?void 0:n.vendors)||[];return G&&(X=X==null?void 0:X.filter(S=>S==null?void 0:S.is_active)),M&&(X=X==null?void 0:X.filter(S=>{var O,Y;return(Y=(O=S==null?void 0:S.specialty)==null?void 0:O.toLowerCase())==null?void 0:Y.includes(M==null?void 0:M.toLowerCase())})),(X==null?void 0:X.map(S=>({id:S==null?void 0:S.id,value:(S==null?void 0:S.value)||(S==null?void 0:S.id),label:(S==null?void 0:S.label)||(S==null?void 0:S.name),name:S==null?void 0:S.name,specialty:S==null?void 0:S.specialty,email:S==null?void 0:S.email,phone:S==null?void 0:S.phone})))||[]};return I.useEffect(()=>{let x=!0;return(async()=>{var M;if(!o)return;const G=Date.now();for(;x&&(v!=null&&v.loading)&&Date.now()-G<5e3;)await new Promise(X=>setTimeout(X,200));x&&(v!=null&&v.user?(console.log("Dropdowns: authenticated user",(M=v==null?void 0:v.user)==null?void 0:M.id),v!=null&&v.userProfile&&console.log("Dropdowns: user profile org",v.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),x&&await f())})(),()=>{x=!1}},[o,v==null?void 0:v.loading,(q=v==null?void 0:v.user)==null?void 0:q.id,j==null?void 0:j.loading,j==null?void 0:j.orgId]),{dc:n==null?void 0:n.dc,sales:n==null?void 0:n.sales,finance:n==null?void 0:n.finance,users:n==null?void 0:n.users,vendors:n==null?void 0:n.vendors,products:n==null?void 0:n.products,smsTemplates:n==null?void 0:n.smsTemplates,loading:n==null?void 0:n.loading,error:n==null?void 0:n.error,searchResults:n==null?void 0:n.searchResults,globalSearch:A,clearSearch:R,getUserOptions:m,getVendorOptions:E,refresh:f,refreshIfNeeded:p,lastUpdate:d,isCacheValid:N(),salesConsultantOptions:(z=(n==null?void 0:n.sales)||[])==null?void 0:z.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),deliveryCoordinatorOptions:(t=(n==null?void 0:n.dc)||[])==null?void 0:t.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),financeManagerOptions:(D=(n==null?void 0:n.finance)||[])==null?void 0:D.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name}))}}const ds=()=>{var v,f,N;const{dc:s,sales:o,finance:l,vendors:n,products:u,loading:d,error:c,refresh:j}=Ye({loadOnMount:!0});return{salesConsultants:o,deliveryCoordinators:s,financeManagers:l,vendors:n,products:u,loading:d,error:c,refresh:j,salesConsultantOptions:(v=o||[])==null?void 0:v.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),deliveryCoordinatorOptions:(f=s||[])==null?void 0:f.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),financeManagerOptions:(N=l||[])==null?void 0:N.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),vendorOptions:n||[],productOptions:u||[]}},us=()=>(He.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),we=({options:s=[],value:o,onChange:l,placeholder:n="Select...",searchable:u=!1,clearable:d=!1,disabled:c=!1,loading:j=!1,error:v=null,className:f="",optionLabel:N="label",optionValue:p="value",groupBy:A=null,renderOption:R=null,label:m="",helperText:E=""})=>{const[q,z]=I.useState(!1),[t,D]=I.useState(""),[x,G]=I.useState(!1),[M,X]=I.useState(s),[S,O]=I.useState(-1),[Y,xe]=I.useState({top:0,left:0,width:0}),W=I.useRef(null),ne=I.useRef(null);I.useRef(null),I.useEffect(()=>{G((()=>{var a;return(a=window.matchMedia("(max-width: 767px)"))==null?void 0:a.matches})());const F=window.matchMedia("(max-width: 767px)"),T=()=>G(F==null?void 0:F.matches);return F==null||F.addEventListener("change",T),()=>F==null?void 0:F.removeEventListener("change",T)},[]),I.useEffect(()=>{if(!(t!=null&&t.trim())){X(s);return}const g=t==null?void 0:t.toLowerCase(),F=s==null?void 0:s.filter(T=>{const a=[T==null?void 0:T.name,T==null?void 0:T.displayName,T==null?void 0:T.category,T==null?void 0:T.brand,T==null?void 0:T.specialty,T==null?void 0:T.department,T==null?void 0:T.email].filter(Boolean);return a==null?void 0:a.some(k=>{var P;return(P=k==null?void 0:k.toLowerCase())==null?void 0:P.includes(g)})});X(F),O(-1)},[t,s]);const H=s==null?void 0:s.find(g=>(g==null?void 0:g.id)===o),y=g=>((g==null?void 0:g[p])||(g==null?void 0:g.id))===o,ie=()=>{var g;if(W!=null&&W.current){const F=(g=W==null?void 0:W.current)==null?void 0:g.getBoundingClientRect();xe({top:(F==null?void 0:F.bottom)+window.scrollY,left:(F==null?void 0:F.left)+window.scrollX,width:F==null?void 0:F.width})}};I.useEffect(()=>{q&&!x&&ie()},[q,x]),I.useEffect(()=>{if(x)return;const g=F=>{var T;W!=null&&W.current&&!((T=W==null?void 0:W.current)!=null&&T.contains(F==null?void 0:F.target))&&(z(!1),D(""),O(-1))};return document==null||document.addEventListener("mousedown",g),()=>document==null?void 0:document.removeEventListener("mousedown",g)},[x]);const B=g=>{if(!x){if(!q){((g==null?void 0:g.key)==="Enter"||(g==null?void 0:g.key)===" "||(g==null?void 0:g.key)==="ArrowDown")&&(g==null||g.preventDefault(),z(!0),u&&setTimeout(()=>{var F;return(F=ne==null?void 0:ne.current)==null?void 0:F.focus()},0));return}switch(g==null?void 0:g.key){case"Escape":z(!1),D(""),O(-1);break;case"ArrowDown":g==null||g.preventDefault(),O(F=>F<(M==null?void 0:M.length)-1?F+1:0);break;case"ArrowUp":g==null||g.preventDefault(),O(F=>F>0?F-1:(M==null?void 0:M.length)-1);break;case"Enter":g==null||g.preventDefault(),S>=0&&(M!=null&&M[S])&&oe(M==null?void 0:M[S]);break;case"Tab":z(!1),D(""),O(-1);break}}},oe=g=>{l==null||l(g==null?void 0:g.id),z(!1),D(""),O(-1)},be=g=>{g==null||g.stopPropagation(),l==null||l(null)};return x?e.jsxs("div",{className:`relative ${f}`,children:[e.jsxs("select",{value:o||"",onChange:g=>{var F;return l==null?void 0:l(((F=g==null?void 0:g.target)==null?void 0:F.value)||null)},disabled:c||j,className:`
            w-full px-3 py-2 border rounded-lg
            ${v?"border-red-500":"border-gray-300"}
            ${c||j?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:n}),s==null?void 0:s.map(g=>e.jsx("option",{value:(g==null?void 0:g[p])||(g==null?void 0:g.id),children:(g==null?void 0:g[N])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[p])||(g==null?void 0:g.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(Q,{name:"ChevronDown",size:16,className:"text-gray-400"})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]}):e.jsxs("div",{className:`relative ${f}`,ref:W,children:[e.jsxs("button",{type:"button",onClick:()=>!c&&!j&&z(!q),onKeyDown:B,disabled:c||j,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${v?"border-red-500":"border-gray-300"}
          ${c||j?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${q?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:H?"text-gray-900":"text-gray-500",children:H?(H==null?void 0:H[N])||(H==null?void 0:H.label):n}),e.jsxs("div",{className:"flex items-center space-x-1",children:[j&&e.jsx(Q,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),d&&H&&!j&&e.jsx("button",{type:"button",onClick:be,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(Q,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(Q,{name:q?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),q&&typeof window<"u"&&e.jsx(us,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>z(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${Y==null?void 0:Y.top}px`,left:`${Y==null?void 0:Y.left}px`,width:`${Y==null?void 0:Y.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:g=>g==null?void 0:g.stopPropagation(),children:[u&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:t,onChange:g=>{var F;return D((F=g==null?void 0:g.target)==null?void 0:F.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(M==null?void 0:M.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:t?"No results found":"No options available"}):M==null?void 0:M.map(g=>e.jsx("button",{type:"button",onClick:()=>oe(g),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${y(g)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(g==null?void 0:g[N])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[p])||(g==null?void 0:g.id)))})]})})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]})},hs=({isOpen:s,dealId:o,onClose:l,onSuccess:n})=>{var _,V,U,le,te,he,de;const[u,d]=I.useState(!0),[c,j]=I.useState(!1),[v,f]=I.useState(""),[N,p]=I.useState(!1),[A,R]=I.useState(!1),[m,E]=I.useState(!1),[q,z]=I.useState(!1),[t,D]=I.useState(null),[x,G]=I.useState(null),[M,X]=I.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:S,deliveryCoordinatorOptions:O,financeManagerOptions:Y,vendorOptions:xe,productOptions:W,loading:ne,refresh:H}=ds(),[y,ie]=I.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]});I.useEffect(()=>{if(t){const i=JSON.stringify(y)!==JSON.stringify(t);E(i)}},[y,t]),I.useEffect(()=>{if(s)try{H==null||H()}catch{}},[s,H]),I.useEffect(()=>{s&&o&&g()},[s,o]);const B=({checked:i,onChange:b})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!i,onChange:w=>{var L;return b(!!((L=w==null?void 0:w.target)!=null&&L.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),oe=({value:i,selectedValue:b,onChange:w,itemIndex:L,disabled:re=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${L}`,value:"in_house",checked:!b,onChange:()=>w(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:re}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${L}`,value:"vendor",checked:b,onChange:()=>w(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:re}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),be=({requiresScheduling:i,onChange:b,itemIndex:w,disabled:L=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${w}`,checked:i===!0,onChange:()=>b(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:L}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${w}`,checked:i===!1,onChange:()=>b(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:L}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),g=async()=>{var i,b,w,L,re,ae,$,C,ce,Se;try{d(!0),f("");const ye=await We(o),je=Ge(ye),{data:fe}=await((L=(w=(b=(i=J)==null?void 0:i.from("transactions"))==null?void 0:b.select("customer_name, customer_phone, customer_email"))==null?void 0:w.eq("job_id",o))==null?void 0:L.single());let me=null;try{const{data:pe}=await((ce=(C=($=(ae=(re=J)==null?void 0:re.from("loaner_assignments"))==null?void 0:ae.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:$.eq("job_id",o))==null?void 0:C.is("returned_at",null))==null?void 0:ce.limit(1));me=Array.isArray(pe)?pe[0]:pe}catch{}const Ne={...je,customerName:(fe==null?void 0:fe.customer_name)||"",customerPhone:(fe==null?void 0:fe.customer_phone)||"",customerEmail:(fe==null?void 0:fe.customer_email)||"",lineItems:((Se=(je==null?void 0:je.lineItems)||[])==null?void 0:Se.length)>0?je==null?void 0:je.lineItems:[F()]};if(ie(Ne),D(JSON.parse(JSON.stringify(Ne))),G(me||null),me)X({loaner_number:(me==null?void 0:me.loaner_number)||"",eta_return_date:(me==null?void 0:me.eta_return_date)||"",notes:(me==null?void 0:me.notes)||""});else{const pe=((Ne==null?void 0:Ne.lineItems)||[]).filter(ge=>(ge==null?void 0:ge.requiresScheduling)&&(ge==null?void 0:ge.lineItemPromisedDate)).map(ge=>new Date(ge.lineItemPromisedDate).getTime()),Te=pe!=null&&pe.length?new Date(Math.max(...pe)):null;X(ge=>({...ge,eta_return_date:Te?Te.toISOString().split("T")[0]:""}))}}catch(ye){f(`Failed to load deal: ${ye==null?void 0:ye.message}`)}finally{d(!1)}},F=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),T=i=>{ie(b=>({...b,...i}))},a=(i,b)=>{if(ie(w=>{var L;return{...w,lineItems:(L=w==null?void 0:w.lineItems)==null?void 0:L.map((re,ae)=>{if(ae===i){let $={...re,...b};return"requiresScheduling"in b&&($.requiresScheduling=!!(b!=null&&b.requiresScheduling),(b==null?void 0:b.requiresScheduling)===!0?$.noScheduleReason="":$.lineItemPromisedDate=""),"isOffSite"in b&&($.isOffSite=!!(b!=null&&b.isOffSite),b!=null&&b.isOffSite||($.vendorId="")),$}return re})}}),b!=null&&b.product_id){const w=W==null?void 0:W.find(L=>(L==null?void 0:L.id)===(b==null?void 0:b.product_id));w&&ie(L=>{var re;return{...L,lineItems:(re=L==null?void 0:L.lineItems)==null?void 0:re.map((ae,$)=>$===i?{...ae,unit_price:(w==null?void 0:w.unitPrice)||(w==null?void 0:w.unit_price)||(ae==null?void 0:ae.unit_price),cost_price:(w==null?void 0:w.cost)||(ae==null?void 0:ae.cost_price)}:ae)}})}},k=()=>{ie(i=>({...i,lineItems:[...i==null?void 0:i.lineItems,F()]}))},P=i=>{ie(b=>{var w;return{...b,lineItems:(w=b==null?void 0:b.lineItems)==null?void 0:w.filter((L,re)=>re!==i)}})},se=async()=>{var i,b,w,L,re;try{if(j(!0),f(""),!((i=y==null?void 0:y.customerName)!=null&&i.trim())){f("Customer name is required");return}for(let $=0;$<((b=y==null?void 0:y.lineItems)==null?void 0:b.length);$++){const C=(w=y==null?void 0:y.lineItems)==null?void 0:w[$];if(!(C!=null&&C.product_id)){f(`Line item ${$+1}: Product is required`);return}if(C!=null&&C.requiresScheduling&&!(C!=null&&C.lineItemPromisedDate)){f(`Line item ${$+1}: Promised date is required when scheduling is needed`);return}if(!(C!=null&&C.requiresScheduling)&&!((L=C==null?void 0:C.noScheduleReason)!=null&&L.trim())){f(`Line item ${$+1}: Reason is required when no scheduling is needed`);return}if(C!=null&&C.isOffSite&&!(C!=null&&C.vendorId)){f(`Line item ${$+1}: Vendor is required for off-site service`);return}}const ae={...y,customer_needs_loaner:!!(y!=null&&y.customer_needs_loaner),lineItems:(re=y==null?void 0:y.lineItems)==null?void 0:re.map($=>({...$,requiresScheduling:!!($!=null&&$.requiresScheduling),isOffSite:!!($!=null&&$.isOffSite),unit_price:parseFloat($==null?void 0:$.unit_price)||0,quantity_used:parseInt($==null?void 0:$.quantity_used)||1}))};await Ze(o,{...ae,loanerForm:M}),n==null||n(),l==null||l()}catch(ae){f(`Failed to save deal: ${ae==null?void 0:ae.message}`)}finally{j(!1)}},ee=async()=>{try{R(!0),await Qe(o),n==null||n(),l==null||l()}catch(i){f(`Failed to delete deal: ${i==null?void 0:i.message}`)}finally{R(!1),p(!1)}},Z=()=>{m?z(!0):l()},r=()=>{z(!1),l()},h=()=>{var i;return((i=y==null?void 0:y.lineItems)==null?void 0:i.reduce((b,w)=>{const L=parseFloat(w==null?void 0:w.unit_price)||0,re=parseInt(w==null?void 0:w.quantity_used)||1;return b+L*re},0))||0};return s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:Z,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(Q,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[v&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:v})}),ne&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-blue-800 text-sm",children:"Loading dropdown data..."})}),u?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{g();try{H==null||H()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ce,{value:y==null?void 0:y.job_status,onChange:i=>{var b;return T({job_status:(b=i==null?void 0:i.target)==null?void 0:b.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(ue,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:y==null?void 0:y.customerName,onChange:i=>{var b;return T({customerName:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(ue,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:y==null?void 0:y.customerPhone,onChange:i=>{var b;return T({customerPhone:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(ue,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:y==null?void 0:y.customerEmail,onChange:i=>{var b;return T({customerEmail:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ce,{value:y==null?void 0:y.priority,onChange:i=>{var b;return T({priority:(b=i==null?void 0:i.target)==null?void 0:b.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(ue,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(y==null?void 0:y.vehicleYear)||"",onChange:i=>{var b;return T({vehicleYear:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"2024",min:"1900",max:((_=new Date)==null?void 0:_.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(ue,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(y==null?void 0:y.vehicleMake)||"",onChange:i=>{var b;return T({vehicleMake:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(ue,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(y==null?void 0:y.vehicleModel)||"",onChange:i=>{var b;return T({vehicleModel:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(ue,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(y==null?void 0:y.stockNumber)||"",onChange:i=>{var b;return T({stockNumber:(b=i==null?void 0:i.target)==null?void 0:b.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(B,{checked:y==null?void 0:y.customer_needs_loaner,onChange:i=>{if(T({customer_needs_loaner:i}),i&&!(M!=null&&M.eta_return_date)){const b=((y==null?void 0:y.lineItems)||[]).filter(L=>(L==null?void 0:L.requiresScheduling)&&(L==null?void 0:L.lineItemPromisedDate)).map(L=>new Date(L.lineItemPromisedDate).getTime()),w=b!=null&&b.length?new Date(Math.max(...b)):null;w&&X(L=>({...L,eta_return_date:w.toISOString().split("T")[0]}))}}}),x&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",x==null?void 0:x.loaner_number,(x==null?void 0:x.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due"," ",(V=new Date(x==null?void 0:x.eta_return_date))==null?void 0:V.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(y==null?void 0:y.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(ue,{id:"loaner-number","aria-label":"Loaner number",value:(M==null?void 0:M.loaner_number)||"",onChange:i=>X(b=>{var w;return{...b,loaner_number:(w=i==null?void 0:i.target)==null?void 0:w.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(ue,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(M==null?void 0:M.eta_return_date)||"",onChange:i=>X(b=>{var w;return{...b,eta_return_date:(w=i==null?void 0:i.target)==null?void 0:w.value}}),min:(te=(le=(U=new Date)==null?void 0:U.toISOString())==null?void 0:le.split("T"))==null?void 0:te[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ue,{id:"loaner-notes","aria-label":"Loaner notes",value:(M==null?void 0:M.notes)||"",onChange:i=>X(b=>{var w;return{...b,notes:(w=i==null?void 0:i.target)==null?void 0:w.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsx("div",{className:"mb-4","data-testid":"sales-select",children:e.jsx(we,{label:"Sales Consultant",options:S,value:y==null?void 0:y.assignedTo,onChange:i=>T({assignedTo:i}),placeholder:"Select sales consultant",searchable:!0,clearable:!0})}),e.jsx("div",{className:"mb-4","data-testid":"delivery-select",children:e.jsx(we,{label:"Delivery Coordinator",options:O,value:y==null?void 0:y.deliveryCoordinator,onChange:i=>T({deliveryCoordinator:i}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0})}),e.jsx("div",{"data-testid":"finance-select",children:e.jsx(we,{label:"Finance Manager",options:Y,value:y==null?void 0:y.financeManager,onChange:i=>T({financeManager:i}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(K,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:k,children:[e.jsx(Q,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(he=y==null?void 0:y.lineItems)==null?void 0:he.map((i,b)=>{var w,L,re,ae;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",b+1]}),((w=y==null?void 0:y.lineItems)==null?void 0:w.length)>1&&e.jsx(K,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>P(b),children:e.jsx(Q,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(we,{label:"Product *",options:W,value:(i==null?void 0:i.product_id)||"",onChange:$=>a(b,{product_id:$?parseInt($):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(ue,{id:`unit-price-${b}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:i==null?void 0:i.unit_price,onChange:$=>{var C;return a(b,{unit_price:parseFloat((C=$==null?void 0:$.target)==null?void 0:C.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(ue,{id:`quantity-${b}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:i==null?void 0:i.quantity_used,onChange:$=>{var C;return a(b,{quantity_used:parseInt((C=$==null?void 0:$.target)==null?void 0:C.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(oe,{selectedValue:i==null?void 0:i.isOffSite,onChange:$=>a(b,{isOffSite:$}),itemIndex:b})]}),(i==null?void 0:i.isOffSite)&&e.jsx("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:e.jsx(we,{label:"Vendor *",options:xe,value:(i==null?void 0:i.vendorId)||"",onChange:$=>a(b,{vendorId:$}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"})}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(be,{requiresScheduling:i==null?void 0:i.requiresScheduling,onChange:$=>a(b,{requiresScheduling:$}),itemIndex:b})}),i!=null&&i.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(ue,{id:`promised-date-${b}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:i==null?void 0:i.lineItemPromisedDate,onChange:$=>{var C;return a(b,{lineItemPromisedDate:(C=$==null?void 0:$.target)==null?void 0:C.value})},min:(ae=(re=(L=new Date)==null?void 0:L.toISOString())==null?void 0:re.split("T"))==null?void 0:ae[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ue,{id:`notes-${b}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(i==null?void 0:i.description)||"",onChange:$=>{var C;return a(b,{description:(C=$==null?void 0:$.target)==null?void 0:C.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(ue,{id:`no-schedule-reason-${b}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:i==null?void 0:i.noScheduleReason,onChange:$=>{var C;return a(b,{noScheduleReason:(C=$==null?void 0:$.target)==null?void 0:C.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(i==null?void 0:i.unit_price)||0)*(parseInt(i==null?void 0:i.quantity_used)||1)).toFixed(2)]})]},b)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(de=h())==null?void 0:de.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(K,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>p(!0),children:[e.jsx(Q,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(K,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:Z,children:"Cancel"}),e.jsx(K,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:se,disabled:c,children:c?"Saving...":"Save Changes"})]})]}),N&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(K,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:ee,disabled:A,children:A?"Deleting...":"Delete"})]})]})}),q&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(K,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>z(!1),children:"Keep Editing"}),e.jsx(K,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:r,children:"Discard Changes"})]})]})})]})}):null},xs=({status:s})=>{var u;const o={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},l=(o==null?void 0:o[s])||"bg-gray-100 text-gray-700",n=((u=s==null?void 0:s.replace("_"," "))==null?void 0:u.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${l}`,children:n})},Oe=({nextPromisedShort:s})=>{if(!s)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const o=new Date(s),l=new Date;l==null||l.setHours(0,0,0,0),o==null||o.setHours(0,0,0,0);const n=new Date(l);n==null||n.setDate((l==null?void 0:l.getDate())+2);let u="";return o<l?u="bg-red-100 text-red-800 border-red-200":o<=n?u="bg-amber-100 text-amber-800 border-amber-200":u="bg-green-100 text-green-800 border-green-200",e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${u}`,children:["Next: ",s]})},Pe=({serviceType:s,jobParts:o})=>{const l=o==null?void 0:o.some(u=>u==null?void 0:u.is_off_site),n=o==null?void 0:o.some(u=>!(u!=null&&u.is_off_site));return l&&n?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):l?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},ms=({draftsCount:s,onViewDrafts:o})=>{const[l,n]=I.useState(!1);return s===0||l?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Q,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",s," draft deal",s>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{size:"sm",variant:"ghost",onClick:o,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>n(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(Q,{name:"X",size:16})})]})]})})},ke=s=>s?s!=null&&s.job_number?s.job_number:s!=null&&s.id?`Job-${String(s.id).slice(0,8)}`:"â€”":"â€”",Je=s=>s&&(s==null?void 0:s.customer_name)||"",qe=({deal:s})=>!(s!=null&&s.customer_name)&&!(s!=null&&s.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"}):e.jsxs("div",{className:"space-y-1",children:[(s==null?void 0:s.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:s==null?void 0:s.customer_name}),(s==null?void 0:s.customer_phone)&&e.jsx("a",{href:`tel:${s==null?void 0:s.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:o=>o==null?void 0:o.stopPropagation(),children:s==null?void 0:s.customer_phone})]}),ze=({amount:s})=>{var l;const o=parseFloat(s)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:l.format(o)})})},gs=({deal:s})=>s!=null&&s.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",s==null?void 0:s.loaner_number,(s==null?void 0:s.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due ",s==null?void 0:s.loaner_eta_short]})]}):null,bs=({isOpen:s,onClose:o,deal:l,onSave:n,loading:u})=>{var N,p,A,R;const[d,c]=I.useState({loaner_number:"",eta_return_date:"",notes:""}),[j,v]=I.useState("");I.useEffect(()=>{if(s&&l){let m="";try{const E=((l==null?void 0:l.job_parts)||[]).filter(q=>(q==null?void 0:q.requires_scheduling)&&(q==null?void 0:q.promised_date)).map(q=>new Date(q.promised_date));(E==null?void 0:E.length)>0&&(m=new Date(Math.max.apply(null,E)).toISOString().split("T")[0])}catch{}c({loaner_number:(l==null?void 0:l.loaner_number)||"",eta_return_date:(l==null?void 0:l.loaner_eta_return_date)||m||"",notes:(l==null?void 0:l.loaner_notes)||""}),v("")}else s||(c({loaner_number:"",eta_return_date:"",notes:""}),v(""))},[s,l]);const f=async()=>{var m,E,q;if(v(""),!((m=d==null?void 0:d.loaner_number)!=null&&m.trim())){v("Loaner number is required");return}if(!(d!=null&&d.eta_return_date)){v("ETA return date is required");return}try{await n({job_id:l==null?void 0:l.id,loaner_number:(E=d==null?void 0:d.loaner_number)==null?void 0:E.trim(),eta_return_date:d==null?void 0:d.eta_return_date,notes:((q=d==null?void 0:d.notes)==null?void 0:q.trim())||null}),o()}catch(z){v((z==null?void 0:z.message)||"Failed to save loaner assignment")}};return s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:o}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(K,{variant:"ghost",size:"icon",onClick:o,"aria-label":"Close drawer",children:e.jsx(Q,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:ke(l)}),e.jsx("p",{className:"text-xs text-slate-500",children:Je(l)})]}),j&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:j}),e.jsx("button",{onClick:()=>v(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:d==null?void 0:d.loaner_number,onChange:m=>c(E=>{var q;return{...E,loaner_number:(q=m==null?void 0:m.target)==null?void 0:q.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:d==null?void 0:d.eta_return_date,onChange:m=>c(E=>{var q;return{...E,eta_return_date:(q=m==null?void 0:m.target)==null?void 0:q.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(A=(p=(N=new Date)==null?void 0:N.toISOString())==null?void 0:p.split("T"))==null?void 0:A[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:d==null?void 0:d.notes,onChange:m=>c(E=>{var q;return{...E,notes:(q=m==null?void 0:m.target)==null?void 0:q.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(K,{variant:"outline",onClick:o,className:"flex-1 h-11",disabled:u,children:"Cancel"}),e.jsx(K,{onClick:f,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:u||!((R=d==null?void 0:d.loaner_number)!=null&&R.trim())||!(d!=null&&d.eta_return_date),children:u?"Saving...":"Save Loaner"})]})]})})]}):null},fs=({loaner:s,onClose:o,onConfirm:l,loading:n})=>s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",s==null?void 0:s.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(K,{variant:"outline",onClick:o,className:"flex-1 h-11",disabled:n,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(K,{onClick:l,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:n,"aria-label":"Confirm loaner returned",children:n?"Processing...":"Mark Returned"})]})]})})}):null;function Ls(){var Z;const[s,o]=I.useState([]),[l,n]=I.useState(!0),[u,d]=I.useState(!1),[c,j]=I.useState(!1),[v,f]=I.useState(null),[N,p]=I.useState(null),[A,R]=I.useState(""),[m,E]=I.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[q,z]=I.useState(!1),[t,D]=I.useState(null),[x,G]=I.useState(!1),[M,X]=I.useState(null),[S,O]=I.useState(!1),[Y,xe]=I.useState(""),{clearSearch:W,error:ne}=Ye({loadOnMount:!0});ls();const{user:H}=Ee(),y=async r=>{var h;try{R("");const{error:_}=await((h=J)==null?void 0:h.rpc("delete_job_cascade",{p_job_id:r}));if(_)throw _;p(null),await oe()}catch(_){R(`Failed to delete deal: ${_==null?void 0:_.message}`),console.error("Delete error:",_)}},ie=async r=>{var h,_,V,U,le,te,he,de,i,b;try{G(!0),R("");let w=null;try{const{data:L}=await((le=(U=(V=(_=(h=J)==null?void 0:h.from("loaner_assignments"))==null?void 0:_.select("id"))==null?void 0:V.eq("job_id",r==null?void 0:r.job_id))==null?void 0:U.is("returned_at",null))==null?void 0:le.limit(1));w=Array.isArray(L)?L[0]:L}catch{}if(w!=null&&w.id){const{error:L}=await((de=(he=(te=J)==null?void 0:te.from("loaner_assignments"))==null?void 0:he.update({loaner_number:r==null?void 0:r.loaner_number,eta_return_date:r==null?void 0:r.eta_return_date,notes:r==null?void 0:r.notes}))==null?void 0:de.eq("id",w.id));if(L)throw L}else{const{error:L}=await((b=(i=J)==null?void 0:i.from("loaner_assignments"))==null?void 0:b.insert([{job_id:r==null?void 0:r.job_id,loaner_number:r==null?void 0:r.loaner_number,eta_return_date:r==null?void 0:r.eta_return_date,notes:r==null?void 0:r.notes}]));if(L)throw L}z(!1),D(null),await oe()}catch(w){const L=`Failed to save loaner assignment: ${w==null?void 0:w.message}`;throw R(L),new Error(L)}finally{G(!1)}},B=async r=>{try{O(!0),R(""),await De(r==null?void 0:r.loaner_id),X(null),await oe()}catch(h){R(`Failed to mark loaner as returned: ${h==null?void 0:h.message}`),console.error("Mark returned error:",h)}finally{O(!1)}},oe=async(r=0)=>{var h,_;try{n(!0),R("");const V=await es();o(V||[])}catch(V){const U=`Failed to load deals: ${V==null?void 0:V.message}`;if(console.error("Load deals error:",V),r<2&&((h=V==null?void 0:V.message)!=null&&h.includes("fetch")||(_=V==null?void 0:V.message)!=null&&_.includes("network"))){console.log(`Retrying load deals (attempt ${r+1})`),setTimeout(()=>oe(r+1),1e3*(r+1));return}R(U),o([])}finally{n(!1)}};I.useEffect(()=>{var _;const r=new URLSearchParams(window.location.search),h=r==null?void 0:r.get("status");if(h){const V=((_=h==null?void 0:h.charAt(0))==null?void 0:_.toUpperCase())+(h==null?void 0:h.slice(1));E(U=>({...U,status:V}))}},[]),I.useEffect(()=>{oe()},[]);const be=r=>{D(r),z(!0)},g=({message:r,onClose:h})=>r?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(Q,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:r})]})]}),h&&e.jsx("button",{onClick:h,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(Q,{name:"X",size:16})})]})}):null,T=(r=>{var de,i,b;const h=r||[],_=((de=h==null?void 0:h.filter(w=>(w==null?void 0:w.job_status)==="in_progress"))==null?void 0:de.length)||0,V=h==null?void 0:h.reduce((w,L)=>{const re=parseFloat(L==null?void 0:L.total_amount)||0;return w+re},0),U=V*.25,le=V>0?25:0,te=((i=h==null?void 0:h.filter(w=>(w==null?void 0:w.job_status)==="pending"))==null?void 0:i.length)||0,he=((b=h==null?void 0:h.filter(w=>(w==null?void 0:w.job_status)==="draft"))==null?void 0:b.length)||0;return{active:_,revenue:(V==null?void 0:V.toFixed(2))||"0.00",profit:(U==null?void 0:U.toFixed(2))||"0.00",margin:(le==null?void 0:le.toFixed(1))||"0.0",pending:te,drafts:he}})(s),a=s==null?void 0:s.filter(r=>{var h,_,V,U,le;if((m==null?void 0:m.status)!=="All"){const te=(_=(h=m==null?void 0:m.status)==null?void 0:h.toLowerCase())==null?void 0:_.replace(" ","_");if((r==null?void 0:r.job_status)!==te)return!1}if(m!=null&&m.salesAssigned&&(r==null?void 0:r.assigned_to)!==(m==null?void 0:m.salesAssigned)||m!=null&&m.deliveryAssigned&&(r==null?void 0:r.delivery_coordinator_id)!==(m==null?void 0:m.deliveryAssigned)||m!=null&&m.financeAssigned&&(r==null?void 0:r.finance_manager_id)!==(m==null?void 0:m.financeAssigned)||m!=null&&m.vendor&&(r==null?void 0:r.vendor_id)!==(m==null?void 0:m.vendor))return!1;if(Y!=null&&Y.trim()){const te=Y==null?void 0:Y.toLowerCase(),he=w=>(w==null?void 0:w.replace(/\D/g,""))||"",de=he(te),i=[r==null?void 0:r.customer_name,r==null?void 0:r.customer_phone,r==null?void 0:r.customer_email,r==null?void 0:r.job_number,(V=r==null?void 0:r.vehicle)==null?void 0:V.make,(U=r==null?void 0:r.vehicle)==null?void 0:U.model,((le=r==null?void 0:r.vehicle)==null?void 0:le.stock_number)||(r==null?void 0:r.stock_no),r==null?void 0:r.description].filter(Boolean);if(!(i==null?void 0:i.some(w=>{var re;const L=w==null?void 0:w.toLowerCase();return!!(L!=null&&L.includes(te)||(de==null?void 0:de.length)>=3&&((re=he(L))!=null&&re.includes(de)))})))return!1}return!0});I.useEffect(()=>{const r=setTimeout(()=>{xe(m==null?void 0:m.search)},300);return()=>clearTimeout(r)},[m==null?void 0:m.search]);const k=(r,h)=>{var _,V;if(E(U=>({...U,[r]:h})),r==="status"){const U=new URLSearchParams(window.location.search);h==="All"?U==null||U.delete("status"):U==null||U.set("status",h==null?void 0:h.toLowerCase());const le=`${(_=window.location)==null?void 0:_.pathname}${U!=null&&U.toString()?"?"+(U==null?void 0:U.toString()):""}`;(V=window.history)==null||V.replaceState({},"",le)}},P=()=>{var r,h;E({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),W(),(h=window.history)==null||h.replaceState({},"",(r=window.location)==null?void 0:r.pathname)},se=r=>{f(r),j(!0)},ee=()=>{j(!1),f(null)};return l?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Me,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Me,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(g,{message:A||ne,onClose:()=>{R("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ns,{exportType:"jobs",filters:{status:m==null?void 0:m.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(r,h)=>console.log(`Export complete: ${r} records`),onExportError:r=>R(`Export failed: ${r}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(K,{onClick:()=>d(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(Q,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(ms,{draftsCount:T==null?void 0:T.drafts,onViewDrafts:()=>k("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(Q,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:T==null?void 0:T.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(Q,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",T==null?void 0:T.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(Q,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",T==null?void 0:T.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(Q,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[T==null?void 0:T.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(Q,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:T==null?void 0:T.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(Q,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:T==null?void 0:T.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(r=>e.jsx("button",{onClick:()=>k("status",r),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(m==null?void 0:m.status)===r?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:r},r))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Q,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:m==null?void 0:m.search,onChange:r=>{var h;return k("search",(h=r==null?void 0:r.target)==null?void 0:h.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(K,{variant:"ghost",size:"sm",onClick:P,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(Q,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",a==null?void 0:a.length," of ",s==null?void 0:s.length," deals",((m==null?void 0:m.salesAssigned)||(m==null?void 0:m.deliveryAssigned)||(m==null?void 0:m.financeAssigned)||(m==null?void 0:m.vendor)||(m==null?void 0:m.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Next"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:a==null?void 0:a.map(r=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(qe,{deal:r})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(ze,{amount:r==null?void 0:r.total_amount})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Oe,{nextPromisedShort:r==null?void 0:r.next_promised_short})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Pe,{serviceType:r==null?void 0:r.service_type,jobParts:r==null?void 0:r.job_parts})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>se(r==null?void 0:r.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(r==null?void 0:r.customer_needs_loaner)&&e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>be(r),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(r==null?void 0:r.loaner_id)&&e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>X({loaner_id:r==null?void 0:r.loaner_id,loaner_number:r==null?void 0:r.loaner_number,job_title:ke(r)}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>p(r),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},r==null?void 0:r.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(a==null?void 0:a.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(m==null?void 0:m.status)==="All"?"No deals found":`No ${(Z=m==null?void 0:m.status)==null?void 0:Z.toLowerCase()} deals found`})}):a==null?void 0:a.map(r=>e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:ke(r)}),e.jsx("div",{className:"text-sm text-slate-600",children:Je(r)||"â€”"})]}),e.jsx(xs,{status:r==null?void 0:r.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((r==null?void 0:r.customer_name)||(r==null?void 0:r.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(qe,{deal:r})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(ze,{amount:r==null?void 0:r.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(Oe,{nextPromisedShort:r==null?void 0:r.next_promised_short})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(Pe,{serviceType:r==null?void 0:r.service_type,jobParts:r==null?void 0:r.job_parts})]}),(r==null?void 0:r.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(gs,{deal:r})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>se(r==null?void 0:r.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(Q,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>p(r),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(Q,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((r==null?void 0:r.customer_needs_loaner)||(r==null?void 0:r.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(r==null?void 0:r.customer_needs_loaner)&&!(r!=null&&r.loaner_id)&&e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>be(r),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(Q,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(r==null?void 0:r.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>be(r),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(Q,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(K,{size:"sm",variant:"outline",onClick:()=>X({loaner_id:r==null?void 0:r.loaner_id,loaner_number:r==null?void 0:r.loaner_number,job_title:ke(r)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(Q,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},r==null?void 0:r.id))}),e.jsx(cs,{isOpen:u,onClose:()=>d(!1),onSuccess:oe}),e.jsx(hs,{isOpen:c,dealId:v,onClose:ee,onSuccess:()=>{oe(),ee()}}),N&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(K,{variant:"outline",onClick:()=>p(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(K,{onClick:()=>y(N==null?void 0:N.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(bs,{isOpen:q,onClose:()=>{z(!1),D(null),R("")},deal:t,onSave:ie,loading:x}),e.jsx(fs,{loaner:M,onClose:()=>{X(null),R("")},onConfirm:()=>B(M),loading:S})]})]})}export{Ls as default};
//# sourceMappingURL=index-qZZtXjf2.js.map
