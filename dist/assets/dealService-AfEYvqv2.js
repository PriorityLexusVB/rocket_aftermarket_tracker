import{s as a}from"./index-BmnpmxFD.js";import"./react-Czq5O75u.js";import"./supabase-D02rA7zj.js";import"./router-CZES1Sa0.js";const x=["job_number","title","description","vehicle_id","vendor_id","job_status","priority","location","scheduled_start_time","scheduled_end_time","estimated_hours","estimated_cost","actual_cost","customer_needs_loaner","service_type","delivery_coordinator_id","finance_manager_id","assigned_to","org_id"];function j(e,n){const i={};return n==null||n.forEach(o=>{(e==null?void 0:e[o])!==void 0&&(i[o]=e==null?void 0:e[o])}),i}function S(e){const n=j(e||{},x);return Object.keys(n).forEach(i=>{n[i]===""&&(n[i]=null)}),n}function H(){const e=Date.now(),n=Math.floor(Math.random()*1e4);return`TXN-${e}-${n}`}async function b(e){var o,s,c,_;const{data:n,error:i}=await((_=(c=(s=(o=a)==null?void 0:o.from("jobs"))==null?void 0:s.select(`
        id, job_number, title, description, job_status, priority, location,
        vehicle_id, vendor_id, scheduled_start_time, scheduled_end_time,
        estimated_hours, estimated_cost, actual_cost, customer_needs_loaner,
        service_type, delivery_coordinator_id, assigned_to, created_at, finance_manager_id,
        vehicle:vehicles(id, year, make, model, stock_number),
        vendor:vendors(id, name),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site, product:products(id, name, category, brand))
      `))==null?void 0:c.eq("id",e))==null?void 0:_.single());if(i)throw new Error(`Failed to load deal: ${i.message}`);return n}function K(e={}){var g,y,I,N,h,F,q,t,p;const n=S(e||{}),i=(e==null?void 0:e.org_id)??(e==null?void 0:e.orgId),o=i?{...n,org_id:i}:n;if(!(o!=null&&o.title)){const r=((e==null?void 0:e.description)||"").trim();r?o.title=r:o!=null&&o.job_number?o.title=`Deal ${o.job_number}`:o.title="Untitled Deal"}const c=((Array.isArray(e==null?void 0:e.line_items)?e==null?void 0:e.line_items:Array.isArray(e==null?void 0:e.lineItems)?e==null?void 0:e.lineItems:[])||[]).map(r=>{const f=(r==null?void 0:r.requires_scheduling)??(r==null?void 0:r.requiresScheduling)??!0,O=(r==null?void 0:r.no_schedule_reason)||(r==null?void 0:r.noScheduleReason)||null,A=(r==null?void 0:r.promised_date)||(r==null?void 0:r.lineItemPromisedDate)||null,L=(r==null?void 0:r.is_off_site)??(r==null?void 0:r.isOffSite)??!1;return{product_id:r.product_id??null,quantity_used:Number(r.quantity_used??r.quantity??1),unit_price:Number(r.unit_price??r.price??0),promised_date:A,requires_scheduling:!!f,no_schedule_reason:f?null:O,is_off_site:!!L,lineItemPromisedDate:A,requiresScheduling:!!f,noScheduleReason:f?null:O,isOffSite:!!L}});for(const r of c)if((Number.isNaN(r.quantity_used)||r.quantity_used==null)&&(r.quantity_used=1),(Number.isNaN(r.unit_price)||r.unit_price==null)&&(r.unit_price=0),!r.requires_scheduling&&!String(r.no_schedule_reason||"").trim())throw new Error("Each non-scheduled line item must include a reason");if(((c==null?void 0:c.length)||0)>0&&!c.some(f=>!!f.product_id))throw new Error("At least one product is required");const _=(c||[]).map(r=>({product_id:r.product_id,quantity:Number(r.quantity_used??1),unit_price:Number(r.unit_price??0),total_price:Number(r.unit_price??0)*Number(r.quantity_used??1),quantity_used:r.quantity_used,promised_date:r.promised_date,requires_scheduling:r.requires_scheduling,no_schedule_reason:r.no_schedule_reason,is_off_site:r.is_off_site})),u=(e==null?void 0:e.loanerForm)||null,v=((g=e==null?void 0:e.customerName)==null?void 0:g.trim())||((I=(y=e==null?void 0:e.customer_name)==null?void 0:y.trim)==null?void 0:I.call(y))||"",$=((N=e==null?void 0:e.customerPhone)==null?void 0:N.trim())||((F=(h=e==null?void 0:e.customer_phone)==null?void 0:h.trim)==null?void 0:F.call(h))||"",E=((q=e==null?void 0:e.customerEmail)==null?void 0:q.trim())||((p=(t=e==null?void 0:e.customer_email)==null?void 0:t.trim)==null?void 0:p.call(t))||"";return{payload:o,normalizedLineItems:c,jobPayload:o,jobParts:_,loanerForm:u,customerName:v,customerPhone:$,customerEmail:E}}function Q(e,n=[]){var i,o;return(o=(i=n||[])==null?void 0:i.map(s=>({job_id:e,product_id:(s==null?void 0:s.product_id)??null,quantity_used:(s==null?void 0:s.quantity_used)??(s==null?void 0:s.quantity)??1,unit_price:(s==null?void 0:s.unit_price)??(s==null?void 0:s.price)??0,promised_date:(s==null?void 0:s.lineItemPromisedDate)||(s!=null&&s.requiresScheduling?new Date().toISOString().slice(0,10):null),requires_scheduling:!!(s!=null&&s.requiresScheduling),no_schedule_reason:s!=null&&s.requiresScheduling?null:(s==null?void 0:s.noScheduleReason)||null,is_off_site:!!(s!=null&&s.isOffSite)})))==null?void 0:o.filter(s=>(s==null?void 0:s.product_id)!==null||(s==null?void 0:s.quantity_used)||(s==null?void 0:s.unit_price))}async function W(e,n){var i,o,s,c,_,u,v,$,E,g,y,I,N;if((i=n==null?void 0:n.loaner_number)!=null&&i.trim())try{const{data:h}=await((u=(_=(c=(s=(o=a)==null?void 0:o.from("loaner_assignments"))==null?void 0:s.select("id"))==null?void 0:c.eq("job_id",e))==null?void 0:_.is("returned_at",null))==null?void 0:u.single()),F={job_id:e,loaner_number:(v=n==null?void 0:n.loaner_number)==null?void 0:v.trim(),eta_return_date:(n==null?void 0:n.eta_return_date)||null,notes:(($=n==null?void 0:n.notes)==null?void 0:$.trim())||null};if(h){const{error:q}=await((y=(g=(E=a)==null?void 0:E.from("loaner_assignments"))==null?void 0:g.update(F))==null?void 0:y.eq("id",h==null?void 0:h.id));if(q)throw q}else{const{error:q}=await((N=(I=a)==null?void 0:I.from("loaner_assignments"))==null?void 0:N.insert([F]));if(q)throw q}}catch(h){throw(h==null?void 0:h.code)==="23505"?new Error(`Loaner ${n==null?void 0:n.loaner_number} is already assigned to another active job`):h}}async function D(){var e,n,i,o,s,c,_,u,v,$,E;try{const{data:g,error:y}=await((o=(i=(n=(e=a)==null?void 0:e.from("jobs"))==null?void 0:n.select(`
        id, created_at, job_status, service_type, color_code, title, job_number,
        customer_needs_loaner, assigned_to, delivery_coordinator_id, finance_manager_id,
        vehicle:vehicles(year, make, model, stock_number),
        job_parts(id, product_id, unit_price, quantity_used, promised_date, requires_scheduling, no_schedule_reason, is_off_site)
      `))==null?void 0:i.in("job_status",["draft","pending","in_progress","completed"]))==null?void 0:o.order("created_at",{ascending:!1}));if(y)throw y;const I=(g==null?void 0:g.map(t=>t==null?void 0:t.id))||[],[N,h]=await Promise.all([(_=(c=(s=a)==null?void 0:s.from("transactions"))==null?void 0:c.select("job_id, customer_name, customer_phone, customer_email, total_amount"))==null?void 0:_.in("job_id",I),(E=($=(v=(u=a)==null?void 0:u.from("loaner_assignments"))==null?void 0:v.select("job_id, id, loaner_number, eta_return_date"))==null?void 0:$.in("job_id",I))==null?void 0:E.is("returned_at",null)]),F=(N==null?void 0:N.data)||[],q=(h==null?void 0:h.data)||[];return(g==null?void 0:g.map(t=>{var A,L,J,M,U,R,T,B,w,m;const p=F==null?void 0:F.find(l=>(l==null?void 0:l.job_id)===(t==null?void 0:t.id)),r=q==null?void 0:q.find(l=>(l==null?void 0:l.job_id)===(t==null?void 0:t.id)),f=((A=t==null?void 0:t.job_parts)==null?void 0:A.filter(l=>(l==null?void 0:l.requires_scheduling)&&(l==null?void 0:l.promised_date)))||[],O=(f==null?void 0:f.length)>0?(J=(L=f==null?void 0:f.sort((l,C)=>new Date(l.promised_date)-new Date(C.promised_date)))==null?void 0:L[0])==null?void 0:J.promised_date:null;return{...t,customer_name:(p==null?void 0:p.customer_name)||"",customer_phone:(p==null?void 0:p.customer_phone)||"",customer_email:(p==null?void 0:p.customer_email)||"",total_amount:(p==null?void 0:p.total_amount)||0,has_active_loaner:!!(r!=null&&r.id),next_promised_short:O?(M=new Date(O))==null?void 0:M.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,loaner_id:(r==null?void 0:r.id)||null,loaner_number:(r==null?void 0:r.loaner_number)||null,loaner_eta_short:r!=null&&r.eta_return_date?(U=new Date(r==null?void 0:r.eta_return_date))==null?void 0:U.toLocaleDateString("en-US",{month:"short",day:"numeric"}):null,vehicle:t!=null&&t.vehicle_id&&(t!=null&&t.vehicle)?{year:(R=t==null?void 0:t.vehicle)==null?void 0:R.year,make:(T=t==null?void 0:t.vehicle)==null?void 0:T.make,model:(B=t==null?void 0:t.vehicle)==null?void 0:B.model,stock_number:(w=t==null?void 0:t.vehicle)==null?void 0:w.stock_number}:null,stock_no:(m=t==null?void 0:t.vehicle)==null?void 0:m.stock_number}}))||[]}catch(g){throw console.error("Failed to load deals:",g),new Error(`Failed to load deals: ${g==null?void 0:g.message}`)}}async function V(e){var n,i,o,s;try{const c=await b(e),{data:_}=await((s=(o=(i=(n=a)==null?void 0:n.from("transactions"))==null?void 0:i.select("customer_name, customer_phone, customer_email, total_amount"))==null?void 0:o.eq("job_id",e))==null?void 0:s.single());return{...c,customer_name:(_==null?void 0:_.customer_name)||"",customer_phone:(_==null?void 0:_.customer_phone)||"",customer_email:(_==null?void 0:_.customer_email)||"",total_amount:(_==null?void 0:_.total_amount)||0}}catch(c){throw console.error("[dealService:get] Failed to get deal:",c),new Error(`Failed to load deal: ${c==null?void 0:c.message}`)}}async function ee(e){var $,E,g,y,I,N,h,F,q,t,p,r,f,O,A,L,J,M,U,R,T,B,w,m,l,C,X,G;const{payload:n,normalizedLineItems:i,loanerForm:o,customerName:s,customerPhone:c,customerEmail:_}=K(e||{});if(!(n!=null&&n.org_id))try{const{data:d}=await((g=(E=($=a)==null?void 0:$.auth)==null?void 0:E.getUser)==null?void 0:g.call(E)),P=(y=d==null?void 0:d.user)==null?void 0:y.id;if(P){const{data:z}=await((F=(h=(N=(I=a)==null?void 0:I.from("user_profiles"))==null?void 0:N.select("org_id"))==null?void 0:h.eq("id",P))==null?void 0:F.single());z!=null&&z.org_id&&(n.org_id=z.org_id)}}catch(d){console.warn("[dealService:create] Unable to infer org_id from profile:",d==null?void 0:d.message)}if(!(n!=null&&n.job_number)){const d=Date.now(),P=Math.floor(Math.random()*1e4);n.job_number=`JOB-${d}-${P}`}n!=null&&n.vendor_id&&!(n!=null&&n.scheduled_start_time)&&(n.scheduled_start_time=new Date().toISOString());const{data:u,error:v}=await((r=(p=(t=(q=a)==null?void 0:q.from("jobs"))==null?void 0:t.insert([n]))==null?void 0:p.select("id"))==null?void 0:r.single());if(v)throw new Error(`Failed to create deal: ${v.message}`);try{if((i||[]).length>0){const d=Q(u==null?void 0:u.id,i);if((d==null?void 0:d.length)>0){const{error:P}=await((O=(f=a)==null?void 0:f.from("job_parts"))==null?void 0:O.insert(d));if(P)throw P}}n!=null&&n.customer_needs_loaner&&o&&await W(u==null?void 0:u.id,o);try{const d={job_id:u==null?void 0:u.id,vehicle_id:(n==null?void 0:n.vehicle_id)||null,total_amount:(i||[]).reduce((z,k)=>{const Y=Number((k==null?void 0:k.quantity_used)||(k==null?void 0:k.quantity)||1),Z=Number((k==null?void 0:k.unit_price)||(k==null?void 0:k.price)||0);return z+Y*Z},0)||0,customer_name:s||"Unknown Customer",customer_phone:c||null,customer_email:_||null,transaction_status:"pending",transaction_number:H()},{data:P}=await((R=(U=(M=(J=(L=(A=a)==null?void 0:A.from("transactions"))==null?void 0:L.select("id"))==null?void 0:J.eq("job_id",u==null?void 0:u.id))==null?void 0:M.limit(1))==null?void 0:U.maybeSingle)==null?void 0:R.call(U));P!=null&&P.id||await((B=(T=a)==null?void 0:T.from("transactions"))==null?void 0:B.insert([d]))}catch(d){console.warn("[dealService:create] pre-create transaction insert skipped:",d==null?void 0:d.message)}try{return await V(u==null?void 0:u.id)}catch(d){return console.warn("[dealService:create] getDeal fallback due to error:",d==null?void 0:d.message),{id:u==null?void 0:u.id}}}catch(d){console.error("[dealService:create] Failed to create deal:",d);try{await((l=(m=(w=a)==null?void 0:w.from("job_parts"))==null?void 0:m.delete())==null?void 0:l.eq("job_id",u==null?void 0:u.id))}catch{}try{await((G=(X=(C=a)==null?void 0:C.from("jobs"))==null?void 0:X.delete())==null?void 0:G.eq("id",u==null?void 0:u.id))}catch{}throw new Error(`Failed to create deal: ${d.message}`)}}async function ne(e,n){var y,I,N,h,F,q,t,p,r,f,O,A,L,J,M,U,R,T,B;const{payload:i,normalizedLineItems:o,loanerForm:s,customerName:c,customerPhone:_,customerEmail:u}=K(n||{}),v=(o||[]).reduce((w,m)=>{const l=Number((m==null?void 0:m.quantity_used)||(m==null?void 0:m.quantity)||1),C=Number((m==null?void 0:m.unit_price)||(m==null?void 0:m.price)||0);return w+l*C},0)||0,{error:$}=await((N=(I=(y=a)==null?void 0:y.from("jobs"))==null?void 0:I.update(i))==null?void 0:N.eq("id",e));if($)throw new Error(`Failed to update deal: ${$.message}`);const E={job_id:e,vehicle_id:(i==null?void 0:i.vehicle_id)||null,total_amount:v,customer_name:c||"Unknown Customer",customer_phone:_||null,customer_email:u||null,transaction_status:"pending"};try{const{data:w}=await((r=(p=(t=(q=(F=(h=a)==null?void 0:h.from("transactions"))==null?void 0:F.select("id, transaction_number"))==null?void 0:q.eq("job_id",e))==null?void 0:t.limit(1))==null?void 0:p.maybeSingle)==null?void 0:r.call(p));if(w!=null&&w.id){const{error:m}=await((A=(O=(f=a)==null?void 0:f.from("transactions"))==null?void 0:O.update(E))==null?void 0:A.eq("id",w.id));if(m)throw m}else{const m={...E,transaction_number:H()},{error:l}=await((J=(L=a)==null?void 0:L.from("transactions"))==null?void 0:J.insert([m]));if(l)throw l}}catch(w){throw new Error(`Failed to upsert transaction: ${(w==null?void 0:w.message)||w}`)}const{error:g}=await((R=(U=(M=a)==null?void 0:M.from("job_parts"))==null?void 0:U.delete())==null?void 0:R.eq("job_id",e));if(g)throw new Error(`Failed to update line items: ${g.message}`);if((o||[]).length>0){const w=Q(e,o);if((w==null?void 0:w.length)>0){const{error:m}=await((B=(T=a)==null?void 0:T.from("job_parts"))==null?void 0:B.insert(w));if(m)throw new Error(`Failed to update line items: ${m.message}`)}}return i!=null&&i.customer_needs_loaner&&s&&await W(e,s),await V(e)}async function re(e){var i;const{error:n}=await((i=a)==null?void 0:i.rpc("delete_job_cascade",{p_job_id:e}));if(n)throw new Error(`Failed to delete deal: ${n.message}`);return!0}async function se(e,n){var s,c,_,u,v;const{data:i,error:o}=await((v=(u=(_=(c=(s=a)==null?void 0:s.from("jobs"))==null?void 0:c.update({job_status:n}))==null?void 0:_.eq("id",e))==null?void 0:u.select("id, job_status"))==null?void 0:v.single());if(o)throw new Error(`Failed to update status: ${o.message}`);return i}function ue(e){var n;return e?{id:e==null?void 0:e.id,job_number:(e==null?void 0:e.job_number)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",vendor_id:e==null?void 0:e.vendor_id,vehicle_id:e==null?void 0:e.vehicle_id,job_status:(e==null?void 0:e.job_status)||"pending",priority:(e==null?void 0:e.priority)||"medium",scheduled_start_time:(e==null?void 0:e.scheduled_start_time)||"",scheduled_end_time:(e==null?void 0:e.scheduled_end_time)||"",estimated_hours:(e==null?void 0:e.estimated_hours)||"",estimated_cost:(e==null?void 0:e.estimated_cost)||"",actual_cost:(e==null?void 0:e.actual_cost)||"",location:(e==null?void 0:e.location)||"",customer_needs_loaner:!!(e!=null&&e.customer_needs_loaner),assigned_to:e==null?void 0:e.assigned_to,delivery_coordinator_id:e==null?void 0:e.delivery_coordinator_id,finance_manager_id:e==null?void 0:e.finance_manager_id,customerName:(e==null?void 0:e.customer_name)||"",customerPhone:(e==null?void 0:e.customer_phone)||"",customerEmail:(e==null?void 0:e.customer_email)||"",vehicle:(e==null?void 0:e.vehicle)||null,lineItems:(n=(e==null?void 0:e.job_parts)||[])==null?void 0:n.map(i=>({product_id:i==null?void 0:i.product_id,unit_price:(i==null?void 0:i.unit_price)||0,quantity_used:(i==null?void 0:i.quantity_used)||1,promised_date:(i==null?void 0:i.promised_date)||"",requires_scheduling:!!(i!=null&&i.requires_scheduling),no_schedule_reason:(i==null?void 0:i.no_schedule_reason)||"",is_off_site:!!(i!=null&&i.is_off_site)}))}:null}async function _e(e){var n,i,o,s;try{const{error:c}=await((s=(o=(n=a)==null?void 0:n.from("loaner_assignments"))==null?void 0:o.update({returned_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:s.eq("id",e));if(c)throw c;return!0}catch(c){throw console.error("Failed to mark loaner as returned:",c),new Error(`Failed to mark loaner as returned: ${c==null?void 0:c.message}`)}}const de={getAllDeals:D,getDeal:V,createDeal:ee,updateDeal:ne,deleteDeal:re,updateDealStatus:se};export{ee as createDeal,de as dealService,de as default,re as deleteDeal,D as getAllDeals,V as getDeal,ue as mapDbDealToForm,K as mapFormToDb,_e as markLoanerReturned,Q as toJobPartRows,ne as updateDeal,se as updateDealStatus};
//# sourceMappingURL=dealService-AfEYvqv2.js.map
