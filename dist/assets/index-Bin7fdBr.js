import{s as Q,u as Je,j as e,B as I,S as Ye,I as Xe,a as rs,g as ts,b as ns,c as as,d as ls,e as cs,p as He,f as ds,h as us,i as hs,k as xs,l as ke}from"./index-DFEbJZ8Z.js";import{r as S,R as is}from"./react-Czq5O75u.js";import{dealService as We,mapDbDealToForm as Ge,getDeal as ms,updateDeal as gs,deleteDeal as bs,markLoanerReturned as fs,getAllDeals as ps}from"./dealService-GCDKS-zG.js";import{s as Ue,t as js}from"./options-CllavUpK.js";import{I as H}from"./Icon-BVWGvxXf.js";import{l as vs}from"./vendorService-CKEuO_iF.js";import{l as ys}from"./smsTemplateService-BQiWocnB.js";import{N as Ze}from"./Navbar-PurkmRVa.js";import{a as Ns}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const _s=(t,h="")=>t==null?h:String(t),Ie={async getOverdueJobs(){var t;try{const{data:h,error:r}=await((t=Q)==null?void 0:t.rpc("get_overdue_jobs_enhanced"));return r?(console.error("Error fetching overdue jobs:",r),{data:[],error:{message:r==null?void 0:r.message}}):{data:h||[],error:null}}catch(h){return console.error("Error in getOverdueJobs service:",h),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var t,h,r,i;try{const{data:u,error:m}=await((i=(r=(h=(t=Q)==null?void 0:t.from("sms_templates"))==null?void 0:h.select("*"))==null?void 0:r.eq("is_active",!0))==null?void 0:i.order("created_at",{ascending:!1}));return m?{data:[],error:{message:m==null?void 0:m.message}}:{data:u||[],error:null}}catch(u){return console.error("Error fetching SMS templates:",u),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(t){var h,r,i,u,m,o,j,y;try{const p=await((r=(h=Q)==null?void 0:h.auth)==null?void 0:r.getUser()),{data:v,error:x}=await((y=(j=(o=(i=Q)==null?void 0:i.from("sms_templates"))==null?void 0:o.insert([{...t,created_by:(m=(u=p==null?void 0:p.data)==null?void 0:u.user)==null?void 0:m.id}]))==null?void 0:j.select())==null?void 0:y.single());return x?{data:null,error:{message:x==null?void 0:x.message}}:{data:v,error:null}}catch(p){return console.error("Error creating SMS template:",p),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(t,h){var r,i,u,m,o,j;try{const{data:y,error:p}=await((j=(o=(m=(u=(r=Q)==null?void 0:r.from("sms_templates"))==null?void 0:u.update({...h,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:m.eq("id",t))==null?void 0:o.select())==null?void 0:j.single());return p?{data:null,error:{message:p==null?void 0:p.message}}:{data:y,error:null}}catch(y){return console.error("Error updating SMS template:",y),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(t){var h,r,i;try{const{error:u}=await((i=(r=(h=Q)==null?void 0:h.from("sms_templates"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting SMS template:",u),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(t){var h,r,i,u,m,o,j,y,p;try{const v=await((r=(h=Q)==null?void 0:h.auth)==null?void 0:r.getUser()),{data:x,error:O}=await((p=(y=(m=(u=(i=Q)==null?void 0:i.from("filter_presets"))==null?void 0:u.select("*"))==null?void 0:m.eq("page_type",t))==null?void 0:y.or(`user_id.eq.${(j=(o=v==null?void 0:v.data)==null?void 0:o.user)==null?void 0:j.id},is_public.eq.true`))==null?void 0:p.order("created_at",{ascending:!1}));return O?{data:[],error:{message:O==null?void 0:O.message}}:{data:x||[],error:null}}catch(v){return console.error("Error fetching filter presets:",v),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(t,h,r,i=!1){var u,m,o,j,y,p,v,x;try{const O=await((m=(u=Q)==null?void 0:u.auth)==null?void 0:m.getUser()),{data:ne,error:ae}=await((x=(v=(p=(o=Q)==null?void 0:o.from("filter_presets"))==null?void 0:p.insert([{user_id:(y=(j=O==null?void 0:O.data)==null?void 0:j.user)==null?void 0:y.id,page_type:t,name:h,filters:r,is_public:i}]))==null?void 0:v.select())==null?void 0:x.single());return ae?{data:null,error:{message:ae==null?void 0:ae.message}}:{data:ne,error:null}}catch(O){return console.error("Error saving filter preset:",O),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(t){var h,r,i;try{const{error:u}=await((i=(r=(h=Q)==null?void 0:h.from("filter_presets"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting filter preset:",u),{error:{message:"Failed to delete filter preset"}}}},async exportData(t,h={},r="staff"){var i,u;try{const{data:m,error:o}=await((i=Q)==null?void 0:i.rpc("generate_export_data",{export_type:t,filters:h,user_role:r}));return o?{data:null,error:{message:o==null?void 0:o.message}}:{data:(u=m||[])==null?void 0:u.map(y=>{var x;const p=(y==null?void 0:y.export_data)||y,v={};return(x=Object==null?void 0:Object.entries(p))==null||x.forEach(([O,ne])=>{typeof ne=="number"?v[O]=isNaN(ne)?0:ne:ne==null?v[O]="":v[O]=ne}),{export_data:v}}),error:null}}catch(m){return console.error("Error exporting data:",m),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(t,h,r=null){var i,u,m,o;try{if(!t||(t==null?void 0:t.length)===0)throw new Error("No data to export");let j="";if(r)j+=(r==null?void 0:r.join(","))+`
`;else{const v=((i=t==null?void 0:t[0])==null?void 0:i.export_data)||(t==null?void 0:t[0]);v&&(j+=((u=Object==null?void 0:Object.keys(v))==null?void 0:u.join(","))+`
`)}t==null||t.forEach(v=>{var ne;const x=(v==null?void 0:v.export_data)||v,O=(ne=Object==null?void 0:Object.values(x))==null?void 0:ne.map(ae=>{if(ae==null)return"";if(typeof ae=="number"&&isNaN(ae))return"0";let w=_s(ae);return w!=null&&w.includes(",")||w!=null&&w.includes('"')?`"${w==null?void 0:w.replace(/"/g,'""')}"`:w});j+=(O==null?void 0:O.join(","))+`
`});const y=new Blob([j],{type:"text/csv;charset=utf-8;"}),p=document.createElement("a");if((p==null?void 0:p.download)!==void 0){const v=URL==null?void 0:URL.createObjectURL(y);p==null||p.setAttribute("href",v),p==null||p.setAttribute("download",h),p.style.visibility="hidden",(m=document.body)==null||m.appendChild(p),p==null||p.click(),(o=document.body)==null||o.removeChild(p),URL==null||URL.revokeObjectURL(v)}return{success:!0,error:null}}catch(j){return console.error("Export to CSV error:",j),{success:!1,error:{message:(j==null?void 0:j.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(t,h){var r,i,u,m,o;try{const j=await((i=(r=Q)==null?void 0:r.auth)==null?void 0:i.getUser()),{data:y,error:p}=await((o=Q)==null?void 0:o.rpc("bulk_update_jobs",{job_ids:t,updates:h,performed_by:(m=(u=j==null?void 0:j.data)==null?void 0:u.user)==null?void 0:m.id}));return p?{data:null,error:{message:p==null?void 0:p.message}}:{data:(y==null?void 0:y[0])||null,error:null}}catch(j){return console.error("Error in bulk update jobs:",j),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var t,h,r,i,u,m,o;try{const j=await((h=(t=Q)==null?void 0:t.auth)==null?void 0:h.getUser()),{data:y,error:p}=await((o=(i=(r=Q)==null?void 0:r.from("notification_preferences"))==null?void 0:i.select("*"))==null?void 0:o.eq("user_id",(m=(u=j==null?void 0:j.data)==null?void 0:u.user)==null?void 0:m.id));return p?{data:[],error:{message:p==null?void 0:p.message}}:{data:y||[],error:null}}catch(j){return console.error("Error fetching notification preferences:",j),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(t){var h,r,i,u,m,o,j,y,p,v;try{const x=await((r=(h=Q)==null?void 0:h.auth)==null?void 0:r.getUser());await((j=(u=(i=Q)==null?void 0:i.from("notification_preferences"))==null?void 0:u.delete())==null?void 0:j.eq("user_id",(o=(m=x==null?void 0:x.data)==null?void 0:m.user)==null?void 0:o.id));const O=t==null?void 0:t.map(w=>{var d,U;return{...w,user_id:(U=(d=x==null?void 0:x.data)==null?void 0:d.user)==null?void 0:U.id}}),{data:ne,error:ae}=await((v=(p=(y=Q)==null?void 0:y.from("notification_preferences"))==null?void 0:p.insert(O))==null?void 0:v.select());return ae?{data:null,error:{message:ae==null?void 0:ae.message}}:{data:ne,error:null}}catch(x){return console.error("Error updating notification preferences:",x),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(t){var h,r,i;try{return(i=(r=(h=Q)==null?void 0:h.channel("overdue-jobs"))==null?void 0:r.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},m=>{var o;(o=this.getOverdueJobs())==null||o.then(j=>{j!=null&&j.data&&t(j==null?void 0:j.data)})}))==null?void 0:i.subscribe()}catch(u){return console.error("Error subscribing to overdue jobs:",u),null}},async searchWithFilters(t,h,r){var i,u,m;try{let o=(i=Q)==null?void 0:i.from(r);if(t)switch(r){case"jobs":o=o==null?void 0:o.or(`job_number.ilike.%${t}%,title.ilike.%${t}%`);break;case"vehicles":o=o==null?void 0:o.or(`vin.ilike.%${t}%,make.ilike.%${t}%,model.ilike.%${t}%`);break;case"vendors":o=o==null?void 0:o.or(`name.ilike.%${t}%,specialty.ilike.%${t}%`);break}(u=Object==null?void 0:Object.entries(h))==null||u.forEach(([p,v])=>{v!=null&&v!==""&&(Array!=null&&Array.isArray(v)?o=o==null?void 0:o.in(p,v):typeof v=="object"&&(v==null?void 0:v.min)!==void 0?o=o==null?void 0:o.gte(p,v==null?void 0:v.min):typeof v=="object"&&(v==null?void 0:v.max)!==void 0?o=o==null?void 0:o.lte(p,v==null?void 0:v.max):o=o==null?void 0:o.eq(p,v))});const{data:j,error:y}=await((m=o==null?void 0:o.select("*"))==null?void 0:m.order("created_at",{ascending:!1}));return y?{data:[],error:{message:y==null?void 0:y.message}}:{data:j||[],error:null}}catch(o){return console.error("Error in search with filters:",o),{data:[],error:{message:"Failed to search with filters"}}}}},ws=({exportType:t,filters:h={},selectedIds:r=[],onExportStart:i,onExportComplete:u,onExportError:m,disabled:o=!1,variant:j="outline",size:y="sm",className:p=""})=>{var A;const[v,x]=S.useState(!1),[O,ne]=S.useState(!1),[ae,w]=S.useState("csv"),[d,U]=S.useState("filtered"),{user:c,userProfile:le}=Je(),g=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],P=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(r==null?void 0:r.length)>0?[{value:"selected",label:`Selected (${r==null?void 0:r.length})`}]:[]],L=()=>{var W,je,ce;const B=(ce=(je=(W=new Date)==null?void 0:W.toISOString())==null?void 0:je.split("T"))==null?void 0:ce[0];return`${t}-${d==="selected"?"selected":d}-${B}.${ae}`},q=async()=>{var B,_e,W,je;if(!v)try{x(!0),i&&i();let ce={...h};d==="selected"&&(r==null?void 0:r.length)>0&&(ce.ids=r),d==="all"&&(ce={});const te=await(Ie==null?void 0:Ie.exportData(t,ce,(le==null?void 0:le.role)||"staff"));if(te!=null&&te.error)throw new Error((B=te==null?void 0:te.error)==null?void 0:B.message);if(!(te!=null&&te.data)||((_e=te==null?void 0:te.data)==null?void 0:_e.length)===0)throw new Error("No data found to export");const f=L(),z=await(Ie==null?void 0:Ie.exportToCSV(te==null?void 0:te.data,f));if(z!=null&&z.error)throw new Error((W=z==null?void 0:z.error)==null?void 0:W.message);ne(!1),u&&u((je=te==null?void 0:te.data)==null?void 0:je.length,f)}catch(ce){console.error("Export error:",ce),m&&m((ce==null?void 0:ce.message)||"Export failed")}finally{x(!1)}},_=()=>{switch(t){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(I,{variant:j,size:y,onClick:()=>ne(!O),disabled:o||v,iconName:v?void 0:"Download",iconPosition:"left",className:`${p} ${v?"cursor-wait":""}`,"aria-label":`Export ${_()}`,children:v?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${_()}`}),O&&!v&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ye,{value:ae,onChange:w,options:g,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ye,{value:d,onChange:U,options:P,className:"w-full"})]}),d==="filtered"&&((A=Object==null?void 0:Object.keys(h))==null?void 0:A.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Xe,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),d==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Xe,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",r==null?void 0:r.length," selected record",(r==null?void 0:r.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>ne(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(I,{size:"sm",onClick:q,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${_()}`,children:"Export"})]})]})})]})},Qe={async getVehicles(t={},h=null){var r,i,u,m;try{let o=(u=(i=(r=Q)==null?void 0:r.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:u.order("created_at",{ascending:!1});return h&&(o=o==null?void 0:o.eq("org_id",h)),t!=null&&t.status&&(o=o==null?void 0:o.eq("vehicle_status",t==null?void 0:t.status)),t!=null&&t.make&&(o=o==null?void 0:o.eq("make",t==null?void 0:t.make)),t!=null&&t.year&&(o=o==null?void 0:o.eq("year",t==null?void 0:t.year)),t!=null&&t.search&&(o=o==null?void 0:o.or(`vin.ilike.%${t==null?void 0:t.search}%,make.ilike.%${t==null?void 0:t.search}%,model.ilike.%${t==null?void 0:t.search}%,license_plate.ilike.%${t==null?void 0:t.search}%,owner_name.ilike.%${t==null?void 0:t.search}%,owner_phone.ilike.%${t==null?void 0:t.search}%,owner_email.ilike.%${t==null?void 0:t.search}%,stock_number.ilike.%${t==null?void 0:t.search}%`)),{data:await Ue(o,"vehicles:getVehicles")||[],error:null}}catch(o){return(m=o==null?void 0:o.message)!=null&&m.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(t,h=null){var r,i,u,m,o;try{let j=(m=(u=(i=(r=Q)==null?void 0:r.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:u.eq("id",t))==null?void 0:m.single();return h&&(j=j==null?void 0:j.eq("org_id",h)),{data:await Ue(j,"vehicles:getVehicleById"),error:null}}catch(j){return(o=j==null?void 0:j.message)!=null&&o.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(t){var h,r,i,u,m,o,j,y,p,v;try{const{data:x,error:O}=await((p=(y=(j=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:j.insert([{...t,created_by:(o=(m=(u=await((i=(r=Q)==null?void 0:r.auth)==null?void 0:i.getUser()))==null?void 0:u.data)==null?void 0:m.user)==null?void 0:o.id}]))==null?void 0:y.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:p.single());return O?{data:null,error:{message:O==null?void 0:O.message}}:{data:x,error:null}}catch(x){return(v=x==null?void 0:x.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(t){var h,r,i,u;try{const{data:m,error:o}=await((u=(i=(r=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:r.insert([t]))==null?void 0:i.select())==null?void 0:u.single());if(o)throw console.error("Vehicle creation error:",o),new Error(o.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",m),m}catch(m){throw console.error("Error in vehicleService.create:",m),m}},async createVehicleWithProducts(t){var h,r;try{console.log("Creating vehicle with products:",t);const i=`vehicle_${Date.now()}`;await new Promise(m=>setTimeout(m,1e3));const u={id:i,...t,created_at:(h=new Date)==null?void 0:h.toISOString(),initial_products_count:((r=t==null?void 0:t.initial_products)==null?void 0:r.length)||0,estimated_aftermarket_value:(t==null?void 0:t.total_initial_product_value)||0};return console.log("Vehicle created successfully:",u),u}catch(i){throw console.error("Error creating vehicle with products:",i),i}},async checkStockNumberExists(t){var h,r,i,u;if(!(t!=null&&t.trim()))return!1;try{const{data:m,error:o}=await((u=(i=(r=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:i.eq("stock_number",t==null?void 0:t.trim()))==null?void 0:u.maybeSingle());return o?(console.error("Stock number check error:",o),!1):!!m}catch(m){return console.error("Error checking stock number:",m),!1}},async checkVinExists(t){var h,r,i,u;if(!(t!=null&&t.trim()))return!1;try{const{data:m,error:o}=await((u=(i=(r=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:i.eq("vin",t==null?void 0:t.trim()))==null?void 0:u.maybeSingle());return o?(console.error("VIN check error:",o),!1):!!m}catch(m){return console.error("Error checking VIN:",m),!1}},async updateVehicle(t,h){var r,i,u,m,o,j,y;try{const{data:p,error:v}=await((j=(o=(m=(u=(r=Q)==null?void 0:r.from("vehicles"))==null?void 0:u.update({...h,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:m.eq("id",t))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:j.single());return v?{data:null,error:{message:v==null?void 0:v.message}}:{data:p,error:null}}catch(p){return(y=p==null?void 0:p.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(t){var h,r,i,u;try{const{error:m}=await((i=(r=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:r.delete())==null?void 0:i.eq("id",t));return m?{error:{message:m==null?void 0:m.message}}:{error:null}}catch(m){return(u=m==null?void 0:m.message)!=null&&u.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(t=null){var h,r,i,u,m,o,j;try{let y=(r=(h=Q)==null?void 0:h.from("vehicles"))==null?void 0:r.select("vehicle_status");t&&(y=y==null?void 0:y.eq("org_id",t));const p=await Ue(y,"vehicles:getVehicleStats");return{data:{total:(p==null?void 0:p.length)||0,active:((i=p==null?void 0:p.filter(x=>(x==null?void 0:x.vehicle_status)==="active"))==null?void 0:i.length)||0,maintenance:((u=p==null?void 0:p.filter(x=>(x==null?void 0:x.vehicle_status)==="maintenance"))==null?void 0:u.length)||0,retired:((m=p==null?void 0:p.filter(x=>(x==null?void 0:x.vehicle_status)==="retired"))==null?void 0:m.length)||0,sold:((o=p==null?void 0:p.filter(x=>(x==null?void 0:x.vehicle_status)==="sold"))==null?void 0:o.length)||0},error:null}}catch(y){return(j=y==null?void 0:y.message)!=null&&j.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(t={}){return await this.getVehicles(t)}};function Ss({isOpen:t,onClose:h,onSuccess:r}){var b,V,D;const{user:i}=Je(),{orgId:u}=rs()||{},[m,o]=S.useState(1),[j,y]=S.useState(!1),[p,v]=S.useState(""),[x,O]=S.useState(!1),[ne,ae]=S.useState(!1),[w,d]=S.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),U={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(b=new Date)==null?void 0:b.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[c,le]=S.useState(U),[g,P]=S.useState([]),L=async(n=0)=>{var k,$;try{d(X=>({...X,loading:!0,error:null,retryCount:n}));const[oe,de,ie,K,me]=await Promise.all([ts().catch(()=>[]),ns().catch(()=>[]),as().catch(()=>[]),ls({activeOnly:!0}).catch(()=>[]),cs({activeOnly:!0}).catch(()=>[])]);d({salesConsultants:oe,deliveryCoordinators:de,financeManagers:ie,vendors:K,products:me==null?void 0:me.map(X=>({...X,unitPrice:X==null?void 0:X.unit_price})),loading:!1,error:null,retryCount:n})}catch(oe){if(console.error("Failed to load dropdown data:",oe),n<2&&((k=oe==null?void 0:oe.message)!=null&&k.includes("fetch")||($=oe==null?void 0:oe.message)!=null&&$.includes("network"))){setTimeout(()=>L(n+1),1e3*(n+1));return}d(de=>({...de,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:n}))}},q=({checked:n,onChange:k})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!n,onChange:$=>{var de;const oe=!!((de=$==null?void 0:$.target)!=null&&de.checked);k(oe)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),_=({label:n,options:k,value:$,onChange:oe,placeholder:de,required:ie=!1,helpText:K,testId:me})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[n," ",ie&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:$||"",onChange:X=>{var T;return oe(((T=X==null?void 0:X.target)==null?void 0:T.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:w==null?void 0:w.loading,required:ie,"data-testid":me,children:[e.jsx("option",{value:"",children:de}),k==null?void 0:k.map(X=>e.jsx("option",{value:X==null?void 0:X.id,children:(X==null?void 0:X.full_name)||(X==null?void 0:X.label)||(X==null?void 0:X.name)},X==null?void 0:X.id))]}),K&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:K}),(k==null?void 0:k.length)===0&&!(w!=null&&w.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No ",n==null?void 0:n.toLowerCase()," found yet. Add it in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]});S.useEffect(()=>{const n=(c==null?void 0:c.customerName)!==(U==null?void 0:U.customerName)||(c==null?void 0:c.customerPhone)!==(U==null?void 0:U.customerPhone)||(c==null?void 0:c.customerEmail)!==(U==null?void 0:U.customerEmail)||(c==null?void 0:c.needsLoaner)!==(U==null?void 0:U.needsLoaner)||(c==null?void 0:c.assignedTo)!==(U==null?void 0:U.assignedTo)||(c==null?void 0:c.deliveryCoordinator)!==(U==null?void 0:U.deliveryCoordinator)||(c==null?void 0:c.financeManager)!==(U==null?void 0:U.financeManager)||(g==null?void 0:g.length)>0;O(n)},[c,g]),S.useEffect(()=>{t&&L()},[t]);const A=()=>{P(n=>[...n,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},B=(n,k,$)=>{var oe;if(P(de=>de==null?void 0:de.map(ie=>{if((ie==null?void 0:ie.id)===n){let K={...ie,[k]:$};return k==="requiresScheduling"&&($===!0?K.noScheduleReason="":K.promisedDate=""),K}return ie})),k==="productId"&&$){const de=(oe=w==null?void 0:w.products)==null?void 0:oe.find(ie=>(ie==null?void 0:ie.id)===$);de&&P(ie=>ie==null?void 0:ie.map(K=>(K==null?void 0:K.id)===n?{...K,unitPrice:(de==null?void 0:de.unitPrice)||""}:K))}},_e=n=>{P(k=>k==null?void 0:k.filter($=>($==null?void 0:$.id)!==n))},W=()=>{var n,k;return((k=(n=c==null?void 0:c.customerName)==null?void 0:n.trim())==null?void 0:k.length)>0},je=()=>(g==null?void 0:g.length)===0?!1:g==null?void 0:g.every(n=>{var k;return!(!(n!=null&&n.productId)||!(n!=null&&n.unitPrice)||n!=null&&n.requiresScheduling&&!(n!=null&&n.promisedDate)||!(n!=null&&n.requiresScheduling)&&!((k=n==null?void 0:n.noScheduleReason)!=null&&k.trim())||(n==null?void 0:n.serviceType)==="vendor"&&!(n!=null&&n.vendorId))}),ce=()=>g==null?void 0:g.reduce((n,k)=>n+(parseFloat(k==null?void 0:k.unitPrice)||0),0),te=async()=>{var n,k,$,oe,de,ie,K,me,X,T;if(!W()){v("Customer name is required to save draft");return}y(!0),v("");try{const ee={year:(c==null?void 0:c.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(k=c==null?void 0:c.customerName)==null?void 0:k.trim(),owner_phone:(($=c==null?void 0:c.customerPhone)==null?void 0:$.trim())||null,owner_email:((oe=c==null?void 0:c.customerEmail)==null?void 0:oe.trim())||null,stock_number:((de=c==null?void 0:c.stockNumber)==null?void 0:de.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},we=await Qe.create(ee),Ee={title:`Draft Deal - ${(ie=c==null?void 0:c.customerName)==null?void 0:ie.trim()}`,description:`Draft deal for ${(K=c==null?void 0:c.customerName)==null?void 0:K.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:we==null?void 0:we.id,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),customerName:(me=c==null?void 0:c.customerName)==null?void 0:me.trim(),customerPhone:((X=c==null?void 0:c.customerPhone)==null?void 0:X.trim())||"",customerEmail:((T=c==null?void 0:c.customerEmail)==null?void 0:T.trim())||"",org_id:u||void 0,lineItems:[]};await We.createDeal(Ee),r==null||r(),z(),h()}catch(ee){v(`Failed to save draft: ${ee==null?void 0:ee.message}`)}finally{y(!1)}},f=async()=>{var n,k,$,oe,de,ie,K,me,X,T,ee,we;if(!W()||!je()){v("Please complete all required fields");return}y(!0),v("");try{const Ee={year:(c==null?void 0:c.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(k=c==null?void 0:c.customerName)==null?void 0:k.trim(),owner_phone:(($=c==null?void 0:c.customerPhone)==null?void 0:$.trim())||null,owner_email:((oe=c==null?void 0:c.customerEmail)==null?void 0:oe.trim())||null,stock_number:((de=c==null?void 0:c.stockNumber)==null?void 0:de.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},$e=await Qe.create(Ee),qe=ce(),ue=(g==null?void 0:g.some(l=>(l==null?void 0:l.serviceType)==="vendor"))?"vendor":"in_house",ve=((ie=g==null?void 0:g.find(l=>l==null?void 0:l.vendorId))==null?void 0:ie.vendorId)||null;let Ne=null;if(ue==="vendor"){const l=(g||[]).filter(a=>(a==null?void 0:a.serviceType)==="vendor"&&(a==null?void 0:a.requiresScheduling)&&(a==null?void 0:a.promisedDate)).map(a=>new Date(a==null?void 0:a.promisedDate)).sort((a,C)=>a-C);Ne=(K=(l==null?void 0:l[0])||new Date)==null?void 0:K.toISOString()}const Fe=(g||[]).map(l=>({product_id:l==null?void 0:l.productId,quantity_used:1,unit_price:parseFloat((l==null?void 0:l.unitPrice)||0),promised_date:l!=null&&l.requiresScheduling?l==null?void 0:l.promisedDate:null,requires_scheduling:!!(l!=null&&l.requiresScheduling),no_schedule_reason:l!=null&&l.requiresScheduling?null:l==null?void 0:l.noScheduleReason,is_off_site:(l==null?void 0:l.serviceType)==="vendor"})),Me={title:`Deal - ${(me=c==null?void 0:c.customerName)==null?void 0:me.trim()}`,description:`Deal for ${(X=c==null?void 0:c.customerName)==null?void 0:X.trim()}`,job_status:"pending",service_type:ue,vehicle_id:$e==null?void 0:$e.id,vendor_id:ve,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),scheduled_start_time:Ne,estimated_cost:qe,org_id:u||void 0,customerName:(T=c==null?void 0:c.customerName)==null?void 0:T.trim(),customerPhone:((ee=c==null?void 0:c.customerPhone)==null?void 0:ee.trim())||"",customerEmail:((we=c==null?void 0:c.customerEmail)==null?void 0:we.trim())||"",lineItems:Fe},Ae=await We.createDeal(Me);await We.updateDeal(Ae==null?void 0:Ae.id,Me),r==null||r(),z(),h()}catch(Ee){v(`Failed to create deal: ${Ee==null?void 0:Ee.message}`)}finally{y(!1)}},z=()=>{o(1),le(U),P([]),v(""),O(!1)},Ce=()=>{x?ae(!0):(z(),h())},Le=()=>{ae(!1),z(),h()};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:m===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:Ce,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(H,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${m>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${m>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${m>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${m>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[p&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",p]}),e.jsx("button",{onClick:()=>v(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(H,{name:"X",size:16})})]})}),(w==null?void 0:w.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",w==null?void 0:w.error]}),e.jsx("button",{onClick:()=>L(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),m===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:c==null?void 0:c.customerName,onChange:n=>le(k=>{var $;return{...k,customerName:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:c==null?void 0:c.customerPhone,onChange:n=>le(k=>{var $;return{...k,customerPhone:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:c==null?void 0:c.customerEmail,onChange:n=>le(k=>{var $;return{...k,customerEmail:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(c==null?void 0:c.vehicleYear)||"",onChange:n=>le(k=>{var $;return{...k,vehicleYear:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((V=new Date)==null?void 0:V.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleMake)||"",onChange:n=>le(k=>{var $;return{...k,vehicleMake:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleModel)||"",onChange:n=>le(k=>{var $;return{...k,vehicleModel:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.stockNumber)||"",onChange:n=>le(k=>{var $;return{...k,stockNumber:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(q,{checked:c==null?void 0:c.needsLoaner,onChange:n=>{le(k=>({...k,needsLoaner:!!n}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(_,{label:"Sales Consultant",options:w==null?void 0:w.salesConsultants,value:c==null?void 0:c.assignedTo,onChange:n=>le(k=>({...k,assignedTo:n})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(_,{label:"Delivery Coordinator",options:w==null?void 0:w.deliveryCoordinators,value:c==null?void 0:c.deliveryCoordinator,onChange:n=>le(k=>({...k,deliveryCoordinator:n})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(_,{label:"Finance Manager",options:w==null?void 0:w.financeManagers,value:c==null?void 0:c.financeManager,onChange:n=>le(k=>({...k,financeManager:n})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),m===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(I,{onClick:A,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(H,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(g==null?void 0:g.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(H,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[g==null?void 0:g.map((n,k)=>{var $,oe,de,ie,K,me,X;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",k+1]}),e.jsx("button",{onClick:()=>_e(n==null?void 0:n.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.productId)||"",onChange:T=>{var ee;return B(n==null?void 0:n.id,"productId",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${k}`,children:[e.jsx("option",{value:"",children:"Select product"}),($=w==null?void 0:w.products)==null?void 0:$.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(w!=null&&w.loading)&&(((oe=w==null?void 0:w.products)==null?void 0:oe.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No products found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:n==null?void 0:n.unitPrice,onChange:T=>{var ee;return B(n==null?void 0:n.id,"unitPrice",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${k}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"in_house",checked:(n==null?void 0:n.serviceType)==="in_house",onChange:T=>{var ee;return B(n==null?void 0:n.id,"serviceType",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"mr-2 cursor-pointer"}),"🏠 On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"vendor",checked:(n==null?void 0:n.serviceType)==="vendor",onChange:T=>{var ee;return B(n==null?void 0:n.id,"serviceType",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"mr-2 cursor-pointer"}),"🏢 Off-Site (Vendor)"]})]})]}),(n==null?void 0:n.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.vendorId)||"",onChange:T=>{var ee;return B(n==null?void 0:n.id,"vendorId",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(de=w==null?void 0:w.vendors)==null?void 0:de.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(w!=null&&w.loading)&&(((ie=w==null?void 0:w.vendors)==null?void 0:ie.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!0,onChange:()=>B(n==null?void 0:n.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${k}`,"data-testid":`requires-scheduling-${k}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!1,onChange:()=>B(n==null?void 0:n.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${k}`}),"No Scheduling Needed"]})]}),n!=null&&n.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:n==null?void 0:n.promisedDate,onChange:T=>{var ee;return B(n==null?void 0:n.id,"promisedDate",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},min:(X=(me=(K=new Date)==null?void 0:K.toISOString())==null?void 0:me.split("T"))==null?void 0:X[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:n==null?void 0:n.noScheduleReason,onChange:T=>{var ee;return B(n==null?void 0:n.id,"noScheduleReason",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:n==null?void 0:n.serviceNotes,onChange:T=>{var ee;return B(n==null?void 0:n.id,"serviceNotes",(ee=T==null?void 0:T.target)==null?void 0:ee.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},n==null?void 0:n.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(D=ce())==null?void 0:D.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[g==null?void 0:g.length," item",(g==null?void 0:g.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:m===2&&e.jsx(I,{onClick:()=>o(1),variant:"outline",className:"w-full md:w-auto h-11",children:"← Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(I,{onClick:Ce,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),m===1&&e.jsxs(e.Fragment,{children:[e.jsx(I,{onClick:te,disabled:!W()||j,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:j?"Saving...":"Save Draft"}),e.jsx(I,{onClick:()=>o(2),disabled:!W(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items →"})]}),m===2&&e.jsx(I,{onClick:f,disabled:!W()||!je()||j,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:j?"Creating...":"Create Deal"})]})]})}),ne&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(I,{variant:"outline",onClick:()=>ae(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(I,{onClick:Le,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function ks(t,{activeOnly:h=!0}={}){let r=Q.from("products").select("*").order("name",{ascending:!0});h&&(r=r.eq("is_active",!0)),t&&(r=r.or(`org_id.eq.${t},org_id.is.null`));const i=await Ue(r,"products:listByOrg");return js(i,{labelKey:"name",valueKey:"id"})}function Cs(t,{activeOnly:h=!0}={}){let r=Q.from("user_profiles").select("*").order("full_name",{ascending:!0});return h&&(r=r.eq("is_active",!0)),t&&(r=r.or(`org_id.eq.${t},org_id.is.null`)),Ue(r,"staff:listByOrg")}function os(t={}){var d,U,c,le;const{loadOnMount:h=!0,cacheTime:r=5*60*1e3}=t,[i,u]=S.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[m,o]=S.useState(null),j=rs(),y=Je(),p=async()=>{var g,P,L,q;try{if(j.loading)return;if(u(z=>({...z,loading:!0,error:null})),!((g=j.session)!=null&&g.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),u(z=>({...z,loading:!1}));return}const _=!!j.orgId,A=[(P=ns())==null?void 0:P.catch(z=>(console.error("[dropdowns:dc] Delivery coordinators failed:",z),[])),(L=ts())==null?void 0:L.catch(z=>(console.error("[dropdowns:sales] Sales consultants failed:",z),[])),(q=as())==null?void 0:q.catch(z=>(console.error("[dropdowns:finance] Finance managers failed:",z),[])),_?Cs(j.orgId).catch(z=>(console.error("[dropdowns:users] tenant staff failed:",z),[])):hs({activeOnly:!0}).catch(z=>(console.error("[dropdowns:users] global user profiles failed:",z),[])),_?vs(j.orgId).catch(z=>(console.error("[dropdowns:vendors] tenant vendors failed:",z),[])):ls({activeOnly:!0}).catch(z=>(console.error("[dropdowns:vendors] global vendors failed:",z),[])),_?ks(j.orgId).catch(z=>(console.error("[dropdowns:products] tenant products failed:",z),[])):cs({activeOnly:!0}).catch(z=>(console.error("[dropdowns:products] global products failed:",z),[])),_?ys(j.orgId).catch(z=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",z),[])):Promise.resolve([])],[B,_e,W,je,ce,te,f]=await Promise.all(A);u({dc:B,sales:_e,finance:W,users:je,vendors:ce,products:te,smsTemplates:f,loading:!1,error:null,searchResults:null}),o(Date.now())}catch(_){u({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(_==null?void 0:_.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",_)}};S.useEffect(()=>{try{const g=He({departments:["Sales","Sales Consultant","Sales Consultants"]}),P=He({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),L=He({departments:["Finance","Finance Manager","Finance Managers"]}),q=ds({activeOnly:!0}),_=us({activeOnly:!0});[g==null?void 0:g.length,P==null?void 0:P.length,L==null?void 0:L.length,q==null?void 0:q.length,_==null?void 0:_.length].some(Boolean)&&u(B=>({...B,sales:g||B.sales,dc:P||B.dc,finance:L||B.finance,vendors:q||B.vendors,products:_||B.products,loading:!1,error:null}))}catch(g){console.info("[dropdowns] cached-first hydrate skipped:",g==null?void 0:g.message)}},[]);const v=()=>m?Date.now()-m<r:!1,x=async()=>{v()||await p()},O=async g=>{try{if(!(g!=null&&g.trim())){u(L=>({...L,searchResults:null}));return}const P=await xs(g);u(L=>({...L,searchResults:P}))}catch(P){console.error("[dropdowns:search] Search failed:",P),u(L=>({...L,searchResults:{users:[],vendors:[]}}))}},ne=()=>{u(g=>({...g,searchResults:null}))},ae=(g={})=>{const{roles:P=[],departments:L=[],activeOnly:q=!0}=g;let _=(i==null?void 0:i.users)||[];return q&&(_=_==null?void 0:_.filter(A=>A==null?void 0:A.is_active)),(P==null?void 0:P.length)>0&&(_=_==null?void 0:_.filter(A=>P==null?void 0:P.includes(A==null?void 0:A.role))),(L==null?void 0:L.length)>0&&(_=_==null?void 0:_.filter(A=>L==null?void 0:L.includes(A==null?void 0:A.department))),(_==null?void 0:_.map(A=>({id:A==null?void 0:A.id,value:A==null?void 0:A.id,label:A==null?void 0:A.full_name,name:A==null?void 0:A.full_name,role:A==null?void 0:A.role,department:A==null?void 0:A.department,email:A==null?void 0:A.email})))||[]},w=(g={})=>{const{activeOnly:P=!0,specialty:L=null}=g;let q=(i==null?void 0:i.vendors)||[];return P&&(q=q==null?void 0:q.filter(_=>_==null?void 0:_.is_active)),L&&(q=q==null?void 0:q.filter(_=>{var A,B;return(B=(A=_==null?void 0:_.specialty)==null?void 0:A.toLowerCase())==null?void 0:B.includes(L==null?void 0:L.toLowerCase())})),(q==null?void 0:q.map(_=>({id:_==null?void 0:_.id,value:(_==null?void 0:_.value)||(_==null?void 0:_.id),label:(_==null?void 0:_.label)||(_==null?void 0:_.name),name:_==null?void 0:_.name,specialty:_==null?void 0:_.specialty,email:_==null?void 0:_.email,phone:_==null?void 0:_.phone})))||[]};return S.useEffect(()=>{let g=!0;return(async()=>{var L;if(!h)return;const P=Date.now();for(;g&&(y!=null&&y.loading)&&Date.now()-P<5e3;)await new Promise(q=>setTimeout(q,200));g&&(y!=null&&y.user?(console.log("Dropdowns: authenticated user",(L=y==null?void 0:y.user)==null?void 0:L.id),y!=null&&y.userProfile&&console.log("Dropdowns: user profile org",y.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),g&&await p())})(),()=>{g=!1}},[h,y==null?void 0:y.loading,(d=y==null?void 0:y.user)==null?void 0:d.id,j==null?void 0:j.loading,j==null?void 0:j.orgId]),{dc:i==null?void 0:i.dc,sales:i==null?void 0:i.sales,finance:i==null?void 0:i.finance,users:i==null?void 0:i.users,vendors:i==null?void 0:i.vendors,products:i==null?void 0:i.products,smsTemplates:i==null?void 0:i.smsTemplates,loading:i==null?void 0:i.loading,error:i==null?void 0:i.error,searchResults:i==null?void 0:i.searchResults,globalSearch:O,clearSearch:ne,getUserOptions:ae,getVendorOptions:w,refresh:p,refreshIfNeeded:x,lastUpdate:m,isCacheValid:v(),salesConsultantOptions:(U=(i==null?void 0:i.sales)||[])==null?void 0:U.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),deliveryCoordinatorOptions:(c=(i==null?void 0:i.dc)||[])==null?void 0:c.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),financeManagerOptions:(le=(i==null?void 0:i.finance)||[])==null?void 0:le.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name}))}}const Es=()=>{var y,p,v;const{dc:t,sales:h,finance:r,vendors:i,products:u,loading:m,error:o,refresh:j}=os({loadOnMount:!0});return{salesConsultants:h,deliveryCoordinators:t,financeManagers:r,vendors:i,products:u,loading:m,error:o,refresh:j,salesConsultantOptions:(y=h||[])==null?void 0:y.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),deliveryCoordinatorOptions:(p=t||[])==null?void 0:p.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),financeManagerOptions:(v=r||[])==null?void 0:v.map(x=>({id:x==null?void 0:x.id,value:x==null?void 0:x.id,label:x==null?void 0:x.full_name,name:x==null?void 0:x.full_name})),vendorOptions:i||[],productOptions:u||[]}},Ts=()=>(is.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Re=({options:t=[],value:h,onChange:r,placeholder:i="Select...",searchable:u=!1,clearable:m=!1,disabled:o=!1,loading:j=!1,error:y=null,className:p="",optionLabel:v="label",optionValue:x="value",groupBy:O=null,renderOption:ne=null,label:ae="",helperText:w=""})=>{const[d,U]=S.useState(!1),[c,le]=S.useState(""),[g,P]=S.useState(!1),[L,q]=S.useState(t),[_,A]=S.useState(-1),[B,_e]=S.useState({top:0,left:0,width:0}),W=S.useRef(null),je=S.useRef(null);S.useRef(null),S.useEffect(()=>{P((()=>{var n;return(n=window.matchMedia("(max-width: 767px)"))==null?void 0:n.matches})());const V=window.matchMedia("(max-width: 767px)"),D=()=>P(V==null?void 0:V.matches);return V==null||V.addEventListener("change",D),()=>V==null?void 0:V.removeEventListener("change",D)},[]),S.useEffect(()=>{if(!(c!=null&&c.trim())){q(t);return}const b=c==null?void 0:c.toLowerCase(),V=t==null?void 0:t.filter(D=>{const n=[D==null?void 0:D.name,D==null?void 0:D.displayName,D==null?void 0:D.category,D==null?void 0:D.brand,D==null?void 0:D.specialty,D==null?void 0:D.department,D==null?void 0:D.email].filter(Boolean);return n==null?void 0:n.some(k=>{var $;return($=k==null?void 0:k.toLowerCase())==null?void 0:$.includes(b)})});q(V),A(-1)},[c,t]);const ce=t==null?void 0:t.find(b=>(b==null?void 0:b.id)===h),te=b=>((b==null?void 0:b[x])||(b==null?void 0:b.id))===h,f=()=>{var b;if(W!=null&&W.current){const V=(b=W==null?void 0:W.current)==null?void 0:b.getBoundingClientRect();_e({top:(V==null?void 0:V.bottom)+window.scrollY,left:(V==null?void 0:V.left)+window.scrollX,width:V==null?void 0:V.width})}};S.useEffect(()=>{d&&!g&&f()},[d,g]),S.useEffect(()=>{if(g)return;const b=V=>{var D;W!=null&&W.current&&!((D=W==null?void 0:W.current)!=null&&D.contains(V==null?void 0:V.target))&&(U(!1),le(""),A(-1))};return document==null||document.addEventListener("mousedown",b),()=>document==null?void 0:document.removeEventListener("mousedown",b)},[g]);const z=b=>{if(!g){if(!d){((b==null?void 0:b.key)==="Enter"||(b==null?void 0:b.key)===" "||(b==null?void 0:b.key)==="ArrowDown")&&(b==null||b.preventDefault(),U(!0),u&&setTimeout(()=>{var V;return(V=je==null?void 0:je.current)==null?void 0:V.focus()},0));return}switch(b==null?void 0:b.key){case"Escape":U(!1),le(""),A(-1);break;case"ArrowDown":b==null||b.preventDefault(),A(V=>V<(L==null?void 0:L.length)-1?V+1:0);break;case"ArrowUp":b==null||b.preventDefault(),A(V=>V>0?V-1:(L==null?void 0:L.length)-1);break;case"Enter":b==null||b.preventDefault(),_>=0&&(L!=null&&L[_])&&Ce(L==null?void 0:L[_]);break;case"Tab":U(!1),le(""),A(-1);break}}},Ce=b=>{r==null||r(b==null?void 0:b.id),U(!1),le(""),A(-1)},Le=b=>{b==null||b.stopPropagation(),r==null||r(null)};return g?e.jsxs("div",{className:`relative ${p}`,children:[e.jsxs("select",{value:h||"",onChange:b=>{var V;return r==null?void 0:r(((V=b==null?void 0:b.target)==null?void 0:V.value)||null)},disabled:o||j,className:`
            w-full px-3 py-2 border rounded-lg
            ${y?"border-red-500":"border-gray-300"}
            ${o||j?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:i}),t==null?void 0:t.map(b=>e.jsx("option",{value:(b==null?void 0:b[x])||(b==null?void 0:b.id),children:(b==null?void 0:b[v])||(b==null?void 0:b.label)||(b==null?void 0:b.name)},(b==null?void 0:b[x])||(b==null?void 0:b.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(H,{name:"ChevronDown",size:16,className:"text-gray-400"})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]}):e.jsxs("div",{className:`relative ${p}`,ref:W,children:[e.jsxs("button",{type:"button",onClick:()=>!o&&!j&&U(!d),onKeyDown:z,disabled:o||j,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${y?"border-red-500":"border-gray-300"}
          ${o||j?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${d?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:ce?"text-gray-900":"text-gray-500",children:ce?(ce==null?void 0:ce[v])||(ce==null?void 0:ce.label):i}),e.jsxs("div",{className:"flex items-center space-x-1",children:[j&&e.jsx(H,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),m&&ce&&!j&&e.jsx("button",{type:"button",onClick:Le,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(H,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(H,{name:d?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),d&&typeof window<"u"&&e.jsx(Ts,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>U(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${B==null?void 0:B.top}px`,left:`${B==null?void 0:B.left}px`,width:`${B==null?void 0:B.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:b=>b==null?void 0:b.stopPropagation(),children:[u&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:c,onChange:b=>{var V;return le((V=b==null?void 0:b.target)==null?void 0:V.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(L==null?void 0:L.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:c?"No results found":"No options available"}):L==null?void 0:L.map(b=>e.jsx("button",{type:"button",onClick:()=>Ce(b),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${te(b)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(b==null?void 0:b[v])||(b==null?void 0:b.label)||(b==null?void 0:b.name)},(b==null?void 0:b[x])||(b==null?void 0:b.id)))})]})})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]})},As=({isOpen:t,dealId:h,deal:r,onClose:i,onSuccess:u})=>{var Be,ue,ve,Ne,Fe,Me,Ae;const[m,o]=S.useState(!0),[j,y]=S.useState(!1),[p,v]=S.useState(""),[x,O]=S.useState(!1),[ne,ae]=S.useState(!1),[w,d]=S.useState(!1),[U,c]=S.useState(!1),[le,g]=S.useState(null),[P,L]=S.useState(null),[q,_]=S.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:A,deliveryCoordinatorOptions:B,financeManagerOptions:_e,vendorOptions:W,productOptions:je,loading:ce,refresh:te}=Es(),[f,z]=S.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),Ce=(l=[],a,C="Selected")=>!a||Array.isArray(l)&&l.some(F=>(F==null?void 0:F.id)===a)?l:[...l||[],{id:a,value:a,label:C}],Le=S.useMemo(()=>Ce(W,f==null?void 0:f.vendor_id,"Selected vendor"),[W,f==null?void 0:f.vendor_id]),b=S.useMemo(()=>Ce(A,f==null?void 0:f.assignedTo,"Selected user"),[A,f==null?void 0:f.assignedTo]),V=S.useMemo(()=>Ce(B,f==null?void 0:f.deliveryCoordinator,"Selected user"),[B,f==null?void 0:f.deliveryCoordinator]),D=S.useMemo(()=>Ce(_e,f==null?void 0:f.financeManager,"Selected user"),[_e,f==null?void 0:f.financeManager]);S.useEffect(()=>{if(le){const l=JSON.stringify(f)!==JSON.stringify(le);d(l)}},[f,le]),S.useEffect(()=>{if(t)try{te==null||te()}catch{}},[t,te]),S.useEffect(()=>{var l;if(t)if(r&&(r!=null&&r.id))try{const a=Ge(r),C={...a,assignedTo:(a==null?void 0:a.assigned_to)||null,deliveryCoordinator:(a==null?void 0:a.delivery_coordinator_id)||null,financeManager:(a==null?void 0:a.finance_manager_id)||null,vendor_id:(a==null?void 0:a.vendor_id)||null,customerName:(r==null?void 0:r.customer_name)||"",customerPhone:(r==null?void 0:r.customer_phone)||"",customerEmail:(r==null?void 0:r.customer_email)||"",lineItems:((l=(a==null?void 0:a.lineItems)||[])==null?void 0:l.length)>0?oe(a==null?void 0:a.lineItems):[ie()]};z(C),g(JSON.parse(JSON.stringify(C))),o(!1),v("")}catch(a){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",a),de()}else h?de():(v("No deal selected to edit."),o(!1))},[t,h,r==null?void 0:r.id]),S.useEffect(()=>{if(!t||!m)return;const l=setTimeout(()=>{o(!1),v(a=>a||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(l)},[t,m]);const n=({checked:l,onChange:a})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!l,onChange:C=>{var F;return a(!!((F=C==null?void 0:C.target)!=null&&F.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),k=({value:l,selectedValue:a,onChange:C,itemIndex:F,disabled:be=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${F}`,value:"in_house",checked:!a,onChange:()=>C(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:be}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏠 On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${F}`,value:"vendor",checked:a,onChange:()=>C(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:be}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏢 Off-Site"})]})]}),$=({requiresScheduling:l,onChange:a,itemIndex:C,disabled:F=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${C}`,checked:l===!0,onChange:()=>a(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:F}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${C}`,checked:l===!1,onChange:()=>a(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:F}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),oe=(l=[])=>(l||[]).map(a=>({product_id:(a==null?void 0:a.product_id)??null,unit_price:(a==null?void 0:a.unit_price)??0,quantity_used:(a==null?void 0:a.quantity_used)??1,lineItemPromisedDate:(a==null?void 0:a.lineItemPromisedDate)||(a==null?void 0:a.promised_date)||"",requiresScheduling:typeof(a==null?void 0:a.requiresScheduling)=="boolean"?a==null?void 0:a.requiresScheduling:!!(a!=null&&a.requires_scheduling),noScheduleReason:(a==null?void 0:a.noScheduleReason)||(a==null?void 0:a.no_schedule_reason)||"",isOffSite:typeof(a==null?void 0:a.isOffSite)=="boolean"?a==null?void 0:a.isOffSite:!!(a!=null&&a.is_off_site),description:(a==null?void 0:a.description)||""})),de=async()=>{var l,a,C,F,be,se,Y,J,ye,s;try{o(!0),v("");const N=await ms(h),E=Ge(N),{data:M}=await((F=(C=(a=(l=Q)==null?void 0:l.from("transactions"))==null?void 0:a.select("customer_name, customer_phone, customer_email"))==null?void 0:C.eq("job_id",h))==null?void 0:F.single());let R=null;try{const{data:he}=await((ye=(J=(Y=(se=(be=Q)==null?void 0:be.from("loaner_assignments"))==null?void 0:se.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:Y.eq("job_id",h))==null?void 0:J.is("returned_at",null))==null?void 0:ye.limit(1));R=Array.isArray(he)?he[0]:he}catch{}const fe={...E,assignedTo:(E==null?void 0:E.assigned_to)||null,deliveryCoordinator:(E==null?void 0:E.delivery_coordinator_id)||null,financeManager:(E==null?void 0:E.finance_manager_id)||null,vendor_id:(E==null?void 0:E.vendor_id)||null,customerName:(M==null?void 0:M.customer_name)||"",customerPhone:(M==null?void 0:M.customer_phone)||"",customerEmail:(M==null?void 0:M.customer_email)||"",lineItems:((s=(E==null?void 0:E.lineItems)||[])==null?void 0:s.length)>0?oe(E==null?void 0:E.lineItems):[ie()]};if(z(fe),g(JSON.parse(JSON.stringify(fe))),L(R||null),R)_({loaner_number:(R==null?void 0:R.loaner_number)||"",eta_return_date:(R==null?void 0:R.eta_return_date)||"",notes:(R==null?void 0:R.notes)||""});else{const he=((fe==null?void 0:fe.lineItems)||[]).filter(G=>(G==null?void 0:G.requiresScheduling)&&(G==null?void 0:G.lineItemPromisedDate)).map(G=>new Date(G.lineItemPromisedDate).getTime()),ge=he!=null&&he.length?new Date(Math.max(...he)):null;_(G=>({...G,eta_return_date:ge?ge.toISOString().split("T")[0]:""}))}}catch(N){v(`Failed to load deal: ${N==null?void 0:N.message}`)}finally{o(!1)}},ie=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),K=l=>{z(a=>({...a,...l}))},me=(l,a)=>{if(z(C=>{var F;return{...C,lineItems:(F=C==null?void 0:C.lineItems)==null?void 0:F.map((be,se)=>{if(se===l){let Y={...be,...a};return"requiresScheduling"in a&&(Y.requiresScheduling=!!(a!=null&&a.requiresScheduling),(a==null?void 0:a.requiresScheduling)===!0?Y.noScheduleReason="":Y.lineItemPromisedDate=""),"isOffSite"in a&&(Y.isOffSite=!!(a!=null&&a.isOffSite),a!=null&&a.isOffSite||(Y.vendorId="")),Y}return be})}}),a!=null&&a.product_id){const C=je==null?void 0:je.find(F=>(F==null?void 0:F.id)===(a==null?void 0:a.product_id));C&&z(F=>{var be;return{...F,lineItems:(be=F==null?void 0:F.lineItems)==null?void 0:be.map((se,Y)=>Y===l?{...se,unit_price:(C==null?void 0:C.unitPrice)||(C==null?void 0:C.unit_price)||(se==null?void 0:se.unit_price),cost_price:(C==null?void 0:C.cost)||(se==null?void 0:se.cost_price)}:se)}})}},X=()=>{z(l=>({...l,lineItems:[...l==null?void 0:l.lineItems,ie()]}))},T=l=>{z(a=>{var C;return{...a,lineItems:(C=a==null?void 0:a.lineItems)==null?void 0:C.filter((F,be)=>be!==l)}})},ee=async()=>{var l,a,C,F,be;try{if(y(!0),v(""),!((l=f==null?void 0:f.customerName)!=null&&l.trim())){v("Customer name is required");return}for(let J=0;J<((a=f==null?void 0:f.lineItems)==null?void 0:a.length);J++){const ye=(C=f==null?void 0:f.lineItems)==null?void 0:C[J];if(!(ye!=null&&ye.product_id)){v(`Line item ${J+1}: Product is required`);return}if(ye!=null&&ye.requiresScheduling&&!(ye!=null&&ye.lineItemPromisedDate)){v(`Line item ${J+1}: Promised date is required when scheduling is needed`);return}if(!(ye!=null&&ye.requiresScheduling)&&!((F=ye==null?void 0:ye.noScheduleReason)!=null&&F.trim())){v(`Line item ${J+1}: Reason is required when no scheduling is needed`);return}}const se={...f,customer_needs_loaner:!!(f!=null&&f.customer_needs_loaner),lineItems:(be=f==null?void 0:f.lineItems)==null?void 0:be.map(J=>({...J,requiresScheduling:!!(J!=null&&J.requiresScheduling),isOffSite:!!(J!=null&&J.isOffSite),unit_price:parseFloat(J==null?void 0:J.unit_price)||0,quantity_used:parseInt(J==null?void 0:J.quantity_used)||1}))},Y={...se,assigned_to:(se==null?void 0:se.assignedTo)??null,delivery_coordinator_id:(se==null?void 0:se.deliveryCoordinator)??null,finance_manager_id:(se==null?void 0:se.financeManager)??null,vendor_id:(se==null?void 0:se.vendor_id)??null};await gs(h,{...Y,loanerForm:q}),u==null||u(),i==null||i()}catch(se){v(`Failed to save deal: ${se==null?void 0:se.message}`)}finally{y(!1)}},we=async()=>{try{ae(!0),await bs(h),u==null||u(),i==null||i()}catch(l){v(`Failed to delete deal: ${l==null?void 0:l.message}`)}finally{ae(!1),O(!1)}},Ee=()=>{w?c(!0):i()},$e=()=>{c(!1),i()},qe=()=>{var l;return((l=f==null?void 0:f.lineItems)==null?void 0:l.reduce((a,C)=>{const F=parseFloat(C==null?void 0:C.unit_price)||0,be=parseInt(C==null?void 0:C.quantity_used)||1;return a+F*be},0))||0};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:Ee,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(H,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[p&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:p})}),m?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{de();try{te==null||te()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ye,{value:f==null?void 0:f.job_status,onChange:l=>{var a;return K({job_status:(a=l==null?void 0:l.target)==null?void 0:a.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(ke,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:f==null?void 0:f.customerName,onChange:l=>{var a;return K({customerName:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(ke,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:f==null?void 0:f.customerPhone,onChange:l=>{var a;return K({customerPhone:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(ke,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:f==null?void 0:f.customerEmail,onChange:l=>{var a;return K({customerEmail:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ye,{value:f==null?void 0:f.priority,onChange:l=>{var a;return K({priority:(a=l==null?void 0:l.target)==null?void 0:a.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(ke,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(f==null?void 0:f.vehicleYear)||"",onChange:l=>{var a;return K({vehicleYear:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"2024",min:"1900",max:((Be=new Date)==null?void 0:Be.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(ke,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(f==null?void 0:f.vehicleMake)||"",onChange:l=>{var a;return K({vehicleMake:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(ke,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(f==null?void 0:f.vehicleModel)||"",onChange:l=>{var a;return K({vehicleModel:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(ke,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(f==null?void 0:f.stockNumber)||"",onChange:l=>{var a;return K({stockNumber:(a=l==null?void 0:l.target)==null?void 0:a.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(n,{checked:f==null?void 0:f.customer_needs_loaner,onChange:l=>{if(K({customer_needs_loaner:l}),l&&!(q!=null&&q.eta_return_date)){const a=((f==null?void 0:f.lineItems)||[]).filter(F=>(F==null?void 0:F.requiresScheduling)&&(F==null?void 0:F.lineItemPromisedDate)).map(F=>new Date(F.lineItemPromisedDate).getTime()),C=a!=null&&a.length?new Date(Math.max(...a)):null;C&&_(F=>({...F,eta_return_date:C.toISOString().split("T")[0]}))}}}),P&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",P==null?void 0:P.loaner_number,(P==null?void 0:P.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["• due"," ",(ue=new Date(P==null?void 0:P.eta_return_date))==null?void 0:ue.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(f==null?void 0:f.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(ke,{id:"loaner-number","aria-label":"Loaner number",value:(q==null?void 0:q.loaner_number)||"",onChange:l=>_(a=>{var C;return{...a,loaner_number:(C=l==null?void 0:l.target)==null?void 0:C.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(ke,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(q==null?void 0:q.eta_return_date)||"",onChange:l=>_(a=>{var C;return{...a,eta_return_date:(C=l==null?void 0:l.target)==null?void 0:C.value}}),min:(Fe=(Ne=(ve=new Date)==null?void 0:ve.toISOString())==null?void 0:Ne.split("T"))==null?void 0:Fe[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ke,{id:"loaner-notes","aria-label":"Loaner notes",value:(q==null?void 0:q.notes)||"",onChange:l=>_(a=>{var C;return{...a,notes:(C=l==null?void 0:l.target)==null?void 0:C.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"mb-4","data-testid":"vendor-select",children:[e.jsx(Re,{label:"Vendor",options:Le,value:(f==null?void 0:f.vendor_id)||"",onChange:l=>K({vendor_id:l||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"}),!ce&&((W==null?void 0:W.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"sales-select",children:[e.jsx(Re,{label:"Sales Consultant",options:b,value:f==null?void 0:f.assignedTo,onChange:l=>K({assignedTo:l}),placeholder:"Select sales consultant",searchable:!0,clearable:!0}),!ce&&((A==null?void 0:A.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"delivery-select",children:[e.jsx(Re,{label:"Delivery Coordinator",options:V,value:f==null?void 0:f.deliveryCoordinator,onChange:l=>K({deliveryCoordinator:l}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0}),!ce&&((B==null?void 0:B.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{"data-testid":"finance-select",children:[e.jsx(Re,{label:"Finance Manager",options:D,value:f==null?void 0:f.financeManager,onChange:l=>K({financeManager:l}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"}),!ce&&((_e==null?void 0:_e.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(I,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:X,children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(Me=f==null?void 0:f.lineItems)==null?void 0:Me.map((l,a)=>{var C,F,be,se;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",a+1]}),((C=f==null?void 0:f.lineItems)==null?void 0:C.length)>1&&e.jsx(I,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>T(a),children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Re,{label:"Product *",options:je,value:(l==null?void 0:l.product_id)||"",onChange:Y=>me(a,{product_id:Y?parseInt(Y):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(ke,{id:`unit-price-${a}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:l==null?void 0:l.unit_price,onChange:Y=>{var J;return me(a,{unit_price:parseFloat((J=Y==null?void 0:Y.target)==null?void 0:J.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(ke,{id:`quantity-${a}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:l==null?void 0:l.quantity_used,onChange:Y=>{var J;return me(a,{quantity_used:parseInt((J=Y==null?void 0:Y.target)==null?void 0:J.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(k,{selectedValue:l==null?void 0:l.isOffSite,onChange:Y=>me(a,{isOffSite:Y}),itemIndex:a})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx($,{requiresScheduling:l==null?void 0:l.requiresScheduling,onChange:Y=>me(a,{requiresScheduling:Y}),itemIndex:a})}),l!=null&&l.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(ke,{id:`promised-date-${a}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:l==null?void 0:l.lineItemPromisedDate,onChange:Y=>{var J;return me(a,{lineItemPromisedDate:(J=Y==null?void 0:Y.target)==null?void 0:J.value})},min:(se=(be=(F=new Date)==null?void 0:F.toISOString())==null?void 0:be.split("T"))==null?void 0:se[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ke,{id:`notes-${a}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(l==null?void 0:l.description)||"",onChange:Y=>{var J;return me(a,{description:(J=Y==null?void 0:Y.target)==null?void 0:J.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(ke,{id:`no-schedule-reason-${a}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:l==null?void 0:l.noScheduleReason,onChange:Y=>{var J;return me(a,{noScheduleReason:(J=Y==null?void 0:Y.target)==null?void 0:J.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(l==null?void 0:l.unit_price)||0)*(parseInt(l==null?void 0:l.quantity_used)||1)).toFixed(2)]})]},a)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(Ae=qe())==null?void 0:Ae.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(I,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>O(!0),children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(I,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:Ee,children:"Cancel"}),e.jsx(I,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:ee,disabled:j,children:j?"Saving...":"Save Changes"})]})]}),x&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(I,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>O(!1),children:"Cancel"}),e.jsx(I,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:we,disabled:ne,children:ne?"Deleting...":"Delete"})]})]})}),U&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(I,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>c(!1),children:"Keep Editing"}),e.jsx(I,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:$e,children:"Discard Changes"})]})]})})]})}):null};function Ls({isOpen:t,onClose:h,deal:r}){const[i,u]=S.useState("Customer"),[m,o]=S.useState(""),j=S.useMemo(()=>["Customer","Vehicle","Deal & Pricing","Scheduling","Vendor","Files","Activity","Alerts/Holds"],[]);if(!t||!r)return null;const y=async x=>{try{await navigator.clipboard.writeText(x),o("Copied!"),setTimeout(()=>o(""),1500)}catch{o("Copy failed"),setTimeout(()=>o(""),1500)}},p=({title:x,children:O})=>e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2",children:x}),e.jsx("div",{className:"bg-white border border-slate-200 rounded-lg p-3 text-sm text-slate-800",children:O||e.jsx("span",{className:"text-slate-400",children:"—"})})]}),v=()=>{var x,O,ne,ae,w;switch(i){case"Customer":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Customer",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(r==null?void 0:r.customer_name)||"—"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_email)||"—"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_phone)||"—"})]}),e.jsxs("div",{className:"flex gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:d=>d.stopPropagation(),children:e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:d=>d.stopPropagation(),children:e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",onClick:()=>y(`${(r==null?void 0:r.customer_name)||""} ${(r==null?void 0:r.customer_phone)||""}`.trim()),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy"]})]})]})})});case"Vehicle":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Vehicle",children:e.jsxs("div",{children:[e.jsx("div",{children:r!=null&&r.vehicle?`${((x=r==null?void 0:r.vehicle)==null?void 0:x.year)||""} ${((O=r==null?void 0:r.vehicle)==null?void 0:O.make)||""} ${((ne=r==null?void 0:r.vehicle)==null?void 0:ne.model)||""}`.trim():"—"}),((ae=r==null?void 0:r.vehicle)==null?void 0:ae.stock_number)&&e.jsxs("div",{className:"text-slate-600",children:["Stock: ",(w=r==null?void 0:r.vehicle)==null?void 0:w.stock_number]})]})})});case"Deal & Pricing":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Totals",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Value"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(parseFloat(r==null?void 0:r.total_amount)||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Est. Margin"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(r==null?void 0:r.total_amount)||0)*.25)})]})]})})});case"Scheduling":return e.jsxs(e.Fragment,{children:[e.jsx(p,{title:"Appointment",children:r!=null&&r.appt_start?e.jsxs("div",{className:"text-sm",children:[new Date(r==null?void 0:r.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," • ",new Date(r==null?void 0:r.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"–",r!=null&&r.appt_end?new Date(r==null?void 0:r.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):"—"}),e.jsx(p,{title:"Next Promise",children:r!=null&&r.next_promised_iso?new Date(r==null?void 0:r.next_promised_iso).toLocaleString():"—"})]});case"Vendor":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Vendor",children:e.jsx("div",{children:(r==null?void 0:r.vendor_name)||"Unassigned"})})});case"Files":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Files",children:"No files yet."})});case"Activity":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Activity",children:"Activity timeline coming soon."})});case"Alerts/Holds":return e.jsx(e.Fragment,{children:e.jsx(p,{title:"Alerts/Holds",children:"No alerts."})});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50",onClick:h}),e.jsxs("div",{className:"fixed right-0 top-0 h-full w-full md:w-[520px] bg-white shadow-xl z-50 overflow-y-auto",children:[e.jsxs("div",{className:"p-5 border-b bg-white sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:(r==null?void 0:r.job_number)||`Job-${String((r==null?void 0:r.id)||"").slice(0,8)}`}),e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:(r==null?void 0:r.customer_name)||"Deal Details"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[m&&e.jsx("span",{className:"text-xs text-slate-500",children:m}),e.jsx(I,{variant:"ghost",size:"icon",onClick:h,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:x=>x.stopPropagation(),children:e.jsxs(I,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:x=>x.stopPropagation(),children:e.jsxs(I,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",onClick:()=>y((r==null?void 0:r.customer_phone)||""),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy Phone"]}),e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"Calendar",size:16,className:"mr-1"})," Schedule"]}),e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"FileText",size:16,className:"mr-1"})," Note"]}),e.jsxs(I,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-1"})," Complete"]})]})]}),e.jsx("div",{className:"px-5 pt-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:j.map(x=>e.jsx("button",{onClick:()=>u(x),className:`px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap border ${i===x?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:x},x))})}),e.jsx("div",{className:"p-5",children:v()})]})]})}const De=({status:t})=>{var u;const h={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},r=(h==null?void 0:h[t])||"bg-gray-100 text-gray-700",i=((u=t==null?void 0:t.replace("_"," "))==null?void 0:u.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${r}`,children:i})},$s=t=>{try{if(!t)return"—";const h=new Date(t);if(Number.isNaN(h.getTime()))return"—";const r=Date.now()-h.getTime(),i=Math.floor(r/1e3),u=Math.floor(i/60),m=Math.floor(u/60),o=Math.floor(m/24);return o>0?`${o}d ago`:m>0?`${m}h ago`:u>0?`${u}m ago`:"just now"}catch{return"—"}},es=({nextPromisedAt:t})=>{var y;if(!t)return e.jsx("span",{className:"text-xs text-gray-500",children:"—"});const h=new Date,i=new Date(t)-h,u=i<0,m=i>=0&&i<24*60*60*1e3,o=u?"bg-red-100 text-red-800 border-red-200":m?"bg-amber-100 text-amber-800 border-amber-200":"bg-green-100 text-green-800 border-green-200",j=(y=new Date(t))==null?void 0:y.toLocaleDateString("en-US",{month:"short",day:"numeric"});return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${o}`,children:["Next: ",j]})},ss=({serviceType:t,jobParts:h})=>{const r=h==null?void 0:h.some(u=>u==null?void 0:u.is_off_site),i=h==null?void 0:h.some(u=>!(u!=null&&u.is_off_site));return r&&i?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"🏢 Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})]}):r?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"🏢 Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})},Ms=({draftsCount:t,onViewDrafts:h})=>{const[r,i]=S.useState(!1);return t===0||r?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(H,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft – needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",t," draft deal",t>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{size:"sm",variant:"ghost",onClick:h,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>i(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(H,{name:"X",size:16})})]})]})})},Os=({loaner:t,onClose:h,onConfirm:r,loading:i})=>t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",t==null?void 0:t.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(I,{variant:"outline",onClick:h,className:"flex-1 h-11",disabled:i,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(I,{onClick:r,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:i,"aria-label":"Confirm loaner returned",children:i?"Processing...":"Mark Returned"})]})]})})}):null;function Js(){var ye;const[t,h]=S.useState([]),[r,i]=S.useState(!0),[u,m]=S.useState(!1),[o,j]=S.useState(!1),[y,p]=S.useState(null),[v,x]=S.useState(null),[O,ne]=S.useState(null),[ae,w]=S.useState(""),[d,U]=S.useState({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),[c,le]=S.useState(!1),[g,P]=S.useState(null),[L,q]=S.useState(!1),[_,A]=S.useState(null),[B,_e]=S.useState(!1),[W,je]=S.useState(""),[ce,te]=S.useState(!1),[f,z]=S.useState(null),{getUserOptions:Ce,getVendorOptions:Le,clearSearch:b,error:V}=os({loadOnMount:!0});Ns();const{user:D}=Je(),[n,k]=S.useState([]),[$,oe]=S.useState(""),de=()=>{try{return Ce({roles:["staff"],departments:["Sales Consultants"],activeOnly:!0})||[]}catch(s){return console.error("Error getting sales consultants:",s),[]}},ie=()=>{try{return Ce({roles:["admin","manager"],departments:["Delivery Coordinator"],activeOnly:!0})||[]}catch(s){return console.error("Error getting delivery coordinators:",s),[]}},K=()=>{try{return Ce({roles:["staff"],departments:["Finance Manager"],activeOnly:!0})||[]}catch(s){return console.error("Error getting finance managers:",s),[]}},me=(s={})=>{try{return Le(s)||[]}catch(N){return console.error("Error getting vendor options:",N),[]}},X=async s=>{var N;try{w("");const{error:E}=await((N=Q)==null?void 0:N.rpc("delete_job_cascade",{p_job_id:s}));if(E)throw E;ne(null),await we()}catch(E){w(`Failed to delete deal: ${E==null?void 0:E.message}`),console.error("Delete error:",E)}},T=async s=>{var N,E,M,R,fe,he,ge,G,xe,pe;try{q(!0),w("");let Z=null;try{const{data:re}=await((fe=(R=(M=(E=(N=Q)==null?void 0:N.from("loaner_assignments"))==null?void 0:E.select("id"))==null?void 0:M.eq("job_id",s==null?void 0:s.job_id))==null?void 0:R.is("returned_at",null))==null?void 0:fe.limit(1));Z=Array.isArray(re)?re[0]:re}catch{}if(Z!=null&&Z.id){const{error:re}=await((G=(ge=(he=Q)==null?void 0:he.from("loaner_assignments"))==null?void 0:ge.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:G.eq("id",Z.id));if(re)throw re}else{const{error:re}=await((pe=(xe=Q)==null?void 0:xe.from("loaner_assignments"))==null?void 0:pe.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(re)throw re}le(!1),P(null),await we()}catch(Z){const re=`Failed to save loaner assignment: ${Z==null?void 0:Z.message}`;throw w(re),new Error(re)}finally{q(!1)}},ee=async s=>{try{_e(!0),w(""),await fs(s==null?void 0:s.loaner_id),A(null),await we()}catch(N){w(`Failed to mark loaner as returned: ${N==null?void 0:N.message}`),console.error("Mark returned error:",N)}finally{_e(!1)}},we=async(s=0)=>{var N,E;try{i(!0),w("");const M=await ps();h(M||[])}catch(M){const R=`Failed to load deals: ${M==null?void 0:M.message}`;if(console.error("Load deals error:",M),s<2&&((N=M==null?void 0:M.message)!=null&&N.includes("fetch")||(E=M==null?void 0:M.message)!=null&&E.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>we(s+1),1e3*(s+1));return}w(R),h([])}finally{i(!1)}};S.useEffect(()=>{var E;const s=new URLSearchParams(window.location.search),N=s==null?void 0:s.get("status");if(N){const M=((E=N==null?void 0:N.charAt(0))==null?void 0:E.toUpperCase())+(N==null?void 0:N.slice(1));U(R=>({...R,status:M}))}},[]),S.useEffect(()=>{we()},[]),S.useEffect(()=>{try{const s=localStorage.getItem("dealsSavedViews");if(s){const N=JSON.parse(s);Array.isArray(N)&&k(N)}}catch{}},[]);const Ee=s=>{P(s),le(!0)},$e=s=>{z(s),te(!0)},qe=({message:s,onClose:N})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),N&&e.jsx("button",{onClick:N,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(H,{name:"X",size:16})})]})}):null,ue=(s=>{var G,xe,pe;const N=s||[],E=((G=N==null?void 0:N.filter(Z=>(Z==null?void 0:Z.job_status)==="in_progress"))==null?void 0:G.length)||0,M=N==null?void 0:N.reduce((Z,re)=>{const Se=parseFloat(re==null?void 0:re.total_amount)||0;return Z+Se},0),R=M*.25,fe=M>0?25:0,he=((xe=N==null?void 0:N.filter(Z=>(Z==null?void 0:Z.job_status)==="pending"))==null?void 0:xe.length)||0,ge=((pe=N==null?void 0:N.filter(Z=>(Z==null?void 0:Z.job_status)==="draft"))==null?void 0:pe.length)||0;return{active:E,revenue:(M==null?void 0:M.toFixed(2))||"0.00",profit:(R==null?void 0:R.toFixed(2))||"0.00",margin:(fe==null?void 0:fe.toFixed(1))||"0.0",pending:he,drafts:ge}})(t),ve=t==null?void 0:t.filter(s=>{var N,E,M,R,fe,he,ge;if((d==null?void 0:d.status)!=="All"){let G=(E=(N=d==null?void 0:d.status)==null?void 0:N.toLowerCase())==null?void 0:E.replace(" ","_");if(G==="active"&&(G="in_progress"),(s==null?void 0:s.job_status)!==G)return!1}if(d!=null&&d.presetView&&(d==null?void 0:d.presetView)!=="All"){const G=new Date,xe=new Date(G);xe.setHours(0,0,0,0);const pe=new Date(G);pe.setHours(23,59,59,999);const Z=s!=null&&s.appt_start?new Date(s==null?void 0:s.appt_start):null,re=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null,Se=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null,Pe=Array.isArray(s==null?void 0:s.job_parts)?(M=s==null?void 0:s.job_parts)==null?void 0:M.some(Ve=>Ve==null?void 0:Ve.requires_scheduling):!1,ze=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id);switch(d==null?void 0:d.presetView){case"Today":if(!(Z&&Z>=xe&&Z<=pe))return!1;break;case"Past Due":if(!(re&&re<G))return!1;break;case"Unscheduled":if(!(Pe&&!Z))return!1;break;case"Off-site Today":{const Ke=(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some(Oe=>Oe==null?void 0:Oe.is_off_site),Te=Oe=>Oe&&Oe>=xe&&Oe<=pe;if(!(Ke&&(Te(Z)||Te(re))))return!1;break}case"Awaiting Vendor/Parts":{if(!(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some(Te=>(Te==null?void 0:Te.requires_scheduling)&&!(Te!=null&&Te.promised_date)))return!1;break}case"Completed—awaiting pickup":if(!((s==null?void 0:s.job_status)==="completed"&&(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id)))return!1;break;case"My Deals":if(!(s!=null&&s.assigned_to&&(D!=null&&D.id)&&s.assigned_to===D.id))return!1;break;case"Loaners Out":if(!ze)return!1;break;case"Loaners Due":if(!(ze&&Se&&Se>=xe&&Se<=pe))return!1;break;case"Loaners Overdue":if(!(ze&&Se&&Se<xe))return!1;break}}if(d!=null&&d.salesAssigned&&(s==null?void 0:s.assigned_to)!==(d==null?void 0:d.salesAssigned)||d!=null&&d.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(d==null?void 0:d.deliveryAssigned)||d!=null&&d.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(d==null?void 0:d.financeAssigned)||d!=null&&d.vendor&&(s==null?void 0:s.vendor_id)!==(d==null?void 0:d.vendor))return!1;if(d!=null&&d.location&&(d==null?void 0:d.location)!=="All"){const G=Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[],xe=G.some(re=>re==null?void 0:re.is_off_site),pe=G.some(re=>!(re!=null&&re.is_off_site));if((xe&&pe?"Mixed":xe?"Off-Site":"In-House")!==d.location)return!1}if((R=d==null?void 0:d.workTags)!=null&&R.length){const G=Array.isArray(s==null?void 0:s.work_tags)?s.work_tags:[];if(!d.workTags.some(pe=>G.includes(pe)))return!1}if(d!=null&&d.loanerStatus&&(d==null?void 0:d.loanerStatus)!=="All"){const G=new Date,xe=new Date(G);xe.setHours(0,0,0,0);const pe=new Date(G);pe.setHours(23,59,59,999);const Z=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id),re=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null;switch(d.loanerStatus){case"Active":if(!Z)return!1;break;case"Due Today":if(!(Z&&re&&re>=xe&&re<=pe))return!1;break;case"Overdue":if(!(Z&&re&&re<xe))return!1;break;case"None":if(Z)return!1;break}}if(d!=null&&d.promiseStartDate||d!=null&&d.promiseEndDate){const G=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null;if(!G)return!1;if(d!=null&&d.promiseStartDate){const xe=new Date(d.promiseStartDate+"T00:00:00");if(G<xe)return!1}if(d!=null&&d.promiseEndDate){const xe=new Date(d.promiseEndDate+"T23:59:59.999");if(G>xe)return!1}}if(W!=null&&W.trim()){const G=W==null?void 0:W.toLowerCase(),xe=Se=>(Se==null?void 0:Se.replace(/\D/g,""))||"",pe=xe(G),Z=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(fe=s==null?void 0:s.vehicle)==null?void 0:fe.make,(he=s==null?void 0:s.vehicle)==null?void 0:he.model,((ge=s==null?void 0:s.vehicle)==null?void 0:ge.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(Z==null?void 0:Z.some(Se=>{var ze;const Pe=Se==null?void 0:Se.toLowerCase();return!!(Pe!=null&&Pe.includes(G)||(pe==null?void 0:pe.length)>=3&&((ze=xe(Pe))!=null&&ze.includes(pe)))})))return!1}return!0});S.useEffect(()=>{const s=setTimeout(()=>{je(d==null?void 0:d.search)},300);return()=>clearTimeout(s)},[d==null?void 0:d.search]);const Ne=(s,N)=>{var E,M;if(U(R=>({...R,[s]:N})),s==="status"){const R=new URLSearchParams(window.location.search);N==="All"?R==null||R.delete("status"):R==null||R.set("status",N==null?void 0:N.toLowerCase());const fe=`${(E=window.location)==null?void 0:E.pathname}${R!=null&&R.toString()?"?"+(R==null?void 0:R.toString()):""}`;(M=window.history)==null||M.replaceState({},"",fe)}},Fe=()=>{var s,N;U({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),b(),(N=window.history)==null||N.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},Me=is.useMemo(()=>{const s=new Set;for(const N of t||[])for(const E of(N==null?void 0:N.work_tags)||[])s.add(E);return Array.from(s).sort((N,E)=>N.localeCompare(E))},[t]),Ae=me({activeOnly:!0}),l=de(),a=ie(),C=K(),F=()=>{try{const s=window.prompt("Save view as:");if(!s||!s.trim())return;const N={name:s.trim(),filters:d},E=[...n.filter(M=>M.name!==N.name),N];k(E),localStorage.setItem("dealsSavedViews",JSON.stringify(E)),oe(N.name)}catch(s){console.error("saveCurrentView failed",s)}},be=s=>{oe(s);const N=n.find(E=>E.name===s);N!=null&&N.filters&&U(N.filters)},se=()=>{if(!$)return;const s=n.filter(N=>N.name!==$);k(s),localStorage.setItem("dealsSavedViews",JSON.stringify(s)),oe("")},Y=s=>{var N;p(s);try{const E=(N=ve!=null&&ve.length?ve:t)==null?void 0:N.find(M=>(M==null?void 0:M.id)===s);x(E||null)}catch{x(null)}j(!0)},J=()=>{j(!1),p(null),x(null)};return r?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ze,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Ze,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(qe,{message:ae||V,onClose:()=>{w("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ws,{exportType:"jobs",filters:{status:d==null?void 0:d.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,N)=>console.log(`Export complete: ${s} records`),onExportError:s=>w(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(I,{onClick:()=>m(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(Ms,{draftsCount:ue==null?void 0:ue.drafts,onViewDrafts:()=>Ne("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(H,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",ue==null?void 0:ue.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(H,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",ue==null?void 0:ue.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(H,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[ue==null?void 0:ue.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(H,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>Ne("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(d==null?void 0:d.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Today","Past Due","Unscheduled","Off-site Today","Awaiting Vendor/Parts","Completed—awaiting pickup","My Deals","Loaners Out","Loaners Due","Loaners Overdue"].map(s=>e.jsx("button",{onClick:()=>Ne("presetView",s),className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors border
                    ${(d==null?void 0:d.presetView)===s?"bg-slate-900 text-white border-slate-900":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(H,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:d==null?void 0:d.search,onChange:s=>{var N;return Ne("search",(N=s==null?void 0:s.target)==null?void 0:N.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(I,{variant:"ghost",size:"sm",onClick:Fe,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(H,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Vendor"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.vendor||"",onChange:s=>Ne("vendor",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),Ae.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Sales"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.salesAssigned||"",onChange:s=>Ne("salesAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),l.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Finance"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.financeAssigned||"",onChange:s=>Ne("financeAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),C.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Delivery"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.deliveryAssigned||"",onChange:s=>Ne("deliveryAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),a.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Location"}),e.jsx("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.location,onChange:s=>Ne("location",s.target.value),children:["All","In-House","Off-Site","Mixed"].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Loaner"}),e.jsx("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.loanerStatus,onChange:s=>Ne("loanerStatus",s.target.value),children:["All","Active","Due Today","Overdue","None"].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Promise from"}),e.jsx("input",{type:"date",className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.promiseStartDate,onChange:s=>Ne("promiseStartDate",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Promise to"}),e.jsx("input",{type:"date",className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:d.promiseEndDate,onChange:s=>Ne("promiseEndDate",s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Work tags"}),e.jsx("select",{multiple:!0,className:"bg-white border border-slate-200 rounded-lg w-full min-h-[44px] px-3 py-2",value:d.workTags,onChange:s=>{const N=Array.from(s.target.selectedOptions).map(E=>E.value);Ne("workTags",N)},children:Me.map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsx("label",{className:"text-xs text-slate-600",children:"Saved views"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg h-9 px-3",value:$,onChange:s=>be(s.target.value),children:[e.jsx("option",{value:"",children:"— Select view —"}),n.map(s=>e.jsx("option",{value:s.name,children:s.name},s.name))]}),e.jsx(I,{size:"sm",variant:"outline",onClick:F,children:"Save current"}),e.jsx(I,{size:"sm",variant:"ghost",onClick:se,disabled:!$,children:"Delete selected"})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",ve==null?void 0:ve.length," of ",t==null?void 0:t.length," deals",(d==null?void 0:d.search)&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Promise"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Appt Window"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vehicle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"$/Margin"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Work"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Last Activity"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:ve==null?void 0:ve.map(s=>{var N,E,M,R,fe,he;return e.jsxs("tr",{className:"hover:bg-slate-50 cursor-pointer",onClick:()=>$e(s),children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(De,{status:s==null?void 0:s.job_status})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:typeof(s==null?void 0:s.age_days)=="number"?`${s==null?void 0:s.age_days}d`:"—"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(es,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.appt_start?e.jsxs("span",{className:"text-sm text-slate-700",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," • ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"–",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):e.jsx("span",{className:"text-xs text-gray-500",children:"—"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(CustomerDisplay,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[(s==null?void 0:s.customer_phone_e164)||(s==null?void 0:s.customer_phone)||"—",s!=null&&s.customer_phone_last4?e.jsxs("span",{className:"text-slate-400",children:[" ","(",`…${s==null?void 0:s.customer_phone_last4}`,")"]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[s!=null&&s.vehicle?`${((N=s==null?void 0:s.vehicle)==null?void 0:N.year)||""} ${((E=s==null?void 0:s.vehicle)==null?void 0:E.make)||""} ${((M=s==null?void 0:s.vehicle)==null?void 0:M.model)||""}`.trim():"—",(R=s==null?void 0:s.vehicle)!=null&&R.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","• Stock: ",(fe=s==null?void 0:s.vehicle)==null?void 0:fe.stock_number]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(ValueDisplay,{amount:s==null?void 0:s.total_amount}),e.jsxs("span",{className:"text-xs text-slate-500",children:["est."," ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(s==null?void 0:s.total_amount)||0)*.25)]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[((s==null?void 0:s.work_tags)||[]).map(ge=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 border border-slate-200",children:ge},ge)),(!(s!=null&&s.work_tags)||((he=s==null?void 0:s.work_tags)==null?void 0:he.length)===0)&&e.jsx("span",{className:"text-xs text-gray-500",children:"—"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:(s==null?void 0:s.vendor_name)||"Unassigned"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(ss,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:$s(s==null?void 0:s.created_at)})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.loaner_number||s!=null&&s.has_active_loaner?e.jsx(LoanerBadge,{deal:s}):e.jsx("span",{className:"text-xs text-gray-500",children:"—"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(I,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),Y(s==null?void 0:s.id)},className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(I,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),Ee(s)},className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(I,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),A({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:getDealPrimaryRef(s)})},className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(I,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),ne(s)},className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(ve==null?void 0:ve.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(d==null?void 0:d.status)==="All"?"No deals found":`No ${(ye=d==null?void 0:d.status)==null?void 0:ye.toLowerCase()} deals found`})}):ve==null?void 0:ve.map(s=>{var N,E,M,R,fe;return e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:getDealPrimaryRef(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:getDealSubtitle(s)||"—"})]}),e.jsx(De,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-medium text-slate-900 text-sm",children:(s==null?void 0:s.customer_name)||"—"}),e.jsx("div",{className:"text-xs text-slate-500 truncate",children:s!=null&&s.customer_phone?e.jsx("a",{href:`tel:${s==null?void 0:s.customer_phone}`,onClick:he=>{var ge;return(ge=he==null?void 0:he.stopPropagation)==null?void 0:ge.call(he)},className:"underline",children:s==null?void 0:s.customer_phone}):"—"})]}),e.jsx("div",{className:"ml-3 shrink-0",children:e.jsx(ss,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})})]}),e.jsxs("div",{className:"text-xs text-slate-600 truncate",children:[(s!=null&&s.vehicle?`${((N=s==null?void 0:s.vehicle)==null?void 0:N.year)||""} ${((E=s==null?void 0:s.vehicle)==null?void 0:E.make)||""} ${((M=s==null?void 0:s.vehicle)==null?void 0:M.model)||""}`.trim():"")||"—",(R=s==null?void 0:s.vehicle)!=null&&R.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","• Stock: ",(fe=s==null?void 0:s.vehicle)==null?void 0:fe.stock_number]}):null,s!=null&&s.vendor_name?e.jsxs("span",{className:"text-slate-400",children:[" • ",s==null?void 0:s.vendor_name]}):null]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{"data-testid":"mobile-next-chip",children:e.jsx(es,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),(s==null?void 0:s.appt_start)&&e.jsxs("span",{className:"text-xs text-slate-700","data-testid":"mobile-appt-window",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," • ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"–",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}),((s==null?void 0:s.loaner_number)||(s==null?void 0:s.has_active_loaner))&&e.jsx(LoanerBadge,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(I,{size:"sm",variant:"outline",onClick:()=>Y(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(I,{size:"sm",variant:"outline",onClick:()=>ne(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(I,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(H,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(I,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(I,{size:"sm",variant:"outline",onClick:()=>A({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:getDealPrimaryRef(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id)})}),e.jsx(Ss,{isOpen:u,onClose:()=>m(!1),onSuccess:we}),e.jsx(As,{isOpen:o,dealId:y,deal:v,onClose:J,onSuccess:()=>{we(),J()}}),O&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(I,{variant:"outline",onClick:()=>ne(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(I,{onClick:()=>X(O==null?void 0:O.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(LoanerDrawer,{isOpen:c,onClose:()=>{le(!1),P(null),w("")},deal:g,onSave:T,loading:L}),e.jsx(Ls,{isOpen:ce,onClose:()=>{te(!1),z(null)},deal:f}),e.jsx(Os,{loaner:_,onClose:()=>{A(null),w("")},onConfirm:()=>ee(_),loading:B})]})]})}export{Js as default};
//# sourceMappingURL=index-Bin7fdBr.js.map
