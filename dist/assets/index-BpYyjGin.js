import{s as D,u as Pe,j as e,B as q,S as Fe,I as Ye,a as es,g as ss,b as rs,c as ts,d as Ve,e as Ue,p as ze,f as ls,h as cs,i as Je,k as is,l as je}from"./index-CcC1YCBr.js";import{r as w,R as ns}from"./react-Czq5O75u.js";import{dealService as Ie,mapDbDealToForm as He,getDeal as os,updateDeal as ds,deleteDeal as us,markLoanerReturned as hs,getAllDeals as xs}from"./dealService-D6CPrm_A.js";import{s as qe}from"./options-CllavUpK.js";import{I as H}from"./Icon-CtYt9WHI.js";import{l as ms,a as gs,b as bs,c as fs}from"./tenantService-DRlCX1f9.js";import{N as We}from"./Navbar-C3SUqvwP.js";import{a as ps}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const js=(r,o="")=>r==null?o:String(r),Ae={async getOverdueJobs(){var r;try{const{data:o,error:t}=await((r=D)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return t?(console.error("Error fetching overdue jobs:",t),{data:[],error:{message:t==null?void 0:t.message}}):{data:o||[],error:null}}catch(o){return console.error("Error in getOverdueJobs service:",o),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,o,t,a;try{const{data:d,error:h}=await((a=(t=(o=(r=D)==null?void 0:r.from("sms_templates"))==null?void 0:o.select("*"))==null?void 0:t.eq("is_active",!0))==null?void 0:a.order("created_at",{ascending:!1}));return h?{data:[],error:{message:h==null?void 0:h.message}}:{data:d||[],error:null}}catch(d){return console.error("Error fetching SMS templates:",d),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var o,t,a,d,h,i,f,v;try{const g=await((t=(o=D)==null?void 0:o.auth)==null?void 0:t.getUser()),{data:y,error:m}=await((v=(f=(i=(a=D)==null?void 0:a.from("sms_templates"))==null?void 0:i.insert([{...r,created_by:(h=(d=g==null?void 0:g.data)==null?void 0:d.user)==null?void 0:h.id}]))==null?void 0:f.select())==null?void 0:v.single());return m?{data:null,error:{message:m==null?void 0:m.message}}:{data:y,error:null}}catch(g){return console.error("Error creating SMS template:",g),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,o){var t,a,d,h,i,f;try{const{data:v,error:g}=await((f=(i=(h=(d=(t=D)==null?void 0:t.from("sms_templates"))==null?void 0:d.update({...o,updated_at:(a=new Date)==null?void 0:a.toISOString()}))==null?void 0:h.eq("id",r))==null?void 0:i.select())==null?void 0:f.single());return g?{data:null,error:{message:g==null?void 0:g.message}}:{data:v,error:null}}catch(v){return console.error("Error updating SMS template:",v),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var o,t,a;try{const{error:d}=await((a=(t=(o=D)==null?void 0:o.from("sms_templates"))==null?void 0:t.delete())==null?void 0:a.eq("id",r));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return console.error("Error deleting SMS template:",d),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var o,t,a,d,h,i,f,v,g;try{const y=await((t=(o=D)==null?void 0:o.auth)==null?void 0:t.getUser()),{data:m,error:A}=await((g=(v=(h=(d=(a=D)==null?void 0:a.from("filter_presets"))==null?void 0:d.select("*"))==null?void 0:h.eq("page_type",r))==null?void 0:v.or(`user_id.eq.${(f=(i=y==null?void 0:y.data)==null?void 0:i.user)==null?void 0:f.id},is_public.eq.true`))==null?void 0:g.order("created_at",{ascending:!1}));return A?{data:[],error:{message:A==null?void 0:A.message}}:{data:m||[],error:null}}catch(y){return console.error("Error fetching filter presets:",y),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,o,t,a=!1){var d,h,i,f,v,g,y,m;try{const A=await((h=(d=D)==null?void 0:d.auth)==null?void 0:h.getUser()),{data:G,error:re}=await((m=(y=(g=(i=D)==null?void 0:i.from("filter_presets"))==null?void 0:g.insert([{user_id:(v=(f=A==null?void 0:A.data)==null?void 0:f.user)==null?void 0:v.id,page_type:r,name:o,filters:t,is_public:a}]))==null?void 0:y.select())==null?void 0:m.single());return re?{data:null,error:{message:re==null?void 0:re.message}}:{data:G,error:null}}catch(A){return console.error("Error saving filter preset:",A),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var o,t,a;try{const{error:d}=await((a=(t=(o=D)==null?void 0:o.from("filter_presets"))==null?void 0:t.delete())==null?void 0:a.eq("id",r));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return console.error("Error deleting filter preset:",d),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,o={},t="staff"){var a,d;try{const{data:h,error:i}=await((a=D)==null?void 0:a.rpc("generate_export_data",{export_type:r,filters:o,user_role:t}));return i?{data:null,error:{message:i==null?void 0:i.message}}:{data:(d=h||[])==null?void 0:d.map(v=>{var m;const g=(v==null?void 0:v.export_data)||v,y={};return(m=Object==null?void 0:Object.entries(g))==null||m.forEach(([A,G])=>{typeof G=="number"?y[A]=isNaN(G)?0:G:G==null?y[A]="":y[A]=G}),{export_data:y}}),error:null}}catch(h){return console.error("Error exporting data:",h),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,o,t=null){var a,d,h,i;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let f="";if(t)f+=(t==null?void 0:t.join(","))+`
`;else{const y=((a=r==null?void 0:r[0])==null?void 0:a.export_data)||(r==null?void 0:r[0]);y&&(f+=((d=Object==null?void 0:Object.keys(y))==null?void 0:d.join(","))+`
`)}r==null||r.forEach(y=>{var G;const m=(y==null?void 0:y.export_data)||y,A=(G=Object==null?void 0:Object.values(m))==null?void 0:G.map(re=>{if(re==null)return"";if(typeof re=="number"&&isNaN(re))return"0";let S=js(re);return S!=null&&S.includes(",")||S!=null&&S.includes('"')?`"${S==null?void 0:S.replace(/"/g,'""')}"`:S});f+=(A==null?void 0:A.join(","))+`
`});const v=new Blob([f],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a");if((g==null?void 0:g.download)!==void 0){const y=URL==null?void 0:URL.createObjectURL(v);g==null||g.setAttribute("href",y),g==null||g.setAttribute("download",o),g.style.visibility="hidden",(h=document.body)==null||h.appendChild(g),g==null||g.click(),(i=document.body)==null||i.removeChild(g),URL==null||URL.revokeObjectURL(y)}return{success:!0,error:null}}catch(f){return console.error("Export to CSV error:",f),{success:!1,error:{message:(f==null?void 0:f.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,o){var t,a,d,h,i;try{const f=await((a=(t=D)==null?void 0:t.auth)==null?void 0:a.getUser()),{data:v,error:g}=await((i=D)==null?void 0:i.rpc("bulk_update_jobs",{job_ids:r,updates:o,performed_by:(h=(d=f==null?void 0:f.data)==null?void 0:d.user)==null?void 0:h.id}));return g?{data:null,error:{message:g==null?void 0:g.message}}:{data:(v==null?void 0:v[0])||null,error:null}}catch(f){return console.error("Error in bulk update jobs:",f),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,o,t,a,d,h,i;try{const f=await((o=(r=D)==null?void 0:r.auth)==null?void 0:o.getUser()),{data:v,error:g}=await((i=(a=(t=D)==null?void 0:t.from("notification_preferences"))==null?void 0:a.select("*"))==null?void 0:i.eq("user_id",(h=(d=f==null?void 0:f.data)==null?void 0:d.user)==null?void 0:h.id));return g?{data:[],error:{message:g==null?void 0:g.message}}:{data:v||[],error:null}}catch(f){return console.error("Error fetching notification preferences:",f),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var o,t,a,d,h,i,f,v,g,y;try{const m=await((t=(o=D)==null?void 0:o.auth)==null?void 0:t.getUser());await((f=(d=(a=D)==null?void 0:a.from("notification_preferences"))==null?void 0:d.delete())==null?void 0:f.eq("user_id",(i=(h=m==null?void 0:m.data)==null?void 0:h.user)==null?void 0:i.id));const A=r==null?void 0:r.map(S=>{var x,B;return{...S,user_id:(B=(x=m==null?void 0:m.data)==null?void 0:x.user)==null?void 0:B.id}}),{data:G,error:re}=await((y=(g=(v=D)==null?void 0:v.from("notification_preferences"))==null?void 0:g.insert(A))==null?void 0:y.select());return re?{data:null,error:{message:re==null?void 0:re.message}}:{data:G,error:null}}catch(m){return console.error("Error updating notification preferences:",m),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var o,t,a;try{return(a=(t=(o=D)==null?void 0:o.channel("overdue-jobs"))==null?void 0:t.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},h=>{var i;(i=this.getOverdueJobs())==null||i.then(f=>{f!=null&&f.data&&r(f==null?void 0:f.data)})}))==null?void 0:a.subscribe()}catch(d){return console.error("Error subscribing to overdue jobs:",d),null}},async searchWithFilters(r,o,t){var a,d,h;try{let i=(a=D)==null?void 0:a.from(t);if(r)switch(t){case"jobs":i=i==null?void 0:i.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":i=i==null?void 0:i.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":i=i==null?void 0:i.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(d=Object==null?void 0:Object.entries(o))==null||d.forEach(([g,y])=>{y!=null&&y!==""&&(Array!=null&&Array.isArray(y)?i=i==null?void 0:i.in(g,y):typeof y=="object"&&(y==null?void 0:y.min)!==void 0?i=i==null?void 0:i.gte(g,y==null?void 0:y.min):typeof y=="object"&&(y==null?void 0:y.max)!==void 0?i=i==null?void 0:i.lte(g,y==null?void 0:y.max):i=i==null?void 0:i.eq(g,y))});const{data:f,error:v}=await((h=i==null?void 0:i.select("*"))==null?void 0:h.order("created_at",{ascending:!1}));return v?{data:[],error:{message:v==null?void 0:v.message}}:{data:f||[],error:null}}catch(i){return console.error("Error in search with filters:",i),{data:[],error:{message:"Failed to search with filters"}}}}},vs=({exportType:r,filters:o={},selectedIds:t=[],onExportStart:a,onExportComplete:d,onExportError:h,disabled:i=!1,variant:f="outline",size:v="sm",className:g=""})=>{var $;const[y,m]=w.useState(!1),[A,G]=w.useState(!1),[re,S]=w.useState("csv"),[x,B]=w.useState("filtered"),{user:c,userProfile:ae}=Pe(),b=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],R=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(t==null?void 0:t.length)>0?[{value:"selected",label:`Selected (${t==null?void 0:t.length})`}]:[]],O=()=>{var W,he,ee;const Y=(ee=(he=(W=new Date)==null?void 0:W.toISOString())==null?void 0:he.split("T"))==null?void 0:ee[0];return`${r}-${x==="selected"?"selected":x}-${Y}.${re}`},V=async()=>{var Y,ge,W,he;if(!y)try{m(!0),a&&a();let ee={...o};x==="selected"&&(t==null?void 0:t.length)>0&&(ee.ids=t),x==="all"&&(ee={});const Z=await(Ae==null?void 0:Ae.exportData(r,ee,(ae==null?void 0:ae.role)||"staff"));if(Z!=null&&Z.error)throw new Error((Y=Z==null?void 0:Z.error)==null?void 0:Y.message);if(!(Z!=null&&Z.data)||((ge=Z==null?void 0:Z.data)==null?void 0:ge.length)===0)throw new Error("No data found to export");const p=O(),P=await(Ae==null?void 0:Ae.exportToCSV(Z==null?void 0:Z.data,p));if(P!=null&&P.error)throw new Error((W=P==null?void 0:P.error)==null?void 0:W.message);G(!1),d&&d((he=Z==null?void 0:Z.data)==null?void 0:he.length,p)}catch(ee){console.error("Export error:",ee),h&&h((ee==null?void 0:ee.message)||"Export failed")}finally{m(!1)}},N=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(q,{variant:f,size:v,onClick:()=>G(!A),disabled:i||y,iconName:y?void 0:"Download",iconPosition:"left",className:`${g} ${y?"cursor-wait":""}`,"aria-label":`Export ${N()}`,children:y?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${N()}`}),A&&!y&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Fe,{value:re,onChange:S,options:b,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Fe,{value:x,onChange:B,options:R,className:"w-full"})]}),x==="filtered"&&(($=Object==null?void 0:Object.keys(o))==null?void 0:$.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Ye,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),x==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Ye,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",t==null?void 0:t.length," selected record",(t==null?void 0:t.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(q,{variant:"ghost",size:"sm",onClick:()=>G(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(q,{size:"sm",onClick:V,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${N()}`,children:"Export"})]})]})})]})},Xe={async getVehicles(r={},o=null){var t,a,d,h;try{let i=(d=(a=(t=D)==null?void 0:t.from("vehicles"))==null?void 0:a.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:d.order("created_at",{ascending:!1});return o&&(i=i==null?void 0:i.eq("org_id",o)),r!=null&&r.status&&(i=i==null?void 0:i.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(i=i==null?void 0:i.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(i=i==null?void 0:i.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(i=i==null?void 0:i.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await qe(i,"vehicles:getVehicles")||[],error:null}}catch(i){return(h=i==null?void 0:i.message)!=null&&h.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,o=null){var t,a,d,h,i;try{let f=(h=(d=(a=(t=D)==null?void 0:t.from("vehicles"))==null?void 0:a.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:d.eq("id",r))==null?void 0:h.single();return o&&(f=f==null?void 0:f.eq("org_id",o)),{data:await qe(f,"vehicles:getVehicleById"),error:null}}catch(f){return(i=f==null?void 0:f.message)!=null&&i.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var o,t,a,d,h,i,f,v,g,y;try{const{data:m,error:A}=await((g=(v=(f=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:f.insert([{...r,created_by:(i=(h=(d=await((a=(t=D)==null?void 0:t.auth)==null?void 0:a.getUser()))==null?void 0:d.data)==null?void 0:h.user)==null?void 0:i.id}]))==null?void 0:v.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:g.single());return A?{data:null,error:{message:A==null?void 0:A.message}}:{data:m,error:null}}catch(m){return(y=m==null?void 0:m.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var o,t,a,d;try{const{data:h,error:i}=await((d=(a=(t=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:t.insert([r]))==null?void 0:a.select())==null?void 0:d.single());if(i)throw console.error("Vehicle creation error:",i),new Error(i.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",h),h}catch(h){throw console.error("Error in vehicleService.create:",h),h}},async createVehicleWithProducts(r){var o,t;try{console.log("Creating vehicle with products:",r);const a=`vehicle_${Date.now()}`;await new Promise(h=>setTimeout(h,1e3));const d={id:a,...r,created_at:(o=new Date)==null?void 0:o.toISOString(),initial_products_count:((t=r==null?void 0:r.initial_products)==null?void 0:t.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",d),d}catch(a){throw console.error("Error creating vehicle with products:",a),a}},async checkStockNumberExists(r){var o,t,a,d;if(!(r!=null&&r.trim()))return!1;try{const{data:h,error:i}=await((d=(a=(t=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:t.select("id"))==null?void 0:a.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:d.maybeSingle());return i?(console.error("Stock number check error:",i),!1):!!h}catch(h){return console.error("Error checking stock number:",h),!1}},async checkVinExists(r){var o,t,a,d;if(!(r!=null&&r.trim()))return!1;try{const{data:h,error:i}=await((d=(a=(t=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:t.select("id"))==null?void 0:a.eq("vin",r==null?void 0:r.trim()))==null?void 0:d.maybeSingle());return i?(console.error("VIN check error:",i),!1):!!h}catch(h){return console.error("Error checking VIN:",h),!1}},async updateVehicle(r,o){var t,a,d,h,i,f,v;try{const{data:g,error:y}=await((f=(i=(h=(d=(t=D)==null?void 0:t.from("vehicles"))==null?void 0:d.update({...o,updated_at:(a=new Date)==null?void 0:a.toISOString()}))==null?void 0:h.eq("id",r))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:f.single());return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:g,error:null}}catch(g){return(v=g==null?void 0:g.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var o,t,a,d;try{const{error:h}=await((a=(t=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:t.delete())==null?void 0:a.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return(d=h==null?void 0:h.message)!=null&&d.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var o,t,a,d,h,i,f;try{let v=(t=(o=D)==null?void 0:o.from("vehicles"))==null?void 0:t.select("vehicle_status");r&&(v=v==null?void 0:v.eq("org_id",r));const g=await qe(v,"vehicles:getVehicleStats");return{data:{total:(g==null?void 0:g.length)||0,active:((a=g==null?void 0:g.filter(m=>(m==null?void 0:m.vehicle_status)==="active"))==null?void 0:a.length)||0,maintenance:((d=g==null?void 0:g.filter(m=>(m==null?void 0:m.vehicle_status)==="maintenance"))==null?void 0:d.length)||0,retired:((h=g==null?void 0:g.filter(m=>(m==null?void 0:m.vehicle_status)==="retired"))==null?void 0:h.length)||0,sold:((i=g==null?void 0:g.filter(m=>(m==null?void 0:m.vehicle_status)==="sold"))==null?void 0:i.length)||0},error:null}}catch(v){return(f=v==null?void 0:v.message)!=null&&f.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function ys({isOpen:r,onClose:o,onSuccess:t}){var j,U,Q;const{user:a}=Pe(),{orgId:d}=es()||{},[h,i]=w.useState(1),[f,v]=w.useState(!1),[g,y]=w.useState(""),[m,A]=w.useState(!1),[G,re]=w.useState(!1),[S,x]=w.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),B={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(j=new Date)==null?void 0:j.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[c,ae]=w.useState(B),[b,R]=w.useState([]),O=async(n=0)=>{var k,z;try{x(K=>({...K,loading:!0,error:null,retryCount:n}));const[oe,ce,le,X,ue]=await Promise.all([ss().catch(()=>[]),rs().catch(()=>[]),ts().catch(()=>[]),Ve({activeOnly:!0}).catch(()=>[]),Ue({activeOnly:!0}).catch(()=>[])]);x({salesConsultants:oe,deliveryCoordinators:ce,financeManagers:le,vendors:X,products:ue==null?void 0:ue.map(K=>({...K,unitPrice:K==null?void 0:K.unit_price})),loading:!1,error:null,retryCount:n})}catch(oe){if(console.error("Failed to load dropdown data:",oe),n<2&&((k=oe==null?void 0:oe.message)!=null&&k.includes("fetch")||(z=oe==null?void 0:oe.message)!=null&&z.includes("network"))){setTimeout(()=>O(n+1),1e3*(n+1));return}x(ce=>({...ce,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:n}))}},V=({checked:n,onChange:k})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!n,onChange:z=>{var ce;const oe=!!((ce=z==null?void 0:z.target)!=null&&ce.checked);k(oe)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),N=({label:n,options:k,value:z,onChange:oe,placeholder:ce,required:le=!1,helpText:X,testId:ue})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[n," ",le&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:z||"",onChange:K=>{var E;return oe(((E=K==null?void 0:K.target)==null?void 0:E.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:S==null?void 0:S.loading,required:le,"data-testid":ue,children:[e.jsx("option",{value:"",children:ce}),k==null?void 0:k.map(K=>e.jsx("option",{value:K==null?void 0:K.id,children:(K==null?void 0:K.full_name)||(K==null?void 0:K.label)||(K==null?void 0:K.name)},K==null?void 0:K.id))]}),X&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:X}),(k==null?void 0:k.length)===0&&!(S!=null&&S.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No ",n==null?void 0:n.toLowerCase()," found yet. Add it in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]});w.useEffect(()=>{const n=(c==null?void 0:c.customerName)!==(B==null?void 0:B.customerName)||(c==null?void 0:c.customerPhone)!==(B==null?void 0:B.customerPhone)||(c==null?void 0:c.customerEmail)!==(B==null?void 0:B.customerEmail)||(c==null?void 0:c.needsLoaner)!==(B==null?void 0:B.needsLoaner)||(c==null?void 0:c.assignedTo)!==(B==null?void 0:B.assignedTo)||(c==null?void 0:c.deliveryCoordinator)!==(B==null?void 0:B.deliveryCoordinator)||(c==null?void 0:c.financeManager)!==(B==null?void 0:B.financeManager)||(b==null?void 0:b.length)>0;A(n)},[c,b]),w.useEffect(()=>{r&&O()},[r]);const $=()=>{R(n=>[...n,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},Y=(n,k,z)=>{var oe;if(R(ce=>ce==null?void 0:ce.map(le=>{if((le==null?void 0:le.id)===n){let X={...le,[k]:z};return k==="requiresScheduling"&&(z===!0?X.noScheduleReason="":X.promisedDate=""),X}return le})),k==="productId"&&z){const ce=(oe=S==null?void 0:S.products)==null?void 0:oe.find(le=>(le==null?void 0:le.id)===z);ce&&R(le=>le==null?void 0:le.map(X=>(X==null?void 0:X.id)===n?{...X,unitPrice:(ce==null?void 0:ce.unitPrice)||""}:X))}},ge=n=>{R(k=>k==null?void 0:k.filter(z=>(z==null?void 0:z.id)!==n))},W=()=>{var n,k;return((k=(n=c==null?void 0:c.customerName)==null?void 0:n.trim())==null?void 0:k.length)>0},he=()=>(b==null?void 0:b.length)===0?!1:b==null?void 0:b.every(n=>{var k;return!(!(n!=null&&n.productId)||!(n!=null&&n.unitPrice)||n!=null&&n.requiresScheduling&&!(n!=null&&n.promisedDate)||!(n!=null&&n.requiresScheduling)&&!((k=n==null?void 0:n.noScheduleReason)!=null&&k.trim())||(n==null?void 0:n.serviceType)==="vendor"&&!(n!=null&&n.vendorId))}),ee=()=>b==null?void 0:b.reduce((n,k)=>n+(parseFloat(k==null?void 0:k.unitPrice)||0),0),Z=async()=>{var n,k,z,oe,ce,le,X,ue,K,E;if(!W()){y("Customer name is required to save draft");return}v(!0),y("");try{const se={year:(c==null?void 0:c.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(k=c==null?void 0:c.customerName)==null?void 0:k.trim(),owner_phone:((z=c==null?void 0:c.customerPhone)==null?void 0:z.trim())||null,owner_email:((oe=c==null?void 0:c.customerEmail)==null?void 0:oe.trim())||null,stock_number:((ce=c==null?void 0:c.stockNumber)==null?void 0:ce.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...d?{org_id:d}:{}},be=await Xe.create(se),ye={title:`Draft Deal - ${(le=c==null?void 0:c.customerName)==null?void 0:le.trim()}`,description:`Draft deal for ${(X=c==null?void 0:c.customerName)==null?void 0:X.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:be==null?void 0:be.id,assigned_to:(c==null?void 0:c.assignedTo)||(a==null?void 0:a.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),customerName:(ue=c==null?void 0:c.customerName)==null?void 0:ue.trim(),customerPhone:((K=c==null?void 0:c.customerPhone)==null?void 0:K.trim())||"",customerEmail:((E=c==null?void 0:c.customerEmail)==null?void 0:E.trim())||"",org_id:d||void 0,lineItems:[]};await Ie.createDeal(ye),t==null||t(),P(),o()}catch(se){y(`Failed to save draft: ${se==null?void 0:se.message}`)}finally{v(!1)}},p=async()=>{var n,k,z,oe,ce,le,X,ue,K,E,se,be;if(!W()||!he()){y("Please complete all required fields");return}v(!0),y("");try{const ye={year:(c==null?void 0:c.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(k=c==null?void 0:c.customerName)==null?void 0:k.trim(),owner_phone:((z=c==null?void 0:c.customerPhone)==null?void 0:z.trim())||null,owner_email:((oe=c==null?void 0:c.customerEmail)==null?void 0:oe.trim())||null,stock_number:((ce=c==null?void 0:c.stockNumber)==null?void 0:ce.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...d?{org_id:d}:{}},Ee=await Xe.create(ye),Le=ee(),de=(b==null?void 0:b.some(l=>(l==null?void 0:l.serviceType)==="vendor"))?"vendor":"in_house",xe=((le=b==null?void 0:b.find(l=>l==null?void 0:l.vendorId))==null?void 0:le.vendorId)||null;let Ne=null;if(de==="vendor"){const l=(b||[]).filter(s=>(s==null?void 0:s.serviceType)==="vendor"&&(s==null?void 0:s.requiresScheduling)&&(s==null?void 0:s.promisedDate)).map(s=>new Date(s==null?void 0:s.promisedDate)).sort((s,u)=>s-u);Ne=(X=(l==null?void 0:l[0])||new Date)==null?void 0:X.toISOString()}const Te=(b||[]).map(l=>({product_id:l==null?void 0:l.productId,quantity_used:1,unit_price:parseFloat((l==null?void 0:l.unitPrice)||0),promised_date:l!=null&&l.requiresScheduling?l==null?void 0:l.promisedDate:null,requires_scheduling:!!(l!=null&&l.requiresScheduling),no_schedule_reason:l!=null&&l.requiresScheduling?null:l==null?void 0:l.noScheduleReason,is_off_site:(l==null?void 0:l.serviceType)==="vendor"})),ke={title:`Deal - ${(ue=c==null?void 0:c.customerName)==null?void 0:ue.trim()}`,description:`Deal for ${(K=c==null?void 0:c.customerName)==null?void 0:K.trim()}`,job_status:"pending",service_type:de,vehicle_id:Ee==null?void 0:Ee.id,vendor_id:xe,assigned_to:(c==null?void 0:c.assignedTo)||(a==null?void 0:a.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),scheduled_start_time:Ne,estimated_cost:Le,org_id:d||void 0,customerName:(E=c==null?void 0:c.customerName)==null?void 0:E.trim(),customerPhone:((se=c==null?void 0:c.customerPhone)==null?void 0:se.trim())||"",customerEmail:((be=c==null?void 0:c.customerEmail)==null?void 0:be.trim())||"",lineItems:Te},_e=await Ie.createDeal(ke);await Ie.updateDeal(_e==null?void 0:_e.id,ke),t==null||t(),P(),o()}catch(ye){y(`Failed to create deal: ${ye==null?void 0:ye.message}`)}finally{v(!1)}},P=()=>{i(1),ae(B),R([]),y(""),A(!1)},ve=()=>{m?re(!0):(P(),o())},Ce=()=>{re(!1),P(),o()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:h===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:ve,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(H,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${h>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${h>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${h>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${h>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[g&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",g]}),e.jsx("button",{onClick:()=>y(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(H,{name:"X",size:16})})]})}),(S==null?void 0:S.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",S==null?void 0:S.error]}),e.jsx("button",{onClick:()=>O(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),h===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:c==null?void 0:c.customerName,onChange:n=>ae(k=>{var z;return{...k,customerName:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:c==null?void 0:c.customerPhone,onChange:n=>ae(k=>{var z;return{...k,customerPhone:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:c==null?void 0:c.customerEmail,onChange:n=>ae(k=>{var z;return{...k,customerEmail:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(c==null?void 0:c.vehicleYear)||"",onChange:n=>ae(k=>{var z;return{...k,vehicleYear:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((U=new Date)==null?void 0:U.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleMake)||"",onChange:n=>ae(k=>{var z;return{...k,vehicleMake:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleModel)||"",onChange:n=>ae(k=>{var z;return{...k,vehicleModel:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.stockNumber)||"",onChange:n=>ae(k=>{var z;return{...k,stockNumber:(z=n==null?void 0:n.target)==null?void 0:z.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(V,{checked:c==null?void 0:c.needsLoaner,onChange:n=>{ae(k=>({...k,needsLoaner:!!n}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(N,{label:"Sales Consultant",options:S==null?void 0:S.salesConsultants,value:c==null?void 0:c.assignedTo,onChange:n=>ae(k=>({...k,assignedTo:n})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(N,{label:"Delivery Coordinator",options:S==null?void 0:S.deliveryCoordinators,value:c==null?void 0:c.deliveryCoordinator,onChange:n=>ae(k=>({...k,deliveryCoordinator:n})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(N,{label:"Finance Manager",options:S==null?void 0:S.financeManagers,value:c==null?void 0:c.financeManager,onChange:n=>ae(k=>({...k,financeManager:n})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),h===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(q,{onClick:$,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(H,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(b==null?void 0:b.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(H,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[b==null?void 0:b.map((n,k)=>{var z,oe,ce,le,X,ue,K;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",k+1]}),e.jsx("button",{onClick:()=>ge(n==null?void 0:n.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.productId)||"",onChange:E=>{var se;return Y(n==null?void 0:n.id,"productId",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${k}`,children:[e.jsx("option",{value:"",children:"Select product"}),(z=S==null?void 0:S.products)==null?void 0:z.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]}),!(S!=null&&S.loading)&&(((oe=S==null?void 0:S.products)==null?void 0:oe.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No products found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:n==null?void 0:n.unitPrice,onChange:E=>{var se;return Y(n==null?void 0:n.id,"unitPrice",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${k}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"in_house",checked:(n==null?void 0:n.serviceType)==="in_house",onChange:E=>{var se;return Y(n==null?void 0:n.id,"serviceType",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"vendor",checked:(n==null?void 0:n.serviceType)==="vendor",onChange:E=>{var se;return Y(n==null?void 0:n.id,"serviceType",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(n==null?void 0:n.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.vendorId)||"",onChange:E=>{var se;return Y(n==null?void 0:n.id,"vendorId",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(ce=S==null?void 0:S.vendors)==null?void 0:ce.map(E=>e.jsx("option",{value:E==null?void 0:E.id,children:E==null?void 0:E.label},E==null?void 0:E.id))]}),!(S!=null&&S.loading)&&(((le=S==null?void 0:S.vendors)==null?void 0:le.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!0,onChange:()=>Y(n==null?void 0:n.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${k}`,"data-testid":`requires-scheduling-${k}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!1,onChange:()=>Y(n==null?void 0:n.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${k}`}),"No Scheduling Needed"]})]}),n!=null&&n.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:n==null?void 0:n.promisedDate,onChange:E=>{var se;return Y(n==null?void 0:n.id,"promisedDate",(se=E==null?void 0:E.target)==null?void 0:se.value)},min:(K=(ue=(X=new Date)==null?void 0:X.toISOString())==null?void 0:ue.split("T"))==null?void 0:K[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:n==null?void 0:n.noScheduleReason,onChange:E=>{var se;return Y(n==null?void 0:n.id,"noScheduleReason",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:n==null?void 0:n.serviceNotes,onChange:E=>{var se;return Y(n==null?void 0:n.id,"serviceNotes",(se=E==null?void 0:E.target)==null?void 0:se.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},n==null?void 0:n.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(Q=ee())==null?void 0:Q.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[b==null?void 0:b.length," item",(b==null?void 0:b.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:h===2&&e.jsx(q,{onClick:()=>i(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(q,{onClick:ve,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),h===1&&e.jsxs(e.Fragment,{children:[e.jsx(q,{onClick:Z,disabled:!W()||f,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:f?"Saving...":"Save Draft"}),e.jsx(q,{onClick:()=>i(2),disabled:!W(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),h===2&&e.jsx(q,{onClick:p,disabled:!W()||!he()||f,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:f?"Creating...":"Create Deal"})]})]})}),G&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(q,{variant:"outline",onClick:()=>re(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(q,{onClick:Ce,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}function as(r={}){var x,B,c,ae;const{loadOnMount:o=!0,cacheTime:t=5*60*1e3}=r,[a,d]=w.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[h,i]=w.useState(null),f=es(),v=Pe(),g=async()=>{var b,R,O,V;try{if(f.loading)return;if(d(P=>({...P,loading:!0,error:null})),!((b=f.session)!=null&&b.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),d(P=>({...P,loading:!1}));return}const N=!!f.orgId,$=[(R=rs())==null?void 0:R.catch(P=>(console.error("[dropdowns:dc] Delivery coordinators failed:",P),[])),(O=ss())==null?void 0:O.catch(P=>(console.error("[dropdowns:sales] Sales consultants failed:",P),[])),(V=ts())==null?void 0:V.catch(P=>(console.error("[dropdowns:finance] Finance managers failed:",P),[])),N?ms(f.orgId).catch(P=>(console.error("[dropdowns:users] tenant staff failed:",P),[])):Je({activeOnly:!0}).catch(P=>(console.error("[dropdowns:users] global user profiles failed:",P),[])),N?gs(f.orgId).catch(P=>(console.error("[dropdowns:vendors] tenant vendors failed:",P),[])):Ve({activeOnly:!0}).catch(P=>(console.error("[dropdowns:vendors] global vendors failed:",P),[])),N?bs(f.orgId).catch(P=>(console.error("[dropdowns:products] tenant products failed:",P),[])):Ue({activeOnly:!0}).catch(P=>(console.error("[dropdowns:products] global products failed:",P),[])),N?fs(f.orgId).catch(P=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",P),[])):Promise.resolve([])];let[Y,ge,W,he,ee,Z,p]=await Promise.all($);N&&((!Array.isArray(he)||he.length===0)&&(he=await Je({activeOnly:!0}).catch(P=>(console.error("[dropdowns:users] tenant fallback to global failed:",P),[]))),(!Array.isArray(ee)||ee.length===0)&&(ee=await Ve({activeOnly:!0}).catch(P=>(console.error("[dropdowns:vendors] tenant fallback to global failed:",P),[]))),(!Array.isArray(Z)||Z.length===0)&&(Z=await Ue({activeOnly:!0}).catch(P=>(console.error("[dropdowns:products] tenant fallback to global failed:",P),[]))),(!Array.isArray(p)||p.length===0)&&(p=[])),d({dc:Y,sales:ge,finance:W,users:he,vendors:ee,products:Z,smsTemplates:p,loading:!1,error:null,searchResults:null}),i(Date.now())}catch(N){d({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(N==null?void 0:N.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",N)}};w.useEffect(()=>{try{const b=ze({departments:["Sales","Sales Consultant","Sales Consultants"]}),R=ze({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),O=ze({departments:["Finance","Finance Manager","Finance Managers"]}),V=ls({activeOnly:!0}),N=cs({activeOnly:!0});[b==null?void 0:b.length,R==null?void 0:R.length,O==null?void 0:O.length,V==null?void 0:V.length,N==null?void 0:N.length].some(Boolean)&&d(Y=>({...Y,sales:b||Y.sales,dc:R||Y.dc,finance:O||Y.finance,vendors:V||Y.vendors,products:N||Y.products,loading:!1,error:null}))}catch(b){console.info("[dropdowns] cached-first hydrate skipped:",b==null?void 0:b.message)}},[]);const y=()=>h?Date.now()-h<t:!1,m=async()=>{y()||await g()},A=async b=>{try{if(!(b!=null&&b.trim())){d(O=>({...O,searchResults:null}));return}const R=await is(b);d(O=>({...O,searchResults:R}))}catch(R){console.error("[dropdowns:search] Search failed:",R),d(O=>({...O,searchResults:{users:[],vendors:[]}}))}},G=()=>{d(b=>({...b,searchResults:null}))},re=(b={})=>{const{roles:R=[],departments:O=[],activeOnly:V=!0}=b;let N=(a==null?void 0:a.users)||[];return V&&(N=N==null?void 0:N.filter($=>$==null?void 0:$.is_active)),(R==null?void 0:R.length)>0&&(N=N==null?void 0:N.filter($=>R==null?void 0:R.includes($==null?void 0:$.role))),(O==null?void 0:O.length)>0&&(N=N==null?void 0:N.filter($=>O==null?void 0:O.includes($==null?void 0:$.department))),(N==null?void 0:N.map($=>({id:$==null?void 0:$.id,value:$==null?void 0:$.id,label:$==null?void 0:$.full_name,name:$==null?void 0:$.full_name,role:$==null?void 0:$.role,department:$==null?void 0:$.department,email:$==null?void 0:$.email})))||[]},S=(b={})=>{const{activeOnly:R=!0,specialty:O=null}=b;let V=(a==null?void 0:a.vendors)||[];return R&&(V=V==null?void 0:V.filter(N=>N==null?void 0:N.is_active)),O&&(V=V==null?void 0:V.filter(N=>{var $,Y;return(Y=($=N==null?void 0:N.specialty)==null?void 0:$.toLowerCase())==null?void 0:Y.includes(O==null?void 0:O.toLowerCase())})),(V==null?void 0:V.map(N=>({id:N==null?void 0:N.id,value:(N==null?void 0:N.value)||(N==null?void 0:N.id),label:(N==null?void 0:N.label)||(N==null?void 0:N.name),name:N==null?void 0:N.name,specialty:N==null?void 0:N.specialty,email:N==null?void 0:N.email,phone:N==null?void 0:N.phone})))||[]};return w.useEffect(()=>{let b=!0;return(async()=>{var O;if(!o)return;const R=Date.now();for(;b&&(v!=null&&v.loading)&&Date.now()-R<5e3;)await new Promise(V=>setTimeout(V,200));b&&(v!=null&&v.user?(console.log("Dropdowns: authenticated user",(O=v==null?void 0:v.user)==null?void 0:O.id),v!=null&&v.userProfile&&console.log("Dropdowns: user profile org",v.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),b&&await g())})(),()=>{b=!1}},[o,v==null?void 0:v.loading,(x=v==null?void 0:v.user)==null?void 0:x.id,f==null?void 0:f.loading,f==null?void 0:f.orgId]),{dc:a==null?void 0:a.dc,sales:a==null?void 0:a.sales,finance:a==null?void 0:a.finance,users:a==null?void 0:a.users,vendors:a==null?void 0:a.vendors,products:a==null?void 0:a.products,smsTemplates:a==null?void 0:a.smsTemplates,loading:a==null?void 0:a.loading,error:a==null?void 0:a.error,searchResults:a==null?void 0:a.searchResults,globalSearch:A,clearSearch:G,getUserOptions:re,getVendorOptions:S,refresh:g,refreshIfNeeded:m,lastUpdate:h,isCacheValid:y(),salesConsultantOptions:(B=(a==null?void 0:a.sales)||[])==null?void 0:B.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),deliveryCoordinatorOptions:(c=(a==null?void 0:a.dc)||[])==null?void 0:c.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),financeManagerOptions:(ae=(a==null?void 0:a.finance)||[])==null?void 0:ae.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name}))}}const Ns=()=>{var v,g,y;const{dc:r,sales:o,finance:t,vendors:a,products:d,loading:h,error:i,refresh:f}=as({loadOnMount:!0});return{salesConsultants:o,deliveryCoordinators:r,financeManagers:t,vendors:a,products:d,loading:h,error:i,refresh:f,salesConsultantOptions:(v=o||[])==null?void 0:v.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),deliveryCoordinatorOptions:(g=r||[])==null?void 0:g.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),financeManagerOptions:(y=t||[])==null?void 0:y.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),vendorOptions:a||[],productOptions:d||[]}},_s=()=>(ns.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Me=({options:r=[],value:o,onChange:t,placeholder:a="Select...",searchable:d=!1,clearable:h=!1,disabled:i=!1,loading:f=!1,error:v=null,className:g="",optionLabel:y="label",optionValue:m="value",groupBy:A=null,renderOption:G=null,label:re="",helperText:S=""})=>{const[x,B]=w.useState(!1),[c,ae]=w.useState(""),[b,R]=w.useState(!1),[O,V]=w.useState(r),[N,$]=w.useState(-1),[Y,ge]=w.useState({top:0,left:0,width:0}),W=w.useRef(null),he=w.useRef(null);w.useRef(null),w.useEffect(()=>{R((()=>{var n;return(n=window.matchMedia("(max-width: 767px)"))==null?void 0:n.matches})());const U=window.matchMedia("(max-width: 767px)"),Q=()=>R(U==null?void 0:U.matches);return U==null||U.addEventListener("change",Q),()=>U==null?void 0:U.removeEventListener("change",Q)},[]),w.useEffect(()=>{if(!(c!=null&&c.trim())){V(r);return}const j=c==null?void 0:c.toLowerCase(),U=r==null?void 0:r.filter(Q=>{const n=[Q==null?void 0:Q.name,Q==null?void 0:Q.displayName,Q==null?void 0:Q.category,Q==null?void 0:Q.brand,Q==null?void 0:Q.specialty,Q==null?void 0:Q.department,Q==null?void 0:Q.email].filter(Boolean);return n==null?void 0:n.some(k=>{var z;return(z=k==null?void 0:k.toLowerCase())==null?void 0:z.includes(j)})});V(U),$(-1)},[c,r]);const ee=r==null?void 0:r.find(j=>(j==null?void 0:j.id)===o),Z=j=>((j==null?void 0:j[m])||(j==null?void 0:j.id))===o,p=()=>{var j;if(W!=null&&W.current){const U=(j=W==null?void 0:W.current)==null?void 0:j.getBoundingClientRect();ge({top:(U==null?void 0:U.bottom)+window.scrollY,left:(U==null?void 0:U.left)+window.scrollX,width:U==null?void 0:U.width})}};w.useEffect(()=>{x&&!b&&p()},[x,b]),w.useEffect(()=>{if(b)return;const j=U=>{var Q;W!=null&&W.current&&!((Q=W==null?void 0:W.current)!=null&&Q.contains(U==null?void 0:U.target))&&(B(!1),ae(""),$(-1))};return document==null||document.addEventListener("mousedown",j),()=>document==null?void 0:document.removeEventListener("mousedown",j)},[b]);const P=j=>{if(!b){if(!x){((j==null?void 0:j.key)==="Enter"||(j==null?void 0:j.key)===" "||(j==null?void 0:j.key)==="ArrowDown")&&(j==null||j.preventDefault(),B(!0),d&&setTimeout(()=>{var U;return(U=he==null?void 0:he.current)==null?void 0:U.focus()},0));return}switch(j==null?void 0:j.key){case"Escape":B(!1),ae(""),$(-1);break;case"ArrowDown":j==null||j.preventDefault(),$(U=>U<(O==null?void 0:O.length)-1?U+1:0);break;case"ArrowUp":j==null||j.preventDefault(),$(U=>U>0?U-1:(O==null?void 0:O.length)-1);break;case"Enter":j==null||j.preventDefault(),N>=0&&(O!=null&&O[N])&&ve(O==null?void 0:O[N]);break;case"Tab":B(!1),ae(""),$(-1);break}}},ve=j=>{t==null||t(j==null?void 0:j.id),B(!1),ae(""),$(-1)},Ce=j=>{j==null||j.stopPropagation(),t==null||t(null)};return b?e.jsxs("div",{className:`relative ${g}`,children:[e.jsxs("select",{value:o||"",onChange:j=>{var U;return t==null?void 0:t(((U=j==null?void 0:j.target)==null?void 0:U.value)||null)},disabled:i||f,className:`
            w-full px-3 py-2 border rounded-lg
            ${v?"border-red-500":"border-gray-300"}
            ${i||f?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:a}),r==null?void 0:r.map(j=>e.jsx("option",{value:(j==null?void 0:j[m])||(j==null?void 0:j.id),children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[m])||(j==null?void 0:j.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(H,{name:"ChevronDown",size:16,className:"text-gray-400"})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]}):e.jsxs("div",{className:`relative ${g}`,ref:W,children:[e.jsxs("button",{type:"button",onClick:()=>!i&&!f&&B(!x),onKeyDown:P,disabled:i||f,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${v?"border-red-500":"border-gray-300"}
          ${i||f?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${x?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:ee?"text-gray-900":"text-gray-500",children:ee?(ee==null?void 0:ee[y])||(ee==null?void 0:ee.label):a}),e.jsxs("div",{className:"flex items-center space-x-1",children:[f&&e.jsx(H,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),h&&ee&&!f&&e.jsx("button",{type:"button",onClick:Ce,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(H,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(H,{name:x?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),x&&typeof window<"u"&&e.jsx(_s,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>B(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${Y==null?void 0:Y.top}px`,left:`${Y==null?void 0:Y.left}px`,width:`${Y==null?void 0:Y.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:j=>j==null?void 0:j.stopPropagation(),children:[d&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:c,onChange:j=>{var U;return ae((U=j==null?void 0:j.target)==null?void 0:U.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(O==null?void 0:O.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:c?"No results found":"No options available"}):O==null?void 0:O.map(j=>e.jsx("button",{type:"button",onClick:()=>ve(j),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${Z(j)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[m])||(j==null?void 0:j.id)))})]})})}),v&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:v})]})},ws=({isOpen:r,dealId:o,deal:t,onClose:a,onSuccess:d})=>{var Oe,de,xe,Ne,Te,ke,_e;const[h,i]=w.useState(!0),[f,v]=w.useState(!1),[g,y]=w.useState(""),[m,A]=w.useState(!1),[G,re]=w.useState(!1),[S,x]=w.useState(!1),[B,c]=w.useState(!1),[ae,b]=w.useState(null),[R,O]=w.useState(null),[V,N]=w.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:$,deliveryCoordinatorOptions:Y,financeManagerOptions:ge,vendorOptions:W,productOptions:he,loading:ee,refresh:Z}=Ns(),[p,P]=w.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),ve=(l=[],s,u="Selected")=>!s||Array.isArray(l)&&l.some(_=>(_==null?void 0:_.id)===s)?l:[...l||[],{id:s,value:s,label:u}],Ce=w.useMemo(()=>ve(W,p==null?void 0:p.vendor_id,"Selected vendor"),[W,p==null?void 0:p.vendor_id]),j=w.useMemo(()=>ve($,p==null?void 0:p.assignedTo,"Selected user"),[$,p==null?void 0:p.assignedTo]),U=w.useMemo(()=>ve(Y,p==null?void 0:p.deliveryCoordinator,"Selected user"),[Y,p==null?void 0:p.deliveryCoordinator]),Q=w.useMemo(()=>ve(ge,p==null?void 0:p.financeManager,"Selected user"),[ge,p==null?void 0:p.financeManager]);w.useEffect(()=>{if(ae){const l=JSON.stringify(p)!==JSON.stringify(ae);x(l)}},[p,ae]),w.useEffect(()=>{if(r)try{Z==null||Z()}catch{}},[r,Z]),w.useEffect(()=>{var l;if(r)if(t&&(t!=null&&t.id))try{const s=He(t),u={...s,assignedTo:(s==null?void 0:s.assigned_to)||null,deliveryCoordinator:(s==null?void 0:s.delivery_coordinator_id)||null,financeManager:(s==null?void 0:s.finance_manager_id)||null,vendor_id:(s==null?void 0:s.vendor_id)||null,customerName:(t==null?void 0:t.customer_name)||"",customerPhone:(t==null?void 0:t.customer_phone)||"",customerEmail:(t==null?void 0:t.customer_email)||"",lineItems:((l=(s==null?void 0:s.lineItems)||[])==null?void 0:l.length)>0?oe(s==null?void 0:s.lineItems):[le()]};P(u),b(JSON.parse(JSON.stringify(u))),i(!1),y("")}catch(s){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",s),ce()}else o?ce():(y("No deal selected to edit."),i(!1))},[r,o,t==null?void 0:t.id]),w.useEffect(()=>{if(!r||!h)return;const l=setTimeout(()=>{i(!1),y(s=>s||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(l)},[r,h]);const n=({checked:l,onChange:s})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!l,onChange:u=>{var _;return s(!!((_=u==null?void 0:u.target)!=null&&_.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),k=({value:l,selectedValue:s,onChange:u,itemIndex:_,disabled:T=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${_}`,value:"in_house",checked:!s,onChange:()=>u(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:T}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${_}`,value:"vendor",checked:s,onChange:()=>u(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:T}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),z=({requiresScheduling:l,onChange:s,itemIndex:u,disabled:_=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${u}`,checked:l===!0,onChange:()=>s(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:_}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${u}`,checked:l===!1,onChange:()=>s(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:_}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),oe=(l=[])=>(l||[]).map(s=>({product_id:(s==null?void 0:s.product_id)??null,unit_price:(s==null?void 0:s.unit_price)??0,quantity_used:(s==null?void 0:s.quantity_used)??1,lineItemPromisedDate:(s==null?void 0:s.lineItemPromisedDate)||(s==null?void 0:s.promised_date)||"",requiresScheduling:typeof(s==null?void 0:s.requiresScheduling)=="boolean"?s==null?void 0:s.requiresScheduling:!!(s!=null&&s.requires_scheduling),noScheduleReason:(s==null?void 0:s.noScheduleReason)||(s==null?void 0:s.no_schedule_reason)||"",isOffSite:typeof(s==null?void 0:s.isOffSite)=="boolean"?s==null?void 0:s.isOffSite:!!(s!=null&&s.is_off_site),description:(s==null?void 0:s.description)||""})),ce=async()=>{var l,s,u,_,T,C,M,F,ie,ne;try{i(!0),y("");const te=await os(o),J=He(te),{data:I}=await((_=(u=(s=(l=D)==null?void 0:l.from("transactions"))==null?void 0:s.select("customer_name, customer_phone, customer_email"))==null?void 0:u.eq("job_id",o))==null?void 0:_.single());let L=null;try{const{data:fe}=await((ie=(F=(M=(C=(T=D)==null?void 0:T.from("loaner_assignments"))==null?void 0:C.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:M.eq("job_id",o))==null?void 0:F.is("returned_at",null))==null?void 0:ie.limit(1));L=Array.isArray(fe)?fe[0]:fe}catch{}const me={...J,assignedTo:(J==null?void 0:J.assigned_to)||null,deliveryCoordinator:(J==null?void 0:J.delivery_coordinator_id)||null,financeManager:(J==null?void 0:J.finance_manager_id)||null,vendor_id:(J==null?void 0:J.vendor_id)||null,customerName:(I==null?void 0:I.customer_name)||"",customerPhone:(I==null?void 0:I.customer_phone)||"",customerEmail:(I==null?void 0:I.customer_email)||"",lineItems:((ne=(J==null?void 0:J.lineItems)||[])==null?void 0:ne.length)>0?oe(J==null?void 0:J.lineItems):[le()]};if(P(me),b(JSON.parse(JSON.stringify(me))),O(L||null),L)N({loaner_number:(L==null?void 0:L.loaner_number)||"",eta_return_date:(L==null?void 0:L.eta_return_date)||"",notes:(L==null?void 0:L.notes)||""});else{const fe=((me==null?void 0:me.lineItems)||[]).filter(pe=>(pe==null?void 0:pe.requiresScheduling)&&(pe==null?void 0:pe.lineItemPromisedDate)).map(pe=>new Date(pe.lineItemPromisedDate).getTime()),we=fe!=null&&fe.length?new Date(Math.max(...fe)):null;N(pe=>({...pe,eta_return_date:we?we.toISOString().split("T")[0]:""}))}}catch(te){y(`Failed to load deal: ${te==null?void 0:te.message}`)}finally{i(!1)}},le=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),X=l=>{P(s=>({...s,...l}))},ue=(l,s)=>{if(P(u=>{var _;return{...u,lineItems:(_=u==null?void 0:u.lineItems)==null?void 0:_.map((T,C)=>{if(C===l){let M={...T,...s};return"requiresScheduling"in s&&(M.requiresScheduling=!!(s!=null&&s.requiresScheduling),(s==null?void 0:s.requiresScheduling)===!0?M.noScheduleReason="":M.lineItemPromisedDate=""),"isOffSite"in s&&(M.isOffSite=!!(s!=null&&s.isOffSite),s!=null&&s.isOffSite||(M.vendorId="")),M}return T})}}),s!=null&&s.product_id){const u=he==null?void 0:he.find(_=>(_==null?void 0:_.id)===(s==null?void 0:s.product_id));u&&P(_=>{var T;return{..._,lineItems:(T=_==null?void 0:_.lineItems)==null?void 0:T.map((C,M)=>M===l?{...C,unit_price:(u==null?void 0:u.unitPrice)||(u==null?void 0:u.unit_price)||(C==null?void 0:C.unit_price),cost_price:(u==null?void 0:u.cost)||(C==null?void 0:C.cost_price)}:C)}})}},K=()=>{P(l=>({...l,lineItems:[...l==null?void 0:l.lineItems,le()]}))},E=l=>{P(s=>{var u;return{...s,lineItems:(u=s==null?void 0:s.lineItems)==null?void 0:u.filter((_,T)=>T!==l)}})},se=async()=>{var l,s,u,_,T;try{if(v(!0),y(""),!((l=p==null?void 0:p.customerName)!=null&&l.trim())){y("Customer name is required");return}for(let F=0;F<((s=p==null?void 0:p.lineItems)==null?void 0:s.length);F++){const ie=(u=p==null?void 0:p.lineItems)==null?void 0:u[F];if(!(ie!=null&&ie.product_id)){y(`Line item ${F+1}: Product is required`);return}if(ie!=null&&ie.requiresScheduling&&!(ie!=null&&ie.lineItemPromisedDate)){y(`Line item ${F+1}: Promised date is required when scheduling is needed`);return}if(!(ie!=null&&ie.requiresScheduling)&&!((_=ie==null?void 0:ie.noScheduleReason)!=null&&_.trim())){y(`Line item ${F+1}: Reason is required when no scheduling is needed`);return}}const C={...p,customer_needs_loaner:!!(p!=null&&p.customer_needs_loaner),lineItems:(T=p==null?void 0:p.lineItems)==null?void 0:T.map(F=>({...F,requiresScheduling:!!(F!=null&&F.requiresScheduling),isOffSite:!!(F!=null&&F.isOffSite),unit_price:parseFloat(F==null?void 0:F.unit_price)||0,quantity_used:parseInt(F==null?void 0:F.quantity_used)||1}))},M={...C,assigned_to:(C==null?void 0:C.assignedTo)??null,delivery_coordinator_id:(C==null?void 0:C.deliveryCoordinator)??null,finance_manager_id:(C==null?void 0:C.financeManager)??null,vendor_id:(C==null?void 0:C.vendor_id)??null};await ds(o,{...M,loanerForm:V}),d==null||d(),a==null||a()}catch(C){y(`Failed to save deal: ${C==null?void 0:C.message}`)}finally{v(!1)}},be=async()=>{try{re(!0),await us(o),d==null||d(),a==null||a()}catch(l){y(`Failed to delete deal: ${l==null?void 0:l.message}`)}finally{re(!1),A(!1)}},ye=()=>{S?c(!0):a()},Ee=()=>{c(!1),a()},Le=()=>{var l;return((l=p==null?void 0:p.lineItems)==null?void 0:l.reduce((s,u)=>{const _=parseFloat(u==null?void 0:u.unit_price)||0,T=parseInt(u==null?void 0:u.quantity_used)||1;return s+_*T},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:ye,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(H,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[g&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:g})}),h?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{ce();try{Z==null||Z()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Fe,{value:p==null?void 0:p.job_status,onChange:l=>{var s;return X({job_status:(s=l==null?void 0:l.target)==null?void 0:s.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(je,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:p==null?void 0:p.customerName,onChange:l=>{var s;return X({customerName:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(je,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:p==null?void 0:p.customerPhone,onChange:l=>{var s;return X({customerPhone:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(je,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:p==null?void 0:p.customerEmail,onChange:l=>{var s;return X({customerEmail:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Fe,{value:p==null?void 0:p.priority,onChange:l=>{var s;return X({priority:(s=l==null?void 0:l.target)==null?void 0:s.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(je,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(p==null?void 0:p.vehicleYear)||"",onChange:l=>{var s;return X({vehicleYear:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"2024",min:"1900",max:((Oe=new Date)==null?void 0:Oe.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(je,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(p==null?void 0:p.vehicleMake)||"",onChange:l=>{var s;return X({vehicleMake:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(je,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(p==null?void 0:p.vehicleModel)||"",onChange:l=>{var s;return X({vehicleModel:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(je,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(p==null?void 0:p.stockNumber)||"",onChange:l=>{var s;return X({stockNumber:(s=l==null?void 0:l.target)==null?void 0:s.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(n,{checked:p==null?void 0:p.customer_needs_loaner,onChange:l=>{if(X({customer_needs_loaner:l}),l&&!(V!=null&&V.eta_return_date)){const s=((p==null?void 0:p.lineItems)||[]).filter(_=>(_==null?void 0:_.requiresScheduling)&&(_==null?void 0:_.lineItemPromisedDate)).map(_=>new Date(_.lineItemPromisedDate).getTime()),u=s!=null&&s.length?new Date(Math.max(...s)):null;u&&N(_=>({..._,eta_return_date:u.toISOString().split("T")[0]}))}}}),R&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",R==null?void 0:R.loaner_number,(R==null?void 0:R.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due"," ",(de=new Date(R==null?void 0:R.eta_return_date))==null?void 0:de.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(p==null?void 0:p.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(je,{id:"loaner-number","aria-label":"Loaner number",value:(V==null?void 0:V.loaner_number)||"",onChange:l=>N(s=>{var u;return{...s,loaner_number:(u=l==null?void 0:l.target)==null?void 0:u.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(je,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(V==null?void 0:V.eta_return_date)||"",onChange:l=>N(s=>{var u;return{...s,eta_return_date:(u=l==null?void 0:l.target)==null?void 0:u.value}}),min:(Te=(Ne=(xe=new Date)==null?void 0:xe.toISOString())==null?void 0:Ne.split("T"))==null?void 0:Te[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(je,{id:"loaner-notes","aria-label":"Loaner notes",value:(V==null?void 0:V.notes)||"",onChange:l=>N(s=>{var u;return{...s,notes:(u=l==null?void 0:l.target)==null?void 0:u.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"mb-4","data-testid":"vendor-select",children:[e.jsx(Me,{label:"Vendor",options:Ce,value:(p==null?void 0:p.vendor_id)||"",onChange:l=>X({vendor_id:l||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"}),!ee&&((W==null?void 0:W.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"sales-select",children:[e.jsx(Me,{label:"Sales Consultant",options:j,value:p==null?void 0:p.assignedTo,onChange:l=>X({assignedTo:l}),placeholder:"Select sales consultant",searchable:!0,clearable:!0}),!ee&&(($==null?void 0:$.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"delivery-select",children:[e.jsx(Me,{label:"Delivery Coordinator",options:U,value:p==null?void 0:p.deliveryCoordinator,onChange:l=>X({deliveryCoordinator:l}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0}),!ee&&((Y==null?void 0:Y.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{"data-testid":"finance-select",children:[e.jsx(Me,{label:"Finance Manager",options:Q,value:p==null?void 0:p.financeManager,onChange:l=>X({financeManager:l}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"}),!ee&&((ge==null?void 0:ge.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(q,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:K,children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(ke=p==null?void 0:p.lineItems)==null?void 0:ke.map((l,s)=>{var u,_,T,C;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",s+1]}),((u=p==null?void 0:p.lineItems)==null?void 0:u.length)>1&&e.jsx(q,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>E(s),children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Me,{label:"Product *",options:he,value:(l==null?void 0:l.product_id)||"",onChange:M=>ue(s,{product_id:M?parseInt(M):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(je,{id:`unit-price-${s}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:l==null?void 0:l.unit_price,onChange:M=>{var F;return ue(s,{unit_price:parseFloat((F=M==null?void 0:M.target)==null?void 0:F.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(je,{id:`quantity-${s}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:l==null?void 0:l.quantity_used,onChange:M=>{var F;return ue(s,{quantity_used:parseInt((F=M==null?void 0:M.target)==null?void 0:F.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(k,{selectedValue:l==null?void 0:l.isOffSite,onChange:M=>ue(s,{isOffSite:M}),itemIndex:s})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(z,{requiresScheduling:l==null?void 0:l.requiresScheduling,onChange:M=>ue(s,{requiresScheduling:M}),itemIndex:s})}),l!=null&&l.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(je,{id:`promised-date-${s}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:l==null?void 0:l.lineItemPromisedDate,onChange:M=>{var F;return ue(s,{lineItemPromisedDate:(F=M==null?void 0:M.target)==null?void 0:F.value})},min:(C=(T=(_=new Date)==null?void 0:_.toISOString())==null?void 0:T.split("T"))==null?void 0:C[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(je,{id:`notes-${s}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(l==null?void 0:l.description)||"",onChange:M=>{var F;return ue(s,{description:(F=M==null?void 0:M.target)==null?void 0:F.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(je,{id:`no-schedule-reason-${s}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:l==null?void 0:l.noScheduleReason,onChange:M=>{var F;return ue(s,{noScheduleReason:(F=M==null?void 0:M.target)==null?void 0:F.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(l==null?void 0:l.unit_price)||0)*(parseInt(l==null?void 0:l.quantity_used)||1)).toFixed(2)]})]},s)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(_e=Le())==null?void 0:_e.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(q,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>A(!0),children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(q,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:ye,children:"Cancel"}),e.jsx(q,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:se,disabled:f,children:f?"Saving...":"Save Changes"})]})]}),m&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(q,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>A(!1),children:"Cancel"}),e.jsx(q,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:be,disabled:G,children:G?"Deleting...":"Delete"})]})]})}),B&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(q,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>c(!1),children:"Keep Editing"}),e.jsx(q,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:Ee,children:"Discard Changes"})]})]})})]})}):null};function Ss({isOpen:r,onClose:o,deal:t}){const[a,d]=w.useState("Customer"),[h,i]=w.useState(""),f=w.useMemo(()=>["Customer","Vehicle","Deal & Pricing","Scheduling","Vendor","Files","Activity","Alerts/Holds"],[]);if(!r||!t)return null;const v=async m=>{try{await navigator.clipboard.writeText(m),i("Copied!"),setTimeout(()=>i(""),1500)}catch{i("Copy failed"),setTimeout(()=>i(""),1500)}},g=({title:m,children:A})=>e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2",children:m}),e.jsx("div",{className:"bg-white border border-slate-200 rounded-lg p-3 text-sm text-slate-800",children:A||e.jsx("span",{className:"text-slate-400",children:"â€”"})})]}),y=()=>{var m,A,G,re,S;switch(a){case"Customer":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Customer",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(t==null?void 0:t.customer_name)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(t==null?void 0:t.customer_email)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(t==null?void 0:t.customer_phone)||"â€”"})]}),e.jsxs("div",{className:"flex gap-2",children:[(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`tel:${t==null?void 0:t.customer_phone}`,onClick:x=>x.stopPropagation(),children:e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`sms:${t==null?void 0:t.customer_phone}`,onClick:x=>x.stopPropagation(),children:e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",onClick:()=>v(`${(t==null?void 0:t.customer_name)||""} ${(t==null?void 0:t.customer_phone)||""}`.trim()),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy"]})]})]})})});case"Vehicle":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Vehicle",children:e.jsxs("div",{children:[e.jsx("div",{children:t!=null&&t.vehicle?`${((m=t==null?void 0:t.vehicle)==null?void 0:m.year)||""} ${((A=t==null?void 0:t.vehicle)==null?void 0:A.make)||""} ${((G=t==null?void 0:t.vehicle)==null?void 0:G.model)||""}`.trim():"â€”"}),((re=t==null?void 0:t.vehicle)==null?void 0:re.stock_number)&&e.jsxs("div",{className:"text-slate-600",children:["Stock: ",(S=t==null?void 0:t.vehicle)==null?void 0:S.stock_number]})]})})});case"Deal & Pricing":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Totals",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Value"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(parseFloat(t==null?void 0:t.total_amount)||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Est. Margin"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(t==null?void 0:t.total_amount)||0)*.25)})]})]})})});case"Scheduling":return e.jsxs(e.Fragment,{children:[e.jsx(g,{title:"Appointment",children:t!=null&&t.appt_start?e.jsxs("div",{className:"text-sm",children:[new Date(t==null?void 0:t.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(t==null?void 0:t.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",t!=null&&t.appt_end?new Date(t==null?void 0:t.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):"â€”"}),e.jsx(g,{title:"Next Promise",children:t!=null&&t.next_promised_iso?new Date(t==null?void 0:t.next_promised_iso).toLocaleString():"â€”"})]});case"Vendor":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Vendor",children:e.jsx("div",{children:(t==null?void 0:t.vendor_name)||"Unassigned"})})});case"Files":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Files",children:"No files yet."})});case"Activity":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Activity",children:"Activity timeline coming soon."})});case"Alerts/Holds":return e.jsx(e.Fragment,{children:e.jsx(g,{title:"Alerts/Holds",children:"No alerts."})});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50",onClick:o}),e.jsxs("div",{className:"fixed right-0 top-0 h-full w-full md:w-[520px] bg-white shadow-xl z-50 overflow-y-auto",children:[e.jsxs("div",{className:"p-5 border-b bg-white sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:(t==null?void 0:t.job_number)||`Job-${String((t==null?void 0:t.id)||"").slice(0,8)}`}),e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:(t==null?void 0:t.customer_name)||"Deal Details"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[h&&e.jsx("span",{className:"text-xs text-slate-500",children:h}),e.jsx(q,{variant:"ghost",size:"icon",onClick:o,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`tel:${t==null?void 0:t.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(q,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`sms:${t==null?void 0:t.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(q,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",onClick:()=>v((t==null?void 0:t.customer_phone)||""),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy Phone"]}),e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"Calendar",size:16,className:"mr-1"})," Schedule"]}),e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"FileText",size:16,className:"mr-1"})," Note"]}),e.jsxs(q,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-1"})," Complete"]})]})]}),e.jsx("div",{className:"px-5 pt-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:f.map(m=>e.jsx("button",{onClick:()=>d(m),className:`px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap border ${a===m?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:m},m))})}),e.jsx("div",{className:"p-5",children:y()})]})]})}function ks({isOpen:r,onClose:o,deal:t,onSave:a,loading:d}){const[h,i]=w.useState(""),[f,v]=w.useState(""),[g,y]=w.useState("");if(w.useEffect(()=>{if(!r)return;i((t==null?void 0:t.loaner_number)||"");const A=(t==null?void 0:t.loaner_eta_return_date)||"";if(A)try{const G=new Date(A),re=G.getFullYear(),S=String(G.getMonth()+1).padStart(2,"0"),x=String(G.getDate()).padStart(2,"0");v(`${re}-${S}-${x}`)}catch{v("")}else v("");y("")},[r,t]),!r)return null;const m=async()=>{const A={job_id:t==null?void 0:t.id,loaner_number:(h||"").trim(),eta_return_date:f||null,notes:(g||"").trim()||null};await(a==null?void 0:a(A))};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50",onClick:o}),e.jsxs("div",{className:"fixed right-0 top-0 h-full w-full md:w-[420px] bg-white shadow-xl z-50 overflow-y-auto",children:[e.jsxs("div",{className:"p-5 border-b bg-white sticky top-0 z-10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:(t==null?void 0:t.job_number)||`Job-${String((t==null?void 0:t.id)||"").slice(0,8)}`}),e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:t!=null&&t.customer_name?`Loaner for ${t.customer_name}`:"Assign Loaner"})]}),e.jsx(q,{variant:"ghost",size:"icon",onClick:o,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]}),e.jsxs("div",{className:"p-5 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Loaner Number"}),e.jsx("input",{"data-testid":"loaner-number-input",type:"text",value:h,onChange:A=>i(A.target.value),placeholder:"#123",className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"ETA Return Date"}),e.jsx("input",{"data-testid":"loaner-eta-input",type:"date",value:f,onChange:A=>v(A.target.value),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Notes (optional)"}),e.jsx("textarea",{"data-testid":"loaner-notes-input",value:g,onChange:A=>y(A.target.value),rows:3,className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(q,{variant:"outline",onClick:o,className:"h-11 flex-1","aria-label":"Cancel loaner edit",disabled:d,children:"Cancel"}),e.jsx(q,{onClick:m,className:"h-11 flex-1 bg-purple-600 hover:bg-purple-700 text-white","aria-label":"Save loaner",disabled:d||!h.trim(),children:d?"Savingâ€¦":"Save"})]})]})]})]})}const Ke=({status:r})=>{var d;const o={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},t=(o==null?void 0:o[r])||"bg-gray-100 text-gray-700",a=((d=r==null?void 0:r.replace("_"," "))==null?void 0:d.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t}`,children:a})},Ge=({deal:r})=>{const o=r!=null&&r.loaner_eta_return_date?new Date(r.loaner_eta_return_date).toLocaleDateString("en-US",{month:"short",day:"numeric"}):null;return e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200",children:[e.jsx(H,{name:"Car",size:12,className:"mr-1"}),r!=null&&r.loaner_number?`#${r.loaner_number}`:"Loaner",o?` â€¢ Due ${o}`:""]})},Cs=r=>{try{if(!r)return"â€”";const o=new Date(r);if(Number.isNaN(o.getTime()))return"â€”";const t=Date.now()-o.getTime(),a=Math.floor(t/1e3),d=Math.floor(a/60),h=Math.floor(d/60),i=Math.floor(h/24);return i>0?`${i}d ago`:h>0?`${h}h ago`:d>0?`${d}m ago`:"just now"}catch{return"â€”"}},Ze=({nextPromisedAt:r})=>{var v;if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const o=new Date,a=new Date(r)-o,d=a<0,h=a>=0&&a<24*60*60*1e3,i=d?"bg-red-100 text-red-800 border-red-200":h?"bg-amber-100 text-amber-800 border-amber-200":"bg-green-100 text-green-800 border-green-200",f=(v=new Date(r))==null?void 0:v.toLocaleDateString("en-US",{month:"short",day:"numeric"});return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${i}`,children:["Next: ",f]})},Es=({deal:r})=>{if(!r)return e.jsx("span",{className:"text-sm text-slate-700",children:"â€”"});const o=(r==null?void 0:r.customer_name)||(r==null?void 0:r.customerEmail)||"â€”",t=(r==null?void 0:r.customer_email)||"",a=Array.isArray(r==null?void 0:r.work_tags)?r.work_tags:[],d=[o,t,a.length?`Tags: ${a.join(", ")}`:null].filter(Boolean).join(" â€¢ ");return e.jsxs("div",{className:"flex flex-col gap-1",title:d,children:[e.jsx("span",{className:"text-sm font-medium text-slate-800",children:o}),t?e.jsx("span",{className:"text-xs text-slate-500",children:t}):null,a.length?e.jsx("div",{className:"flex flex-wrap gap-1",children:a.map(h=>e.jsx("span",{className:"inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600",children:h},h))}):null]})},Re=r=>{var i;if(!r)return"Deal";const o=(r==null?void 0:r.job_number)||(r==null?void 0:r.jobNumber),t=((r==null?void 0:r.title)||(r==null?void 0:r.description)||"").trim(),a=((i=r==null?void 0:r.vehicle)==null?void 0:i.stock_number)||(r==null?void 0:r.stock_no)||(r==null?void 0:r.stockNumber)||(r==null?void 0:r.vehicle_stock),d=r!=null&&r.id?`Job-${String(r.id).slice(0,8)}`:"",h=((r==null?void 0:r.customer_name)||(r==null?void 0:r.customerName)||"").trim();return o&&t?`${o} â€¢ ${t}`:o&&a?`${o} â€¢ Stock ${a}`:o||(t&&a?`${t} â€¢ Stock ${a}`:t||(a?`Stock ${a}`:h||d||"Deal"))},$s=r=>{var i,f,v,g;if(!r)return"";const o=[(i=r==null?void 0:r.vehicle)==null?void 0:i.year,(f=r==null?void 0:r.vehicle)==null?void 0:f.make,(v=r==null?void 0:r.vehicle)==null?void 0:v.model].filter(Boolean).join(" ").trim(),t=((g=r==null?void 0:r.vehicle)==null?void 0:g.stock_number)||(r==null?void 0:r.stock_no),a=(r==null?void 0:r.vendor_name)||"",d=Array.isArray(r==null?void 0:r.work_tags)?r.work_tags.slice(0,2):[],h=[];return o&&h.push(o),t&&h.push(`Stock ${t}`),a&&h.push(a),d.length&&h.push(d.join(", ")),h.join(" â€¢ ")},Qe=({amount:r})=>{const o=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2});return typeof r!="number"||Number.isNaN(r)?e.jsx("span",{className:"text-sm text-slate-700",children:"â€”"}):e.jsx("span",{className:"text-sm text-slate-700",children:o.format(r)})},De=({serviceType:r,jobParts:o})=>{const t=o==null?void 0:o.some(d=>d==null?void 0:d.is_off_site),a=o==null?void 0:o.some(d=>!(d!=null&&d.is_off_site));return t&&a?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):t?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},Ts=({draftsCount:r,onViewDrafts:o})=>{const[t,a]=w.useState(!1);return r===0||t?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(H,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{size:"sm",variant:"ghost",onClick:o,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>a(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(H,{name:"X",size:16})})]})]})})},As=({loaner:r,onClose:o,onConfirm:t,loading:a})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(q,{variant:"outline",onClick:o,className:"flex-1 h-11",disabled:a,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(q,{onClick:t,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:a,"aria-label":"Confirm loaner returned",children:a?"Processing...":"Mark Returned"})]})]})})}):null;function Vs(){var l;const[r,o]=w.useState([]),[t,a]=w.useState(!0),[d,h]=w.useState(!1),[i,f]=w.useState(!1),[v,g]=w.useState(null),[y,m]=w.useState(null),[A,G]=w.useState(null),[re,S]=w.useState(""),[x,B]=w.useState({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),[c,ae]=w.useState(!1),[b,R]=w.useState(null),[O,V]=w.useState(!1),[N,$]=w.useState(null),[Y,ge]=w.useState(!1),[W,he]=w.useState(""),[ee,Z]=w.useState(!1),[p,P]=w.useState(null),{getUserOptions:ve,getVendorOptions:Ce,clearSearch:j,error:U}=as({loadOnMount:!0});ps();const{user:Q}=Pe(),[n,k]=w.useState([]),[z,oe]=w.useState(""),ce=()=>{try{return ve({roles:["staff"],departments:["Sales Consultants"],activeOnly:!0})||[]}catch(s){return console.error("Error getting sales consultants:",s),[]}},le=()=>{try{return ve({roles:["admin","manager"],departments:["Delivery Coordinator"],activeOnly:!0})||[]}catch(s){return console.error("Error getting delivery coordinators:",s),[]}},X=()=>{try{return ve({roles:["staff"],departments:["Finance Manager"],activeOnly:!0})||[]}catch(s){return console.error("Error getting finance managers:",s),[]}},ue=(s={})=>{try{return Ce(s)||[]}catch(u){return console.error("Error getting vendor options:",u),[]}},K=async s=>{var u;try{S("");const{error:_}=await((u=D)==null?void 0:u.rpc("delete_job_cascade",{p_job_id:s}));if(_)throw _;G(null),await be()}catch(_){S(`Failed to delete deal: ${_==null?void 0:_.message}`),console.error("Delete error:",_)}},E=async s=>{var u,_,T,C,M,F,ie,ne,te,J;try{V(!0),S("");let I=null;try{const{data:L}=await((M=(C=(T=(_=(u=D)==null?void 0:u.from("loaner_assignments"))==null?void 0:_.select("id"))==null?void 0:T.eq("job_id",s==null?void 0:s.job_id))==null?void 0:C.is("returned_at",null))==null?void 0:M.limit(1));I=Array.isArray(L)?L[0]:L}catch{}if(I!=null&&I.id){const{error:L}=await((ne=(ie=(F=D)==null?void 0:F.from("loaner_assignments"))==null?void 0:ie.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:ne.eq("id",I.id));if(L)throw L}else{const{error:L}=await((J=(te=D)==null?void 0:te.from("loaner_assignments"))==null?void 0:J.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(L)throw L}ae(!1),R(null),await be()}catch(I){const L=`Failed to save loaner assignment: ${I==null?void 0:I.message}`;throw S(L),new Error(L)}finally{V(!1)}},se=async s=>{try{ge(!0),S(""),await hs(s==null?void 0:s.loaner_id),$(null),await be()}catch(u){S(`Failed to mark loaner as returned: ${u==null?void 0:u.message}`),console.error("Mark returned error:",u)}finally{ge(!1)}},be=async(s=0)=>{var u,_;try{a(!0),S("");const T=await xs();o(T||[])}catch(T){const C=`Failed to load deals: ${T==null?void 0:T.message}`;if(console.error("Load deals error:",T),s<2&&((u=T==null?void 0:T.message)!=null&&u.includes("fetch")||(_=T==null?void 0:T.message)!=null&&_.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>be(s+1),1e3*(s+1));return}S(C),o([])}finally{a(!1)}};w.useEffect(()=>{var _;const s=new URLSearchParams(window.location.search),u=s==null?void 0:s.get("status");if(u){const T=((_=u==null?void 0:u.charAt(0))==null?void 0:_.toUpperCase())+(u==null?void 0:u.slice(1));B(C=>({...C,status:T}))}},[]),w.useEffect(()=>{be()},[]),w.useEffect(()=>{try{const s=localStorage.getItem("dealsSavedViews");if(s){const u=JSON.parse(s);Array.isArray(u)&&k(u)}}catch{}},[]);const ye=s=>{R(s),ae(!0)},Ee=s=>{P(s),Z(!0)},Le=({message:s,onClose:u})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),u&&e.jsx("button",{onClick:u,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(H,{name:"X",size:16})})]})}):null,de=(s=>{var ne,te,J;const u=s||[],_=((ne=u==null?void 0:u.filter(I=>(I==null?void 0:I.job_status)==="in_progress"))==null?void 0:ne.length)||0,T=u==null?void 0:u.reduce((I,L)=>{const me=parseFloat(L==null?void 0:L.total_amount)||0;return I+me},0),C=T*.25,M=T>0?25:0,F=((te=u==null?void 0:u.filter(I=>(I==null?void 0:I.job_status)==="pending"))==null?void 0:te.length)||0,ie=((J=u==null?void 0:u.filter(I=>(I==null?void 0:I.job_status)==="draft"))==null?void 0:J.length)||0;return{active:_,revenue:(T==null?void 0:T.toFixed(2))||"0.00",profit:(C==null?void 0:C.toFixed(2))||"0.00",margin:(M==null?void 0:M.toFixed(1))||"0.0",pending:F,drafts:ie}})(r),xe=r==null?void 0:r.filter(s=>{var u,_,T,C,M,F,ie;if((x==null?void 0:x.status)!=="All"){let ne=(_=(u=x==null?void 0:x.status)==null?void 0:u.toLowerCase())==null?void 0:_.replace(" ","_");if(ne==="active"&&(ne="in_progress"),(s==null?void 0:s.job_status)!==ne)return!1}if(x!=null&&x.presetView&&(x==null?void 0:x.presetView)!=="All"){const ne=new Date,te=new Date(ne);te.setHours(0,0,0,0);const J=new Date(ne);J.setHours(23,59,59,999);const I=s!=null&&s.appt_start?new Date(s==null?void 0:s.appt_start):null,L=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null,me=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null,fe=Array.isArray(s==null?void 0:s.job_parts)?(T=s==null?void 0:s.job_parts)==null?void 0:T.some(pe=>pe==null?void 0:pe.requires_scheduling):!1,we=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id);switch(x==null?void 0:x.presetView){case"Today":if(!(I&&I>=te&&I<=J))return!1;break;case"Past Due":if(!(L&&L<ne))return!1;break;case"Unscheduled":if(!(fe&&!I))return!1;break;case"Off-site Today":{const Be=(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some($e=>$e==null?void 0:$e.is_off_site),Se=$e=>$e&&$e>=te&&$e<=J;if(!(Be&&(Se(I)||Se(L))))return!1;break}case"Awaiting Vendor/Parts":{if(!(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some(Se=>(Se==null?void 0:Se.requires_scheduling)&&!(Se!=null&&Se.promised_date)))return!1;break}case"Completedâ€”awaiting pickup":if(!((s==null?void 0:s.job_status)==="completed"&&(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id)))return!1;break;case"My Deals":if(!(s!=null&&s.assigned_to&&(Q!=null&&Q.id)&&s.assigned_to===Q.id))return!1;break;case"Loaners Out":if(!we)return!1;break;case"Loaners Due":if(!(we&&me&&me>=te&&me<=J))return!1;break;case"Loaners Overdue":if(!(we&&me&&me<te))return!1;break}}if(x!=null&&x.salesAssigned&&(s==null?void 0:s.assigned_to)!==(x==null?void 0:x.salesAssigned)||x!=null&&x.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(x==null?void 0:x.deliveryAssigned)||x!=null&&x.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(x==null?void 0:x.financeAssigned)||x!=null&&x.vendor&&(s==null?void 0:s.vendor_id)!==(x==null?void 0:x.vendor))return!1;if(x!=null&&x.location&&(x==null?void 0:x.location)!=="All"){const ne=Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[],te=ne.some(L=>L==null?void 0:L.is_off_site),J=ne.some(L=>!(L!=null&&L.is_off_site));if((te&&J?"Mixed":te?"Off-Site":"In-House")!==x.location)return!1}if((C=x==null?void 0:x.workTags)!=null&&C.length){const ne=Array.isArray(s==null?void 0:s.work_tags)?s.work_tags:[];if(!x.workTags.some(J=>ne.includes(J)))return!1}if(x!=null&&x.loanerStatus&&(x==null?void 0:x.loanerStatus)!=="All"){const ne=new Date,te=new Date(ne);te.setHours(0,0,0,0);const J=new Date(ne);J.setHours(23,59,59,999);const I=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id),L=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null;switch(x.loanerStatus){case"Active":if(!I)return!1;break;case"Due Today":if(!(I&&L&&L>=te&&L<=J))return!1;break;case"Overdue":if(!(I&&L&&L<te))return!1;break;case"None":if(I)return!1;break}}if(x!=null&&x.promiseStartDate||x!=null&&x.promiseEndDate){const ne=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null;if(!ne)return!1;if(x!=null&&x.promiseStartDate){const te=new Date(x.promiseStartDate+"T00:00:00");if(ne<te)return!1}if(x!=null&&x.promiseEndDate){const te=new Date(x.promiseEndDate+"T23:59:59.999");if(ne>te)return!1}}if(W!=null&&W.trim()){const ne=W==null?void 0:W.toLowerCase(),te=me=>(me==null?void 0:me.replace(/\D/g,""))||"",J=te(ne),I=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(M=s==null?void 0:s.vehicle)==null?void 0:M.make,(F=s==null?void 0:s.vehicle)==null?void 0:F.model,((ie=s==null?void 0:s.vehicle)==null?void 0:ie.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(I==null?void 0:I.some(me=>{var we;const fe=me==null?void 0:me.toLowerCase();return!!(fe!=null&&fe.includes(ne)||(J==null?void 0:J.length)>=3&&((we=te(fe))!=null&&we.includes(J)))})))return!1}return!0});w.useEffect(()=>{const s=setTimeout(()=>{he(x==null?void 0:x.search)},300);return()=>clearTimeout(s)},[x==null?void 0:x.search]);const Ne=(s,u)=>{var _,T;if(B(C=>({...C,[s]:u})),s==="status"){const C=new URLSearchParams(window.location.search);u==="All"?C==null||C.delete("status"):C==null||C.set("status",u==null?void 0:u.toLowerCase());const M=`${(_=window.location)==null?void 0:_.pathname}${C!=null&&C.toString()?"?"+(C==null?void 0:C.toString()):""}`;(T=window.history)==null||T.replaceState({},"",M)}},Te=()=>{var s,u;B({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),j(),(u=window.history)==null||u.replaceState({},"",(s=window.location)==null?void 0:s.pathname)};ns.useMemo(()=>{const s=new Set;for(const u of r||[])for(const _ of(u==null?void 0:u.work_tags)||[])s.add(_);return Array.from(s).sort((u,_)=>u.localeCompare(_))},[r]),ue({activeOnly:!0}),ce(),le(),X();const ke=s=>{var u;g(s);try{const _=(u=xe!=null&&xe.length?xe:r)==null?void 0:u.find(T=>(T==null?void 0:T.id)===s);m(_||null)}catch{m(null)}f(!0)},_e=()=>{f(!1),g(null),m(null)};return t?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(We,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(We,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(Le,{message:re||U,onClose:()=>{S("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(vs,{exportType:"jobs",filters:{status:x==null?void 0:x.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,u)=>console.log(`Export complete: ${s} records`),onExportError:s=>S(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(q,{onClick:()=>h(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(Ts,{draftsCount:de==null?void 0:de.drafts,onViewDrafts:()=>Ne("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:de==null?void 0:de.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(H,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",de==null?void 0:de.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(H,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",de==null?void 0:de.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(H,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[de==null?void 0:de.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:de==null?void 0:de.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(H,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:de==null?void 0:de.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>Ne("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(x==null?void 0:x.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),!1,e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(H,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:x==null?void 0:x.search,onChange:s=>{var u;return Ne("search",(u=s==null?void 0:s.target)==null?void 0:u.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(q,{variant:"ghost",size:"sm",onClick:Te,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(H,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]}),!1]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",xe==null?void 0:xe.length," of ",r==null?void 0:r.length," deals",(x==null?void 0:x.search)&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-x-auto shadow-sm",children:e.jsxs("table",{className:"table-fixed min-w-[1200px] w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Promise"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Appt Window"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vehicle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-[120px]",children:"$"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Work"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider hidden xl:table-cell",children:"Vendor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider hidden xl:table-cell",children:"Last Activity"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:xe==null?void 0:xe.map(s=>{var u,_,T,C,M,F,ie,ne,te,J,I;return e.jsxs("tr",{className:"hover:bg-slate-50 cursor-pointer",onClick:()=>Ee(s),children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(Ke,{status:s==null?void 0:s.job_status})}),e.jsx("td",{className:"px-4 py-3 w-[72px]",children:e.jsx("span",{className:"text-sm text-slate-700",children:typeof(s==null?void 0:s.age_days)=="number"?`${s==null?void 0:s.age_days}d`:"â€”"})}),e.jsx("td",{className:"px-4 py-3 w-[120px]",children:e.jsx(Ze,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),e.jsx("td",{className:"px-4 py-3 w-[180px]",children:s!=null&&s.appt_start?e.jsxs("span",{className:"text-sm text-slate-700",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-4 py-3 max-w-[220px]",children:e.jsx("div",{className:"truncate",children:e.jsx(Es,{deal:s})})}),e.jsx("td",{className:"px-4 py-3 w-[150px]",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[(s==null?void 0:s.customer_phone_e164)||(s==null?void 0:s.customer_phone)||"â€”",s!=null&&s.customer_phone_last4?e.jsxs("span",{className:"text-slate-400",children:[" ","(",`â€¦${s==null?void 0:s.customer_phone_last4}`,")"]}):null]})}),e.jsx("td",{className:"px-4 py-3 max-w-[220px]",children:e.jsxs("span",{className:"text-sm text-slate-700 truncate inline-block max-w-full",title:`${s!=null&&s.vehicle?`${((u=s==null?void 0:s.vehicle)==null?void 0:u.year)||""} ${((_=s==null?void 0:s.vehicle)==null?void 0:_.make)||""} ${((T=s==null?void 0:s.vehicle)==null?void 0:T.model)||""}`.trim():""}${(C=s==null?void 0:s.vehicle)!=null&&C.stock_number?` â€¢ Stock: ${(M=s==null?void 0:s.vehicle)==null?void 0:M.stock_number}`:""}`.trim()||"",children:[s!=null&&s.vehicle?`${((F=s==null?void 0:s.vehicle)==null?void 0:F.year)||""} ${((ie=s==null?void 0:s.vehicle)==null?void 0:ie.make)||""} ${((ne=s==null?void 0:s.vehicle)==null?void 0:ne.model)||""}`.trim():"â€”",(te=s==null?void 0:s.vehicle)!=null&&te.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(J=s==null?void 0:s.vehicle)==null?void 0:J.stock_number]}):null]})}),e.jsx("td",{className:"px-4 py-3 w-[120px]",children:e.jsx(Qe,{amount:s==null?void 0:s.total_amount})}),e.jsx("td",{className:"px-4 py-3 max-w-[180px]",children:e.jsxs("div",{className:"flex flex-wrap gap-1 truncate",children:[((s==null?void 0:s.work_tags)||[]).slice(0,2).map(L=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 border border-slate-200",children:L},L)),(s==null?void 0:s.work_tags)&&(s==null?void 0:s.work_tags.length)>2&&e.jsxs("span",{className:"text-xs text-slate-500",children:["+",s.work_tags.length-2]}),(!(s!=null&&s.work_tags)||((I=s==null?void 0:s.work_tags)==null?void 0:I.length)===0)&&e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})]})}),e.jsx("td",{className:"px-4 py-3 max-w-[160px] hidden xl:table-cell",children:e.jsx("span",{className:"text-sm text-slate-700 truncate inline-block max-w-full",title:(s==null?void 0:s.vendor_name)||"Unassigned",children:(s==null?void 0:s.vendor_name)||"Unassigned"})}),e.jsx("td",{className:"px-4 py-3 w-[120px]",children:e.jsx(De,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-4 py-3 w-[120px] hidden xl:table-cell",children:e.jsx("span",{className:"text-sm text-slate-700",children:Cs(s==null?void 0:s.created_at)})}),e.jsx("td",{className:"px-4 py-3 w-[140px]",children:s!=null&&s.loaner_number||s!=null&&s.has_active_loaner?e.jsx(Ge,{deal:s}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-4 py-3 text-right w-[160px]",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(q,{size:"sm",variant:"ghost",onClick:L=>{L.stopPropagation(),ke(s==null?void 0:s.id)},className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(q,{size:"sm",variant:"ghost",onClick:L=>{L.stopPropagation(),ye(s)},className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(q,{size:"sm",variant:"ghost",onClick:L=>{L.stopPropagation(),$({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Re(s)})},className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(q,{size:"sm",variant:"ghost",onClick:L=>{L.stopPropagation(),G(s)},className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(xe==null?void 0:xe.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(x==null?void 0:x.status)==="All"?"No deals found":`No ${(l=x==null?void 0:x.status)==null?void 0:l.toLowerCase()} deals found`})}):xe==null?void 0:xe.map(s=>{var u,_,T,C,M;return e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Re(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:$s(s)||"â€”"})]}),e.jsx(Ke,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-medium text-slate-900 text-sm",children:(s==null?void 0:s.customer_name)||"â€”"}),e.jsx("div",{className:"text-xs text-slate-500 truncate",children:s!=null&&s.customer_phone?e.jsx("a",{href:`tel:${s==null?void 0:s.customer_phone}`,onClick:F=>{var ie;return(ie=F==null?void 0:F.stopPropagation)==null?void 0:ie.call(F)},className:"underline",children:s==null?void 0:s.customer_phone}):"â€”"})]}),e.jsx("div",{className:"ml-3 shrink-0",children:e.jsx(De,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})})]}),e.jsxs("div",{className:"text-xs text-slate-600 truncate",children:[(s!=null&&s.vehicle?`${((u=s==null?void 0:s.vehicle)==null?void 0:u.year)||""} ${((_=s==null?void 0:s.vehicle)==null?void 0:_.make)||""} ${((T=s==null?void 0:s.vehicle)==null?void 0:T.model)||""}`.trim():"")||"â€”",(C=s==null?void 0:s.vehicle)!=null&&C.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(M=s==null?void 0:s.vehicle)==null?void 0:M.stock_number]}):null,s!=null&&s.vendor_name?e.jsxs("span",{className:"text-slate-400",children:[" â€¢ ",s==null?void 0:s.vendor_name]}):null]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{"data-testid":"mobile-next-chip",children:e.jsx(Ze,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),(s==null?void 0:s.appt_start)&&e.jsxs("span",{className:"text-xs text-slate-700","data-testid":"mobile-appt-window",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}),((s==null?void 0:s.loaner_number)||(s==null?void 0:s.has_active_loaner))&&e.jsx(Ge,{deal:s}),e.jsx("div",{className:"ml-auto font-medium text-slate-900 text-sm",children:e.jsx(Qe,{amount:s==null?void 0:s.total_amount})})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>ke(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>G(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>ye(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(H,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>ye(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>$({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Re(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id)})}),e.jsx(ys,{isOpen:d,onClose:()=>h(!1),onSuccess:be}),e.jsx(ws,{isOpen:i,dealId:v,deal:y,onClose:_e,onSuccess:()=>{be(),_e()}}),A&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(q,{variant:"outline",onClick:()=>G(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(q,{onClick:()=>K(A==null?void 0:A.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(ks,{isOpen:c,onClose:()=>{ae(!1),R(null),S("")},deal:b,onSave:E,loading:O}),e.jsx(Ss,{isOpen:ee,onClose:()=>{Z(!1),P(null)},deal:p}),e.jsx(As,{loaner:N,onClose:()=>{$(null),S("")},onConfirm:()=>se(N),loading:Y})]})]})}export{Vs as default};
//# sourceMappingURL=index-BpYyjGin.js.map
