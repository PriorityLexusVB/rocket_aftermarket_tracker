import{s as J,u as Ce,j as e,B,S as Se,I as Te,g as ze,a as Ae,b as qe,c as Re,d as Ve,e as Ye,f as Je,h as he}from"./index-CPnol-fB.js";import{r as E,R as Ke}from"./react-Czq5O75u.js";import{dealService as Ee,getDeal as Xe,mapDbDealToForm as We,updateDeal as He,deleteDeal as Ge,markLoanerReturned as Ze,getAllDeals as Qe}from"./dealService-TwCMg0z-.js";import{u as Be}from"./useTenant-DmtAcTlV.js";import{s as ye,t as De}from"./options-CllavUpK.js";import{I as H}from"./Icon-BPQTc-Lt.js";import{l as es}from"./vendorService-CtFRLr9v.js";import{l as ss}from"./smsTemplateService-CUlR8AN9.js";import{N as $e}from"./Navbar-BNMYGfNu.js";import{a as rs}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const as=(r,o="")=>r==null?o:String(r),pe={async getOverdueJobs(){var r;try{const{data:o,error:n}=await((r=J)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return n?(console.error("Error fetching overdue jobs:",n),{data:[],error:{message:n==null?void 0:n.message}}):{data:o||[],error:null}}catch(o){return console.error("Error in getOverdueJobs service:",o),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,o,n,c;try{const{data:h,error:u}=await((c=(n=(o=(r=J)==null?void 0:r.from("sms_templates"))==null?void 0:o.select("*"))==null?void 0:n.eq("is_active",!0))==null?void 0:c.order("created_at",{ascending:!1}));return u?{data:[],error:{message:u==null?void 0:u.message}}:{data:h||[],error:null}}catch(h){return console.error("Error fetching SMS templates:",h),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var o,n,c,h,u,d,m,j;try{const b=await((n=(o=J)==null?void 0:o.auth)==null?void 0:n.getUser()),{data:v,error:f}=await((j=(m=(d=(c=J)==null?void 0:c.from("sms_templates"))==null?void 0:d.insert([{...r,created_by:(u=(h=b==null?void 0:b.data)==null?void 0:h.user)==null?void 0:u.id}]))==null?void 0:m.select())==null?void 0:j.single());return f?{data:null,error:{message:f==null?void 0:f.message}}:{data:v,error:null}}catch(b){return console.error("Error creating SMS template:",b),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,o){var n,c,h,u,d,m;try{const{data:j,error:b}=await((m=(d=(u=(h=(n=J)==null?void 0:n.from("sms_templates"))==null?void 0:h.update({...o,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:u.eq("id",r))==null?void 0:d.select())==null?void 0:m.single());return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:j,error:null}}catch(j){return console.error("Error updating SMS template:",j),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var o,n,c;try{const{error:h}=await((c=(n=(o=J)==null?void 0:o.from("sms_templates"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting SMS template:",h),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var o,n,c,h,u,d,m,j,b;try{const v=await((n=(o=J)==null?void 0:o.auth)==null?void 0:n.getUser()),{data:f,error:A}=await((b=(j=(u=(h=(c=J)==null?void 0:c.from("filter_presets"))==null?void 0:h.select("*"))==null?void 0:u.eq("page_type",r))==null?void 0:j.or(`user_id.eq.${(m=(d=v==null?void 0:v.data)==null?void 0:d.user)==null?void 0:m.id},is_public.eq.true`))==null?void 0:b.order("created_at",{ascending:!1}));return A?{data:[],error:{message:A==null?void 0:A.message}}:{data:f||[],error:null}}catch(v){return console.error("Error fetching filter presets:",v),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,o,n,c=!1){var h,u,d,m,j,b,v,f;try{const A=await((u=(h=J)==null?void 0:h.auth)==null?void 0:u.getUser()),{data:q,error:x}=await((f=(v=(b=(d=J)==null?void 0:d.from("filter_presets"))==null?void 0:b.insert([{user_id:(j=(m=A==null?void 0:A.data)==null?void 0:m.user)==null?void 0:j.id,page_type:r,name:o,filters:n,is_public:c}]))==null?void 0:v.select())==null?void 0:f.single());return x?{data:null,error:{message:x==null?void 0:x.message}}:{data:q,error:null}}catch(A){return console.error("Error saving filter preset:",A),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var o,n,c;try{const{error:h}=await((c=(n=(o=J)==null?void 0:o.from("filter_presets"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting filter preset:",h),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,o={},n="staff"){var c,h;try{const{data:u,error:d}=await((c=J)==null?void 0:c.rpc("generate_export_data",{export_type:r,filters:o,user_role:n}));return d?{data:null,error:{message:d==null?void 0:d.message}}:{data:(h=u||[])==null?void 0:h.map(j=>{var f;const b=(j==null?void 0:j.export_data)||j,v={};return(f=Object==null?void 0:Object.entries(b))==null||f.forEach(([A,q])=>{typeof q=="number"?v[A]=isNaN(q)?0:q:q==null?v[A]="":v[A]=q}),{export_data:v}}),error:null}}catch(u){return console.error("Error exporting data:",u),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,o,n=null){var c,h,u,d;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let m="";if(n)m+=(n==null?void 0:n.join(","))+`
`;else{const v=((c=r==null?void 0:r[0])==null?void 0:c.export_data)||(r==null?void 0:r[0]);v&&(m+=((h=Object==null?void 0:Object.keys(v))==null?void 0:h.join(","))+`
`)}r==null||r.forEach(v=>{var q;const f=(v==null?void 0:v.export_data)||v,A=(q=Object==null?void 0:Object.values(f))==null?void 0:q.map(x=>{if(x==null)return"";if(typeof x=="number"&&isNaN(x))return"0";let C=as(x);return C!=null&&C.includes(",")||C!=null&&C.includes('"')?`"${C==null?void 0:C.replace(/"/g,'""')}"`:C});m+=(A==null?void 0:A.join(","))+`
`});const j=new Blob([m],{type:"text/csv;charset=utf-8;"}),b=document.createElement("a");if((b==null?void 0:b.download)!==void 0){const v=URL==null?void 0:URL.createObjectURL(j);b==null||b.setAttribute("href",v),b==null||b.setAttribute("download",o),b.style.visibility="hidden",(u=document.body)==null||u.appendChild(b),b==null||b.click(),(d=document.body)==null||d.removeChild(b),URL==null||URL.revokeObjectURL(v)}return{success:!0,error:null}}catch(m){return console.error("Export to CSV error:",m),{success:!1,error:{message:(m==null?void 0:m.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,o){var n,c,h,u,d;try{const m=await((c=(n=J)==null?void 0:n.auth)==null?void 0:c.getUser()),{data:j,error:b}=await((d=J)==null?void 0:d.rpc("bulk_update_jobs",{job_ids:r,updates:o,performed_by:(u=(h=m==null?void 0:m.data)==null?void 0:h.user)==null?void 0:u.id}));return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:(j==null?void 0:j[0])||null,error:null}}catch(m){return console.error("Error in bulk update jobs:",m),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,o,n,c,h,u,d;try{const m=await((o=(r=J)==null?void 0:r.auth)==null?void 0:o.getUser()),{data:j,error:b}=await((d=(c=(n=J)==null?void 0:n.from("notification_preferences"))==null?void 0:c.select("*"))==null?void 0:d.eq("user_id",(u=(h=m==null?void 0:m.data)==null?void 0:h.user)==null?void 0:u.id));return b?{data:[],error:{message:b==null?void 0:b.message}}:{data:j||[],error:null}}catch(m){return console.error("Error fetching notification preferences:",m),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var o,n,c,h,u,d,m,j,b,v;try{const f=await((n=(o=J)==null?void 0:o.auth)==null?void 0:n.getUser());await((m=(h=(c=J)==null?void 0:c.from("notification_preferences"))==null?void 0:h.delete())==null?void 0:m.eq("user_id",(d=(u=f==null?void 0:f.data)==null?void 0:u.user)==null?void 0:d.id));const A=r==null?void 0:r.map(C=>{var R,F;return{...C,user_id:(F=(R=f==null?void 0:f.data)==null?void 0:R.user)==null?void 0:F.id}}),{data:q,error:x}=await((v=(b=(j=J)==null?void 0:j.from("notification_preferences"))==null?void 0:b.insert(A))==null?void 0:v.select());return x?{data:null,error:{message:x==null?void 0:x.message}}:{data:q,error:null}}catch(f){return console.error("Error updating notification preferences:",f),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var o,n,c;try{return(c=(n=(o=J)==null?void 0:o.channel("overdue-jobs"))==null?void 0:n.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},u=>{var d;(d=this.getOverdueJobs())==null||d.then(m=>{m!=null&&m.data&&r(m==null?void 0:m.data)})}))==null?void 0:c.subscribe()}catch(h){return console.error("Error subscribing to overdue jobs:",h),null}},async searchWithFilters(r,o,n){var c,h,u;try{let d=(c=J)==null?void 0:c.from(n);if(r)switch(n){case"jobs":d=d==null?void 0:d.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":d=d==null?void 0:d.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":d=d==null?void 0:d.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(h=Object==null?void 0:Object.entries(o))==null||h.forEach(([b,v])=>{v!=null&&v!==""&&(Array!=null&&Array.isArray(v)?d=d==null?void 0:d.in(b,v):typeof v=="object"&&(v==null?void 0:v.min)!==void 0?d=d==null?void 0:d.gte(b,v==null?void 0:v.min):typeof v=="object"&&(v==null?void 0:v.max)!==void 0?d=d==null?void 0:d.lte(b,v==null?void 0:v.max):d=d==null?void 0:d.eq(b,v))});const{data:m,error:j}=await((u=d==null?void 0:d.select("*"))==null?void 0:u.order("created_at",{ascending:!1}));return j?{data:[],error:{message:j==null?void 0:j.message}}:{data:m||[],error:null}}catch(d){return console.error("Error in search with filters:",d),{data:[],error:{message:"Failed to search with filters"}}}}},ls=({exportType:r,filters:o={},selectedIds:n=[],onExportStart:c,onExportComplete:h,onExportError:u,disabled:d=!1,variant:m="outline",size:j="sm",className:b=""})=>{var L;const[v,f]=E.useState(!1),[A,q]=E.useState(!1),[x,C]=E.useState("csv"),[R,F]=E.useState("filtered"),{user:t,userProfile:se}=Ce(),p=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],G=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(n==null?void 0:n.length)>0?[{value:"selected",label:`Selected (${n==null?void 0:n.length})`}]:[]],M=()=>{var U,de,ae;const V=(ae=(de=(U=new Date)==null?void 0:U.toISOString())==null?void 0:de.split("T"))==null?void 0:ae[0];return`${r}-${R==="selected"?"selected":R}-${V}.${x}`},D=async()=>{var V,y,U,de;if(!v)try{f(!0),c&&c();let ae={...o};R==="selected"&&(n==null?void 0:n.length)>0&&(ae.ids=n),R==="all"&&(ae={});const X=await(pe==null?void 0:pe.exportData(r,ae,(se==null?void 0:se.role)||"staff"));if(X!=null&&X.error)throw new Error((V=X==null?void 0:X.error)==null?void 0:V.message);if(!(X!=null&&X.data)||((y=X==null?void 0:X.data)==null?void 0:y.length)===0)throw new Error("No data found to export");const xe=M(),P=await(pe==null?void 0:pe.exportToCSV(X==null?void 0:X.data,xe));if(P!=null&&P.error)throw new Error((U=P==null?void 0:P.error)==null?void 0:U.message);q(!1),h&&h((de=X==null?void 0:X.data)==null?void 0:de.length,xe)}catch(ae){console.error("Export error:",ae),u&&u((ae==null?void 0:ae.message)||"Export failed")}finally{f(!1)}},N=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(B,{variant:m,size:j,onClick:()=>q(!A),disabled:d||v,iconName:v?void 0:"Download",iconPosition:"left",className:`${b} ${v?"cursor-wait":""}`,"aria-label":`Export ${N()}`,children:v?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${N()}`}),A&&!v&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Se,{value:x,onChange:C,options:p,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Se,{value:R,onChange:F,options:G,className:"w-full"})]}),R==="filtered"&&((L=Object==null?void 0:Object.keys(o))==null?void 0:L.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Te,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),R==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Te,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",n==null?void 0:n.length," selected record",(n==null?void 0:n.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(B,{variant:"ghost",size:"sm",onClick:()=>q(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(B,{size:"sm",onClick:D,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${N()}`,children:"Export"})]})]})})]})},Me={async getVehicles(r={},o=null){var n,c,h,u;try{let d=(h=(c=(n=J)==null?void 0:n.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:h.order("created_at",{ascending:!1});return o&&(d=d==null?void 0:d.eq("org_id",o)),r!=null&&r.status&&(d=d==null?void 0:d.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(d=d==null?void 0:d.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(d=d==null?void 0:d.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(d=d==null?void 0:d.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await ye(d,"vehicles:getVehicles")||[],error:null}}catch(d){return(u=d==null?void 0:d.message)!=null&&u.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,o=null){var n,c,h,u,d;try{let m=(u=(h=(c=(n=J)==null?void 0:n.from("vehicles"))==null?void 0:c.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:h.eq("id",r))==null?void 0:u.single();return o&&(m=m==null?void 0:m.eq("org_id",o)),{data:await ye(m,"vehicles:getVehicleById"),error:null}}catch(m){return(d=m==null?void 0:m.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var o,n,c,h,u,d,m,j,b,v;try{const{data:f,error:A}=await((b=(j=(m=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:m.insert([{...r,created_by:(d=(u=(h=await((c=(n=J)==null?void 0:n.auth)==null?void 0:c.getUser()))==null?void 0:h.data)==null?void 0:u.user)==null?void 0:d.id}]))==null?void 0:j.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:b.single());return A?{data:null,error:{message:A==null?void 0:A.message}}:{data:f,error:null}}catch(f){return(v=f==null?void 0:f.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var o,n,c,h;try{const{data:u,error:d}=await((h=(c=(n=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:n.insert([r]))==null?void 0:c.select())==null?void 0:h.single());if(d)throw console.error("Vehicle creation error:",d),new Error(d.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",u),u}catch(u){throw console.error("Error in vehicleService.create:",u),u}},async createVehicleWithProducts(r){var o,n;try{console.log("Creating vehicle with products:",r);const c=`vehicle_${Date.now()}`;await new Promise(u=>setTimeout(u,1e3));const h={id:c,...r,created_at:(o=new Date)==null?void 0:o.toISOString(),initial_products_count:((n=r==null?void 0:r.initial_products)==null?void 0:n.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",h),h}catch(c){throw console.error("Error creating vehicle with products:",c),c}},async checkStockNumberExists(r){var o,n,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:u,error:d}=await((h=(c=(n=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:n.select("id"))==null?void 0:c.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return d?(console.error("Stock number check error:",d),!1):!!u}catch(u){return console.error("Error checking stock number:",u),!1}},async checkVinExists(r){var o,n,c,h;if(!(r!=null&&r.trim()))return!1;try{const{data:u,error:d}=await((h=(c=(n=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:n.select("id"))==null?void 0:c.eq("vin",r==null?void 0:r.trim()))==null?void 0:h.maybeSingle());return d?(console.error("VIN check error:",d),!1):!!u}catch(u){return console.error("Error checking VIN:",u),!1}},async updateVehicle(r,o){var n,c,h,u,d,m,j;try{const{data:b,error:v}=await((m=(d=(u=(h=(n=J)==null?void 0:n.from("vehicles"))==null?void 0:h.update({...o,updated_at:(c=new Date)==null?void 0:c.toISOString()}))==null?void 0:u.eq("id",r))==null?void 0:d.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:m.single());return v?{data:null,error:{message:v==null?void 0:v.message}}:{data:b,error:null}}catch(b){return(j=b==null?void 0:b.message)!=null&&j.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var o,n,c,h;try{const{error:u}=await((c=(n=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:n.delete())==null?void 0:c.eq("id",r));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return(h=u==null?void 0:u.message)!=null&&h.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var o,n,c,h,u,d,m;try{let j=(n=(o=J)==null?void 0:o.from("vehicles"))==null?void 0:n.select("vehicle_status");r&&(j=j==null?void 0:j.eq("org_id",r));const b=await ye(j,"vehicles:getVehicleStats");return{data:{total:(b==null?void 0:b.length)||0,active:((c=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="active"))==null?void 0:c.length)||0,maintenance:((h=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="maintenance"))==null?void 0:h.length)||0,retired:((u=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="retired"))==null?void 0:u.length)||0,sold:((d=b==null?void 0:b.filter(f=>(f==null?void 0:f.vehicle_status)==="sold"))==null?void 0:d.length)||0},error:null}}catch(j){return(m=j==null?void 0:j.message)!=null&&m.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function ns({isOpen:r,onClose:o,onSuccess:n}){var g,O,W;const{user:c}=Ce(),{orgId:h}=Be()||{},[u,d]=E.useState(1),[m,j]=E.useState(!1),[b,v]=E.useState(""),[f,A]=E.useState(!1),[q,x]=E.useState(!1),[C,R]=E.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),F={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(g=new Date)==null?void 0:g.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[t,se]=E.useState(F),[p,G]=E.useState([]),M=async(l=0)=>{var S,$;try{R(i=>({...i,loading:!0,error:null,retryCount:l}));const[K,Z,ee,ne,a]=await Promise.all([ze().catch(()=>[]),Ae().catch(()=>[]),qe().catch(()=>[]),Re({activeOnly:!0}).catch(()=>[]),Ve({activeOnly:!0}).catch(()=>[])]);R({salesConsultants:K,deliveryCoordinators:Z,financeManagers:ee,vendors:ne,products:a==null?void 0:a.map(i=>({...i,unitPrice:i==null?void 0:i.unit_price})),loading:!1,error:null,retryCount:l})}catch(K){if(console.error("Failed to load dropdown data:",K),l<2&&((S=K==null?void 0:K.message)!=null&&S.includes("fetch")||($=K==null?void 0:K.message)!=null&&$.includes("network"))){setTimeout(()=>M(l+1),1e3*(l+1));return}R(Z=>({...Z,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:l}))}},D=({checked:l,onChange:S})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!l,onChange:$=>{var Z;const K=!!((Z=$==null?void 0:$.target)!=null&&Z.checked);S(K)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),N=({label:l,options:S,value:$,onChange:K,placeholder:Z,required:ee=!1,helpText:ne})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l," ",ee&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:$||"",onChange:a=>{var i;return K(((i=a==null?void 0:a.target)==null?void 0:i.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:C==null?void 0:C.loading,required:ee,children:[e.jsx("option",{value:"",children:Z}),S==null?void 0:S.map(a=>e.jsx("option",{value:a==null?void 0:a.id,children:(a==null?void 0:a.full_name)||(a==null?void 0:a.label)||(a==null?void 0:a.name)},a==null?void 0:a.id))]}),ne&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:ne}),(S==null?void 0:S.length)===0&&!(C!=null&&C.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-red-500",children:["No ",l==null?void 0:l.toLowerCase()," found. Please check your database connection."]})]});E.useEffect(()=>{const l=(t==null?void 0:t.customerName)!==(F==null?void 0:F.customerName)||(t==null?void 0:t.customerPhone)!==(F==null?void 0:F.customerPhone)||(t==null?void 0:t.customerEmail)!==(F==null?void 0:F.customerEmail)||(t==null?void 0:t.needsLoaner)!==(F==null?void 0:F.needsLoaner)||(t==null?void 0:t.assignedTo)!==(F==null?void 0:F.assignedTo)||(t==null?void 0:t.deliveryCoordinator)!==(F==null?void 0:F.deliveryCoordinator)||(t==null?void 0:t.financeManager)!==(F==null?void 0:F.financeManager)||(p==null?void 0:p.length)>0;A(l)},[t,p]),E.useEffect(()=>{r&&M()},[r]);const L=()=>{G(l=>[...l,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},V=(l,S,$)=>{var K;if(G(Z=>Z==null?void 0:Z.map(ee=>{if((ee==null?void 0:ee.id)===l){let ne={...ee,[S]:$};return S==="requiresScheduling"&&($===!0?ne.noScheduleReason="":ne.promisedDate=""),ne}return ee})),S==="productId"&&$){const Z=(K=C==null?void 0:C.products)==null?void 0:K.find(ee=>(ee==null?void 0:ee.id)===$);Z&&G(ee=>ee==null?void 0:ee.map(ne=>(ne==null?void 0:ne.id)===l?{...ne,unitPrice:(Z==null?void 0:Z.unitPrice)||""}:ne))}},y=l=>{G(S=>S==null?void 0:S.filter($=>($==null?void 0:$.id)!==l))},U=()=>{var l,S;return((S=(l=t==null?void 0:t.customerName)==null?void 0:l.trim())==null?void 0:S.length)>0},de=()=>(p==null?void 0:p.length)===0?!1:p==null?void 0:p.every(l=>{var S;return!(!(l!=null&&l.productId)||!(l!=null&&l.unitPrice)||l!=null&&l.requiresScheduling&&!(l!=null&&l.promisedDate)||!(l!=null&&l.requiresScheduling)&&!((S=l==null?void 0:l.noScheduleReason)!=null&&S.trim())||(l==null?void 0:l.serviceType)==="vendor"&&!(l!=null&&l.vendorId))}),ae=()=>p==null?void 0:p.reduce((l,S)=>l+(parseFloat(S==null?void 0:S.unitPrice)||0),0),X=async()=>{var l,S,$,K,Z,ee,ne,a,i,_;if(!U()){v("Customer name is required to save draft");return}j(!0),v("");try{const z={year:(t==null?void 0:t.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(t==null?void 0:t.vehicleMake)||"TBD",model:(t==null?void 0:t.vehicleModel)||"TBD",owner_name:(S=t==null?void 0:t.customerName)==null?void 0:S.trim(),owner_phone:(($=t==null?void 0:t.customerPhone)==null?void 0:$.trim())||null,owner_email:((K=t==null?void 0:t.customerEmail)==null?void 0:K.trim())||null,stock_number:((Z=t==null?void 0:t.stockNumber)==null?void 0:Z.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},re=await Me.create(z),Q={title:`Draft Deal - ${(ee=t==null?void 0:t.customerName)==null?void 0:ee.trim()}`,description:`Draft deal for ${(ne=t==null?void 0:t.customerName)==null?void 0:ne.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:re==null?void 0:re.id,assigned_to:(t==null?void 0:t.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(t==null?void 0:t.deliveryCoordinator)||null,finance_manager_id:(t==null?void 0:t.financeManager)||null,customer_needs_loaner:!!(t!=null&&t.needsLoaner),customerName:(a=t==null?void 0:t.customerName)==null?void 0:a.trim(),customerPhone:((i=t==null?void 0:t.customerPhone)==null?void 0:i.trim())||"",customerEmail:((_=t==null?void 0:t.customerEmail)==null?void 0:_.trim())||"",org_id:h||void 0,lineItems:[]};await Ee.createDeal(Q),n==null||n(),P(),o()}catch(z){v(`Failed to save draft: ${z==null?void 0:z.message}`)}finally{j(!1)}},xe=async()=>{var l,S,$,K,Z,ee,ne,a,i,_,z,re;if(!U()||!de()){v("Please complete all required fields");return}j(!0),v("");try{const Q={year:(t==null?void 0:t.vehicleYear)||((l=new Date)==null?void 0:l.getFullYear()),make:(t==null?void 0:t.vehicleMake)||"TBD",model:(t==null?void 0:t.vehicleModel)||"TBD",owner_name:(S=t==null?void 0:t.customerName)==null?void 0:S.trim(),owner_phone:(($=t==null?void 0:t.customerPhone)==null?void 0:$.trim())||null,owner_email:((K=t==null?void 0:t.customerEmail)==null?void 0:K.trim())||null,stock_number:((Z=t==null?void 0:t.stockNumber)==null?void 0:Z.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},T=await Me.create(Q),I=ae(),je=(p==null?void 0:p.some(k=>(k==null?void 0:k.serviceType)==="vendor"))?"vendor":"in_house",Ne=((ee=p==null?void 0:p.find(k=>k==null?void 0:k.vendorId))==null?void 0:ee.vendorId)||null;let s=null;if(je==="vendor"){const k=(p||[]).filter(ce=>(ce==null?void 0:ce.serviceType)==="vendor"&&(ce==null?void 0:ce.requiresScheduling)&&(ce==null?void 0:ce.promisedDate)).map(ce=>new Date(ce==null?void 0:ce.promisedDate)).sort((ce,ge)=>ce-ge);s=(ne=(k==null?void 0:k[0])||new Date)==null?void 0:ne.toISOString()}const w=(p||[]).map(k=>({product_id:k==null?void 0:k.productId,quantity_used:1,unit_price:parseFloat((k==null?void 0:k.unitPrice)||0),promised_date:k!=null&&k.requiresScheduling?k==null?void 0:k.promisedDate:null,requires_scheduling:!!(k!=null&&k.requiresScheduling),no_schedule_reason:k!=null&&k.requiresScheduling?null:k==null?void 0:k.noScheduleReason,is_off_site:(k==null?void 0:k.serviceType)==="vendor"})),te={title:`Deal - ${(a=t==null?void 0:t.customerName)==null?void 0:a.trim()}`,description:`Deal for ${(i=t==null?void 0:t.customerName)==null?void 0:i.trim()}`,job_status:"pending",service_type:je,vehicle_id:T==null?void 0:T.id,vendor_id:Ne,assigned_to:(t==null?void 0:t.assignedTo)||(c==null?void 0:c.id),delivery_coordinator_id:(t==null?void 0:t.deliveryCoordinator)||null,finance_manager_id:(t==null?void 0:t.financeManager)||null,customer_needs_loaner:!!(t!=null&&t.needsLoaner),scheduled_start_time:s,estimated_cost:I,org_id:h||void 0,customerName:(_=t==null?void 0:t.customerName)==null?void 0:_.trim(),customerPhone:((z=t==null?void 0:t.customerPhone)==null?void 0:z.trim())||"",customerEmail:((re=t==null?void 0:t.customerEmail)==null?void 0:re.trim())||"",lineItems:w},Y=await Ee.createDeal(te);await Ee.updateDeal(Y==null?void 0:Y.id,te),n==null||n(),P(),o()}catch(Q){v(`Failed to create deal: ${Q==null?void 0:Q.message}`)}finally{j(!1)}},P=()=>{d(1),se(F),G([]),v(""),A(!1)},ie=()=>{f?x(!0):(P(),o())},ue=()=>{x(!1),P(),o()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:u===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:ie,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(H,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${u>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${u>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${u>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${u>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[b&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",b]}),e.jsx("button",{onClick:()=>v(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(H,{name:"X",size:16})})]})}),(C==null?void 0:C.loading)&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(H,{name:"Loader",size:16,className:"mr-2 animate-spin"}),"Loading dropdown data..."]})}),(C==null?void 0:C.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",C==null?void 0:C.error]}),e.jsx("button",{onClick:()=>M(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),u===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t==null?void 0:t.customerName,onChange:l=>se(S=>{var $;return{...S,customerName:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:t==null?void 0:t.customerPhone,onChange:l=>se(S=>{var $;return{...S,customerPhone:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:t==null?void 0:t.customerEmail,onChange:l=>se(S=>{var $;return{...S,customerEmail:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(t==null?void 0:t.vehicleYear)||"",onChange:l=>se(S=>{var $;return{...S,vehicleYear:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((O=new Date)==null?void 0:O.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.vehicleMake)||"",onChange:l=>se(S=>{var $;return{...S,vehicleMake:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.vehicleModel)||"",onChange:l=>se(S=>{var $;return{...S,vehicleModel:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(t==null?void 0:t.stockNumber)||"",onChange:l=>se(S=>{var $;return{...S,stockNumber:($=l==null?void 0:l.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(D,{checked:t==null?void 0:t.needsLoaner,onChange:l=>{se(S=>({...S,needsLoaner:!!l}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(N,{label:"Sales Consultant",options:C==null?void 0:C.salesConsultants,value:t==null?void 0:t.assignedTo,onChange:l=>se(S=>({...S,assignedTo:l})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal"}),e.jsx(N,{label:"Delivery Coordinator",options:C==null?void 0:C.deliveryCoordinators,value:t==null?void 0:t.deliveryCoordinator,onChange:l=>se(S=>({...S,deliveryCoordinator:l})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal"}),e.jsx(N,{label:"Finance Manager",options:C==null?void 0:C.financeManagers,value:t==null?void 0:t.financeManager,onChange:l=>se(S=>({...S,financeManager:l})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal"})]})]})]}),u===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(B,{onClick:L,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(H,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(p==null?void 0:p.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(H,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[p==null?void 0:p.map((l,S)=>{var $,K,Z,ee,ne;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",S+1]}),e.jsx("button",{onClick:()=>y(l==null?void 0:l.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.productId)||"",onChange:a=>{var i;return V(l==null?void 0:l.id,"productId",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select product"}),($=C==null?void 0:C.products)==null?void 0:$.map(a=>e.jsx("option",{value:a==null?void 0:a.id,children:a==null?void 0:a.label},a==null?void 0:a.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:l==null?void 0:l.unitPrice,onChange:a=>{var i;return V(l==null?void 0:l.id,"unitPrice",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"in_house",checked:(l==null?void 0:l.serviceType)==="in_house",onChange:a=>{var i;return V(l==null?void 0:l.id,"serviceType",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${l==null?void 0:l.id}`,value:"vendor",checked:(l==null?void 0:l.serviceType)==="vendor",onChange:a=>{var i;return V(l==null?void 0:l.id,"serviceType",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(l==null?void 0:l.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(l==null?void 0:l.vendorId)||"",onChange:a=>{var i;return V(l==null?void 0:l.id,"vendorId",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(K=C==null?void 0:C.vendors)==null?void 0:K.map(a=>e.jsx("option",{value:a==null?void 0:a.id,children:a==null?void 0:a.label},a==null?void 0:a.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!0,onChange:()=>V(l==null?void 0:l.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer"}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${l==null?void 0:l.id}`,checked:(l==null?void 0:l.requiresScheduling)===!1,onChange:()=>V(l==null?void 0:l.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer"}),"No Scheduling Needed"]})]}),l!=null&&l.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:l==null?void 0:l.promisedDate,onChange:a=>{var i;return V(l==null?void 0:l.id,"promisedDate",(i=a==null?void 0:a.target)==null?void 0:i.value)},min:(ne=(ee=(Z=new Date)==null?void 0:Z.toISOString())==null?void 0:ee.split("T"))==null?void 0:ne[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:l==null?void 0:l.noScheduleReason,onChange:a=>{var i;return V(l==null?void 0:l.id,"noScheduleReason",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:l==null?void 0:l.serviceNotes,onChange:a=>{var i;return V(l==null?void 0:l.id,"serviceNotes",(i=a==null?void 0:a.target)==null?void 0:i.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},l==null?void 0:l.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(W=ae())==null?void 0:W.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[p==null?void 0:p.length," item",(p==null?void 0:p.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:u===2&&e.jsx(B,{onClick:()=>d(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(B,{onClick:ie,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),u===1&&e.jsxs(e.Fragment,{children:[e.jsx(B,{onClick:X,disabled:!U()||m,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:m?"Saving...":"Save Draft"}),e.jsx(B,{onClick:()=>d(2),disabled:!U(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),u===2&&e.jsx(B,{onClick:xe,disabled:!U()||!de()||m,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:m?"Creating...":"Create Deal"})]})]})}),q&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(B,{variant:"outline",onClick:()=>x(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(B,{onClick:ue,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function ts(r,{activeOnly:o=!0}={}){let n=J.from("products").select("*").order("name",{ascending:!0});o&&(n=n.eq("is_active",!0)),r&&(n=n.or(`org_id.eq.${r},org_id.is.null`));const c=await ye(n,"products:listByOrg");return De(c,{labelKey:"name",valueKey:"id"})}function cs(r,{activeOnly:o=!0}={}){let n=J.from("user_profiles").select("*").order("full_name",{ascending:!0});return o&&(n=n.eq("is_active",!0)),r&&(n=n.eq("org_id",r)),ye(n,"staff:listByOrg")}function Ue(r={}){var R,F,t,se;const{loadOnMount:o=!0,cacheTime:n=5*60*1e3}=r,[c,h]=E.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[u,d]=E.useState(null),m=Be(),j=Ce(),b=async()=>{var p,G,M,D;try{if(h(P=>({...P,loading:!0,error:null})),m.loading){h(P=>({...P,loading:!0}));return}if(!((p=m.session)!=null&&p.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),h(P=>({...P,loading:!1}));return}const N=!!m.orgId,L=[(G=Ae())==null?void 0:G.catch(P=>(console.error("[dropdowns:dc] Delivery coordinators failed:",P),[])),(M=ze())==null?void 0:M.catch(P=>(console.error("[dropdowns:sales] Sales consultants failed:",P),[])),(D=qe())==null?void 0:D.catch(P=>(console.error("[dropdowns:finance] Finance managers failed:",P),[])),N?cs(m.orgId).catch(P=>(console.error("[dropdowns:users] tenant staff failed:",P),[])):Ye({activeOnly:!0}).catch(P=>(console.error("[dropdowns:users] global user profiles failed:",P),[])),N?es(m.orgId).catch(P=>(console.error("[dropdowns:vendors] tenant vendors failed:",P),[])):Re({activeOnly:!0}).catch(P=>(console.error("[dropdowns:vendors] global vendors failed:",P),[])),N?ts(m.orgId).catch(P=>(console.error("[dropdowns:products] tenant products failed:",P),[])):Ve({activeOnly:!0}).catch(P=>(console.error("[dropdowns:products] global products failed:",P),[])),N?ss(m.orgId).catch(P=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",P),[])):Promise.resolve([])],[V,y,U,de,ae,X,xe]=await Promise.all(L);h({dc:V,sales:y,finance:U,users:de,vendors:ae,products:X,smsTemplates:xe,loading:!1,error:null,searchResults:null}),d(Date.now())}catch(N){h({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(N==null?void 0:N.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",N)}},v=()=>u?Date.now()-u<n:!1,f=async()=>{v()||await b()},A=async p=>{try{if(!(p!=null&&p.trim())){h(M=>({...M,searchResults:null}));return}const G=await Je(p);h(M=>({...M,searchResults:G}))}catch(G){console.error("[dropdowns:search] Search failed:",G),h(M=>({...M,searchResults:{users:[],vendors:[]}}))}},q=()=>{h(p=>({...p,searchResults:null}))},x=(p={})=>{const{roles:G=[],departments:M=[],activeOnly:D=!0}=p;let N=(c==null?void 0:c.users)||[];return D&&(N=N==null?void 0:N.filter(L=>L==null?void 0:L.is_active)),(G==null?void 0:G.length)>0&&(N=N==null?void 0:N.filter(L=>G==null?void 0:G.includes(L==null?void 0:L.role))),(M==null?void 0:M.length)>0&&(N=N==null?void 0:N.filter(L=>M==null?void 0:M.includes(L==null?void 0:L.department))),(N==null?void 0:N.map(L=>({id:L==null?void 0:L.id,value:L==null?void 0:L.id,label:L==null?void 0:L.full_name,name:L==null?void 0:L.full_name,role:L==null?void 0:L.role,department:L==null?void 0:L.department,email:L==null?void 0:L.email})))||[]},C=(p={})=>{const{activeOnly:G=!0,specialty:M=null}=p;let D=(c==null?void 0:c.vendors)||[];return G&&(D=D==null?void 0:D.filter(N=>N==null?void 0:N.is_active)),M&&(D=D==null?void 0:D.filter(N=>{var L,V;return(V=(L=N==null?void 0:N.specialty)==null?void 0:L.toLowerCase())==null?void 0:V.includes(M==null?void 0:M.toLowerCase())})),(D==null?void 0:D.map(N=>({id:N==null?void 0:N.id,value:(N==null?void 0:N.value)||(N==null?void 0:N.id),label:(N==null?void 0:N.label)||(N==null?void 0:N.name),name:N==null?void 0:N.name,specialty:N==null?void 0:N.specialty,email:N==null?void 0:N.email,phone:N==null?void 0:N.phone})))||[]};return E.useEffect(()=>{let p=!0;return(async()=>{var M;if(!o)return;const G=Date.now();for(;p&&(j!=null&&j.loading)&&Date.now()-G<5e3;)await new Promise(D=>setTimeout(D,200));p&&(j!=null&&j.user?(console.log("Dropdowns: authenticated user",(M=j==null?void 0:j.user)==null?void 0:M.id),j!=null&&j.userProfile&&console.log("Dropdowns: user profile org",j.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),p&&await b())})(),()=>{p=!1}},[o,j==null?void 0:j.loading,(R=j==null?void 0:j.user)==null?void 0:R.id,m==null?void 0:m.loading,m==null?void 0:m.orgId]),{dc:c==null?void 0:c.dc,sales:c==null?void 0:c.sales,finance:c==null?void 0:c.finance,users:c==null?void 0:c.users,vendors:c==null?void 0:c.vendors,products:c==null?void 0:c.products,smsTemplates:c==null?void 0:c.smsTemplates,loading:c==null?void 0:c.loading,error:c==null?void 0:c.error,searchResults:c==null?void 0:c.searchResults,globalSearch:A,clearSearch:q,getUserOptions:x,getVendorOptions:C,refresh:b,refreshIfNeeded:f,lastUpdate:u,isCacheValid:v(),salesConsultantOptions:(F=(c==null?void 0:c.sales)||[])==null?void 0:F.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),deliveryCoordinatorOptions:(t=(c==null?void 0:c.dc)||[])==null?void 0:t.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name})),financeManagerOptions:(se=(c==null?void 0:c.finance)||[])==null?void 0:se.map(p=>({id:p==null?void 0:p.id,value:p==null?void 0:p.id,label:p==null?void 0:p.full_name,name:p==null?void 0:p.full_name}))}}const is=()=>{var j,b,v;const{dc:r,sales:o,finance:n,vendors:c,products:h,loading:u,error:d,refresh:m}=Ue({loadOnMount:!0});return{salesConsultants:o,deliveryCoordinators:r,financeManagers:n,vendors:c,products:h,loading:u,error:d,refresh:m,salesConsultantOptions:(j=o||[])==null?void 0:j.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),deliveryCoordinatorOptions:(b=r||[])==null?void 0:b.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),financeManagerOptions:(v=n||[])==null?void 0:v.map(f=>({id:f==null?void 0:f.id,value:f==null?void 0:f.id,label:f==null?void 0:f.full_name,name:f==null?void 0:f.full_name})),vendorOptions:c||[],productOptions:h||[]}},os=()=>(Ke.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),ve=({options:r=[],value:o,onChange:n,placeholder:c="Select...",searchable:h=!1,clearable:u=!1,disabled:d=!1,loading:m=!1,error:j=null,className:b="",optionLabel:v="label",optionValue:f="value",groupBy:A=null,renderOption:q=null,label:x="",helperText:C=""})=>{const[R,F]=E.useState(!1),[t,se]=E.useState(""),[p,G]=E.useState(!1),[M,D]=E.useState(r),[N,L]=E.useState(-1),[V,y]=E.useState({top:0,left:0,width:0}),U=E.useRef(null),de=E.useRef(null);E.useRef(null),E.useEffect(()=>{G((()=>{var l;return(l=window.matchMedia("(max-width: 767px)"))==null?void 0:l.matches})());const O=window.matchMedia("(max-width: 767px)"),W=()=>G(O==null?void 0:O.matches);return O==null||O.addEventListener("change",W),()=>O==null?void 0:O.removeEventListener("change",W)},[]),E.useEffect(()=>{if(!(t!=null&&t.trim())){D(r);return}const g=t==null?void 0:t.toLowerCase(),O=r==null?void 0:r.filter(W=>{const l=[W==null?void 0:W.name,W==null?void 0:W.displayName,W==null?void 0:W.category,W==null?void 0:W.brand,W==null?void 0:W.specialty,W==null?void 0:W.department,W==null?void 0:W.email].filter(Boolean);return l==null?void 0:l.some(S=>{var $;return($=S==null?void 0:S.toLowerCase())==null?void 0:$.includes(g)})});D(O),L(-1)},[t,r]);const ae=r==null?void 0:r.find(g=>(g==null?void 0:g.id)===o),X=g=>((g==null?void 0:g[f])||(g==null?void 0:g.id))===o,xe=()=>{var g;if(U!=null&&U.current){const O=(g=U==null?void 0:U.current)==null?void 0:g.getBoundingClientRect();y({top:(O==null?void 0:O.bottom)+window.scrollY,left:(O==null?void 0:O.left)+window.scrollX,width:O==null?void 0:O.width})}};E.useEffect(()=>{R&&!p&&xe()},[R,p]),E.useEffect(()=>{if(p)return;const g=O=>{var W;U!=null&&U.current&&!((W=U==null?void 0:U.current)!=null&&W.contains(O==null?void 0:O.target))&&(F(!1),se(""),L(-1))};return document==null||document.addEventListener("mousedown",g),()=>document==null?void 0:document.removeEventListener("mousedown",g)},[p]);const P=g=>{if(!p){if(!R){((g==null?void 0:g.key)==="Enter"||(g==null?void 0:g.key)===" "||(g==null?void 0:g.key)==="ArrowDown")&&(g==null||g.preventDefault(),F(!0),h&&setTimeout(()=>{var O;return(O=de==null?void 0:de.current)==null?void 0:O.focus()},0));return}switch(g==null?void 0:g.key){case"Escape":F(!1),se(""),L(-1);break;case"ArrowDown":g==null||g.preventDefault(),L(O=>O<(M==null?void 0:M.length)-1?O+1:0);break;case"ArrowUp":g==null||g.preventDefault(),L(O=>O>0?O-1:(M==null?void 0:M.length)-1);break;case"Enter":g==null||g.preventDefault(),N>=0&&(M!=null&&M[N])&&ie(M==null?void 0:M[N]);break;case"Tab":F(!1),se(""),L(-1);break}}},ie=g=>{n==null||n(g==null?void 0:g.id),F(!1),se(""),L(-1)},ue=g=>{g==null||g.stopPropagation(),n==null||n(null)};return p?e.jsxs("div",{className:`relative ${b}`,children:[e.jsxs("select",{value:o||"",onChange:g=>{var O;return n==null?void 0:n(((O=g==null?void 0:g.target)==null?void 0:O.value)||null)},disabled:d||m,className:`
            w-full px-3 py-2 border rounded-lg
            ${j?"border-red-500":"border-gray-300"}
            ${d||m?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:c}),r==null?void 0:r.map(g=>e.jsx("option",{value:(g==null?void 0:g[f])||(g==null?void 0:g.id),children:(g==null?void 0:g[v])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[f])||(g==null?void 0:g.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(H,{name:"ChevronDown",size:16,className:"text-gray-400"})}),j&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:j})]}):e.jsxs("div",{className:`relative ${b}`,ref:U,children:[e.jsxs("button",{type:"button",onClick:()=>!d&&!m&&F(!R),onKeyDown:P,disabled:d||m,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${j?"border-red-500":"border-gray-300"}
          ${d||m?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${R?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:ae?"text-gray-900":"text-gray-500",children:ae?(ae==null?void 0:ae[v])||(ae==null?void 0:ae.label):c}),e.jsxs("div",{className:"flex items-center space-x-1",children:[m&&e.jsx(H,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),u&&ae&&!m&&e.jsx("button",{type:"button",onClick:ue,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(H,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(H,{name:R?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),R&&typeof window<"u"&&e.jsx(os,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>F(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${V==null?void 0:V.top}px`,left:`${V==null?void 0:V.left}px`,width:`${V==null?void 0:V.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:g=>g==null?void 0:g.stopPropagation(),children:[h&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:t,onChange:g=>{var O;return se((O=g==null?void 0:g.target)==null?void 0:O.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(M==null?void 0:M.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:t?"No results found":"No options available"}):M==null?void 0:M.map(g=>e.jsx("button",{type:"button",onClick:()=>ie(g),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${X(g)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(g==null?void 0:g[v])||(g==null?void 0:g.label)||(g==null?void 0:g.name)},(g==null?void 0:g[f])||(g==null?void 0:g.id)))})]})})}),j&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:j})]})},ds=({isOpen:r,dealId:o,onClose:n,onSuccess:c})=>{var Z,ee,ne;const[h,u]=E.useState(!0),[d,m]=E.useState(!1),[j,b]=E.useState(""),[v,f]=E.useState(!1),[A,q]=E.useState(!1),[x,C]=E.useState(!1),[R,F]=E.useState(!1),[t,se]=E.useState(null),{salesConsultants:p,deliveryCoordinators:G,financeManagers:M,vendors:D,products:N,loading:L,refresh:V}=is(),[y,U]=E.useState({title:"",customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,financeManager:null,lineItems:[]});E.useEffect(()=>{if(t){const a=JSON.stringify(y)!==JSON.stringify(t);C(a)}},[y,t]),E.useEffect(()=>{r&&!L&&V()},[r,V,L]),E.useEffect(()=>{r&&o&&xe()},[r,o]);const de=({checked:a,onChange:i})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",onClick:_=>_==null?void 0:_.stopPropagation(),children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!a,onChange:_=>{var z;_==null||_.stopPropagation(),i((z=_==null?void 0:_.target)==null?void 0:z.checked)},onClick:_=>_==null?void 0:_.stopPropagation(),className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),ae=({value:a,selectedValue:i,onChange:_,itemIndex:z,disabled:re=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${z}`,value:"in_house",checked:!i,onChange:()=>_(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:re}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${z}`,value:"vendor",checked:i,onChange:()=>_(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:re}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),X=({requiresScheduling:a,onChange:i,itemIndex:_,disabled:z=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${_}`,checked:a===!0,onChange:()=>i(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:z}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${_}`,checked:a===!1,onChange:()=>i(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:z}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),xe=async()=>{var a,i,_,z,re;try{u(!0),b("");const Q=await Xe(o),T=We(Q),{data:I}=await((z=(_=(i=(a=J)==null?void 0:a.from("transactions"))==null?void 0:i.select("customer_name, customer_phone, customer_email"))==null?void 0:_.eq("job_id",o))==null?void 0:z.single()),le={...T,customerName:(I==null?void 0:I.customer_name)||"",customerPhone:(I==null?void 0:I.customer_phone)||"",customerEmail:(I==null?void 0:I.customer_email)||"",lineItems:((re=(T==null?void 0:T.lineItems)||[])==null?void 0:re.length)>0?T==null?void 0:T.lineItems:[P()]};U(le),se(JSON.parse(JSON.stringify(le)))}catch(Q){b(`Failed to load deal: ${Q==null?void 0:Q.message}`)}finally{u(!1)}},P=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),ie=a=>{U(i=>({...i,...a}))},ue=(a,i)=>{if(U(_=>{var z;return{..._,lineItems:(z=_==null?void 0:_.lineItems)==null?void 0:z.map((re,Q)=>{if(Q===a){let T={...re,...i};return"requiresScheduling"in i&&(T.requiresScheduling=!!(i!=null&&i.requiresScheduling),(i==null?void 0:i.requiresScheduling)===!0?T.noScheduleReason="":T.lineItemPromisedDate=""),"isOffSite"in i&&(T.isOffSite=!!(i!=null&&i.isOffSite),i!=null&&i.isOffSite||(T.vendorId="")),T}return re})}}),i!=null&&i.product_id){const _=N==null?void 0:N.find(z=>(z==null?void 0:z.id)===(i==null?void 0:i.product_id));_&&U(z=>{var re;return{...z,lineItems:(re=z==null?void 0:z.lineItems)==null?void 0:re.map((Q,T)=>T===a?{...Q,unit_price:(_==null?void 0:_.unitPrice)||(_==null?void 0:_.unit_price)||(Q==null?void 0:Q.unit_price),cost_price:(_==null?void 0:_.cost)||(Q==null?void 0:Q.cost_price)}:Q)}})}},g=()=>{U(a=>({...a,lineItems:[...a==null?void 0:a.lineItems,P()]}))},O=a=>{U(i=>{var _;return{...i,lineItems:(_=i==null?void 0:i.lineItems)==null?void 0:_.filter((z,re)=>re!==a)}})},W=async()=>{var a,i,_,z,re,Q;try{if(m(!0),b(""),!((a=y==null?void 0:y.title)!=null&&a.trim())){b("Title is required");return}if(!((i=y==null?void 0:y.customerName)!=null&&i.trim())){b("Customer name is required");return}for(let I=0;I<((_=y==null?void 0:y.lineItems)==null?void 0:_.length);I++){const le=(z=y==null?void 0:y.lineItems)==null?void 0:z[I];if(!(le!=null&&le.product_id)){b(`Line item ${I+1}: Product is required`);return}if(le!=null&&le.requiresScheduling&&!(le!=null&&le.lineItemPromisedDate)){b(`Line item ${I+1}: Promised date is required when scheduling is needed`);return}if(!(le!=null&&le.requiresScheduling)&&!((re=le==null?void 0:le.noScheduleReason)!=null&&re.trim())){b(`Line item ${I+1}: Reason is required when no scheduling is needed`);return}if(le!=null&&le.isOffSite&&!(le!=null&&le.vendorId)){b(`Line item ${I+1}: Vendor is required for off-site service`);return}}const T={...y,customer_needs_loaner:!!(y!=null&&y.customer_needs_loaner),lineItems:(Q=y==null?void 0:y.lineItems)==null?void 0:Q.map(I=>({...I,requiresScheduling:!!(I!=null&&I.requiresScheduling),isOffSite:!!(I!=null&&I.isOffSite),unit_price:parseFloat(I==null?void 0:I.unit_price)||0,quantity_used:parseInt(I==null?void 0:I.quantity_used)||1}))};await He(o,T),c==null||c(),n==null||n()}catch(T){b(`Failed to save deal: ${T==null?void 0:T.message}`)}finally{m(!1)}},l=async()=>{try{q(!0),await Ge(o),c==null||c(),n==null||n()}catch(a){b(`Failed to delete deal: ${a==null?void 0:a.message}`)}finally{q(!1),f(!1)}},S=()=>{x?F(!0):n()},$=()=>{F(!1),n()},K=()=>{var a;return((a=y==null?void 0:y.lineItems)==null?void 0:a.reduce((i,_)=>{const z=parseFloat(_==null?void 0:_.unit_price)||0,re=parseInt(_==null?void 0:_.quantity_used)||1;return i+z*re},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:S,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(H,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[j&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:j})}),L&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-blue-800 text-sm",children:"Loading dropdown data..."})}),h?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-gray-600",children:"Loading deal..."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Deal Title *"}),e.jsx(he,{id:"deal-title","aria-label":"Deal title input",label:"",helperText:"",maxLength:255,style:{},value:y==null?void 0:y.title,onChange:a=>{var i;return ie({title:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Enter deal title"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Se,{value:y==null?void 0:y.job_status,onChange:a=>{var i;return ie({job_status:(i=a==null?void 0:a.target)==null?void 0:i.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(he,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:y==null?void 0:y.customerName,onChange:a=>{var i;return ie({customerName:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(he,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:y==null?void 0:y.customerPhone,onChange:a=>{var i;return ie({customerPhone:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(he,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:y==null?void 0:y.customerEmail,onChange:a=>{var i;return ie({customerEmail:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Se,{value:y==null?void 0:y.priority,onChange:a=>{var i;return ie({priority:(i=a==null?void 0:a.target)==null?void 0:i.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(he,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(y==null?void 0:y.vehicleYear)||"",onChange:a=>{var i;return ie({vehicleYear:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"2024",min:"1900",max:((Z=new Date)==null?void 0:Z.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(he,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(y==null?void 0:y.vehicleMake)||"",onChange:a=>{var i;return ie({vehicleMake:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(he,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(y==null?void 0:y.vehicleModel)||"",onChange:a=>{var i;return ie({vehicleModel:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(he,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(y==null?void 0:y.stockNumber)||"",onChange:a=>{var i;return ie({stockNumber:(i=a==null?void 0:a.target)==null?void 0:i.value})},placeholder:"Enter stock number"})]})]}),e.jsx(de,{checked:y==null?void 0:y.customer_needs_loaner,onChange:a=>ie({customer_needs_loaner:a})}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsx("div",{className:"mb-4",children:e.jsx(ve,{label:"Sales Consultant",options:p,value:y==null?void 0:y.assignedTo,onChange:a=>ie({assignedTo:a}),placeholder:"Select sales consultant",searchable:!0,clearable:!0})}),e.jsx("div",{className:"mb-4",children:e.jsx(ve,{label:"Delivery Coordinator",options:G,value:y==null?void 0:y.deliveryCoordinator,onChange:a=>ie({deliveryCoordinator:a}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0})}),e.jsx("div",{children:e.jsx(ve,{label:"Finance Manager",options:M,value:y==null?void 0:y.financeManager,onChange:a=>ie({financeManager:a}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(B,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:g,children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(ee=y==null?void 0:y.lineItems)==null?void 0:ee.map((a,i)=>{var _,z,re,Q;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",i+1]}),((_=y==null?void 0:y.lineItems)==null?void 0:_.length)>1&&e.jsx(B,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>O(i),children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(ve,{label:"Product *",options:N,value:(a==null?void 0:a.product_id)||"",onChange:T=>ue(i,{product_id:T?parseInt(T):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(he,{id:`unit-price-${i}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:a==null?void 0:a.unit_price,onChange:T=>{var I;return ue(i,{unit_price:parseFloat((I=T==null?void 0:T.target)==null?void 0:I.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(he,{id:`quantity-${i}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:a==null?void 0:a.quantity_used,onChange:T=>{var I;return ue(i,{quantity_used:parseInt((I=T==null?void 0:T.target)==null?void 0:I.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(ae,{selectedValue:a==null?void 0:a.isOffSite,onChange:T=>ue(i,{isOffSite:T}),itemIndex:i})]}),(a==null?void 0:a.isOffSite)&&e.jsx("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:e.jsx(ve,{label:"Vendor *",options:D,value:(a==null?void 0:a.vendorId)||"",onChange:T=>ue(i,{vendorId:T}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"})}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(X,{requiresScheduling:a==null?void 0:a.requiresScheduling,onChange:T=>ue(i,{requiresScheduling:T}),itemIndex:i})}),a!=null&&a.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(he,{id:`promised-date-${i}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:a==null?void 0:a.lineItemPromisedDate,onChange:T=>{var I;return ue(i,{lineItemPromisedDate:(I=T==null?void 0:T.target)==null?void 0:I.value})},min:(Q=(re=(z=new Date)==null?void 0:z.toISOString())==null?void 0:re.split("T"))==null?void 0:Q[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(he,{id:`notes-${i}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(a==null?void 0:a.description)||"",onChange:T=>{var I;return ue(i,{description:(I=T==null?void 0:T.target)==null?void 0:I.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(he,{id:`no-schedule-reason-${i}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:a==null?void 0:a.noScheduleReason,onChange:T=>{var I;return ue(i,{noScheduleReason:(I=T==null?void 0:T.target)==null?void 0:I.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(a==null?void 0:a.unit_price)||0)*(parseInt(a==null?void 0:a.quantity_used)||1)).toFixed(2)]})]},i)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(ne=K())==null?void 0:ne.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(B,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>f(!0),children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(B,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:S,children:"Cancel"}),e.jsx(B,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:W,disabled:d,children:d?"Saving...":"Save Changes"})]})]}),v&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(B,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>f(!1),children:"Cancel"}),e.jsx(B,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:l,disabled:A,children:A?"Deleting...":"Delete"})]})]})}),R&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(B,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>F(!1),children:"Keep Editing"}),e.jsx(B,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:$,children:"Discard Changes"})]})]})})]})}):null},us=({status:r})=>{var h;const o={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},n=(o==null?void 0:o[r])||"bg-gray-100 text-gray-700",c=((h=r==null?void 0:r.replace("_"," "))==null?void 0:h.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${n}`,children:c})},Le=r=>{var u,d,m;if(!r)return"";const o=(u=r==null?void 0:r.trim())==null?void 0:u.split(" ");if((o==null?void 0:o.length)<2)return r;const n=o==null?void 0:o[0],c=(d=o==null?void 0:o.slice(1))==null?void 0:d.join(" "),h=(m=n==null?void 0:n[0])==null?void 0:m.toUpperCase();return`${c}, ${h}.`},Fe=({nextPromisedShort:r})=>{if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const o=new Date(r),n=new Date;n==null||n.setHours(0,0,0,0),o==null||o.setHours(0,0,0,0);const c=new Date(n);c==null||c.setDate((n==null?void 0:n.getDate())+2);let h="";return o<n?h="bg-red-100 text-red-800 border-red-200":o<=c?h="bg-amber-100 text-amber-800 border-amber-200":h="bg-green-100 text-green-800 border-green-200",e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${h}`,children:["Next: ",r]})},Ie=({serviceType:r,jobParts:o})=>{const n=o==null?void 0:o.some(h=>h==null?void 0:h.is_off_site),c=o==null?void 0:o.some(h=>!(h!=null&&h.is_off_site));return n&&c?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):n?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},hs=({draftsCount:r,onViewDrafts:o})=>{const[n,c]=E.useState(!1);return r===0||n?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(H,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{size:"sm",variant:"ghost",onClick:o,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>c(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(H,{name:"X",size:16})})]})]})})},Oe=({deal:r})=>!(r!=null&&r.customer_name)&&!(r!=null&&r.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"}):e.jsxs("div",{className:"space-y-1",children:[(r==null?void 0:r.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:r==null?void 0:r.customer_name}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:o=>o==null?void 0:o.stopPropagation(),children:r==null?void 0:r.customer_phone})]}),Pe=({amount:r})=>{var n;const o=parseFloat(r)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(n=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:n.format(o)})})},xs=({deal:r})=>r!=null&&r.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",r==null?void 0:r.loaner_number,(r==null?void 0:r.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due ",r==null?void 0:r.loaner_eta_short]})]}):null,gs=({isOpen:r,onClose:o,deal:n,onSave:c,loading:h})=>{var v,f,A,q;const[u,d]=E.useState({loaner_number:"",eta_return_date:"",notes:""}),[m,j]=E.useState("");E.useEffect(()=>{r&&n?(d({loaner_number:(n==null?void 0:n.loaner_number)||"",eta_return_date:(n==null?void 0:n.loaner_eta_return_date)||"",notes:(n==null?void 0:n.loaner_notes)||""}),j("")):r||(d({loaner_number:"",eta_return_date:"",notes:""}),j(""))},[r,n]);const b=async()=>{var x,C,R;if(j(""),!((x=u==null?void 0:u.loaner_number)!=null&&x.trim())){j("Loaner number is required");return}if(!(u!=null&&u.eta_return_date)){j("ETA return date is required");return}try{await c({job_id:n==null?void 0:n.id,loaner_number:(C=u==null?void 0:u.loaner_number)==null?void 0:C.trim(),eta_return_date:u==null?void 0:u.eta_return_date,notes:((R=u==null?void 0:u.notes)==null?void 0:R.trim())||null}),o()}catch(F){j((F==null?void 0:F.message)||"Failed to save loaner assignment")}};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:o}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(B,{variant:"ghost",size:"icon",onClick:o,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:n==null?void 0:n.title}),e.jsx("p",{className:"text-xs text-slate-500",children:n==null?void 0:n.customer_name})]}),m&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:m}),e.jsx("button",{onClick:()=>j(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:u==null?void 0:u.loaner_number,onChange:x=>d(C=>{var R;return{...C,loaner_number:(R=x==null?void 0:x.target)==null?void 0:R.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:u==null?void 0:u.eta_return_date,onChange:x=>d(C=>{var R;return{...C,eta_return_date:(R=x==null?void 0:x.target)==null?void 0:R.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(A=(f=(v=new Date)==null?void 0:v.toISOString())==null?void 0:f.split("T"))==null?void 0:A[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:u==null?void 0:u.notes,onChange:x=>d(C=>{var R;return{...C,notes:(R=x==null?void 0:x.target)==null?void 0:R.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(B,{variant:"outline",onClick:o,className:"flex-1 h-11",disabled:h,children:"Cancel"}),e.jsx(B,{onClick:b,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:h||!((q=u==null?void 0:u.loaner_number)!=null&&q.trim())||!(u!=null&&u.eta_return_date),children:h?"Saving...":"Save Loaner"})]})]})})]}):null},ms=({loaner:r,onClose:o,onConfirm:n,loading:c})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(B,{variant:"outline",onClick:o,className:"flex-1 h-11",disabled:c,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(B,{onClick:n,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:c,"aria-label":"Confirm loaner returned",children:c?"Processing...":"Mark Returned"})]})]})})}):null;function ks(){var T,I,le,je,Ne;const[r,o]=E.useState([]),[n,c]=E.useState(!0),[h,u]=E.useState(!1),[d,m]=E.useState(!1),[j,b]=E.useState(null),[v,f]=E.useState(null),[A,q]=E.useState(""),[x,C]=E.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[R,F]=E.useState(!1),[t,se]=E.useState(null),[p,G]=E.useState(!1),[M,D]=E.useState(null),[N,L]=E.useState(!1),[V,y]=E.useState(""),{getUserOptions:U,getVendorOptions:de,clearSearch:ae,loading:X,error:xe,refresh:P}=Ue({loadOnMount:!0});rs();const{user:ie}=Ce(),ue=()=>{try{return U({roles:["staff"],departments:["Sales Consultants"],activeOnly:!0})||[]}catch(s){return console.error("Error getting sales consultants:",s),[]}},g=()=>{try{return U({roles:["admin","manager"],departments:["Delivery Coordinator"],activeOnly:!0})||[]}catch(s){return console.error("Error getting delivery coordinators:",s),[]}},O=()=>{try{return U({roles:["staff"],departments:["Finance Manager"],activeOnly:!0})||[]}catch(s){return console.error("Error getting finance managers:",s),[]}},W=(s={})=>{try{return de(s)||[]}catch(w){return console.error("Error getting vendor options:",w),[]}},l=async s=>{var w;try{q("");const{error:te}=await((w=J)==null?void 0:w.rpc("delete_job_cascade",{p_job_id:s}));if(te)throw te;f(null),await K()}catch(te){q(`Failed to delete deal: ${te==null?void 0:te.message}`),console.error("Delete error:",te)}},S=async s=>{var w,te;try{G(!0),q("");const{error:Y}=await((te=(w=J)==null?void 0:w.from("loaner_assignments"))==null?void 0:te.upsert({job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes},{onConflict:"job_id"}));if(Y)throw Y;F(!1),se(null),await K()}catch(Y){const k=`Failed to save loaner assignment: ${Y==null?void 0:Y.message}`;throw q(k),new Error(k)}finally{G(!1)}},$=async s=>{try{L(!0),q(""),await Ze(s==null?void 0:s.loaner_id),D(null),await K()}catch(w){q(`Failed to mark loaner as returned: ${w==null?void 0:w.message}`),console.error("Mark returned error:",w)}finally{L(!1)}},K=async(s=0)=>{var w,te;try{c(!0),q("");const Y=await Qe();o(Y||[])}catch(Y){const k=`Failed to load deals: ${Y==null?void 0:Y.message}`;if(console.error("Load deals error:",Y),s<2&&((w=Y==null?void 0:Y.message)!=null&&w.includes("fetch")||(te=Y==null?void 0:Y.message)!=null&&te.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>K(s+1),1e3*(s+1));return}q(k),o([])}finally{c(!1)}};E.useEffect(()=>{var te;const s=new URLSearchParams(window.location.search),w=s==null?void 0:s.get("status");if(w){const Y=((te=w==null?void 0:w.charAt(0))==null?void 0:te.toUpperCase())+(w==null?void 0:w.slice(1));C(k=>({...k,status:Y}))}},[]),E.useEffect(()=>{K()},[]);const Z=s=>{se(s),F(!0)},ee=({message:s,onClose:w})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),w&&e.jsx("button",{onClick:w,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(H,{name:"X",size:16})})]})}):null,a=(s=>{var be,fe,ke;const w=s||[],te=((be=w==null?void 0:w.filter(oe=>(oe==null?void 0:oe.job_status)==="in_progress"))==null?void 0:be.length)||0,Y=w==null?void 0:w.reduce((oe,me)=>{const _e=parseFloat(me==null?void 0:me.total_amount)||0;return oe+_e},0),k=Y*.25,ce=Y>0?25:0,ge=((fe=w==null?void 0:w.filter(oe=>(oe==null?void 0:oe.job_status)==="pending"))==null?void 0:fe.length)||0,we=((ke=w==null?void 0:w.filter(oe=>(oe==null?void 0:oe.job_status)==="draft"))==null?void 0:ke.length)||0;return{active:te,revenue:(Y==null?void 0:Y.toFixed(2))||"0.00",profit:(k==null?void 0:k.toFixed(2))||"0.00",margin:(ce==null?void 0:ce.toFixed(1))||"0.0",pending:ge,drafts:we}})(r),i=r==null?void 0:r.filter(s=>{var w,te,Y,k,ce;if((x==null?void 0:x.status)!=="All"){const ge=(te=(w=x==null?void 0:x.status)==null?void 0:w.toLowerCase())==null?void 0:te.replace(" ","_");if((s==null?void 0:s.job_status)!==ge)return!1}if(x!=null&&x.salesAssigned&&(s==null?void 0:s.assigned_to)!==(x==null?void 0:x.salesAssigned)||x!=null&&x.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(x==null?void 0:x.deliveryAssigned)||x!=null&&x.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(x==null?void 0:x.financeAssigned)||x!=null&&x.vendor&&(s==null?void 0:s.vendor_id)!==(x==null?void 0:x.vendor))return!1;if(V!=null&&V.trim()){const ge=V==null?void 0:V.toLowerCase(),we=oe=>(oe==null?void 0:oe.replace(/\D/g,""))||"",be=we(ge),fe=[s==null?void 0:s.title,s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(Y=s==null?void 0:s.vehicle)==null?void 0:Y.make,(k=s==null?void 0:s.vehicle)==null?void 0:k.model,((ce=s==null?void 0:s.vehicle)==null?void 0:ce.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(fe==null?void 0:fe.some(oe=>{var _e;const me=oe==null?void 0:oe.toLowerCase();return!!(me!=null&&me.includes(ge)||(be==null?void 0:be.length)>=3&&((_e=we(me))!=null&&_e.includes(be)))})))return!1}return!0});E.useEffect(()=>{const s=setTimeout(()=>{y(x==null?void 0:x.search)},300);return()=>clearTimeout(s)},[x==null?void 0:x.search]);const _=(s,w)=>{var te,Y;if(C(k=>({...k,[s]:w})),s==="status"){const k=new URLSearchParams(window.location.search);w==="All"?k==null||k.delete("status"):k==null||k.set("status",w==null?void 0:w.toLowerCase());const ce=`${(te=window.location)==null?void 0:te.pathname}${k!=null&&k.toString()?"?"+(k==null?void 0:k.toString()):""}`;(Y=window.history)==null||Y.replaceState({},"",ce)}},z=()=>{var s,w;C({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),ae(),(w=window.history)==null||w.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},re=s=>{b(s),m(!0)},Q=()=>{m(!1),b(null)};return n?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx($e,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-slate-600",children:"Loading deals..."}),X&&e.jsx("div",{className:"text-sm text-slate-500 mt-2",children:"Loading dropdown data..."})]})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx($e,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(ee,{message:A||xe,onClose:()=>{q("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ls,{exportType:"jobs",filters:{status:x==null?void 0:x.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,w)=>console.log(`Export complete: ${s} records`),onExportError:s=>q(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(B,{onClick:()=>u(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(hs,{draftsCount:a==null?void 0:a.drafts,onViewDrafts:()=>_("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:a==null?void 0:a.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(H,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",a==null?void 0:a.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(H,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",a==null?void 0:a.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(H,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[a==null?void 0:a.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:a==null?void 0:a.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(H,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:a==null?void 0:a.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>_("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(x==null?void 0:x.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(H,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:x==null?void 0:x.search,onChange:s=>{var w;return _("search",(w=s==null?void 0:s.target)==null?void 0:w.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(x==null?void 0:x.salesAssigned)||"",onChange:s=>{var w;return _("salesAssigned",((w=s==null?void 0:s.target)==null?void 0:w.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:X,id:"sales-filter",children:[e.jsx("option",{value:"",children:"Sales Consultants"}),(T=ue())==null?void 0:T.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:Le(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(x==null?void 0:x.deliveryAssigned)||"",onChange:s=>{var w;return _("deliveryAssigned",((w=s==null?void 0:s.target)==null?void 0:w.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:X,id:"delivery-filter",children:[e.jsx("option",{value:"",children:"Delivery Coordinator"}),(I=g())==null?void 0:I.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:Le(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:(x==null?void 0:x.financeAssigned)||"",onChange:s=>{var w;return _("financeAssigned",((w=s==null?void 0:s.target)==null?void 0:w.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:X,id:"finance-filter",children:[e.jsx("option",{value:"",children:"Finance Manager"}),(le=O())==null?void 0:le.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:Le(s==null?void 0:s.name)},s==null?void 0:s.id))]})}),e.jsx("div",{className:"min-w-[180px]",children:e.jsxs("select",{value:(x==null?void 0:x.vendor)||"",onChange:s=>{var w;return _("vendor",((w=s==null?void 0:s.target)==null?void 0:w.value)||null)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500",disabled:X,id:"vendor-filter",children:[e.jsx("option",{value:"",children:"Vendors"}),(je=W({activeOnly:!0}))==null?void 0:je.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:s==null?void 0:s.name},s==null?void 0:s.id))]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(B,{variant:"ghost",size:"sm",onClick:P,className:"text-slate-600 hover:text-slate-800",disabled:X,"aria-label":"Refresh dropdown data",children:[e.jsx(H,{name:"RefreshCw",size:16,className:"mr-1"}),X?"Loading...":"Refresh"]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(B,{variant:"ghost",size:"sm",onClick:z,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(H,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",i==null?void 0:i.length," of ",r==null?void 0:r.length," deals",((x==null?void 0:x.salesAssigned)||(x==null?void 0:x.deliveryAssigned)||(x==null?void 0:x.financeAssigned)||(x==null?void 0:x.vendor)||(x==null?void 0:x.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Next"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:i==null?void 0:i.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(Oe,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Pe,{amount:s==null?void 0:s.total_amount})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Fe,{nextPromisedShort:s==null?void 0:s.next_promised_short})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ie,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(B,{size:"sm",variant:"ghost",onClick:()=>re(s==null?void 0:s.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(B,{size:"sm",variant:"ghost",onClick:()=>Z(s),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(B,{size:"sm",variant:"ghost",onClick:()=>D({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:s==null?void 0:s.title}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(B,{size:"sm",variant:"ghost",onClick:()=>f(s),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(i==null?void 0:i.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(x==null?void 0:x.status)==="All"?"No deals found":`No ${(Ne=x==null?void 0:x.status)==null?void 0:Ne.toLowerCase()} deals found`})}):i==null?void 0:i.map(s=>{var w;return e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:(s==null?void 0:s.job_number)||`Job-${(w=s==null?void 0:s.id)==null?void 0:w.slice(0,8)}`}),e.jsx("div",{className:"text-sm text-slate-600",children:s==null?void 0:s.title})]}),e.jsx(us,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((s==null?void 0:s.customer_name)||(s==null?void 0:s.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(Oe,{deal:s})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(Pe,{amount:s==null?void 0:s.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(Fe,{nextPromisedShort:s==null?void 0:s.next_promised_short})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(Ie,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})]}),(s==null?void 0:s.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(xs,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(B,{size:"sm",variant:"outline",onClick:()=>re(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(B,{size:"sm",variant:"outline",onClick:()=>f(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(B,{size:"sm",variant:"outline",onClick:()=>Z(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(H,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(B,{size:"sm",variant:"outline",onClick:()=>Z(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(B,{size:"sm",variant:"outline",onClick:()=>D({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:s==null?void 0:s.title}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id)})}),e.jsx(ns,{isOpen:h,onClose:()=>u(!1),onSuccess:K}),e.jsx(ds,{isOpen:d,dealId:j,onClose:Q,onSuccess:()=>{K(),Q()}}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(B,{variant:"outline",onClick:()=>f(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(B,{onClick:()=>l(v==null?void 0:v.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(gs,{isOpen:R,onClose:()=>{F(!1),se(null),q("")},deal:t,onSave:S,loading:p}),e.jsx(ms,{loaner:M,onClose:()=>{D(null),q("")},onConfirm:()=>$(M),loading:N})]})]})}export{ks as default};
//# sourceMappingURL=index-DLsGfq2x.js.map
