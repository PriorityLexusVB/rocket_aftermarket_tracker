import{s as K,u as Ie,j as e,B as W,S as Ae,I as Fe,a as He,g as Ge,b as Ze,c as Qe,d as De,e as es,p as Oe,f as ts,h as ns,i as ls,k as as,l as be}from"./index-CVH3qcV1.js";import{r as k,R as cs}from"./react-Czq5O75u.js";import{dealService as Pe,mapDbDealToForm as Re,getDeal as is,updateDeal as os,deleteDeal as ds,markLoanerReturned as us,getAllDeals as xs}from"./dealService-DE8xnNP1.js";import{s as $e,t as hs}from"./options-CllavUpK.js";import{I as le}from"./Icon-Bzx-trsB.js";import{l as ms}from"./vendorService-DEEXbhDA.js";import{l as gs}from"./smsTemplateService-DscuSQb-.js";import{N as Be}from"./Navbar-BW61XeJG.js";import{a as bs}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const fs=(r,x="")=>r==null?x:String(r),Ce={async getOverdueJobs(){var r;try{const{data:x,error:l}=await((r=K)==null?void 0:r.rpc("get_overdue_jobs_enhanced"));return l?(console.error("Error fetching overdue jobs:",l),{data:[],error:{message:l==null?void 0:l.message}}):{data:x||[],error:null}}catch(x){return console.error("Error in getOverdueJobs service:",x),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var r,x,l,i;try{const{data:u,error:d}=await((i=(l=(x=(r=K)==null?void 0:r.from("sms_templates"))==null?void 0:x.select("*"))==null?void 0:l.eq("is_active",!0))==null?void 0:i.order("created_at",{ascending:!1}));return d?{data:[],error:{message:d==null?void 0:d.message}}:{data:u||[],error:null}}catch(u){return console.error("Error fetching SMS templates:",u),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(r){var x,l,i,u,d,o,p,y;try{const N=await((l=(x=K)==null?void 0:x.auth)==null?void 0:l.getUser()),{data:v,error:j}=await((y=(p=(o=(i=K)==null?void 0:i.from("sms_templates"))==null?void 0:o.insert([{...r,created_by:(d=(u=N==null?void 0:N.data)==null?void 0:u.user)==null?void 0:d.id}]))==null?void 0:p.select())==null?void 0:y.single());return j?{data:null,error:{message:j==null?void 0:j.message}}:{data:v,error:null}}catch(N){return console.error("Error creating SMS template:",N),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(r,x){var l,i,u,d,o,p;try{const{data:y,error:N}=await((p=(o=(d=(u=(l=K)==null?void 0:l.from("sms_templates"))==null?void 0:u.update({...x,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:o.select())==null?void 0:p.single());return N?{data:null,error:{message:N==null?void 0:N.message}}:{data:y,error:null}}catch(y){return console.error("Error updating SMS template:",y),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(r){var x,l,i;try{const{error:u}=await((i=(l=(x=K)==null?void 0:x.from("sms_templates"))==null?void 0:l.delete())==null?void 0:i.eq("id",r));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting SMS template:",u),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(r){var x,l,i,u,d,o,p,y,N;try{const v=await((l=(x=K)==null?void 0:x.auth)==null?void 0:l.getUser()),{data:j,error:F}=await((N=(y=(d=(u=(i=K)==null?void 0:i.from("filter_presets"))==null?void 0:u.select("*"))==null?void 0:d.eq("page_type",r))==null?void 0:y.or(`user_id.eq.${(p=(o=v==null?void 0:v.data)==null?void 0:o.user)==null?void 0:p.id},is_public.eq.true`))==null?void 0:N.order("created_at",{ascending:!1}));return F?{data:[],error:{message:F==null?void 0:F.message}}:{data:j||[],error:null}}catch(v){return console.error("Error fetching filter presets:",v),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(r,x,l,i=!1){var u,d,o,p,y,N,v,j;try{const F=await((d=(u=K)==null?void 0:u.auth)==null?void 0:d.getUser()),{data:ee,error:I}=await((j=(v=(N=(o=K)==null?void 0:o.from("filter_presets"))==null?void 0:N.insert([{user_id:(y=(p=F==null?void 0:F.data)==null?void 0:p.user)==null?void 0:y.id,page_type:r,name:x,filters:l,is_public:i}]))==null?void 0:v.select())==null?void 0:j.single());return I?{data:null,error:{message:I==null?void 0:I.message}}:{data:ee,error:null}}catch(F){return console.error("Error saving filter preset:",F),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(r){var x,l,i;try{const{error:u}=await((i=(l=(x=K)==null?void 0:x.from("filter_presets"))==null?void 0:l.delete())==null?void 0:i.eq("id",r));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return console.error("Error deleting filter preset:",u),{error:{message:"Failed to delete filter preset"}}}},async exportData(r,x={},l="staff"){var i,u;try{const{data:d,error:o}=await((i=K)==null?void 0:i.rpc("generate_export_data",{export_type:r,filters:x,user_role:l}));return o?{data:null,error:{message:o==null?void 0:o.message}}:{data:(u=d||[])==null?void 0:u.map(y=>{var j;const N=(y==null?void 0:y.export_data)||y,v={};return(j=Object==null?void 0:Object.entries(N))==null||j.forEach(([F,ee])=>{typeof ee=="number"?v[F]=isNaN(ee)?0:ee:ee==null?v[F]="":v[F]=ee}),{export_data:v}}),error:null}}catch(d){return console.error("Error exporting data:",d),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(r,x,l=null){var i,u,d,o;try{if(!r||(r==null?void 0:r.length)===0)throw new Error("No data to export");let p="";if(l)p+=(l==null?void 0:l.join(","))+`
`;else{const v=((i=r==null?void 0:r[0])==null?void 0:i.export_data)||(r==null?void 0:r[0]);v&&(p+=((u=Object==null?void 0:Object.keys(v))==null?void 0:u.join(","))+`
`)}r==null||r.forEach(v=>{var ee;const j=(v==null?void 0:v.export_data)||v,F=(ee=Object==null?void 0:Object.values(j))==null?void 0:ee.map(I=>{if(I==null)return"";if(typeof I=="number"&&isNaN(I))return"0";let w=fs(I);return w!=null&&w.includes(",")||w!=null&&w.includes('"')?`"${w==null?void 0:w.replace(/"/g,'""')}"`:w});p+=(F==null?void 0:F.join(","))+`
`});const y=new Blob([p],{type:"text/csv;charset=utf-8;"}),N=document.createElement("a");if((N==null?void 0:N.download)!==void 0){const v=URL==null?void 0:URL.createObjectURL(y);N==null||N.setAttribute("href",v),N==null||N.setAttribute("download",x),N.style.visibility="hidden",(d=document.body)==null||d.appendChild(N),N==null||N.click(),(o=document.body)==null||o.removeChild(N),URL==null||URL.revokeObjectURL(v)}return{success:!0,error:null}}catch(p){return console.error("Export to CSV error:",p),{success:!1,error:{message:(p==null?void 0:p.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(r,x){var l,i,u,d,o;try{const p=await((i=(l=K)==null?void 0:l.auth)==null?void 0:i.getUser()),{data:y,error:N}=await((o=K)==null?void 0:o.rpc("bulk_update_jobs",{job_ids:r,updates:x,performed_by:(d=(u=p==null?void 0:p.data)==null?void 0:u.user)==null?void 0:d.id}));return N?{data:null,error:{message:N==null?void 0:N.message}}:{data:(y==null?void 0:y[0])||null,error:null}}catch(p){return console.error("Error in bulk update jobs:",p),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var r,x,l,i,u,d,o;try{const p=await((x=(r=K)==null?void 0:r.auth)==null?void 0:x.getUser()),{data:y,error:N}=await((o=(i=(l=K)==null?void 0:l.from("notification_preferences"))==null?void 0:i.select("*"))==null?void 0:o.eq("user_id",(d=(u=p==null?void 0:p.data)==null?void 0:u.user)==null?void 0:d.id));return N?{data:[],error:{message:N==null?void 0:N.message}}:{data:y||[],error:null}}catch(p){return console.error("Error fetching notification preferences:",p),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(r){var x,l,i,u,d,o,p,y,N,v;try{const j=await((l=(x=K)==null?void 0:x.auth)==null?void 0:l.getUser());await((p=(u=(i=K)==null?void 0:i.from("notification_preferences"))==null?void 0:u.delete())==null?void 0:p.eq("user_id",(o=(d=j==null?void 0:j.data)==null?void 0:d.user)==null?void 0:o.id));const F=r==null?void 0:r.map(w=>{var g,M;return{...w,user_id:(M=(g=j==null?void 0:j.data)==null?void 0:g.user)==null?void 0:M.id}}),{data:ee,error:I}=await((v=(N=(y=K)==null?void 0:y.from("notification_preferences"))==null?void 0:N.insert(F))==null?void 0:v.select());return I?{data:null,error:{message:I==null?void 0:I.message}}:{data:ee,error:null}}catch(j){return console.error("Error updating notification preferences:",j),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(r){var x,l,i;try{return(i=(l=(x=K)==null?void 0:x.channel("overdue-jobs"))==null?void 0:l.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},d=>{var o;(o=this.getOverdueJobs())==null||o.then(p=>{p!=null&&p.data&&r(p==null?void 0:p.data)})}))==null?void 0:i.subscribe()}catch(u){return console.error("Error subscribing to overdue jobs:",u),null}},async searchWithFilters(r,x,l){var i,u,d;try{let o=(i=K)==null?void 0:i.from(l);if(r)switch(l){case"jobs":o=o==null?void 0:o.or(`job_number.ilike.%${r}%,title.ilike.%${r}%`);break;case"vehicles":o=o==null?void 0:o.or(`vin.ilike.%${r}%,make.ilike.%${r}%,model.ilike.%${r}%`);break;case"vendors":o=o==null?void 0:o.or(`name.ilike.%${r}%,specialty.ilike.%${r}%`);break}(u=Object==null?void 0:Object.entries(x))==null||u.forEach(([N,v])=>{v!=null&&v!==""&&(Array!=null&&Array.isArray(v)?o=o==null?void 0:o.in(N,v):typeof v=="object"&&(v==null?void 0:v.min)!==void 0?o=o==null?void 0:o.gte(N,v==null?void 0:v.min):typeof v=="object"&&(v==null?void 0:v.max)!==void 0?o=o==null?void 0:o.lte(N,v==null?void 0:v.max):o=o==null?void 0:o.eq(N,v))});const{data:p,error:y}=await((d=o==null?void 0:o.select("*"))==null?void 0:d.order("created_at",{ascending:!1}));return y?{data:[],error:{message:y==null?void 0:y.message}}:{data:p||[],error:null}}catch(o){return console.error("Error in search with filters:",o),{data:[],error:{message:"Failed to search with filters"}}}}},ps=({exportType:r,filters:x={},selectedIds:l=[],onExportStart:i,onExportComplete:u,onExportError:d,disabled:o=!1,variant:p="outline",size:y="sm",className:N=""})=>{var T;const[v,j]=k.useState(!1),[F,ee]=k.useState(!1),[I,w]=k.useState("csv"),[g,M]=k.useState("filtered"),{user:c,userProfile:se}=Ie(),b=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],O=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(l==null?void 0:l.length)>0?[{value:"selected",label:`Selected (${l==null?void 0:l.length})`}]:[]],$=()=>{var Y,ie,re;const R=(re=(ie=(Y=new Date)==null?void 0:Y.toISOString())==null?void 0:ie.split("T"))==null?void 0:re[0];return`${r}-${g==="selected"?"selected":g}-${R}.${I}`},P=async()=>{var R,xe,Y,ie;if(!v)try{j(!0),i&&i();let re={...x};g==="selected"&&(l==null?void 0:l.length)>0&&(re.ids=l),g==="all"&&(re={});const G=await(Ce==null?void 0:Ce.exportData(r,re,(se==null?void 0:se.role)||"staff"));if(G!=null&&G.error)throw new Error((R=G==null?void 0:G.error)==null?void 0:R.message);if(!(G!=null&&G.data)||((xe=G==null?void 0:G.data)==null?void 0:xe.length)===0)throw new Error("No data found to export");const f=$(),q=await(Ce==null?void 0:Ce.exportToCSV(G==null?void 0:G.data,f));if(q!=null&&q.error)throw new Error((Y=q==null?void 0:q.error)==null?void 0:Y.message);ee(!1),u&&u((ie=G==null?void 0:G.data)==null?void 0:ie.length,f)}catch(re){console.error("Export error:",re),d&&d((re==null?void 0:re.message)||"Export failed")}finally{j(!1)}},S=()=>{switch(r){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(W,{variant:p,size:y,onClick:()=>ee(!F),disabled:o||v,iconName:v?void 0:"Download",iconPosition:"left",className:`${N} ${v?"cursor-wait":""}`,"aria-label":`Export ${S()}`,children:v?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${S()}`}),F&&!v&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Ae,{value:I,onChange:w,options:b,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Ae,{value:g,onChange:M,options:O,className:"w-full"})]}),g==="filtered"&&((T=Object==null?void 0:Object.keys(x))==null?void 0:T.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Fe,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),g==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Fe,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",l==null?void 0:l.length," selected record",(l==null?void 0:l.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(W,{variant:"ghost",size:"sm",onClick:()=>ee(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(W,{size:"sm",onClick:P,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${S()}`,children:"Export"})]})]})})]})},Ve={async getVehicles(r={},x=null){var l,i,u,d;try{let o=(u=(i=(l=K)==null?void 0:l.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:u.order("created_at",{ascending:!1});return x&&(o=o==null?void 0:o.eq("org_id",x)),r!=null&&r.status&&(o=o==null?void 0:o.eq("vehicle_status",r==null?void 0:r.status)),r!=null&&r.make&&(o=o==null?void 0:o.eq("make",r==null?void 0:r.make)),r!=null&&r.year&&(o=o==null?void 0:o.eq("year",r==null?void 0:r.year)),r!=null&&r.search&&(o=o==null?void 0:o.or(`vin.ilike.%${r==null?void 0:r.search}%,make.ilike.%${r==null?void 0:r.search}%,model.ilike.%${r==null?void 0:r.search}%,license_plate.ilike.%${r==null?void 0:r.search}%,owner_name.ilike.%${r==null?void 0:r.search}%,owner_phone.ilike.%${r==null?void 0:r.search}%,owner_email.ilike.%${r==null?void 0:r.search}%,stock_number.ilike.%${r==null?void 0:r.search}%`)),{data:await $e(o,"vehicles:getVehicles")||[],error:null}}catch(o){return(d=o==null?void 0:o.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(r,x=null){var l,i,u,d,o;try{let p=(d=(u=(i=(l=K)==null?void 0:l.from("vehicles"))==null?void 0:i.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:u.eq("id",r))==null?void 0:d.single();return x&&(p=p==null?void 0:p.eq("org_id",x)),{data:await $e(p,"vehicles:getVehicleById"),error:null}}catch(p){return(o=p==null?void 0:p.message)!=null&&o.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(r){var x,l,i,u,d,o,p,y,N,v;try{const{data:j,error:F}=await((N=(y=(p=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:p.insert([{...r,created_by:(o=(d=(u=await((i=(l=K)==null?void 0:l.auth)==null?void 0:i.getUser()))==null?void 0:u.data)==null?void 0:d.user)==null?void 0:o.id}]))==null?void 0:y.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:N.single());return F?{data:null,error:{message:F==null?void 0:F.message}}:{data:j,error:null}}catch(j){return(v=j==null?void 0:j.message)!=null&&v.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(r){var x,l,i,u;try{const{data:d,error:o}=await((u=(i=(l=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:l.insert([r]))==null?void 0:i.select())==null?void 0:u.single());if(o)throw console.error("Vehicle creation error:",o),new Error(o.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",d),d}catch(d){throw console.error("Error in vehicleService.create:",d),d}},async createVehicleWithProducts(r){var x,l;try{console.log("Creating vehicle with products:",r);const i=`vehicle_${Date.now()}`;await new Promise(d=>setTimeout(d,1e3));const u={id:i,...r,created_at:(x=new Date)==null?void 0:x.toISOString(),initial_products_count:((l=r==null?void 0:r.initial_products)==null?void 0:l.length)||0,estimated_aftermarket_value:(r==null?void 0:r.total_initial_product_value)||0};return console.log("Vehicle created successfully:",u),u}catch(i){throw console.error("Error creating vehicle with products:",i),i}},async checkStockNumberExists(r){var x,l,i,u;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:o}=await((u=(i=(l=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:i.eq("stock_number",r==null?void 0:r.trim()))==null?void 0:u.maybeSingle());return o?(console.error("Stock number check error:",o),!1):!!d}catch(d){return console.error("Error checking stock number:",d),!1}},async checkVinExists(r){var x,l,i,u;if(!(r!=null&&r.trim()))return!1;try{const{data:d,error:o}=await((u=(i=(l=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:l.select("id"))==null?void 0:i.eq("vin",r==null?void 0:r.trim()))==null?void 0:u.maybeSingle());return o?(console.error("VIN check error:",o),!1):!!d}catch(d){return console.error("Error checking VIN:",d),!1}},async updateVehicle(r,x){var l,i,u,d,o,p,y;try{const{data:N,error:v}=await((p=(o=(d=(u=(l=K)==null?void 0:l.from("vehicles"))==null?void 0:u.update({...x,updated_at:(i=new Date)==null?void 0:i.toISOString()}))==null?void 0:d.eq("id",r))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:p.single());return v?{data:null,error:{message:v==null?void 0:v.message}}:{data:N,error:null}}catch(N){return(y=N==null?void 0:N.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(r){var x,l,i,u;try{const{error:d}=await((i=(l=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:l.delete())==null?void 0:i.eq("id",r));return d?{error:{message:d==null?void 0:d.message}}:{error:null}}catch(d){return(u=d==null?void 0:d.message)!=null&&u.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(r=null){var x,l,i,u,d,o,p;try{let y=(l=(x=K)==null?void 0:x.from("vehicles"))==null?void 0:l.select("vehicle_status");r&&(y=y==null?void 0:y.eq("org_id",r));const N=await $e(y,"vehicles:getVehicleStats");return{data:{total:(N==null?void 0:N.length)||0,active:((i=N==null?void 0:N.filter(j=>(j==null?void 0:j.vehicle_status)==="active"))==null?void 0:i.length)||0,maintenance:((u=N==null?void 0:N.filter(j=>(j==null?void 0:j.vehicle_status)==="maintenance"))==null?void 0:u.length)||0,retired:((d=N==null?void 0:N.filter(j=>(j==null?void 0:j.vehicle_status)==="retired"))==null?void 0:d.length)||0,sold:((o=N==null?void 0:N.filter(j=>(j==null?void 0:j.vehicle_status)==="sold"))==null?void 0:o.length)||0},error:null}}catch(y){return(p=y==null?void 0:y.message)!=null&&p.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(r={}){return await this.getVehicles(r)}};function js({isOpen:r,onClose:x,onSuccess:l}){var m,A,Z;const{user:i}=Ie(),{orgId:u}=He()||{},[d,o]=k.useState(1),[p,y]=k.useState(!1),[N,v]=k.useState(""),[j,F]=k.useState(!1),[ee,I]=k.useState(!1),[w,g]=k.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),M={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(m=new Date)==null?void 0:m.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[c,se]=k.useState(M),[b,O]=k.useState([]),$=async(t=0)=>{var _,C;try{g(s=>({...s,loading:!0,error:null,retryCount:t}));const[te,ne,Q,U,ce]=await Promise.all([Ge().catch(()=>[]),Ze().catch(()=>[]),Qe().catch(()=>[]),De({activeOnly:!0}).catch(()=>[]),es({activeOnly:!0}).catch(()=>[])]);g({salesConsultants:te,deliveryCoordinators:ne,financeManagers:Q,vendors:U,products:ce==null?void 0:ce.map(s=>({...s,unitPrice:s==null?void 0:s.unit_price})),loading:!1,error:null,retryCount:t})}catch(te){if(console.error("Failed to load dropdown data:",te),t<2&&((_=te==null?void 0:te.message)!=null&&_.includes("fetch")||(C=te==null?void 0:te.message)!=null&&C.includes("network"))){setTimeout(()=>$(t+1),1e3*(t+1));return}g(ne=>({...ne,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:t}))}},P=({checked:t,onChange:_})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!t,onChange:C=>{var ne;const te=!!((ne=C==null?void 0:C.target)!=null&&ne.checked);_(te)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),S=({label:t,options:_,value:C,onChange:te,placeholder:ne,required:Q=!1,helpText:U,testId:ce})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[t," ",Q&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:C||"",onChange:s=>{var h;return te(((h=s==null?void 0:s.target)==null?void 0:h.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:w==null?void 0:w.loading,required:Q,"data-testid":ce,children:[e.jsx("option",{value:"",children:ne}),_==null?void 0:_.map(s=>e.jsx("option",{value:s==null?void 0:s.id,children:(s==null?void 0:s.full_name)||(s==null?void 0:s.label)||(s==null?void 0:s.name)},s==null?void 0:s.id))]}),U&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:U}),(_==null?void 0:_.length)===0&&!(w!=null&&w.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No ",t==null?void 0:t.toLowerCase()," found yet. Add it in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]});k.useEffect(()=>{const t=(c==null?void 0:c.customerName)!==(M==null?void 0:M.customerName)||(c==null?void 0:c.customerPhone)!==(M==null?void 0:M.customerPhone)||(c==null?void 0:c.customerEmail)!==(M==null?void 0:M.customerEmail)||(c==null?void 0:c.needsLoaner)!==(M==null?void 0:M.needsLoaner)||(c==null?void 0:c.assignedTo)!==(M==null?void 0:M.assignedTo)||(c==null?void 0:c.deliveryCoordinator)!==(M==null?void 0:M.deliveryCoordinator)||(c==null?void 0:c.financeManager)!==(M==null?void 0:M.financeManager)||(b==null?void 0:b.length)>0;F(t)},[c,b]),k.useEffect(()=>{r&&$()},[r]);const T=()=>{O(t=>[...t,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},R=(t,_,C)=>{var te;if(O(ne=>ne==null?void 0:ne.map(Q=>{if((Q==null?void 0:Q.id)===t){let U={...Q,[_]:C};return _==="requiresScheduling"&&(C===!0?U.noScheduleReason="":U.promisedDate=""),U}return Q})),_==="productId"&&C){const ne=(te=w==null?void 0:w.products)==null?void 0:te.find(Q=>(Q==null?void 0:Q.id)===C);ne&&O(Q=>Q==null?void 0:Q.map(U=>(U==null?void 0:U.id)===t?{...U,unitPrice:(ne==null?void 0:ne.unitPrice)||""}:U))}},xe=t=>{O(_=>_==null?void 0:_.filter(C=>(C==null?void 0:C.id)!==t))},Y=()=>{var t,_;return((_=(t=c==null?void 0:c.customerName)==null?void 0:t.trim())==null?void 0:_.length)>0},ie=()=>(b==null?void 0:b.length)===0?!1:b==null?void 0:b.every(t=>{var _;return!(!(t!=null&&t.productId)||!(t!=null&&t.unitPrice)||t!=null&&t.requiresScheduling&&!(t!=null&&t.promisedDate)||!(t!=null&&t.requiresScheduling)&&!((_=t==null?void 0:t.noScheduleReason)!=null&&_.trim())||(t==null?void 0:t.serviceType)==="vendor"&&!(t!=null&&t.vendorId))}),re=()=>b==null?void 0:b.reduce((t,_)=>t+(parseFloat(_==null?void 0:_.unitPrice)||0),0),G=async()=>{var t,_,C,te,ne,Q,U,ce,s,h;if(!Y()){v("Customer name is required to save draft");return}y(!0),v("");try{const E={year:(c==null?void 0:c.vehicleYear)||((t=new Date)==null?void 0:t.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(_=c==null?void 0:c.customerName)==null?void 0:_.trim(),owner_phone:((C=c==null?void 0:c.customerPhone)==null?void 0:C.trim())||null,owner_email:((te=c==null?void 0:c.customerEmail)==null?void 0:te.trim())||null,stock_number:((ne=c==null?void 0:c.stockNumber)==null?void 0:ne.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},B=await Ve.create(E),V={title:`Draft Deal - ${(Q=c==null?void 0:c.customerName)==null?void 0:Q.trim()}`,description:`Draft deal for ${(U=c==null?void 0:c.customerName)==null?void 0:U.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:B==null?void 0:B.id,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),customerName:(ce=c==null?void 0:c.customerName)==null?void 0:ce.trim(),customerPhone:((s=c==null?void 0:c.customerPhone)==null?void 0:s.trim())||"",customerEmail:((h=c==null?void 0:c.customerEmail)==null?void 0:h.trim())||"",org_id:u||void 0,lineItems:[]};await Pe.createDeal(V),l==null||l(),q(),x()}catch(E){v(`Failed to save draft: ${E==null?void 0:E.message}`)}finally{y(!1)}},f=async()=>{var t,_,C,te,ne,Q,U,ce,s,h,E,B;if(!Y()||!ie()){v("Please complete all required fields");return}y(!0),v("");try{const V={year:(c==null?void 0:c.vehicleYear)||((t=new Date)==null?void 0:t.getFullYear()),make:(c==null?void 0:c.vehicleMake)||"TBD",model:(c==null?void 0:c.vehicleModel)||"TBD",owner_name:(_=c==null?void 0:c.customerName)==null?void 0:_.trim(),owner_phone:((C=c==null?void 0:c.customerPhone)==null?void 0:C.trim())||null,owner_email:((te=c==null?void 0:c.customerEmail)==null?void 0:te.trim())||null,stock_number:((ne=c==null?void 0:c.stockNumber)==null?void 0:ne.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...u?{org_id:u}:{}},de=await Ve.create(V),me=re(),ge=(b==null?void 0:b.some(a=>(a==null?void 0:a.serviceType)==="vendor"))?"vendor":"in_house",pe=((Q=b==null?void 0:b.find(a=>a==null?void 0:a.vendorId))==null?void 0:Q.vendorId)||null;let ye=null;if(ge==="vendor"){const a=(b||[]).filter(n=>(n==null?void 0:n.serviceType)==="vendor"&&(n==null?void 0:n.requiresScheduling)&&(n==null?void 0:n.promisedDate)).map(n=>new Date(n==null?void 0:n.promisedDate)).sort((n,L)=>n-L);ye=(U=(a==null?void 0:a[0])||new Date)==null?void 0:U.toISOString()}const H=(b||[]).map(a=>({product_id:a==null?void 0:a.productId,quantity_used:1,unit_price:parseFloat((a==null?void 0:a.unitPrice)||0),promised_date:a!=null&&a.requiresScheduling?a==null?void 0:a.promisedDate:null,requires_scheduling:!!(a!=null&&a.requiresScheduling),no_schedule_reason:a!=null&&a.requiresScheduling?null:a==null?void 0:a.noScheduleReason,is_off_site:(a==null?void 0:a.serviceType)==="vendor"})),ae={title:`Deal - ${(ce=c==null?void 0:c.customerName)==null?void 0:ce.trim()}`,description:`Deal for ${(s=c==null?void 0:c.customerName)==null?void 0:s.trim()}`,job_status:"pending",service_type:ge,vehicle_id:de==null?void 0:de.id,vendor_id:pe,assigned_to:(c==null?void 0:c.assignedTo)||(i==null?void 0:i.id),delivery_coordinator_id:(c==null?void 0:c.deliveryCoordinator)||null,finance_manager_id:(c==null?void 0:c.financeManager)||null,customer_needs_loaner:!!(c!=null&&c.needsLoaner),scheduled_start_time:ye,estimated_cost:me,org_id:u||void 0,customerName:(h=c==null?void 0:c.customerName)==null?void 0:h.trim(),customerPhone:((E=c==null?void 0:c.customerPhone)==null?void 0:E.trim())||"",customerEmail:((B=c==null?void 0:c.customerEmail)==null?void 0:B.trim())||"",lineItems:H},Ne=await Pe.createDeal(ae);await Pe.updateDeal(Ne==null?void 0:Ne.id,ae),l==null||l(),q(),x()}catch(V){v(`Failed to create deal: ${V==null?void 0:V.message}`)}finally{y(!1)}},q=()=>{o(1),se(M),O([]),v(""),F(!1)},je=()=>{j?I(!0):(q(),x())},ke=()=>{I(!1),q(),x()};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:je,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(le,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${d>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${d>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${d>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[N&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",N]}),e.jsx("button",{onClick:()=>v(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(le,{name:"X",size:16})})]})}),(w==null?void 0:w.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",w==null?void 0:w.error]}),e.jsx("button",{onClick:()=>$(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),d===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:c==null?void 0:c.customerName,onChange:t=>se(_=>{var C;return{..._,customerName:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:c==null?void 0:c.customerPhone,onChange:t=>se(_=>{var C;return{..._,customerPhone:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:c==null?void 0:c.customerEmail,onChange:t=>se(_=>{var C;return{..._,customerEmail:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(c==null?void 0:c.vehicleYear)||"",onChange:t=>se(_=>{var C;return{..._,vehicleYear:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((A=new Date)==null?void 0:A.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleMake)||"",onChange:t=>se(_=>{var C;return{..._,vehicleMake:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.vehicleModel)||"",onChange:t=>se(_=>{var C;return{..._,vehicleModel:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(c==null?void 0:c.stockNumber)||"",onChange:t=>se(_=>{var C;return{..._,stockNumber:(C=t==null?void 0:t.target)==null?void 0:C.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(P,{checked:c==null?void 0:c.needsLoaner,onChange:t=>{se(_=>({..._,needsLoaner:!!t}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(S,{label:"Sales Consultant",options:w==null?void 0:w.salesConsultants,value:c==null?void 0:c.assignedTo,onChange:t=>se(_=>({..._,assignedTo:t})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(S,{label:"Delivery Coordinator",options:w==null?void 0:w.deliveryCoordinators,value:c==null?void 0:c.deliveryCoordinator,onChange:t=>se(_=>({..._,deliveryCoordinator:t})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(S,{label:"Finance Manager",options:w==null?void 0:w.financeManagers,value:c==null?void 0:c.financeManager,onChange:t=>se(_=>({..._,financeManager:t})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),d===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(W,{onClick:T,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(le,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(b==null?void 0:b.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(le,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[b==null?void 0:b.map((t,_)=>{var C,te,ne,Q,U,ce,s;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",_+1]}),e.jsx("button",{onClick:()=>xe(t==null?void 0:t.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(le,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(t==null?void 0:t.productId)||"",onChange:h=>{var E;return R(t==null?void 0:t.id,"productId",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${_}`,children:[e.jsx("option",{value:"",children:"Select product"}),(C=w==null?void 0:w.products)==null?void 0:C.map(h=>e.jsx("option",{value:h==null?void 0:h.id,children:h==null?void 0:h.label},h==null?void 0:h.id))]}),!(w!=null&&w.loading)&&(((te=w==null?void 0:w.products)==null?void 0:te.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No products found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:t==null?void 0:t.unitPrice,onChange:h=>{var E;return R(t==null?void 0:t.id,"unitPrice",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${_}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${t==null?void 0:t.id}`,value:"in_house",checked:(t==null?void 0:t.serviceType)==="in_house",onChange:h=>{var E;return R(t==null?void 0:t.id,"serviceType",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"mr-2 cursor-pointer"}),"🏠 On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${t==null?void 0:t.id}`,value:"vendor",checked:(t==null?void 0:t.serviceType)==="vendor",onChange:h=>{var E;return R(t==null?void 0:t.id,"serviceType",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"mr-2 cursor-pointer"}),"🏢 Off-Site (Vendor)"]})]})]}),(t==null?void 0:t.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(t==null?void 0:t.vendorId)||"",onChange:h=>{var E;return R(t==null?void 0:t.id,"vendorId",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(ne=w==null?void 0:w.vendors)==null?void 0:ne.map(h=>e.jsx("option",{value:h==null?void 0:h.id,children:h==null?void 0:h.label},h==null?void 0:h.id))]}),!(w!=null&&w.loading)&&(((Q=w==null?void 0:w.vendors)==null?void 0:Q.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${_}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${t==null?void 0:t.id}`,checked:(t==null?void 0:t.requiresScheduling)===!0,onChange:()=>R(t==null?void 0:t.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${_}`,"data-testid":`requires-scheduling-${_}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${_}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${t==null?void 0:t.id}`,checked:(t==null?void 0:t.requiresScheduling)===!1,onChange:()=>R(t==null?void 0:t.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${_}`}),"No Scheduling Needed"]})]}),t!=null&&t.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:t==null?void 0:t.promisedDate,onChange:h=>{var E;return R(t==null?void 0:t.id,"promisedDate",(E=h==null?void 0:h.target)==null?void 0:E.value)},min:(s=(ce=(U=new Date)==null?void 0:U.toISOString())==null?void 0:ce.split("T"))==null?void 0:s[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t==null?void 0:t.noScheduleReason,onChange:h=>{var E;return R(t==null?void 0:t.id,"noScheduleReason",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:t==null?void 0:t.serviceNotes,onChange:h=>{var E;return R(t==null?void 0:t.id,"serviceNotes",(E=h==null?void 0:h.target)==null?void 0:E.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},t==null?void 0:t.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(Z=re())==null?void 0:Z.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[b==null?void 0:b.length," item",(b==null?void 0:b.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:d===2&&e.jsx(W,{onClick:()=>o(1),variant:"outline",className:"w-full md:w-auto h-11",children:"← Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(W,{onClick:je,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),d===1&&e.jsxs(e.Fragment,{children:[e.jsx(W,{onClick:G,disabled:!Y()||p,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:p?"Saving...":"Save Draft"}),e.jsx(W,{onClick:()=>o(2),disabled:!Y(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items →"})]}),d===2&&e.jsx(W,{onClick:f,disabled:!Y()||!ie()||p,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:p?"Creating...":"Create Deal"})]})]})}),ee&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(W,{variant:"outline",onClick:()=>I(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(W,{onClick:ke,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function ys(r,{activeOnly:x=!0}={}){let l=K.from("products").select("*").order("name",{ascending:!0});x&&(l=l.eq("is_active",!0)),r&&(l=l.or(`org_id.eq.${r},org_id.is.null`));const i=await $e(l,"products:listByOrg");return hs(i,{labelKey:"name",valueKey:"id"})}function vs(r,{activeOnly:x=!0}={}){let l=K.from("user_profiles").select("*").order("full_name",{ascending:!0});return x&&(l=l.eq("is_active",!0)),r&&(l=l.eq("org_id",r)),$e(l,"staff:listByOrg")}function ss(r={}){var g,M,c,se;const{loadOnMount:x=!0,cacheTime:l=5*60*1e3}=r,[i,u]=k.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[d,o]=k.useState(null),p=He(),y=Ie(),N=async()=>{var b,O,$,P;try{if(p.loading)return;if(u(q=>({...q,loading:!0,error:null})),!((b=p.session)!=null&&b.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),u(q=>({...q,loading:!1}));return}const S=!!p.orgId,T=[(O=Ze())==null?void 0:O.catch(q=>(console.error("[dropdowns:dc] Delivery coordinators failed:",q),[])),($=Ge())==null?void 0:$.catch(q=>(console.error("[dropdowns:sales] Sales consultants failed:",q),[])),(P=Qe())==null?void 0:P.catch(q=>(console.error("[dropdowns:finance] Finance managers failed:",q),[])),S?vs(p.orgId).catch(q=>(console.error("[dropdowns:users] tenant staff failed:",q),[])):ls({activeOnly:!0}).catch(q=>(console.error("[dropdowns:users] global user profiles failed:",q),[])),S?ms(p.orgId).catch(q=>(console.error("[dropdowns:vendors] tenant vendors failed:",q),[])):De({activeOnly:!0}).catch(q=>(console.error("[dropdowns:vendors] global vendors failed:",q),[])),S?ys(p.orgId).catch(q=>(console.error("[dropdowns:products] tenant products failed:",q),[])):es({activeOnly:!0}).catch(q=>(console.error("[dropdowns:products] global products failed:",q),[])),S?gs(p.orgId).catch(q=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",q),[])):Promise.resolve([])],[R,xe,Y,ie,re,G,f]=await Promise.all(T);u({dc:R,sales:xe,finance:Y,users:ie,vendors:re,products:G,smsTemplates:f,loading:!1,error:null,searchResults:null}),o(Date.now())}catch(S){u({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(S==null?void 0:S.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",S)}};k.useEffect(()=>{try{const b=Oe({departments:["Sales","Sales Consultant","Sales Consultants"]}),O=Oe({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),$=Oe({departments:["Finance","Finance Manager","Finance Managers"]}),P=ts({activeOnly:!0}),S=ns({activeOnly:!0});[b==null?void 0:b.length,O==null?void 0:O.length,$==null?void 0:$.length,P==null?void 0:P.length,S==null?void 0:S.length].some(Boolean)&&u(R=>({...R,sales:b||R.sales,dc:O||R.dc,finance:$||R.finance,vendors:P||R.vendors,products:S||R.products,loading:!1,error:null}))}catch(b){console.info("[dropdowns] cached-first hydrate skipped:",b==null?void 0:b.message)}},[]);const v=()=>d?Date.now()-d<l:!1,j=async()=>{v()||await N()},F=async b=>{try{if(!(b!=null&&b.trim())){u($=>({...$,searchResults:null}));return}const O=await as(b);u($=>({...$,searchResults:O}))}catch(O){console.error("[dropdowns:search] Search failed:",O),u($=>({...$,searchResults:{users:[],vendors:[]}}))}},ee=()=>{u(b=>({...b,searchResults:null}))},I=(b={})=>{const{roles:O=[],departments:$=[],activeOnly:P=!0}=b;let S=(i==null?void 0:i.users)||[];return P&&(S=S==null?void 0:S.filter(T=>T==null?void 0:T.is_active)),(O==null?void 0:O.length)>0&&(S=S==null?void 0:S.filter(T=>O==null?void 0:O.includes(T==null?void 0:T.role))),($==null?void 0:$.length)>0&&(S=S==null?void 0:S.filter(T=>$==null?void 0:$.includes(T==null?void 0:T.department))),(S==null?void 0:S.map(T=>({id:T==null?void 0:T.id,value:T==null?void 0:T.id,label:T==null?void 0:T.full_name,name:T==null?void 0:T.full_name,role:T==null?void 0:T.role,department:T==null?void 0:T.department,email:T==null?void 0:T.email})))||[]},w=(b={})=>{const{activeOnly:O=!0,specialty:$=null}=b;let P=(i==null?void 0:i.vendors)||[];return O&&(P=P==null?void 0:P.filter(S=>S==null?void 0:S.is_active)),$&&(P=P==null?void 0:P.filter(S=>{var T,R;return(R=(T=S==null?void 0:S.specialty)==null?void 0:T.toLowerCase())==null?void 0:R.includes($==null?void 0:$.toLowerCase())})),(P==null?void 0:P.map(S=>({id:S==null?void 0:S.id,value:(S==null?void 0:S.value)||(S==null?void 0:S.id),label:(S==null?void 0:S.label)||(S==null?void 0:S.name),name:S==null?void 0:S.name,specialty:S==null?void 0:S.specialty,email:S==null?void 0:S.email,phone:S==null?void 0:S.phone})))||[]};return k.useEffect(()=>{let b=!0;return(async()=>{var $;if(!x)return;const O=Date.now();for(;b&&(y!=null&&y.loading)&&Date.now()-O<5e3;)await new Promise(P=>setTimeout(P,200));b&&(y!=null&&y.user?(console.log("Dropdowns: authenticated user",($=y==null?void 0:y.user)==null?void 0:$.id),y!=null&&y.userProfile&&console.log("Dropdowns: user profile org",y.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),b&&await N())})(),()=>{b=!1}},[x,y==null?void 0:y.loading,(g=y==null?void 0:y.user)==null?void 0:g.id,p==null?void 0:p.loading,p==null?void 0:p.orgId]),{dc:i==null?void 0:i.dc,sales:i==null?void 0:i.sales,finance:i==null?void 0:i.finance,users:i==null?void 0:i.users,vendors:i==null?void 0:i.vendors,products:i==null?void 0:i.products,smsTemplates:i==null?void 0:i.smsTemplates,loading:i==null?void 0:i.loading,error:i==null?void 0:i.error,searchResults:i==null?void 0:i.searchResults,globalSearch:F,clearSearch:ee,getUserOptions:I,getVendorOptions:w,refresh:N,refreshIfNeeded:j,lastUpdate:d,isCacheValid:v(),salesConsultantOptions:(M=(i==null?void 0:i.sales)||[])==null?void 0:M.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),deliveryCoordinatorOptions:(c=(i==null?void 0:i.dc)||[])==null?void 0:c.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name})),financeManagerOptions:(se=(i==null?void 0:i.finance)||[])==null?void 0:se.map(b=>({id:b==null?void 0:b.id,value:b==null?void 0:b.id,label:b==null?void 0:b.full_name,name:b==null?void 0:b.full_name}))}}const Ns=()=>{var y,N,v;const{dc:r,sales:x,finance:l,vendors:i,products:u,loading:d,error:o,refresh:p}=ss({loadOnMount:!0});return{salesConsultants:x,deliveryCoordinators:r,financeManagers:l,vendors:i,products:u,loading:d,error:o,refresh:p,salesConsultantOptions:(y=x||[])==null?void 0:y.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name})),deliveryCoordinatorOptions:(N=r||[])==null?void 0:N.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name})),financeManagerOptions:(v=l||[])==null?void 0:v.map(j=>({id:j==null?void 0:j.id,value:j==null?void 0:j.id,label:j==null?void 0:j.full_name,name:j==null?void 0:j.full_name})),vendorOptions:i||[],productOptions:u||[]}},_s=()=>(cs.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Le=({options:r=[],value:x,onChange:l,placeholder:i="Select...",searchable:u=!1,clearable:d=!1,disabled:o=!1,loading:p=!1,error:y=null,className:N="",optionLabel:v="label",optionValue:j="value",groupBy:F=null,renderOption:ee=null,label:I="",helperText:w=""})=>{const[g,M]=k.useState(!1),[c,se]=k.useState(""),[b,O]=k.useState(!1),[$,P]=k.useState(r),[S,T]=k.useState(-1),[R,xe]=k.useState({top:0,left:0,width:0}),Y=k.useRef(null),ie=k.useRef(null);k.useRef(null),k.useEffect(()=>{O((()=>{var t;return(t=window.matchMedia("(max-width: 767px)"))==null?void 0:t.matches})());const A=window.matchMedia("(max-width: 767px)"),Z=()=>O(A==null?void 0:A.matches);return A==null||A.addEventListener("change",Z),()=>A==null?void 0:A.removeEventListener("change",Z)},[]),k.useEffect(()=>{if(!(c!=null&&c.trim())){P(r);return}const m=c==null?void 0:c.toLowerCase(),A=r==null?void 0:r.filter(Z=>{const t=[Z==null?void 0:Z.name,Z==null?void 0:Z.displayName,Z==null?void 0:Z.category,Z==null?void 0:Z.brand,Z==null?void 0:Z.specialty,Z==null?void 0:Z.department,Z==null?void 0:Z.email].filter(Boolean);return t==null?void 0:t.some(_=>{var C;return(C=_==null?void 0:_.toLowerCase())==null?void 0:C.includes(m)})});P(A),T(-1)},[c,r]);const re=r==null?void 0:r.find(m=>(m==null?void 0:m.id)===x),G=m=>((m==null?void 0:m[j])||(m==null?void 0:m.id))===x,f=()=>{var m;if(Y!=null&&Y.current){const A=(m=Y==null?void 0:Y.current)==null?void 0:m.getBoundingClientRect();xe({top:(A==null?void 0:A.bottom)+window.scrollY,left:(A==null?void 0:A.left)+window.scrollX,width:A==null?void 0:A.width})}};k.useEffect(()=>{g&&!b&&f()},[g,b]),k.useEffect(()=>{if(b)return;const m=A=>{var Z;Y!=null&&Y.current&&!((Z=Y==null?void 0:Y.current)!=null&&Z.contains(A==null?void 0:A.target))&&(M(!1),se(""),T(-1))};return document==null||document.addEventListener("mousedown",m),()=>document==null?void 0:document.removeEventListener("mousedown",m)},[b]);const q=m=>{if(!b){if(!g){((m==null?void 0:m.key)==="Enter"||(m==null?void 0:m.key)===" "||(m==null?void 0:m.key)==="ArrowDown")&&(m==null||m.preventDefault(),M(!0),u&&setTimeout(()=>{var A;return(A=ie==null?void 0:ie.current)==null?void 0:A.focus()},0));return}switch(m==null?void 0:m.key){case"Escape":M(!1),se(""),T(-1);break;case"ArrowDown":m==null||m.preventDefault(),T(A=>A<($==null?void 0:$.length)-1?A+1:0);break;case"ArrowUp":m==null||m.preventDefault(),T(A=>A>0?A-1:($==null?void 0:$.length)-1);break;case"Enter":m==null||m.preventDefault(),S>=0&&($!=null&&$[S])&&je($==null?void 0:$[S]);break;case"Tab":M(!1),se(""),T(-1);break}}},je=m=>{l==null||l(m==null?void 0:m.id),M(!1),se(""),T(-1)},ke=m=>{m==null||m.stopPropagation(),l==null||l(null)};return b?e.jsxs("div",{className:`relative ${N}`,children:[e.jsxs("select",{value:x||"",onChange:m=>{var A;return l==null?void 0:l(((A=m==null?void 0:m.target)==null?void 0:A.value)||null)},disabled:o||p,className:`
            w-full px-3 py-2 border rounded-lg
            ${y?"border-red-500":"border-gray-300"}
            ${o||p?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:i}),r==null?void 0:r.map(m=>e.jsx("option",{value:(m==null?void 0:m[j])||(m==null?void 0:m.id),children:(m==null?void 0:m[v])||(m==null?void 0:m.label)||(m==null?void 0:m.name)},(m==null?void 0:m[j])||(m==null?void 0:m.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(le,{name:"ChevronDown",size:16,className:"text-gray-400"})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]}):e.jsxs("div",{className:`relative ${N}`,ref:Y,children:[e.jsxs("button",{type:"button",onClick:()=>!o&&!p&&M(!g),onKeyDown:q,disabled:o||p,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${y?"border-red-500":"border-gray-300"}
          ${o||p?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${g?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:re?"text-gray-900":"text-gray-500",children:re?(re==null?void 0:re[v])||(re==null?void 0:re.label):i}),e.jsxs("div",{className:"flex items-center space-x-1",children:[p&&e.jsx(le,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),d&&re&&!p&&e.jsx("button",{type:"button",onClick:ke,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(le,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(le,{name:g?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),g&&typeof window<"u"&&e.jsx(_s,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>M(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${R==null?void 0:R.top}px`,left:`${R==null?void 0:R.left}px`,width:`${R==null?void 0:R.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:m=>m==null?void 0:m.stopPropagation(),children:[u&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:c,onChange:m=>{var A;return se((A=m==null?void 0:m.target)==null?void 0:A.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:($==null?void 0:$.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:c?"No results found":"No options available"}):$==null?void 0:$.map(m=>e.jsx("button",{type:"button",onClick:()=>je(m),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${G(m)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(m==null?void 0:m[v])||(m==null?void 0:m.label)||(m==null?void 0:m.name)},(m==null?void 0:m[j])||(m==null?void 0:m.id)))})]})})}),y&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:y})]})},ws=({isOpen:r,dealId:x,deal:l,onClose:i,onSuccess:u})=>{var fe,ge,pe,ye,H,ae,Ne;const[d,o]=k.useState(!0),[p,y]=k.useState(!1),[N,v]=k.useState(""),[j,F]=k.useState(!1),[ee,I]=k.useState(!1),[w,g]=k.useState(!1),[M,c]=k.useState(!1),[se,b]=k.useState(null),[O,$]=k.useState(null),[P,S]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:T,deliveryCoordinatorOptions:R,financeManagerOptions:xe,vendorOptions:Y,productOptions:ie,loading:re,refresh:G}=Ns(),[f,q]=k.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),je=(a=[],n,L="Selected")=>!n||Array.isArray(a)&&a.some(z=>(z==null?void 0:z.id)===n)?a:[...a||[],{id:n,value:n,label:L}],ke=k.useMemo(()=>je(Y,f==null?void 0:f.vendor_id,"Selected vendor"),[Y,f==null?void 0:f.vendor_id]),m=k.useMemo(()=>je(T,f==null?void 0:f.assignedTo,"Selected user"),[T,f==null?void 0:f.assignedTo]),A=k.useMemo(()=>je(R,f==null?void 0:f.deliveryCoordinator,"Selected user"),[R,f==null?void 0:f.deliveryCoordinator]),Z=k.useMemo(()=>je(xe,f==null?void 0:f.financeManager,"Selected user"),[xe,f==null?void 0:f.financeManager]);k.useEffect(()=>{if(se){const a=JSON.stringify(f)!==JSON.stringify(se);g(a)}},[f,se]),k.useEffect(()=>{if(r)try{G==null||G()}catch{}},[r,G]),k.useEffect(()=>{var a;if(r)if(l&&(l!=null&&l.id))try{const n=Re(l),L={...n,assignedTo:(n==null?void 0:n.assigned_to)||null,deliveryCoordinator:(n==null?void 0:n.delivery_coordinator_id)||null,financeManager:(n==null?void 0:n.finance_manager_id)||null,vendor_id:(n==null?void 0:n.vendor_id)||null,customerName:(l==null?void 0:l.customer_name)||"",customerPhone:(l==null?void 0:l.customer_phone)||"",customerEmail:(l==null?void 0:l.customer_email)||"",lineItems:((a=(n==null?void 0:n.lineItems)||[])==null?void 0:a.length)>0?te(n==null?void 0:n.lineItems):[Q()]};q(L),b(JSON.parse(JSON.stringify(L))),o(!1),v("")}catch(n){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",n),ne()}else x?ne():(v("No deal selected to edit."),o(!1))},[r,x,l==null?void 0:l.id]),k.useEffect(()=>{if(!r||!d)return;const a=setTimeout(()=>{o(!1),v(n=>n||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(a)},[r,d]);const t=({checked:a,onChange:n})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!a,onChange:L=>{var z;return n(!!((z=L==null?void 0:L.target)!=null&&z.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),_=({value:a,selectedValue:n,onChange:L,itemIndex:z,disabled:oe=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${z}`,value:"in_house",checked:!n,onChange:()=>L(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:oe}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏠 On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${z}`,value:"vendor",checked:n,onChange:()=>L(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:oe}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"🏢 Off-Site"})]})]}),C=({requiresScheduling:a,onChange:n,itemIndex:L,disabled:z=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${L}`,checked:a===!0,onChange:()=>n(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:z}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${L}`,checked:a===!1,onChange:()=>n(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:z}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),te=(a=[])=>(a||[]).map(n=>({product_id:(n==null?void 0:n.product_id)??null,unit_price:(n==null?void 0:n.unit_price)??0,quantity_used:(n==null?void 0:n.quantity_used)??1,lineItemPromisedDate:(n==null?void 0:n.lineItemPromisedDate)||(n==null?void 0:n.promised_date)||"",requiresScheduling:typeof(n==null?void 0:n.requiresScheduling)=="boolean"?n==null?void 0:n.requiresScheduling:!!(n!=null&&n.requires_scheduling),noScheduleReason:(n==null?void 0:n.noScheduleReason)||(n==null?void 0:n.no_schedule_reason)||"",isOffSite:typeof(n==null?void 0:n.isOffSite)=="boolean"?n==null?void 0:n.isOffSite:!!(n!=null&&n.is_off_site),description:(n==null?void 0:n.description)||""})),ne=async()=>{var a,n,L,z,oe,D,J,X,he,qe;try{o(!0),v("");const Ee=await is(x),ue=Re(Ee),{data:we}=await((z=(L=(n=(a=K)==null?void 0:a.from("transactions"))==null?void 0:n.select("customer_name, customer_phone, customer_email"))==null?void 0:L.eq("job_id",x))==null?void 0:z.single());let ve=null;try{const{data:Se}=await((he=(X=(J=(D=(oe=K)==null?void 0:oe.from("loaner_assignments"))==null?void 0:D.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:J.eq("job_id",x))==null?void 0:X.is("returned_at",null))==null?void 0:he.limit(1));ve=Array.isArray(Se)?Se[0]:Se}catch{}const Te={...ue,assignedTo:(ue==null?void 0:ue.assigned_to)||null,deliveryCoordinator:(ue==null?void 0:ue.delivery_coordinator_id)||null,financeManager:(ue==null?void 0:ue.finance_manager_id)||null,vendor_id:(ue==null?void 0:ue.vendor_id)||null,customerName:(we==null?void 0:we.customer_name)||"",customerPhone:(we==null?void 0:we.customer_phone)||"",customerEmail:(we==null?void 0:we.customer_email)||"",lineItems:((qe=(ue==null?void 0:ue.lineItems)||[])==null?void 0:qe.length)>0?te(ue==null?void 0:ue.lineItems):[Q()]};if(q(Te),b(JSON.parse(JSON.stringify(Te))),$(ve||null),ve)S({loaner_number:(ve==null?void 0:ve.loaner_number)||"",eta_return_date:(ve==null?void 0:ve.eta_return_date)||"",notes:(ve==null?void 0:ve.notes)||""});else{const Se=((Te==null?void 0:Te.lineItems)||[]).filter(_e=>(_e==null?void 0:_e.requiresScheduling)&&(_e==null?void 0:_e.lineItemPromisedDate)).map(_e=>new Date(_e.lineItemPromisedDate).getTime()),ze=Se!=null&&Se.length?new Date(Math.max(...Se)):null;S(_e=>({..._e,eta_return_date:ze?ze.toISOString().split("T")[0]:""}))}}catch(Ee){v(`Failed to load deal: ${Ee==null?void 0:Ee.message}`)}finally{o(!1)}},Q=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),U=a=>{q(n=>({...n,...a}))},ce=(a,n)=>{if(q(L=>{var z;return{...L,lineItems:(z=L==null?void 0:L.lineItems)==null?void 0:z.map((oe,D)=>{if(D===a){let J={...oe,...n};return"requiresScheduling"in n&&(J.requiresScheduling=!!(n!=null&&n.requiresScheduling),(n==null?void 0:n.requiresScheduling)===!0?J.noScheduleReason="":J.lineItemPromisedDate=""),"isOffSite"in n&&(J.isOffSite=!!(n!=null&&n.isOffSite),n!=null&&n.isOffSite||(J.vendorId="")),J}return oe})}}),n!=null&&n.product_id){const L=ie==null?void 0:ie.find(z=>(z==null?void 0:z.id)===(n==null?void 0:n.product_id));L&&q(z=>{var oe;return{...z,lineItems:(oe=z==null?void 0:z.lineItems)==null?void 0:oe.map((D,J)=>J===a?{...D,unit_price:(L==null?void 0:L.unitPrice)||(L==null?void 0:L.unit_price)||(D==null?void 0:D.unit_price),cost_price:(L==null?void 0:L.cost)||(D==null?void 0:D.cost_price)}:D)}})}},s=()=>{q(a=>({...a,lineItems:[...a==null?void 0:a.lineItems,Q()]}))},h=a=>{q(n=>{var L;return{...n,lineItems:(L=n==null?void 0:n.lineItems)==null?void 0:L.filter((z,oe)=>oe!==a)}})},E=async()=>{var a,n,L,z,oe;try{if(y(!0),v(""),!((a=f==null?void 0:f.customerName)!=null&&a.trim())){v("Customer name is required");return}for(let X=0;X<((n=f==null?void 0:f.lineItems)==null?void 0:n.length);X++){const he=(L=f==null?void 0:f.lineItems)==null?void 0:L[X];if(!(he!=null&&he.product_id)){v(`Line item ${X+1}: Product is required`);return}if(he!=null&&he.requiresScheduling&&!(he!=null&&he.lineItemPromisedDate)){v(`Line item ${X+1}: Promised date is required when scheduling is needed`);return}if(!(he!=null&&he.requiresScheduling)&&!((z=he==null?void 0:he.noScheduleReason)!=null&&z.trim())){v(`Line item ${X+1}: Reason is required when no scheduling is needed`);return}}const D={...f,customer_needs_loaner:!!(f!=null&&f.customer_needs_loaner),lineItems:(oe=f==null?void 0:f.lineItems)==null?void 0:oe.map(X=>({...X,requiresScheduling:!!(X!=null&&X.requiresScheduling),isOffSite:!!(X!=null&&X.isOffSite),unit_price:parseFloat(X==null?void 0:X.unit_price)||0,quantity_used:parseInt(X==null?void 0:X.quantity_used)||1}))},J={...D,assigned_to:(D==null?void 0:D.assignedTo)??null,delivery_coordinator_id:(D==null?void 0:D.deliveryCoordinator)??null,finance_manager_id:(D==null?void 0:D.financeManager)??null,vendor_id:(D==null?void 0:D.vendor_id)??null};await os(x,{...J,loanerForm:P}),u==null||u(),i==null||i()}catch(D){v(`Failed to save deal: ${D==null?void 0:D.message}`)}finally{y(!1)}},B=async()=>{try{I(!0),await ds(x),u==null||u(),i==null||i()}catch(a){v(`Failed to delete deal: ${a==null?void 0:a.message}`)}finally{I(!1),F(!1)}},V=()=>{w?c(!0):i()},de=()=>{c(!1),i()},me=()=>{var a;return((a=f==null?void 0:f.lineItems)==null?void 0:a.reduce((n,L)=>{const z=parseFloat(L==null?void 0:L.unit_price)||0,oe=parseInt(L==null?void 0:L.quantity_used)||1;return n+z*oe},0))||0};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:V,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(le,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[N&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:N})}),d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{ne();try{G==null||G()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Ae,{value:f==null?void 0:f.job_status,onChange:a=>{var n;return U({job_status:(n=a==null?void 0:a.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(be,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:f==null?void 0:f.customerName,onChange:a=>{var n;return U({customerName:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(be,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:f==null?void 0:f.customerPhone,onChange:a=>{var n;return U({customerPhone:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(be,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:f==null?void 0:f.customerEmail,onChange:a=>{var n;return U({customerEmail:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Ae,{value:f==null?void 0:f.priority,onChange:a=>{var n;return U({priority:(n=a==null?void 0:a.target)==null?void 0:n.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(be,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(f==null?void 0:f.vehicleYear)||"",onChange:a=>{var n;return U({vehicleYear:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"2024",min:"1900",max:((fe=new Date)==null?void 0:fe.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(be,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(f==null?void 0:f.vehicleMake)||"",onChange:a=>{var n;return U({vehicleMake:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(be,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(f==null?void 0:f.vehicleModel)||"",onChange:a=>{var n;return U({vehicleModel:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(be,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(f==null?void 0:f.stockNumber)||"",onChange:a=>{var n;return U({stockNumber:(n=a==null?void 0:a.target)==null?void 0:n.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(t,{checked:f==null?void 0:f.customer_needs_loaner,onChange:a=>{if(U({customer_needs_loaner:a}),a&&!(P!=null&&P.eta_return_date)){const n=((f==null?void 0:f.lineItems)||[]).filter(z=>(z==null?void 0:z.requiresScheduling)&&(z==null?void 0:z.lineItemPromisedDate)).map(z=>new Date(z.lineItemPromisedDate).getTime()),L=n!=null&&n.length?new Date(Math.max(...n)):null;L&&S(z=>({...z,eta_return_date:L.toISOString().split("T")[0]}))}}}),O&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",O==null?void 0:O.loaner_number,(O==null?void 0:O.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["• due"," ",(ge=new Date(O==null?void 0:O.eta_return_date))==null?void 0:ge.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(f==null?void 0:f.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(be,{id:"loaner-number","aria-label":"Loaner number",value:(P==null?void 0:P.loaner_number)||"",onChange:a=>S(n=>{var L;return{...n,loaner_number:(L=a==null?void 0:a.target)==null?void 0:L.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(be,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(P==null?void 0:P.eta_return_date)||"",onChange:a=>S(n=>{var L;return{...n,eta_return_date:(L=a==null?void 0:a.target)==null?void 0:L.value}}),min:(H=(ye=(pe=new Date)==null?void 0:pe.toISOString())==null?void 0:ye.split("T"))==null?void 0:H[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(be,{id:"loaner-notes","aria-label":"Loaner notes",value:(P==null?void 0:P.notes)||"",onChange:a=>S(n=>{var L;return{...n,notes:(L=a==null?void 0:a.target)==null?void 0:L.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"mb-4","data-testid":"vendor-select",children:[e.jsx(Le,{label:"Vendor",options:ke,value:(f==null?void 0:f.vendor_id)||"",onChange:a=>U({vendor_id:a||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"}),!re&&((Y==null?void 0:Y.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"sales-select",children:[e.jsx(Le,{label:"Sales Consultant",options:m,value:f==null?void 0:f.assignedTo,onChange:a=>U({assignedTo:a}),placeholder:"Select sales consultant",searchable:!0,clearable:!0}),!re&&((T==null?void 0:T.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"delivery-select",children:[e.jsx(Le,{label:"Delivery Coordinator",options:A,value:f==null?void 0:f.deliveryCoordinator,onChange:a=>U({deliveryCoordinator:a}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0}),!re&&((R==null?void 0:R.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{"data-testid":"finance-select",children:[e.jsx(Le,{label:"Finance Manager",options:Z,value:f==null?void 0:f.financeManager,onChange:a=>U({financeManager:a}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"}),!re&&((xe==null?void 0:xe.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(W,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:s,children:[e.jsx(le,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(ae=f==null?void 0:f.lineItems)==null?void 0:ae.map((a,n)=>{var L,z,oe,D;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",n+1]}),((L=f==null?void 0:f.lineItems)==null?void 0:L.length)>1&&e.jsx(W,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>h(n),children:e.jsx(le,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Le,{label:"Product *",options:ie,value:(a==null?void 0:a.product_id)||"",onChange:J=>ce(n,{product_id:J?parseInt(J):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(be,{id:`unit-price-${n}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:a==null?void 0:a.unit_price,onChange:J=>{var X;return ce(n,{unit_price:parseFloat((X=J==null?void 0:J.target)==null?void 0:X.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(be,{id:`quantity-${n}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:a==null?void 0:a.quantity_used,onChange:J=>{var X;return ce(n,{quantity_used:parseInt((X=J==null?void 0:J.target)==null?void 0:X.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(_,{selectedValue:a==null?void 0:a.isOffSite,onChange:J=>ce(n,{isOffSite:J}),itemIndex:n})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx(C,{requiresScheduling:a==null?void 0:a.requiresScheduling,onChange:J=>ce(n,{requiresScheduling:J}),itemIndex:n})}),a!=null&&a.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(be,{id:`promised-date-${n}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:a==null?void 0:a.lineItemPromisedDate,onChange:J=>{var X;return ce(n,{lineItemPromisedDate:(X=J==null?void 0:J.target)==null?void 0:X.value})},min:(D=(oe=(z=new Date)==null?void 0:z.toISOString())==null?void 0:oe.split("T"))==null?void 0:D[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(be,{id:`notes-${n}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(a==null?void 0:a.description)||"",onChange:J=>{var X;return ce(n,{description:(X=J==null?void 0:J.target)==null?void 0:X.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(be,{id:`no-schedule-reason-${n}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:a==null?void 0:a.noScheduleReason,onChange:J=>{var X;return ce(n,{noScheduleReason:(X=J==null?void 0:J.target)==null?void 0:X.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(a==null?void 0:a.unit_price)||0)*(parseInt(a==null?void 0:a.quantity_used)||1)).toFixed(2)]})]},n)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(Ne=me())==null?void 0:Ne.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(W,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>F(!0),children:[e.jsx(le,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(W,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:V,children:"Cancel"}),e.jsx(W,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:E,disabled:p,children:p?"Saving...":"Save Changes"})]})]}),j&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(W,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>F(!1),children:"Cancel"}),e.jsx(W,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:B,disabled:ee,children:ee?"Deleting...":"Delete"})]})]})}),M&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(W,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>c(!1),children:"Keep Editing"}),e.jsx(W,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:de,children:"Discard Changes"})]})]})})]})}):null},Ue=({status:r})=>{var u;const x={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},l=(x==null?void 0:x[r])||"bg-gray-100 text-gray-700",i=((u=r==null?void 0:r.replace("_"," "))==null?void 0:u.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${l}`,children:i})},Ss=r=>{try{if(!r)return"—";const x=new Date(r);if(Number.isNaN(x.getTime()))return"—";const l=Date.now()-x.getTime(),i=Math.floor(l/1e3),u=Math.floor(i/60),d=Math.floor(u/60),o=Math.floor(d/24);return o>0?`${o}d ago`:d>0?`${d}h ago`:u>0?`${u}m ago`:"just now"}catch{return"—"}},Ye=({nextPromisedAt:r})=>{var y;if(!r)return e.jsx("span",{className:"text-xs text-gray-500",children:"—"});const x=new Date,i=new Date(r)-x,u=i<0,d=i>=0&&i<24*60*60*1e3,o=u?"bg-red-100 text-red-800 border-red-200":d?"bg-amber-100 text-amber-800 border-amber-200":"bg-green-100 text-green-800 border-green-200",p=(y=new Date(r))==null?void 0:y.toLocaleDateString("en-US",{month:"short",day:"numeric"});return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${o}`,children:["Next: ",p]})},Je=({serviceType:r,jobParts:x})=>{const l=x==null?void 0:x.some(u=>u==null?void 0:u.is_off_site),i=x==null?void 0:x.some(u=>!(u!=null&&u.is_off_site));return l&&i?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})]}):l?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#f97316"},children:"🏢 Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"🏠 In-House"})},ks=({draftsCount:r,onViewDrafts:x})=>{const[l,i]=k.useState(!1);return r===0||l?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(le,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft – needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",r," draft deal",r>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(W,{size:"sm",variant:"ghost",onClick:x,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>i(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(le,{name:"X",size:16})})]})]})})},Me=r=>r?r!=null&&r.job_number?r.job_number:r!=null&&r.id?`Job-${String(r.id).slice(0,8)}`:"—":"—",rs=r=>r&&(r==null?void 0:r.customer_name)||"",Ke=({deal:r})=>!(r!=null&&r.customer_name)&&!(r!=null&&r.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"—"}):e.jsxs("div",{className:"space-y-1",children:[(r==null?void 0:r.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:r==null?void 0:r.customer_name}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:x=>x==null?void 0:x.stopPropagation(),children:r==null?void 0:r.customer_phone})]}),We=({amount:r})=>{var l;const x=parseFloat(r)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:l.format(x)})})},Xe=({deal:r})=>r!=null&&r.loaner_number?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["🚗 Loaner #",r==null?void 0:r.loaner_number,(r==null?void 0:r.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["• due ",r==null?void 0:r.loaner_eta_short]})]}):null,Cs=({isOpen:r,onClose:x,deal:l,onSave:i,loading:u})=>{var v,j,F,ee;const[d,o]=k.useState({loaner_number:"",eta_return_date:"",notes:""}),[p,y]=k.useState("");k.useEffect(()=>{if(r&&l){let I="";try{const w=((l==null?void 0:l.job_parts)||[]).filter(g=>(g==null?void 0:g.requires_scheduling)&&(g==null?void 0:g.promised_date)).map(g=>new Date(g.promised_date));(w==null?void 0:w.length)>0&&(I=new Date(Math.max.apply(null,w)).toISOString().split("T")[0])}catch{}o({loaner_number:(l==null?void 0:l.loaner_number)||"",eta_return_date:(l==null?void 0:l.loaner_eta_return_date)||I||"",notes:(l==null?void 0:l.loaner_notes)||""}),y("")}else r||(o({loaner_number:"",eta_return_date:"",notes:""}),y(""))},[r,l]);const N=async()=>{var I,w,g;if(y(""),!((I=d==null?void 0:d.loaner_number)!=null&&I.trim())){y("Loaner number is required");return}if(!(d!=null&&d.eta_return_date)){y("ETA return date is required");return}try{await i({job_id:l==null?void 0:l.id,loaner_number:(w=d==null?void 0:d.loaner_number)==null?void 0:w.trim(),eta_return_date:d==null?void 0:d.eta_return_date,notes:((g=d==null?void 0:d.notes)==null?void 0:g.trim())||null}),x()}catch(M){y((M==null?void 0:M.message)||"Failed to save loaner assignment")}};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:x}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(W,{variant:"ghost",size:"icon",onClick:x,"aria-label":"Close drawer",children:e.jsx(le,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:Me(l)}),e.jsx("p",{className:"text-xs text-slate-500",children:rs(l)})]}),p&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:p}),e.jsx("button",{onClick:()=>y(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:d==null?void 0:d.loaner_number,onChange:I=>o(w=>{var g;return{...w,loaner_number:(g=I==null?void 0:I.target)==null?void 0:g.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:d==null?void 0:d.eta_return_date,onChange:I=>o(w=>{var g;return{...w,eta_return_date:(g=I==null?void 0:I.target)==null?void 0:g.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(F=(j=(v=new Date)==null?void 0:v.toISOString())==null?void 0:j.split("T"))==null?void 0:F[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:d==null?void 0:d.notes,onChange:I=>o(w=>{var g;return{...w,notes:(g=I==null?void 0:I.target)==null?void 0:g.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(W,{variant:"outline",onClick:x,className:"flex-1 h-11",disabled:u,children:"Cancel"}),e.jsx(W,{onClick:N,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:u||!((ee=d==null?void 0:d.loaner_number)!=null&&ee.trim())||!(d!=null&&d.eta_return_date),children:u?"Saving...":"Save Loaner"})]})]})})]}):null},Es=({loaner:r,onClose:x,onConfirm:l,loading:i})=>r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",r==null?void 0:r.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(W,{variant:"outline",onClick:x,className:"flex-1 h-11",disabled:i,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(W,{onClick:l,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:i,"aria-label":"Confirm loaner returned",children:i?"Processing...":"Mark Returned"})]})]})})}):null;function Fs(){var ce;const[r,x]=k.useState([]),[l,i]=k.useState(!0),[u,d]=k.useState(!1),[o,p]=k.useState(!1),[y,N]=k.useState(null),[v,j]=k.useState(null),[F,ee]=k.useState(null),[I,w]=k.useState(""),[g,M]=k.useState({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),[c,se]=k.useState(!1),[b,O]=k.useState(null),[$,P]=k.useState(!1),[S,T]=k.useState(null),[R,xe]=k.useState(!1),[Y,ie]=k.useState(""),{clearSearch:re,error:G}=ss({loadOnMount:!0});bs();const{user:f}=Ie(),q=async s=>{var h;try{w("");const{error:E}=await((h=K)==null?void 0:h.rpc("delete_job_cascade",{p_job_id:s}));if(E)throw E;ee(null),await m()}catch(E){w(`Failed to delete deal: ${E==null?void 0:E.message}`),console.error("Delete error:",E)}},je=async s=>{var h,E,B,V,de,me,fe,ge,pe,ye;try{P(!0),w("");let H=null;try{const{data:ae}=await((de=(V=(B=(E=(h=K)==null?void 0:h.from("loaner_assignments"))==null?void 0:E.select("id"))==null?void 0:B.eq("job_id",s==null?void 0:s.job_id))==null?void 0:V.is("returned_at",null))==null?void 0:de.limit(1));H=Array.isArray(ae)?ae[0]:ae}catch{}if(H!=null&&H.id){const{error:ae}=await((ge=(fe=(me=K)==null?void 0:me.from("loaner_assignments"))==null?void 0:fe.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:ge.eq("id",H.id));if(ae)throw ae}else{const{error:ae}=await((ye=(pe=K)==null?void 0:pe.from("loaner_assignments"))==null?void 0:ye.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(ae)throw ae}se(!1),O(null),await m()}catch(H){const ae=`Failed to save loaner assignment: ${H==null?void 0:H.message}`;throw w(ae),new Error(ae)}finally{P(!1)}},ke=async s=>{try{xe(!0),w(""),await us(s==null?void 0:s.loaner_id),T(null),await m()}catch(h){w(`Failed to mark loaner as returned: ${h==null?void 0:h.message}`),console.error("Mark returned error:",h)}finally{xe(!1)}},m=async(s=0)=>{var h,E;try{i(!0),w("");const B=await xs();x(B||[])}catch(B){const V=`Failed to load deals: ${B==null?void 0:B.message}`;if(console.error("Load deals error:",B),s<2&&((h=B==null?void 0:B.message)!=null&&h.includes("fetch")||(E=B==null?void 0:B.message)!=null&&E.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>m(s+1),1e3*(s+1));return}w(V),x([])}finally{i(!1)}};k.useEffect(()=>{var E;const s=new URLSearchParams(window.location.search),h=s==null?void 0:s.get("status");if(h){const B=((E=h==null?void 0:h.charAt(0))==null?void 0:E.toUpperCase())+(h==null?void 0:h.slice(1));M(V=>({...V,status:B}))}},[]),k.useEffect(()=>{m()},[]);const A=s=>{O(s),se(!0)},Z=({message:s,onClose:h})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(le,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),h&&e.jsx("button",{onClick:h,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(le,{name:"X",size:16})})]})}):null,_=(s=>{var ge,pe,ye;const h=s||[],E=((ge=h==null?void 0:h.filter(H=>(H==null?void 0:H.job_status)==="in_progress"))==null?void 0:ge.length)||0,B=h==null?void 0:h.reduce((H,ae)=>{const Ne=parseFloat(ae==null?void 0:ae.total_amount)||0;return H+Ne},0),V=B*.25,de=B>0?25:0,me=((pe=h==null?void 0:h.filter(H=>(H==null?void 0:H.job_status)==="pending"))==null?void 0:pe.length)||0,fe=((ye=h==null?void 0:h.filter(H=>(H==null?void 0:H.job_status)==="draft"))==null?void 0:ye.length)||0;return{active:E,revenue:(B==null?void 0:B.toFixed(2))||"0.00",profit:(V==null?void 0:V.toFixed(2))||"0.00",margin:(de==null?void 0:de.toFixed(1))||"0.0",pending:me,drafts:fe}})(r),C=r==null?void 0:r.filter(s=>{var h,E,B,V,de;if((g==null?void 0:g.status)!=="All"){const me=(E=(h=g==null?void 0:g.status)==null?void 0:h.toLowerCase())==null?void 0:E.replace(" ","_");if((s==null?void 0:s.job_status)!==me)return!1}if(g!=null&&g.salesAssigned&&(s==null?void 0:s.assigned_to)!==(g==null?void 0:g.salesAssigned)||g!=null&&g.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(g==null?void 0:g.deliveryAssigned)||g!=null&&g.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(g==null?void 0:g.financeAssigned)||g!=null&&g.vendor&&(s==null?void 0:s.vendor_id)!==(g==null?void 0:g.vendor))return!1;if(Y!=null&&Y.trim()){const me=Y==null?void 0:Y.toLowerCase(),fe=H=>(H==null?void 0:H.replace(/\D/g,""))||"",ge=fe(me),pe=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(B=s==null?void 0:s.vehicle)==null?void 0:B.make,(V=s==null?void 0:s.vehicle)==null?void 0:V.model,((de=s==null?void 0:s.vehicle)==null?void 0:de.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(pe==null?void 0:pe.some(H=>{var Ne;const ae=H==null?void 0:H.toLowerCase();return!!(ae!=null&&ae.includes(me)||(ge==null?void 0:ge.length)>=3&&((Ne=fe(ae))!=null&&Ne.includes(ge)))})))return!1}return!0});k.useEffect(()=>{const s=setTimeout(()=>{ie(g==null?void 0:g.search)},300);return()=>clearTimeout(s)},[g==null?void 0:g.search]);const te=(s,h)=>{var E,B;if(M(V=>({...V,[s]:h})),s==="status"){const V=new URLSearchParams(window.location.search);h==="All"?V==null||V.delete("status"):V==null||V.set("status",h==null?void 0:h.toLowerCase());const de=`${(E=window.location)==null?void 0:E.pathname}${V!=null&&V.toString()?"?"+(V==null?void 0:V.toString()):""}`;(B=window.history)==null||B.replaceState({},"",de)}},ne=()=>{var s,h;M({status:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,search:""}),re(),(h=window.history)==null||h.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},Q=s=>{var h;N(s);try{const E=(h=C!=null&&C.length?C:r)==null?void 0:h.find(B=>(B==null?void 0:B.id)===s);j(E||null)}catch{j(null)}p(!0)},U=()=>{p(!1),N(null),j(null)};return l?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Be,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Be,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(Z,{message:I||G,onClose:()=>{w("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ps,{exportType:"jobs",filters:{status:g==null?void 0:g.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,h)=>console.log(`Export complete: ${s} records`),onExportError:s=>w(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(W,{onClick:()=>d(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(le,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(ks,{draftsCount:_==null?void 0:_.drafts,onViewDrafts:()=>te("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(le,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:_==null?void 0:_.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(le,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",_==null?void 0:_.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(le,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",_==null?void 0:_.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(le,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[_==null?void 0:_.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(le,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:_==null?void 0:_.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(le,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:_==null?void 0:_.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>te("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(g==null?void 0:g.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(le,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:g==null?void 0:g.search,onChange:s=>{var h;return te("search",(h=s==null?void 0:s.target)==null?void 0:h.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(W,{variant:"ghost",size:"sm",onClick:ne,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(le,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",C==null?void 0:C.length," of ",r==null?void 0:r.length," deals",((g==null?void 0:g.salesAssigned)||(g==null?void 0:g.deliveryAssigned)||(g==null?void 0:g.financeAssigned)||(g==null?void 0:g.vendor)||(g==null?void 0:g.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Promise"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Appt Window"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vehicle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"$/Margin"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Work"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Last Activity"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:C==null?void 0:C.map(s=>{var h,E,B,V,de,me;return e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ue,{status:s==null?void 0:s.job_status})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:typeof(s==null?void 0:s.age_days)=="number"?`${s==null?void 0:s.age_days}d`:"—"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ye,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.appt_start?e.jsxs("span",{className:"text-sm text-slate-700",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," • ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"–",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):e.jsx("span",{className:"text-xs text-gray-500",children:"—"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ke,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[(s==null?void 0:s.customer_phone_e164)||(s==null?void 0:s.customer_phone)||"—",s!=null&&s.customer_phone_last4?e.jsxs("span",{className:"text-slate-400",children:[" ","(",`…${s==null?void 0:s.customer_phone_last4}`,")"]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[s!=null&&s.vehicle?`${((h=s==null?void 0:s.vehicle)==null?void 0:h.year)||""} ${((E=s==null?void 0:s.vehicle)==null?void 0:E.make)||""} ${((B=s==null?void 0:s.vehicle)==null?void 0:B.model)||""}`.trim():"—",(V=s==null?void 0:s.vehicle)!=null&&V.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","• Stock: ",(de=s==null?void 0:s.vehicle)==null?void 0:de.stock_number]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(We,{amount:s==null?void 0:s.total_amount}),e.jsxs("span",{className:"text-xs text-slate-500",children:["est."," ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(s==null?void 0:s.total_amount)||0)*.25)]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[((s==null?void 0:s.work_tags)||[]).map(fe=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 border border-slate-200",children:fe},fe)),(!(s!=null&&s.work_tags)||((me=s==null?void 0:s.work_tags)==null?void 0:me.length)===0)&&e.jsx("span",{className:"text-xs text-gray-500",children:"—"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:(s==null?void 0:s.vendor_name)||"Unassigned"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Je,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:Ss(s==null?void 0:s.created_at)})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.loaner_number||s!=null&&s.has_active_loaner?e.jsx(Xe,{deal:s}):e.jsx("span",{className:"text-xs text-gray-500",children:"—"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(W,{size:"sm",variant:"ghost",onClick:()=>Q(s==null?void 0:s.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(W,{size:"sm",variant:"ghost",onClick:()=>A(s),className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(W,{size:"sm",variant:"ghost",onClick:()=>T({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)}),className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(W,{size:"sm",variant:"ghost",onClick:()=>ee(s),className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(C==null?void 0:C.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(g==null?void 0:g.status)==="All"?"No deals found":`No ${(ce=g==null?void 0:g.status)==null?void 0:ce.toLowerCase()} deals found`})}):C==null?void 0:C.map(s=>e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Me(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:rs(s)||"—"})]}),e.jsx(Ue,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[((s==null?void 0:s.customer_name)||(s==null?void 0:s.customer_phone))&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Customer"}),e.jsx(Ke,{deal:s})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Value"}),e.jsx(We,{amount:s==null?void 0:s.total_amount})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Next"}),e.jsx(Ye,{nextPromisedAt:s==null?void 0:s.next_promised_iso})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Service"}),e.jsx(Je,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})]}),(s==null?void 0:s.loaner_number)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1",children:"Loaner Assignment"}),e.jsx(Xe,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(W,{size:"sm",variant:"outline",onClick:()=>Q(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(le,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(W,{size:"sm",variant:"outline",onClick:()=>ee(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(le,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(W,{size:"sm",variant:"outline",onClick:()=>A(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(le,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(W,{size:"sm",variant:"outline",onClick:()=>A(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(le,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(W,{size:"sm",variant:"outline",onClick:()=>T({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Me(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(le,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id))}),e.jsx(js,{isOpen:u,onClose:()=>d(!1),onSuccess:m}),e.jsx(ws,{isOpen:o,dealId:y,deal:v,onClose:U,onSuccess:()=>{m(),U()}}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(W,{variant:"outline",onClick:()=>ee(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(W,{onClick:()=>q(F==null?void 0:F.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(Cs,{isOpen:c,onClose:()=>{se(!1),O(null),w("")},deal:b,onSave:je,loading:$}),e.jsx(Es,{loaner:S,onClose:()=>{T(null),w("")},onConfirm:()=>ke(S),loading:R})]})]})}export{Fs as default};
//# sourceMappingURL=index-BrvoVtbs.js.map
