import{s as D,u as He,j as e,B as z,S as Je,I as Ge,a as ns,g as as,b as ls,c as cs,d as is,e as os,p as We,f as hs,h as ms,i as gs,k as bs,l as ke}from"./index-CsUHg1Df.js";import{r as S,R as ds}from"./react-Czq5O75u.js";import{dealService as Ke,mapDbDealToForm as Ze,getDeal as fs,updateDeal as ps,deleteDeal as js,markLoanerReturned as vs,getAllDeals as ys}from"./dealService-th_4Casr.js";import{s as Ue,t as Ns}from"./options-CllavUpK.js";import{I as H}from"./Icon-CEIKjzFD.js";import{l as _s}from"./vendorService-BlefxV3H.js";import{l as ws}from"./smsTemplateService-D8cpLpoS.js";import{N as Qe}from"./Navbar-Drk33yWo.js";import{a as Ss}from"./router-CZES1Sa0.js";import"./supabase-D02rA7zj.js";const ks=(t,x="")=>t==null?x:String(t),Fe={async getOverdueJobs(){var t;try{const{data:x,error:r}=await((t=D)==null?void 0:t.rpc("get_overdue_jobs_enhanced"));return r?(console.error("Error fetching overdue jobs:",r),{data:[],error:{message:r==null?void 0:r.message}}):{data:x||[],error:null}}catch(x){return console.error("Error in getOverdueJobs service:",x),{data:[],error:{message:"Failed to fetch overdue jobs"}}}},async getSmsTemplates(){var t,x,r,o;try{const{data:h,error:u}=await((o=(r=(x=(t=D)==null?void 0:t.from("sms_templates"))==null?void 0:x.select("*"))==null?void 0:r.eq("is_active",!0))==null?void 0:o.order("created_at",{ascending:!1}));return u?{data:[],error:{message:u==null?void 0:u.message}}:{data:h||[],error:null}}catch(h){return console.error("Error fetching SMS templates:",h),{data:[],error:{message:"Failed to fetch SMS templates"}}}},async createSmsTemplate(t){var x,r,o,h,u,d,f,p;try{const b=await((r=(x=D)==null?void 0:x.auth)==null?void 0:r.getUser()),{data:y,error:m}=await((p=(f=(d=(o=D)==null?void 0:o.from("sms_templates"))==null?void 0:d.insert([{...t,created_by:(u=(h=b==null?void 0:b.data)==null?void 0:h.user)==null?void 0:u.id}]))==null?void 0:f.select())==null?void 0:p.single());return m?{data:null,error:{message:m==null?void 0:m.message}}:{data:y,error:null}}catch(b){return console.error("Error creating SMS template:",b),{data:null,error:{message:"Failed to create SMS template"}}}},async updateSmsTemplate(t,x){var r,o,h,u,d,f;try{const{data:p,error:b}=await((f=(d=(u=(h=(r=D)==null?void 0:r.from("sms_templates"))==null?void 0:h.update({...x,updated_at:(o=new Date)==null?void 0:o.toISOString()}))==null?void 0:u.eq("id",t))==null?void 0:d.select())==null?void 0:f.single());return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:p,error:null}}catch(p){return console.error("Error updating SMS template:",p),{data:null,error:{message:"Failed to update SMS template"}}}},async deleteSmsTemplate(t){var x,r,o;try{const{error:h}=await((o=(r=(x=D)==null?void 0:x.from("sms_templates"))==null?void 0:r.delete())==null?void 0:o.eq("id",t));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting SMS template:",h),{error:{message:"Failed to delete SMS template"}}}},async getFilterPresets(t){var x,r,o,h,u,d,f,p,b;try{const y=await((r=(x=D)==null?void 0:x.auth)==null?void 0:r.getUser()),{data:m,error:M}=await((b=(p=(u=(h=(o=D)==null?void 0:o.from("filter_presets"))==null?void 0:h.select("*"))==null?void 0:u.eq("page_type",t))==null?void 0:p.or(`user_id.eq.${(f=(d=y==null?void 0:y.data)==null?void 0:d.user)==null?void 0:f.id},is_public.eq.true`))==null?void 0:b.order("created_at",{ascending:!1}));return M?{data:[],error:{message:M==null?void 0:M.message}}:{data:m||[],error:null}}catch(y){return console.error("Error fetching filter presets:",y),{data:[],error:{message:"Failed to fetch filter presets"}}}},async saveFilterPreset(t,x,r,o=!1){var h,u,d,f,p,b,y,m;try{const M=await((u=(h=D)==null?void 0:h.auth)==null?void 0:u.getUser()),{data:se,error:O}=await((m=(y=(b=(d=D)==null?void 0:d.from("filter_presets"))==null?void 0:b.insert([{user_id:(p=(f=M==null?void 0:M.data)==null?void 0:f.user)==null?void 0:p.id,page_type:t,name:x,filters:r,is_public:o}]))==null?void 0:y.select())==null?void 0:m.single());return O?{data:null,error:{message:O==null?void 0:O.message}}:{data:se,error:null}}catch(M){return console.error("Error saving filter preset:",M),{data:null,error:{message:"Failed to save filter preset"}}}},async deleteFilterPreset(t){var x,r,o;try{const{error:h}=await((o=(r=(x=D)==null?void 0:x.from("filter_presets"))==null?void 0:r.delete())==null?void 0:o.eq("id",t));return h?{error:{message:h==null?void 0:h.message}}:{error:null}}catch(h){return console.error("Error deleting filter preset:",h),{error:{message:"Failed to delete filter preset"}}}},async exportData(t,x={},r="staff"){var o,h;try{const{data:u,error:d}=await((o=D)==null?void 0:o.rpc("generate_export_data",{export_type:t,filters:x,user_role:r}));return d?{data:null,error:{message:d==null?void 0:d.message}}:{data:(h=u||[])==null?void 0:h.map(p=>{var m;const b=(p==null?void 0:p.export_data)||p,y={};return(m=Object==null?void 0:Object.entries(b))==null||m.forEach(([M,se])=>{typeof se=="number"?y[M]=isNaN(se)?0:se:se==null?y[M]="":y[M]=se}),{export_data:y}}),error:null}}catch(u){return console.error("Error exporting data:",u),{data:null,error:{message:"Failed to export data"}}}},async exportToCSV(t,x,r=null){var o,h,u,d;try{if(!t||(t==null?void 0:t.length)===0)throw new Error("No data to export");let f="";if(r)f+=(r==null?void 0:r.join(","))+`
`;else{const y=((o=t==null?void 0:t[0])==null?void 0:o.export_data)||(t==null?void 0:t[0]);y&&(f+=((h=Object==null?void 0:Object.keys(y))==null?void 0:h.join(","))+`
`)}t==null||t.forEach(y=>{var se;const m=(y==null?void 0:y.export_data)||y,M=(se=Object==null?void 0:Object.values(m))==null?void 0:se.map(O=>{if(O==null)return"";if(typeof O=="number"&&isNaN(O))return"0";let N=ks(O);return N!=null&&N.includes(",")||N!=null&&N.includes('"')?`"${N==null?void 0:N.replace(/"/g,'""')}"`:N});f+=(M==null?void 0:M.join(","))+`
`});const p=new Blob([f],{type:"text/csv;charset=utf-8;"}),b=document.createElement("a");if((b==null?void 0:b.download)!==void 0){const y=URL==null?void 0:URL.createObjectURL(p);b==null||b.setAttribute("href",y),b==null||b.setAttribute("download",x),b.style.visibility="hidden",(u=document.body)==null||u.appendChild(b),b==null||b.click(),(d=document.body)==null||d.removeChild(b),URL==null||URL.revokeObjectURL(y)}return{success:!0,error:null}}catch(f){return console.error("Export to CSV error:",f),{success:!1,error:{message:(f==null?void 0:f.message)||"Failed to export CSV"}}}},async bulkUpdateJobs(t,x){var r,o,h,u,d;try{const f=await((o=(r=D)==null?void 0:r.auth)==null?void 0:o.getUser()),{data:p,error:b}=await((d=D)==null?void 0:d.rpc("bulk_update_jobs",{job_ids:t,updates:x,performed_by:(u=(h=f==null?void 0:f.data)==null?void 0:h.user)==null?void 0:u.id}));return b?{data:null,error:{message:b==null?void 0:b.message}}:{data:(p==null?void 0:p[0])||null,error:null}}catch(f){return console.error("Error in bulk update jobs:",f),{data:null,error:{message:"Failed to bulk update jobs"}}}},async getNotificationPreferences(){var t,x,r,o,h,u,d;try{const f=await((x=(t=D)==null?void 0:t.auth)==null?void 0:x.getUser()),{data:p,error:b}=await((d=(o=(r=D)==null?void 0:r.from("notification_preferences"))==null?void 0:o.select("*"))==null?void 0:d.eq("user_id",(u=(h=f==null?void 0:f.data)==null?void 0:h.user)==null?void 0:u.id));return b?{data:[],error:{message:b==null?void 0:b.message}}:{data:p||[],error:null}}catch(f){return console.error("Error fetching notification preferences:",f),{data:[],error:{message:"Failed to fetch notification preferences"}}}},async updateNotificationPreferences(t){var x,r,o,h,u,d,f,p,b,y;try{const m=await((r=(x=D)==null?void 0:x.auth)==null?void 0:r.getUser());await((f=(h=(o=D)==null?void 0:o.from("notification_preferences"))==null?void 0:h.delete())==null?void 0:f.eq("user_id",(d=(u=m==null?void 0:m.data)==null?void 0:u.user)==null?void 0:d.id));const M=t==null?void 0:t.map(N=>{var a,I;return{...N,user_id:(I=(a=m==null?void 0:m.data)==null?void 0:a.user)==null?void 0:I.id}}),{data:se,error:O}=await((y=(b=(p=D)==null?void 0:p.from("notification_preferences"))==null?void 0:b.insert(M))==null?void 0:y.select());return O?{data:null,error:{message:O==null?void 0:O.message}}:{data:se,error:null}}catch(m){return console.error("Error updating notification preferences:",m),{data:null,error:{message:"Failed to update notification preferences"}}}},subscribeToOverdueJobs(t){var x,r,o;try{return(o=(r=(x=D)==null?void 0:x.channel("overdue-jobs"))==null?void 0:r.on("postgres_changes",{event:"*",schema:"public",table:"jobs"},u=>{var d;(d=this.getOverdueJobs())==null||d.then(f=>{f!=null&&f.data&&t(f==null?void 0:f.data)})}))==null?void 0:o.subscribe()}catch(h){return console.error("Error subscribing to overdue jobs:",h),null}},async searchWithFilters(t,x,r){var o,h,u;try{let d=(o=D)==null?void 0:o.from(r);if(t)switch(r){case"jobs":d=d==null?void 0:d.or(`job_number.ilike.%${t}%,title.ilike.%${t}%`);break;case"vehicles":d=d==null?void 0:d.or(`vin.ilike.%${t}%,make.ilike.%${t}%,model.ilike.%${t}%`);break;case"vendors":d=d==null?void 0:d.or(`name.ilike.%${t}%,specialty.ilike.%${t}%`);break}(h=Object==null?void 0:Object.entries(x))==null||h.forEach(([b,y])=>{y!=null&&y!==""&&(Array!=null&&Array.isArray(y)?d=d==null?void 0:d.in(b,y):typeof y=="object"&&(y==null?void 0:y.min)!==void 0?d=d==null?void 0:d.gte(b,y==null?void 0:y.min):typeof y=="object"&&(y==null?void 0:y.max)!==void 0?d=d==null?void 0:d.lte(b,y==null?void 0:y.max):d=d==null?void 0:d.eq(b,y))});const{data:f,error:p}=await((u=d==null?void 0:d.select("*"))==null?void 0:u.order("created_at",{ascending:!1}));return p?{data:[],error:{message:p==null?void 0:p.message}}:{data:f||[],error:null}}catch(d){return console.error("Error in search with filters:",d),{data:[],error:{message:"Failed to search with filters"}}}}},Cs=({exportType:t,filters:x={},selectedIds:r=[],onExportStart:o,onExportComplete:h,onExportError:u,disabled:d=!1,variant:f="outline",size:p="sm",className:b=""})=>{var A;const[y,m]=S.useState(!1),[M,se]=S.useState(!1),[O,N]=S.useState("csv"),[a,I]=S.useState("filtered"),{user:i,userProfile:le}=He(),g=[{value:"csv",label:"CSV File"},{value:"excel",label:"Excel File"}],q=[{value:"all",label:"All Records"},{value:"filtered",label:"Filtered Results"},...(r==null?void 0:r.length)>0?[{value:"selected",label:`Selected (${r==null?void 0:r.length})`}]:[]],L=()=>{var K,je,ce;const Y=(ce=(je=(K=new Date)==null?void 0:K.toISOString())==null?void 0:je.split("T"))==null?void 0:ce[0];return`${t}-${a==="selected"?"selected":a}-${Y}.${O}`},R=async()=>{var Y,_e,K,je;if(!y)try{m(!0),o&&o();let ce={...x};a==="selected"&&(r==null?void 0:r.length)>0&&(ce.ids=r),a==="all"&&(ce={});const ae=await(Fe==null?void 0:Fe.exportData(t,ce,(le==null?void 0:le.role)||"staff"));if(ae!=null&&ae.error)throw new Error((Y=ae==null?void 0:ae.error)==null?void 0:Y.message);if(!(ae!=null&&ae.data)||((_e=ae==null?void 0:ae.data)==null?void 0:_e.length)===0)throw new Error("No data found to export");const v=L(),V=await(Fe==null?void 0:Fe.exportToCSV(ae==null?void 0:ae.data,v));if(V!=null&&V.error)throw new Error((K=V==null?void 0:V.error)==null?void 0:K.message);se(!1),h&&h((je=ae==null?void 0:ae.data)==null?void 0:je.length,v)}catch(ce){console.error("Export error:",ce),u&&u((ce==null?void 0:ce.message)||"Export failed")}finally{m(!1)}},w=()=>{switch(t){case"jobs":return"Jobs";case"vehicles":return"Vehicles";case"vendors":return"Vendors";case"transactions":return"Transactions";default:return"Data"}};return e.jsxs("div",{className:"relative",children:[e.jsx(z,{variant:f,size:p,onClick:()=>se(!M),disabled:d||y,iconName:y?void 0:"Download",iconPosition:"left",className:`${b} ${y?"cursor-wait":""}`,"aria-label":`Export ${w()}`,children:y?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin"}),e.jsx("span",{children:"Exporting..."})]}):`Export ${w()}`}),M&&!y&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-card border border-border rounded-lg shadow-lg z-50",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Format"}),e.jsx(Je,{value:O,onChange:N,options:g,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Export Scope"}),e.jsx(Je,{value:a,onChange:I,options:q,className:"w-full"})]}),a==="filtered"&&((A=Object==null?void 0:Object.keys(x))==null?void 0:A.length)===0&&e.jsxs("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded",children:[e.jsx(Ge,{name:"AlertTriangle",size:12,className:"inline mr-1"}),"No filters applied. This will export all records."]}),a==="selected"&&e.jsxs("div",{className:"text-xs text-blue-600 bg-blue-50 p-2 rounded",children:[e.jsx(Ge,{name:"Info",size:12,className:"inline mr-1"}),"Exporting ",r==null?void 0:r.length," selected record",(r==null?void 0:r.length)!==1?"s":"","."]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2 border-t border-border",children:[e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>se(!1),className:"min-w-0","aria-label":"Cancel export",children:"Cancel"}),e.jsx(z,{size:"sm",onClick:R,iconName:"Download",iconPosition:"left",className:"min-w-0","aria-label":`Export ${w()}`,children:"Export"})]})]})})]})},De={async getVehicles(t={},x=null){var r,o,h,u;try{let d=(h=(o=(r=D)==null?void 0:r.from("vehicles"))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:h.order("created_at",{ascending:!1});return x&&(d=d==null?void 0:d.eq("org_id",x)),t!=null&&t.status&&(d=d==null?void 0:d.eq("vehicle_status",t==null?void 0:t.status)),t!=null&&t.make&&(d=d==null?void 0:d.eq("make",t==null?void 0:t.make)),t!=null&&t.year&&(d=d==null?void 0:d.eq("year",t==null?void 0:t.year)),t!=null&&t.search&&(d=d==null?void 0:d.or(`vin.ilike.%${t==null?void 0:t.search}%,make.ilike.%${t==null?void 0:t.search}%,model.ilike.%${t==null?void 0:t.search}%,license_plate.ilike.%${t==null?void 0:t.search}%,owner_name.ilike.%${t==null?void 0:t.search}%,owner_phone.ilike.%${t==null?void 0:t.search}%,owner_email.ilike.%${t==null?void 0:t.search}%,stock_number.ilike.%${t==null?void 0:t.search}%`)),{data:await Ue(d,"vehicles:getVehicles")||[],error:null}}catch(d){return(u=d==null?void 0:d.message)!=null&&u.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicles"}}}},async getVehicleById(t,x=null){var r,o,h,u,d;try{let f=(u=(h=(o=(r=D)==null?void 0:r.from("vehicles"))==null?void 0:o.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email),
          jobs(
            id,
            job_number,
            title,
            job_status,
            priority,
            estimated_cost,
            actual_cost,
            created_at,
            assigned_to_profile:user_profiles!jobs_assigned_to_fkey(full_name)
          )
        `))==null?void 0:h.eq("id",t))==null?void 0:u.single();return x&&(f=f==null?void 0:f.eq("org_id",x)),{data:await Ue(f,"vehicles:getVehicleById"),error:null}}catch(f){return(d=f==null?void 0:f.message)!=null&&d.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle details"}}}},async createVehicle(t){var x,r,o,h,u,d,f,p,b,y;try{const{data:m,error:M}=await((b=(p=(f=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:f.insert([{...t,created_by:(d=(u=(h=await((o=(r=D)==null?void 0:r.auth)==null?void 0:o.getUser()))==null?void 0:h.data)==null?void 0:u.user)==null?void 0:d.id}]))==null?void 0:p.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:b.single());return M?{data:null,error:{message:M==null?void 0:M.message}}:{data:m,error:null}}catch(m){return(y=m==null?void 0:m.message)!=null&&y.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to create vehicle"}}}},async create(t){var x,r,o,h;try{const{data:u,error:d}=await((h=(o=(r=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:r.insert([t]))==null?void 0:o.select())==null?void 0:h.single());if(d)throw console.error("Vehicle creation error:",d),new Error(d.message||"Failed to create vehicle");return console.log("Vehicle created successfully:",u),u}catch(u){throw console.error("Error in vehicleService.create:",u),u}},async createVehicleWithProducts(t){var x,r;try{console.log("Creating vehicle with products:",t);const o=`vehicle_${Date.now()}`;await new Promise(u=>setTimeout(u,1e3));const h={id:o,...t,created_at:(x=new Date)==null?void 0:x.toISOString(),initial_products_count:((r=t==null?void 0:t.initial_products)==null?void 0:r.length)||0,estimated_aftermarket_value:(t==null?void 0:t.total_initial_product_value)||0};return console.log("Vehicle created successfully:",h),h}catch(o){throw console.error("Error creating vehicle with products:",o),o}},async checkStockNumberExists(t){var x,r,o,h;if(!(t!=null&&t.trim()))return!1;try{const{data:u,error:d}=await((h=(o=(r=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:o.eq("stock_number",t==null?void 0:t.trim()))==null?void 0:h.maybeSingle());return d?(console.error("Stock number check error:",d),!1):!!u}catch(u){return console.error("Error checking stock number:",u),!1}},async checkVinExists(t){var x,r,o,h;if(!(t!=null&&t.trim()))return!1;try{const{data:u,error:d}=await((h=(o=(r=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:r.select("id"))==null?void 0:o.eq("vin",t==null?void 0:t.trim()))==null?void 0:h.maybeSingle());return d?(console.error("VIN check error:",d),!1):!!u}catch(u){return console.error("Error checking VIN:",u),!1}},async updateVehicle(t,x){var r,o,h,u,d,f,p;try{const{data:b,error:y}=await((f=(d=(u=(h=(r=D)==null?void 0:r.from("vehicles"))==null?void 0:h.update({...x,updated_at:(o=new Date)==null?void 0:o.toISOString()}))==null?void 0:u.eq("id",t))==null?void 0:d.select(`
          *,
          created_by_profile:user_profiles!vehicles_created_by_fkey(full_name, email)
        `))==null?void 0:f.single());return y?{data:null,error:{message:y==null?void 0:y.message}}:{data:b,error:null}}catch(b){return(p=b==null?void 0:b.message)!=null&&p.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to update vehicle"}}}},async deleteVehicle(t){var x,r,o,h;try{const{error:u}=await((o=(r=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:r.delete())==null?void 0:o.eq("id",t));return u?{error:{message:u==null?void 0:u.message}}:{error:null}}catch(u){return(h=u==null?void 0:u.message)!=null&&h.includes("Failed to fetch")?{error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{error:{message:"Failed to delete vehicle"}}}},async getVehicleStats(t=null){var x,r,o,h,u,d,f;try{let p=(r=(x=D)==null?void 0:x.from("vehicles"))==null?void 0:r.select("vehicle_status");t&&(p=p==null?void 0:p.eq("org_id",t));const b=await Ue(p,"vehicles:getVehicleStats");return{data:{total:(b==null?void 0:b.length)||0,active:((o=b==null?void 0:b.filter(m=>(m==null?void 0:m.vehicle_status)==="active"))==null?void 0:o.length)||0,maintenance:((h=b==null?void 0:b.filter(m=>(m==null?void 0:m.vehicle_status)==="maintenance"))==null?void 0:h.length)||0,retired:((u=b==null?void 0:b.filter(m=>(m==null?void 0:m.vehicle_status)==="retired"))==null?void 0:u.length)||0,sold:((d=b==null?void 0:b.filter(m=>(m==null?void 0:m.vehicle_status)==="sold"))==null?void 0:d.length)||0},error:null}}catch(p){return(f=p==null?void 0:p.message)!=null&&f.includes("Failed to fetch")?{data:null,error:{message:"Cannot connect to database. Your Supabase project may be paused or deleted. Please visit your Supabase dashboard to check project status."}}:{data:null,error:{message:"Failed to load vehicle statistics"}}}},async getAllVehicles(t={}){return await this.getVehicles(t)}};function Es({isOpen:t,onClose:x,onSuccess:r}){var j,U,ee;const{user:o}=He(),{orgId:h}=ns()||{},[u,d]=S.useState(1),[f,p]=S.useState(!1),[b,y]=S.useState(""),[m,M]=S.useState(!1),[se,O]=S.useState(!1),[N,a]=S.useState({salesConsultants:[],deliveryCoordinators:[],financeManagers:[],vendors:[],products:[],loading:!0,error:null,retryCount:0}),I={customerName:"",customerPhone:"",customerEmail:"",needsLoaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,vehicleYear:(j=new Date)==null?void 0:j.getFullYear(),vehicleMake:"Toyota",vehicleModel:"Camry",stockNumber:""},[i,le]=S.useState(I),[g,q]=S.useState([]),L=async(n=0)=>{var k,$;try{a(G=>({...G,loading:!0,error:null,retryCount:n}));const[oe,de,ie,X,me]=await Promise.all([as().catch(()=>[]),ls().catch(()=>[]),cs().catch(()=>[]),is({activeOnly:!0}).catch(()=>[]),os({activeOnly:!0}).catch(()=>[])]);a({salesConsultants:oe,deliveryCoordinators:de,financeManagers:ie,vendors:X,products:me==null?void 0:me.map(G=>({...G,unitPrice:G==null?void 0:G.unit_price})),loading:!1,error:null,retryCount:n})}catch(oe){if(console.error("Failed to load dropdown data:",oe),n<2&&((k=oe==null?void 0:oe.message)!=null&&k.includes("fetch")||($=oe==null?void 0:oe.message)!=null&&$.includes("network"))){setTimeout(()=>L(n+1),1e3*(n+1));return}a(de=>({...de,loading:!1,error:"Failed to load dropdown data. Please check your connection and try again.",retryCount:n}))}},R=({checked:n,onChange:k})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsxs("label",{htmlFor:"needs-loaner-modal",className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("input",{id:"needs-loaner-modal",type:"checkbox",checked:!!n,onChange:$=>{var de;const oe=!!((de=$==null?void 0:$.target)!=null&&de.checked);k(oe)},className:"w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customer needs loaner vehicle"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 ml-8",children:"Check this if the customer requires a loaner vehicle during service"})]}),w=({label:n,options:k,value:$,onChange:oe,placeholder:de,required:ie=!1,helpText:X,testId:me})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[n," ",ie&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:$||"",onChange:G=>{var T;return oe(((T=G==null?void 0:G.target)==null?void 0:T.value)||null)},className:"bg-white border border-gray-300 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",disabled:N==null?void 0:N.loading,required:ie,"data-testid":me,children:[e.jsx("option",{value:"",children:de}),k==null?void 0:k.map(G=>e.jsx("option",{value:G==null?void 0:G.id,children:(G==null?void 0:G.full_name)||(G==null?void 0:G.label)||(G==null?void 0:G.name)},G==null?void 0:G.id))]}),X&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:X}),(k==null?void 0:k.length)===0&&!(N!=null&&N.loading)&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No ",n==null?void 0:n.toLowerCase()," found yet. Add it in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]});S.useEffect(()=>{const n=(i==null?void 0:i.customerName)!==(I==null?void 0:I.customerName)||(i==null?void 0:i.customerPhone)!==(I==null?void 0:I.customerPhone)||(i==null?void 0:i.customerEmail)!==(I==null?void 0:I.customerEmail)||(i==null?void 0:i.needsLoaner)!==(I==null?void 0:I.needsLoaner)||(i==null?void 0:i.assignedTo)!==(I==null?void 0:I.assignedTo)||(i==null?void 0:i.deliveryCoordinator)!==(I==null?void 0:I.deliveryCoordinator)||(i==null?void 0:i.financeManager)!==(I==null?void 0:I.financeManager)||(g==null?void 0:g.length)>0;M(n)},[i,g]),S.useEffect(()=>{t&&L()},[t]);const A=()=>{q(n=>[...n,{id:Date.now(),productId:"",unitPrice:"",serviceType:"in_house",vendorId:"",requiresScheduling:!0,promisedDate:"",noScheduleReason:"",serviceNotes:""}])},Y=(n,k,$)=>{var oe;if(q(de=>de==null?void 0:de.map(ie=>{if((ie==null?void 0:ie.id)===n){let X={...ie,[k]:$};return k==="requiresScheduling"&&($===!0?X.noScheduleReason="":X.promisedDate=""),X}return ie})),k==="productId"&&$){const de=(oe=N==null?void 0:N.products)==null?void 0:oe.find(ie=>(ie==null?void 0:ie.id)===$);de&&q(ie=>ie==null?void 0:ie.map(X=>(X==null?void 0:X.id)===n?{...X,unitPrice:(de==null?void 0:de.unitPrice)||""}:X))}},_e=n=>{q(k=>k==null?void 0:k.filter($=>($==null?void 0:$.id)!==n))},K=()=>{var n,k;return((k=(n=i==null?void 0:i.customerName)==null?void 0:n.trim())==null?void 0:k.length)>0},je=()=>(g==null?void 0:g.length)===0?!1:g==null?void 0:g.every(n=>{var k;return!(!(n!=null&&n.productId)||!(n!=null&&n.unitPrice)||n!=null&&n.requiresScheduling&&!(n!=null&&n.promisedDate)||!(n!=null&&n.requiresScheduling)&&!((k=n==null?void 0:n.noScheduleReason)!=null&&k.trim())||(n==null?void 0:n.serviceType)==="vendor"&&!(n!=null&&n.vendorId))}),ce=()=>g==null?void 0:g.reduce((n,k)=>n+(parseFloat(k==null?void 0:k.unitPrice)||0),0),ae=async()=>{var n,k,$,oe,de,ie,X,me,G,T;if(!K()){y("Customer name is required to save draft");return}p(!0),y("");try{const re={year:(i==null?void 0:i.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(i==null?void 0:i.vehicleMake)||"TBD",model:(i==null?void 0:i.vehicleModel)||"TBD",owner_name:(k=i==null?void 0:i.customerName)==null?void 0:k.trim(),owner_phone:(($=i==null?void 0:i.customerPhone)==null?void 0:$.trim())||null,owner_email:((oe=i==null?void 0:i.customerEmail)==null?void 0:oe.trim())||null,stock_number:((de=i==null?void 0:i.stockNumber)==null?void 0:de.trim())||`DRAFT-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},we=await De.create(re),Ee={title:`Draft Deal - ${(ie=i==null?void 0:i.customerName)==null?void 0:ie.trim()}`,description:`Draft deal for ${(X=i==null?void 0:i.customerName)==null?void 0:X.trim()}`,job_status:"draft",service_type:"in_house",vehicle_id:we==null?void 0:we.id,assigned_to:(i==null?void 0:i.assignedTo)||(o==null?void 0:o.id),delivery_coordinator_id:(i==null?void 0:i.deliveryCoordinator)||null,finance_manager_id:(i==null?void 0:i.financeManager)||null,customer_needs_loaner:!!(i!=null&&i.needsLoaner),customerName:(me=i==null?void 0:i.customerName)==null?void 0:me.trim(),customerPhone:((G=i==null?void 0:i.customerPhone)==null?void 0:G.trim())||"",customerEmail:((T=i==null?void 0:i.customerEmail)==null?void 0:T.trim())||"",org_id:h||void 0,lineItems:[]};await Ke.createDeal(Ee),r==null||r(),V(),x()}catch(re){y(`Failed to save draft: ${re==null?void 0:re.message}`)}finally{p(!1)}},v=async()=>{var n,k,$,oe,de,ie,X,me,G,T,re,we;if(!K()||!je()){y("Please complete all required fields");return}p(!0),y("");try{const Ee={year:(i==null?void 0:i.vehicleYear)||((n=new Date)==null?void 0:n.getFullYear()),make:(i==null?void 0:i.vehicleMake)||"TBD",model:(i==null?void 0:i.vehicleModel)||"TBD",owner_name:(k=i==null?void 0:i.customerName)==null?void 0:k.trim(),owner_phone:(($=i==null?void 0:i.customerPhone)==null?void 0:$.trim())||null,owner_email:((oe=i==null?void 0:i.customerEmail)==null?void 0:oe.trim())||null,stock_number:((de=i==null?void 0:i.stockNumber)==null?void 0:de.trim())||`DEAL-${Date.now()}`,vehicle_status:"active",...h?{org_id:h}:{}},$e=await De.create(Ee),qe=ce(),ue=(g==null?void 0:g.some(c=>(c==null?void 0:c.serviceType)==="vendor"))?"vendor":"in_house",ve=((ie=g==null?void 0:g.find(c=>c==null?void 0:c.vendorId))==null?void 0:ie.vendorId)||null;let Ne=null;if(ue==="vendor"){const c=(g||[]).filter(l=>(l==null?void 0:l.serviceType)==="vendor"&&(l==null?void 0:l.requiresScheduling)&&(l==null?void 0:l.promisedDate)).map(l=>new Date(l==null?void 0:l.promisedDate)).sort((l,C)=>l-C);Ne=(X=(c==null?void 0:c[0])||new Date)==null?void 0:X.toISOString()}const Pe=(g||[]).map(c=>({product_id:c==null?void 0:c.productId,quantity_used:1,unit_price:parseFloat((c==null?void 0:c.unitPrice)||0),promised_date:c!=null&&c.requiresScheduling?c==null?void 0:c.promisedDate:null,requires_scheduling:!!(c!=null&&c.requiresScheduling),no_schedule_reason:c!=null&&c.requiresScheduling?null:c==null?void 0:c.noScheduleReason,is_off_site:(c==null?void 0:c.serviceType)==="vendor"})),Me={title:`Deal - ${(me=i==null?void 0:i.customerName)==null?void 0:me.trim()}`,description:`Deal for ${(G=i==null?void 0:i.customerName)==null?void 0:G.trim()}`,job_status:"pending",service_type:ue,vehicle_id:$e==null?void 0:$e.id,vendor_id:ve,assigned_to:(i==null?void 0:i.assignedTo)||(o==null?void 0:o.id),delivery_coordinator_id:(i==null?void 0:i.deliveryCoordinator)||null,finance_manager_id:(i==null?void 0:i.financeManager)||null,customer_needs_loaner:!!(i!=null&&i.needsLoaner),scheduled_start_time:Ne,estimated_cost:qe,org_id:h||void 0,customerName:(T=i==null?void 0:i.customerName)==null?void 0:T.trim(),customerPhone:((re=i==null?void 0:i.customerPhone)==null?void 0:re.trim())||"",customerEmail:((we=i==null?void 0:i.customerEmail)==null?void 0:we.trim())||"",lineItems:Pe},Ae=await Ke.createDeal(Me);await Ke.updateDeal(Ae==null?void 0:Ae.id,Me),r==null||r(),V(),x()}catch(Ee){y(`Failed to create deal: ${Ee==null?void 0:Ee.message}`)}finally{p(!1)}},V=()=>{d(1),le(I),q([]),y(""),M(!1)},Ce=()=>{m?O(!0):(V(),x())},Le=()=>{O(!1),V(),x()};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Create New Deal"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:u===1?"Customer Information":"Line Items & Service Configuration"})]}),e.jsx("button",{onClick:Ce,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(H,{name:"X",size:24})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex-shrink-0 border-b",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-2 ${u>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${u>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e.jsx("span",{className:"font-medium",children:"Customer"})]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("div",{className:`flex items-center space-x-2 ${u>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${u>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e.jsx("span",{className:"font-medium",children:"Line Items"})]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1 bg-white",children:[b&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",b]}),e.jsx("button",{onClick:()=>y(""),className:"text-red-600 hover:text-red-800 ml-2",children:e.jsx(H,{name:"X",size:16})})]})}),(N==null?void 0:N.error)&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Error:"})," ",N==null?void 0:N.error]}),e.jsx("button",{onClick:()=>L(),className:"text-blue-600 hover:text-blue-800 ml-2 text-xs underline",children:"Retry"})]})}),u===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:i==null?void 0:i.customerName,onChange:n=>le(k=>{var $;return{...k,customerName:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Phone"}),e.jsx("input",{type:"tel",value:i==null?void 0:i.customerPhone,onChange:n=>le(k=>{var $;return{...k,customerPhone:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer phone"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer Email"}),e.jsx("input",{type:"email",value:i==null?void 0:i.customerEmail,onChange:n=>le(k=>{var $;return{...k,customerEmail:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter customer email"})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx("input",{type:"number",value:(i==null?void 0:i.vehicleYear)||"",onChange:n=>le(k=>{var $;return{...k,vehicleYear:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"2024",min:"1900",max:((U=new Date)==null?void 0:U.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx("input",{type:"text",value:(i==null?void 0:i.vehicleMake)||"",onChange:n=>le(k=>{var $;return{...k,vehicleMake:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx("input",{type:"text",value:(i==null?void 0:i.vehicleModel)||"",onChange:n=>le(k=>{var $;return{...k,vehicleModel:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx("input",{type:"text",value:(i==null?void 0:i.stockNumber)||"",onChange:n=>le(k=>{var $;return{...k,stockNumber:($=n==null?void 0:n.target)==null?void 0:$.value}}),className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter stock number (optional)"})]})]}),e.jsx(R,{checked:i==null?void 0:i.needsLoaner,onChange:n=>{le(k=>({...k,needsLoaner:!!n}))}}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(w,{label:"Sales Consultant",options:N==null?void 0:N.salesConsultants,value:i==null?void 0:i.assignedTo,onChange:n=>le(k=>({...k,assignedTo:n})),placeholder:"Select sales consultant (optional)",helpText:"Choose the sales consultant responsible for this deal",testId:"sales-select"}),e.jsx(w,{label:"Delivery Coordinator",options:N==null?void 0:N.deliveryCoordinators,value:i==null?void 0:i.deliveryCoordinator,onChange:n=>le(k=>({...k,deliveryCoordinator:n})),placeholder:"Select delivery coordinator (optional)",helpText:"Choose the delivery coordinator for this deal",testId:"delivery-select"}),e.jsx(w,{label:"Finance Manager",options:N==null?void 0:N.financeManagers,value:i==null?void 0:i.financeManager,onChange:n=>le(k=>({...k,financeManager:n})),placeholder:"Select finance manager (optional)",helpText:"Choose the finance manager for this deal",testId:"finance-select"})]})]})]}),u===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(z,{onClick:A,variant:"outline",size:"sm",className:"flex items-center space-x-2 bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 h-11",children:[e.jsx(H,{name:"Plus",size:16}),e.jsx("span",{children:"Add Item"})]})]}),(g==null?void 0:g.length)===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-slate-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx(H,{name:"Package",size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No line items added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Item" to get started'})]}):e.jsxs("div",{className:"space-y-4",children:[g==null?void 0:g.map((n,k)=>{var $,oe,de,ie,X,me,G;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50 border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",k+1]}),e.jsx("button",{onClick:()=>_e(n==null?void 0:n.id),className:"text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg","aria-label":"Remove line item",title:"Remove line item",children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Product ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.productId)||"",onChange:T=>{var re;return Y(n==null?void 0:n.id,"productId",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,"data-testid":`product-select-${k}`,children:[e.jsx("option",{value:"",children:"Select product"}),($=N==null?void 0:N.products)==null?void 0:$.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(N!=null&&N.loading)&&(((oe=N==null?void 0:N.products)==null?void 0:oe.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No products found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Unit Price ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:n==null?void 0:n.unitPrice,onChange:T=>{var re;return Y(n==null?void 0:n.id,"unitPrice",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00",required:!0,"data-testid":`unit-price-input-${k}`})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-slate-200 mb-4",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Service Configuration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"in_house",checked:(n==null?void 0:n.serviceType)==="in_house",onChange:T=>{var re;return Y(n==null?void 0:n.id,"serviceType",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"mr-2 cursor-pointer"}),"ðŸ  On-Site (In-House)"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceType_${n==null?void 0:n.id}`,value:"vendor",checked:(n==null?void 0:n.serviceType)==="vendor",onChange:T=>{var re;return Y(n==null?void 0:n.id,"serviceType",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"mr-2 cursor-pointer"}),"ðŸ¢ Off-Site (Vendor)"]})]})]}),(n==null?void 0:n.serviceType)==="vendor"&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Vendor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:(n==null?void 0:n.vendorId)||"",onChange:T=>{var re;return Y(n==null?void 0:n.id,"vendorId",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"Select vendor"}),(de=N==null?void 0:N.vendors)==null?void 0:de.map(T=>e.jsx("option",{value:T==null?void 0:T.id,children:T==null?void 0:T.label},T==null?void 0:T.id))]}),!(N!=null&&N.loading)&&(((ie=N==null?void 0:N.vendors)==null?void 0:ie.length)||0)===0&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scheduling"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`requiresScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!0,onChange:()=>Y(n==null?void 0:n.id,"requiresScheduling",!0),className:"mr-2 cursor-pointer",id:`requiresScheduling-${k}`,"data-testid":`requires-scheduling-${k}`}),"Needs Scheduling"]}),e.jsxs("label",{className:"flex items-center cursor-pointer",htmlFor:`noScheduling-${k}`,children:[e.jsx("input",{type:"radio",name:`scheduling_${n==null?void 0:n.id}`,checked:(n==null?void 0:n.requiresScheduling)===!1,onChange:()=>Y(n==null?void 0:n.id,"requiresScheduling",!1),className:"mr-2 cursor-pointer",id:`noScheduling-${k}`}),"No Scheduling Needed"]})]}),n!=null&&n.requiresScheduling?e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Promised Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:n==null?void 0:n.promisedDate,onChange:T=>{var re;return Y(n==null?void 0:n.id,"promisedDate",(re=T==null?void 0:T.target)==null?void 0:re.value)},min:(G=(me=(X=new Date)==null?void 0:X.toISOString())==null?void 0:me.split("T"))==null?void 0:G[0],className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for No Schedule ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:n==null?void 0:n.noScheduleReason,onChange:T=>{var re;return Y(n==null?void 0:n.id,"noScheduleReason",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., installed at delivery, no appointment needed",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Notes"}),e.jsx("textarea",{rows:2,value:n==null?void 0:n.serviceNotes,onChange:T=>{var re;return Y(n==null?void 0:n.id,"serviceNotes",(re=T==null?void 0:T.target)==null?void 0:re.value)},className:"w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Special instructions, customer preferences, etc."})]})]})]},n==null?void 0:n.id)}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-medium text-gray-900",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:["$",(ee=ce())==null?void 0:ee.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[g==null?void 0:g.length," item",(g==null?void 0:g.length)!==1?"s":""," added"]})]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-t bg-slate-50 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-3",children:[e.jsx("div",{className:"flex space-x-3 w-full md:w-auto",children:u===2&&e.jsx(z,{onClick:()=>d(1),variant:"outline",className:"w-full md:w-auto h-11",children:"â† Back"})}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(z,{onClick:Ce,variant:"outline",className:"w-full md:w-auto h-11",children:"Cancel"}),u===1&&e.jsxs(e.Fragment,{children:[e.jsx(z,{onClick:ae,disabled:!K()||f,variant:"outline",className:"w-full md:w-auto h-11 bg-yellow-50 border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:f?"Saving...":"Save Draft"}),e.jsx(z,{onClick:()=>d(2),disabled:!K(),className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700",children:"Add Line Items â†’"})]}),u===2&&e.jsx(z,{onClick:v,disabled:!K()||!je()||f,className:"w-full md:w-auto h-11 bg-green-600 hover:bg-green-700",children:f?"Creating...":"Create Deal"})]})]})}),se&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(z,{variant:"outline",onClick:()=>O(!1),className:"flex-1 h-11",children:"Keep Editing"}),e.jsx(z,{onClick:Le,className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white",children:"Discard Changes"})]})]})})]})}):null}async function Ts(t,{activeOnly:x=!0}={}){let r=D.from("products").select("*").order("name",{ascending:!0});x&&(r=r.eq("is_active",!0)),t&&(r=r.or(`org_id.eq.${t},org_id.is.null`));const o=await Ue(r,"products:listByOrg");return Ns(o,{labelKey:"name",valueKey:"id"})}function As(t,{activeOnly:x=!0}={}){let r=D.from("user_profiles").select("*").order("full_name",{ascending:!0});return x&&(r=r.eq("is_active",!0)),t&&(r=r.or(`org_id.eq.${t},org_id.is.null`)),Ue(r,"staff:listByOrg")}function us(t={}){var a,I,i,le;const{loadOnMount:x=!0,cacheTime:r=5*60*1e3}=t,[o,h]=S.useState({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!0,error:null,searchResults:null}),[u,d]=S.useState(null),f=ns(),p=He(),b=async()=>{var g,q,L,R;try{if(f.loading)return;if(h(V=>({...V,loading:!0,error:null})),!((g=f.session)!=null&&g.user)){console.warn("Dropdowns: no authenticated user; some queries may return empty due to RLS"),h(V=>({...V,loading:!1}));return}const w=!!f.orgId,A=[(q=ls())==null?void 0:q.catch(V=>(console.error("[dropdowns:dc] Delivery coordinators failed:",V),[])),(L=as())==null?void 0:L.catch(V=>(console.error("[dropdowns:sales] Sales consultants failed:",V),[])),(R=cs())==null?void 0:R.catch(V=>(console.error("[dropdowns:finance] Finance managers failed:",V),[])),w?As(f.orgId).catch(V=>(console.error("[dropdowns:users] tenant staff failed:",V),[])):gs({activeOnly:!0}).catch(V=>(console.error("[dropdowns:users] global user profiles failed:",V),[])),w?_s(f.orgId).catch(V=>(console.error("[dropdowns:vendors] tenant vendors failed:",V),[])):is({activeOnly:!0}).catch(V=>(console.error("[dropdowns:vendors] global vendors failed:",V),[])),w?Ts(f.orgId).catch(V=>(console.error("[dropdowns:products] tenant products failed:",V),[])):os({activeOnly:!0}).catch(V=>(console.error("[dropdowns:products] global products failed:",V),[])),w?ws(f.orgId).catch(V=>(console.error("[dropdowns:smsTemplates] tenant SMS templates failed:",V),[])):Promise.resolve([])],[Y,_e,K,je,ce,ae,v]=await Promise.all(A);h({dc:Y,sales:_e,finance:K,users:je,vendors:ce,products:ae,smsTemplates:v,loading:!1,error:null,searchResults:null}),d(Date.now())}catch(w){h({dc:[],sales:[],finance:[],users:[],vendors:[],products:[],smsTemplates:[],loading:!1,error:(w==null?void 0:w.message)||"Failed to load dropdown data",searchResults:null}),console.error("[dropdowns] Dropdown data load failed:",w)}};S.useEffect(()=>{try{const g=We({departments:["Sales","Sales Consultant","Sales Consultants"]}),q=We({departments:["Delivery","Delivery Coordinator","Delivery Coordinators"]}),L=We({departments:["Finance","Finance Manager","Finance Managers"]}),R=hs({activeOnly:!0}),w=ms({activeOnly:!0});[g==null?void 0:g.length,q==null?void 0:q.length,L==null?void 0:L.length,R==null?void 0:R.length,w==null?void 0:w.length].some(Boolean)&&h(Y=>({...Y,sales:g||Y.sales,dc:q||Y.dc,finance:L||Y.finance,vendors:R||Y.vendors,products:w||Y.products,loading:!1,error:null}))}catch(g){console.info("[dropdowns] cached-first hydrate skipped:",g==null?void 0:g.message)}},[]);const y=()=>u?Date.now()-u<r:!1,m=async()=>{y()||await b()},M=async g=>{try{if(!(g!=null&&g.trim())){h(L=>({...L,searchResults:null}));return}const q=await bs(g);h(L=>({...L,searchResults:q}))}catch(q){console.error("[dropdowns:search] Search failed:",q),h(L=>({...L,searchResults:{users:[],vendors:[]}}))}},se=()=>{h(g=>({...g,searchResults:null}))},O=(g={})=>{const{roles:q=[],departments:L=[],activeOnly:R=!0}=g;let w=(o==null?void 0:o.users)||[];return R&&(w=w==null?void 0:w.filter(A=>A==null?void 0:A.is_active)),(q==null?void 0:q.length)>0&&(w=w==null?void 0:w.filter(A=>q==null?void 0:q.includes(A==null?void 0:A.role))),(L==null?void 0:L.length)>0&&(w=w==null?void 0:w.filter(A=>L==null?void 0:L.includes(A==null?void 0:A.department))),(w==null?void 0:w.map(A=>({id:A==null?void 0:A.id,value:A==null?void 0:A.id,label:A==null?void 0:A.full_name,name:A==null?void 0:A.full_name,role:A==null?void 0:A.role,department:A==null?void 0:A.department,email:A==null?void 0:A.email})))||[]},N=(g={})=>{const{activeOnly:q=!0,specialty:L=null}=g;let R=(o==null?void 0:o.vendors)||[];return q&&(R=R==null?void 0:R.filter(w=>w==null?void 0:w.is_active)),L&&(R=R==null?void 0:R.filter(w=>{var A,Y;return(Y=(A=w==null?void 0:w.specialty)==null?void 0:A.toLowerCase())==null?void 0:Y.includes(L==null?void 0:L.toLowerCase())})),(R==null?void 0:R.map(w=>({id:w==null?void 0:w.id,value:(w==null?void 0:w.value)||(w==null?void 0:w.id),label:(w==null?void 0:w.label)||(w==null?void 0:w.name),name:w==null?void 0:w.name,specialty:w==null?void 0:w.specialty,email:w==null?void 0:w.email,phone:w==null?void 0:w.phone})))||[]};return S.useEffect(()=>{let g=!0;return(async()=>{var L;if(!x)return;const q=Date.now();for(;g&&(p!=null&&p.loading)&&Date.now()-q<5e3;)await new Promise(R=>setTimeout(R,200));g&&(p!=null&&p.user?(console.log("Dropdowns: authenticated user",(L=p==null?void 0:p.user)==null?void 0:L.id),p!=null&&p.userProfile&&console.log("Dropdowns: user profile org",p.userProfile)):console.warn("Dropdowns: no authenticated user; dropdown queries will likely return empty due to RLS"),g&&await b())})(),()=>{g=!1}},[x,p==null?void 0:p.loading,(a=p==null?void 0:p.user)==null?void 0:a.id,f==null?void 0:f.loading,f==null?void 0:f.orgId]),{dc:o==null?void 0:o.dc,sales:o==null?void 0:o.sales,finance:o==null?void 0:o.finance,users:o==null?void 0:o.users,vendors:o==null?void 0:o.vendors,products:o==null?void 0:o.products,smsTemplates:o==null?void 0:o.smsTemplates,loading:o==null?void 0:o.loading,error:o==null?void 0:o.error,searchResults:o==null?void 0:o.searchResults,globalSearch:M,clearSearch:se,getUserOptions:O,getVendorOptions:N,refresh:b,refreshIfNeeded:m,lastUpdate:u,isCacheValid:y(),salesConsultantOptions:(I=(o==null?void 0:o.sales)||[])==null?void 0:I.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),deliveryCoordinatorOptions:(i=(o==null?void 0:o.dc)||[])==null?void 0:i.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name})),financeManagerOptions:(le=(o==null?void 0:o.finance)||[])==null?void 0:le.map(g=>({id:g==null?void 0:g.id,value:g==null?void 0:g.id,label:g==null?void 0:g.full_name,name:g==null?void 0:g.full_name}))}}const Ls=()=>{var p,b,y;const{dc:t,sales:x,finance:r,vendors:o,products:h,loading:u,error:d,refresh:f}=us({loadOnMount:!0});return{salesConsultants:x,deliveryCoordinators:t,financeManagers:r,vendors:o,products:h,loading:u,error:d,refresh:f,salesConsultantOptions:(p=x||[])==null?void 0:p.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),deliveryCoordinatorOptions:(b=t||[])==null?void 0:b.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),financeManagerOptions:(y=r||[])==null?void 0:y.map(m=>({id:m==null?void 0:m.id,value:m==null?void 0:m.id,label:m==null?void 0:m.full_name,name:m==null?void 0:m.full_name})),vendorOptions:o||[],productOptions:h||[]}},$s=()=>(ds.useEffect(()=>{console.warn("Placeholder: Portal is not implemented yet.")},[]),e.jsx(e.Fragment,{})),Re=({options:t=[],value:x,onChange:r,placeholder:o="Select...",searchable:h=!1,clearable:u=!1,disabled:d=!1,loading:f=!1,error:p=null,className:b="",optionLabel:y="label",optionValue:m="value",groupBy:M=null,renderOption:se=null,label:O="",helperText:N=""})=>{const[a,I]=S.useState(!1),[i,le]=S.useState(""),[g,q]=S.useState(!1),[L,R]=S.useState(t),[w,A]=S.useState(-1),[Y,_e]=S.useState({top:0,left:0,width:0}),K=S.useRef(null),je=S.useRef(null);S.useRef(null),S.useEffect(()=>{q((()=>{var n;return(n=window.matchMedia("(max-width: 767px)"))==null?void 0:n.matches})());const U=window.matchMedia("(max-width: 767px)"),ee=()=>q(U==null?void 0:U.matches);return U==null||U.addEventListener("change",ee),()=>U==null?void 0:U.removeEventListener("change",ee)},[]),S.useEffect(()=>{if(!(i!=null&&i.trim())){R(t);return}const j=i==null?void 0:i.toLowerCase(),U=t==null?void 0:t.filter(ee=>{const n=[ee==null?void 0:ee.name,ee==null?void 0:ee.displayName,ee==null?void 0:ee.category,ee==null?void 0:ee.brand,ee==null?void 0:ee.specialty,ee==null?void 0:ee.department,ee==null?void 0:ee.email].filter(Boolean);return n==null?void 0:n.some(k=>{var $;return($=k==null?void 0:k.toLowerCase())==null?void 0:$.includes(j)})});R(U),A(-1)},[i,t]);const ce=t==null?void 0:t.find(j=>(j==null?void 0:j.id)===x),ae=j=>((j==null?void 0:j[m])||(j==null?void 0:j.id))===x,v=()=>{var j;if(K!=null&&K.current){const U=(j=K==null?void 0:K.current)==null?void 0:j.getBoundingClientRect();_e({top:(U==null?void 0:U.bottom)+window.scrollY,left:(U==null?void 0:U.left)+window.scrollX,width:U==null?void 0:U.width})}};S.useEffect(()=>{a&&!g&&v()},[a,g]),S.useEffect(()=>{if(g)return;const j=U=>{var ee;K!=null&&K.current&&!((ee=K==null?void 0:K.current)!=null&&ee.contains(U==null?void 0:U.target))&&(I(!1),le(""),A(-1))};return document==null||document.addEventListener("mousedown",j),()=>document==null?void 0:document.removeEventListener("mousedown",j)},[g]);const V=j=>{if(!g){if(!a){((j==null?void 0:j.key)==="Enter"||(j==null?void 0:j.key)===" "||(j==null?void 0:j.key)==="ArrowDown")&&(j==null||j.preventDefault(),I(!0),h&&setTimeout(()=>{var U;return(U=je==null?void 0:je.current)==null?void 0:U.focus()},0));return}switch(j==null?void 0:j.key){case"Escape":I(!1),le(""),A(-1);break;case"ArrowDown":j==null||j.preventDefault(),A(U=>U<(L==null?void 0:L.length)-1?U+1:0);break;case"ArrowUp":j==null||j.preventDefault(),A(U=>U>0?U-1:(L==null?void 0:L.length)-1);break;case"Enter":j==null||j.preventDefault(),w>=0&&(L!=null&&L[w])&&Ce(L==null?void 0:L[w]);break;case"Tab":I(!1),le(""),A(-1);break}}},Ce=j=>{r==null||r(j==null?void 0:j.id),I(!1),le(""),A(-1)},Le=j=>{j==null||j.stopPropagation(),r==null||r(null)};return g?e.jsxs("div",{className:`relative ${b}`,children:[e.jsxs("select",{value:x||"",onChange:j=>{var U;return r==null?void 0:r(((U=j==null?void 0:j.target)==null?void 0:U.value)||null)},disabled:d||f,className:`
            w-full px-3 py-2 border rounded-lg
            ${p?"border-red-500":"border-gray-300"}
            ${d||f?"bg-gray-100 cursor-not-allowed":"bg-white"}
            focus:ring-1 focus:ring-blue-500 focus:border-blue-500
            appearance-none text-base
          `,children:[e.jsx("option",{value:"",children:o}),t==null?void 0:t.map(j=>e.jsx("option",{value:(j==null?void 0:j[m])||(j==null?void 0:j.id),children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[m])||(j==null?void 0:j.id)))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(H,{name:"ChevronDown",size:16,className:"text-gray-400"})}),p&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:p})]}):e.jsxs("div",{className:`relative ${b}`,ref:K,children:[e.jsxs("button",{type:"button",onClick:()=>!d&&!f&&I(!a),onKeyDown:V,disabled:d||f,className:`
          w-full px-3 py-2 text-left border rounded-lg
          ${p?"border-red-500":"border-gray-300"}
          ${d||f?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-gray-400"}
          ${a?"ring-1 ring-blue-500 border-blue-500":""}
          focus:ring-1 focus:ring-blue-500 focus:border-blue-500
          flex items-center justify-between
        `,children:[e.jsx("span",{className:ce?"text-gray-900":"text-gray-500",children:ce?(ce==null?void 0:ce[y])||(ce==null?void 0:ce.label):o}),e.jsxs("div",{className:"flex items-center space-x-1",children:[f&&e.jsx(H,{name:"Loader2",size:16,className:"animate-spin text-gray-400"}),u&&ce&&!f&&e.jsx("button",{type:"button",onClick:Le,className:"p-0.5 hover:bg-gray-200 rounded",children:e.jsx(H,{name:"X",size:14,className:"text-gray-400 hover:text-gray-600"})}),e.jsx(H,{name:a?"ChevronUp":"ChevronDown",size:16,className:"text-gray-400"})]})]}),a&&typeof window<"u"&&e.jsx($s,{children:e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>I(!1),children:e.jsxs("div",{style:{position:"absolute",top:`${Y==null?void 0:Y.top}px`,left:`${Y==null?void 0:Y.left}px`,width:`${Y==null?void 0:Y.width}px`,zIndex:9999},className:"bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden",onClick:j=>j==null?void 0:j.stopPropagation(),children:[h&&e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:i,onChange:j=>{var U;return le((U=j==null?void 0:j.target)==null?void 0:U.value)},placeholder:"Search...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0})}),e.jsx("div",{className:"max-h-48 overflow-auto",children:(L==null?void 0:L.length)===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:i?"No results found":"No options available"}):L==null?void 0:L.map(j=>e.jsx("button",{type:"button",onClick:()=>Ce(j),className:`
                        w-full px-3 py-2 text-left text-sm hover:bg-gray-50
                        ${ae(j)?"bg-blue-50 text-blue-700":"text-gray-900"}
                        focus:bg-gray-50 focus:outline-none
                      `,children:(j==null?void 0:j[y])||(j==null?void 0:j.label)||(j==null?void 0:j.name)},(j==null?void 0:j[m])||(j==null?void 0:j.id)))})]})})}),p&&e.jsx("div",{className:"mt-1 text-sm text-red-600",children:p})]})},Ms=({isOpen:t,dealId:x,deal:r,onClose:o,onSuccess:h})=>{var Be,ue,ve,Ne,Pe,Me,Ae;const[u,d]=S.useState(!0),[f,p]=S.useState(!1),[b,y]=S.useState(""),[m,M]=S.useState(!1),[se,O]=S.useState(!1),[N,a]=S.useState(!1),[I,i]=S.useState(!1),[le,g]=S.useState(null),[q,L]=S.useState(null),[R,w]=S.useState({loaner_number:"",eta_return_date:"",notes:""}),{salesConsultantOptions:A,deliveryCoordinatorOptions:Y,financeManagerOptions:_e,vendorOptions:K,productOptions:je,loading:ce,refresh:ae}=Ls(),[v,V]=S.useState({customerName:"",customerPhone:"",customerEmail:"",job_status:"draft",priority:"medium",customer_needs_loaner:!1,assignedTo:null,deliveryCoordinator:null,financeManager:null,lineItems:[]}),Ce=(c=[],l,C="Selected")=>!l||Array.isArray(c)&&c.some(F=>(F==null?void 0:F.id)===l)?c:[...c||[],{id:l,value:l,label:C}],Le=S.useMemo(()=>Ce(K,v==null?void 0:v.vendor_id,"Selected vendor"),[K,v==null?void 0:v.vendor_id]),j=S.useMemo(()=>Ce(A,v==null?void 0:v.assignedTo,"Selected user"),[A,v==null?void 0:v.assignedTo]),U=S.useMemo(()=>Ce(Y,v==null?void 0:v.deliveryCoordinator,"Selected user"),[Y,v==null?void 0:v.deliveryCoordinator]),ee=S.useMemo(()=>Ce(_e,v==null?void 0:v.financeManager,"Selected user"),[_e,v==null?void 0:v.financeManager]);S.useEffect(()=>{if(le){const c=JSON.stringify(v)!==JSON.stringify(le);a(c)}},[v,le]),S.useEffect(()=>{if(t)try{ae==null||ae()}catch{}},[t,ae]),S.useEffect(()=>{var c;if(t)if(r&&(r!=null&&r.id))try{const l=Ze(r),C={...l,assignedTo:(l==null?void 0:l.assigned_to)||null,deliveryCoordinator:(l==null?void 0:l.delivery_coordinator_id)||null,financeManager:(l==null?void 0:l.finance_manager_id)||null,vendor_id:(l==null?void 0:l.vendor_id)||null,customerName:(r==null?void 0:r.customer_name)||"",customerPhone:(r==null?void 0:r.customer_phone)||"",customerEmail:(r==null?void 0:r.customer_email)||"",lineItems:((c=(l==null?void 0:l.lineItems)||[])==null?void 0:c.length)>0?oe(l==null?void 0:l.lineItems):[ie()]};V(C),g(JSON.parse(JSON.stringify(C))),d(!1),y("")}catch(l){console.warn("[EditDealModal] failed to preload deal, falling back to fetch:",l),de()}else x?de():(y("No deal selected to edit."),d(!1))},[t,x,r==null?void 0:r.id]),S.useEffect(()=>{if(!t||!u)return;const c=setTimeout(()=>{d(!1),y(l=>l||"Took longer than expected to load. You can retry the load.")},8e3);return()=>clearTimeout(c)},[t,u]);const n=({checked:c,onChange:l})=>e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border",children:e.jsxs("label",{htmlFor:"customer_needs_loaner",className:"inline-flex items-center gap-3 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{id:"customer_needs_loaner",type:"checkbox",checked:!!c,onChange:C=>{var F;return l(!!((F=C==null?void 0:C.target)!=null&&F.checked))},className:"w-5 h-5 accent-blue-600 appearance-auto border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500","data-testid":"loaner-checkbox"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 select-none",children:"Customer needs loaner vehicle"})]})}),k=({value:c,selectedValue:l,onChange:C,itemIndex:F,disabled:be=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${F}`,value:"in_house",checked:!l,onChange:()=>C(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-in-house",disabled:be}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ  On-Site"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`serviceLocation_${F}`,value:"vendor",checked:l,onChange:()=>C(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"service-type-vendor",disabled:be}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"ðŸ¢ Off-Site"})]})]}),$=({requiresScheduling:c,onChange:l,itemIndex:C,disabled:F=!1})=>e.jsxs("div",{className:"flex space-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${C}`,checked:c===!0,onChange:()=>l(!0),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-yes",disabled:F}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"Needs scheduling"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 min-h-11 px-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`scheduling_${C}`,checked:c===!1,onChange:()=>l(!1),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500","data-testid":"requires-scheduling-no",disabled:F}),e.jsx("span",{className:"text-sm text-gray-700 select-none",children:"No scheduling needed"})]})]}),oe=(c=[])=>(c||[]).map(l=>({product_id:(l==null?void 0:l.product_id)??null,unit_price:(l==null?void 0:l.unit_price)??0,quantity_used:(l==null?void 0:l.quantity_used)??1,lineItemPromisedDate:(l==null?void 0:l.lineItemPromisedDate)||(l==null?void 0:l.promised_date)||"",requiresScheduling:typeof(l==null?void 0:l.requiresScheduling)=="boolean"?l==null?void 0:l.requiresScheduling:!!(l!=null&&l.requires_scheduling),noScheduleReason:(l==null?void 0:l.noScheduleReason)||(l==null?void 0:l.no_schedule_reason)||"",isOffSite:typeof(l==null?void 0:l.isOffSite)=="boolean"?l==null?void 0:l.isOffSite:!!(l!=null&&l.is_off_site),description:(l==null?void 0:l.description)||""})),de=async()=>{var c,l,C,F,be,te,J,W,ye,s;try{d(!0),y("");const _=await fs(x),E=Ze(_),{data:P}=await((F=(C=(l=(c=D)==null?void 0:c.from("transactions"))==null?void 0:l.select("customer_name, customer_phone, customer_email"))==null?void 0:C.eq("job_id",x))==null?void 0:F.single());let B=null;try{const{data:xe}=await((ye=(W=(J=(te=(be=D)==null?void 0:be.from("loaner_assignments"))==null?void 0:te.select("id, loaner_number, eta_return_date, returned_at"))==null?void 0:J.eq("job_id",x))==null?void 0:W.is("returned_at",null))==null?void 0:ye.limit(1));B=Array.isArray(xe)?xe[0]:xe}catch{}const fe={...E,assignedTo:(E==null?void 0:E.assigned_to)||null,deliveryCoordinator:(E==null?void 0:E.delivery_coordinator_id)||null,financeManager:(E==null?void 0:E.finance_manager_id)||null,vendor_id:(E==null?void 0:E.vendor_id)||null,customerName:(P==null?void 0:P.customer_name)||"",customerPhone:(P==null?void 0:P.customer_phone)||"",customerEmail:(P==null?void 0:P.customer_email)||"",lineItems:((s=(E==null?void 0:E.lineItems)||[])==null?void 0:s.length)>0?oe(E==null?void 0:E.lineItems):[ie()]};if(V(fe),g(JSON.parse(JSON.stringify(fe))),L(B||null),B)w({loaner_number:(B==null?void 0:B.loaner_number)||"",eta_return_date:(B==null?void 0:B.eta_return_date)||"",notes:(B==null?void 0:B.notes)||""});else{const xe=((fe==null?void 0:fe.lineItems)||[]).filter(Z=>(Z==null?void 0:Z.requiresScheduling)&&(Z==null?void 0:Z.lineItemPromisedDate)).map(Z=>new Date(Z.lineItemPromisedDate).getTime()),ge=xe!=null&&xe.length?new Date(Math.max(...xe)):null;w(Z=>({...Z,eta_return_date:ge?ge.toISOString().split("T")[0]:""}))}}catch(_){y(`Failed to load deal: ${_==null?void 0:_.message}`)}finally{d(!1)}},ie=()=>({product_id:null,unit_price:0,quantity_used:1,lineItemPromisedDate:"",requiresScheduling:!1,noScheduleReason:"",isOffSite:!1,description:""}),X=c=>{V(l=>({...l,...c}))},me=(c,l)=>{if(V(C=>{var F;return{...C,lineItems:(F=C==null?void 0:C.lineItems)==null?void 0:F.map((be,te)=>{if(te===c){let J={...be,...l};return"requiresScheduling"in l&&(J.requiresScheduling=!!(l!=null&&l.requiresScheduling),(l==null?void 0:l.requiresScheduling)===!0?J.noScheduleReason="":J.lineItemPromisedDate=""),"isOffSite"in l&&(J.isOffSite=!!(l!=null&&l.isOffSite),l!=null&&l.isOffSite||(J.vendorId="")),J}return be})}}),l!=null&&l.product_id){const C=je==null?void 0:je.find(F=>(F==null?void 0:F.id)===(l==null?void 0:l.product_id));C&&V(F=>{var be;return{...F,lineItems:(be=F==null?void 0:F.lineItems)==null?void 0:be.map((te,J)=>J===c?{...te,unit_price:(C==null?void 0:C.unitPrice)||(C==null?void 0:C.unit_price)||(te==null?void 0:te.unit_price),cost_price:(C==null?void 0:C.cost)||(te==null?void 0:te.cost_price)}:te)}})}},G=()=>{V(c=>({...c,lineItems:[...c==null?void 0:c.lineItems,ie()]}))},T=c=>{V(l=>{var C;return{...l,lineItems:(C=l==null?void 0:l.lineItems)==null?void 0:C.filter((F,be)=>be!==c)}})},re=async()=>{var c,l,C,F,be;try{if(p(!0),y(""),!((c=v==null?void 0:v.customerName)!=null&&c.trim())){y("Customer name is required");return}for(let W=0;W<((l=v==null?void 0:v.lineItems)==null?void 0:l.length);W++){const ye=(C=v==null?void 0:v.lineItems)==null?void 0:C[W];if(!(ye!=null&&ye.product_id)){y(`Line item ${W+1}: Product is required`);return}if(ye!=null&&ye.requiresScheduling&&!(ye!=null&&ye.lineItemPromisedDate)){y(`Line item ${W+1}: Promised date is required when scheduling is needed`);return}if(!(ye!=null&&ye.requiresScheduling)&&!((F=ye==null?void 0:ye.noScheduleReason)!=null&&F.trim())){y(`Line item ${W+1}: Reason is required when no scheduling is needed`);return}}const te={...v,customer_needs_loaner:!!(v!=null&&v.customer_needs_loaner),lineItems:(be=v==null?void 0:v.lineItems)==null?void 0:be.map(W=>({...W,requiresScheduling:!!(W!=null&&W.requiresScheduling),isOffSite:!!(W!=null&&W.isOffSite),unit_price:parseFloat(W==null?void 0:W.unit_price)||0,quantity_used:parseInt(W==null?void 0:W.quantity_used)||1}))},J={...te,assigned_to:(te==null?void 0:te.assignedTo)??null,delivery_coordinator_id:(te==null?void 0:te.deliveryCoordinator)??null,finance_manager_id:(te==null?void 0:te.financeManager)??null,vendor_id:(te==null?void 0:te.vendor_id)??null};await ps(x,{...J,loanerForm:R}),h==null||h(),o==null||o()}catch(te){y(`Failed to save deal: ${te==null?void 0:te.message}`)}finally{p(!1)}},we=async()=>{try{O(!0),await js(x),h==null||h(),o==null||o()}catch(c){y(`Failed to delete deal: ${c==null?void 0:c.message}`)}finally{O(!1),M(!1)}},Ee=()=>{N?i(!0):o()},$e=()=>{i(!1),o()},qe=()=>{var c;return((c=v==null?void 0:v.lineItems)==null?void 0:c.reduce((l,C)=>{const F=parseFloat(C==null?void 0:C.unit_price)||0,be=parseInt(C==null?void 0:C.quantity_used)||1;return l+F*be},0))||0};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-slate-50",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Deal"}),e.jsx("button",{onClick:Ee,className:"p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600",children:e.jsx(H,{name:"X",size:20})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:e.jsxs("div",{className:"p-6 space-y-6 bg-white",children:[b&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 text-sm",children:b})}),u?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-3",children:[e.jsx("div",{className:"text-gray-600",children:"Loading deal..."}),e.jsx("button",{type:"button",onClick:()=>{de();try{ae==null||ae()}catch{}},className:"text-sm text-blue-600 hover:text-blue-800",children:"Having trouble? Retry load"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs(Je,{value:v==null?void 0:v.job_status,onChange:c=>{var l;return X({job_status:(l=c==null?void 0:c.target)==null?void 0:l.value})},children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Name *"}),e.jsx(ke,{id:"customer-name","aria-label":"Customer name input",label:"",helperText:"",maxLength:255,style:{},value:v==null?void 0:v.customerName,onChange:c=>{var l;return X({customerName:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Phone"}),e.jsx(ke,{id:"customer-phone","aria-label":"Customer phone input",label:"",helperText:"",maxLength:20,style:{},value:v==null?void 0:v.customerPhone,onChange:c=>{var l;return X({customerPhone:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Enter phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Email"}),e.jsx(ke,{id:"customer-email","aria-label":"Customer email input",label:"",helperText:"",maxLength:255,style:{},type:"email",value:v==null?void 0:v.customerEmail,onChange:c=>{var l;return X({customerEmail:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs(Je,{value:v==null?void 0:v.priority,onChange:c=>{var l;return X({priority:(l=c==null?void 0:c.target)==null?void 0:l.value})},children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"block bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Vehicle Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Year"}),e.jsx(ke,{id:"vehicle-year","aria-label":"Vehicle year input",label:"",helperText:"",maxLength:4,style:{},type:"number",value:(v==null?void 0:v.vehicleYear)||"",onChange:c=>{var l;return X({vehicleYear:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"2024",min:"1900",max:((Be=new Date)==null?void 0:Be.getFullYear())+2})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Make"}),e.jsx(ke,{id:"vehicle-make","aria-label":"Vehicle make input",label:"",helperText:"",maxLength:50,style:{},value:(v==null?void 0:v.vehicleMake)||"",onChange:c=>{var l;return X({vehicleMake:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Toyota"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Model"}),e.jsx(ke,{id:"vehicle-model","aria-label":"Vehicle model input",label:"",helperText:"",maxLength:50,style:{},value:(v==null?void 0:v.vehicleModel)||"",onChange:c=>{var l;return X({vehicleModel:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Camry"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock Number"}),e.jsx(ke,{id:"vehicle-stock","aria-label":"Vehicle stock number input",label:"",helperText:"",maxLength:20,style:{},value:(v==null?void 0:v.stockNumber)||"",onChange:c=>{var l;return X({stockNumber:(l=c==null?void 0:c.target)==null?void 0:l.value})},placeholder:"Enter stock number"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(n,{checked:v==null?void 0:v.customer_needs_loaner,onChange:c=>{if(X({customer_needs_loaner:c}),c&&!(R!=null&&R.eta_return_date)){const l=((v==null?void 0:v.lineItems)||[]).filter(F=>(F==null?void 0:F.requiresScheduling)&&(F==null?void 0:F.lineItemPromisedDate)).map(F=>new Date(F.lineItemPromisedDate).getTime()),C=l!=null&&l.length?new Date(Math.max(...l)):null;C&&w(F=>({...F,eta_return_date:C.toISOString().split("T")[0]}))}}}),q&&e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200",children:["ðŸš— Loaner #",q==null?void 0:q.loaner_number,(q==null?void 0:q.eta_return_date)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due"," ",(ue=new Date(q==null?void 0:q.eta_return_date))==null?void 0:ue.toLocaleDateString("en-US",{month:"short",day:"numeric"})]})]}),(v==null?void 0:v.customer_needs_loaner)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loaner Number"}),e.jsx(ke,{id:"loaner-number","aria-label":"Loaner number",value:(R==null?void 0:R.loaner_number)||"",onChange:c=>w(l=>{var C;return{...l,loaner_number:(C=c==null?void 0:c.target)==null?void 0:C.value}}),placeholder:"e.g. 1234"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ETA Return Date"}),e.jsx(ke,{id:"loaner-eta","aria-label":"Loaner ETA",type:"date",value:(R==null?void 0:R.eta_return_date)||"",onChange:c=>w(l=>{var C;return{...l,eta_return_date:(C=c==null?void 0:c.target)==null?void 0:C.value}}),min:(Pe=(Ne=(ve=new Date)==null?void 0:ve.toISOString())==null?void 0:Ne.split("T"))==null?void 0:Pe[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ke,{id:"loaner-notes","aria-label":"Loaner notes",value:(R==null?void 0:R.notes)||"",onChange:c=>w(l=>{var C;return{...l,notes:(C=c==null?void 0:c.target)==null?void 0:C.value}}),placeholder:"Optional notes"})]})]})]}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Dealer Representatives"}),e.jsxs("div",{className:"mb-4","data-testid":"vendor-select",children:[e.jsx(Re,{label:"Vendor",options:Le,value:(v==null?void 0:v.vendor_id)||"",onChange:c=>X({vendor_id:c||null}),placeholder:"Select vendor",searchable:!0,clearable:!0,groupBy:"specialty"}),!ce&&((K==null?void 0:K.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No vendors found yet. Add one in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"sales-select",children:[e.jsx(Re,{label:"Sales Consultant",options:j,value:v==null?void 0:v.assignedTo,onChange:c=>X({assignedTo:c}),placeholder:"Select sales consultant",searchable:!0,clearable:!0}),!ce&&((A==null?void 0:A.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{className:"mb-4","data-testid":"delivery-select",children:[e.jsx(Re,{label:"Delivery Coordinator",options:U,value:v==null?void 0:v.deliveryCoordinator,onChange:c=>X({deliveryCoordinator:c}),placeholder:"Select delivery coordinator",searchable:!0,clearable:!0}),!ce&&((Y==null?void 0:Y.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]}),e.jsxs("div",{"data-testid":"finance-select",children:[e.jsx(Re,{label:"Finance Manager",options:ee,value:v==null?void 0:v.financeManager,onChange:c=>X({financeManager:c}),placeholder:"Select finance manager",searchable:!0,clearable:!0,helperText:"Optional - does not block saves"}),!ce&&((_e==null?void 0:_e.length)||0)===0&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["No staff found for this role. Add staff in Admin."," ",e.jsx("a",{href:"/admin",target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:"Open Admin"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs(z,{className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Add line item",variant:"outline",size:"sm",onClick:G,children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"space-y-4",children:(Me=v==null?void 0:v.lineItems)==null?void 0:Me.map((c,l)=>{var C,F,be,te;return e.jsxs("div",{className:"border rounded-xl p-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["Item #",l+1]}),((C=v==null?void 0:v.lineItems)==null?void 0:C.length)>1&&e.jsx(z,{className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Remove line item",variant:"ghost",size:"sm",onClick:()=>T(l),children:e.jsx(H,{name:"Trash2",size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("div",{children:e.jsx(Re,{label:"Product *",options:je,value:(c==null?void 0:c.product_id)||"",onChange:J=>me(l,{product_id:J?parseInt(J):null}),placeholder:"Select product",searchable:!0,clearable:!0,groupBy:"category"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Unit Price *"}),e.jsx(ke,{id:`unit-price-${l}`,"aria-label":"Unit price input",label:"",helperText:"",maxLength:10,style:{},type:"number",step:"0.01",value:c==null?void 0:c.unit_price,onChange:J=>{var W;return me(l,{unit_price:parseFloat((W=J==null?void 0:J.target)==null?void 0:W.value)||0})},placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx(ke,{id:`quantity-${l}`,"aria-label":"Quantity input",label:"",helperText:"",maxLength:10,style:{},type:"number",min:"1",value:c==null?void 0:c.quantity_used,onChange:J=>{var W;return me(l,{quantity_used:parseInt((W=J==null?void 0:J.target)==null?void 0:W.value)||1})},placeholder:"1"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx(k,{selectedValue:c==null?void 0:c.isOffSite,onChange:J=>me(l,{isOffSite:J}),itemIndex:l})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("h5",{className:"font-medium text-gray-900 mb-3",children:"Scheduling"}),e.jsx("div",{className:"mb-3",children:e.jsx($,{requiresScheduling:c==null?void 0:c.requiresScheduling,onChange:J=>me(l,{requiresScheduling:J}),itemIndex:l})}),c!=null&&c.requiresScheduling?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Promised Date *"}),e.jsx(ke,{id:`promised-date-${l}`,"aria-label":"Promised date input",label:"",helperText:"",maxLength:255,style:{},type:"date",value:c==null?void 0:c.lineItemPromisedDate,onChange:J=>{var W;return me(l,{lineItemPromisedDate:(W=J==null?void 0:J.target)==null?void 0:W.value})},min:(te=(be=(F=new Date)==null?void 0:F.toISOString())==null?void 0:be.split("T"))==null?void 0:te[0],placeholder:""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx(ke,{id:`notes-${l}`,"aria-label":"Notes input",label:"",helperText:"",maxLength:500,style:{},value:(c==null?void 0:c.description)||"",onChange:J=>{var W;return me(l,{description:(W=J==null?void 0:J.target)==null?void 0:W.value})},placeholder:"Special instructions..."})]})]}):e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for no schedule *"}),e.jsx(ke,{id:`no-schedule-reason-${l}`,"aria-label":"No schedule reason input",label:"",helperText:"",maxLength:255,style:{},value:c==null?void 0:c.noScheduleReason,onChange:J=>{var W;return me(l,{noScheduleReason:(W=J==null?void 0:J.target)==null?void 0:W.value})},placeholder:"e.g., installed at delivery, no appointment needed"})]})]}),e.jsxs("div",{className:"text-right mt-3 text-sm text-gray-600",children:["Line Total: $",((parseFloat(c==null?void 0:c.unit_price)||0)*(parseInt(c==null?void 0:c.quantity_used)||1)).toFixed(2)]})]},l)})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("div",{className:"bg-green-50 border border-green-200 px-4 py-2 rounded-lg",children:e.jsxs("span",{className:"font-medium text-green-900",children:["Deal Total: $",(Ae=qe())==null?void 0:Ae.toFixed(2)]})})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between p-6 border-t bg-slate-50 gap-3",children:[e.jsxs(z,{className:"w-full md:w-auto h-11 text-red-600 border-red-300 hover:bg-red-50","aria-label":"Delete deal",variant:"outline",onClick:()=>M(!0),children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete Deal"]}),e.jsxs("div",{className:"flex space-x-3 w-full md:w-auto",children:[e.jsx(z,{className:"w-full md:w-auto h-11","aria-label":"Cancel editing",variant:"outline",onClick:Ee,children:"Cancel"}),e.jsx(z,{className:"w-full md:w-auto h-11 bg-blue-600 hover:bg-blue-700","aria-label":"Save changes",onClick:re,disabled:f,children:f?"Saving...":"Save Changes"})]})]}),m&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Delete Deal"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this deal and all its line items? This action cannot be undone."}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(z,{className:"flex-1 h-11","aria-label":"Cancel deletion",variant:"outline",onClick:()=>M(!1),children:"Cancel"}),e.jsx(z,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",onClick:we,disabled:se,children:se?"Deleting...":"Delete"})]})]})}),I&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Unsaved Changes"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You have unsaved changes. Are you sure you want to close and discard your changes?"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(z,{className:"flex-1 h-11","aria-label":"Keep editing",variant:"outline",onClick:()=>i(!1),children:"Keep Editing"}),e.jsx(z,{className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Discard changes",onClick:$e,children:"Discard Changes"})]})]})})]})}):null};function Os({isOpen:t,onClose:x,deal:r}){const[o,h]=S.useState("Customer"),[u,d]=S.useState(""),f=S.useMemo(()=>["Customer","Vehicle","Deal & Pricing","Scheduling","Vendor","Files","Activity","Alerts/Holds"],[]);if(!t||!r)return null;const p=async m=>{try{await navigator.clipboard.writeText(m),d("Copied!"),setTimeout(()=>d(""),1500)}catch{d("Copy failed"),setTimeout(()=>d(""),1500)}},b=({title:m,children:M})=>e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2",children:m}),e.jsx("div",{className:"bg-white border border-slate-200 rounded-lg p-3 text-sm text-slate-800",children:M||e.jsx("span",{className:"text-slate-400",children:"â€”"})})]}),y=()=>{var m,M,se,O,N;switch(o){case"Customer":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Customer",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(r==null?void 0:r.customer_name)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_email)||"â€”"}),e.jsx("div",{className:"text-slate-600",children:(r==null?void 0:r.customer_phone)||"â€”"})]}),e.jsxs("div",{className:"flex gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:a=>a.stopPropagation(),children:e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:a=>a.stopPropagation(),children:e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",onClick:()=>p(`${(r==null?void 0:r.customer_name)||""} ${(r==null?void 0:r.customer_phone)||""}`.trim()),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy"]})]})]})})});case"Vehicle":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Vehicle",children:e.jsxs("div",{children:[e.jsx("div",{children:r!=null&&r.vehicle?`${((m=r==null?void 0:r.vehicle)==null?void 0:m.year)||""} ${((M=r==null?void 0:r.vehicle)==null?void 0:M.make)||""} ${((se=r==null?void 0:r.vehicle)==null?void 0:se.model)||""}`.trim():"â€”"}),((O=r==null?void 0:r.vehicle)==null?void 0:O.stock_number)&&e.jsxs("div",{className:"text-slate-600",children:["Stock: ",(N=r==null?void 0:r.vehicle)==null?void 0:N.stock_number]})]})})});case"Deal & Pricing":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Totals",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Value"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(parseFloat(r==null?void 0:r.total_amount)||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Est. Margin"}),e.jsx("div",{className:"font-medium",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(r==null?void 0:r.total_amount)||0)*.25)})]})]})})});case"Scheduling":return e.jsxs(e.Fragment,{children:[e.jsx(b,{title:"Appointment",children:r!=null&&r.appt_start?e.jsxs("div",{className:"text-sm",children:[new Date(r==null?void 0:r.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(r==null?void 0:r.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",r!=null&&r.appt_end?new Date(r==null?void 0:r.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):"â€”"}),e.jsx(b,{title:"Next Promise",children:r!=null&&r.next_promised_iso?new Date(r==null?void 0:r.next_promised_iso).toLocaleString():"â€”"})]});case"Vendor":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Vendor",children:e.jsx("div",{children:(r==null?void 0:r.vendor_name)||"Unassigned"})})});case"Files":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Files",children:"No files yet."})});case"Activity":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Activity",children:"Activity timeline coming soon."})});case"Alerts/Holds":return e.jsx(e.Fragment,{children:e.jsx(b,{title:"Alerts/Holds",children:"No alerts."})});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50",onClick:x}),e.jsxs("div",{className:"fixed right-0 top-0 h-full w-full md:w-[520px] bg-white shadow-xl z-50 overflow-y-auto",children:[e.jsxs("div",{className:"p-5 border-b bg-white sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:(r==null?void 0:r.job_number)||`Job-${String((r==null?void 0:r.id)||"").slice(0,8)}`}),e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:(r==null?void 0:r.customer_name)||"Deal Details"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[u&&e.jsx("span",{className:"text-xs text-slate-500",children:u}),e.jsx(z,{variant:"ghost",size:"icon",onClick:x,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`tel:${r==null?void 0:r.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(z,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"Phone",size:16,className:"mr-1"})," Call"]})}),(r==null?void 0:r.customer_phone)&&e.jsx("a",{href:`sms:${r==null?void 0:r.customer_phone}`,onClick:m=>m.stopPropagation(),children:e.jsxs(z,{size:"sm",className:"h-9",children:[e.jsx(H,{name:"MessageSquare",size:16,className:"mr-1"})," SMS"]})}),e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",onClick:()=>p((r==null?void 0:r.customer_phone)||""),children:[e.jsx(H,{name:"Copy",size:16,className:"mr-1"})," Copy Phone"]}),e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"Calendar",size:16,className:"mr-1"})," Schedule"]}),e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"FileText",size:16,className:"mr-1"})," Note"]}),e.jsxs(z,{size:"sm",variant:"outline",className:"h-9",disabled:!0,children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-1"})," Complete"]})]})]}),e.jsx("div",{className:"px-5 pt-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:f.map(m=>e.jsx("button",{onClick:()=>h(m),className:`px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap border ${o===m?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:m},m))})}),e.jsx("div",{className:"p-5",children:y()})]})]})}const es=({status:t})=>{var h;const x={draft:"bg-gray-100 text-gray-700",pending:"bg-blue-100 text-blue-700",in_progress:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700"},r=(x==null?void 0:x[t])||"bg-gray-100 text-gray-700",o=((h=t==null?void 0:t.replace("_"," "))==null?void 0:h.toUpperCase())||"UNKNOWN";return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${r}`,children:o})},Ps=t=>{try{if(!t)return"â€”";const x=new Date(t);if(Number.isNaN(x.getTime()))return"â€”";const r=Date.now()-x.getTime(),o=Math.floor(r/1e3),h=Math.floor(o/60),u=Math.floor(h/60),d=Math.floor(u/24);return d>0?`${d}d ago`:u>0?`${u}h ago`:h>0?`${h}m ago`:"just now"}catch{return"â€”"}},ss=({nextPromisedAt:t})=>{var p;if(!t)return e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"});const x=new Date,o=new Date(t)-x,h=o<0,u=o>=0&&o<24*60*60*1e3,d=h?"bg-red-100 text-red-800 border-red-200":u?"bg-amber-100 text-amber-800 border-amber-200":"bg-green-100 text-green-800 border-green-200",f=(p=new Date(t))==null?void 0:p.toLocaleDateString("en-US",{month:"short",day:"numeric"});return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium border ${d}`,children:["Next: ",f]})},rs=({serviceType:t,jobParts:x})=>{const r=x==null?void 0:x.some(h=>h==null?void 0:h.is_off_site),o=x==null?void 0:x.some(h=>!(h!=null&&h.is_off_site));return r&&o?e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"ðŸ¢ Off-Site"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})]}):r?e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#3b82f6"},children:"ðŸ¢ Off-Site"}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white",style:{backgroundColor:"#22c55e"},children:"ðŸ  In-House"})},zs=({draftsCount:t,onViewDrafts:x})=>{const[r,o]=S.useState(!1);return t===0||r?null:e.jsx("div",{className:"mb-6 p-4 rounded-lg border",style:{backgroundColor:"#FEF3C7",borderColor:"#F3E8A3",color:"#92400E"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(H,{name:"AlertCircle",size:20,style:{color:"#D97706"}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Draft â€“ needs details"}),e.jsxs("p",{className:"text-sm",children:["You have ",t," draft deal",t>1?"s":""," to complete."]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(z,{size:"sm",variant:"ghost",onClick:x,style:{color:"#92400E"},className:"hover:bg-yellow-100","aria-label":"View draft deals",children:"View drafts"}),e.jsx("button",{onClick:()=>o(!0),className:"p-1",style:{color:"#F59E0B"},children:e.jsx(H,{name:"X",size:16})})]})]})})},Ye=t=>t?t!=null&&t.job_number?t.job_number:t!=null&&t.id?`Job-${String(t.id).slice(0,8)}`:"â€”":"â€”",xs=t=>t&&(t==null?void 0:t.customer_name)||"",Is=({deal:t})=>!(t!=null&&t.customer_name)&&!(t!=null&&t.customer_phone)?e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"}):e.jsxs("div",{className:"space-y-1",children:[(t==null?void 0:t.customer_name)&&e.jsx("div",{className:"font-medium text-sm text-slate-900",children:t==null?void 0:t.customer_name}),(t==null?void 0:t.customer_phone)&&e.jsx("a",{href:`tel:${t==null?void 0:t.customer_phone}`,className:"text-xs text-slate-500 hover:text-blue-600 underline",onClick:x=>x==null?void 0:x.stopPropagation(),children:t==null?void 0:t.customer_phone})]}),Fs=({amount:t})=>{var r;const x=parseFloat(t)||0;return e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm font-medium text-slate-900",children:(r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}))==null?void 0:r.format(x)})})},ts=({deal:t})=>{if(!(t!=null&&t.loaner_number))return null;const x=new Date,r=new Date(x);r.setHours(0,0,0,0);const o=t!=null&&t.loaner_eta_return_date?new Date(t==null?void 0:t.loaner_eta_return_date):null,h=!!(o&&o<r),u="inline-flex items-center px-2 py-1 rounded text-xs font-medium border",d=h?"bg-white text-red-700 border-red-300":"bg-teal-100 text-teal-800 border-teal-200",f=async p=>{var b;(b=p==null?void 0:p.stopPropagation)==null||b.call(p);try{await navigator.clipboard.writeText(String(t==null?void 0:t.loaner_number)),console.log("Loaner number copied")}catch(y){console.warn("Clipboard copy failed",y)}};return e.jsxs("span",{className:`${u} ${d} cursor-pointer`,onClick:f,title:"Click to copy loaner number",children:["ðŸš— Loaner #",t==null?void 0:t.loaner_number,(t==null?void 0:t.loaner_eta_short)&&e.jsxs("span",{className:"ml-1",children:["â€¢ due ",t==null?void 0:t.loaner_eta_short]})]})},qs=({isOpen:t,onClose:x,deal:r,onSave:o,loading:h})=>{var y,m,M,se;const[u,d]=S.useState({loaner_number:"",eta_return_date:"",notes:""}),[f,p]=S.useState("");S.useEffect(()=>{if(t&&r){let O="";try{const N=((r==null?void 0:r.job_parts)||[]).filter(a=>(a==null?void 0:a.requires_scheduling)&&(a==null?void 0:a.promised_date)).map(a=>new Date(a.promised_date));(N==null?void 0:N.length)>0&&(O=new Date(Math.max.apply(null,N)).toISOString().split("T")[0])}catch{}d({loaner_number:(r==null?void 0:r.loaner_number)||"",eta_return_date:(r==null?void 0:r.loaner_eta_return_date)||O||"",notes:(r==null?void 0:r.loaner_notes)||""}),p("")}else t||(d({loaner_number:"",eta_return_date:"",notes:""}),p(""))},[t,r]);const b=async()=>{var O,N,a;if(p(""),!((O=u==null?void 0:u.loaner_number)!=null&&O.trim())){p("Loaner number is required");return}if(!(u!=null&&u.eta_return_date)){p("ETA return date is required");return}try{await o({job_id:r==null?void 0:r.id,loaner_number:(N=u==null?void 0:u.loaner_number)==null?void 0:N.trim(),eta_return_date:u==null?void 0:u.eta_return_date,notes:((a=u==null?void 0:u.notes)==null?void 0:a.trim())||null}),x()}catch(I){p((I==null?void 0:I.message)||"Failed to save loaner assignment")}};return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:x}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Loaner Assignment"}),e.jsx(z,{variant:"ghost",size:"icon",onClick:x,"aria-label":"Close drawer",children:e.jsx(H,{name:"X",size:20})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsx("h4",{className:"font-medium text-sm text-slate-900 mb-2",children:"Deal Information"}),e.jsx("p",{className:"text-sm text-slate-600",children:Ye(r)}),e.jsx("p",{className:"text-xs text-slate-500",children:xs(r)})]}),f&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-700",children:f}),e.jsx("button",{onClick:()=>p(""),className:"text-xs text-red-500 hover:text-red-700 mt-1 underline",children:"Dismiss"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Loaner Number *"}),e.jsx("input",{type:"text",value:u==null?void 0:u.loaner_number,onChange:O=>d(N=>{var a;return{...N,loaner_number:(a=O==null?void 0:O.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Expected Return Date *"}),e.jsx("input",{type:"date",value:u==null?void 0:u.eta_return_date,onChange:O=>d(N=>{var a;return{...N,eta_return_date:(a=O==null?void 0:O.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",min:(M=(m=(y=new Date)==null?void 0:y.toISOString())==null?void 0:m.split("T"))==null?void 0:M[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:u==null?void 0:u.notes,onChange:O=>d(N=>{var a;return{...N,notes:(a=O==null?void 0:O.target)==null?void 0:a.value}}),className:"bg-white border border-slate-200 rounded-lg w-full px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Optional notes about the loaner vehicle..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(z,{variant:"outline",onClick:x,className:"flex-1 h-11",disabled:h,children:"Cancel"}),e.jsx(z,{onClick:b,className:"flex-1 h-11 bg-blue-600 hover:bg-blue-700 text-white",disabled:h||!((se=u==null?void 0:u.loaner_number)!=null&&se.trim())||!(u!=null&&u.eta_return_date),children:h?"Saving...":"Save Loaner"})]})]})})]}):null},Vs=({loaner:t,onClose:x,onConfirm:r,loading:o})=>t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Mark Loaner Returned"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Mark loaner ",e.jsxs("strong",{children:["#",t==null?void 0:t.loaner_number]})," as returned?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{variant:"outline",onClick:x,className:"flex-1 h-11",disabled:o,"aria-label":"Cancel marking loaner as returned",children:"Cancel"}),e.jsx(z,{onClick:r,className:"flex-1 h-11 bg-green-600 hover:bg-green-700 text-white",disabled:o,"aria-label":"Confirm loaner returned",children:o?"Processing...":"Mark Returned"})]})]})})}):null;function Zs(){var ye;const[t,x]=S.useState([]),[r,o]=S.useState(!0),[h,u]=S.useState(!1),[d,f]=S.useState(!1),[p,b]=S.useState(null),[y,m]=S.useState(null),[M,se]=S.useState(null),[O,N]=S.useState(""),[a,I]=S.useState({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),[i,le]=S.useState(!1),[g,q]=S.useState(null),[L,R]=S.useState(!1),[w,A]=S.useState(null),[Y,_e]=S.useState(!1),[K,je]=S.useState(""),[ce,ae]=S.useState(!1),[v,V]=S.useState(null),{getUserOptions:Ce,getVendorOptions:Le,clearSearch:j,error:U}=us({loadOnMount:!0});Ss();const{user:ee}=He(),[n,k]=S.useState([]),[$,oe]=S.useState(""),de=()=>{try{return Ce({roles:["staff"],departments:["Sales Consultants"],activeOnly:!0})||[]}catch(s){return console.error("Error getting sales consultants:",s),[]}},ie=()=>{try{return Ce({roles:["admin","manager"],departments:["Delivery Coordinator"],activeOnly:!0})||[]}catch(s){return console.error("Error getting delivery coordinators:",s),[]}},X=()=>{try{return Ce({roles:["staff"],departments:["Finance Manager"],activeOnly:!0})||[]}catch(s){return console.error("Error getting finance managers:",s),[]}},me=(s={})=>{try{return Le(s)||[]}catch(_){return console.error("Error getting vendor options:",_),[]}},G=async s=>{var _;try{N("");const{error:E}=await((_=D)==null?void 0:_.rpc("delete_job_cascade",{p_job_id:s}));if(E)throw E;se(null),await we()}catch(E){N(`Failed to delete deal: ${E==null?void 0:E.message}`),console.error("Delete error:",E)}},T=async s=>{var _,E,P,B,fe,xe,ge,Z,he,pe;try{R(!0),N("");let Q=null;try{const{data:ne}=await((fe=(B=(P=(E=(_=D)==null?void 0:_.from("loaner_assignments"))==null?void 0:E.select("id"))==null?void 0:P.eq("job_id",s==null?void 0:s.job_id))==null?void 0:B.is("returned_at",null))==null?void 0:fe.limit(1));Q=Array.isArray(ne)?ne[0]:ne}catch{}if(Q!=null&&Q.id){const{error:ne}=await((Z=(ge=(xe=D)==null?void 0:xe.from("loaner_assignments"))==null?void 0:ge.update({loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}))==null?void 0:Z.eq("id",Q.id));if(ne)throw ne}else{const{error:ne}=await((pe=(he=D)==null?void 0:he.from("loaner_assignments"))==null?void 0:pe.insert([{job_id:s==null?void 0:s.job_id,loaner_number:s==null?void 0:s.loaner_number,eta_return_date:s==null?void 0:s.eta_return_date,notes:s==null?void 0:s.notes}]));if(ne)throw ne}le(!1),q(null),await we()}catch(Q){const ne=`Failed to save loaner assignment: ${Q==null?void 0:Q.message}`;throw N(ne),new Error(ne)}finally{R(!1)}},re=async s=>{try{_e(!0),N(""),await vs(s==null?void 0:s.loaner_id),A(null),await we()}catch(_){N(`Failed to mark loaner as returned: ${_==null?void 0:_.message}`),console.error("Mark returned error:",_)}finally{_e(!1)}},we=async(s=0)=>{var _,E;try{o(!0),N("");const P=await ys();x(P||[])}catch(P){const B=`Failed to load deals: ${P==null?void 0:P.message}`;if(console.error("Load deals error:",P),s<2&&((_=P==null?void 0:P.message)!=null&&_.includes("fetch")||(E=P==null?void 0:P.message)!=null&&E.includes("network"))){console.log(`Retrying load deals (attempt ${s+1})`),setTimeout(()=>we(s+1),1e3*(s+1));return}N(B),x([])}finally{o(!1)}};S.useEffect(()=>{var E;const s=new URLSearchParams(window.location.search),_=s==null?void 0:s.get("status");if(_){const P=((E=_==null?void 0:_.charAt(0))==null?void 0:E.toUpperCase())+(_==null?void 0:_.slice(1));I(B=>({...B,status:P}))}},[]),S.useEffect(()=>{we()},[]),S.useEffect(()=>{try{const s=localStorage.getItem("dealsSavedViews");if(s){const _=JSON.parse(s);Array.isArray(_)&&k(_)}}catch{}},[]);const Ee=s=>{q(s),le(!0)},$e=s=>{V(s),ae(!0)},qe=({message:s,onClose:_})=>s?e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"AlertCircle",size:20,className:"text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s})]})]}),_&&e.jsx("button",{onClick:_,className:"text-red-400 hover:text-red-600","aria-label":"Dismiss error",children:e.jsx(H,{name:"X",size:16})})]})}):null,ue=(s=>{var Z,he,pe;const _=s||[],E=((Z=_==null?void 0:_.filter(Q=>(Q==null?void 0:Q.job_status)==="in_progress"))==null?void 0:Z.length)||0,P=_==null?void 0:_.reduce((Q,ne)=>{const Se=parseFloat(ne==null?void 0:ne.total_amount)||0;return Q+Se},0),B=P*.25,fe=P>0?25:0,xe=((he=_==null?void 0:_.filter(Q=>(Q==null?void 0:Q.job_status)==="pending"))==null?void 0:he.length)||0,ge=((pe=_==null?void 0:_.filter(Q=>(Q==null?void 0:Q.job_status)==="draft"))==null?void 0:pe.length)||0;return{active:E,revenue:(P==null?void 0:P.toFixed(2))||"0.00",profit:(B==null?void 0:B.toFixed(2))||"0.00",margin:(fe==null?void 0:fe.toFixed(1))||"0.0",pending:xe,drafts:ge}})(t),ve=t==null?void 0:t.filter(s=>{var _,E,P,B,fe,xe,ge;if((a==null?void 0:a.status)!=="All"){let Z=(E=(_=a==null?void 0:a.status)==null?void 0:_.toLowerCase())==null?void 0:E.replace(" ","_");if(Z==="active"&&(Z="in_progress"),(s==null?void 0:s.job_status)!==Z)return!1}if(a!=null&&a.presetView&&(a==null?void 0:a.presetView)!=="All"){const Z=new Date,he=new Date(Z);he.setHours(0,0,0,0);const pe=new Date(Z);pe.setHours(23,59,59,999);const Q=s!=null&&s.appt_start?new Date(s==null?void 0:s.appt_start):null,ne=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null,Se=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null,ze=Array.isArray(s==null?void 0:s.job_parts)?(P=s==null?void 0:s.job_parts)==null?void 0:P.some(Ve=>Ve==null?void 0:Ve.requires_scheduling):!1,Ie=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id);switch(a==null?void 0:a.presetView){case"Today":if(!(Q&&Q>=he&&Q<=pe))return!1;break;case"Past Due":if(!(ne&&ne<Z))return!1;break;case"Unscheduled":if(!(ze&&!Q))return!1;break;case"Off-site Today":{const Xe=(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some(Oe=>Oe==null?void 0:Oe.is_off_site),Te=Oe=>Oe&&Oe>=he&&Oe<=pe;if(!(Xe&&(Te(Q)||Te(ne))))return!1;break}case"Awaiting Vendor/Parts":{if(!(Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[]).some(Te=>(Te==null?void 0:Te.requires_scheduling)&&!(Te!=null&&Te.promised_date)))return!1;break}case"Completedâ€”awaiting pickup":if(!((s==null?void 0:s.job_status)==="completed"&&(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id)))return!1;break;case"My Deals":if(!(s!=null&&s.assigned_to&&(ee!=null&&ee.id)&&s.assigned_to===ee.id))return!1;break;case"Loaners Out":if(!Ie)return!1;break;case"Loaners Due":if(!(Ie&&Se&&Se>=he&&Se<=pe))return!1;break;case"Loaners Overdue":if(!(Ie&&Se&&Se<he))return!1;break}}if(a!=null&&a.salesAssigned&&(s==null?void 0:s.assigned_to)!==(a==null?void 0:a.salesAssigned)||a!=null&&a.deliveryAssigned&&(s==null?void 0:s.delivery_coordinator_id)!==(a==null?void 0:a.deliveryAssigned)||a!=null&&a.financeAssigned&&(s==null?void 0:s.finance_manager_id)!==(a==null?void 0:a.financeAssigned)||a!=null&&a.vendor&&(s==null?void 0:s.vendor_id)!==(a==null?void 0:a.vendor))return!1;if(a!=null&&a.location&&(a==null?void 0:a.location)!=="All"){const Z=Array.isArray(s==null?void 0:s.job_parts)?s.job_parts:[],he=Z.some(ne=>ne==null?void 0:ne.is_off_site),pe=Z.some(ne=>!(ne!=null&&ne.is_off_site));if((he&&pe?"Mixed":he?"Off-Site":"In-House")!==a.location)return!1}if((B=a==null?void 0:a.workTags)!=null&&B.length){const Z=Array.isArray(s==null?void 0:s.work_tags)?s.work_tags:[];if(!a.workTags.some(pe=>Z.includes(pe)))return!1}if(a!=null&&a.loanerStatus&&(a==null?void 0:a.loanerStatus)!=="All"){const Z=new Date,he=new Date(Z);he.setHours(0,0,0,0);const pe=new Date(Z);pe.setHours(23,59,59,999);const Q=!!(s!=null&&s.has_active_loaner||s!=null&&s.loaner_id),ne=s!=null&&s.loaner_eta_return_date?new Date(s==null?void 0:s.loaner_eta_return_date):null;switch(a.loanerStatus){case"Active":if(!Q)return!1;break;case"Due Today":if(!(Q&&ne&&ne>=he&&ne<=pe))return!1;break;case"Overdue":if(!(Q&&ne&&ne<he))return!1;break;case"None":if(Q)return!1;break}}if(a!=null&&a.promiseStartDate||a!=null&&a.promiseEndDate){const Z=s!=null&&s.next_promised_iso?new Date(s==null?void 0:s.next_promised_iso):null;if(!Z)return!1;if(a!=null&&a.promiseStartDate){const he=new Date(a.promiseStartDate+"T00:00:00");if(Z<he)return!1}if(a!=null&&a.promiseEndDate){const he=new Date(a.promiseEndDate+"T23:59:59.999");if(Z>he)return!1}}if(K!=null&&K.trim()){const Z=K==null?void 0:K.toLowerCase(),he=Se=>(Se==null?void 0:Se.replace(/\D/g,""))||"",pe=he(Z),Q=[s==null?void 0:s.customer_name,s==null?void 0:s.customer_phone,s==null?void 0:s.customer_email,s==null?void 0:s.job_number,(fe=s==null?void 0:s.vehicle)==null?void 0:fe.make,(xe=s==null?void 0:s.vehicle)==null?void 0:xe.model,((ge=s==null?void 0:s.vehicle)==null?void 0:ge.stock_number)||(s==null?void 0:s.stock_no),s==null?void 0:s.description].filter(Boolean);if(!(Q==null?void 0:Q.some(Se=>{var Ie;const ze=Se==null?void 0:Se.toLowerCase();return!!(ze!=null&&ze.includes(Z)||(pe==null?void 0:pe.length)>=3&&((Ie=he(ze))!=null&&Ie.includes(pe)))})))return!1}return!0});S.useEffect(()=>{const s=setTimeout(()=>{je(a==null?void 0:a.search)},300);return()=>clearTimeout(s)},[a==null?void 0:a.search]);const Ne=(s,_)=>{var E,P;if(I(B=>({...B,[s]:_})),s==="status"){const B=new URLSearchParams(window.location.search);_==="All"?B==null||B.delete("status"):B==null||B.set("status",_==null?void 0:_.toLowerCase());const fe=`${(E=window.location)==null?void 0:E.pathname}${B!=null&&B.toString()?"?"+(B==null?void 0:B.toString()):""}`;(P=window.history)==null||P.replaceState({},"",fe)}},Pe=()=>{var s,_;I({status:"All",presetView:"All",salesAssigned:null,deliveryAssigned:null,financeAssigned:null,vendor:null,location:"All",workTags:[],loanerStatus:"All",promiseStartDate:"",promiseEndDate:"",search:""}),j(),(_=window.history)==null||_.replaceState({},"",(s=window.location)==null?void 0:s.pathname)},Me=ds.useMemo(()=>{const s=new Set;for(const _ of t||[])for(const E of(_==null?void 0:_.work_tags)||[])s.add(E);return Array.from(s).sort((_,E)=>_.localeCompare(E))},[t]),Ae=me({activeOnly:!0}),c=de(),l=ie(),C=X(),F=()=>{try{const s=window.prompt("Save view as:");if(!s||!s.trim())return;const _={name:s.trim(),filters:a},E=[...n.filter(P=>P.name!==_.name),_];k(E),localStorage.setItem("dealsSavedViews",JSON.stringify(E)),oe(_.name)}catch(s){console.error("saveCurrentView failed",s)}},be=s=>{oe(s);const _=n.find(E=>E.name===s);_!=null&&_.filters&&I(_.filters)},te=()=>{if(!$)return;const s=n.filter(_=>_.name!==$);k(s),localStorage.setItem("dealsSavedViews",JSON.stringify(s)),oe("")},J=s=>{var _;b(s);try{const E=(_=ve!=null&&ve.length?ve:t)==null?void 0:_.find(P=>(P==null?void 0:P.id)===s);m(E||null)}catch{m(null)}f(!0)},W=()=>{f(!1),b(null),m(null)};return r?e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Qe,{}),e.jsx("div",{className:"p-4 md:p-8",style:{paddingTop:"5rem"},children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading deals..."})})})})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[e.jsx(Qe,{}),e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto",style:{paddingTop:"5rem"},children:[e.jsx(qe,{message:O||U,onClose:()=>{N("")}}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Deal Tracker"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Cs,{exportType:"jobs",filters:{status:a==null?void 0:a.status},onExportStart:()=>console.log("Starting export..."),onExportComplete:(s,_)=>console.log(`Export complete: ${s} records`),onExportError:s=>N(`Export failed: ${s}`),variant:"outline",size:"sm",className:"bg-white hover:bg-gray-50"}),e.jsxs(z,{onClick:()=>u(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 h-11","aria-label":"Create new deal",children:[e.jsx(H,{name:"Plus",size:16,className:"mr-2"}),"New Deal"]})]})]}),e.jsx(zs,{draftsCount:ue==null?void 0:ue.drafts,onViewDrafts:()=>Ne("status","Draft")}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-orange-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Active"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.active})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 mr-4",children:e.jsx(H,{name:"DollarSign",size:24,className:"text-green-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Revenue"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",ue==null?void 0:ue.revenue]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 mr-4",children:e.jsx(H,{name:"TrendingUp",size:24,className:"text-blue-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Profit"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:["$",ue==null?void 0:ue.profit]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 mr-4",children:e.jsx(H,{name:"Percent",size:24,className:"text-purple-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Margin"}),e.jsxs("p",{className:"text-slate-900 text-2xl font-bold",children:[ue==null?void 0:ue.margin,"%"]})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-yellow-100 mr-4",children:e.jsx(H,{name:"Clock",size:24,className:"text-yellow-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Pending"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.pending})]})]})}),e.jsx("div",{className:"bg-white p-6 rounded-xl border shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 mr-4",children:e.jsx(H,{name:"File",size:24,className:"text-gray-700"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-slate-600 text-sm font-medium uppercase tracking-wide",children:"Drafts"}),e.jsx("p",{className:"text-slate-900 text-2xl font-bold",children:ue==null?void 0:ue.drafts})]})]})})]})}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg border p-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Draft","Pending","Active","Completed"].map(s=>e.jsx("button",{onClick:()=>Ne("status",s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                  ${(a==null?void 0:a.status)===s?"bg-blue-600 text-white":"bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"}`,children:s},s))}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:["All","Today","Past Due","Unscheduled","Off-site Today","Awaiting Vendor/Parts","Completedâ€”awaiting pickup","My Deals","Loaners Out","Loaners Due","Loaners Overdue"].map(s=>e.jsx("button",{onClick:()=>Ne("presetView",s),className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors border
                    ${(a==null?void 0:a.presetView)===s?"bg-slate-900 text-white border-slate-900":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"}`,children:s},s))}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(H,{name:"Search",size:16,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search deals, customers, vehicles...",value:a==null?void 0:a.search,onChange:s=>{var _;return Ne("search",(_=s==null?void 0:s.target)==null?void 0:_.value)},className:"bg-white border border-slate-200 rounded-lg w-full h-11 pl-9 pr-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"flex items-center",children:e.jsxs(z,{variant:"ghost",size:"sm",onClick:Pe,className:"text-slate-600 hover:text-slate-800","aria-label":"Clear all filters",children:[e.jsx(H,{name:"X",size:16,className:"mr-1"}),"Clear"]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Vendor"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.vendor||"",onChange:s=>Ne("vendor",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),Ae.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Sales"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.salesAssigned||"",onChange:s=>Ne("salesAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),c.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Finance"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.financeAssigned||"",onChange:s=>Ne("financeAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),C.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Delivery"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.deliveryAssigned||"",onChange:s=>Ne("deliveryAssigned",s.target.value||null),children:[e.jsx("option",{value:"",children:"All"}),l.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Location"}),e.jsx("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.location,onChange:s=>Ne("location",s.target.value),children:["All","In-House","Off-Site","Mixed"].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Loaner"}),e.jsx("select",{className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.loanerStatus,onChange:s=>Ne("loanerStatus",s.target.value),children:["All","Active","Due Today","Overdue","None"].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Promise from"}),e.jsx("input",{type:"date",className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.promiseStartDate,onChange:s=>Ne("promiseStartDate",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Promise to"}),e.jsx("input",{type:"date",className:"bg-white border border-slate-200 rounded-lg w-full h-11 px-3",value:a.promiseEndDate,onChange:s=>Ne("promiseEndDate",s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-600 mb-1",children:"Work tags"}),e.jsx("select",{multiple:!0,className:"bg-white border border-slate-200 rounded-lg w-full min-h-[44px] px-3 py-2",value:a.workTags,onChange:s=>{const _=Array.from(s.target.selectedOptions).map(E=>E.value);Ne("workTags",_)},children:Me.map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsx("label",{className:"text-xs text-slate-600",children:"Saved views"}),e.jsxs("select",{className:"bg-white border border-slate-200 rounded-lg h-9 px-3",value:$,onChange:s=>be(s.target.value),children:[e.jsx("option",{value:"",children:"â€” Select view â€”"}),n.map(s=>e.jsx("option",{value:s.name,children:s.name},s.name))]}),e.jsx(z,{size:"sm",variant:"outline",onClick:F,children:"Save current"}),e.jsx(z,{size:"sm",variant:"ghost",onClick:te,disabled:!$,children:"Delete selected"})]})]}),e.jsxs("div",{className:"mb-4 text-sm text-slate-600",children:["Showing ",ve==null?void 0:ve.length," of ",t==null?void 0:t.length," deals",((a==null?void 0:a.salesAssigned)||(a==null?void 0:a.deliveryAssigned)||(a==null?void 0:a.financeAssigned)||(a==null?void 0:a.vendor)||(a==null?void 0:a.location)!=="All"||(a==null?void 0:a.workTags)&&(a==null?void 0:a.workTags.length)||(a==null?void 0:a.loanerStatus)!=="All"||(a==null?void 0:a.promiseStartDate)||(a==null?void 0:a.promiseEndDate)||(a==null?void 0:a.search))&&e.jsx("span",{className:"ml-2 text-blue-600",children:"(filtered)"})]}),e.jsx("div",{className:"hidden md:block bg-white border rounded-lg overflow-hidden shadow-sm",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Promise"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Appt Window"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vehicle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"$/Margin"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Work"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Last Activity"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Loaner"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-slate-200",children:ve==null?void 0:ve.map(s=>{var _,E,P,B,fe,xe;return e.jsxs("tr",{className:"hover:bg-slate-50 cursor-pointer",onClick:()=>$e(s),children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx(es,{status:s==null?void 0:s.job_status})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:typeof(s==null?void 0:s.age_days)=="number"?`${s==null?void 0:s.age_days}d`:"â€”"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(ss,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.appt_start?e.jsxs("span",{className:"text-sm text-slate-700",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Is,{deal:s})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[(s==null?void 0:s.customer_phone_e164)||(s==null?void 0:s.customer_phone)||"â€”",s!=null&&s.customer_phone_last4?e.jsxs("span",{className:"text-slate-400",children:[" ","(",`â€¦${s==null?void 0:s.customer_phone_last4}`,")"]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm text-slate-700",children:[s!=null&&s.vehicle?`${((_=s==null?void 0:s.vehicle)==null?void 0:_.year)||""} ${((E=s==null?void 0:s.vehicle)==null?void 0:E.make)||""} ${((P=s==null?void 0:s.vehicle)==null?void 0:P.model)||""}`.trim():"â€”",(B=s==null?void 0:s.vehicle)!=null&&B.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(fe=s==null?void 0:s.vehicle)==null?void 0:fe.stock_number]}):null]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Fs,{amount:s==null?void 0:s.total_amount}),e.jsxs("span",{className:"text-xs text-slate-500",children:["est."," ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((parseFloat(s==null?void 0:s.total_amount)||0)*.25)]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[((s==null?void 0:s.work_tags)||[]).map(ge=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 border border-slate-200",children:ge},ge)),(!(s!=null&&s.work_tags)||((xe=s==null?void 0:s.work_tags)==null?void 0:xe.length)===0)&&e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:(s==null?void 0:s.vendor_name)||"Unassigned"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(rs,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-slate-700",children:Ps(s==null?void 0:s.created_at)})}),e.jsx("td",{className:"px-6 py-4",children:s!=null&&s.loaner_number||s!=null&&s.has_active_loaner?e.jsx(ts,{deal:s}):e.jsx("span",{className:"text-xs text-gray-500",children:"â€”"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(z,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),J(s==null?void 0:s.id)},className:"text-blue-600 hover:text-blue-800","aria-label":"Edit deal",children:"Edit"}),(s==null?void 0:s.customer_needs_loaner)&&e.jsx(z,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),Ee(s)},className:"text-purple-600 hover:text-purple-800","aria-label":"Manage loaner",children:"Loaner"}),(s==null?void 0:s.loaner_id)&&e.jsx(z,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),A({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Ye(s)})},className:"text-green-600 hover:text-green-800","aria-label":"Mark loaner returned",children:"Return"}),e.jsx(z,{size:"sm",variant:"ghost",onClick:ge=>{ge.stopPropagation(),se(s)},className:"text-red-600 hover:text-red-800","aria-label":"Delete deal",children:"Delete"})]})})]},s==null?void 0:s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:(ve==null?void 0:ve.length)===0?e.jsx("div",{className:"bg-white rounded-lg border p-8 text-center",children:e.jsx("div",{className:"text-slate-500",children:(a==null?void 0:a.status)==="All"?"No deals found":`No ${(ye=a==null?void 0:a.status)==null?void 0:ye.toLowerCase()} deals found`})}):ve==null?void 0:ve.map(s=>{var _,E,P,B,fe;return e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-slate-50",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-900",children:Ye(s)}),e.jsx("div",{className:"text-sm text-slate-600",children:xs(s)||"â€”"})]}),e.jsx(es,{status:s==null?void 0:s.job_status})]})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-medium text-slate-900 text-sm",children:(s==null?void 0:s.customer_name)||"â€”"}),e.jsx("div",{className:"text-xs text-slate-500 truncate",children:s!=null&&s.customer_phone?e.jsx("a",{href:`tel:${s==null?void 0:s.customer_phone}`,onClick:xe=>{var ge;return(ge=xe==null?void 0:xe.stopPropagation)==null?void 0:ge.call(xe)},className:"underline",children:s==null?void 0:s.customer_phone}):"â€”"})]}),e.jsx("div",{className:"ml-3 shrink-0",children:e.jsx(rs,{serviceType:s==null?void 0:s.service_type,jobParts:s==null?void 0:s.job_parts})})]}),e.jsxs("div",{className:"text-xs text-slate-600 truncate",children:[(s!=null&&s.vehicle?`${((_=s==null?void 0:s.vehicle)==null?void 0:_.year)||""} ${((E=s==null?void 0:s.vehicle)==null?void 0:E.make)||""} ${((P=s==null?void 0:s.vehicle)==null?void 0:P.model)||""}`.trim():"")||"â€”",(B=s==null?void 0:s.vehicle)!=null&&B.stock_number?e.jsxs("span",{className:"text-slate-400",children:[" ","â€¢ Stock: ",(fe=s==null?void 0:s.vehicle)==null?void 0:fe.stock_number]}):null,s!=null&&s.vendor_name?e.jsxs("span",{className:"text-slate-400",children:[" â€¢ ",s==null?void 0:s.vendor_name]}):null]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{"data-testid":"mobile-next-chip",children:e.jsx(ss,{nextPromisedAt:s==null?void 0:s.next_promised_iso})}),(s==null?void 0:s.appt_start)&&e.jsxs("span",{className:"text-xs text-slate-700","data-testid":"mobile-appt-window",children:[new Date(s==null?void 0:s.appt_start).toLocaleDateString("en-US",{month:"short",day:"numeric"})," â€¢ ",new Date(s==null?void 0:s.appt_start).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),"â€“",s!=null&&s.appt_end?new Date(s==null?void 0:s.appt_end).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""]}),((s==null?void 0:s.loaner_number)||(s==null?void 0:s.has_active_loaner))&&e.jsx(ts,{deal:s})]})]}),e.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>J(s==null?void 0:s.id),className:"h-11 w-full bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100","aria-label":"Edit deal",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit"]}),e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>se(s),className:"h-11 w-full bg-red-50 border-red-200 text-red-700 hover:bg-red-100","aria-label":"Delete deal",children:[e.jsx(H,{name:"Trash2",size:16,className:"mr-2"}),"Delete"]})]}),((s==null?void 0:s.customer_needs_loaner)||(s==null?void 0:s.loaner_id))&&e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[(s==null?void 0:s.customer_needs_loaner)&&!(s!=null&&s.loaner_id)&&e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Manage loaner",children:[e.jsx(H,{name:"Car",size:16,className:"mr-2"}),"Assign Loaner"]}),(s==null?void 0:s.loaner_id)&&e.jsxs(e.Fragment,{children:[e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"h-11 w-full bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100","aria-label":"Edit loaner",children:[e.jsx(H,{name:"Edit",size:16,className:"mr-2"}),"Edit Loaner"]}),e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>A({loaner_id:s==null?void 0:s.loaner_id,loaner_number:s==null?void 0:s.loaner_number,job_title:Ye(s)}),className:"h-11 w-full bg-green-50 border-green-200 text-green-700 hover:bg-green-100","aria-label":"Mark loaner returned",children:[e.jsx(H,{name:"CheckCircle",size:16,className:"mr-2"}),"Mark Returned"]})]})]})]})]},s==null?void 0:s.id)})}),e.jsx(Es,{isOpen:h,onClose:()=>u(!1),onSuccess:we}),e.jsx(Ms,{isOpen:d,dealId:p,deal:y,onClose:W,onSuccess:()=>{we(),W()}}),M&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto p-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-900",children:"Delete Deal"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Delete deal and its line items? This cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{variant:"outline",onClick:()=>se(null),className:"flex-1 h-11","aria-label":"Cancel deletion",children:"Cancel"}),e.jsx(z,{onClick:()=>G(M==null?void 0:M.id),className:"flex-1 h-11 bg-red-600 hover:bg-red-700 text-white","aria-label":"Confirm deletion",children:"Delete"})]})]})})}),e.jsx(qs,{isOpen:i,onClose:()=>{le(!1),q(null),N("")},deal:g,onSave:T,loading:L}),e.jsx(Os,{isOpen:ce,onClose:()=>{ae(!1),V(null)},deal:v}),e.jsx(Vs,{loaner:w,onClose:()=>{A(null),N("")},onConfirm:()=>re(w),loading:Y})]})]})}export{Zs as default};
//# sourceMappingURL=index-CqrITzax.js.map
