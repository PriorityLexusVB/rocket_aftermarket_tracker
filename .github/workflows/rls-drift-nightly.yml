name: Nightly RLS Drift & Health Check

# Run nightly to detect schema drift and validate health endpoints
on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  issues: write # To create issues if drift detected

jobs:
  rls-drift-check:
    name: RLS Schema Drift Detection
    runs-on: ubuntu-latest
    # Only run on main branch (skip forks)
    if: github.repository == 'PriorityLexusVB/rocket_aftermarket_tracker'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm via corepack (use packageManager version) + retry
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          PNPM_VER=$(node -p "require('./package.json').packageManager.split('@')[1].split('+')[0]")
          echo "Using pnpm@${PNPM_VER} via corepack"

          for i in 1 2 3; do
            echo "corepack prepare attempt $i..."
            if corepack prepare pnpm@"${PNPM_VER}" --activate; then
              pnpm -v
              exit 0
            fi
            sleep $((i * 5))
          done

          echo "corepack prepare failed after retries" >&2
          exit 1

      - name: Get pnpm store path
        id: pnpm-store
        shell: bash
        run: |
          set -euo pipefail
          echo "path=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Schema Drift Script
        id: drift_check
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          echo "Running schema cache verification..."
          # Ensure we use npx supabase from node_modules
          if bash scripts/verify-schema-cache.sh; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Schema cache verification passed"
          else
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "‚ùå Schema cache verification failed"
            exit 1
          fi
        continue-on-error: true

      - name: Start Development Server
        id: start_server
        if: always()
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          echo "Starting Vite dev server..."
          pnpm dev &
          DEV_PID=$!
          echo "dev_pid=$DEV_PID" >> $GITHUB_OUTPUT
          echo "Dev server started with PID: $DEV_PID"
          # Give server time to start
          sleep 10

      - name: Wait for Server Ready
        if: always() && steps.start_server.conclusion == 'success'
        run: |
          echo "Waiting for server to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do sleep 2; done' || {
            echo "‚ùå Server failed to start within timeout"
            exit 1
          }
          echo "‚úÖ Server is ready"

      - name: Check Health Endpoint
        id: health_check
        if: always() && steps.start_server.conclusion == 'success'
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        run: |
          echo "Checking /api/health endpoint..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "http://localhost:5173/api/health" || echo "000")
          HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          BODY=$(echo "$HEALTH_RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Health endpoint responding"
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
            echo "‚ùå Health endpoint failed (HTTP $HTTP_CODE)"
          fi

      - name: Check Deals Relationship Health Endpoint
        id: deals_rel_check
        if: always() && steps.start_server.conclusion == 'success'
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        run: |
          echo "Checking /api/health-deals-rel endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "http://localhost:5173/api/health-deals-rel" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            # Consider OK when the health endpoint reports ok:true (classification ok)
            if echo "$BODY" | grep -q '"ok":true'; then
              echo "deals_rel_ok=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Deals relationship health OK"
            else
              echo "deals_rel_ok=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Deals relationship health warning"
              echo "Response: $BODY"
            fi
          else
            echo "deals_rel_ok=false" >> $GITHUB_OUTPUT
            echo "‚ùå Deals relationship health failed (HTTP $HTTP_CODE)"
          fi

      - name: Stop Development Server
        if: always() && steps.start_server.conclusion == 'success'
        run: |
          DEV_PID=${{ steps.start_server.outputs.dev_pid }}
          if [ -n "$DEV_PID" ] && kill -0 "$DEV_PID" 2>/dev/null; then
            echo "Stopping dev server (PID: $DEV_PID)"
            kill "$DEV_PID" || true
            sleep 2
            # Force kill if still running
            kill -9 "$DEV_PID" 2>/dev/null || true
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## Nightly RLS Drift & Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Schema Drift Check" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.drift_check.outputs.drift_detected }}" = "false" ]; then
            echo "‚úÖ **PASS** - No schema drift detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **FAIL** - Schema drift detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required**: Run \`scripts/verify-schema-cache.sh\` locally to diagnose" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Endpoints" >> $GITHUB_STEP_SUMMARY

          echo "#### /api/health" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.health_check.outputs.health_ok }}" = "true" ]; then
            echo "‚úÖ **PASS** - Basic health check OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **FAIL** - Basic health check failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### /api/health-deals-rel" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deals_rel_check.outputs.deals_rel_ok }}" = "true" ]; then
            echo "‚úÖ **PASS** - Deals relationship OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **FAIL** - Deals relationship check failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.drift_check.outputs.drift_detected }}" = "true" ] || \
             [ "${{ steps.health_check.outputs.health_ok }}" = "false" ] || \
             [ "${{ steps.deals_rel_check.outputs.deals_rel_ok }}" = "false" ]; then
            echo "‚ö†Ô∏è **Issues Detected** - Review logs above for details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting**:" >> $GITHUB_STEP_SUMMARY
            echo "- Check [TROUBLESHOOTING_SCHEMA_CACHE.md](https://github.com/${{ github.repository }}/blob/main/docs/TROUBLESHOOTING_SCHEMA_CACHE.md)" >> $GITHUB_STEP_SUMMARY
            echo "- Run \`bash scripts/verify-schema-cache.sh\` locally" >> $GITHUB_STEP_SUMMARY
            echo "- Check [DEPLOY_CHECKLIST.md](https://github.com/${{ github.repository }}/blob/main/docs/DEPLOY_CHECKLIST.md)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All Checks Passed** - System healthy" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Issue on Failure
        if: failure() && steps.drift_check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Nightly Check: RLS Schema Drift Detected`;
            const body = `## Schema Drift Detected

            The nightly RLS drift check has detected a potential schema cache issue.

            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Date**: ${new Date().toUTCString()}

            ### Likely Causes
            1. Recent migration added FK constraint without \`NOTIFY pgrst, 'reload schema'\`
            2. PostgREST cache not reloaded after schema change
            3. Column or relationship missing from database

            ### Troubleshooting Steps
            1. Review workflow logs: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Run locally: \`bash scripts/verify-schema-cache.sh\`
            3. Check recent migrations in \`supabase/migrations/\`
            4. See [TROUBLESHOOTING_SCHEMA_CACHE.md](https://github.com/${{ github.repository }}/blob/main/docs/TROUBLESHOOTING_SCHEMA_CACHE.md)
            5. See [DEPLOY_CHECKLIST.md](https://github.com/${{ github.repository }}/blob/main/docs/DEPLOY_CHECKLIST.md)

            ### Resolution
            If a migration is missing \`NOTIFY pgrst, 'reload schema'\`, add it and redeploy:
            \`\`\`sql
            -- At end of migration
            NOTIFY pgrst, 'reload schema';
            \`\`\`

            Or manually reload via Supabase SQL Editor:
            \`\`\`sql
            NOTIFY pgrst, 'reload schema';
            \`\`\`
            `;

            // Check if issue already exists (open issues with this title)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'schema-drift,automated'
            });

            const existingIssue = issues.data.find(issue => 
              issue.title.includes('RLS Schema Drift Detected')
            );

            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Detection\n\n${body}`
              });
              console.log(`Updated existing issue: #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['schema-drift', 'automated', 'priority-high']
              });
              console.log(`Created issue: #${issue.data.number}`);
            }

      - name: Fail Workflow on Issues
        if: |
          steps.drift_check.outputs.drift_detected == 'true' ||
          steps.health_check.outputs.health_ok == 'false' ||
          steps.deals_rel_check.outputs.deals_rel_ok == 'false'
        run: |
          echo "‚ùå Nightly check failed - see summary for details"
          exit 1
