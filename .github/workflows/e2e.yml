name: E2E Tests (Playwright)

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e-smoke:
    name: E2E Smoke (PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: supabase-e2e
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine if E2E smoke should run
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            run_e2e:
              - 'src/**'
              - 'api/**'
              - 'e2e/**'
              - 'supabase/**'
              - 'scripts/**'
              - 'global.setup.ts'
              - 'playwright.config.ts'
              - 'vite.config.*'
              - 'package.json'
              - 'pnpm-lock.yaml'

      - name: Setup Node
        if: steps.changes.outputs.run_e2e == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm via corepack (use packageManager version) + retry
        if: steps.changes.outputs.run_e2e == 'true'
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          PNPM_VER=$(node -p "require('./package.json').packageManager.split('@')[1].split('+')[0]")
          echo "Using pnpm@${PNPM_VER} via corepack"

          for i in 1 2 3; do
            echo "corepack prepare attempt $i..."
            if corepack prepare pnpm@"${PNPM_VER}" --activate; then
              pnpm -v
              exit 0
            fi
            sleep $((i * 5))
          done

          echo "corepack prepare failed after retries" >&2
          exit 1

      - name: Get pnpm store path
        if: steps.changes.outputs.run_e2e == 'true'
        id: pnpm-store
        shell: bash
        run: |
          set -euo pipefail
          echo "path=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        if: steps.changes.outputs.run_e2e == 'true'
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Check for required secrets
        if: steps.changes.outputs.run_e2e == 'true'
        id: check-secrets
        run: |
          echo "::group::E2E PR context"
          echo "event_name=${{ github.event_name }}"
          echo "repo=${{ github.repository }}"
          echo "head_repo=${{ github.event.pull_request.head.repo.full_name }}"
          echo "head_ref=${{ github.event.pull_request.head.ref }}"
          echo "fork=${{ github.event.pull_request.head.repo.fork }}"
          echo "If fork=true, GitHub Actions will not expose repo secrets to this PR job by default."
          echo "::endgroup::"

          echo "::group::E2E secret availability (present/not present)"
          echo "VITE_SUPABASE_URL=$([ -n \"${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "VITE_SUPABASE_ANON_KEY=$([ -n \"${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "E2E_EMAIL=$([ -n \"${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "E2E_PASSWORD=$([ -n \"${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "DATABASE_URL=$([ -n \"${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "::endgroup::"

          if [ -z "${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}" ] || [ -z "${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}" ] || \
             [ -z "${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}" ] || [ -z "${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}" ] || \
             [ -z "${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}" ]; then
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "::warning::E2E secrets not available for this PR (including DATABASE_URL). Smoke tests will be skipped."
          else
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        run: pnpm exec playwright install --with-deps

      - name: Debug - show Supabase project refs (non-secret)
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          VITE_SUPABASE_URL: ${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: |
          set -euo pipefail
          echo "::group::Supabase refs (non-secret)"
          echo "vite_supabase_ref=$(echo "${VITE_SUPABASE_URL:-}" | sed -n 's#https://\([^.]*\)\.supabase\.co.*#\1#p')"
          echo "database_url_ref=$(echo "${DATABASE_URL:-}" | sed -n 's#.*\.\([a-z0-9]\{20\}\)@.*#\1#p')"
          echo "::endgroup::"

      - name: Safety check - block E2E against production Supabase
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          VITE_SUPABASE_URL: ${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: |
          set -euo pipefail
          PROD_REF="ogjtmtndgiqqdtwatsue"
          if echo "${VITE_SUPABASE_URL:-}" | grep -q "${PROD_REF}"; then
            echo "::error::Refusing to run E2E against production Supabase (VITE_SUPABASE_URL contains ${PROD_REF})."
            echo "::error::Point repo secrets to a dedicated E2E/staging Supabase project."
            exit 1
          fi

          if echo "${DATABASE_URL:-}" | grep -q "${PROD_REF}"; then
            echo "::error::Refusing to seed E2E data against production Supabase (DATABASE_URL contains ${PROD_REF})."
            echo "::error::Point DATABASE_URL to a dedicated E2E/staging database."
            exit 1
          fi

      - name: Preflight - verify E2E DB schema (requires_scheduling)
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: node scripts/checkE2ESchema.mjs

      - name: Seed E2E test data
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          E2E_EMAIL: ${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::warning::DATABASE_URL secret not set - E2E tests may fail if products don't exist"
            echo "Skipping seed step - tests will rely on existing data or admin-crud test"
          else
            echo "Seeding E2E test data (products, vendors, etc.)"
            pnpm run db:seed-e2e || echo "::warning::Seed failed, continuing anyway"
          fi

      - name: Debug - effective PLAYWRIGHT_BASE_URL
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5174
        run: |
          set -euo pipefail
          echo "::group::Playwright base URL"
          echo "PLAYWRIGHT_BASE_URL=${PLAYWRIGHT_BASE_URL}"
          echo "::endgroup::"

      - name: Run E2E smoke tests (fast subset)
        if: steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        env:
          # App runtime env (Vite reads VITE_* at dev server start)
          VITE_SUPABASE_URL: ${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_ORG_SCOPED_DROPDOWNS: true
          # Playwright/global.setup auth and base URL
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5174
          E2E_EMAIL: ${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}
          # Database access for global.setup / helpers
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: |
          pnpm exec playwright test \
            e2e/profile-name-fallback.spec.ts \
            e2e/deal-form-dropdowns.spec.ts \
            e2e/deal-edit.spec.ts

      - name: Upload Playwright HTML report (always)
        if: always() && steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke
          path: playwright-report
          if-no-files-found: ignore

      - name: Upload test results and traces
        if: always() && steps.changes.outputs.run_e2e == 'true' && steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-smoke
          path: |
            test-results/
            e2e/*.png
            e2e/*.html
          if-no-files-found: ignore
          retention-days: 7

  e2e-full:
    name: E2E Full (Main)
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: supabase-e2e
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm via corepack (use packageManager version) + retry
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          PNPM_VER=$(node -p "require('./package.json').packageManager.split('@')[1].split('+')[0]")
          echo "Using pnpm@${PNPM_VER} via corepack"

          for i in 1 2 3; do
            echo "corepack prepare attempt $i..."
            if corepack prepare pnpm@"${PNPM_VER}" --activate; then
              pnpm -v
              exit 0
            fi
            sleep $((i * 5))
          done

          echo "corepack prepare failed after retries" >&2
          exit 1

      - name: Get pnpm store path
        id: pnpm-store
        shell: bash
        run: |
          set -euo pipefail
          echo "path=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Check for required secrets
        id: check-secrets
        run: |
          echo "::group::E2E main secret availability (present/not present)"
          echo "VITE_SUPABASE_URL=$([ -n \"${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "VITE_SUPABASE_ANON_KEY=$([ -n \"${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "E2E_EMAIL=$([ -n \"${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "E2E_PASSWORD=$([ -n \"${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "DATABASE_URL=$([ -n \"${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}\" ] && echo PRESENT || echo NOT_PRESENT)"
          echo "::endgroup::"

          if [ -z "${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}" ] || [ -z "${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}" ] || \
             [ -z "${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}" ] || [ -z "${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}" ] || \
             [ -z "${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}" ]; then
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "::warning::E2E copilot secrets not configured; skipping full E2E on main."
          else
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-secrets.outputs.secrets_available == 'true'
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        if: steps.check-secrets.outputs.secrets_available == 'true'
        run: pnpm exec playwright install --with-deps

      - name: Debug Environment Variables
        if: steps.check-secrets.outputs.secrets_available == 'true'
        run: |
          echo "::group::Environment Variable Check"
          echo "Checking for VITE_* environment variables..."
          env | grep "^VITE_" | sed 's/=.*/=***/' || echo "No VITE_ variables found"
          echo "Checking for E2E_* environment variables..."
          env | grep "^E2E_" | sed 's/=.*/=***/' || echo "No E2E_ variables found"
          echo "Checking for PLAYWRIGHT_* environment variables..."
          env | grep "^PLAYWRIGHT_" || echo "No PLAYWRIGHT_ variables found"
          echo "::endgroup::"

      - name: Safety check - block E2E against production Supabase
        if: steps.check-secrets.outputs.secrets_available == 'true'
        env:
          VITE_SUPABASE_URL: ${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: |
          set -euo pipefail
          PROD_REF="ogjtmtndgiqqdtwatsue"
          if echo "${VITE_SUPABASE_URL:-}" | grep -q "${PROD_REF}"; then
            echo "::error::Refusing to run E2E against production Supabase (VITE_SUPABASE_URL contains ${PROD_REF})."
            echo "::error::Point repo secrets to a dedicated E2E/staging Supabase project."
            exit 1
          fi

          if echo "${DATABASE_URL:-}" | grep -q "${PROD_REF}"; then
            echo "::error::Refusing to seed E2E data against production Supabase (DATABASE_URL contains ${PROD_REF})."
            echo "::error::Point DATABASE_URL to a dedicated E2E/staging database."
            exit 1
          fi

      - name: Preflight - verify E2E DB schema (requires_scheduling)
        if: steps.check-secrets.outputs.secrets_available == 'true'
        env:
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: node scripts/checkE2ESchema.mjs

      - name: Seed E2E test data
        if: steps.check-secrets.outputs.secrets_available == 'true'
        env:
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          E2E_EMAIL: ${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::warning::DATABASE_URL secret not set - E2E tests may fail if products don't exist"
            echo "Skipping seed step - tests will rely on existing data or admin-crud test"
          else
            echo "Seeding E2E test data (products, vendors, etc.)"
            pnpm run db:seed-e2e || echo "::warning::Seed failed, continuing anyway"
          fi

      - name: Debug - effective PLAYWRIGHT_BASE_URL
        if: steps.check-secrets.outputs.secrets_available == 'true'
        env:
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5174
        run: |
          set -euo pipefail
          echo "::group::Playwright base URL"
          echo "PLAYWRIGHT_BASE_URL=${PLAYWRIGHT_BASE_URL}"
          echo "::endgroup::"

      - name: Run E2E tests (full suite)
        if: steps.check-secrets.outputs.secrets_available == 'true'
        env:
          # App runtime env (Vite reads VITE_* at dev server start)
          VITE_SUPABASE_URL: ${{ secrets.E2E_VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.E2E_VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_ORG_SCOPED_DROPDOWNS: true
          # Playwright/global.setup auth and base URL
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5174
          E2E_EMAIL: ${{ secrets.E2E_EMAIL || secrets.E2E_TEST_EMAIL }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD || secrets.E2E_TEST_PASSWORD }}
          # Database access for global.setup / helpers
          DATABASE_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL: ${{ secrets.E2E_DATABASE_URL || secrets.DATABASE_URL || secrets.SUPABASE_DB_URL }}
        run: pnpm e2e

      - name: Upload Playwright HTML report (always)
        if: always() && steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-full
          path: playwright-report
          if-no-files-found: ignore

      - name: Upload test results and traces
        if: always() && steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-full
          path: |
            test-results/
            e2e/*.png
            e2e/*.html
          if-no-files-found: ignore
          retention-days: 7
