name: Supabase Migrate Production

on:
  push:
    branches: ["main"]
    paths:
      - "supabase/migrations/**"
      - "supabase/config.toml"
  workflow_dispatch:

concurrency:
  group: supabase-migrate-prod
  cancel-in-progress: false

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: supabase-production

    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ] || [ -z "${{ secrets.SUPABASE_DB_PASSWORD }}" ] || [ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ]; then
            echo "Required Supabase secrets are missing. Aborting migration."
            exit 1
          fi

      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: 2.65.5

      - name: Show Supabase CLI version
        run: |
          echo "=== Supabase CLI Version ==="
          supabase --version

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "=== Linking to Supabase Project ==="
          echo "Project Ref: ${SUPABASE_PROJECT_REF:0:4}***"
          supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"
          echo "✓ Successfully linked to project"

      - name: List pending migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "=== Migration Status ==="
          supabase migration list || echo "Warning: Could not list migrations"

      - name: Repair migration history for duplicate timestamps
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "=== Checking for migration drift ==="
          echo "Attempting to repair version 20250110120000 if already applied remotely..."
          
          # Mark 20250110120000 as applied if it exists in remote DB but causes conflicts
          # This is safe because we're only marking existing migrations as applied
          # Note: -p flag is the official Supabase CLI method; GitHub Actions automatically masks secrets in logs
          if supabase migration repair 20250110120000 --status applied --linked --password "$SUPABASE_DB_PASSWORD" 2>&1 | tee repair_output.log; then
            echo "✓ Migration 20250110120000 repair completed successfully"
          else
            # Check if it failed because version doesn't exist (which is fine)
            if grep -q "migration version .* not found" repair_output.log; then
              echo "✓ Migration 20250110120000 not found in history - no repair needed"
            else
              echo "Warning: Repair command had unexpected output, but continuing..."
              cat repair_output.log
            fi
          fi
          rm -f repair_output.log
          echo "✓ Migration history reconciliation complete"

      - name: Apply migrations to production
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "=== Applying Migrations to Production ==="
          yes | supabase db push --include-all
          echo "✓ Migrations applied successfully"
